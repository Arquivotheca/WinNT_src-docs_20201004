<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dumpctl.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dumpctl.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>
<code>#include "ntddft.h"</code><br>
<code>#include &lt;<a class="el" href="../../d1/d0/inbv_8h-source.html">inbv.h</a>&gt;</code><br>
<code>#include &lt;windef.h&gt;</code><br>

<p>
<a href="../../d3/d2/dumpctl_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a0">min3</a>(_a, _b, _c)&nbsp;&nbsp;&nbsp;( min ( min ((_a), (_b)), min ((_a), (_c))) )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a1">IO_DUMP_MAXIMUM_TRANSFER_SIZE</a>&nbsp;&nbsp;&nbsp;( 1024 * 64 )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a2">IO_DUMP_MINIMUM_TRANSFER_SIZE</a>&nbsp;&nbsp;&nbsp;( 1024 * 32 )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a3">IO_DUMP_MINIMUM_FILE_SIZE</a>&nbsp;&nbsp;&nbsp;( PAGE_SIZE * 256 )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a4">MAX_UNICODE_LENGTH</a>&nbsp;&nbsp;&nbsp;( 512 )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a5">DEFAULT_DRIVER_PATH</a>&nbsp;&nbsp;&nbsp;L"\\SystemRoot\\System32\\Drivers\\"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a6">DEFAULT_DUMP_DRIVER</a>&nbsp;&nbsp;&nbsp;L"\\SystemRoot\\System32\\Drivers\\diskdump.sys"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a7">SCSIPORT_DRIVER_NAME</a>&nbsp;&nbsp;&nbsp;L"scsiport.sys"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a8">MAX_TRIAGE_STACK_SIZE</a>&nbsp;&nbsp;&nbsp;( 16 * 1024 )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a9">DEFAULT_TRIAGE_DUMP_FLAGS</a>&nbsp;&nbsp;&nbsp;(0xFFFFFFFF)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>(X)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a11">DmpPoolStringSize</a>(DumpString)&nbsp;&nbsp;&nbsp;(sizeof (DUMP_STRING) + sizeof (WCHAR) * ( DumpString-&gt;Length + 1 ))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a12">DmpNextPoolString</a>(DumpString)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a13">ALIGN_8</a>(_x)&nbsp;&nbsp;&nbsp;ALIGN_UP(_x, DWORDLONG)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a14">IndexByByte</a>(Pointer, <a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>)&nbsp;&nbsp;&nbsp;(&amp;(((<a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>*) (Pointer)) [<a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>]))</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a20">IopWriteTriageDump</a> (IN ULONG FieldsToWrite, IN <a class="el" href="../../d0/d5/io_8h.html#a268">PDUMP_DRIVER_WRITE</a> WriteRoutine, IN OUT PLARGE_INTEGER Mcb, IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl, IN ULONG DiverTransferSize, IN PCONTEXT Context, IN LPBYTE <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>, IN ULONG ServicePackBuild, IN ULONG TriageOptions)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a21">IopWriteSummaryDump</a> (IN PRTL_BITMAP PageMap, IN <a class="el" href="../../d0/d5/io_8h.html#a268">PDUMP_DRIVER_WRITE</a> WriteRoutine, IN PANSI_STRING ProgressMessage, IN PUCHAR MessageBuffer, IN OUT PLARGE_INTEGER Mcb, IN ULONG DiverTransferSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a22">IopWriteToDisk</a> (IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG WriteLength, IN <a class="el" href="../../d0/d5/io_8h.html#a268">PDUMP_DRIVER_WRITE</a> DriverWriteRoutine, IN OUT PLARGE_INTEGER *Mcb, IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl, IN ULONG DriverTransferSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a23">IopMapPhysicalMemory</a> (IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl, IN ULONG_PTR MemoryAddress, IN <a class="el" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PPHYSICAL_MEMORY_RUN</a> PhysicalMemoryRun, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a24">IopLoadDumpDriver</a> (IN OUT <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a> DumpStack, IN PWCHAR DriverNameString, IN PWCHAR NewBaseNameString)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a25">IoSetCrashDumpState</a> (IN SYSTEM_CRASH_STATE_INFORMATION *pDumpState)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PSUMMARY_DUMP_HEADER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a26">IopInitializeSummaryDump</a> (IN <a class="el" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a> pDcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a27">IopWriteSummaryHeader</a> (IN PSUMMARY_DUMP_HEADER pSummaryHeader, IN <a class="el" href="../../d0/d5/io_8h.html#a268">PDUMP_DRIVER_WRITE</a> pfWrite, IN OUT PLARGE_INTEGER *pMcbBuffer, IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> pMdl, IN ULONG dwWriteSize, IN ULONG dwLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a28">IopMapVirtualToPhysicalMdl</a> (IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> pMdl, IN ULONG_PTR dwMemoryAddress, IN ULONG dwLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a29">IopCreateSummaryDump</a> (IN PSUMMARY_DUMP_HEADER pHeader)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a30">IopDeleteNonExistentMemory</a> (PSUMMARY_DUMP_HEADER pHeader, <a class="el" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> <a class="el" href="../../d5/d1/mminit_8c.html#a20">MmPhysicalMemoryBlock</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a31">IopGetDumpStack</a> (IN PWCHAR ModulePrefix, OUT <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a> *pDumpStack, IN PUNICODE_STRING pUniDeviceName, IN PWSTR pDumpDriverName, IN <a class="el" href="../../d0/d5/io_8h.html#a362">DEVICE_USAGE_NOTIFICATION_TYPE</a> UsageType, IN ULONG IgnoreDeviceUsageFailure)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a32">IopInitializeDCB</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LARGE_INTEGER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a33">IopCalculateRequiredDumpSpace</a> (IN ULONG dwDmpFlags, IN ULONG dwHeaderSize, IN PFN_NUMBER dwMaxPages, IN PFN_NUMBER dwMaxSummaryPages)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a34">IopCompleteDumpInitialization</a> (IN HANDLE FileHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a35">IopIsAddressRangeValid</a> (IN PVOID VirtualAddress, IN SIZE_T Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a36">IoGetDumpStack</a> (IN PWCHAR ModulePrefix, OUT <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a> *pDumpStack, IN <a class="el" href="../../d0/d5/io_8h.html#a362">DEVICE_USAGE_NOTIFICATION_TYPE</a> UsageType, IN ULONG IgnoreDeviceUsageFailure)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a37">IopGetDumpStack</a> (IN PWCHAR ModulePrefix, OUT <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a> *pDumpStack, IN PUNICODE_STRING pUniDeviceName, IN PWCHAR pDumpDriverName, IN <a class="el" href="../../d0/d5/io_8h.html#a362">DEVICE_USAGE_NOTIFICATION_TYPE</a> UsageType, IN ULONG IgnoreDeviceUsageFailure)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a38">IopGetDumpControlBlockCheck</a> (IN <a class="el" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a> Dcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a39">IoInitializeDumpStack</a> (IN <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a> DumpStack, IN PUCHAR MessageBuffer OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a40">IoGetDumpHiberRanges</a> (IN PVOID HiberContext, IN <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a> DumpStack)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a41">IoFreeDumpStack</a> (IN <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a> DumpStack)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a42">IopInitializeDumpSpaceAndType</a> (IN <a class="el" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a> dcb, IN OUT PULONG block, IN PSUMMARY_DUMP_HEADER pSummaryHeader)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a43">IoWriteCrashDump</a> (IN ULONG BugCheckCode, IN ULONG_PTR BugCheckParameter1, IN ULONG_PTR BugCheckParameter2, IN ULONG_PTR BugCheckParameter3, IN ULONG_PTR BugCheckParameter4, IN PVOID ContextSave)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a44">IopAddPageToPageMap</a> (IN ULONG dwMaxPage, IN PRTL_BITMAP pBitMapHeader, IN ULONG dwPageFrameIndex, IN ULONG dwNumberOfPages)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a45">IopRemovePageFromPageMap</a> (IN ULONG dwMaxPage, IN PRTL_BITMAP pBitMapHeader, IN ULONG dwPageFrameIndex, IN ULONG dwNumberOfPages)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a46">IoGetCrashDumpInformation</a> (OUT PSYSTEM_CRASH_DUMP_INFORMATION pCrashDumpInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a47">IoGetCrashDumpStateInformation</a> (OUT PSYSTEM_CRASH_STATE_INFORMATION pCrashDumpState)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a48">IoSetDumpRange</a> (IN PVOID DumpContext, IN PVOID StartVa, IN ULONG_PTR Pages, IN BOOLEAN IsPhysicalAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a49">IoFreeDumpRange</a> (IN PVOID DumpContext, IN PVOID StartVa, IN ULONG_PTR Pages, IN BOOLEAN IsPhysicalAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a50">IopGetLoadedDriverInfo</a> (OUT ULONG *lpDriverCount, OUT ULONG *lpSizeOfStringData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a51">IopWriteDriverList</a> (IN ULONG_PTR BufferAddress, IN ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>, IN ULONG DriverListOffset, IN ULONG StringPoolOffset)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a52">IopWriteTriageDump</a> (IN ULONG Fields, IN <a class="el" href="../../d0/d5/io_8h.html#a268">PDUMP_DRIVER_WRITE</a> DriverWriteRoutine, IN OUT PLARGE_INTEGER Mcb, IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl, IN ULONG DriverTransferSize, IN PCONTEXT Context, IN <a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *<a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>, IN ULONG ServicePackBuild, IN ULONG TriageOptions)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a53">IopWritePageToDisk</a> (IN <a class="el" href="../../d0/d5/io_8h.html#a268">PDUMP_DRIVER_WRITE</a> DriverWrite, IN OUT PLARGE_INTEGER *McbBuffer, IN OUT ULONG DriverTransferSize, IN PFN_NUMBER PageFrameIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a54">IopWriteSummaryDump</a> (IN PRTL_BITMAP PageMap, IN <a class="el" href="../../d0/d5/io_8h.html#a268">PDUMP_DRIVER_WRITE</a> DriverWriteRoutine, IN PANSI_STRING ProgressMessage, IN PUCHAR MessageBuffer, IN OUT PLARGE_INTEGER Mcb, IN OUT ULONG DriverTransferSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a55">IopFreeDCB</a> (BOOLEAN FreeDCB)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a56">IopReadDumpRegistry</a> (OUT PULONG dumpControl, OUT PULONG numberOfHeaderPages, OUT PULONG autoReboot, OUT PULONG dumpFileSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a57">IopConfigureCrashDump</a> (IN HANDLE hPageFile)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_NUMBER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = -1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a18">IopCrashDumpStateChange</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d3/dumpctl_8c.html#a19">IopDumpFileContainsNewDump</a> = FALSE</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a13" doxytag="dumpctl.c::ALIGN_8" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ALIGN_8          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_x&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ALIGN_UP(_x, DWORDLONG)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02672">2672</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02795">IopWriteTriageDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="dumpctl.c::DEFAULT_DRIVER_PATH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DEFAULT_DRIVER_PATH&nbsp;&nbsp;&nbsp;L"\\SystemRoot\\System32\\Drivers\\"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00091">91</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="dumpctl.c::DEFAULT_DUMP_DRIVER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DEFAULT_DUMP_DRIVER&nbsp;&nbsp;&nbsp;L"\\SystemRoot\\System32\\Drivers\\diskdump.sys"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00092">92</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00335">IoGetDumpStack()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="dumpctl.c::DEFAULT_TRIAGE_DUMP_FLAGS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DEFAULT_TRIAGE_DUMP_FLAGS&nbsp;&nbsp;&nbsp;(0xFFFFFFFF)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00095">95</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">IopInitializeDCB()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="dumpctl.c::DmpNextPoolString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DmpNextPoolString          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">DumpString&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(PDUMP_STRING) (                                                    \
            <a class="code" href="../../d0/d9/ntosdef_8h.html#a6">ALIGN_UP_POINTER</a>(                                               \
                ((LPBYTE) DumpString) + DmpPoolStringSize (DumpString),     \
                ULONGLONG                                                   \
                )                                                           \
            )
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02664">2664</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02681">IopWriteDriverList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="dumpctl.c::DmpPoolStringSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DmpPoolStringSize          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">DumpString&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(sizeof (DUMP_STRING) + sizeof (WCHAR) * ( DumpString-&gt;Length + 1 ))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02661">2661</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="dumpctl.c::IndexByByte" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IndexByByte          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Pointer,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(&amp;(((<a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>*) (Pointer)) [<a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>]))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02676">2676</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02795">IopWriteTriageDump()</a>, <a class="el" href="../../d6/d4/triage_8c-source.html#l00421">TriageGetLoaderEntry()</a>, <a class="el" href="../../d6/d4/triage_8c-source.html#l00490">TriageGetMmInformation()</a>, <a class="el" href="../../d6/d4/triage_8c-source.html#l00223">TriagepGetTriagePointer()</a>, and <a class="el" href="../../d6/d4/triage_8c-source.html#l00171">TriagepVerifyDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="dumpctl.c::IO_DUMP_MAXIMUM_TRANSFER_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_DUMP_MAXIMUM_TRANSFER_SIZE&nbsp;&nbsp;&nbsp;( 1024 * 64 )          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00086">86</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03638">IopWriteToDisk()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="dumpctl.c::IO_DUMP_MINIMUM_FILE_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_DUMP_MINIMUM_FILE_SIZE&nbsp;&nbsp;&nbsp;( PAGE_SIZE * 256 )          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00088">88</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02492">IopCalculateRequiredDumpSpace()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="dumpctl.c::IO_DUMP_MINIMUM_TRANSFER_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IO_DUMP_MINIMUM_TRANSFER_SIZE&nbsp;&nbsp;&nbsp;( 1024 * 32 )          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00087">87</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03638">IopWriteToDisk()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="dumpctl.c::IoDebugPrint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IoDebugPrint          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">X&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">231</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02400">IoFreeDumpRange()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01142">IoInitializeDumpStack()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04746">IopConfigureCrashDump()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03815">IopCreateSummaryDump()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03953">IopDeleteNonExistentMemory()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04252">IopFreeDCB()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">IopInitializeDCB()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01452">IopInitializeDumpSpaceAndType()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03442">IopInitializeSummaryDump()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00954">IopLoadDumpDriver()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03759">IopMapVirtualToPhysicalMdl()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04379">IopReadDumpRegistry()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02193">IopRemovePageFromPageMap()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03329">IopWriteSummaryDump()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03520">IopWriteSummaryHeader()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03638">IopWriteToDisk()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02795">IopWriteTriageDump()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="dumpctl.c::MAX_TRIAGE_STACK_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_TRIAGE_STACK_SIZE&nbsp;&nbsp;&nbsp;( 16 * 1024 )          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00094">94</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02795">IopWriteTriageDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="dumpctl.c::MAX_UNICODE_LENGTH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_UNICODE_LENGTH&nbsp;&nbsp;&nbsp;( 512 )          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00089">89</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="dumpctl.c::min3" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define min3          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>_b,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>_c&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;( min ( min ((_a), (_b)), min ((_a), (_c))) )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00068">68</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03183">IopWritePageToDisk()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="dumpctl.c::SCSIPORT_DRIVER_NAME" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SCSIPORT_DRIVER_NAME&nbsp;&nbsp;&nbsp;L"scsiport.sys"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00093">93</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a49" doxytag="dumpctl.c::IoFreeDumpRange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IoFreeDumpRange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DumpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>StartVa</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Pages</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsPhysicalAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02400">2400</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02193">IopRemovePageFromPageMap()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05490">MmGetPhysicalAddress()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l08083">MmSetKernelDumpRange()</a>.
<p>
<pre class="fragment"><div>02408                    :
02409 
02410     This routine excludes <span class="keyword">this</span> range of memory in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump.
02411 
02412 Arguments:
02413 
02414     DumpContext - dump context
02415     
02416     StartVa - Starting VA
02417     
02418     Pages - The number of pages to include
02419     
02420     IsPhysicalAddress - <span class="keyword">true</span> <span class="keywordflow">if</span> direct physical address <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a46">translation</a>
02421     
02422 Return Value:
02423 
02424     STATUS_SUCCESS - On success.
02425     
02426     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>.
02427 
02428 --*/
02429 {
02430     PCHAR                   Va;
02431     PRTL_BITMAP             pBitMapHeader;
02432     PHYSICAL_ADDRESS        phyAddr;
02433     PSUMMARY_DUMP_HEADER    pHeader;
02434 
02435     <span class="comment">//</span>
02436     <span class="comment">// Round to page size.</span>
02437     <span class="comment">//</span>
02438     
02439     Va = StartVa;
02440     pHeader = (PSUMMARY_DUMP_HEADER)DumpContext;
02441     pBitMapHeader = (PRTL_BITMAP)(pHeader + 1);
02442 
02443     <span class="comment">//</span>
02444     <span class="comment">// Win64 can have really large page addresses.  This dump code does</span>
02445     <span class="comment">// not handle that yet.  Note that before this assert is removed</span>
02446     <span class="comment">// the casts of Pages to ULONG must be removed.</span>
02447     <span class="comment">//</span>
02448 
02449     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pages &lt;= MAXULONG);
02450 
02451     <span class="keywordflow">if</span> (IsPhysicalAddress) {
02452 
02453         phyAddr = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a>(Va);
02454 
02455         <a class="code" href="../../d2/d3/dumpctl_8c.html#a45">IopRemovePageFromPageMap</a> (pHeader-&gt;BitmapSize,
02456                                   pBitMapHeader,
02457                                   (ULONG)(phyAddr.QuadPart &gt;&gt; PAGE_SHIFT),
02458                                   (ULONG) Pages
02459                                   );
02460     } <span class="keywordflow">else</span> {
02461 
02462         <span class="keywordflow">while</span> (Pages) {
02463 
02464             <span class="comment">//</span>
02465             <span class="comment">// Only do a translation for valid pages.</span>
02466             <span class="comment">//</span>
02467 
02468             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (Va) ) {
02469                 phyAddr = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a> (Va);
02470 
02471                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((3,<span class="stringliteral">"IoFreeDumpRange:Va: %x Pages: %x IsPhysical: %x phyAddr %I64x\n"</span>,
02472                     StartVa,Pages,IsPhysicalAddress, phyAddr.QuadPart));
02473 
02474                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a45">IopRemovePageFromPageMap</a> (pHeader-&gt;BitmapSize,
02475                                           pBitMapHeader,
02476                                           (ULONG)(phyAddr.QuadPart &gt;&gt; PAGE_SHIFT),
02477                                           1);
02478 
02479             }
02480 
02481             Va += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02482             Pages--;
02483         }
02484     }
02485 
02486     <span class="keywordflow">return</span> STATUS_SUCCESS;
02487 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="dumpctl.c::IoFreeDumpStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IoFreeDumpStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DumpStack</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01300">1300</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l00322">_INITIALIZATION_CONTEXT::AdapterObject</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00316">_INITIALIZATION_CONTEXT::CommonBuffer</a>, <a class="el" href="../../d0/d5/io_8h.html#a603a417">DeviceUsageTypeUndefined</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d2/d7/hal_8h.html#a228">HalFreeCommonBuffer()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00183">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05372">MmFreeContiguousMemory()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d5/io_8h.html#a280">PDUMP_STACK_IMAGE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00317">_INITIALIZATION_CONTEXT::PhysicalAddress</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04252">IopFreeDCB()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>.
<p>
<pre class="fragment"><div>01305                    :
01306 
01307     Free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump driver stack referenced by DumpStack
01308 
01309 Arguments:
01310 
01311     DumpStack           - <a class="code" href="../../d2/d5/editreg_8c.html#a66">Dump</a> driver stack being initialized
01312 
01313 Return Value:
01314 
01315     None
01316 
01317 --*/
01318 {
01319     <a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html">PINITIALIZATION_CONTEXT</a>     DumpInit;
01320     <a class="code" href="../../d0/d5/io_8h.html#a280">PDUMP_STACK_IMAGE</a>           DumpImage;
01321     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>              DeviceObject;
01322     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>          IrpSp;
01323     IO_STATUS_BLOCK             IoStatus;
01324     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>                        <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
01325     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>                      <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
01326     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01327     ULONG                       i;
01328     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>                FileObject;
01329     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>           irpSp;
01330     ULONG                       information;
01331 
01332     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01333     DumpInit = &amp;DumpStack-&gt;Init;
01334 
01335     <span class="comment">//</span>
01336     <span class="comment">// Release the claim to this file as a specific device usage path.</span>
01337     <span class="comment">//</span>
01338 
01339     FileObject = DumpStack-&gt;FileObject;
01340     <span class="keywordflow">if</span> (FileObject) {
01341         DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a> (FileObject);
01342 
01343         RtlZeroMemory (&amp;irpSp, <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
01344 
01345         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
01346         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a86">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>;
01347         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.UsageNotification.Type = DumpStack-&gt;UsageType;
01348         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.UsageNotification.InPath = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01349         irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
01350 
01351         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a603a417">DeviceUsageTypeUndefined</a> != DumpStack-&gt;UsageType) {
01352             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a> (DeviceObject, &amp;irpSp, (VOID **) &amp;information);
01353             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (0 == information);
01354         } <span class="keywordflow">else</span> {
01355             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01356         }
01357     }
01358 
01359     <span class="comment">//</span>
01360     <span class="comment">// Free any common buffers which where allocated</span>
01361     <span class="comment">//</span>
01362 
01363     <span class="keywordflow">for</span> (i=0; i &lt; 2; i++) {
01364         <span class="keywordflow">if</span> (DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o3">CommonBuffer</a>[i]) {
01365             <span class="keywordflow">if</span> (DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>) {
01366 
01367 <span class="preprocessor">#if !defined(NO_LEGACY_DRIVERS)</span>
01368 <span class="preprocessor"></span>                <a class="code" href="../../d2/d7/hal_8h.html#a228">HalFreeCommonBuffer</a> (
01369                     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>,
01370                     ((PDUMP_POINTERS)DumpStack-&gt;DumpPointers)-&gt;CommonBufferSize,
01371                     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o4">PhysicalAddress</a>[i],
01372                     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o3">CommonBuffer</a>[i],
01373                     FALSE
01374                     );
01375 <span class="preprocessor">#else</span>
01376 <span class="preprocessor"></span>                (*((<a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a>)DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>)-&gt;DmaOperations-&gt;
01377                  FreeCommonBuffer )(
01378                      (<a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a>)DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>,
01379                      ((PDUMP_POINTERS)DumpStack-&gt;DumpPointers)-&gt;CommonBufferSize,
01380                      DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o4">PhysicalAddress</a>[i],
01381                      DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o3">CommonBuffer</a>[i],
01382                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01383                      );
01384 
01385 <span class="preprocessor">#endif // NO_LEGACY_DRIVERS</span>
01386 <span class="preprocessor"></span>
01387                 
01388             } <span class="keywordflow">else</span> {
01389                 <a class="code" href="../../d5/d6/iosup_8c.html#a66">MmFreeContiguousMemory</a> (DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o3">CommonBuffer</a>[i]);
01390             }
01391         }
01392         DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o3">CommonBuffer</a>[i] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01393     }
01394 
01395     <span class="comment">//</span>
01396     <span class="comment">// Unload the dump drivers</span>
01397     <span class="comment">//</span>
01398 
01399     <span class="keywordflow">while</span> (!IsListEmpty(&amp;DumpStack-&gt;DriverList)) {
01400         DumpImage = CONTAINING_RECORD(DumpStack-&gt;DriverList.Blink, <a class="code" href="../../d4/d8/structDUMP__STACK__IMAGE.html">DUMP_STACK_IMAGE</a>, Link);
01401         RemoveEntryList (&amp;DumpImage-&gt;Link);
01402         <a class="code" href="../../d8/d8/sysload_8c.html#a59">MmUnloadSystemImage</a> (DumpImage-&gt;Image);
01403         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DumpImage);
01404     }
01405 
01406     <span class="comment">//</span>
01407     <span class="comment">// Inform the driver stack that the dump registartion is over</span>
01408     <span class="comment">//</span>
01409 
01410     <span class="keywordflow">if</span> (DumpStack-&gt;FileObject) {
01411         DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a> ((<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>) DumpStack-&gt;FileObject);
01412 
01413         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;Event, NotificationEvent, FALSE );
01414         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>(
01415                     IOCTL_SCSI_FREE_DUMP_POINTERS,
01416                     DeviceObject,
01417                     DumpStack-&gt;DumpPointers,
01418                     sizeof (DUMP_POINTERS),
01419                     NULL,
01420                     0,
01421                     FALSE,
01422                     &amp;Event,
01423                     &amp;IoStatus
01424                     );
01425 
01426         IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a> (Irp);
01427         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = DumpStack-&gt;FileObject;
01428 
01429         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, Irp );
01430 
01431         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
01432             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;Event, Executive, KernelMode, FALSE, NULL);
01433             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatus.Status;
01434         }
01435         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DumpStack-&gt;FileObject );
01436     }
01437     <span class="comment">//</span>
01438     <span class="comment">// Free the target address if it exists</span>
01439     <span class="comment">//</span>
01440     <span class="keywordflow">if</span> (DumpStack-&gt;Init.TargetAddress) {
01441         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DumpStack-&gt;Init.TargetAddress);
01442     }
01443     <span class="comment">//</span>
01444     <span class="comment">// Free the dump stack context</span>
01445     <span class="comment">//</span>
01446 
01447     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DumpStack);
01448 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="dumpctl.c::IoGetCrashDumpInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS IoGetCrashDumpInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PSYSTEM_CRASH_DUMP_INFORMATION&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pCrashDumpInfo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02217">2217</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d4/d4/iodata_8c-source.html#l00263">IopDumpControlBlock</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>.
<p>
<pre class="fragment"><div>02223                    :
02224 
02225     This function checks to see <span class="keywordflow">if</span> an open crash dump section exists and
02226     <span class="keywordflow">if</span> so creates a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section and returns that value
02227     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CrashDumpInformation structure.
02228 
02229 
02230 Arguments:
02231 
02232     CrashInfo - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> crash dump information
02233                 structure.
02234 
02235 Return Value:
02236 
02237     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> handle value of zero indicates no
02238     crash dump was located.
02239 
02240 --*/
02241 {
02242 
02243     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>) {
02244         <span class="keywordflow">return</span> STATUS_NOT_FOUND;
02245     }
02246 
02247     <span class="comment">//</span>
02248     <span class="comment">// NB: The section object is for direct dump support, which has been</span>
02249     <span class="comment">// removed.</span>
02250     <span class="comment">//</span>
02251     
02252     pCrashDumpInfo-&gt;hDumpSection = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02253     <span class="keywordflow">return</span> STATUS_SUCCESS;
02254 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="dumpctl.c::IoGetCrashDumpStateInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS IoGetCrashDumpStateInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PSYSTEM_CRASH_STATE_INFORMATION&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pCrashDumpState</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02260">2260</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>.
<p>
<pre class="fragment"><div>02266                    :
02267 
02268     This routine returns sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state variable <span class="keywordflow">for</span> direct dump (fast dump)
02269 
02270 
02271 Arguments:
02272 
02273     CrashInfo - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> crash dump state information
02274                 structure.
02275 
02276 Return Value:
02277 
02278     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> handle value of zero indicates no
02279     crash dump was located.
02280 
02281 --*/
02282 
02283 {
02284     pCrashDumpState-&gt;ValidDirectDump = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02285 
02286     <span class="keywordflow">return</span> STATUS_SUCCESS;
02287 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="dumpctl.c::IoGetDumpHiberRanges" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IoGetDumpHiberRanges           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HiberContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DumpStack</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01233">1233</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d0/d5/io_8h.html#a280">PDUMP_STACK_IMAGE</a>, <a class="el" href="../../d2/d1/po_8h-source.html#l00142">PO_MEM_CL_OR_NCHK</a>, and <a class="el" href="../../d1/d2/po_8h.html#a67">PoSetHiberRange()</a>.
<p>
<pre class="fragment"><div>01239                    :
01240 
01241     Adds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump driver stack storage to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hibernate range list,
01242     to inform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hibernate <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> which pages need cloned,
01243     discarded or not checksumed as they are in use by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump
01244     stack.
01245 
01246 Arguments:
01247 
01248     HiberContext        - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hiber context structure
01249 
01250     DumpStack           - <a class="code" href="../../d2/d5/editreg_8c.html#a66">Dump</a> driver stack being initialized
01251 
01252 Return Value:
01253 
01254     None
01255 
01256 --*/
01257 {
01258     PDUMP_POINTERS              DumpPointers;
01259     <a class="code" href="../../d0/d5/io_8h.html#a280">PDUMP_STACK_IMAGE</a>           DumpImage;
01260     PLIST_ENTRY                 Link;
01261 
01262     DumpPointers = DumpStack-&gt;DumpPointers;
01263 
01264     <span class="comment">//</span>
01265     <span class="comment">// Report the common buffer</span>
01266     <span class="comment">//</span>
01267 
01268     <span class="keywordflow">if</span> (DumpPointers-&gt;CommonBufferVa) {
01269         <a class="code" href="../../d1/d2/po_8h.html#a67">PoSetHiberRange</a> (
01270             HiberContext,
01271             PO_MEM_CL_OR_NCHK,
01272             DumpPointers-&gt;CommonBufferVa,
01273             DumpPointers-&gt;CommonBufferSize,
01274             'fubc'
01275             );
01276     }
01277 
01278     <span class="comment">//</span>
01279     <span class="comment">// Dump the entire image of the dump drivers</span>
01280     <span class="comment">//</span>
01281 
01282     <span class="keywordflow">for</span> (Link = DumpStack-&gt;DriverList.Flink;
01283          Link != &amp;DumpStack-&gt;DriverList;
01284          Link = Link-&gt;Flink) {
01285 
01286         DumpImage = CONTAINING_RECORD(Link, <a class="code" href="../../d4/d8/structDUMP__STACK__IMAGE.html">DUMP_STACK_IMAGE</a>, Link);
01287 
01288         <a class="code" href="../../d1/d2/po_8h.html#a67">PoSetHiberRange</a> (
01289             HiberContext,
01290             PO_MEM_CL_OR_NCHK,
01291             DumpImage-&gt;ImageBase,
01292             DumpImage-&gt;SizeOfImage,
01293             'gmID'
01294             );
01295     }
01296 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="dumpctl.c::IoGetDumpStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IoGetDumpStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>ModulePrefix</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pDumpStack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/io_8h.html#a362">DEVICE_USAGE_NOTIFICATION_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>UsageType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreDeviceUsageFailure</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00335">335</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00092">DEFAULT_DUMP_DRIVER</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00735">IoArcBootDeviceName</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04746">IopConfigureCrashDump()</a>.
<p>
<pre class="fragment"><div>00343                    :
00344 
00345     This routine loads a dump stack instance and returns an allocated
00346     context structure to track <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loaded dumps stack.
00347 
00348 Arguments:
00349 
00350     ModePrefix      - The prefix to prepent to <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a> during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> load
00351                       operation.  This allows loading <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same drivers
00352                       multiple times with different <span class="keyword">virtual</span> names and
00353                       linkages.
00354 
00355     pDumpStack      - The returned dump stack context structure
00356 
00357     UsageType       - The Device Notification <a class="code" href="../../d1/d1/hivedmp_8c.html#a6">Usage</a> Type <span class="keywordflow">for</span> <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, that
00358                       <span class="keyword">this</span> routine will send as to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object once <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00359                       <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> has been successfully created and initialized.
00360 
00361     IgnoreDeviceUsageFailure - If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Device <a class="code" href="../../d1/d1/hivedmp_8c.html#a6">Usage</a> Notification <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> fails, allow
00362                       <span class="keyword">this</span> to succeed anyway.
00363 
00364 Return Value:
00365 
00366     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
00367 
00368 --*/
00369 {
00370 
00371     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00372     <span class="keywordflow">return</span> <a class="code" href="../../d2/d3/dumpctl_8c.html#a37">IopGetDumpStack</a>(ModulePrefix,
00373                            pDumpStack,
00374                            &amp;IoArcBootDeviceName,
00375                            DEFAULT_DUMP_DRIVER,
00376                            UsageType,
00377                            IgnoreDeviceUsageFailure
00378                            );
00379 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="dumpctl.c::IoInitializeDumpStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IoInitializeDumpStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DumpStack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUCHAR MessageBuffer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01142">1142</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00319">_INITIALIZATION_CONTEXT::OpenRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00522">PDRIVER_INITIALIZE</a>, <a class="el" href="../../d0/d5/io_8h.html#a280">PDUMP_STACK_IMAGE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.
<p>
<pre class="fragment"><div>01148                    :
01149 
01150     Initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump driver stack referenced by DumpStack to perform IO.
01151 
01152 Arguments:
01153 
01154     DumpStack   - <a class="code" href="../../d2/d5/editreg_8c.html#a66">Dump</a> driver stack being initialized
01155 
01156 Return Value:
01157 
01158     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
01159 
01160 --*/
01161 {
01162 
01163     <a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html">PINITIALIZATION_CONTEXT</a>     DumpInit;
01164     PLIST_ENTRY                 Link;
01165     ULONG                       Check;
01166     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01167     <a class="code" href="../../d0/d5/io_8h.html#a284">PDRIVER_INITIALIZE</a>          DriverInit;
01168     <a class="code" href="../../d0/d5/io_8h.html#a280">PDUMP_STACK_IMAGE</a>           DumpImage;
01169 
01170 
01171     DumpInit = &amp;DumpStack-&gt;Init;
01172 
01173     <span class="comment">//</span>
01174     <span class="comment">// Verify checksum on DumpStack structure</span>
01175     <span class="comment">//</span>
01176 
01177     <span class="comment">// BUGBUG: later</span>
01178 
01179     <span class="comment">//</span>
01180     <span class="comment">// Initializes the dump drivers</span>
01181     <span class="comment">//</span>
01182 
01183     <span class="keywordflow">for</span> (Link = DumpStack-&gt;DriverList.Flink;
01184          Link != &amp;DumpStack-&gt;DriverList;
01185          Link = Link-&gt;Flink) {
01186 
01187         DumpImage = CONTAINING_RECORD(Link, <a class="code" href="../../d4/d8/structDUMP__STACK__IMAGE.html">DUMP_STACK_IMAGE</a>, Link);
01188 
01189         <span class="comment">//</span>
01190         <span class="comment">// Call this driver's driver init.  Only the first driver gets the</span>
01191         <span class="comment">// dump initialization context</span>
01192         <span class="comment">//</span>
01193 
01194         DriverInit = DumpImage-&gt;Image-&gt;EntryPoint;
01195         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = DriverInit (NULL, (PUNICODE_STRING) DumpInit);
01196         DumpInit = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01197 
01198         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01199             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((0,
01200                            <span class="stringliteral">"IODUMP: Unable to initialize driver; error = %x\n"</span>,
01201                            Status
01202                            ));
01203             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01204         }
01205     }
01206 
01207     DumpInit = &amp;DumpStack-&gt;Init;
01208 
01209     <span class="comment">//</span>
01210     <span class="comment">// Display string we are starting</span>
01211     <span class="comment">//</span>
01212 
01213     <span class="keywordflow">if</span> (MessageBuffer) {
01214         <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a> (MessageBuffer);
01215     }
01216 
01217     <span class="comment">//</span>
01218     <span class="comment">// Open the partition from which the system was booted.</span>
01219     <span class="comment">// This returns TRUE if the disk w/the appropriate signature was found,</span>
01220     <span class="comment">// otherwise a NULL, in which case there is no way to continue.</span>
01221     <span class="comment">//</span>
01222 
01223     <span class="keywordflow">if</span> (!DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o6">OpenRoutine</a> (DumpStack-&gt;PartitionOffset)) {
01224         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> (( 0, <span class="stringliteral">"IODUMP: Could not find/open partition offset\n"</span> ));
01225         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01226     }
01227 
01228     <span class="keywordflow">return</span> STATUS_SUCCESS;
01229 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="dumpctl.c::IopAddPageToPageMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopAddPageToPageMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>dwMaxPage</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PRTL_BITMAP&nbsp;</td>
          <td class="mdname" nowrap> <em>pBitMapHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>dwPageFrameIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>dwNumberOfPages</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02172">2172</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01634">RtlSetBits()</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02291">IoSetDumpRange()</a>.
<p>
<pre class="fragment"><div>02178 {
02179     <span class="comment">//</span>
02180     <span class="comment">// Sometimes we get PFNs that are out of range. Just ignore them.</span>
02181     <span class="comment">//</span>
02182 
02183     <span class="keywordflow">if</span> (dwPageFrameIndex &gt;= dwMaxPage) {
02184         <span class="keywordflow">return</span>;
02185     }
02186 
02187     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a34">RtlSetBits</a> (pBitMapHeader, dwPageFrameIndex, dwNumberOfPages);
02188 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="dumpctl.c::IopCalculateRequiredDumpSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LARGE_INTEGER IopCalculateRequiredDumpSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>dwDmpFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>dwHeaderSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>dwMaxPages</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>dwMaxSummaryPages</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02492">2492</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00442">DCB_DUMP_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00445">DCB_DUMP_HEADER_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00446">DCB_SUMMARY_DUMP_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00443">DCB_SUMMARY_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00447">DCB_TRIAGE_DUMP_ENABLED</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00088">IO_DUMP_MINIMUM_FILE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00029">MmVirtualBias</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, and <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04746">IopConfigureCrashDump()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01452">IopInitializeDumpSpaceAndType()</a>.
<p>
<pre class="fragment"><div>02501                    :
02502 
02503     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to calcuate required dump space
02504 
02505         1. Crash dump summary must be at least 1 page in length.
02506 
02507         2. Summary dump must be large enough <span class="keywordflow">for</span> kernel memory plus header,
02508            plus summary header.
02509 
02510         3. Full dump must be large enough <span class="keywordflow">for</span> header plus all physical memory.
02511 
02512 Arguments:
02513 
02514     dwDmpFlags - <a class="code" href="../../d2/d5/editreg_8c.html#a66">Dump</a> Control Block (DCB) flags.
02515 
02516     dwHeaderSize - The size of the dump header.
02517 
02518     dwMaxPages - All physical memory.
02519 
02520     dwMaxSummaryPages - Maximum pages in summary dump.
02521 
02522 Return Value:
02523 
02524     Size of the dump file
02525 
02526 --*/
02527 {
02528     LARGE_INTEGER maxMemorySize;
02529 
02530     <span class="comment">//</span>
02531     <span class="comment">// Dump header or dump summary.</span>
02532     <span class="comment">//</span>
02533     
02534     <span class="keywordflow">if</span> ( (dwDmpFlags &amp; <a class="code" href="../../d0/d6/iop_8h.html#a8">DCB_DUMP_HEADER_ENABLED</a>) ||
02535          ( !( dwDmpFlags &amp; <a class="code" href="../../d0/d6/iop_8h.html#a5">DCB_DUMP_ENABLED</a> ) &amp;&amp;
02536          ( dwDmpFlags &amp; <a class="code" href="../../d0/d6/iop_8h.html#a6">DCB_SUMMARY_ENABLED</a> ) ) ) {
02537          
02538         maxMemorySize.QuadPart = <a class="code" href="../../d2/d3/dumpctl_8c.html#a3">IO_DUMP_MINIMUM_FILE_SIZE</a>;
02539         <span class="keywordflow">return</span> maxMemorySize;
02540     }
02541 
02542     <span class="keywordflow">if</span> (dwDmpFlags &amp; <a class="code" href="../../d0/d6/iop_8h.html#a10">DCB_TRIAGE_DUMP_ENABLED</a>) {
02543 
02544         maxMemorySize.QuadPart = TRIAGE_DUMP_SIZE;
02545         <span class="keywordflow">return</span> maxMemorySize;
02546     }
02547 
02548     <span class="keywordflow">if</span> (dwDmpFlags &amp; <a class="code" href="../../d0/d6/iop_8h.html#a9">DCB_SUMMARY_DUMP_ENABLED</a>) {
02549         ULONG summaryHeaderSize;
02550         ULONG dwGB;
02551 
02552         maxMemorySize.QuadPart  = (dwMaxSummaryPages) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02553 
02554         <span class="comment">//</span>
02555         <span class="comment">// If biased then max kernel memory is 1GB otherwise it is 2GB</span>
02556         <span class="comment">//</span>
02557         
02558         dwGB = 1024 * 1024 * 1024;
02559 
02560         <span class="keywordflow">if</span> (maxMemorySize.QuadPart &gt;  (2 * dwGB) ) {
02561             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a>) {
02562                 maxMemorySize.QuadPart = dwGB;
02563             } <span class="keywordflow">else</span> {
02564                 maxMemorySize.QuadPart = (2 * dwGB);
02565             }
02566         }
02567 
02568         <span class="comment">//</span>
02569         <span class="comment">// Calculate the summary header size. Includes the header plus bitmap</span>
02570         <span class="comment">//</span>
02571         summaryHeaderSize = (ULONG) <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(
02572                                 <span class="keyword">sizeof</span>(SUMMARY_DUMP_HEADER) +
02573                                 <span class="keyword">sizeof</span>(RTL_BITMAP) +
02574                                 ( ( (maxMemorySize.QuadPart &gt;&gt; PAGE_SHIFT ) &gt;&gt; 5 ) &lt;&lt; 2 ) +
02575                                 dwHeaderSize
02576                                 );
02577 
02578         maxMemorySize.QuadPart+= summaryHeaderSize;
02579 
02580         <span class="keywordflow">return</span> maxMemorySize;
02581 
02582     }
02583 
02584     <span class="comment">//</span>
02585     <span class="comment">// Full memory dump is #pages * pagesize plus 1 page for the dump header.</span>
02586     <span class="comment">//</span>
02587     
02588     maxMemorySize.QuadPart = (dwMaxPages * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) + dwHeaderSize;
02589 
02590     <span class="keywordflow">return</span> maxMemorySize;
02591 
02592 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="dumpctl.c::IopCompleteDumpInitialization" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopCompleteDumpInitialization           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FileHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04061">4061</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01160">DO_SYSTEM_BOOT_PARTITION</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00469">_DUMP_CONTROL_BLOCK::DumpFileSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00460">_DUMP_CONTROL_BLOCK::FileDescriptorArray</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00461">_DUMP_CONTROL_BLOCK::FileDescriptorSize</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00263">IopDumpControlBlock</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00264">IopDumpControlBlockChecksum</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01062">IopGetDumpControlBlockCheck()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04393">IopLogErrorEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04746">IopConfigureCrashDump()</a>.
<p>
<pre class="fragment"><div>04067                    :
04068 
04069     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created.
04070 
04071     The purpose <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to obtain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> retrieval pointers so that they can then be
04072     used later to write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump. The last step <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to checksum <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04073     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>.
04074 
04075     Fields in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a> are updated <span class="keywordflow">if</span> necessary and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04076     <a class="code" href="../../d3/d5/iodata_8c.html#a48">IopDumpControlBlockChecksum</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initialized.
04077 
04078     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> step in dump initialization.
04079 
04080 Arguments:
04081 
04082     FileHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> just created.
04083 
04084 Return Value:
04085 
04086     STATUS_SUCCESS - Indicates success.
04087 
04088     Other <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Failure.
04089 
04090 --*/
04091 
04092 {
04093     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04094     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ErrorToLog;
04095     ULONG i;
04096     LARGE_INTEGER RequestedFileSize;
04097     PLARGE_INTEGER mcb;
04098     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject;
04099     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
04100     IO_STATUS_BLOCK IoStatusBlock;
04101     FILE_STANDARD_INFORMATION StandardFileInfo;
04102 
04103     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
04104     ErrorToLog = STATUS_SUCCESS;    <span class="comment">// No error</span>
04105     FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04106     DeviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04107 
04108     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
04109                                         0,
04110                                         IoFileObjectType,
04111                                         KernelMode,
04112                                         (PVOID *) &amp;FileObject,
04113                                         NULL
04114                                         );
04115 
04116     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status) ) {
04117         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE);
04118         <span class="keywordflow">goto</span> Cleanup;
04119     }
04120 
04121 
04122     DeviceObject = FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>;
04123 
04124     <span class="comment">//</span>
04125     <span class="comment">// If this device object represents the boot partition then query</span>
04126     <span class="comment">// the retrieval pointers for the file.</span>
04127     <span class="comment">//</span>
04128 
04129     <span class="keywordflow">if</span> ( !(DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a129">DO_SYSTEM_BOOT_PARTITION</a>) ) {
04130          
04131         KdPrint ((<span class="stringliteral">"IODUMP: Cannot dump to pagefile on non-system partition.\n"</span>));
04132         <span class="keywordflow">goto</span> Cleanup;
04133     }
04134 
04135     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryInformationFile(
04136                                 FileHandle,
04137                                 &amp;IoStatusBlock,
04138                                 &amp;StandardFileInfo,
04139                                 <span class="keyword">sizeof</span> (StandardFileInfo),
04140                                 FileStandardInformation
04141                                 );
04142 
04143     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
04144         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>,
04145                                         Executive,
04146                                         KernelMode,
04147                                         FALSE,
04148                                         NULL
04149                                         );
04150         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatusBlock.Status;
04151     }
04152 
04153     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status) ) {
04154         KdPrint ((<span class="stringliteral">"CRASHDUMP: Failed ZwQueryInformationFile\n"</span>));
04155         <span class="keywordflow">goto</span> Cleanup;
04156     }
04157 
04158     <span class="comment">//</span>
04159     <span class="comment">// Do not ask for more space than is in the pagefile.</span>
04160     <span class="comment">//</span>
04161 
04162     RequestedFileSize = <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o18">DumpFileSize</a>;
04163     
04164     <span class="keywordflow">if</span> (RequestedFileSize.QuadPart &gt; StandardFileInfo.EndOfFile.QuadPart) {
04165         RequestedFileSize = StandardFileInfo.EndOfFile;
04166     }
04167 
04168     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwFsControlFile(
04169                         FileHandle,
04170                         NULL,
04171                         NULL,
04172                         NULL,
04173                         &amp;IoStatusBlock,
04174                         FSCTL_QUERY_RETRIEVAL_POINTERS,
04175                         &amp;RequestedFileSize,
04176                         <span class="keyword">sizeof</span>( LARGE_INTEGER ),
04177                         &amp;mcb,
04178                         <span class="keyword">sizeof</span>( PVOID )
04179                         );
04180 
04181     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
04182         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>,
04183                                         Executive,
04184                                         KernelMode,
04185                                         FALSE,
04186                                         NULL );
04187         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatusBlock.Status;
04188     }
04189 
04190 
04191     <span class="comment">//</span>
04192     <span class="comment">// NOTE: If you fail here, put a BP on ntfs!NtfsQueryRetrievalPointers</span>
04193     <span class="comment">// or FatQueryRetrievalPointers and see why you failed.</span>
04194     <span class="comment">//</span>
04195     
04196     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status) ) {
04197         KdPrint ((<span class="stringliteral">"CRASHDUMP: ZwFsControlFile returnd %d\n"</span>, Status));
04198         ErrorToLog = IO_DUMP_POINTER_FAILURE;
04199         <span class="keywordflow">goto</span> Cleanup;
04200     }
04201     
04202     <span class="comment">//</span>
04203     <span class="comment">// This paging file is on the system boot partition, and</span>
04204     <span class="comment">// the retrieval pointers for the file were just successfully</span>
04205     <span class="comment">// queried.  Walk the MCB to size it, and then checksum it.</span>
04206     <span class="comment">//</span>
04207 
04208     <span class="keywordflow">for</span> (i = 0; mcb [i].QuadPart; i++) {
04209         NOTHING;
04210     }
04211 
04212     <span class="comment">//</span>
04213     <span class="comment">// Write back fields of the IopDumpControlBlock.</span>
04214     <span class="comment">//</span>
04215     
04216     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o9">FileDescriptorArray</a> = mcb;
04217     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o10">FileDescriptorSize</a> = (i + 1) * <span class="keyword">sizeof</span> (LARGE_INTEGER);
04218     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o18">DumpFileSize</a> = RequestedFileSize;
04219     <a class="code" href="../../d3/d5/iodata_8c.html#a48">IopDumpControlBlockChecksum</a> = <a class="code" href="../../d0/d6/iop_8h.html#a176">IopGetDumpControlBlockCheck</a> ( IopDumpControlBlock );
04220 
04221     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04222 
04223 Cleanup:
04224 
04225     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS &amp;&amp;
04226         ErrorToLog != STATUS_SUCCESS ) {
04227         
04228         <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a> (0,
04229                           4,
04230                           STATUS_SUCCESS,
04231                           ErrorToLog,
04232                           0,
04233                           NULL,
04234                           0,
04235                           NULL
04236                           );
04237     }
04238 
04239     DeviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04240     
04241     <span class="keywordflow">if</span> ( FileObject ) {
04242         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileObject );
04243         FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04244     }
04245 
04246     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04247 
04248 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="dumpctl.c::IopConfigureCrashDump" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopConfigureCrashDump           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>hPageFile</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04746">4746</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00442">DCB_DUMP_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00443">DCB_SUMMARY_ENABLED</a>, <a class="el" href="../../d0/d5/io_8h.html#a603a420">DeviceUsageTypeDumpFile</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01160">DO_SYSTEM_BOOT_PARTITION</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00469">_DUMP_CONTROL_BLOCK::DumpFileSize</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00457">_DUMP_CONTROL_BLOCK::DumpStack</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00452">_DUMP_CONTROL_BLOCK::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00468">_DUMP_CONTROL_BLOCK::HeaderSize</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00433">IO_DUMP_MEMORY_BLOCK_PAGES</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00335">IoGetDumpStack()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02492">IopCalculateRequiredDumpSpace()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04061">IopCompleteDumpInitialization()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00263">IopDumpControlBlock</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04252">IopFreeDCB()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">IopInitializeDCB()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04393">IopLogErrorEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00458">_DUMP_CONTROL_BLOCK::MemoryDescriptor</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00040">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfPages</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08468">IoPageFileCreated()</a>.
<p>
<pre class="fragment"><div>04751                    :
04752 
04753     This routine configures <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system <span class="keywordflow">for</span> crash dump. The following things
04754     are done:
04755     
04756         1. Initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block and init registry crashdump
04757            parameters.
04758 
04759         2. Configure either page or fast dump.
04760 
04761         3. Complete dump <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> initialization.
04762 
04763     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called as each page <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keywordflow">return</span> value of
04764     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> tells <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller (i.e., NtCreatePagingFiles, IoPageFileCreated)
04765     that crash dump has been configured.
04766 
04767 
04768 Arguments:
04769 
04770        hPageFile - Handle to the paging file
04771 
04772 Return Value:
04773 
04774     TRUE - Configuration complete (or crash dump not enabled).
04775 
04776     FALSE - Error, retry PageFile is not on boot partition.
04777 
04778 --*/
04779 {
04780     ULONG           dwStatus;
04781     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>    fileObject;
04782     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>  deviceObject;
04783 
04784     <span class="comment">//</span>
04785     <span class="comment">// Only Init DCB Once.</span>
04786     <span class="comment">//</span>
04787     
04788     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>) {
04789         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d3/dumpctl_8c.html#a32">IopInitializeDCB</a>()) {
04790             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04791         }
04792     }
04793 
04794     <span class="comment">//</span>
04795     <span class="comment">// Return crash dump not enabled</span>
04796     <span class="comment">//</span>
04797     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>){
04798         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04799     }
04800 
04801     <span class="comment">//</span>
04802     <span class="comment">//  Only autoreboot?</span>
04803     <span class="comment">//</span>
04804     
04805     <span class="keywordflow">if</span> ( !( <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; (<a class="code" href="../../d0/d6/iop_8h.html#a5">DCB_DUMP_ENABLED</a> | <a class="code" href="../../d0/d6/iop_8h.html#a6">DCB_SUMMARY_ENABLED</a>) ) ) {
04806         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04807     }
04808 
04809     <span class="comment">//</span>
04810     <span class="comment">// Configure the paging file for crash dump.</span>
04811     <span class="comment">//</span>
04812 
04813     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"[IoPageFileCreated]: Page file dump\n"</span>));
04814 
04815 
04816     dwStatus = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
04817                                         hPageFile,
04818                                         0,
04819                                         IoFileObjectType,
04820                                         KernelMode,
04821                                         (PVOID *) &amp;fileObject,
04822                                         NULL
04823                                         );
04824 
04825     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( dwStatus )) {
04826         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1,<span class="stringliteral">"[IoPageFileCreated]: ObReferenceObjectByHandle for Paging file failed status = %x\n"</span>,dwStatus));
04827         <span class="keywordflow">goto</span> error_return;
04828     }
04829 
04830     <span class="comment">//</span>
04831     <span class="comment">// Get a pointer to the device object for this file.  Note that it</span>
04832     <span class="comment">// cannot go away, since there is an open handle to it, so it is</span>
04833     <span class="comment">// OK to dereference it and then use it.</span>
04834     <span class="comment">//</span>
04835 
04836     deviceObject = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>;
04837 
04838     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
04839 
04840     <span class="comment">//</span>
04841     <span class="comment">// If this device object does not represents the boot partition return</span>
04842     <span class="comment">// FALSE so MM will try again.</span>
04843     <span class="comment">//</span>
04844     
04845     <span class="keywordflow">if</span> ( ! (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a129">DO_SYSTEM_BOOT_PARTITION</a>) ) {
04846         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04847     }
04848 
04849     <span class="comment">//</span>
04850     <span class="comment">// Load paging file dump stack</span>
04851     <span class="comment">//</span>
04852     
04853     dwStatus = <a class="code" href="../../d2/d3/dumpctl_8c.html#a36">IoGetDumpStack</a> (L<span class="stringliteral">"dump_"</span>,
04854                                &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>,
04855                                DeviceUsageTypeDumpFile,
04856                                FALSE);
04857 
04858     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(dwStatus)) {
04859         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IoPageFileCreated: Could not load dump stack status = %x\n"</span>,dwStatus) );
04860         <span class="keywordflow">goto</span> error_return;
04861     }
04862 
04863     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>-&gt;Init.CrashDump = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04864 
04865     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>-&gt;Init.MemoryBlock = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
04866                                                 NonPagedPool,
04867                                                 IO_DUMP_MEMORY_BLOCK_PAGES * PAGE_SIZE,
04868                                                 'pmuD'
04869                                                 );
04870 
04871     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>-&gt;Init.MemoryBlock) {
04872         dwStatus = STATUS_NO_MEMORY;
04873         <span class="keywordflow">goto</span> error_return;
04874     }
04875 
04876 
04877     <span class="comment">//</span>
04878     <span class="comment">// Calculate the amount of space required for the dump</span>
04879     <span class="comment">//</span>
04880     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o18">DumpFileSize</a> =<a class="code" href="../../d2/d3/dumpctl_8c.html#a33">IopCalculateRequiredDumpSpace</a>(
04881                                                     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a>,
04882                                                     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o17">HeaderSize</a>,
04883                                                     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a>,
04884                                                     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a>
04885                                                     );
04886 
04887 
04888     <span class="comment">//</span>
04889     <span class="comment">// Complete dump initialization</span>
04890     <span class="comment">//</span>
04891 
04892     dwStatus = <a class="code" href="../../d2/d3/dumpctl_8c.html#a34">IopCompleteDumpInitialization</a>(hPageFile);
04893 
04894 error_return:
04895 
04896     <span class="comment">//</span>
04897     <span class="comment">// The BOOT partition paging file could not be configured.</span>
04898     <span class="comment">//   1. Log an error message</span>
04899     <span class="comment">//   2. Return TRUE so that MM does not try again</span>
04900     <span class="comment">//</span>
04901 
04902     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(dwStatus)) {
04903         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1,<span class="stringliteral">"IopPageFileCreated: Page File dump init FAILED status = %x\n"</span>,dwStatus));
04904 
04905         <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a>(0,3,STATUS_SUCCESS,IO_DUMP_PAGE_CONFIG_FAILED,0,NULL,0,NULL);
04906 
04907         <a class="code" href="../../d2/d3/dumpctl_8c.html#a55">IopFreeDCB</a>(FALSE);
04908 
04909     }
04910 
04911     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04912 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="dumpctl.c::IopCreateSummaryDump" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG IopCreateSummaryDump           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSUMMARY_DUMP_HEADER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pHeader</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03815">3815</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00462">_DUMP_CONTROL_BLOCK::HeaderPage</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00468">_DUMP_CONTROL_BLOCK::HeaderSize</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03953">IopDeleteNonExistentMemory()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00263">IopDumpControlBlock</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02291">IoSetDumpRange()</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00027">MmHighestUserAddress</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">MmPhysicalMemoryBlock</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l08083">MmSetKernelDumpRange()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00266">RtlClearAllBits()</a>, and <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03442">IopInitializeSummaryDump()</a>.
<p>
<pre class="fragment"><div>03820                    :
03821 
03822     This routine determines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel memory and data structures to include
03823     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> summary memory dump.
03824 
03825     NOTE: This function uses <a class="code" href="../../d2/d1/mm_8h.html#a291">MmGetPhysicalAddress</a>. <a class="code" href="../../d2/d1/mm_8h.html#a291">MmGetPhysicalAddress</a> does
03826     not acquire any locks. It uses a set of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a6">macros</a> <span class="keywordflow">for</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a46">translation</a>.
03827 
03828 
03829 Arguments:
03830 
03831     pHeader - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump header
03832 
03833     pDcb - <a class="code" href="../../d2/d5/editreg_8c.html#a66">Dump</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block
03834     
03835 Return Value:
03836 
03837     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
03838 
03839 --*/
03840 {
03841     PRTL_BITMAP             pBitMapHeader = (PRTL_BITMAP)(pHeader+1);
03842     ULONG                   Pages;
03843     PCHAR                   VA;
03844     ULONG                   UserPages;
03845     PHYSICAL_ADDRESS        PhyAddr;
03846     ULONG                   i;
03847     PULONG                  pBitMapBuffer;
03848     PUCHAR                  pBitMapBytes;
03849     LARGE_INTEGER           dumpFileSize;
03850     PULONG                  block;
03851     ULONG                   numDumpPages;
03852 
03853     <span class="comment">//</span>
03854     <span class="comment">// The bitmap is the last structure in the header. The</span>
03855     <span class="comment">// buffer is allocated directly after the bitmap header.</span>
03856     <span class="comment">//</span>
03857     <span class="comment">// Initialize Bit Map, set the size and buffer address.</span>
03858     <span class="comment">//</span>
03859     
03860     pBitMapHeader-&gt;SizeOfBitMap = pHeader-&gt;BitmapSize;
03861     pBitMapBuffer = (PULONG)( pBitMapHeader + 1);
03862     pBitMapHeader-&gt;Buffer = pBitMapBuffer;
03863     pBitMapBytes = (PUCHAR)pBitMapBuffer;
03864 
03865     <span class="comment">//</span>
03866     <span class="comment">// Clear all bits</span>
03867     <span class="comment">//</span>
03868 
03869     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a27">RtlClearAllBits</a> (pBitMapHeader);
03870 
03871     <span class="comment">//</span>
03872     <span class="comment">// Have MM initialize the kernel memory to dump</span>
03873     <span class="comment">//</span>
03874     
03875     <a class="code" href="../../d5/d6/iosup_8c.html#a91">MmSetKernelDumpRange</a>(pHeader);
03876 
03877     <span class="comment">//</span>
03878     <span class="comment">// Exclude non-existent memory</span>
03879     <span class="comment">//</span>
03880     
03881     <a class="code" href="../../d2/d3/dumpctl_8c.html#a30">IopDeleteNonExistentMemory</a>(pHeader, MmPhysicalMemoryBlock);
03882 
03883 
03884     Pages = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a> ( pBitMapHeader );
03885     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IopLocalSetBits =       %x\n"</span>,Pages));
03886 
03887     <span class="comment">//</span>
03888     <span class="comment">// See If we have room to Include user va for the current process</span>
03889     <span class="comment">//</span>
03890     
03891     block = <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a>;
03892     dumpFileSize.LowPart= block [DH_REQUIRED_DUMP_SPACE];
03893     dumpFileSize.HighPart= block [DH_REQUIRED_DUMP_SPACE + 1];
03894 
03895     dumpFileSize.QuadPart -= <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o17">HeaderSize</a>;
03896 
03897     <span class="comment">//</span>
03898     <span class="comment">// Total physical pages will not exceed 2&lt;&lt;32 for sometime</span>
03899     <span class="comment">//</span>
03900     
03901     numDumpPages= (ULONG)(dumpFileSize.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03902     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((2,<span class="stringliteral">"IopCreateSummaryDump: numDumpPages: %x Pages : %x\n"</span>, numDumpPages,Pages));
03903 
03904     <span class="comment">//</span>
03905     <span class="comment">// Only copy user virtual if there is enough room in the dump file.</span>
03906     <span class="comment">//</span>
03907     
03908     UserPages = 0;
03909 
03910     <span class="keywordflow">if</span> (Pages &lt; numDumpPages ) {
03911 
03912         <span class="comment">//</span>
03913         <span class="comment">// Stride through user VA and include all valid pages</span>
03914         <span class="comment">//</span>
03915 
03916         <span class="keywordflow">for</span> (VA = 0; VA &lt; (PCHAR)<a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a>; VA+=<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> ) {
03917 
03918             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>( VA ) ) {
03919 
03920                 <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d3/dumpctl_8c.html#a48">IoSetDumpRange</a>(pHeader,VA, 1, FALSE ) ) ) {
03921 
03922                     UserPages++;
03923 
03924                     <span class="comment">//</span>
03925                     <span class="comment">// Break if there is no more room in the dump file</span>
03926                     <span class="comment">//</span>
03927 
03928                     <span class="keywordflow">if</span> (UserPages+Pages &gt;= numDumpPages ) {
03929                         <span class="keywordflow">break</span>;
03930                     }
03931                 }
03932             }
03933         }
03934 
03935     }
03936 
03937     Pages+= UserPages;
03938 
03939     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IopCreateSummaryDump number of user mode pages = %x\n"</span>,UserPages));
03940 
03941     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2, <span class="stringliteral">"SummaryDump: Dump SummaryDumpHeader\n"</span>));
03942     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2, <span class="stringliteral">"SdBitmapSize      =%x\n"</span>, pHeader-&gt;BitmapSize));
03943     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2, <span class="stringliteral">"SdAllBits         =%x\n"</span>, Pages));
03944     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2, <span class="stringliteral">"&amp;SdBitmapBuffer[0]=%x\n"</span>, pBitMapHeader-&gt;Buffer));
03945 
03946 
03947     <span class="keywordflow">return</span> Pages;
03948 
03949 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="dumpctl.c::IopDeleteNonExistentMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDeleteNonExistentMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PSUMMARY_DUMP_HEADER&nbsp;</td>
          <td class="mdname" nowrap> <em>pHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MmPhysicalMemoryBlock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03953">3953</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00034">_PHYSICAL_MEMORY_RUN::BasePage</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02193">IopRemovePageFromPageMap()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">MmPhysicalMemoryBlock</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00039">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfRuns</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00035">_PHYSICAL_MEMORY_RUN::PageCount</a>, and <a class="el" href="../../d3/d0/mm_8h-source.html#l00041">_PHYSICAL_MEMORY_DESCRIPTOR::Run</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03815">IopCreateSummaryDump()</a>.
<p>
<pre class="fragment"><div>03959                    :
03960 
03961     This deletes non existent memory. Non existent memory <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> defined as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03962     unassigned memory between memory runs. For example, memory between
03963     (run[0].base + size) and run[1].base.
03964     
03965 Arguments:
03966 
03967     pHeader - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> summary dump header.
03968     
03969     dwStartingIndex - The starting bit index in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bitmap (starting page).
03970 
03971     dwMemoryAddress - Pseudo-<span class="keyword">virtual</span> address being mapped.
03972 
03973     dwByteCount - The number of bytes to copy.
03974 
03975     dwMaxBitmapBit - The limit or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> highest possible valid bit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bitmap.
03976 
03977     pMdl - The <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> to create.
03978 
03979 Return Value:
03980 
03981     (none)
03982     
03983 --*/
03984 {
03985     <a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PPHYSICAL_MEMORY_RUN</a>    Run;
03986     ULONG                   NumberOfRuns;
03987     ULONG                   i;
03988     PFN_NUMBER              CurrentPageFrame, NextPageFrame;
03989     PRTL_BITMAP             pBitMapHeader;
03990 
03991     NumberOfRuns            = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>;
03992 
03993     Run = &amp;<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[0];
03994 
03995     pBitMapHeader = (PRTL_BITMAP)(pHeader + 1);
03996     i = 0;
03997 
03998     CurrentPageFrame = 1;
03999 
04000     NextPageFrame = Run-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
04001 
04002     <span class="comment">//</span>
04003     <span class="comment">// Remove the gap from 0 till the first run.</span>
04004     <span class="comment">//</span>
04005     
04006     <span class="keywordflow">if</span> (NextPageFrame &gt; CurrentPageFrame) {
04007 
04008         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>( (2,<span class="stringliteral">"DeleteNonExistentMemory: %x - %x\n"</span>,
04009             CurrentPageFrame,
04010             (NextPageFrame - CurrentPageFrame) ) );
04011 
04012         <span class="comment">//</span>
04013         <span class="comment">// FIXFIX - handle page frame numbers greater than 32 bits.</span>
04014         <span class="comment">//</span>
04015 
04016         <a class="code" href="../../d2/d3/dumpctl_8c.html#a45">IopRemovePageFromPageMap</a> (pHeader-&gt;BitmapSize,
04017                                   pBitMapHeader,
04018                                   (ULONG)CurrentPageFrame,
04019                                   (ULONG)(NextPageFrame-CurrentPageFrame)
04020                                   );
04021 
04022     }
04023 
04024     <span class="comment">//</span>
04025     <span class="comment">// Remove the gaps between runs.</span>
04026     <span class="comment">//</span>
04027     
04028     <span class="keywordflow">while</span> (i &lt; NumberOfRuns - 1) {
04029     
04030         CurrentPageFrame = Run-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> + Run-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
04031         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2, <span class="stringliteral">"Run[%x]: Base=%x, Pages=%x\n"</span>, i, Run-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>, Run-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>));
04032 
04033         i++;
04034         Run++;
04035 
04036         <span class="comment">//</span>
04037         <span class="comment">// Get the next starting BasePage.</span>
04038         <span class="comment">//</span>
04039         
04040         NextPageFrame = Run-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
04041 
04042         <span class="keywordflow">if</span> (NextPageFrame != CurrentPageFrame) {
04043 
04044             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2, <span class="stringliteral">"DeleteNonExistentMemory: %x - %x\n"</span>, NextPageFrame, CurrentPageFrame));
04045 
04046             <span class="comment">//</span>
04047             <span class="comment">// FIXFIX - handle page frame numbers greater than 32 bits.</span>
04048             <span class="comment">//</span>
04049 
04050             <a class="code" href="../../d2/d3/dumpctl_8c.html#a45">IopRemovePageFromPageMap</a> (pHeader-&gt;BitmapSize,
04051                                       pBitMapHeader,
04052                                       (ULONG)CurrentPageFrame,
04053                                       (ULONG)(NextPageFrame - CurrentPageFrame)
04054                                       );
04055         }
04056     }
04057 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="dumpctl.c::IopFreeDCB" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopFreeDCB           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">BOOLEAN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FreeDCB</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04252">4252</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00444">DCB_AUTO_REBOOT</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00457">_DUMP_CONTROL_BLOCK::DumpStack</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00460">_DUMP_CONTROL_BLOCK::FileDescriptorArray</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00452">_DUMP_CONTROL_BLOCK::Flags</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00462">_DUMP_CONTROL_BLOCK::HeaderPage</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01300">IoFreeDumpStack()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00263">IopDumpControlBlock</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00458">_DUMP_CONTROL_BLOCK::MemoryDescriptor</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04746">IopConfigureCrashDump()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04325">IoSetCrashDumpState()</a>.
<p>
<pre class="fragment"><div>04258                    :
04259 
04260     Free dump <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block storage.
04261 
04262 Arguments:
04263 
04264     FreeDCB - Implictly free storage <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
04265 
04266 Return Value:
04267 
04268     None
04269 
04270 --*/
04271 {
04272     <a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a> dcb;
04273     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            dwStatus;
04274     BOOLEAN             ShouldFreeDCB;
04275 
04276     dcb = <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>;
04277 
04278 
04279     <span class="keywordflow">if</span> (dcb) {
04280 
04281         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>) {
04282              <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>);
04283              dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>      = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04284         }
04285 
04286         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a>) {
04287             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a>);
04288             dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a>             = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04289         }
04290 
04291         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o9">FileDescriptorArray</a>) {
04292             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o9">FileDescriptorArray</a>);
04293             dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o9">FileDescriptorArray</a>    = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04294         }
04295 
04296         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>) {
04297             <a class="code" href="../../d2/d3/dumpctl_8c.html#a41">IoFreeDumpStack</a> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>);
04298             dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>              = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04299         }
04300 
04301         ShouldFreeDCB = FreeDCB | !( dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a7">DCB_AUTO_REBOOT</a>);
04302 
04303         <span class="comment">//</span>
04304         <span class="comment">// Disable all options that require dump file access</span>
04305         <span class="comment">//</span>
04306         
04307         dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a7">DCB_AUTO_REBOOT</a>;
04308 
04309         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"[IopFreeDCB] Should Free DCB = %s\n"</span>,(ShouldFreeDCB ? <span class="stringliteral">"TRUE"</span> : <span class="stringliteral">"FALSE"</span>)));
04310 
04311         <span class="keywordflow">if</span> (ShouldFreeDCB) {
04312             <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04313             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( dcb );
04314             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"[IopFreeDCB]: Freeing Dump Control Block\n"</span>));
04315         }
04316     }
04317 
04318     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"[IopFreeDCB]: CRASH DUMP DISABLED\n"</span>));
04319 
04320 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="dumpctl.c::IopGetDumpControlBlockCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG IopGetDumpControlBlockCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Dcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01062">1062</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d0/d6/iop_8h.html#a73">DUMP_CONTROL_BLOCK</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a>, <a class="el" href="../../d0/d5/io_8h.html#a280">PDUMP_STACK_IMAGE</a>, and <a class="el" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck()</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04061">IopCompleteDumpInitialization()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.
<p>
<pre class="fragment"><div>01067                    :
01068 
01069     Return <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current checksum total <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Dcb
01070 
01071 Arguments:
01072 
01073     DumpStack           - <a class="code" href="../../d2/d5/editreg_8c.html#a66">Dump</a> driver stack to checksum
01074 
01075 Return Value:
01076 
01077     Checksum value
01078 
01079 --*/
01080 {
01081     ULONG                   Check;
01082     PLIST_ENTRY             Link;
01083     <a class="code" href="../../d0/d5/io_8h.html#a280">PDUMP_STACK_IMAGE</a>       DumpImage;
01084     PMAPPED_ADDRESS         MappedAddress;
01085     <a class="code" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a>     DumpStack;
01086 
01087 
01088     <span class="comment">//</span>
01089     <span class="comment">// Check the DCB, memory descriptor array, and the FileDescriptorArray</span>
01090     <span class="comment">//</span>
01091 
01092     Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(0, Dcb, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">DUMP_CONTROL_BLOCK</a>));
01093     Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(
01094                 Check,
01095                 Dcb-&gt;MemoryDescriptor,
01096                 Dcb-&gt;MemoryDescriptorLength
01097                 );
01098 
01099     Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(Check, Dcb-&gt;FileDescriptorArray, Dcb-&gt;FileDescriptorSize);
01100 
01101     DumpStack = Dcb-&gt;DumpStack;
01102     <span class="keywordflow">if</span> (DumpStack) {
01103 
01104         <span class="comment">//</span>
01105         <span class="comment">// Include the dump stack context structure, and dump driver images</span>
01106         <span class="comment">//</span>
01107 
01108         Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(Check, DumpStack, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/structDUMP__STACK__CONTEXT.html">DUMP_STACK_CONTEXT</a>));
01109         Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(Check, DumpStack-&gt;DumpPointers, DumpStack-&gt;PointersLength);
01110 
01111         <span class="keywordflow">for</span> (Link = DumpStack-&gt;DriverList.Flink;
01112              Link != &amp;DumpStack-&gt;DriverList;
01113              Link = Link-&gt;Flink) {
01114 
01115             DumpImage = CONTAINING_RECORD(Link, <a class="code" href="../../d4/d8/structDUMP__STACK__IMAGE.html">DUMP_STACK_IMAGE</a>, Link);
01116             Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(Check, DumpImage, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/structDUMP__STACK__IMAGE.html">DUMP_STACK_IMAGE</a>));
01117             Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a>(Check, DumpImage-&gt;ImageBase, DumpImage-&gt;SizeOfImage);
01118         }
01119 
01120         <span class="comment">//</span>
01121         <span class="comment">// Include the mapped addresses</span>
01122         <span class="comment">//</span>
01123         <span class="comment">// If this is non-null it is treated as a PMAPPED_ADDRESS * (see scsiport and atdisk)</span>
01124         <span class="comment">//</span>
01125         <span class="keywordflow">if</span> (DumpStack-&gt;Init.MappedRegisterBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01126             MappedAddress = *(PMAPPED_ADDRESS *)DumpStack-&gt;Init.MappedRegisterBase;
01127         } <span class="keywordflow">else</span> {
01128             MappedAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01129         }
01130 
01131         <span class="keywordflow">while</span> (MappedAddress) {
01132             Check = <a class="code" href="../../d1/d2/po_8h.html#a68">PoSimpleCheck</a> (Check, MappedAddress, <span class="keyword">sizeof</span>(MAPPED_ADDRESS));
01133             MappedAddress = MappedAddress-&gt;NextMappedAddress;
01134         }
01135     }
01136 
01137     <span class="keywordflow">return</span> Check;
01138 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="dumpctl.c::IopGetDumpStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetDumpStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>ModulePrefix</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pDumpStack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>pUniDeviceName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>pDumpDriverName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/io_8h.html#a362">DEVICE_USAGE_NOTIFICATION_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>UsageType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreDeviceUsageFailure</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">384</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l00322">_INITIALIZATION_CONTEXT::AdapterObject</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00316">_INITIALIZATION_CONTEXT::CommonBuffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00327">_INITIALIZATION_CONTEXT::CommonBufferSize</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01366">_DRIVER_OBJECT::DeviceObject</a>, <a class="el" href="../../d0/d5/io_8h.html#a603a417">DeviceUsageTypeUndefined</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00314">_INITIALIZATION_CONTEXT::DiskSignature</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01385">_DRIVER_OBJECT::DriverName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d2/d7/hal_8h.html#a227">HalAllocateCommonBuffer()</a>, <a class="el" href="../../d0/d5/io_8h.html#a270">INITIALIZATION_CONTEXT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00434">IO_DUMP_COMMON_BUFFER_SIZE</a>, <a class="el" href="../../d0/d5/io_8h.html#a373">IO_STACK_LOCATION</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01300">IoFreeDumpStack()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00954">IopLoadDumpDriver()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04393">IopLogErrorEvent()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00381">IopSynchronousCall()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00183">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00097">KeGetBugMessageText()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d7/hal_8h.html#a206">KeStallExecutionProcessor()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00313">_INITIALIZATION_CONTEXT::Length</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00323">_INITIALIZATION_CONTEXT::MappedRegisterBase</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03881">MmAllocateContiguousMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05581">MmAllocateNonCachedMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05490">MmGetPhysicalAddress()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d7/hal_8h.html#a127">PDMA_ADAPTER</a>, <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00317">_INITIALIZATION_CONTEXT::PhysicalAddress</a>, <a class="el" href="../../d0/d5/io_8h.html#a271">PINITIALIZATION_CONTEXT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00324">_INITIALIZATION_CONTEXT::PortConfiguration</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00093">SCSIPORT_DRIVER_NAME</a>, <a class="el" href="../../d6/d9/heappage_8c.html#a68">sprintf()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00318">_INITIALIZATION_CONTEXT::StallRoutine</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00328">_INITIALIZATION_CONTEXT::TargetAddress</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00582">ZwOpenFile()</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00335">IoGetDumpStack()</a>.
<p>
<pre class="fragment"><div>00394                    :
00395 
00396     This routine loads a dump stack instance and returns an allocated
00397     context structure to track <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loaded dumps stack.
00398 
00399 Arguments:
00400 
00401     ModePrefix      - The prefix to prepent to <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a> during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> load
00402                       operation.  This allows loading <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same drivers
00403                       multiple times with different <span class="keyword">virtual</span> names and
00404                       linkages.
00405 
00406     pDumpStack      - The returned dump stack context structure
00407 
00408     pDeviceName     - The name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target dump device
00409 
00410     pDumpDriverName - The name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target dump driver
00411 
00412     UsageType       - The Device Notification <a class="code" href="../../d1/d1/hivedmp_8c.html#a6">Usage</a> Type <span class="keywordflow">for</span> <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, that
00413                       <span class="keyword">this</span> routine will send as to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object once <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00414                       <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> has been successfully created and initialized.
00415 
00416     IgnoreDeviceUsageFailure - If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Device <a class="code" href="../../d1/d1/hivedmp_8c.html#a6">Usage</a> Notification <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> fails, allow
00417                       <span class="keyword">this</span> to succeed anyway.
00418 
00419 Return Value:
00420 
00421     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
00422 
00423 --*/
00424 {
00425     <a class="code" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a>         DumpStack;
00426     PUCHAR                      <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00427     PUCHAR                      PartitionName;
00428     ANSI_STRING                 AnsiString;
00429     UNICODE_STRING              TempName;
00430     OBJECT_ATTRIBUTES           <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00431     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00432     HANDLE                      DeviceHandle;
00433     SCSI_ADDRESS                ScsiAddress;
00434     BOOLEAN                     ScsiDump;
00435     PARTITION_INFORMATION       PartitionInfo;
00436     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>                FileObject;
00437     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>              DeviceObject;
00438     <a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html">PINITIALIZATION_CONTEXT</a>     DumpInit;
00439     PDUMP_POINTERS              DumpPointers;
00440     UNICODE_STRING              DriverName;
00441     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>              DriverObject;
00442     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>                        <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
00443     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>          IrpSp;
00444     IO_STATUS_BLOCK             IoStatus;
00445     PWCHAR                      DumpName, NameOffset;
00446     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>                      <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00447     PVOID                       p1;
00448     PHYSICAL_ADDRESS            pa;
00449     ULONG                       i;
00450     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>           irpSp;
00451     ULONG                       information;
00452 
00453     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IopGetDumpStack: Prefix:%ws stk: %x device:%ws driver:%ws\n"</span>,
00454                 ModulePrefix, pDumpStack, pUniDeviceName-&gt;Buffer,pDumpDriverName));
00455 
00456     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DeviceUsageTypeUndefined != UsageType);
00457 
00458     DumpStack = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
00459                     NonPagedPool,
00460                     <span class="keyword">sizeof</span> (<a class="code" href="../../d3/d8/structDUMP__STACK__CONTEXT.html">DUMP_STACK_CONTEXT</a>) + <span class="keyword">sizeof</span> (DUMP_POINTERS),
00461                     'pmuD'
00462                     );
00463 
00464     <span class="keywordflow">if</span> (!DumpStack) {
00465         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00466     }
00467 
00468     RtlZeroMemory(DumpStack, <span class="keyword">sizeof</span>(DUMP_STACK_CONTEXT)+<span class="keyword">sizeof</span>(DUMP_POINTERS));
00469     DumpInit = &amp;DumpStack-&gt;Init;
00470     DumpPointers = (PDUMP_POINTERS) (DumpStack + 1);
00471     DumpStack-&gt;DumpPointers = DumpPointers;
00472     InitializeListHead (&amp;DumpStack-&gt;DriverList);
00473     DumpName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00474 
00475     <span class="comment">//</span>
00476     <span class="comment">// Allocate scratch buffer</span>
00477     <span class="comment">//</span>
00478 
00479     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool, PAGE_SIZE, 'pmuD');
00480     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) {
00481         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DumpStack);
00482         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00483     }
00484 
00485     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d1/bugcheck_8c.html#a14">KeGetBugMessageText</a>(BUGCODE_PSS_CRASH_INIT, &amp;DumpStack-&gt;InitMsg) ||
00486         !<a class="code" href="../../d9/d1/bugcheck_8c.html#a14">KeGetBugMessageText</a>(BUGCODE_PSS_CRASH_PROGRESS, &amp;DumpStack-&gt;ProgMsg) ||
00487         !<a class="code" href="../../d9/d1/bugcheck_8c.html#a14">KeGetBugMessageText</a>(BUGCODE_PSS_CRASH_DONE, &amp;DumpStack-&gt;DoneMsg)) {
00488             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00489             <span class="keywordflow">goto</span> Done;
00490     }
00491 
00492     InitializeObjectAttributes(
00493         &amp;ObjectAttributes,
00494         pUniDeviceName,
00495         0,
00496         NULL,
00497         NULL
00498         );
00499 
00500     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(
00501               &amp;DeviceHandle,
00502               FILE_READ_DATA | SYNCHRONIZE,
00503               &amp;ObjectAttributes,
00504               &amp;IoStatus,
00505               FILE_SHARE_READ | FILE_SHARE_WRITE,
00506               FILE_NON_DIRECTORY_FILE
00507               );
00508 
00509     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00510         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((0,
00511                        <span class="stringliteral">"IODUMP: Could not open boot device partition, %s\n"</span>,
00512                        Buffer
00513                        ));
00514         <span class="keywordflow">goto</span> Done;
00515     }
00516 
00517     <span class="comment">//</span>
00518     <span class="comment">// Check to see whether or not the system was booted from a SCSI device.</span>
00519     <span class="comment">//</span>
00520 
00521     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeviceIoControlFile (
00522                     DeviceHandle,
00523                     NULL,
00524                     NULL,
00525                     NULL,
00526                     &amp;IoStatus,
00527                     IOCTL_SCSI_GET_ADDRESS,
00528                     NULL,
00529                     0,
00530                     &amp;ScsiAddress,
00531                     <span class="keyword">sizeof</span>( SCSI_ADDRESS )
00532                     );
00533 
00534     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00535         ZwWaitForSingleObject (
00536             DeviceHandle,
00537             FALSE,
00538             NULL
00539             );
00540 
00541         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatus.Status;
00542     }
00543 
00544     ScsiDump = (BOOLEAN) (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00545 
00546     <span class="comment">//</span>
00547     <span class="comment">// If SCSI then allocate storage to contain the target address information.</span>
00548     <span class="comment">//</span>
00549 
00550     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o15">TargetAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00551 
00552     <span class="keywordflow">if</span> (ScsiDump) {
00553 
00554         DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o15">TargetAddress</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
00555                                     NonPagedPool,
00556                                     <span class="keyword">sizeof</span> (SCSI_ADDRESS),
00557                                     'pmuD'
00558                                     );
00559         <span class="comment">//</span>
00560         <span class="comment">// It is ok If the allocation fails. The scsi dump driver will scan</span>
00561         <span class="comment">// all devices if the targetaddress information does not exist</span>
00562         <span class="comment">//</span>
00563 
00564         <span class="keywordflow">if</span> (DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o15">TargetAddress</a>) {
00565             RtlCopyMemory(DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o15">TargetAddress</a>,&amp;ScsiAddress,<span class="keyword">sizeof</span>(SCSI_ADDRESS));
00566         }
00567     }
00568 
00569     <span class="comment">//</span>
00570     <span class="comment">// Determine the disk signature for the device from which the system was</span>
00571     <span class="comment">// booted and get the partition offset.</span>
00572     <span class="comment">//</span>
00573 
00574     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeviceIoControlFile(
00575                     DeviceHandle,
00576                     NULL,
00577                     NULL,
00578                     NULL,
00579                     &amp;IoStatus,
00580                     IOCTL_DISK_GET_PARTITION_INFO,
00581                     NULL,
00582                     0,
00583                     &amp;PartitionInfo,
00584                     <span class="keyword">sizeof</span>( PARTITION_INFORMATION )
00585                     );
00586 
00587     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00588         ZwWaitForSingleObject (
00589             DeviceHandle,
00590             FALSE,
00591             NULL
00592             );
00593 
00594         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatus.Status;
00595     }
00596 
00597     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"Partition Type = %x\n"</span>,PartitionInfo.PartitionType));
00598     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"Boot Indicator = %x\n"</span>,PartitionInfo.BootIndicator));
00599 
00600     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeviceIoControlFile(
00601                     DeviceHandle,
00602                     NULL,
00603                     NULL,
00604                     NULL,
00605                     &amp;IoStatus,
00606                     IOCTL_DISK_GET_DRIVE_LAYOUT,
00607                     NULL,
00608                     0,
00609                     Buffer,
00610                     PAGE_SIZE
00611                     );
00612 
00613     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00614         ZwWaitForSingleObject (
00615             DeviceHandle,
00616             FALSE,
00617             NULL
00618             );
00619 
00620         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatus.Status;
00621     }
00622 
00623     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o1">DiskSignature</a> = ((PDRIVE_LAYOUT_INFORMATION) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;Signature;
00624 
00625     <span class="comment">//</span>
00626     <span class="comment">// Get the adapter object and base mapping registers for the disk from</span>
00627     <span class="comment">// the disk driver.  These will be used to call the HAL once the system</span>
00628     <span class="comment">// system has crashed, since it is not possible at that point to recreate</span>
00629     <span class="comment">// them from scratch.</span>
00630     <span class="comment">//</span>
00631 
00632     <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
00633             DeviceHandle,
00634             0,
00635             IoFileObjectType,
00636             KernelMode,
00637             (PVOID *) &amp;FileObject,
00638             NULL
00639             );
00640 
00641 
00642     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a> (FileObject);
00643 
00644     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;Event, NotificationEvent, FALSE );
00645 
00646     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>(
00647                 IOCTL_SCSI_GET_DUMP_POINTERS,
00648                 DeviceObject,
00649                 NULL,
00650                 0,
00651                 DumpPointers,
00652                 <span class="keyword">sizeof</span> (DUMP_POINTERS),
00653                 FALSE,
00654                 &amp;Event,
00655                 &amp;IoStatus
00656                 );
00657 
00658     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>) {
00659         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (FileObject);
00660         ZwClose (DeviceHandle);
00661         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00662         <span class="keywordflow">goto</span> Done;
00663     }
00664 
00665     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a> (Irp);
00666 
00667     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
00668 
00669     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( DeviceObject, Irp );
00670 
00671     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00672         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;Event, Executive, KernelMode, FALSE, NULL);
00673         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IoStatus.Status;
00674     }
00675 
00676     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)  ||  IoStatus.Information &lt; FIELD_OFFSET(DUMP_POINTERS, DeviceObject)) {
00677 
00678         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((0,
00679                        <span class="stringliteral">"IODUMP: Could not get dump pointers; error = %x, length %x\n"</span>,
00680                         Status,
00681                         IoStatus.Information
00682                         ));
00683         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (FileObject);
00684 <span class="comment">//      NtClose (DeviceHandle);</span>
00685         ZwClose (DeviceHandle);
00686         <span class="keywordflow">goto</span> Done;
00687     }
00688     DumpStack-&gt;PointersLength = (ULONG) IoStatus.Information;
00689 
00690     <span class="comment">//</span>
00691     <span class="comment">// If the driver returned a pointer to a device object, that is the</span>
00692     <span class="comment">// object for the dump driver  (non-scsi case)</span>
00693     <span class="comment">//</span>
00694 
00695     DeviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) DumpPointers-&gt;DeviceObject;
00696     <span class="keywordflow">if</span> (DeviceObject) {
00697         DriverObject = DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>;
00698 
00699         <span class="comment">//</span>
00700         <span class="comment">// Loop through the name of the driver looking for the end of the name,</span>
00701         <span class="comment">// which is the name of the dump image.</span>
00702         <span class="comment">//</span>
00703 
00704         DumpName = DriverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Buffer;
00705         <span class="keywordflow">while</span> ( NameOffset = wcsstr( DumpName, L<span class="stringliteral">"\\"</span> )) {
00706             DumpName = ++NameOffset;
00707         }
00708 
00709         ScsiDump = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00710     }
00711 
00712     <span class="comment">//</span>
00713     <span class="comment">// Release the handle, but keep the reference to the file object as it</span>
00714     <span class="comment">// will be needed at free dump dump driver time</span>
00715     <span class="comment">//</span>
00716 
00717     DumpStack-&gt;FileObject = FileObject;
00718     ZwClose (DeviceHandle);
00719 
00720     <span class="comment">//</span>
00721     <span class="comment">// Fill in some DumpInit results</span>
00722     <span class="comment">//</span>
00723 
00724     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o0">Length</a>             = <span class="keyword">sizeof</span> (<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html">INITIALIZATION_CONTEXT</a>);
00725     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o5">StallRoutine</a>       = &amp;<a class="code" href="../../d2/d7/hal_8h.html#a206">KeStallExecutionProcessor</a>;
00726     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>      = DumpPointers-&gt;AdapterObject;
00727     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o10">MappedRegisterBase</a> = DumpPointers-&gt;MappedRegisterBase;
00728     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o11">PortConfiguration</a>  = DumpPointers-&gt;DumpData;
00729 
00730     DumpStack-&gt;ModulePrefix      = ModulePrefix;
00731     DumpStack-&gt;PartitionOffset   = PartitionInfo.StartingOffset;
00732     DumpStack-&gt;UsageType         = <a class="code" href="../../d0/d5/io_8h.html#a603a417">DeviceUsageTypeUndefined</a>;
00733 
00734     <span class="comment">//</span>
00735     <span class="comment">// The minimum common buffer size is IO_DUMP_COMMON_BUFFER_SIZE (compatability)</span>
00736     <span class="comment">// This is used by the dump driver for SRB extension, CachedExtension, and sense buffer</span>
00737     <span class="comment">//</span>
00738     <span class="keywordflow">if</span> (DumpPointers-&gt;CommonBufferSize &lt; <a class="code" href="../../d0/d5/io_8h.html#a115">IO_DUMP_COMMON_BUFFER_SIZE</a>) {
00739         DumpPointers-&gt;CommonBufferSize = <a class="code" href="../../d0/d5/io_8h.html#a115">IO_DUMP_COMMON_BUFFER_SIZE</a>;
00740     }
00741     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o14">CommonBufferSize</a>    = DumpPointers-&gt;CommonBufferSize;
00742 
00743     <span class="comment">//</span>
00744     <span class="comment">// Allocate the required common buffers</span>
00745     <span class="comment">//</span>
00746 
00747     <span class="keywordflow">if</span> (DumpPointers-&gt;AllocateCommonBuffers) {
00748         pa.QuadPart = 0x1000000 - 1;
00749         <span class="keywordflow">for</span> (i=0; i &lt; 2; i++) {
00750             <span class="keywordflow">if</span> (DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>) {
00751 
00752 <span class="preprocessor">#if !defined(NO_LEGACY_DRIVERS)</span>
00753 <span class="preprocessor"></span>                p1 = <a class="code" href="../../d2/d7/hal_8h.html#a227">HalAllocateCommonBuffer</a>(
00754                     DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>,
00755                     DumpPointers-&gt;CommonBufferSize,
00756                     &amp;pa,
00757                     FALSE
00758                     );
00759                 
00760 <span class="preprocessor">#else</span>
00761 <span class="preprocessor"></span>                p1 = (*((<a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a>)DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>)-&gt;DmaOperations-&gt;
00762                       AllocateCommonBuffer)(
00763                           (<a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a>)DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o9">AdapterObject</a>,
00764                           DumpPointers-&gt;CommonBufferSize,
00765                           &amp;pa,
00766                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00767                           );
00768                 
00769 <span class="preprocessor">#endif // NO_LEGACY_DRIVERS</span>
00770 <span class="preprocessor"></span>                        
00771             } <span class="keywordflow">else</span> {
00772                 p1 = <a class="code" href="../../d5/d6/iosup_8c.html#a60">MmAllocateContiguousMemory</a> (
00773                         DumpPointers-&gt;CommonBufferSize,
00774                         pa
00775                         );
00776 
00777                 <span class="keywordflow">if</span> (!p1) {
00778                     p1 = <a class="code" href="../../d5/d6/iosup_8c.html#a70">MmAllocateNonCachedMemory</a> (DumpPointers-&gt;CommonBufferSize);
00779                 }
00780                 pa = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a>(p1);
00781             }
00782 
00783             <span class="keywordflow">if</span> (!p1) {
00784                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((0, <span class="stringliteral">"IODUMP: Could not allocate common buffers for dump\n"</span>));
00785                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00786                 <span class="keywordflow">goto</span> Done;
00787             }
00788 
00789             DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o3">CommonBuffer</a>[i] = p1;
00790             DumpInit-&gt;<a class="code" href="../../d6/d2/struct__INITIALIZATION__CONTEXT.html#o4">PhysicalAddress</a>[i] = pa;
00791         }
00792     }
00793 
00794     <span class="comment">//</span>
00795     <span class="comment">// Determine whether or not the system booted from SCSI.</span>
00796     <span class="comment">//</span>
00797 
00798     <span class="keywordflow">if</span> (ScsiDump) {
00799 
00800         <span class="comment">//</span>
00801         <span class="comment">// Load the boot disk and port driver to be used by the various</span>
00802         <span class="comment">// miniports for writing memory to the disk.</span>
00803         <span class="comment">//</span>
00804 
00805         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a24">IopLoadDumpDriver</a> (
00806                         DumpStack,
00807                         pDumpDriverName,
00808                         SCSIPORT_DRIVER_NAME
00809                         );
00810 
00811         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00812 
00813             <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a>(0,9,STATUS_SUCCESS,IO_DUMP_DRIVER_LOAD_FAILURE,0,NULL,0,NULL);
00814             <span class="keywordflow">goto</span> Done;
00815         }
00816 
00817         <span class="comment">//</span>
00818         <span class="comment">// The disk and port dump driver has been loaded.  Load the appropriate</span>
00819         <span class="comment">// miniport driver as well so that the boot device can be accessed.</span>
00820         <span class="comment">//</span>
00821 
00822         DriverName.Length = 0;
00823         DriverName.Buffer = (PVOID) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00824         DriverName.MaximumLength = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00825 
00826 
00827         <span class="comment">//</span>
00828         <span class="comment">// The system was booted from SCSI. Get the name of the appropriate</span>
00829         <span class="comment">// miniport driver and load it.</span>
00830         <span class="comment">//</span>
00831 
00832         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(Buffer, <span class="stringliteral">"\\Device\\ScsiPort%d"</span>, ScsiAddress.PortNumber );
00833         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;AnsiString, Buffer );
00834         <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;TempName, &amp;AnsiString, TRUE );
00835         InitializeObjectAttributes(
00836                     &amp;ObjectAttributes,
00837                     &amp;TempName,
00838                     0,
00839                     NULL,
00840                     NULL
00841                     );
00842 
00843         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d9/restrfil_8c.html#a33">ZwOpenFile</a>(
00844                     &amp;DeviceHandle,
00845                     FILE_READ_ATTRIBUTES,
00846                     &amp;ObjectAttributes,
00847                     &amp;IoStatus,
00848                     FILE_SHARE_READ | FILE_SHARE_WRITE,
00849                     FILE_NON_DIRECTORY_FILE
00850                     );
00851 
00852         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;TempName );
00853         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00854             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((0,
00855                            <span class="stringliteral">"IODUMP: Could not open SCSI port %d, error = %x\n"</span>,
00856                            ScsiAddress.PortNumber,
00857                            Status
00858                            ));
00859             <span class="keywordflow">goto</span> Done;
00860         }
00861 
00862         <span class="comment">//</span>
00863         <span class="comment">// Convert the file handle into a pointer to the device object, and</span>
00864         <span class="comment">// get the name of the driver from its driver object.</span>
00865         <span class="comment">//</span>
00866 
00867         <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00868                     DeviceHandle,
00869                     0,
00870                     IoFileObjectType,
00871                     KernelMode,
00872                     (PVOID *) &amp;FileObject,
00873                     NULL
00874                     );
00875 
00876         DriverObject = FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>;
00877         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileObject );
00878         ZwClose( DeviceHandle );
00879         <span class="comment">//</span>
00880         <span class="comment">// Loop through the name of the driver looking for the end of the name,</span>
00881         <span class="comment">// which is the name of the miniport image.</span>
00882         <span class="comment">//</span>
00883 
00884         DumpName = DriverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>.Buffer;
00885         <span class="keywordflow">while</span> ( NameOffset = wcsstr( DumpName, L<span class="stringliteral">"\\"</span> )) {
00886             DumpName = ++NameOffset;
00887         }
00888     }
00889 
00890     <span class="comment">//</span>
00891     <span class="comment">// Load the dump driver</span>
00892     <span class="comment">//</span>
00893 
00894     <span class="keywordflow">if</span> (!DumpName) {
00895         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_SUPPORTED;
00896         <span class="keywordflow">goto</span> Done;
00897     }
00898 
00899     swprintf ((PWCHAR) Buffer, L<span class="stringliteral">"\\SystemRoot\\System32\\Drivers\\%s.sys"</span>, DumpName);
00900     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a24">IopLoadDumpDriver</a> (
00901                     DumpStack,
00902                     (PWCHAR) Buffer,
00903                     NULL
00904                     );
00905     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00906 
00907         <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a>(0,10,STATUS_SUCCESS,IO_DUMP_DRIVER_LOAD_FAILURE,0,NULL,0,NULL);
00908         <span class="keywordflow">goto</span> Done;
00909     }
00910 
00911     <span class="comment">//</span>
00912     <span class="comment">// Claim the file as part of specific device usage path.</span>
00913     <span class="comment">//</span>
00914 
00915     FileObject = DumpStack-&gt;FileObject;
00916     DeviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a> (FileObject);
00917 
00918     RtlZeroMemory (&amp;irpSp, <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
00919 
00920     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
00921     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a86">IRP_MN_DEVICE_USAGE_NOTIFICATION</a>;
00922     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.UsageNotification.Type = UsageType;
00923     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.UsageNotification.InPath = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00924     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
00925 
00926     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a> (DeviceObject, &amp;irpSp, (VOID **) &amp;information);
00927     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (0 == information);
00928 
00929     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp; IgnoreDeviceUsageFailure) {
00930         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((0,
00931                        <span class="stringliteral">"IopGetDumpStack: DEVICE_USAGE_NOTIFICATION "</span>
00932                        <span class="stringliteral">"Error ignored (%x)\n"</span>,
00933                        Status));
00934         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00935     }
00936 
00937     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00938         DumpStack-&gt;UsageType         = UsageType;
00939     }
00940 
00941 Done:
00942     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00943         *pDumpStack = DumpStack;
00944     } <span class="keywordflow">else</span> {
00945         <a class="code" href="../../d2/d3/dumpctl_8c.html#a41">IoFreeDumpStack</a> (DumpStack);
00946     }
00947     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Buffer);
00948     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00949 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="dumpctl.c::IopGetDumpStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetDumpStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>ModulePrefix</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>pDumpStack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>pUniDeviceName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>pDumpDriverName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/io_8h.html#a362">DEVICE_USAGE_NOTIFICATION_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>UsageType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreDeviceUsageFailure</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="dumpctl.c::IopGetLoadedDriverInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetLoadedDriverInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>lpDriverCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>lpSizeOfStringData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02602">2602</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00067">DriverEntry()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00287">IopIsAddressRangeValid()</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02795">IopWriteTriageDump()</a>.
<p>
<pre class="fragment"><div>02609                    :
02610 
02611     Get information about all loaded drivers.
02612 
02613 Arguments:
02614 
02615     lpDriverCount - <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> count of all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> drivers that are
02616                     currently loaded in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
02617 
02618     lpSizeOfStringData - <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sum of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sizes of all driver
02619                     name strings (FullDllName). This does not include <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size
02620                     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UNICODE_STRING structure or a trailing <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> byte.
02621 
02622 Return Values:
02623 
02624     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02625 
02626 --*/
02627 
02628 {
02629     ULONG DriverCount = 0;
02630     ULONG SizeOfStringData = 0;
02631     PLIST_ENTRY NextEntry;
02632     PLDR_DATA_TABLE_ENTRY <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>;
02633 
02634 
02635     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
02636     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
02637 
02638         <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> = CONTAINING_RECORD (NextEntry,
02639                                          LDR_DATA_TABLE_ENTRY,
02640                                          InLoadOrderLinks
02641                                          );
02642 
02643         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d3/dumpctl_8c.html#a35">IopIsAddressRangeValid</a> (DriverEntry, <span class="keyword">sizeof</span> (*DriverEntry)) ||
02644             !<a class="code" href="../../d2/d3/dumpctl_8c.html#a35">IopIsAddressRangeValid</a> (<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;BaseDllName.Buffer,
02645                                      <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;BaseDllName.Length)) {
02646 
02647             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02648         }
02649         
02650         DriverCount++;
02651         SizeOfStringData += <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;FullDllName.Length;
02652         NextEntry = NextEntry-&gt;Flink;
02653     }
02654 
02655     *lpDriverCount = DriverCount;
02656     *lpSizeOfStringData = SizeOfStringData;
02657 
02658     <span class="keywordflow">return</span> STATUS_SUCCESS;
02659 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="dumpctl.c::IopInitializeDCB" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopInitializeDCB           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">4580</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00466">_DUMP_CONTROL_BLOCK::BuildNumber</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00032">CmNtCSDVersion</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00444">DCB_AUTO_REBOOT</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00443">DCB_SUMMARY_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00447">DCB_TRIAGE_DUMP_ENABLED</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00095">DEFAULT_TRIAGE_DUMP_FLAGS</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00469">_DUMP_CONTROL_BLOCK::DumpFileSize</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00452">_DUMP_CONTROL_BLOCK::Flags</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00462">_DUMP_CONTROL_BLOCK::HeaderPage</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00463">_DUMP_CONTROL_BLOCK::HeaderPfn</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00468">_DUMP_CONTROL_BLOCK::HeaderSize</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00440">IO_TYPE_DCB</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00263">IopDumpControlBlock</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04393">IopLogErrorEvent()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04379">IopReadDumpRegistry()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02777">KeProcessorArchitecture</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00464">_DUMP_CONTROL_BLOCK::MajorVersion</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00458">_DUMP_CONTROL_BLOCK::MemoryDescriptor</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00459">_DUMP_CONTROL_BLOCK::MemoryDescriptorLength</a>, <a class="el" href="../../d0/d6/iop_8h.html#a71">MINIPORT_NODE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00465">_DUMP_CONTROL_BLOCK::MinorVersion</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05490">MmGetPhysicalAddress()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">MmPhysicalMemoryBlock</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d4/triage_8c-source.html#l00042">NtBuildNumber</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00039">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfRuns</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00454">_DUMP_CONTROL_BLOCK::NumberProcessors</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00456">_DUMP_CONTROL_BLOCK::ProcessorArchitecture</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00453">_DUMP_CONTROL_BLOCK::Size</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00471">_DUMP_CONTROL_BLOCK::TriageDumpBuffer</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00472">_DUMP_CONTROL_BLOCK::TriageDumpBufferSize</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00470">_DUMP_CONTROL_BLOCK::TriageDumpFlags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00451">_DUMP_CONTROL_BLOCK::Type</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04746">IopConfigureCrashDump()</a>.
<p>
<pre class="fragment"><div>04584                    :
04585 
04586     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d5/editreg_8c.html#a66">Dump</a> Control Block (DCB). It allocates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04587     DCB and reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> crashdump parameters from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
04588 
04589 Arguments:
04590 
04591 
04592 Return Value:
04593 
04594     The <span class="keyword">final</span> function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> everything worked, <span class="keywordflow">else</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
04595 
04596 --*/
04597 
04598 {
04599     HANDLE                      keyHandle;
04600     HANDLE                      crashHandle;
04601     LOGICAL                     crashHandleOpened;
04602     UNICODE_STRING              keyName;
04603     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    status;
04604     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04605     <a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a>         dcb;
04606     ULONG                       dumpControl;
04607     ULONG                       handleValue;
04608     ULONG                       autoReboot;
04609     PCHAR                       partitionName;
04610     ULONG                       dcbSize;
04611     LARGE_INTEGER               page;
04612     ULONG                       numberOfHeaderPages;
04613     ULONG                       dumpFileSize;
04614 
04615     <span class="comment">//</span>
04616     <span class="comment">// Read all the registry default values first.</span>
04617     <span class="comment">//</span>
04618 
04619     <a class="code" href="../../d2/d3/dumpctl_8c.html#a56">IopReadDumpRegistry</a> ( &amp;dumpControl,
04620                           &amp;numberOfHeaderPages,
04621                           &amp;autoReboot,
04622                           &amp;dumpFileSize);
04623 
04624     <span class="comment">//</span>
04625     <span class="comment">// If we aren't crashing or auto rebooting then return now.</span>
04626     <span class="comment">//</span>
04627 
04628     <span class="keywordflow">if</span> (dumpControl == 0 &amp;&amp; autoReboot == 0) {
04629 
04630         <span class="comment">//</span>
04631         <span class="comment">// At some point, we will conditionally on system size, type, etc,</span>
04632         <span class="comment">// set dump defaults like the below and skip over the return.</span>
04633         <span class="comment">//</span>
04634         <span class="comment">//    *dumpControl = (DCB_DUMP_ENABLED | DCB_TRIAGE_DUMP_ENABLED);</span>
04635         <span class="comment">//    *autoReboot = 1;</span>
04636         <span class="comment">//    *dumpFileSize = ?</span>
04637         <span class="comment">//</span>
04638 
04639         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04640     }
04641 
04642     <span class="keywordflow">if</span> (dumpControl &amp; <a class="code" href="../../d0/d6/iop_8h.html#a10">DCB_TRIAGE_DUMP_ENABLED</a>) {
04643         dumpControl &amp;= ~<a class="code" href="../../d0/d6/iop_8h.html#a6">DCB_SUMMARY_ENABLED</a>;
04644         dumpFileSize = TRIAGE_DUMP_SIZE;
04645     }
04646 
04647     <span class="comment">//</span>
04648     <span class="comment">// Allocate and initialize the structures necessary to describe and control</span>
04649     <span class="comment">// the post-bugcheck code.</span>
04650     <span class="comment">//</span>
04651 
04652     dcbSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">DUMP_CONTROL_BLOCK</a> ) + <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d9/struct__MINIPORT__NODE.html">MINIPORT_NODE</a> );
04653     dcb = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool, dcbSize, 'pmuD' );
04654     <span class="keywordflow">if</span> (!dcb) {
04655         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IopInitializeDCB: Not enough pool to allocate DCB0\n"</span> ));
04656         <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a>(0,1,STATUS_SUCCESS,IO_DUMP_INITIALIZATION_FAILURE,0,NULL,0,NULL);
04657         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04658     }
04659 
04660     RtlZeroMemory( dcb, dcbSize );
04661     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o0">Type</a> = <a class="code" href="../../d0/d6/iop_8h.html#a4">IO_TYPE_DCB</a>;
04662     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o2">Size</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) dcbSize;
04663     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> = (UCHAR) (dumpControl | (autoReboot ? <a class="code" href="../../d0/d6/iop_8h.html#a7">DCB_AUTO_REBOOT</a> : 0));
04664     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o3">NumberProcessors</a> = <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
04665     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o5">ProcessorArchitecture</a> = <a class="code" href="../../d4/d9/ke_8h.html#a134">KeProcessorArchitecture</a>;
04666     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o14">MinorVersion</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) <a class="code" href="../../d5/d5/triage_8c.html#a0">NtBuildNumber</a>;
04667     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o13">MajorVersion</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ((<a class="code" href="../../d5/d5/triage_8c.html#a0">NtBuildNumber</a> &gt;&gt; 28) &amp; 0xfffffff);
04668     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o15">BuildNumber</a> = <a class="code" href="../../d8/d1/init_8h.html#a7">CmNtCSDVersion</a>;
04669     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o19">TriageDumpFlags</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a9">DEFAULT_TRIAGE_DUMP_FLAGS</a>;
04670 
04671     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o18">DumpFileSize</a>.QuadPart = dumpFileSize;
04672 
04673     <span class="comment">//</span>
04674     <span class="comment">// Allocate memory descriptors.</span>
04675     <span class="comment">//</span>
04676 
04677     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o8">MemoryDescriptorLength</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PHYSICAL_MEMORY_DESCRIPTOR</a> ) - <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a> ) +
04678                                   (<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> * <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a> ));
04679     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
04680                                     NonPagedPool,
04681                                     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o8">MemoryDescriptorLength</a>,
04682                                     'pmuD'
04683                                     );
04684     <span class="keywordflow">if</span> (!dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>) {
04685         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb);
04686 
04687         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IopInitializeDCB: Not enough pool to allocate DCB1\n"</span> ));
04688         <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a>(0,1,STATUS_SUCCESS,IO_DUMP_INITIALIZATION_FAILURE,0,NULL,0,NULL);
04689         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04690     }
04691 
04692     RtlCopyMemory (
04693         dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>,
04694         MmPhysicalMemoryBlock,
04695         dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o8">MemoryDescriptorLength</a>
04696         );
04697 
04698     <span class="comment">//</span>
04699     <span class="comment">// Allocate header page.</span>
04700     <span class="comment">//</span>
04701 
04702     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o17">HeaderSize</a> = numberOfHeaderPages * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
04703     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool, dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o17">HeaderSize</a>, 'pmuD' );
04704 
04705     <span class="keywordflow">if</span> (!dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a>) {
04706         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>);
04707         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb);
04708         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IopInitializeDCB: Not enough pool to allocate DCB2\n"</span> ));
04709         <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a>(0,1,STATUS_SUCCESS,IO_DUMP_INITIALIZATION_FAILURE,0,NULL,0,NULL);
04710         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04711     }
04712     page = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a>( dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a> );
04713     dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o12">HeaderPfn</a> = (ULONG)(page.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
04714 
04715 
04716     <span class="comment">//</span>
04717     <span class="comment">// Allocate the triage-dump buffer.</span>
04718     <span class="comment">//</span>
04719     
04720     <span class="keywordflow">if</span> (dumpControl &amp; <a class="code" href="../../d0/d6/iop_8h.html#a10">DCB_TRIAGE_DUMP_ENABLED</a>) {
04721     
04722         dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o20">TriageDumpBuffer</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> ( NonPagedPool,
04723                                                       dumpFileSize,
04724                                                       'pmuD'
04725                                                       );
04726 
04727         <span class="keywordflow">if</span> (!dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o20">TriageDumpBuffer</a>) {
04728             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a>);
04729             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>);
04730             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (dcb);
04731             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IopInitializeDCB: Not enough pool to allocate DCB3\n"</span> ));
04732             <a class="code" href="../../d0/d6/iop_8h.html#a227">IopLogErrorEvent</a>(0,1,STATUS_SUCCESS,IO_DUMP_INITIALIZATION_FAILURE,0,NULL,0,NULL);
04733             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04734         }
04735 
04736         dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o21">TriageDumpBufferSize</a> = dumpFileSize;
04737     }
04738     
04739     <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a> = dcb;
04740 
04741     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04742 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="dumpctl.c::IopInitializeDumpSpaceAndType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopInitializeDumpSpaceAndType           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>block</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSUMMARY_DUMP_HEADER&nbsp;</td>
          <td class="mdname" nowrap> <em>pSummaryHeader</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01452">1452</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d1/d5/iop_8h-source.html#l00445">DCB_DUMP_HEADER_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00446">DCB_SUMMARY_DUMP_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00447">DCB_TRIAGE_DUMP_ENABLED</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02492">IopCalculateRequiredDumpSpace()</a>, and <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00130">Space</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.
<p>
<pre class="fragment"><div>01457 {
01458     LARGE_INTEGER <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>;
01459     
01460     <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>.QuadPart = 0;
01461 
01462     <span class="keywordflow">if</span> (dcb-&gt;Flags &amp; <a class="code" href="../../d0/d6/iop_8h.html#a10">DCB_TRIAGE_DUMP_ENABLED</a>) {
01463 
01464         <span class="comment">//</span>
01465         <span class="comment">// Fixed size dump for triage-dumps.</span>
01466         <span class="comment">//</span>
01467         
01468         block [ DH_DUMP_TYPE ] = DUMP_TYPE_TRIAGE;
01469         <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>.QuadPart = TRIAGE_DUMP_SIZE;
01470 
01471 
01472     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dcb-&gt;Flags &amp; <a class="code" href="../../d0/d6/iop_8h.html#a9">DCB_SUMMARY_DUMP_ENABLED</a>) {
01473 
01474         block [ DH_DUMP_TYPE ] = DUMP_TYPE_SUMMARY;
01475 
01476         <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a33">IopCalculateRequiredDumpSpace</a>(
01477                                 dcb-&gt;Flags,
01478                                 dcb-&gt;HeaderSize,
01479                                 dcb-&gt;MemoryDescriptor-&gt;NumberOfPages,
01480                                 pSummaryHeader-&gt;Pages
01481                                 );
01482     } <span class="keywordflow">else</span> {
01483 
01484         <span class="keywordflow">if</span> (dcb-&gt;Flags &amp; <a class="code" href="../../d0/d6/iop_8h.html#a8">DCB_DUMP_HEADER_ENABLED</a>) {
01485             block [ DH_DUMP_TYPE ] = DUMP_TYPE_HEADER;
01486         }
01487 
01488         <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a33">IopCalculateRequiredDumpSpace</a>(
01489                                 dcb-&gt;Flags,
01490                                 dcb-&gt;HeaderSize,
01491                                 dcb-&gt;MemoryDescriptor-&gt;NumberOfPages,
01492                                 dcb-&gt;MemoryDescriptor-&gt;NumberOfPages
01493                                 );
01494     }
01495 
01496     <span class="comment">//</span>
01497     <span class="comment">// If the calculated size is larger than the pagefile, truncate it to</span>
01498     <span class="comment">// the pagefile size.</span>
01499     <span class="comment">//</span>
01500 
01501     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>.QuadPart &gt; dcb-&gt;DumpFileSize.QuadPart) {
01502         <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>.QuadPart = dcb-&gt;DumpFileSize.QuadPart;
01503     }
01504     
01505     block [ DH_REQUIRED_DUMP_SPACE ] = <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>.LowPart;
01506     block [ DH_REQUIRED_DUMP_SPACE + 1 ] = <a class="code" href="../../d7/d0/cmdat2_8c.html#a32">Space</a>.HighPart;
01507 
01508     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IODUMP: dcb File Size %x Block Size %x\n"</span>,
01509                     block [DH_REQUIRED_DUMP_SPACE],
01510                     (ULONG)dcb-&gt;DumpFileSize.LowPart
01511                     ));
01512 
01513     <span class="keywordflow">return</span> STATUS_SUCCESS;
01514 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="dumpctl.c::IopInitializeSummaryDump" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PSUMMARY_DUMP_HEADER IopInitializeSummaryDump           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pDcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03442">3442</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00034">_PHYSICAL_MEMORY_RUN::BasePage</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03815">IopCreateSummaryDump()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">MmPhysicalMemoryBlock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00039">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfRuns</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00035">_PHYSICAL_MEMORY_RUN::PageCount</a>, and <a class="el" href="../../d3/d0/mm_8h-source.html#l00041">_PHYSICAL_MEMORY_DESCRIPTOR::Run</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.
<p>
<pre class="fragment"><div>03447                    :
03448 
03449     This routine creates a summary dump header. In particular <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> initializes
03450     a bitmap that contains a map of kernel memory.
03451 
03452 Arguments:
03453 
03454     <a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block.
03455 
03456 Return Value:
03457 
03458     Non-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> summary dump header
03459 
03460     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>
03461 
03462 --*/
03463 {
03464     PULONG                  pdwBlock;
03465     PSUMMARY_DUMP_HEADER    pSummaryHeader;
03466     ULONG                   dwActualPages;
03467 
03468     <span class="comment">//</span>
03469     <span class="comment">// Get the dump header page.</span>
03470     <span class="comment">//</span>
03471 
03472     pdwBlock = pDcb-&gt;HeaderPage;
03473 
03474     <span class="comment">//</span>
03475     <span class="comment">// The summary dump starts 1 page after the header.</span>
03476     <span class="comment">//</span>
03477 
03478     pSummaryHeader = (PSUMMARY_DUMP_HEADER)&amp;pdwBlock[ DH_SUMMARY_DUMP_RECORD ];
03479 
03480     <span class="comment">//</span>
03481     <span class="comment">// Fill the header with signatures.</span>
03482     <span class="comment">//</span>
03483     RtlFillMemoryUlong( pSummaryHeader,
03484                         <span class="keyword">sizeof</span>(SUMMARY_DUMP_HEADER),
03485                         'PMDS' );
03486 
03487     <span class="comment">//</span>
03488     <span class="comment">// Set the size and valid signature.</span>
03489     <span class="comment">//</span>
03490     
03491     pSummaryHeader-&gt;BitmapSize = (ULONG)( <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>-1].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>  +
03492                                       <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>-1].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> );
03493     pSummaryHeader-&gt;ValidDump = 'PMUD';
03494 
03495     <span class="comment">//</span>
03496     <span class="comment">// Construct the kernel memory bitmap.</span>
03497     <span class="comment">//</span>
03498     
03499     dwActualPages = <a class="code" href="../../d2/d3/dumpctl_8c.html#a29">IopCreateSummaryDump</a>(pSummaryHeader);
03500 
03501     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"[IopInitializeSummaryDump]: Kernel Pages = %x\n"</span>,dwActualPages));
03502 
03503     <span class="keywordflow">if</span> (!dwActualPages) {
03504         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03505     }
03506 
03507     <span class="comment">//</span>
03508     <span class="comment">// Set the actual number of physical pages in the summary dump</span>
03509     <span class="comment">//</span>
03510     
03511     pSummaryHeader-&gt;Pages = dwActualPages;
03512     pSummaryHeader-&gt;HeaderSize = pDcb-&gt;HeaderSize;
03513 
03514     <span class="keywordflow">return</span> pSummaryHeader;
03515 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="dumpctl.c::IopIsAddressRangeValid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsAddressRangeValid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00287">287</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">LPVOID</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02602">IopGetLoadedDriverInfo()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02681">IopWriteDriverList()</a>.
<p>
<pre class="fragment"><div>00294                    :
00295 
00296     Validate a range of addresses.
00297 
00298 Arguments:
00299 
00300     <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a> Address - Beginning of of memory block to validate.
00301 
00302     Length - Length of memory block to validate.
00303 
00304 Return Value:
00305 
00306     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - Address range <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid.
00307 
00308     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - Address range <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not valid.
00309 
00310 --*/
00311 
00312 {
00313     UINT_PTR Va;
00314     ULONG Pages;
00315 
00316     Va = (UINT_PTR) <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (VirtualAddress);
00317     Pages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (VirtualAddress, Length);
00318 
00319     <span class="keywordflow">while</span> (Pages) {
00320 
00321         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> ( (LPVOID) Va)) {
00322             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00323         }
00324 
00325         Va += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00326         Pages--;
00327     }
00328 
00329     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00330 }
    
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="dumpctl.c::IopLoadDumpDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopLoadDumpDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DumpStack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverNameString</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>NewBaseNameString</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00954">954</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00062">BaseName</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00379">MmLoadAndLockSystemImage()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d5/io_8h.html#a280">PDUMP_STACK_IMAGE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>.
<p>
<pre class="fragment"><div>00961                    :
00962 
00963     Worker function <span class="keywordflow">for</span> <a class="code" href="../../d0/d5/io_8h.html#a438">IoGetDumpStack</a> to load a particular driver into
00964     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current DumpStack being created
00965 
00966 Arguments:
00967 
00968     DumpStack           - <a class="code" href="../../d2/d5/editreg_8c.html#a66">Dump</a> driver stack being built
00969 
00970     DriverNameString    - The string name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to load
00971 
00972     NewBaseNameString   - The modified basename of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver once loaded
00973 
00974 Return Value:
00975 
00976     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
00977 
00978 --*/
00979 {
00980     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00981     <a class="code" href="../../d0/d5/io_8h.html#a280">PDUMP_STACK_IMAGE</a>       DumpImage;
00982     PLDR_DATA_TABLE_ENTRY   ImageLdrInfo;
00983     UNICODE_STRING          DriverName;
00984     UNICODE_STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>;
00985     UNICODE_STRING          Prefix;
00986     PUNICODE_STRING         LoadBaseName;
00987 
00988     <span class="comment">//</span>
00989     <span class="comment">// Allocate space to track this dump driver</span>
00990     <span class="comment">//</span>
00991 
00992     DumpImage = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
00993                         NonPagedPool,
00994                         <span class="keyword">sizeof</span> (<a class="code" href="../../d4/d8/structDUMP__STACK__IMAGE.html">DUMP_STACK_IMAGE</a>),
00995                         'pmuD'
00996                         );
00997 
00998     <span class="keywordflow">if</span> (!DumpImage) {
00999         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01000     }
01001 
01002     <span class="comment">//</span>
01003     <span class="comment">// Load the system image</span>
01004     <span class="comment">//</span>
01005 
01006     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;DriverName, DriverNameString);
01007     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;Prefix, DumpStack-&gt;ModulePrefix);
01008     LoadBaseName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01009     <span class="keywordflow">if</span> (NewBaseNameString) {
01010         LoadBaseName = &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>;
01011         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;BaseName, NewBaseNameString);
01012         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.MaximumLength = Prefix.Length + <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length;
01013         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
01014                             NonPagedPool,
01015                             <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.MaximumLength,
01016                             'pmuD'
01017                             );
01018 
01019 
01020         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Buffer) {
01021             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DumpImage);
01022             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01023         }
01024 
01025         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Length = 0;
01026         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a> (&amp;BaseName, &amp;Prefix);
01027         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a> (&amp;BaseName, NewBaseNameString);
01028     }
01029 
01030     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a54">MmLoadAndLockSystemImage</a>(
01031                 &amp;DriverName,
01032                 &amp;Prefix,
01033                 LoadBaseName,
01034                 &amp;DumpImage-&gt;Image,
01035                 &amp;DumpImage-&gt;ImageBase
01036                 );
01037 
01038     <span class="keywordflow">if</span> (NewBaseNameString) {
01039         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>.Buffer);
01040     }
01041 
01042     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
01043         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((0,
01044                        <span class="stringliteral">"IODUMP: Could not load %wZ; error = %x\n"</span>,
01045                        &amp;DriverName,
01046                        Status));
01047         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DumpImage);
01048         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01049     }
01050 
01051     <span class="comment">//</span>
01052     <span class="comment">// Put this driver on the list of drivers to be processed at crash time</span>
01053     <span class="comment">//</span>
01054 
01055     DumpImage-&gt;SizeOfImage = DumpImage-&gt;Image-&gt;SizeOfImage;
01056     InsertTailList (&amp;DumpStack-&gt;DriverList, &amp;DumpImage-&gt;Link);
01057     <span class="keywordflow">return</span> STATUS_SUCCESS;
01058 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="dumpctl.c::IopMapPhysicalMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopMapPhysicalMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mdl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PPHYSICAL_MEMORY_RUN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalMemoryRun</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02081">2081</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00034">_PHYSICAL_MEMORY_RUN::BasePage</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00275">MmGetMdlPfnArray</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07197">MmMapMemoryDumpMdl()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, and <a class="el" href="../../d3/d0/mm_8h-source.html#l00035">_PHYSICAL_MEMORY_RUN::PageCount</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.
<p>
<pre class="fragment"><div>02090                    :
02091 
02092     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked to fill in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d0/d9/ntosdef_8h.html#a58">MDL</a> (Memory Descriptor
02093     List) w/<a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate information to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified memory address
02094     range.
02095 
02096 Arguments:
02097 
02098     Mdl - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d9/ntosdef_8h.html#a58">MDL</a> to be filled in.
02099 
02100     MemoryAddress - Pseudo-<span class="keyword">virtual</span> address being mapped.
02101 
02102     PhysicalMemoryRun - Base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical memory run list.
02103 
02104     Length - Length of transfer to be mapped.
02105 
02106 Return Value:
02107 
02108     None.
02109 
02110 --*/
02111 
02112 {
02113     <a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PPHYSICAL_MEMORY_RUN</a> pmr = PhysicalMemoryRun;
02114     PPFN_NUMBER page;
02115     PFN_NUMBER pages;
02116     PFN_NUMBER base;
02117     PFN_NUMBER currentBase;
02118 
02119     <span class="comment">//</span>
02120     <span class="comment">// Begin by determining the base physical page of the start of the address</span>
02121     <span class="comment">// range and filling in the MDL appropriately.</span>
02122     <span class="comment">//</span>
02123     Mdl-&gt;StartVa = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>( (PVOID) (MemoryAddress) );
02124     Mdl-&gt;ByteOffset = (ULONG)(MemoryAddress &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
02125     Mdl-&gt;ByteCount = Length;
02126 
02127     <span class="comment">//</span>
02128     <span class="comment">// Get the page frame index for the base address.</span>
02129     <span class="comment">//</span>
02130 
02131     base = (PFN_NUMBER) ((ULONG_PTR)(Mdl-&gt;StartVa) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02132     pages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a>(MemoryAddress, Length);
02133     currentBase = pmr-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
02134     page = <a class="code" href="../../d2/d1/mm_8h.html#a11">MmGetMdlPfnArray</a>(Mdl);
02135 
02136     <span class="comment">//</span>
02137     <span class="comment">// Map all of the pages for this transfer until there are no more remaining</span>
02138     <span class="comment">// to be mapped.</span>
02139     <span class="comment">//</span>
02140 
02141     <span class="keywordflow">while</span> (pages) {
02142 
02143         <span class="comment">//</span>
02144         <span class="comment">// Find the memory run that maps the beginning of this transfer.</span>
02145         <span class="comment">//</span>
02146 
02147         <span class="keywordflow">while</span> (currentBase + pmr-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> &lt;= base) {
02148             currentBase += pmr-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
02149             pmr++;
02150         }
02151 
02152         <span class="comment">//</span>
02153         <span class="comment">// The current memory run maps the start of this transfer.  Capture</span>
02154         <span class="comment">// the base page for the start of the transfer.</span>
02155         <span class="comment">//</span>
02156 
02157         *page++ = pmr-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> + (PFN_NUMBER)(base++ - currentBase);
02158         pages--;
02159     }
02160 
02161     <span class="comment">//</span>
02162     <span class="comment">// All of the PFNs for the address range have been filled in so map the</span>
02163     <span class="comment">// physical memory into virtual address space.</span>
02164     <span class="comment">//</span>
02165 
02166     <a class="code" href="../../d5/d6/iosup_8c.html#a82">MmMapMemoryDumpMdl</a>( Mdl );
02167 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="dumpctl.c::IopMapVirtualToPhysicalMdl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopMapVirtualToPhysicalMdl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pMdl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>dwMemoryAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>dwLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03759">3759</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00275">MmGetMdlPfnArray</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05490">MmGetPhysicalAddress()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03520">IopWriteSummaryHeader()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03638">IopWriteToDisk()</a>.
<p>
<pre class="fragment"><div>03764 {
03765     PPFN_NUMBER  pdwPage;
03766     ULONG   dwPages;
03767     ULONG   dwBase;
03768     ULONG   dwCurrentBase;
03769     ULONG_PTR dwBaseVa;
03770     PHYSICAL_ADDRESS PhysicalAddress;
03771 
03772     <span class="comment">//</span>
03773     <span class="comment">// Begin by determining the base physical page of the start of the address</span>
03774     <span class="comment">// range and filling in the MDL appropriately.</span>
03775     <span class="comment">//</span>
03776 
03777     pMdl-&gt;StartVa = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>((PVOID)dwMemoryAddress);
03778     pMdl-&gt;ByteOffset= (ULONG)(dwMemoryAddress &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
03779     pMdl-&gt;ByteCount = dwLength;
03780     dwBaseVa = dwMemoryAddress &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> -1);
03781     pMdl-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>;
03782 
03783     <span class="comment">//</span>
03784     <span class="comment">// Compute the number of pages spanned</span>
03785     <span class="comment">//</span>
03786 
03787     dwPages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a>( dwMemoryAddress, dwLength );
03788     pdwPage = <a class="code" href="../../d2/d1/mm_8h.html#a11">MmGetMdlPfnArray</a>(pMdl);
03789 
03790     <span class="comment">//</span>
03791     <span class="comment">// Map all of the pages for this transfer until there are no more remaining</span>
03792     <span class="comment">// to be mapped.</span>
03793     <span class="comment">//</span>
03794     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((3,<span class="stringliteral">"MapVirtualToPhysical: VA: %08x off: %08x Len:%08x base: %08x \n"</span>,pMdl-&gt;StartVa,pMdl-&gt;ByteOffset,pMdl-&gt;ByteCount,dwBaseVa));
03795 
03796     <span class="keywordflow">while</span> (dwPages) {
03797         PhysicalAddress = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a>( (PVOID)dwBaseVa );
03798         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>( (3,<span class="stringliteral">"Physical Frame: %08x Adr: %08x\n"</span>,( PhysicalAddress.QuadPart &gt;&gt; PAGE_SHIFT),dwBaseVa ) );
03799         *pdwPage++  = (PFN_NUMBER)(PhysicalAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03800         dwBaseVa    +=<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
03801         dwPages--;
03802     }
03803 
03804     <span class="comment">//</span>
03805     <span class="comment">// All of the PFNs for the address range have been filled in so map the</span>
03806     <span class="comment">// physical memory into virtual address space using crash dump PTE.</span>
03807     <span class="comment">//</span>
03808 
03809 <span class="comment">//    MmMapMemoryDumpMdl( pMdl );</span>
03810 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="dumpctl.c::IopReadDumpRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopReadDumpRegistry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>dumpControl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>numberOfHeaderPages</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>autoReboot</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>dumpFileSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04379">4379</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00442">DCB_DUMP_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00446">DCB_SUMMARY_DUMP_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00443">DCB_SUMMARY_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00448">DCB_TRIAGE_DUMP_ACT_UPON_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00447">DCB_TRIAGE_DUMP_ENABLED</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05325">IopOpenRegistryKey()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">MmPhysicalMemoryBlock</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00040">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfPages</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">IopInitializeDCB()</a>.
<p>
<pre class="fragment"><div>04387                    :
04388 
04389     This routine reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump parameters from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
04390 
04391 Arguments:
04392 
04393     dumpControl - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dumpControl flags to set.
04394 
04395 Return Value:
04396 
04397     None.
04398 
04399 --*/
04400 
04401 {
04402     HANDLE                      keyHandle;
04403     HANDLE                      crashHandle;
04404     LOGICAL                     crashHandleOpened;
04405     UNICODE_STRING              keyName;
04406     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    status;
04407     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04408     <a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a>         dcb;
04409     ULONG                       handleValue;
04410 
04411     *dumpControl = 0;
04412     *autoReboot = 0;
04413     *dumpFileSize = 0;
04414 
04415     *numberOfHeaderPages = 1;       <span class="comment">// Dump header</span>
04416 
04417     <span class="comment">//</span>
04418     <span class="comment">// Begin by opening the path to the control for dumping memory.  Note</span>
04419     <span class="comment">// that if it does not exist, then no dumps will occur.</span>
04420     <span class="comment">//</span>
04421 
04422     crashHandleOpened = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04423 
04424     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;keyName, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control"</span> );
04425 
04426     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;keyHandle,
04427                                  (HANDLE) NULL,
04428                                  &amp;keyName,
04429                                  KEY_READ,
04430                                  FALSE );
04431 
04432     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04433         <span class="keywordflow">return</span>;
04434     }
04435 
04436     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;keyName, L<span class="stringliteral">"CrashControl"</span> );
04437     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;crashHandle,
04438                                  keyHandle,
04439                                  &amp;keyName,
04440                                  KEY_READ,
04441                                  FALSE );
04442 
04443     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( keyHandle );
04444 
04445     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04446         <span class="keywordflow">return</span>;
04447     }
04448 
04449     crashHandleOpened = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04450 
04451     <span class="comment">//</span>
04452     <span class="comment">// Now get the value of the crash control to determine whether or not</span>
04453     <span class="comment">// dumping is enabled.</span>
04454     <span class="comment">//</span>
04455 
04456     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( crashHandle,
04457                                   L<span class="stringliteral">"CrashDumpEnabled"</span>,
04458                                   &amp;keyValueInformation );
04459 
04460     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
04461 
04462         <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength) {
04463 
04464             handleValue = * ((PULONG) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset));
04465             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
04466 
04467             <span class="keywordflow">if</span> (handleValue) {
04468 
04469                 *dumpControl |= <a class="code" href="../../d0/d6/iop_8h.html#a5">DCB_DUMP_ENABLED</a>;
04470 
04471                 <span class="comment">//</span>
04472                 <span class="comment">// If handleValue equals summary dump or the amount of physical</span>
04473                 <span class="comment">// memory is greater than 2GB, then enable summary dump</span>
04474                 <span class="comment">//</span>
04475 
04476                 <span class="keywordflow">if</span> ( handleValue == 3 ) {
04477 
04478                     *dumpControl |= <a class="code" href="../../d0/d6/iop_8h.html#a10">DCB_TRIAGE_DUMP_ENABLED</a>;
04479                     
04480                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( handleValue == 4 ) {
04481 
04482                     *dumpControl |= ( <a class="code" href="../../d0/d6/iop_8h.html#a10">DCB_TRIAGE_DUMP_ENABLED</a> | <a class="code" href="../../d0/d6/iop_8h.html#a11">DCB_TRIAGE_DUMP_ACT_UPON_ENABLED</a> );
04483                     
04484                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ( handleValue == 2 ) ||
04485                      ( <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> &gt;= ( 0x80000000 &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> ) ) ) {
04486                     
04487                     *dumpControl |= <a class="code" href="../../d0/d6/iop_8h.html#a9">DCB_SUMMARY_DUMP_ENABLED</a>;
04488 
04489                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IopInitializeDCB: SUMMARY DUMP ENABLED \n"</span>));
04490 
04491                     <span class="comment">//</span>
04492                     <span class="comment">// Allocate enough storage for the dump header, summary</span>
04493                     <span class="comment">// dump header and bitmap.</span>
04494                     <span class="comment">//</span>
04495 
04496                     *numberOfHeaderPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(
04497                                             PAGE_SIZE +
04498                                             ( ( <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> &gt;&gt; 5) &lt;&lt; 2 ) +
04499                                             <span class="keyword">sizeof</span>(SUMMARY_DUMP_HEADER)
04500                                             );
04501 
04502                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IopInitializeDCB: NumberOfHeader Pages = %x\n"</span>,numberOfHeaderPages));
04503 
04504                 }
04505             }
04506         }
04507     }
04508 
04509     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( crashHandle,
04510                                   L<span class="stringliteral">"LogEvent"</span>,
04511                                   &amp;keyValueInformation );
04512 
04513     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04514          <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength) {
04515             handleValue = * ((PULONG) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset));
04516             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation);
04517             <span class="keywordflow">if</span> (handleValue) {
04518                 *dumpControl |= <a class="code" href="../../d0/d6/iop_8h.html#a6">DCB_SUMMARY_ENABLED</a>;
04519             }
04520         }
04521     }
04522 
04523     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( crashHandle,
04524                                   L<span class="stringliteral">"SendAlert"</span>,
04525                                   &amp;keyValueInformation );
04526 
04527     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04528          <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength) {
04529             handleValue = * ((PULONG) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset));
04530             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation);
04531             <span class="keywordflow">if</span> (handleValue) {
04532                 *dumpControl |= <a class="code" href="../../d0/d6/iop_8h.html#a6">DCB_SUMMARY_ENABLED</a>;
04533             }
04534         }
04535     }
04536 
04537     <span class="comment">//</span>
04538     <span class="comment">// Now determine whether or not automatic reboot is enabled.</span>
04539     <span class="comment">//</span>
04540 
04541     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( crashHandle,
04542                                   L<span class="stringliteral">"AutoReboot"</span>,
04543                                   &amp;keyValueInformation );
04544 
04545 
04546     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04547         <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength) {
04548             *autoReboot = * ((PULONG) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset));
04549         }
04550         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
04551     }
04552 
04553     <span class="comment">//</span>
04554     <span class="comment">// If we aren't auto rebooting or crashing then return now.</span>
04555     <span class="comment">//</span>
04556 
04557     <span class="keywordflow">if</span> (*dumpControl == 0 &amp;&amp; *autoReboot == 0) {
04558         <span class="keywordflow">if</span> (crashHandleOpened == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04559             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( crashHandle );
04560         }
04561         <span class="keywordflow">return</span>;
04562     }
04563 
04564     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( crashHandle,
04565                                   L<span class="stringliteral">"DumpFileSize"</span>,
04566                                   &amp;keyValueInformation );
04567 
04568     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04569         <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength) {
04570             *dumpFileSize = * ((PULONG) ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset));
04571         }
04572 
04573         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( keyValueInformation );
04574     }
04575     <span class="keywordflow">return</span>;
04576 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="dumpctl.c::IopRemovePageFromPageMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopRemovePageFromPageMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>dwMaxPage</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PRTL_BITMAP&nbsp;</td>
          <td class="mdname" nowrap> <em>pBitMapHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>dwPageFrameIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>dwNumberOfPages</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02193">2193</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, and <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01508">RtlClearBits()</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02400">IoFreeDumpRange()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03953">IopDeleteNonExistentMemory()</a>.
<p>
<pre class="fragment"><div>02199 {
02200     <span class="comment">//</span>
02201     <span class="comment">// Sometimes we get PFNs that are out of range. Just ignore them.</span>
02202     <span class="comment">//</span>
02203 
02204     <span class="keywordflow">if</span> (dwPageFrameIndex &gt;= dwMaxPage) {
02205         <span class="keywordflow">return</span>;
02206     }
02207     
02208     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>( (6, <span class="stringliteral">"RtlClearBits max:%x pfn:%x, pages:%x\n"</span>,(dwMaxPage), (dwPageFrameIndex), (dwNumberOfPages) )); \
02209     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (pBitMapHeader, dwPageFrameIndex, dwNumberOfPages);
02210 
02211 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="dumpctl.c::IopWriteDriverList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopWriteDriverList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverListOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StringPoolOffset</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02681">2681</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02664">DmpNextPoolString</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00067">DriverEntry()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00287">IopIsAddressRangeValid()</a>, <a class="el" href="../../d5/d5/ppc_2debugsup_8c-source.html#l00028">MmDbgReadCheck()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, and <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02795">IopWriteTriageDump()</a>.
<p>
<pre class="fragment"><div>02690                    :
02691 
02692     Write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> triage dump driver list to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
02693 
02694 Arguments:
02695 
02696     BufferAddress - The address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
02697 
02698     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - The size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
02699 
02700     DriverListOffset - The offset within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver list
02701         should be written.
02702 
02703     StringPoolOffset - The offset within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver list's
02704         string <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> should start. If there are no other strings <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> triage
02705         dump other than driver name strings, <span class="keyword">this</span> will be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
02706         offset.
02707 
02708 Return Value:
02709 
02710     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02711 
02712 --*/
02713 
02714 {
02715     ULONG i = 0;
02716     PLIST_ENTRY NextEntry;
02717     PLDR_DATA_TABLE_ENTRY <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>;
02718     PDUMP_DRIVER_ENTRY DumpImageArray;
02719     PDUMP_STRING DumpStringName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02720     PIMAGE_NT_HEADERS NtHeaders;
02721 
02722     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DriverListOffset != 0);
02723     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StringPoolOffset != 0);
02724     
02725 
02726     DumpImageArray = (PDUMP_DRIVER_ENTRY) (BufferAddress + DriverListOffset);
02727     DumpStringName = (PDUMP_STRING) (BufferAddress + StringPoolOffset);
02728 
02729     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
02730     
02731     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
02732 
02733         <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> = CONTAINING_RECORD (NextEntry,
02734                                         LDR_DATA_TABLE_ENTRY,
02735                                         InLoadOrderLinks);
02736 
02737         <span class="comment">//</span>
02738         <span class="comment">// Verify the memory is valid before reading anything from it.</span>
02739         <span class="comment">//</span>
02740         
02741         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d3/dumpctl_8c.html#a35">IopIsAddressRangeValid</a> (DriverEntry, <span class="keyword">sizeof</span> (*DriverEntry)) ||
02742             !<a class="code" href="../../d2/d3/dumpctl_8c.html#a35">IopIsAddressRangeValid</a> (<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;BaseDllName.Buffer,
02743                                      <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;BaseDllName.Length)) {
02744 
02745             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02746         }
02747             
02748         <span class="comment">//</span>
02749         <span class="comment">// Build the entry in the string pool. We guarantee all strings are</span>
02750         <span class="comment">// NULL terminated as well as length prefixed.</span>
02751         <span class="comment">//</span>
02752 
02753         DumpStringName-&gt;Length = <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;BaseDllName.Length / 2;
02754         RtlCopyMemory (DumpStringName-&gt;Buffer,
02755                        <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;BaseDllName.Buffer,
02756                        DumpStringName-&gt;Length * sizeof (WCHAR)
02757                        );
02758 
02759         DumpStringName-&gt;Buffer[ DumpStringName-&gt;Length ] = <span class="charliteral">'\000'</span>;
02760 
02761         RtlCopyMemory (&amp;DumpImageArray [i].LdrEntry,
02762                        DriverEntry,
02763                        <span class="keyword">sizeof</span> (DumpImageArray [i].LdrEntry)
02764                        );
02765 
02766         <span class="comment">//</span>
02767         <span class="comment">// Add the time/date stamp.</span>
02768         <span class="comment">//</span>
02769 
02770         DumpImageArray[i].LdrEntry.TimeDateStamp = 0;
02771         DumpImageArray[i].LdrEntry.SizeOfImage = 0;
02772 
02773         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a0">MmDbgReadCheck</a> (<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;DllBase ) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02774 
02775             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a> (<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;DllBase);
02776             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( NtHeaders );
02777             DumpImageArray[i].LdrEntry.TimeDateStamp = NtHeaders-&gt;FileHeader.TimeDateStamp;
02778             DumpImageArray[i].LdrEntry.SizeOfImage = NtHeaders-&gt;OptionalHeader.SizeOfImage;
02779         }
02780         
02781         DumpImageArray [i].DriverNameOffset =
02782                 (ULONG)((ULONG_PTR) DumpStringName - BufferAddress);
02783 
02784         i++;
02785         DumpStringName = <a class="code" href="../../d2/d3/dumpctl_8c.html#a12">DmpNextPoolString</a> (DumpStringName);
02786         NextEntry = NextEntry-&gt;Flink;
02787     }
02788 
02789     <span class="keywordflow">return</span> STATUS_SUCCESS;
02790 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="dumpctl.c::IopWritePageToDisk" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopWritePageToDisk           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d5/io_8h.html#a268">PDUMP_DRIVER_WRITE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverWrite</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER *&nbsp;</td>
          <td class="mdname" nowrap> <em>McbBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverTransferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>PageFrameIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03183">3183</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00420">_MDL::ByteCount</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00421">_MDL::ByteOffset</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00418">_MDL::MappedSystemVa</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00416">_MDL::MdlFlags</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00068">min3</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00275">MmGetMdlPfnArray</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01789">MmInitializeMdl</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07197">MmMapMemoryDumpMdl()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00419">_MDL::StartVa</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03329">IopWriteSummaryDump()</a>.
<p>
<pre class="fragment"><div>03192                    :
03193 
03194     Write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page described by PageFrameIndex to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk/<a class="code" href="../../d7/d1/genuedef_8c.html#a9">file</a> (DriverWrite,
03195     McbBuffer) and update the <a class="code" href="../../d2/d7/struct__MCB.html">MCB</a> buffer to reflect the new position in the
03196     file.
03197     
03198 Arguments:
03199 
03200     DriverWrite - The driver write routine.
03201 
03202     McbBuffer - A pointer to the <a class="code" href="../../d2/d7/struct__MCB.html">MCB</a> array. This array is terminated by
03203             a zero-length <a class="code" href="../../d2/d7/struct__MCB.html">MCB</a> entry. On success, this pointer is updated
03204             to reflect the new position in the <a class="code" href="../../d2/d7/struct__MCB.html">MCB</a> array.
03205 
03206             NB: <a class="code" href="../../d2/d7/struct__MCB.html">MCB</a>[0] is the size and <a class="code" href="../../d2/d7/struct__MCB.html">MCB</a>[1] is the offset.
03207 
03208     DriverTransferSize - The maximum transfer size for this driver.
03209 
03210     PageFrameIndex - The page to be written.
03211 
03212 Return Values:
03213 
03214     NTSTATUS code.
03215 
03216 --*/
03217 
03218 {
03219     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03220     PFN_NUMBER MdlHack [ (<span class="keyword">sizeof</span> (<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>) / <span class="keyword">sizeof</span> (PFN_NUMBER)) + 1];
03221     PPFN_NUMBER PfnArray;
03222     PLARGE_INTEGER Mcb;
03223     ULONG ByteCount;
03224     ULONG ByteOffset;
03225     ULONG BytesToWrite;
03226     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> TempMdl;
03227 
03228 
03229     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( DriverWrite );
03230     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( McbBuffer );
03231     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( DriverTransferSize &amp;&amp; DriverTransferSize &gt;= PAGE_SIZE );
03232 
03233     <span class="comment">//</span>
03234     <span class="comment">// Initialization</span>
03235     <span class="comment">//</span>
03236 
03237     TempMdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) &amp;MdlHack;
03238     Mcb = *McbBuffer;
03239     BytesToWrite = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
03240 
03241 
03242     <span class="comment">//</span>
03243     <span class="comment">// Initialze the MDL to point to this page.</span>
03244     <span class="comment">//</span>
03245     
03246     <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a> (TempMdl, NULL, PAGE_SIZE);
03247 
03248     PfnArray = <a class="code" href="../../d2/d1/mm_8h.html#a11">MmGetMdlPfnArray</a> ( TempMdl );
03249     PfnArray[0] = PageFrameIndex;
03250 
03251 
03252     <span class="comment">//</span>
03253     <span class="comment">// We loop for the cases when the space remaining in this block (Mcb [0])</span>
03254     <span class="comment">// is less than one page. Generally the Mcb will be large enough to hold</span>
03255     <span class="comment">// the entire page and this loop will only be executed once. When Mcb[0]</span>
03256     <span class="comment">// is less than a page, we will write the first part of the page to this</span>
03257     <span class="comment">// Mcb then increment the Mcb and write the remaining part to the next</span>
03258     <span class="comment">// page.</span>
03259     <span class="comment">//</span>
03260     
03261     ByteOffset = 0;
03262 
03263     <span class="keywordflow">while</span> ( BytesToWrite ) {
03264 
03265         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( Mcb[0].QuadPart != 0 );
03266         
03267         ByteCount = (ULONG) <a class="code" href="../../d2/d3/dumpctl_8c.html#a0">min3</a> ((LONGLONG) BytesToWrite,
03268                                   (LONGLONG) DriverTransferSize,
03269                                   Mcb[0].QuadPart
03270                                   );
03271 
03272         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( ByteCount != 0 );
03273 
03274         <span class="comment">//</span>
03275         <span class="comment">// Update the MDL byte count and byte offset. </span>
03276         <span class="comment">//</span>
03277         
03278         TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> = ByteCount;
03279         TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o7">ByteOffset</a> = ByteOffset;
03280 
03281         <span class="comment">//</span>
03282         <span class="comment">// Map the MDL. The flags are updated to show that MappedSsytemVa is</span>
03283         <span class="comment">// valid, which should probably be done in MmMapMemoryDumpMdl.</span>
03284         <span class="comment">//</span>
03285         
03286         <a class="code" href="../../d5/d6/iosup_8c.html#a82">MmMapMemoryDumpMdl</a> ( TempMdl );
03287         TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= ( <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a> | <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a> );
03288         TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o5">StartVa</a> = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a>);
03289         
03290         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = DriverWrite ( &amp;Mcb[1], TempMdl );
03291 
03292 
03293         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
03294             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03295         }
03296 
03297         BytesToWrite -= ByteCount;
03298         ByteOffset += ByteCount;
03299         
03300         Mcb[0].QuadPart -= ByteCount;
03301         Mcb[1].QuadPart += ByteCount;
03302 
03303 
03304         <span class="comment">//</span>
03305         <span class="comment">// If there is no more room for this MCB, go to the next one.</span>
03306         <span class="comment">//</span>
03307         
03308         <span class="keywordflow">if</span> ( Mcb[0].QuadPart == 0 ) {
03309 
03310             Mcb += 2;
03311 
03312             <span class="comment">//</span>
03313             <span class="comment">// We have filled up all the space in the paging file. </span>
03314             <span class="comment">//</span>
03315             
03316             <span class="keywordflow">if</span> ( Mcb[0].QuadPart == 0) {
03317                 <span class="keywordflow">return</span> STATUS_END_OF_FILE;
03318             }
03319         }
03320     }
03321 
03322     *McbBuffer = Mcb;
03323 
03324     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03325 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="dumpctl.c::IopWriteSummaryDump" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopWriteSummaryDump           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_BITMAP&nbsp;</td>
          <td class="mdname" nowrap> <em>PageMap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/io_8h.html#a268">PDUMP_DRIVER_WRITE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverWriteRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PANSI_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ProgressMessage</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>MessageBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverTransferSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03329">3329</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03183">IopWritePageToDisk()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, <a class="el" href="../../d6/d9/heappage_8c.html#a68">sprintf()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.
<p>
<pre class="fragment"><div>03340                    :
03341 
03342     Write a summary dump to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk.
03343 
03344 Arguments:
03345 
03346 
03347     PageMap - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> bitmap of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages that need to be written.
03348 
03349     DriverWriteRoutine - The driver's write routine.
03350 
03351     ProgressMessage - The <span class="stringliteral">"Percent Complete"</span> message.
03352 
03353     MessageBuffer - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> message buffer we can use to update percentage complete
03354             status.
03355 
03356     Mcb - Message Control Block where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be written.
03357 
03358     DriverTransferSize - The maximum transfer size <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver.
03359 
03360 Return Values:
03361 
03362     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
03363 
03364 --*/
03365 
03366 {
03367     PVOID Va;
03368     PFN_NUMBER PageFrameIndex;
03369     PHYSICAL_ADDRESS PhysicalAddress;
03370     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03371 
03372     ULONG WriteCount;
03373     ULONG MaxWriteCount;
03374     ULONG Step;
03375     
03376 
03377     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( DriverWriteRoutine != NULL );
03378     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( Mcb != NULL );
03379     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( DriverTransferSize != 0 );
03380     
03381 
03382     MaxWriteCount = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a> ( PageMap );
03383     Step = MaxWriteCount / 100;
03384 
03385     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((1, <span class="stringliteral">"IODUMP: Summary Dump\n"</span>
03386                      <span class="stringliteral">"  Writing %x pages to disk from a total of %x\n"</span>,
03387                   MaxWriteCount,
03388                   PageMap-&gt;SizeOfBitMap));
03389 
03390     <span class="comment">//</span>
03391     <span class="comment">// Loop over all pages in the system and write those that are set</span>
03392     <span class="comment">// in the bitmap.</span>
03393     <span class="comment">//</span>
03394 
03395     WriteCount = 0;
03396     <span class="keywordflow">for</span> ( PageFrameIndex = 0;
03397           PageFrameIndex &lt; PageMap-&gt;SizeOfBitMap;
03398           PageFrameIndex++) {
03399 
03400 
03401         <span class="comment">//</span>
03402         <span class="comment">// If this page needs to be included in the dump file.</span>
03403         <span class="comment">//</span>
03404         
03405         <span class="keywordflow">if</span> ( RtlCheckBit (PageMap, PageFrameIndex) ) {
03406 
03407             <span class="keywordflow">if</span> (++WriteCount % Step == 0) {
03408 
03409                 <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a> (MessageBuffer,
03410                          <span class="stringliteral">"%Z: %3d\r"</span>,
03411                          ProgressMessage,
03412                          (WriteCount * 100) / MaxWriteCount);
03413 
03414                 <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a> ( MessageBuffer );
03415             }
03416 
03417             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( WriteCount &lt;= MaxWriteCount );
03418 
03419             <span class="comment">//</span>
03420             <span class="comment">// Write the page to disk.</span>
03421             <span class="comment">//</span>
03422             
03423             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a53">IopWritePageToDisk</a> (
03424                             DriverWriteRoutine,
03425                             &amp;Mcb,
03426                             DriverTransferSize,
03427                             PageFrameIndex
03428                             );
03429             
03430             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
03431 
03432                 <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
03433             }
03434         }
03435     }
03436 
03437     <span class="keywordflow">return</span> STATUS_SUCCESS;
03438 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="dumpctl.c::IopWriteSummaryDump" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopWriteSummaryDump           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRTL_BITMAP&nbsp;</td>
          <td class="mdname" nowrap> <em>PageMap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/io_8h.html#a268">PDUMP_DRIVER_WRITE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PANSI_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ProgressMessage</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>MessageBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DiverTransferSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="dumpctl.c::IopWriteSummaryHeader" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopWriteSummaryHeader           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSUMMARY_DUMP_HEADER&nbsp;</td>
          <td class="mdname" nowrap> <em>pSummaryHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/io_8h.html#a268">PDUMP_DRIVER_WRITE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pfWrite</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER *&nbsp;</td>
          <td class="mdname" nowrap> <em>pMcbBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pMdl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>dwWriteSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>dwLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03520">3520</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03759">IopMapVirtualToPhysicalMdl()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.
<p>
<pre class="fragment"><div>03530                    :
03531 
03532     Write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> summary dump header to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
03533 
03534 Arguments:
03535 
03536     pSummaryHeader - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> summary dump bitmap
03537 
03538     pfWrite - dump driver write function
03539 
03540     McbBuffer - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d7/struct__MCB.html">MCB</a> array.
03541 
03542     pMdl - Pointer to an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>
03543 
03544     dwWriteSize - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a> transfer size <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump driver
03545 
03546     dwLength - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <span class="keyword">this</span> transfer
03547 
03548 Return Value:
03549 
03550     Updated <a class="code" href="../../d2/d7/struct__MCB.html">MCB</a>
03551 
03552 --*/
03553 {
03554     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03555     ULONG       dwBytesRemaining;
03556     ULONG_PTR   dwMemoryAddress;
03557     ULONG       dwByteOffset;
03558     ULONG       dwByteCount;
03559     PLARGE_INTEGER pMcb;
03560 
03561     dwBytesRemaining = dwLength;
03562     dwMemoryAddress = (ULONG_PTR) pSummaryHeader;
03563     pMcb = *McbBuffer;
03564 
03565     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> (( 0, <span class="stringliteral">"IoWriteCrashDump: Writing SUMMARY dump header to disk\n"</span> ));
03566 
03567     <span class="keywordflow">while</span> (dwBytesRemaining) {
03568 
03569         <span class="comment">// Calculate byte offset</span>
03570         dwByteOffset = (ULONG)(dwMemoryAddress &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
03571 
03572         <span class="comment">//</span>
03573         <span class="comment">// See if the number of bytes to write is greator than the crash</span>
03574         <span class="comment">// drives max transfer.</span>
03575         <span class="comment">//</span>
03576         
03577         <span class="keywordflow">if</span> (dwBytesRemaining &lt;= dwWriteSize) {
03578             dwByteCount = dwBytesRemaining;
03579         } <span class="keywordflow">else</span> {
03580             dwByteCount = dwWriteSize;
03581         }
03582 
03583         <span class="comment">//</span>
03584         <span class="comment">// If the byteCount is greater than the remaining mcb then correct it.</span>
03585         <span class="comment">//</span>
03586         
03587         <span class="keywordflow">if</span> (dwByteCount &gt; pMcb[0].QuadPart) {
03588             dwByteCount = pMcb[0].LowPart;
03589         }
03590 
03591         pMdl-&gt;ByteCount      = dwByteCount;
03592         pMdl-&gt;ByteOffset     = dwByteOffset;
03593         pMdl-&gt;MappedSystemVa = (PVOID) dwMemoryAddress;
03594 
03595         <span class="comment">//</span>
03596         <span class="comment">// Get the actual physical frame and create an mdl.</span>
03597         <span class="comment">//</span>
03598         
03599         <a class="code" href="../../d2/d3/dumpctl_8c.html#a28">IopMapVirtualToPhysicalMdl</a>(pMdl, dwMemoryAddress, dwByteCount);
03600 
03601         <span class="comment">//</span>
03602         <span class="comment">// Write to disk.</span>
03603         <span class="comment">//</span>
03604         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = pfWrite( &amp;pMcb[1], pMdl );
03605 
03606         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status) ) {
03607             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03608         }
03609 
03610         <span class="comment">//</span>
03611         <span class="comment">// Adjust bytes remaining.</span>
03612         <span class="comment">//</span>
03613 
03614         dwBytesRemaining -= dwByteCount;
03615         dwMemoryAddress  += dwByteCount;
03616 
03617         pMcb[0].QuadPart = pMcb[0].QuadPart - dwByteCount;
03618         pMcb[1].QuadPart = pMcb[1].QuadPart + dwByteCount;
03619 
03620         <span class="keywordflow">if</span> (pMcb[0].QuadPart == 0) {
03621             pMcb += 2;
03622         }
03623 
03624         <span class="keywordflow">if</span> (pMcb[0].QuadPart == 0) {
03625             <span class="keywordflow">return</span> STATUS_END_OF_FILE;
03626         }
03627     }
03628 
03629     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2, <span class="stringliteral">"IoWriteCrashDump: Writing SUMMARY dump header to disk\n"</span> ));
03630 
03631     *McbBuffer = pMcb;
03632     <span class="keywordflow">return</span> STATUS_SUCCESS;
03633 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="dumpctl.c::IopWriteToDisk" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopWriteToDisk           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/io_8h.html#a268">PDUMP_DRIVER_WRITE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverWriteRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER *&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mdl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverTransferSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03638">3638</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00460">_DUMP_CONTROL_BLOCK::FileDescriptorArray</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00461">_DUMP_CONTROL_BLOCK::FileDescriptorSize</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00086">IO_DUMP_MAXIMUM_TRANSFER_SIZE</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00087">IO_DUMP_MINIMUM_TRANSFER_SIZE</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00263">IopDumpControlBlock</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03759">IopMapVirtualToPhysicalMdl()</a>, <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00366">min</a>, and <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02795">IopWriteTriageDump()</a>.
<p>
<pre class="fragment"><div>03648                    :
03649 
03650     Write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> summary dump header to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
03651 
03652 Arguments:
03653 
03654     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to write.
03655 
03656     WriteLength - The length of <span class="keyword">this</span> transfer.
03657 
03658     DriverWriteRoutine - <a class="code" href="../../d2/d5/editreg_8c.html#a66">Dump</a> driver write function.
03659 
03660     McbBuffer - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> Mapped Control Block.
03661 
03662     Mdl - Pointer to an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
03663 
03664     DriverTransferSize - The <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a> transfer size <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump driver.
03665 
03666 
03667 Return Value:
03668 
03669 
03670 --*/
03671 {
03672     ULONG dwBytesRemaining;
03673     ULONG_PTR dwMemoryAddress;
03674     ULONG dwByteOffset;
03675     ULONG dwByteCount;
03676     PLARGE_INTEGER Mcb;
03677 
03678     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Buffer);
03679     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WriteLength);
03680     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DriverWriteRoutine);
03681     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (McbBuffer &amp;&amp; *McbBuffer);
03682     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Mdl);
03683     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DriverTransferSize &gt;= IO_DUMP_MINIMUM_TRANSFER_SIZE &amp;&amp;
03684             DriverTransferSize &lt;= IO_DUMP_MAXIMUM_TRANSFER_SIZE);
03685     
03686 
03687     Mcb = *McbBuffer;
03688     dwBytesRemaining = WriteLength;
03689     dwMemoryAddress = (ULONG_PTR) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
03690 
03691     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>(( 2, <span class="stringliteral">"IoWriteToDisk: Writing %d bytes to disk.\n"</span>, WriteLength ));
03692 
03693     <span class="keywordflow">while</span> (dwBytesRemaining) {
03694 
03695         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Mcb [0].QuadPart != 0);
03696         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o9">FileDescriptorArray</a> &lt;= Mcb &amp;&amp;
03697                 (LPBYTE) Mcb &lt; (LPBYTE) IopDumpControlBlock-&gt;FileDescriptorArray +
03698                                <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o10">FileDescriptorSize</a>
03699                 );
03700         
03701         dwByteOffset = <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a> (dwMemoryAddress);
03702 
03703         <span class="comment">//</span>
03704         <span class="comment">// See if the number of bytes to write is greator than the crash</span>
03705         <span class="comment">// drives max transfer.</span>
03706         <span class="comment">//</span>
03707 
03708         dwByteCount = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a> ( dwBytesRemaining, DriverTransferSize );
03709 
03710         <span class="comment">//</span>
03711         <span class="comment">// If the byteCount is greater than the remaining mcb then correct it.</span>
03712         <span class="comment">//</span>
03713         
03714         <span class="keywordflow">if</span> (dwByteCount &gt; Mcb[0].QuadPart) {
03715             dwByteCount = Mcb[0].LowPart;
03716         }
03717 
03718         Mdl-&gt;ByteCount = dwByteCount;
03719         Mdl-&gt;ByteOffset = dwByteOffset;
03720         Mdl-&gt;MappedSystemVa = (PVOID) dwMemoryAddress;
03721 
03722         <span class="comment">//</span>
03723         <span class="comment">// Get the actual physical frame and create an mdl.</span>
03724         <span class="comment">//</span>
03725         
03726         <a class="code" href="../../d2/d3/dumpctl_8c.html#a28">IopMapVirtualToPhysicalMdl</a>(Mdl, dwMemoryAddress, dwByteCount);
03727 
03728         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( DriverWriteRoutine ( &amp;Mcb[1], Mdl ) )) {
03729             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((1, <span class="stringliteral">"IopWriteToDisk: Failed write.\n"</span>));
03730             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
03731         }
03732 
03733         <span class="comment">//</span>
03734         <span class="comment">// Adjust bytes remaining.</span>
03735         <span class="comment">//</span>
03736 
03737         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (dwBytesRemaining &gt;= dwByteCount);
03738         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (dwByteCount != 0);
03739         
03740         dwBytesRemaining -= dwByteCount;
03741         dwMemoryAddress  += dwByteCount;
03742 
03743         Mcb[0].QuadPart -= dwByteCount;
03744         Mcb[1].QuadPart += dwByteCount;
03745         
03746         <span class="keywordflow">if</span> (Mcb[0].QuadPart == 0) {
03747             Mcb += 2;
03748         }
03749     }
03750 
03751     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((2, <span class="stringliteral">"IopWriteToDisk: Successfully wrote %d bytes.\n"</span>, WriteLength));
03752 
03753     *McbBuffer = Mcb;
03754     <span class="keywordflow">return</span> STATUS_SUCCESS;
03755 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="dumpctl.c::IopWriteTriageDump" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopWriteTriageDump           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Fields</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/io_8h.html#a268">PDUMP_DRIVER_WRITE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverWriteRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mdl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverTransferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ServicePackBuild</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TriageOptions</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02795">2795</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02672">ALIGN_8</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00126">ALIGN_UP</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00067">DriverEntry()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02676">IndexByByte</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00556">_KTHREAD::InitialStack</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02602">IopGetLoadedDriverInfo()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02681">IopWriteDriverList()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03638">IopWriteToDisk()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00625">_KTHREAD::KernelStackResident</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">LPVOID</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00094">MAX_TRIAGE_STACK_SIZE</a>, <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00366">min</a>, <a class="el" href="../../d2/d1/mm_8h.html#a236">MmSizeOfTriageInformation()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a237">MmSizeOfUnloadedDriverInformation()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a238">MmWriteTriageInformation()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a239">MmWriteUnloadedDriverInformation()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.
<p>
<pre class="fragment"><div>02810                    :
02811 
02812     Write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Triage-<a class="code" href="../../d2/d5/editreg_8c.html#a66">Dump</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d7/struct__MCB.html">MCB</a>.
02813 
02814 Arguments:
02815 
02816     Fields - The set of fields that should be written.
02817     
02818     DriverWriteRoutine - The write routine <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver.
02819 
02820     Mcb - Message Control Block where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be written.
02821 
02822     Mdl - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> descrbing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data to be written (??).
02823 
02824     DriverTransferSize - The maximum transfer size <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver.
02825 
02826     Context - The context.
02827 
02828     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - The buffer to use as a scratch buffer.
02829 
02830     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - The size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
02831 
02832     ServicePackBuild - Service Pack BuildNumber.
02833 
02834     TriageOptions - Triage Options.
02835 
02836 Return Values:
02837 
02838     STATUS_SUCCESS - On success.
02839 
02840     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Otherwise.
02841 
02842 Comments:
02843 
02844     This function assumes that exactly one header page was written.
02845 
02846 --*/
02847 
02848 {
02849     ULONG SizeOfSection;
02850     ULONG SizeOfStringData;
02851     ULONG DriverCount = 0;
02852     <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> Address = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02853     ULONG BytesToWrite = 0;
02854     ULONG_PTR BufferAddress = 0;
02855     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02856     ULONG_PTR <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
02857     ULONG_PTR StartOfStackRegion = 0;
02858     PTRIAGE_DUMP_HEADER TriageDumpHeader = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02859     PLDR_DATA_TABLE_ENTRY <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02860     PDUMP_DRIVER_ENTRY DumpImageArray = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02861     PDUMP_STRING DumpStringName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02862     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02863 
02864     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((0, <span class="stringliteral">"[IopWriteTriageDump] BufferSize = %#x ServicePackBuild = %d\n"</span>,
02865                    BufferSize,
02866                    ServicePackBuild));
02867 
02868     <span class="comment">//</span>
02869     <span class="comment">// Setup the triage-dump header.</span>
02870     <span class="comment">//</span>
02871 
02872     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &lt; <span class="keyword">sizeof</span> (TRIAGE_DUMP_HEADER) + <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)) {
02873         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02874     }
02875     
02876     TriageDumpHeader = (PTRIAGE_DUMP_HEADER) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02877     RtlZeroMemory (TriageDumpHeader, <span class="keyword">sizeof</span> (*TriageDumpHeader));
02878 
02879     <span class="comment">//</span>
02880     <span class="comment">// The normal dump header is of size PAGE_SIZE.</span>
02881     <span class="comment">//</span>
02882     
02883     TriageDumpHeader-&gt;SizeOfDump = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02884 
02885     <span class="comment">//</span>
02886     <span class="comment">// Adjust the BufferSize so we can write the final status DWORD at the</span>
02887     <span class="comment">// end.</span>
02888     <span class="comment">//</span>
02889     
02890     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> -= <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
02891     RtlZeroMemory (IndexByByte (Buffer, BufferSize), <span class="keyword">sizeof</span> (DWORD));
02892 
02893     TriageDumpHeader-&gt;ValidOffset = ( TriageDumpHeader-&gt;SizeOfDump - <span class="keyword">sizeof</span> (ULONG) );
02894     TriageDumpHeader-&gt;ContextOffset = DH_CONTEXT_RECORD * <span class="keyword">sizeof</span> (ULONG);
02895     TriageDumpHeader-&gt;ExceptionOffset = DH_EXCEPTION_RECORD * <span class="keyword">sizeof</span> (ULONG);
02896     TriageDumpHeader-&gt;BrokenDriverOffset = 0;
02897     TriageDumpHeader-&gt;ServicePackBuild = ServicePackBuild;
02898     TriageDumpHeader-&gt;TriageOptions = TriageOptions;
02899 
02900     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a13">ALIGN_8</a> (PAGE_SIZE + <span class="keyword">sizeof</span> (TRIAGE_DUMP_HEADER));
02901 
02902     <span class="comment">//</span>
02903     <span class="comment">// Set the Mm Offset, if necessary.</span>
02904     <span class="comment">//</span>
02905 
02906     SizeOfSection = <a class="code" href="../../d2/d3/dumpctl_8c.html#a13">ALIGN_8</a> (<a class="code" href="../../d2/d1/mm_8h.html#a236">MmSizeOfTriageInformation</a>());
02907 
02908     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + SizeOfSection &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
02909         TriageDumpHeader-&gt;MmOffset = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
02910         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += SizeOfSection;
02911     }
02912 
02913     <span class="comment">//</span>
02914     <span class="comment">// Set the Unloaded Drivers Offset, if necessary.</span>
02915     <span class="comment">//</span>
02916 
02917     SizeOfSection = <a class="code" href="../../d2/d3/dumpctl_8c.html#a13">ALIGN_8</a> (<a class="code" href="../../d2/d1/mm_8h.html#a237">MmSizeOfUnloadedDriverInformation</a>());
02918 
02919     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + SizeOfSection &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
02920         TriageDumpHeader-&gt;UnloadedDriversOffset = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
02921         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += SizeOfSection;
02922     }
02923 
02924     <span class="comment">//</span>
02925     <span class="comment">// Set the Prcb Offset, if necessary.</span>
02926     <span class="comment">//</span>
02927 
02928     <span class="keywordflow">if</span> (Fields &amp; TRIAGE_DUMP_PRCB) {
02929         SizeOfSection = <a class="code" href="../../d2/d3/dumpctl_8c.html#a13">ALIGN_8</a> (<span class="keyword">sizeof</span> (KPRCB));
02930 
02931         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + SizeOfSection &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
02932             TriageDumpHeader-&gt;PrcbOffset = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
02933             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += SizeOfSection;
02934         }
02935     }
02936 
02937     <span class="comment">//</span>
02938     <span class="comment">// Set the Process Offset, if necessary.</span>
02939     <span class="comment">//</span>
02940 
02941     <span class="keywordflow">if</span> (Fields &amp; TRIAGE_DUMP_PROCESS) {
02942         SizeOfSection = <a class="code" href="../../d2/d3/dumpctl_8c.html#a13">ALIGN_8</a> (<span class="keyword">sizeof</span> (<a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>));
02943 
02944         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + SizeOfSection &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
02945             TriageDumpHeader-&gt;ProcessOffset = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
02946             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += SizeOfSection;
02947         }
02948     }
02949 
02950     <span class="comment">//</span>
02951     <span class="comment">// Set the Thread Offset, if necessary.</span>
02952     <span class="comment">//</span>
02953     
02954     <span class="keywordflow">if</span> (Fields &amp; TRIAGE_DUMP_THREAD) {
02955         SizeOfSection = <a class="code" href="../../d2/d3/dumpctl_8c.html#a13">ALIGN_8</a> (<span class="keyword">sizeof</span> (<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>));
02956 
02957         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + SizeOfSection &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
02958             TriageDumpHeader-&gt;ThreadOffset = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
02959             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += SizeOfSection;
02960         }
02961     }
02962 
02963     <span class="comment">//</span>
02964     <span class="comment">// Set the CallStack Offset, if necessary.</span>
02965     <span class="comment">//</span>
02966 
02967     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
02968 
02969     <span class="keywordflow">if</span> (Fields &amp; TRIAGE_DUMP_STACK) {
02970 
02971         <span class="comment">//</span>
02972         <span class="comment">// If there is a stack, calculate its size.</span>
02973         <span class="comment">//</span>
02974         
02975         <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o44">KernelStackResident</a>) {
02976 
02977             ULONG_PTR StackBase;
02978 
02979             StackBase = (ULONG_PTR) Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a>;
02980 
02981             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( StackBase &gt; STACK_POINTER (Context));
02982             
02983             <span class="comment">//</span>
02984             <span class="comment">// There is a valid stack. Note that we limit the size of</span>
02985             <span class="comment">// the triage dump stack to MAX_TRIAGE_STACK_SIZE (currently</span>
02986             <span class="comment">// 16 KB).</span>
02987             <span class="comment">//</span>
02988 
02989             StartOfStackRegion = (ULONG_PTR) STACK_POINTER (Context);
02990             SizeOfSection = (ULONG) <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a> ( StackBase -  (ULONG_PTR) STACK_POINTER (Context),
02991                                   MAX_TRIAGE_STACK_SIZE
02992                                   );
02993 
02994             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( StartOfStackRegion + SizeOfSection &lt;= StackBase);
02995                 
02996         } <span class="keywordflow">else</span> {
02997 
02998             <span class="comment">//</span>
02999             <span class="comment">// There is not a valid stack.</span>
03000             <span class="comment">//</span>
03001 
03002             SizeOfSection = 0;
03003         }
03004 
03005         <span class="keywordflow">if</span> (SizeOfSection &amp;&amp; <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + SizeOfSection &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
03006             TriageDumpHeader-&gt;CallStackOffset = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
03007             TriageDumpHeader-&gt;SizeOfCallStack = SizeOfSection;
03008             TriageDumpHeader-&gt;BaseOfStack = (ULONG) StartOfStackRegion;
03009             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += SizeOfSection;
03010         }
03011     }
03012 
03013     <span class="comment">//</span>
03014     <span class="comment">// Set the Driver List Offset, if necessary.</span>
03015     <span class="comment">//</span>
03016     
03017     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a50">IopGetLoadedDriverInfo</a> (&amp;DriverCount, &amp;SizeOfStringData);
03018 
03019     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status) &amp;&amp; Fields &amp; TRIAGE_DUMP_DRIVER_LIST) {
03020         SizeOfSection = <a class="code" href="../../d2/d3/dumpctl_8c.html#a13">ALIGN_8</a> (DriverCount * <span class="keyword">sizeof</span> (DUMP_DRIVER_ENTRY));
03021 
03022         <span class="keywordflow">if</span> (SizeOfSection &amp;&amp; (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + SizeOfSection &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>)) {
03023             TriageDumpHeader-&gt;DriverListOffset = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
03024             TriageDumpHeader-&gt;DriverCount = DriverCount;
03025             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += SizeOfSection;
03026         }
03027 
03028     } <span class="keywordflow">else</span> {
03029 
03030         SizeOfSection = 0;
03031         SizeOfStringData = 0;
03032     }
03033             
03034     <span class="comment">//</span>
03035     <span class="comment">// Set the String Pool offset.</span>
03036     <span class="comment">//</span>
03037 
03038     SizeOfSection = <a class="code" href="../../d2/d3/dumpctl_8c.html#a13">ALIGN_8</a> (SizeOfStringData +
03039                         DriverCount * (<span class="keyword">sizeof</span> (WCHAR) + <span class="keyword">sizeof</span> (DUMP_STRING)));
03040 
03041     <span class="keywordflow">if</span> (SizeOfSection &amp;&amp; (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + SizeOfSection &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>)) {
03042         TriageDumpHeader-&gt;StringPoolOffset = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
03043         TriageDumpHeader-&gt;StringPoolSize = SizeOfSection;
03044         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> += SizeOfSection;
03045     }
03046 
03047 
03048     BytesToWrite = (ULONG)<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
03049     BufferAddress = ((ULONG_PTR) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> ;
03050 
03051     <span class="comment">//</span>
03052     <span class="comment">// Write the Mm information.</span>
03053     <span class="comment">//</span>
03054 
03055     <span class="keywordflow">if</span> (TriageDumpHeader-&gt;MmOffset) {
03056 
03057         Address = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>) (BufferAddress + TriageDumpHeader-&gt;MmOffset);
03058         <a class="code" href="../../d2/d1/mm_8h.html#a238">MmWriteTriageInformation</a> (Address);
03059     }
03060 
03061     <span class="keywordflow">if</span> (TriageDumpHeader-&gt;UnloadedDriversOffset) {
03062 
03063         Address = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>) (BufferAddress + TriageDumpHeader-&gt;UnloadedDriversOffset);
03064         <a class="code" href="../../d2/d1/mm_8h.html#a239">MmWriteUnloadedDriverInformation</a> (Address);
03065     }
03066 
03067     <span class="comment">//</span>
03068     <span class="comment">// Write the PRCB.</span>
03069     <span class="comment">//</span>
03070 
03071     <span class="keywordflow">if</span> (TriageDumpHeader-&gt;PrcbOffset) {
03072 
03073         Address = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>) (BufferAddress + TriageDumpHeader-&gt;PrcbOffset);
03074         RtlCopyMemory (Address,
03075                        KeGetCurrentPrcb (),
03076                        <span class="keyword">sizeof</span> (KPRCB)
03077                        );
03078     }
03079 
03080     <span class="comment">//</span>
03081     <span class="comment">// Write the EPROCESS.</span>
03082     <span class="comment">//</span>
03083     
03084     <span class="keywordflow">if</span> (TriageDumpHeader-&gt;ProcessOffset) {
03085     
03086         Address = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>) (BufferAddress + TriageDumpHeader-&gt;ProcessOffset);
03087         RtlCopyMemory (Address,
03088                        PsGetCurrentProcess (),
03089                        <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>)
03090                        );
03091     }
03092 
03093     <span class="comment">//</span>
03094     <span class="comment">// Write the ETHREAD.</span>
03095     <span class="comment">//</span>
03096     
03097     <span class="keywordflow">if</span> (TriageDumpHeader-&gt;ThreadOffset) {
03098     
03099         Address = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>) (BufferAddress + TriageDumpHeader-&gt;ThreadOffset);
03100         RtlCopyMemory (Address,
03101                        KeGetCurrentThread (),
03102                        <span class="keyword">sizeof</span> (<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>)
03103                        );
03104     }
03105 
03106     <span class="comment">//</span>
03107     <span class="comment">// Write the Call Stack.</span>
03108     <span class="comment">//</span>
03109 
03110     <span class="keywordflow">if</span> (TriageDumpHeader-&gt;CallStackOffset) {
03111 
03112         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Thread);
03113         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TriageDumpHeader-&gt;SizeOfCallStack != 0);
03114 
03115         Address = (<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>) (BufferAddress + TriageDumpHeader-&gt;CallStackOffset);
03116         RtlCopyMemory (Address,
03117                        (PVOID) StartOfStackRegion,
03118                        TriageDumpHeader-&gt;SizeOfCallStack
03119                        );
03120     }
03121 
03122     <span class="comment">//</span>
03123     <span class="comment">// Write the Driver List.</span>
03124     <span class="comment">//</span>
03125     
03126     <span class="keywordflow">if</span> (TriageDumpHeader-&gt;DriverListOffset &amp;&amp;
03127         TriageDumpHeader-&gt;StringPoolOffset) {
03128 
03129         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a51">IopWriteDriverList</a> (BufferAddress,
03130                                      BufferSize,
03131                                      TriageDumpHeader-&gt;DriverListOffset,
03132                                      TriageDumpHeader-&gt;StringPoolOffset
03133                                      );
03134 
03135         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
03136             TriageDumpHeader-&gt;DriverListOffset = 0;
03137         }
03138     }
03139 
03140     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (BytesToWrite &lt; BufferSize);
03141     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ALIGN_UP (BytesToWrite, PAGE_SIZE) &lt; BufferSize);
03142 
03143     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> ((3, <span class="stringliteral">"TRIAGEDUMP: Calling IopWriteToDisk with:\n"</span>
03144                    <span class="stringliteral">"\tBytesToWrite = %#x\n"</span>
03145                    <span class="stringliteral">"\tBytesToWrite (Aligned) = %#x\n"</span>
03146                    <span class="stringliteral">"\tBufferSize = %#x\n"</span>,
03147                     BytesToWrite,
03148                     ALIGN_UP (BytesToWrite, PAGE_SIZE),
03149                     BufferSize));
03150 
03151 
03152     <span class="comment">//</span>
03153     <span class="comment">// Write the valid status to the end of the dump.</span>
03154     <span class="comment">//</span>
03155 
03156     *((ULONG *)<a class="code" href="../../d2/d3/dumpctl_8c.html#a14">IndexByByte</a> (Buffer, BufferSize)) = TRIAGE_DUMP_VALID ;
03157 
03158     <span class="comment">//</span>
03159     <span class="comment">// Re-adjust the buffer size.</span>
03160     <span class="comment">//</span>
03161     
03162     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> += <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
03163 
03164     <span class="comment">//</span>
03165     <span class="comment">// NOTE: This routine writes the entire buffer, even if it is not</span>
03166     <span class="comment">// all required.</span>
03167     <span class="comment">//</span>
03168 
03169     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a22">IopWriteToDisk</a> (Buffer,
03170                              BufferSize,
03171                              DriverWriteRoutine,
03172                              &amp;Mcb,
03173                              Mdl,
03174                              DriverTransferSize
03175                              );
03176 
03177     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03178 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="dumpctl.c::IopWriteTriageDump" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopWriteTriageDump           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FieldsToWrite</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d5/io_8h.html#a268">PDUMP_DRIVER_WRITE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Mcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mdl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DiverTransferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LPBYTE&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ServicePackBuild</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TriageOptions</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="dumpctl.c::IoSetCrashDumpState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IoSetCrashDumpState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SYSTEM_CRASH_STATE_INFORMATION *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pDumpState</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="dumpctl.c::IoSetDumpRange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IoSetDumpRange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DumpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>StartVa</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Pages</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IsPhysicalAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02291">2291</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02172">IopAddPageToPageMap()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05490">MmGetPhysicalAddress()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03815">IopCreateSummaryDump()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l08083">MmSetKernelDumpRange()</a>.
<p>
<pre class="fragment"><div>02300                    :
02301 
02302     This routine includes <span class="keyword">this</span> range of memory in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump
02303 
02304 Arguments:
02305 
02306     DumpContext - dump context
02307     
02308     StartVa - Starting VA
02309     
02310     Pages - The number of pages to include
02311     
02312     IsPhysicalAddress - <span class="keyword">true</span> <span class="keywordflow">if</span> direct physical address <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a46">translation</a>
02313     
02314 Return Value:
02315 
02316     STATUS_SUCCESS - On success.
02317     
02318     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a>.
02319 
02320 --*/
02321 {
02322     PCHAR                   Va;
02323     PRTL_BITMAP             pBitMapHeader;
02324     PHYSICAL_ADDRESS        phyAddr;
02325     PSUMMARY_DUMP_HEADER    pHeader;
02326     BOOLEAN                 AllPagesSet;
02327 
02328 
02329     Va = StartVa;
02330     pHeader = (PSUMMARY_DUMP_HEADER) DumpContext;
02331     pBitMapHeader = (PRTL_BITMAP)(pHeader + 1);
02332     AllPagesSet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02333 
02334     <span class="comment">//</span>
02335     <span class="comment">// Win64 can have really large page addresses.  This dump code does</span>
02336     <span class="comment">// not handle that yet.  Note that before this assert is removed</span>
02337     <span class="comment">// the casts of Pages to ULONG must be removed.</span>
02338     <span class="comment">//</span>
02339 
02340     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Pages &lt;= MAXULONG);
02341 
02342     <span class="comment">//</span>
02343     <span class="comment">// IsPhysicalAddress indicates that the va is virtually / physically</span>
02344     <span class="comment">// contiguous.</span>
02345     <span class="comment">//</span>
02346     
02347     <span class="keywordflow">if</span> (IsPhysicalAddress) {
02348 
02349         phyAddr = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a> (Va);
02350         <a class="code" href="../../d2/d3/dumpctl_8c.html#a44">IopAddPageToPageMap</a> (pHeader-&gt;BitmapSize,
02351                              pBitMapHeader,
02352                              (ULONG)(phyAddr.QuadPart &gt;&gt; PAGE_SHIFT),
02353                              (ULONG) Pages
02354                              );
02355 
02356     } <span class="keywordflow">else</span> {
02357     
02358         <span class="comment">//</span>
02359         <span class="comment">// Not physically contiguous.</span>
02360         <span class="comment">//</span>
02361         
02362         <span class="keywordflow">while</span> (Pages) {
02363 
02364             <span class="comment">//</span>
02365             <span class="comment">// Only do a translation for valid pages.</span>
02366             <span class="comment">//</span>
02367             
02368             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(Va) ) {
02369 
02370                 <span class="comment">//</span>
02371                 <span class="comment">// Get the physical mapping. Note: this does not require a lock</span>
02372                 <span class="comment">//</span>
02373                 
02374                 phyAddr = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a> (Va);
02375 
02376                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a44">IopAddPageToPageMap</a> (pHeader-&gt;BitmapSize,
02377                                      pBitMapHeader,
02378                                      (ULONG)(phyAddr.QuadPart &gt;&gt; PAGE_SHIFT),
02379                                      1);
02380 
02381                 <span class="keywordflow">if</span> (phyAddr.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> &gt; pHeader-&gt;BitmapSize) {
02382                     AllPagesSet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02383                 }
02384             }
02385 
02386             Va +=  <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02387             Pages--;
02388         }
02389     }
02390 
02391     <span class="keywordflow">if</span> (AllPagesSet) {
02392         <span class="keywordflow">return</span> STATUS_SUCCESS;
02393     }
02394 
02395     <span class="keywordflow">return</span> STATUS_INVALID_ADDRESS;
02396 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="dumpctl.c::IoWriteCrashDump" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IoWriteCrashDump           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BugCheckCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>BugCheckParameter1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>BugCheckParameter2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>BugCheckParameter3</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>BugCheckParameter4</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextSave</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">1519</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00034">_PHYSICAL_MEMORY_RUN::BasePage</a>, <a class="el" href="../../d9/d8/tbitmap_8c-source.html#l00028">BitMap</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00466">_DUMP_CONTROL_BLOCK::BuildNumber</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00420">_MDL::ByteCount</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00421">_MDL::ByteOffset</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00444">DCB_AUTO_REBOOT</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00442">DCB_DUMP_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00445">DCB_DUMP_HEADER_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00446">DCB_SUMMARY_DUMP_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00443">DCB_SUMMARY_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00447">DCB_TRIAGE_DUMP_ENABLED</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00457">_DUMP_CONTROL_BLOCK::DumpStack</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00047">EXCEPTION_NONCONTINUABLE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00460">_DUMP_CONTROL_BLOCK::FileDescriptorArray</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00452">_DUMP_CONTROL_BLOCK::Flags</a>, <a class="el" href="../../d4/d9/ke_8h.html#a411a244">HalRebootRoutine</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00462">_DUMP_CONTROL_BLOCK::HeaderPage</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00463">_DUMP_CONTROL_BLOCK::HeaderPfn</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00468">_DUMP_CONTROL_BLOCK::HeaderSize</a>, <a class="el" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00086">IO_DUMP_MAXIMUM_TRANSFER_SIZE</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00087">IO_DUMP_MINIMUM_TRANSFER_SIZE</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00231">IoDebugPrint</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01142">IoInitializeDumpStack()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00263">IopDumpControlBlock</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00264">IopDumpControlBlockChecksum</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00078">IopFinalCrashDumpStatus</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01062">IopGetDumpControlBlockCheck()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01452">IopInitializeDumpSpaceAndType()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03442">IopInitializeSummaryDump()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02081">IopMapPhysicalMemory()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03329">IopWriteSummaryDump()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03520">IopWriteSummaryHeader()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02795">IopWriteTriageDump()</a>, <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html#l00055">KdGetDataBlock()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d0/d4/ke_2debug_8c-source.html#l00499">KeReturnToFirmware()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00464">_DUMP_CONTROL_BLOCK::MajorVersion</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00418">_MDL::MappedSystemVa</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00416">_MDL::MdlFlags</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00458">_DUMP_CONTROL_BLOCK::MemoryDescriptor</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00465">_DUMP_CONTROL_BLOCK::MinorVersion</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05852">MmCreateMdl()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00275">MmGetMdlPfnArray</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00075">MmPfnDatabase</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00040">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfPages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00039">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfRuns</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00454">_DUMP_CONTROL_BLOCK::NumberProcessors</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00301">PDUMP_DRIVER_FINISH</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00293">PDUMP_DRIVER_WRITE</a>, <a class="el" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a>, <a class="el" href="../../d2/d1/mm_8h.html#a129">PHYSICAL_MEMORY_DESCRIPTOR</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00575">PsActiveProcessHead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00041">_PHYSICAL_MEMORY_DESCRIPTOR::Run</a>, <a class="el" href="../../d6/d9/heappage_8c.html#a68">sprintf()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00419">_MDL::StartVa</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00471">_DUMP_CONTROL_BLOCK::TriageDumpBuffer</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00472">_DUMP_CONTROL_BLOCK::TriageDumpBufferSize</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00470">_DUMP_CONTROL_BLOCK::TriageDumpFlags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d1/d5/iop_8h-source.html#l00467">_DUMP_CONTROL_BLOCK::VersionUser</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>.
<p>
<pre class="fragment"><div>01530                    :
01531 
01532     This routine checks to see whether or not crash dumps are enabled and, <span class="keywordflow">if</span>
01533     so, writes all of physical memory to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system disk's paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01534 
01535 Arguments:
01536 
01537     BugCheckCode/ParameterN - Code and parameters w/which BugCheck was called.
01538 
01539 Return Value:
01540 
01541     None.
01542 
01543 --*/
01544 
01545 {
01546     <a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html">PDUMP_CONTROL_BLOCK</a> dcb;
01547     <a class="code" href="../../d0/d5/io_8h.html#a281">PDUMP_STACK_CONTEXT</a> dumpStack;
01548     <a class="code" href="../../d0/d5/io_8h.html#a268">PDUMP_DRIVER_WRITE</a> write;
01549     <a class="code" href="../../d0/d5/io_8h.html#a269">PDUMP_DRIVER_FINISH</a> finishUp;
01550     PDUMP_HEADER header;
01551     EXCEPTION_RECORD exception;
01552     PCONTEXT context = ContextSave;
01553     PULONG block;
01554     LARGE_INTEGER diskByteOffset;
01555     PPFN_NUMBER page;
01556     PFN_NUMBER localMdl[(<span class="keyword">sizeof</span>( <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> )/<span class="keyword">sizeof</span>(PFN_NUMBER)) + 17];
01557     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> mdl;
01558     PLARGE_INTEGER mcb;
01559     ULONG_PTR memoryAddress;
01560     ULONG byteOffset;
01561     ULONG byteCount;
01562     ULONG bytesRemaining;
01563     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01564     UCHAR messageBuffer[128];
01565     PFN_NUMBER ActualPages;
01566     PSUMMARY_DUMP_HEADER pSummaryHeader;
01567     ULONG dwTransferSize;
01568     LARGE_INTEGER requiredDumpSpace;
01569     ULONG_PTR DirBasePage;
01570 
01571     <span class="comment">//</span>
01572     <span class="comment">// Begin by determining whether or not crash dumps are enabled.  If not,</span>
01573     <span class="comment">// check to see whether or not auto-rebooting is enabled.  If not, return</span>
01574     <span class="comment">// immediately since there is nothing to do.</span>
01575     <span class="comment">//</span>
01576 
01577     dcb = <a class="code" href="../../d3/d5/iodata_8c.html#a47">IopDumpControlBlock</a>;
01578     <span class="keywordflow">if</span> (!dcb) {
01579         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01580     }
01581 
01582     <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a5">DCB_DUMP_ENABLED</a> || dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a6">DCB_SUMMARY_ENABLED</a>) {
01583 
01584         <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_PENDING;
01585 
01586         <span class="comment">//</span>
01587         <span class="comment">// A dump is to be written to the paging file.  Ensure that all of the</span>
01588         <span class="comment">// descriptor data for what needs to be done is valid, otherwise it</span>
01589         <span class="comment">// could be that part of the reason for the bugcheck is that this data</span>
01590         <span class="comment">// was corrupted.  Or, it could be that no paging file was found yet,</span>
01591         <span class="comment">// or any number of other situations.</span>
01592         <span class="comment">//</span>
01593 
01594         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a176">IopGetDumpControlBlockCheck</a>(dcb) != <a class="code" href="../../d3/d5/iodata_8c.html#a48">IopDumpControlBlockChecksum</a>) {
01595             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> (( 0,
01596                            <span class="stringliteral">"CRASHDUMP: Disk dump routine returning due to DCB integrity error\n"</span>
01597                            <span class="stringliteral">"           No dump will be created\n"</span> ));
01598             <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_UNSUCCESSFUL;
01599             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01600         }
01601 
01602         <span class="comment">//</span>
01603         <span class="comment">// Message  that we are starting the crashdump</span>
01604         <span class="comment">//</span>
01605 
01606         dumpStack = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o6">DumpStack</a>;
01607         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( messageBuffer, <span class="stringliteral">"%Z\n"</span>, &amp;dumpStack-&gt;InitMsg );
01608 
01609         <span class="comment">//</span>
01610         <span class="comment">// Initialize the dump stack</span>
01611         <span class="comment">//</span>
01612 
01613         status = <a class="code" href="../../d2/d3/dumpctl_8c.html#a39">IoInitializeDumpStack</a> (dumpStack, messageBuffer);
01614         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01615             <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_UNSUCCESSFUL;
01616             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01617         }
01618 
01619         <span class="comment">//</span>
01620         <span class="comment">// Record the dump driver's entry points.</span>
01621         <span class="comment">//</span>
01622 
01623         write = dumpStack-&gt;Init.WriteRoutine;
01624         finishUp = dumpStack-&gt;Init.FinishRoutine;
01625 
01626 
01627         dwTransferSize = dumpStack-&gt;Init.MaximumTransferSize;
01628 
01629         <span class="keywordflow">if</span> ( ( !dwTransferSize ) || ( dwTransferSize &gt; <a class="code" href="../../d2/d3/dumpctl_8c.html#a1">IO_DUMP_MAXIMUM_TRANSFER_SIZE</a> ) ) {
01630             dwTransferSize = <a class="code" href="../../d2/d3/dumpctl_8c.html#a2">IO_DUMP_MINIMUM_TRANSFER_SIZE</a>;
01631         }
01632 
01633         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"CRASHDUMP: Maximum Transfer Size = %x\n"</span>,dwTransferSize));
01634 
01635 
01636         <span class="comment">//</span>
01637         <span class="comment">// The boot partition was found, so put together a dump file header</span>
01638         <span class="comment">// and write it to the disk.</span>
01639         <span class="comment">//</span>
01640 
01641         block = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a>;
01642         header = (PDUMP_HEADER) block;
01643 
01644         RtlFillMemoryUlong( header, PAGE_SIZE, 'EGAP' );
01645         header-&gt;ValidDump = 'PMUD';
01646         header-&gt;BugCheckCode = BugCheckCode;
01647         header-&gt;BugCheckParameter1 = BugCheckParameter1;
01648         header-&gt;BugCheckParameter2 = BugCheckParameter2;
01649         header-&gt;BugCheckParameter3 = BugCheckParameter3;
01650         header-&gt;BugCheckParameter4 = BugCheckParameter4;
01651 <span class="preprocessor">#if defined (i386)</span>
01652 <span class="preprocessor"></span>        <span class="comment">//</span>
01653         <span class="comment">// Add the current page directory table page - don't use the directory</span>
01654         <span class="comment">// table base for the crashing process as we have switched cr3 on</span>
01655         <span class="comment">// stack overflow crashes, etc.</span>
01656         <span class="comment">//</span>
01657     
01658         _asm {
01659             mov     eax, cr3
01660             mov     DirBasePage, eax
01661         }
01662         header-&gt;DirectoryTableBase = DirBasePage;
01663 <span class="preprocessor">#else</span>
01664 <span class="preprocessor"></span>        header-&gt;DirectoryTableBase = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;DirectoryTableBase[0];
01665 <span class="preprocessor">#endif</span>
01666 <span class="preprocessor"></span>        header-&gt;PfnDataBase = <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>;
01667         header-&gt;PsLoadedModuleList = &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>;
01668         header-&gt;PsActiveProcessHead = &amp;<a class="code" href="../../d1/d9/ps_8h.html#a49">PsActiveProcessHead</a>;
01669         header-&gt;NumberProcessors = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o3">NumberProcessors</a>;
01670         header-&gt;MajorVersion = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o13">MajorVersion</a>;
01671         header-&gt;MinorVersion = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o14">MinorVersion</a>;
01672         header-&gt;KdDebuggerDataBlock = <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a3">KdGetDataBlock</a>();
01673         header-&gt;PaeEnabled = PaeEnabled ();
01674 
01675         header-&gt;MachineImageType = CURRENT_IMAGE_TYPE ();
01676 
01677         <span class="keywordflow">if</span> (!(dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a5">DCB_DUMP_ENABLED</a>)) {
01678             dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> = 1;
01679         }
01680 
01681         strcpy( header-&gt;VersionUser, dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o16">VersionUser</a> );
01682 
01683         RtlCopyMemory( &amp;block[DH_PHYSICAL_MEMORY_BLOCK],
01684                        dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>,
01685                        <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PHYSICAL_MEMORY_DESCRIPTOR</a> ) +
01686                        ((dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> - 1) *
01687                        <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a> )) );
01688 
01689         RtlCopyMemory( &amp;block[DH_CONTEXT_RECORD],
01690                        context,
01691                        <span class="keyword">sizeof</span>( CONTEXT ) );
01692 
01693         exception.ExceptionCode = STATUS_BREAKPOINT;
01694         exception.ExceptionRecord = (PEXCEPTION_RECORD) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01695         exception.NumberParameters = 0;
01696         exception.ExceptionFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a25">EXCEPTION_NONCONTINUABLE</a>;
01697         exception.ExceptionAddress = (PVOID) PROGRAM_COUNTER (context);
01698 
01699         RtlCopyMemory( &amp;block[DH_EXCEPTION_RECORD],
01700                        &amp;exception,
01701                        <span class="keyword">sizeof</span>( EXCEPTION_RECORD ) );
01702 
01703         <span class="comment">//</span>
01704         <span class="comment">// Init dump type to FULL</span>
01705         <span class="comment">//</span>
01706         
01707         block[DH_DUMP_TYPE] = DUMP_TYPE_FULL;
01708 
01709         <span class="comment">//</span>
01710         <span class="comment">// Set the timestamp</span>
01711         <span class="comment">//</span>
01712 <span class="preprocessor">#ifdef _WIN64</span>
01713 <span class="preprocessor"></span>        RtlCopyMemory( &amp;block[DH_CRASH_DUMP_TIMESTAMP],
01714                        (PCHAR)( &amp;SharedUserData-&gt;SystemLowTime),
01715                        <span class="keyword">sizeof</span>( LARGE_INTEGER) );
01716 <span class="preprocessor">#else</span>
01717 <span class="preprocessor"></span>        RtlCopyMemory( &amp;block[DH_CRASH_DUMP_TIMESTAMP],
01718                        (PCHAR)( &amp;SharedUserData-&gt;SystemTime),
01719                        <span class="keyword">sizeof</span>( LARGE_INTEGER) );
01720 <span class="preprocessor">#endif</span>
01721 <span class="preprocessor"></span>
01722         <span class="comment">//</span>
01723         <span class="comment">// Set the Required dump size in the dump header. In the case of</span>
01724         <span class="comment">// a summary dump the file allocation size can be significantly larger</span>
01725         <span class="comment">// then the amount of used space.</span>
01726         <span class="comment">//</span>
01727         
01728         RtlZeroMemory( &amp;block[DH_REQUIRED_DUMP_SPACE], <span class="keyword">sizeof</span>(LARGE_INTEGER));
01729 
01730         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a5">DCB_DUMP_ENABLED</a>) {
01731         
01732             <span class="comment">//</span>
01733             <span class="comment">// If summary dump try to create the dump header</span>
01734             <span class="comment">//</span>
01735             
01736             <span class="keywordflow">if</span> ( (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a9">DCB_SUMMARY_DUMP_ENABLED</a>) ) {
01737 
01738                 <span class="comment">//</span>
01739                 <span class="comment">// Initialize the summary dump</span>
01740                 <span class="comment">//</span>
01741 
01742                 pSummaryHeader = <a class="code" href="../../d2/d3/dumpctl_8c.html#a26">IopInitializeSummaryDump</a>(dcb);
01743 
01744                 <span class="keywordflow">if</span> ( !pSummaryHeader ) {
01745 
01746                     <span class="comment">//</span>
01747                     <span class="comment">// No summary dump header so return.</span>
01748                     <span class="comment">//</span>
01749 
01750                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1,<span class="stringliteral">"IoWriteCrashDump: Error Null summary dump header\n"</span>));
01751 
01752                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_UNSUCCESSFUL;
01753 
01754                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01755                 }
01756             }
01757 
01758             <a class="code" href="../../d2/d3/dumpctl_8c.html#a42">IopInitializeDumpSpaceAndType</a> (dcb, block, pSummaryHeader);
01759         }
01760 
01761         <span class="comment">//</span>
01762         <span class="comment">// All of the pieces of the header file have been generated.  Before</span>
01763         <span class="comment">// mapping or writing anything to the disk, the I- &amp; D-stream caches</span>
01764         <span class="comment">// must be flushed so that page color coherency is kept.  Sweep both</span>
01765         <span class="comment">// caches now.</span>
01766         <span class="comment">//</span>
01767 
01768         KeSweepCurrentDcache();
01769         KeSweepCurrentIcache();
01770 
01771         <span class="comment">//</span>
01772         <span class="comment">// Create MDL for dump.</span>
01773         <span class="comment">//</span>
01774 
01775         mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) &amp;localMdl[0];
01776         <a class="code" href="../../d5/d6/iosup_8c.html#a73">MmCreateMdl</a>( mdl, NULL, PAGE_SIZE );
01777         mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
01778 
01779         mcb = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o9">FileDescriptorArray</a>;
01780 
01781         page = <a class="code" href="../../d2/d1/mm_8h.html#a11">MmGetMdlPfnArray</a>(mdl);
01782         *page = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o12">HeaderPfn</a>;
01783         mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>;
01784 
01785         bytesRemaining = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01786         memoryAddress = (ULONG_PTR) dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o11">HeaderPage</a>;
01787 
01788         <span class="comment">//</span>
01789         <span class="comment">// All of the pieces of the header file have been generated.  Write</span>
01790         <span class="comment">// the header page to the paging file, using the appropriate drivers,</span>
01791         <span class="comment">// etc.</span>
01792         <span class="comment">//</span>
01793 
01794         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IoWriteCrashDump: Writing dump header to disk\n"</span>));
01795 
01796         <span class="keywordflow">while</span> (bytesRemaining) {
01797 
01798             <span class="keywordflow">if</span> (mcb[0].QuadPart &lt;= bytesRemaining) {
01799                 byteCount = mcb[0].LowPart;
01800             } <span class="keywordflow">else</span> {
01801                 byteCount = bytesRemaining;
01802             }
01803 
01804             mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> = byteCount;
01805             mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o7">ByteOffset</a> = (ULONG)(memoryAddress &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
01806             mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a> = (PVOID) memoryAddress;
01807             mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o5">StartVa</a> = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> ((PVOID)memoryAddress);
01808 
01809             <span class="comment">//</span>
01810             <span class="comment">// Write to disk.</span>
01811             <span class="comment">//</span>
01812 
01813             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( write( &amp;mcb[1], mdl ) )) {
01814                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_UNSUCCESSFUL;
01815                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01816             }
01817 
01818             <span class="comment">//</span>
01819             <span class="comment">// Adjust bytes remaining.</span>
01820             <span class="comment">//</span>
01821 
01822             bytesRemaining -= byteCount;
01823             memoryAddress += byteCount;
01824             mcb[0].QuadPart = mcb[0].QuadPart - byteCount;
01825             mcb[1].QuadPart = mcb[1].QuadPart + byteCount;
01826 
01827             <span class="keywordflow">if</span> (!mcb[0].QuadPart) {
01828                 mcb += 2;
01829             }
01830         }
01831 
01832         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IoWriteCrashDump: Header Page written\n"</span>));
01833 
01834 
01835         <span class="comment">//</span>
01836         <span class="comment">// If only requesting a header dump, we are now done.</span>
01837         <span class="comment">//</span>
01838         
01839         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a8">DCB_DUMP_HEADER_ENABLED</a>) {
01840             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IoWriteCrashDump: Only Dumping Dump Header\n"</span>));
01841             <span class="keywordflow">goto</span> FinishDump;
01842         }
01843 
01844         <span class="comment">//</span>
01845         <span class="comment">// The header page has been written. If this is a triage-dump, write</span>
01846         <span class="comment">// the dump information and bail. Otherwise, fall through and do the</span>
01847         <span class="comment">// full or summary dump.</span>
01848         <span class="comment">//</span>
01849 
01850         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a10">DCB_TRIAGE_DUMP_ENABLED</a>) {
01851             status = <a class="code" href="../../d2/d3/dumpctl_8c.html#a52">IopWriteTriageDump</a> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o19">TriageDumpFlags</a>,
01852                                        write,
01853                                        mcb,
01854                                        mdl,
01855                                        dwTransferSize,
01856                                        context,
01857                                        dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o20">TriageDumpBuffer</a>,
01858                                        dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o21">TriageDumpBufferSize</a> - PAGE_SIZE,
01859                                        dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o15">BuildNumber</a>,
01860                                        dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a>
01861                                        );
01862                                        
01863             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01864                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IoWriteCrashDump: Failed to write triage-dump\n"</span>));
01865                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_UNSUCCESSFUL;
01866                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01867             }
01868 
01869             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IoWriteCrashDump: Successfully wrote triage-dump\n"</span>));
01870             <span class="keywordflow">goto</span> FinishDump;
01871         }
01872 
01873         <span class="comment">//</span>
01874         <span class="comment">// The header page has been written to the paging file.  If a full dump</span>
01875         <span class="comment">// of all of physical memory is to be written, write it now.</span>
01876         <span class="comment">//</span>
01877 
01878         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a5">DCB_DUMP_ENABLED</a>) {
01879 
01880             PFN_NUMBER pagesDoneSoFar = 0;
01881             ULONG currentPercentage = 0;
01882             ULONG maximumPercentage = 0;
01883 
01884 
01885             <span class="comment">//</span>
01886             <span class="comment">// Actual Pages is the number of pages to dump.</span>
01887             <span class="comment">//</span>
01888 
01889             ActualPages = dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a>;
01890 
01891             <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a9">DCB_SUMMARY_DUMP_ENABLED</a>) {
01892 
01893                 PRTL_BITMAP PageMap;
01894 
01895                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( pSummaryHeader != NULL );
01896 
01897                 PageMap = (PRTL_BITMAP)(pSummaryHeader + 1);
01898                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PageMap != NULL);
01899 
01900                 <span class="comment">//</span>
01901                 <span class="comment">// At this point the dump header header has been sucessfully</span>
01902                 <span class="comment">// written. Write the summary dump header.</span>
01903                 <span class="comment">//</span>
01904                 
01905                 status = <a class="code" href="../../d2/d3/dumpctl_8c.html#a27">IopWriteSummaryHeader</a>(
01906                                      pSummaryHeader,
01907                                      write,
01908                                      &amp;mcb,
01909                                      mdl,
01910                                      dwTransferSize,
01911                                      (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o17">HeaderSize</a> - PAGE_SIZE)
01912                                      );
01913                                      
01914                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01915                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1,<span class="stringliteral">"IoWriteCrashDump: Error writing summary dump header\n"</span>));
01916                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = status;
01917                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01918                 }
01919 
01920                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IoWriteCrashDump: Sucessfully wrote summary dump header\n"</span>));
01921 
01922                 ActualPages = pSummaryHeader-&gt;Pages;
01923 
01924             }
01925 
01926             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IoWriteCrashDump: Writing Memory Dump\n"</span>));
01927 
01928             <span class="comment">//</span>
01929             <span class="comment">// Set the virtual file offset and initialize loop variables and</span>
01930             <span class="comment">// constants.</span>
01931             <span class="comment">//</span>
01932 
01933             memoryAddress = (ULONG_PTR)dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[0].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01934 
01935             <span class="keywordflow">if</span> ( dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a9">DCB_SUMMARY_DUMP_ENABLED</a> ) {
01936 
01937                 PRTL_BITMAP <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
01938                 
01939                 <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = (PRTL_BITMAP)(pSummaryHeader+1);
01940 
01941                 status = <a class="code" href="../../d2/d3/dumpctl_8c.html#a54">IopWriteSummaryDump</a> (
01942                                         BitMap,
01943                                         write,
01944                                         &amp;dumpStack-&gt;ProgMsg,
01945                                         messageBuffer,
01946                                         mcb,
01947                                         dwTransferSize
01948                                         );
01949 
01950                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
01951                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IoWriteCrashDump: Failed to write triage-dump\n"</span>));
01952                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_UNSUCCESSFUL;
01953                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01954                 }
01955 
01956                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((1, <span class="stringliteral">"IoWriteCrashDump: Successfully wrote triage-dump\n"</span>));
01957                 <span class="keywordflow">goto</span> FinishDump;
01958             }
01959 
01960             <span class="comment">//</span>
01961             <span class="comment">// Now loop, writing all of physical memory to the paging file.</span>
01962             <span class="comment">//</span>
01963 
01964             <span class="keywordflow">while</span> (mcb[0].QuadPart) {
01965 
01966                 diskByteOffset = mcb[1];
01967 
01968                 <span class="comment">//</span>
01969                 <span class="comment">// Calculate byte offset;</span>
01970                 <span class="comment">//</span>
01971 
01972                 byteOffset = (ULONG)(memoryAddress &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
01973 
01974                 <span class="keywordflow">if</span> (dwTransferSize &lt;= mcb[0].QuadPart) {
01975                     byteCount = dwTransferSize - byteOffset;
01976                 } <span class="keywordflow">else</span> {
01977                     byteCount = mcb[0].LowPart;
01978                 }
01979                 pagesDoneSoFar += byteCount / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01980 
01981                 currentPercentage = (ULONG)((pagesDoneSoFar * 100) /
01982                                     ActualPages);
01983 
01984                 <span class="keywordflow">if</span> (currentPercentage &gt; maximumPercentage) {
01985 
01986                     maximumPercentage = currentPercentage;
01987                     <span class="comment">//</span>
01988                     <span class="comment">// Update message on screen.</span>
01989                     <span class="comment">//</span>
01990 
01991                     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( messageBuffer, <span class="stringliteral">"%Z: %3d\r"</span>, &amp;dumpStack-&gt;ProgMsg, maximumPercentage );
01992                     <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a>( messageBuffer );
01993 
01994                 }
01995 
01996                 <span class="comment">//</span>
01997                 <span class="comment">// Map the physical memory and write it to the</span>
01998                 <span class="comment">// current segment of the file.</span>
01999                 <span class="comment">//</span>
02000 
02001                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a23">IopMapPhysicalMemory</a>( mdl,
02002                                    memoryAddress,
02003                                    &amp;dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o7">MemoryDescriptor</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[0],
02004                                    byteCount
02005                                    );
02006 
02007 
02008                 <span class="comment">//</span>
02009                 <span class="comment">// Write the next segment.</span>
02010                 <span class="comment">//</span>
02011 
02012                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( write( &amp;diskByteOffset, mdl ) )) {
02013                     <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_UNSUCCESSFUL;
02014                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02015                 }
02016 
02017                 <span class="comment">//</span>
02018                 <span class="comment">// Adjust pointers for next part.</span>
02019                 <span class="comment">//</span>
02020 
02021                 memoryAddress += byteCount;
02022                 mcb[0].QuadPart = mcb[0].QuadPart - byteCount;
02023                 mcb[1].QuadPart = mcb[1].QuadPart + byteCount;
02024 
02025                 <span class="keywordflow">if</span> (!mcb[0].QuadPart) {
02026                     mcb += 2;
02027                 }
02028 
02029                 <span class="keywordflow">if</span> (pagesDoneSoFar &gt;= ActualPages) {
02030                     <span class="keywordflow">break</span>;
02031 
02032                 }
02033 
02034             }
02035 
02036             <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a>((2,<span class="stringliteral">"IoWriteCrashDump: memory dump written\n"</span>));
02037         }
02038         
02039 FinishDump:
02040 
02041         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>( messageBuffer, <span class="stringliteral">"%Z"</span>, &amp;dumpStack-&gt;DoneMsg );
02042         <a class="code" href="../../d0/d1/inbv_8h.html#a9">InbvDisplayString</a>( messageBuffer );
02043 
02044         <span class="comment">//</span>
02045         <span class="comment">// Sweep the cache so the debugger will work.</span>
02046         <span class="comment">//</span>
02047 
02048         KeSweepCurrentDcache();
02049         KeSweepCurrentIcache();
02050 
02051         <span class="comment">//</span>
02052         <span class="comment">// Have the dump flush the adapter and disk caches.</span>
02053         <span class="comment">//</span>
02054 
02055         finishUp();
02056 
02057         <span class="comment">//</span>
02058         <span class="comment">// Indicate to the debugger that the dump has been successfully</span>
02059         <span class="comment">// written.</span>
02060         <span class="comment">//</span>
02061 
02062         <a class="code" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = STATUS_SUCCESS;
02063     }
02064 
02065     <span class="comment">//</span>
02066     <span class="comment">// Check to see whether or not auto-reboots are enabled and, if so,</span>
02067     <span class="comment">// reboot now.</span>
02068     <span class="comment">//</span>
02069 
02070     <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="../../d1/d1/struct__DUMP__CONTROL__BLOCK.html#o1">Flags</a> &amp; <a class="code" href="../../d0/d6/iop_8h.html#a7">DCB_AUTO_REBOOT</a>) {
02071         <a class="code" href="../../d2/d3/dumpctl_8c.html#a10">IoDebugPrint</a> (( 0,  <span class="stringliteral">"IODUMP: Autorebooting\n"</span> ));
02072         <a class="code" href="../../d9/d4/ke_2debug_8c.html#a13">KeReturnToFirmware</a>( HalRebootRoutine );
02073     }
02074 
02075     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02076 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a18" doxytag="dumpctl.c::IopCrashDumpStateChange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d3/dumpctl_8c.html#a18">IopCrashDumpStateChange</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00079">79</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04325">IoSetCrashDumpState()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="dumpctl.c::IopDumpFileContainsNewDump" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d2/d3/dumpctl_8c.html#a19">IopDumpFileContainsNewDump</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00080">80</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="dumpctl.c::IopFinalCrashDumpStatus" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS <a class="el" href="../../d2/d3/dumpctl_8c.html#a17">IopFinalCrashDumpStatus</a> = -1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00078">78</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="dumpctl.c::MmHighestPossiblePhysicalPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_NUMBER <a class="el" href="../../d0/d9/miglobal_8c.html#a9">MmHighestPossiblePhysicalPage</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00076">76</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/physical_8c-source.html#l02313">MiCleanPhysicalProcessPages()</a>, <a class="el" href="../../d3/d0/inialpha_8c-source.html#l00041">MiInitMachineDependent()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00043">MmAddPhysicalMemory()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l08083">MmSetKernelDumpRange()</a>, and <a class="el" href="../../d9/d4/physical_8c-source.html#l00970">NtAllocateUserPhysicalPages()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="dumpctl.c::MmPfnDatabase" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d0/d9/miglobal_8c.html#a25">MmPfnDatabase</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00075">75</a> of file <a class="el" href="../../d3/d2/dumpctl_8c-source.html">dumpctl.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01095">MiCheckForCrashDump()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l01778">MiFreePoolPages()</a>, <a class="el" href="../../d3/d0/inialpha_8c-source.html#l00041">MiInitMachineDependent()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l01109">MiRemovePhysicalPages()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00821">MiUnlinkFreeOrZeroedPage()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00043">MmAddPhysicalMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l08083">MmSetKernelDumpRange()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:30 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
