<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: udfs/devctrl.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>devctrl.c File Reference</h1><code>#include "UdfProcs.h"</code><br>

<p>
<a href="../../d3/d6/udfs_2devctrl_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/udfs_2devctrl_8c.html#a0">BugCheckFileId</a>&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_DEVCTRL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/udfs_2devctrl_8c.html#a1">Dbg</a>&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_DEVCTRL)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/udfs_2devctrl_8c.html#a2">UdfDvdReadStructure</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/udfs_2devctrl_8c.html#a3">UdfDvdTransferKey</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/udfs_2devctrl_8c.html#a4">UdfDevCtrlCompletionRoutine</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID Contxt)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/udfs_2devctrl_8c.html#a5">UdfCommonDevControl</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="udfs/devctrl.c::BugCheckFileId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BugCheckFileId&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_DEVCTRL)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00028">28</a> of file <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html">udfs/devctrl.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="udfs/devctrl.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_DEVCTRL)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00034">34</a> of file <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html">udfs/devctrl.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a5" doxytag="udfs/devctrl.c::UdfCommonDevControl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonDevControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00069">69</a> of file <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html">udfs/devctrl.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04009">IoCopyCurrentIrpStackLocationToNext</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03913">IoSetCompletionRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00451">UdfDevCtrlCompletionRoutine()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00337">UdfDvdReadStructure()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00227">UdfDvdTransferKey()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00603">UdfVerifyVcb()</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00941">_FCB::Vcb</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00076                    :
00077 
00078     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common routine <span class="keywordflow">for</span> doing Device <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> operations called
00079     by both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fsd and fsp threads
00080 
00081 Arguments:
00082 
00083     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00084 
00085 Return Value:
00086 
00087     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00088 
00089 --*/
00090 
00091 {
00092     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00093 
00094     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00095     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00096     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00097 
00098     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00099 
00100     PVOID TargetBuffer;
00101 
00102     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00103 
00104     <span class="comment">//</span>
00105     <span class="comment">//  Extract and decode the file object.</span>
00106     <span class="comment">//</span>
00107 
00108     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00109 
00110     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
00111                                       &amp;Fcb,
00112                                       &amp;Ccb );
00113 
00114     <span class="comment">//</span>
00115     <span class="comment">//  A few IOCTLs actually require some intervention on our part to</span>
00116     <span class="comment">//  translate some information from file-based to device-based units.</span>
00117     <span class="comment">//</span>
00118 
00119     <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
00120 
00121         <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.IoControlCode) {
00122             <span class="keywordflow">case</span> IOCTL_DVD_READ_KEY:
00123             <span class="keywordflow">case</span> IOCTL_DVD_SEND_KEY:
00124 
00125                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a3">UdfDvdTransferKey</a>( IrpContext, Irp, Fcb );
00126                 <span class="keywordflow">break</span>;
00127 
00128             <span class="keywordflow">case</span> IOCTL_DVD_READ_STRUCTURE:
00129 
00130                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a2">UdfDvdReadStructure</a>( IrpContext, Irp, Fcb );
00131                 <span class="keywordflow">break</span>;
00132 
00133             <span class="keywordflow">case</span> IOCTL_STORAGE_SET_READ_AHEAD:
00134 
00135                 <span class="comment">//</span>
00136                 <span class="comment">//  We're just going to no-op this for now.</span>
00137                 <span class="comment">//</span>
00138                 
00139                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00140                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00141                 <span class="keywordflow">break</span>;
00142 
00143             <span class="keywordflow">default</span>:
00144 
00145                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00146                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00147                 <span class="keywordflow">break</span>;
00148         }
00149 
00150         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00151     }
00152 
00153     <span class="comment">//</span>
00154     <span class="comment">//  Now the only type of opens we accept are user volume opens.</span>
00155     <span class="comment">//</span>
00156 
00157     <span class="keywordflow">if</span> (TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>) {
00158 
00159         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_INVALID_PARAMETER );
00160         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00161     }
00162 
00163     <span class="comment">//</span>
00164     <span class="comment">//  Handle the case of the disk type ourselves.  We're really just going to</span>
00165     <span class="comment">//  lie about this, but it is a good lie.</span>
00166     <span class="comment">//</span>
00167 
00168     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.IoControlCode == IOCTL_CDROM_DISK_TYPE) {
00169 
00170         <span class="comment">//</span>
00171         <span class="comment">//  Verify the Vcb in this case to detect if the volume has changed.</span>
00172         <span class="comment">//</span>
00173 
00174         <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a5">UdfVerifyVcb</a>( IrpContext, Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a> );
00175 
00176         <span class="comment">//</span>
00177         <span class="comment">//  Check the size of the output buffer.</span>
00178         <span class="comment">//</span>
00179 
00180         <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.OutputBufferLength &lt; <span class="keyword">sizeof</span>( CDROM_DISK_DATA )) {
00181 
00182             <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_BUFFER_TOO_SMALL );
00183             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00184         }
00185 
00186         <span class="comment">//</span>
00187         <span class="comment">//  Copy the data from the Vcb.</span>
00188         <span class="comment">//</span>
00189 
00190         ((PCDROM_DISK_DATA) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer)-&gt;DiskData = CDROM_DISK_DATA_TRACK;
00191 
00192         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = <span class="keyword">sizeof</span>( CDROM_DISK_DATA );
00193         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_SUCCESS );
00194         <span class="keywordflow">return</span> STATUS_SUCCESS;
00195     }
00196 
00197     <span class="comment">//</span>
00198     <span class="comment">//  Copy the arguments and set up the completion routine</span>
00199     <span class="comment">//</span>
00200 
00201     <a class="code" href="../../d0/d5/io_8h.html#a239">IoCopyCurrentIrpStackLocationToNext</a>( Irp );
00202     
00203     <a class="code" href="../../d0/d5/io_8h.html#a237">IoSetCompletionRoutine</a>( Irp,
00204                             UdfDevCtrlCompletionRoutine,
00205                             NULL,
00206                             TRUE,
00207                             TRUE,
00208                             TRUE );
00209 
00210     <span class="comment">//</span>
00211     <span class="comment">//  Send the request.</span>
00212     <span class="comment">//</span>
00213 
00214     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( IrpContext-&gt;Vcb-&gt;TargetDeviceObject, Irp );
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">//  Cleanup our Irp Context.  The driver has completed the Irp.</span>
00218     <span class="comment">//</span>
00219 
00220     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, NULL, STATUS_SUCCESS );
00221 
00222     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00223 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="udfs/devctrl.c::UdfDevCtrlCompletionRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfDevCtrlCompletionRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Contxt</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00451">451</a> of file <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html">udfs/devctrl.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01648">_IRP::PendingReturned</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00069">UdfCommonDevControl()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00337">UdfDvdReadStructure()</a>, and <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00227">UdfDvdTransferKey()</a>.
<p>
<pre class="fragment"><div>00457 {
00458     <span class="comment">//</span>
00459     <span class="comment">//  Add the hack-o-ramma to fix formats.</span>
00460     <span class="comment">//</span>
00461 
00462     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a>) {
00463 
00464         <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( Irp );
00465     }
00466 
00467     <span class="keywordflow">return</span> STATUS_SUCCESS;
00468 
00469     UNREFERENCED_PARAMETER( DeviceObject );
00470     UNREFERENCED_PARAMETER( Contxt );
00471 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="udfs/devctrl.c::UdfDvdReadStructure" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfDvdReadStructure           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00337">337</a> of file <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html">udfs/devctrl.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04009">IoCopyCurrentIrpStackLocationToNext</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03913">IoSetCompletionRoutine</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00220">LlBytesFromSectors</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00224">LlSectorsFromBytes</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, and <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00451">UdfDevCtrlCompletionRoutine()</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00069">UdfCommonDevControl()</a>.
<p>
<pre class="fragment"><div>00346                    :
00347 
00348     This routine handles <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> special form of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Dvd structure reading IOCTLs
00349     performed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  For these IOCTLs, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> incoming parameter
00350     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>-relative form, which must be translated to a device-relatvie form
00351     before <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can <span class="keywordflow">continue</span>.
00352 
00353 Arguments:
00354 
00355     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00356     
00357     Fcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> being operated with
00358 
00359 Return Value:
00360 
00361     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00362 
00363 --*/
00364 
00365 {
00366     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00367     PDVD_READ_STRUCTURE ReadStructure;
00368 
00369     LARGE_INTEGER <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00370     BOOLEAN Result;
00371 
00372     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00373     
00374     <span class="comment">//</span>
00375     <span class="comment">//  Grab the input buffer and confirm basic validity.</span>
00376     <span class="comment">//</span>
00377     
00378     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00379     ReadStructure = (PDVD_READ_STRUCTURE) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
00380 
00381     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.InputBufferLength != <span class="keyword">sizeof</span>(DVD_READ_STRUCTURE)) {
00382 
00383         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00384         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00385     }
00386 
00387     <span class="comment">//</span>
00388     <span class="comment">//  Now, convert the file byte offset in the structure to a physical sector.</span>
00389     <span class="comment">//</span>
00390 
00391     Result = <a class="code" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry</a>( &amp;Fcb-&gt;Mcb,
00392                                        <a class="code" href="../../d3/d8/udfprocs_8h.html#a40">LlSectorsFromBytes</a>( Fcb-&gt;Vcb, ReadStructure-&gt;BlockByteOffset.QuadPart ),
00393                                        &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart,
00394                                        NULL,
00395                                        NULL,
00396                                        NULL,
00397                                        NULL );
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">//  If we failed the lookup, we know that this must be some form of unrecorded</span>
00401     <span class="comment">//  extent on the media.  This IOCTL is ill-defined at this point, so we have</span>
00402     <span class="comment">//  to give up.</span>
00403     <span class="comment">//</span>
00404     
00405     <span class="keywordflow">if</span> (!Result || <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart == -1) {
00406         
00407         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00408         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00409     }
00410     
00411     <span class="comment">//</span>
00412     <span class="comment">//  The input is buffered from user space, so we know we can just rewrite it.</span>
00413     <span class="comment">//</span>
00414 
00415     ReadStructure-&gt;BlockByteOffset.QuadPart = <a class="code" href="../../d3/d8/udfprocs_8h.html#a39">LlBytesFromSectors</a>( Fcb-&gt;Vcb, <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart );
00416 
00417     <span class="comment">//</span>
00418     <span class="comment">//  Copy the arguments and set up the completion routine</span>
00419     <span class="comment">//</span>
00420 
00421     <a class="code" href="../../d0/d5/io_8h.html#a239">IoCopyCurrentIrpStackLocationToNext</a>( Irp );
00422 
00423     <a class="code" href="../../d0/d5/io_8h.html#a237">IoSetCompletionRoutine</a>( Irp,
00424                             UdfDevCtrlCompletionRoutine,
00425                             NULL,
00426                             TRUE,
00427                             TRUE,
00428                             TRUE );
00429 
00430     <span class="comment">//</span>
00431     <span class="comment">//  Send the request.</span>
00432     <span class="comment">//</span>
00433 
00434     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( IrpContext-&gt;Vcb-&gt;TargetDeviceObject, Irp );
00435 
00436     <span class="comment">//</span>
00437     <span class="comment">//  Cleanup our Irp Context.  The driver has completed the Irp.</span>
00438     <span class="comment">//</span>
00439 
00440     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, NULL, STATUS_SUCCESS );
00441 
00442     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00443 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="udfs/devctrl.c::UdfDvdTransferKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfDvdTransferKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00227">227</a> of file <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html">udfs/devctrl.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04009">IoCopyCurrentIrpStackLocationToNext</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03913">IoSetCompletionRoutine</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00220">LlBytesFromSectors</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00224">LlSectorsFromBytes</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, and <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00451">UdfDevCtrlCompletionRoutine()</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00069">UdfCommonDevControl()</a>.
<p>
<pre class="fragment"><div>00235                    :
00236 
00237     This routine handles <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> special form of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Dvd key negotiation IOCTLs
00238     performed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  For these IOCTLs, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> incoming parameter
00239     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>-relative form, which must be translated to a device-relatvie form
00240     before <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can <span class="keywordflow">continue</span>.
00241 
00242 Arguments:
00243 
00244     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00245     
00246     Fcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> being operated with
00247 
00248 Return Value:
00249 
00250     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00251 
00252 --*/
00253 
00254 {
00255     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00256     PDVD_COPY_PROTECT_KEY TransferKey;
00257 
00258     LARGE_INTEGER <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00259     BOOLEAN Result;
00260 
00261     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">//  Grab the input buffer and confirm basic validity.</span>
00265     <span class="comment">//</span>
00266     
00267     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00268     TransferKey = (PDVD_COPY_PROTECT_KEY) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
00269 
00270     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.InputBufferLength &lt; <span class="keyword">sizeof</span>(DVD_COPY_PROTECT_KEY) ||
00271         TransferKey-&gt;Parameters.TitleOffset.QuadPart &gt; Fcb-&gt;FileSize.QuadPart) {
00272 
00273         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00274         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00275     }
00276 
00277     <span class="comment">//</span>
00278     <span class="comment">//  Now, convert the file byte offset in the structure to a physical sector.</span>
00279     <span class="comment">//</span>
00280 
00281     Result = <a class="code" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry</a>( &amp;Fcb-&gt;Mcb,
00282                                        <a class="code" href="../../d3/d8/udfprocs_8h.html#a40">LlSectorsFromBytes</a>( Fcb-&gt;Vcb, TransferKey-&gt;Parameters.TitleOffset.QuadPart ),
00283                                        &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart,
00284                                        NULL,
00285                                        NULL,
00286                                        NULL,
00287                                        NULL );
00288 
00289     <span class="comment">//</span>
00290     <span class="comment">//  If we failed the lookup, we know that this must be some form of unrecorded</span>
00291     <span class="comment">//  extent on the media.  This IOCTL is ill-defined at this point, so we have</span>
00292     <span class="comment">//  to give up.</span>
00293     <span class="comment">//</span>
00294     
00295     <span class="keywordflow">if</span> (!Result || <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart == -1) {
00296         
00297         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00298         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00299     }
00300     
00301     <span class="comment">//</span>
00302     <span class="comment">//  The input is buffered from user space, so we know we can just rewrite it.</span>
00303     <span class="comment">//</span>
00304 
00305     TransferKey-&gt;Parameters.TitleOffset.QuadPart = <a class="code" href="../../d3/d8/udfprocs_8h.html#a39">LlBytesFromSectors</a>( Fcb-&gt;Vcb, <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart );
00306 
00307     <span class="comment">//</span>
00308     <span class="comment">//  Copy the arguments and set up the completion routine</span>
00309     <span class="comment">//</span>
00310 
00311     <a class="code" href="../../d0/d5/io_8h.html#a239">IoCopyCurrentIrpStackLocationToNext</a>( Irp );
00312 
00313     <a class="code" href="../../d0/d5/io_8h.html#a237">IoSetCompletionRoutine</a>( Irp,
00314                             UdfDevCtrlCompletionRoutine,
00315                             NULL,
00316                             TRUE,
00317                             TRUE,
00318                             TRUE );
00319 
00320     <span class="comment">//</span>
00321     <span class="comment">//  Send the request.</span>
00322     <span class="comment">//</span>
00323 
00324     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( IrpContext-&gt;Vcb-&gt;TargetDeviceObject, Irp );
00325 
00326     <span class="comment">//</span>
00327     <span class="comment">//  Cleanup our Irp Context.  The driver has completed the Irp.</span>
00328     <span class="comment">//</span>
00329 
00330     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, NULL, STATUS_SUCCESS );
00331 
00332     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00333 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
