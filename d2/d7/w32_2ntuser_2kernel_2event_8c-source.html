<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: event.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>event.c</h1><a href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: event.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* DDE Manager event module - this is a fancy way of allowing interprocess</span>
00007 <span class="comment">*   communication across security contexts.  This is needed because the</span>
00008 <span class="comment">*   DDE Access Object security may be different than hwnd security so</span>
00009 <span class="comment">*   straight messages arn't good enough.</span>
00010 <span class="comment">*</span>
00011 <span class="comment">* Created: 8/27/91 Sanford Staab</span>
00012 <span class="comment">*</span>
00013 <span class="comment">\***************************************************************************/</span>
00014 
00015 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00016 <span class="preprocessor">#pragma hdrstop</span>
00017 <span class="preprocessor"></span>
00018 
<a name="l00019"></a><a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a4">00019</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a2">MonitorFlags</a> = 0;     <span class="comment">// current filter flags being monitored by someone.</span>
00020 
<a name="l00021"></a><a class="code" href="../../d1/d2/structtagMONITOR__COUNT.html">00021</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d2/structtagMONITOR__COUNT.html">tagMONITOR_COUNT</a> {
<a name="l00022"></a><a class="code" href="../../d1/d2/structtagMONITOR__COUNT.html#o0">00022</a>     <span class="keywordtype">int</span> <a class="code" href="../../d1/d2/structtagMONITOR__COUNT.html#o0">iCount</a>;
<a name="l00023"></a><a class="code" href="../../d1/d2/structtagMONITOR__COUNT.html#o1">00023</a>     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d1/d2/structtagMONITOR__COUNT.html#o1">flag</a>;
00024 } <a class="code" href="../../d1/d2/structtagMONITOR__COUNT.html">MONITOR_COUNT</a>, *<a class="code" href="../../d1/d2/structtagMONITOR__COUNT.html">PMONITOR_COUNT</a>;
00025 
<a name="l00026"></a><a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a0">00026</a> <span class="preprocessor">#define C_MONITOR_COUNT 10</span>
00027 <span class="preprocessor"></span>
<a name="l00028"></a><a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a7">00028</a> <a class="code" href="../../d1/d2/structtagMONITOR__COUNT.html">MONITOR_COUNT</a> <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a7">aMonitorCount</a>[<a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a0">C_MONITOR_COUNT</a>] = {
00029     { 0, MF_HSZ_INFO },
00030     { 0, MF_SENDMSGS },
00031     { 0, MF_POSTMSGS },
00032     { 0, MF_CALLBACKS },
00033     { 0, MF_ERRORS },
00034     { 0, MF_LINKS },
00035     { 0, MF_CONV },
00036     { 0, CBF_SKIP_REGISTRATIONS },
00037     { 0, CBF_SKIP_UNREGISTRATIONS },
00038     { 0, <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a0">MF_INTERNAL</a> },
00039 };
00040 
<a name="l00041"></a><a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a1">00041</a> <span class="preprocessor">#define MONITORED_FLAGS \</span>
00042 <span class="preprocessor">    MF_HSZ_INFO |   \</span>
00043 <span class="preprocessor">    MF_SENDMSGS |   \</span>
00044 <span class="preprocessor">    MF_POSTMSGS |   \</span>
00045 <span class="preprocessor">    MF_CALLBACKS |   \</span>
00046 <span class="preprocessor">    MF_ERRORS |   \</span>
00047 <span class="preprocessor">    MF_LINKS |   \</span>
00048 <span class="preprocessor">    MF_CONV |   \</span>
00049 <span class="preprocessor">    CBF_SKIP_REGISTRATIONS |   \</span>
00050 <span class="preprocessor">    CBF_SKIP_UNREGISTRATIONS |   \</span>
00051 <span class="preprocessor">    MF_INTERNAL</span>
00052 <span class="preprocessor"></span>
00053 
00054 <span class="comment">/***************************************************************************\</span>
00055 <span class="comment">* ChangeMonitorFlags</span>
00056 <span class="comment">*</span>
00057 <span class="comment">* Description:</span>
00058 <span class="comment">*   Updates the global MonitorFlags variable to reflect the union of all</span>
00059 <span class="comment">*   event types being monitored by DDEML applications.</span>
00060 <span class="comment">*</span>
00061 <span class="comment">* History:</span>
00062 <span class="comment">* 11-26-91   sanfords    Created.</span>
00063 <span class="comment">\***************************************************************************/</span>
<a name="l00064"></a><a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a8">00064</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a8">xxxChangeMonitorFlags</a>(
00065 <a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html">PSVR_INSTANCE_INFO</a> psii,
00066 DWORD afCmdNew)
00067 {
00068     <span class="keywordtype">int</span> i;
00069     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwChangedFlags;
00070     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> OldMonitorFlags;
00071 
00072     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00073 
00074     dwChangedFlags = psii-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o3">afCmd</a> ^ afCmdNew;
00075     <span class="keywordflow">if</span> (!(dwChangedFlags &amp; <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a1">MONITORED_FLAGS</a>)) {
00076         <span class="keywordflow">return</span>;
00077     }
00078     psii-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o3">afCmd</a> = afCmdNew;
00079 
00080     OldMonitorFlags = <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a2">MonitorFlags</a>;
00081     <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a2">MonitorFlags</a> = 0;
00082     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a0">C_MONITOR_COUNT</a>; i++) {
00083         <span class="keywordflow">if</span> (dwChangedFlags &amp; <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a7">aMonitorCount</a>[i].<a class="code" href="../../d1/d2/structtagMONITOR__COUNT.html#o1">flag</a>) {
00084             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a7">aMonitorCount</a>[i].<a class="code" href="../../d1/d2/structtagMONITOR__COUNT.html#o1">flag</a> &amp; afCmdNew) {
00085                 <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a7">aMonitorCount</a>[i].<a class="code" href="../../d1/d2/structtagMONITOR__COUNT.html#o0">iCount</a>++;
00086             } <span class="keywordflow">else</span> {
00087                 <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a7">aMonitorCount</a>[i].<a class="code" href="../../d1/d2/structtagMONITOR__COUNT.html#o0">iCount</a>--;
00088             }
00089         }
00090         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a7">aMonitorCount</a>[i].<a class="code" href="../../d1/d2/structtagMONITOR__COUNT.html#o0">iCount</a>) {
00091             <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a2">MonitorFlags</a> |= <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a7">aMonitorCount</a>[i].<a class="code" href="../../d1/d2/structtagMONITOR__COUNT.html#o1">flag</a>;
00092         }
00093     }
00094     <span class="keywordflow">if</span> (OldMonitorFlags != <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a2">MonitorFlags</a>) {
00095         <a class="code" href="../../d7/d4/structtagEVENT__PACKET.html">EVENT_PACKET</a> ep;
00096 
00097         ep.<a class="code" href="../../d7/d4/structtagEVENT__PACKET.html#o0">EventType</a> = 0;
00098         ep.<a class="code" href="../../d7/d4/structtagEVENT__PACKET.html#o1">fSense</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00099         ep.<a class="code" href="../../d7/d4/structtagEVENT__PACKET.html#o2">cbEventData</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00100         ep.<a class="code" href="../../d7/d4/structtagEVENT__PACKET.html#o3">Data</a> = <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a2">MonitorFlags</a>;
00101         <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a9">xxxCsEvent</a>(&amp;ep, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>));
00102     }
00103 }
00104 
00105 
00106 
00107 <span class="comment">/***************************************************************************\</span>
00108 <span class="comment">* xxxCsEvent</span>
00109 <span class="comment">*</span>
00110 <span class="comment">* Description:</span>
00111 <span class="comment">*   Handles broadcasting of all types of DDEML events.</span>
00112 <span class="comment">*</span>
00113 <span class="comment">* History:</span>
00114 <span class="comment">* 11-1-91   sanfords    Created.</span>
00115 <span class="comment">* 10-28-97  FritzS    added cbEventData as a passed-in parameter.  This was</span>
00116 <span class="comment">                      done because the EVENT_PACKET may be client-side and</span>
00117 <span class="comment">                      we capture the count to keep a hostile app from changing</span>
00118 <span class="comment">                      the size after data probing.</span>
00119 <span class="comment">\***************************************************************************/</span>
<a name="l00120"></a><a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a9">00120</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a9">xxxCsEvent</a>(
00121 <a class="code" href="../../d7/d4/structtagEVENT__PACKET.html">PEVENT_PACKET</a> pep, WORD cbEventData)
00122 {
00123     <a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html">PSVR_INSTANCE_INFO</a> psiiT;
00124     <a class="code" href="../../d7/d4/structtagEVENT__PACKET.html">PEVENT_PACKET</a> pep2;
00125     HWND *ahwndEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00126     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00127     <span class="keywordtype">int</span> cHwndAllocated, i, cTargets;
00128     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00129     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpep2;
00130     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlahwndEvent;
00131     ULONG cbEventPacket;
00132     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00133 
00134     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00135 
00136     <span class="comment">/*</span>
00137 <span class="comment">     * Copy pep info to a server side stable area</span>
00138 <span class="comment">     */</span>
00139     cbEventPacket = cbEventData + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/structtagEVENT__PACKET.html">EVENT_PACKET</a>) - <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00140     pep2 = (<a class="code" href="../../d7/d4/structtagEVENT__PACKET.html">PEVENT_PACKET</a>)UserAllocPoolWithQuota(cbEventPacket, TAG_DDE5);
00141     <span class="keywordflow">if</span> (pep2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00142         <span class="keywordflow">return</span> DMLERR_MEMORY_ERROR;
00143     }
00144     <span class="keywordflow">try</span> {
00145         RtlCopyMemory((LPSTR)pep2, (LPSTR)<a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>, cbEventPacket);
00146     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00147         UserFreePool(pep2);
00148         <span class="keywordflow">return</span> DMLERR_INVALIDPARAMETER;
00149     }
00150 
00151     pep2-&gt;<a class="code" href="../../d7/d4/structtagEVENT__PACKET.html#o2">cbEventData</a> = cbEventData;
00152     cTargets = 0;
00153     cHwndAllocated = 0;
00154 
00155     <span class="keywordflow">for</span> (psiiT = <a class="code" href="../../d1/d4/ddemlsvr_8c.html#a0">psiiList</a>; psiiT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; psiiT =  psiiT-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o1">next</a>) {
00156         <span class="comment">//</span>
00157         <span class="comment">// Don't bother with event windows for instances who's flags</span>
00158         <span class="comment">// indicate they're not interrested in the event.</span>
00159         <span class="comment">//</span>
00160         <span class="keywordflow">if</span> (((psiiT-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o3">afCmd</a> &amp; pep2-&gt;<a class="code" href="../../d7/d4/structtagEVENT__PACKET.html#o0">EventType</a>) &amp;&amp; !pep2-&gt;<a class="code" href="../../d7/d4/structtagEVENT__PACKET.html#o1">fSense</a>) ||
00161                 (!(psiiT-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o3">afCmd</a> &amp; pep2-&gt;<a class="code" href="../../d7/d4/structtagEVENT__PACKET.html#o0">EventType</a>) &amp;&amp; pep2-&gt;<a class="code" href="../../d7/d4/structtagEVENT__PACKET.html#o1">fSense</a>)) {
00162             <span class="keywordflow">continue</span>;
00163         }
00164 
00165         <span class="keywordflow">if</span> (cTargets &gt;= cHwndAllocated) {
00166             <span class="keywordflow">if</span> (ahwndEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00167                 cHwndAllocated = 8;
00168                 ahwndEvent = (HWND *)UserAllocPoolWithQuota(
00169                         <span class="keyword">sizeof</span>(HWND) * cHwndAllocated,
00170                         TAG_DDE6);
00171             } <span class="keywordflow">else</span> {
00172                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize = cHwndAllocated * <span class="keyword">sizeof</span>(HWND);
00173                 HWND *ahwndEventT = ahwndEvent;
00174 
00175                 cHwndAllocated += 8;
00176                 ahwndEvent = (HWND *)UserReAllocPoolWithQuota(ahwndEvent, dwSize,
00177                         <span class="keyword">sizeof</span>(HWND) * cHwndAllocated, TAG_DDE7);
00178                 <span class="keywordflow">if</span> (ahwndEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00179                     UserFreePool(ahwndEventT);
00180                 }
00181             }
00182             <span class="keywordflow">if</span> (ahwndEvent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00183                 UserFreePool(pep2);
00184                 <span class="keywordflow">return</span> DMLERR_MEMORY_ERROR;
00185             }
00186         }
00187         ahwndEvent[cTargets++] = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(psiiT-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o4">spwndEvent</a>);
00188     }
00189 
00190     <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(pti, pep2, &amp;tlpep2);
00191     <span class="keywordflow">if</span> (ahwndEvent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00192         <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(pti, ahwndEvent, &amp;tlahwndEvent);
00193         <span class="keywordflow">for</span> (i = 0; i &lt; cTargets; i++) {
00194             <span class="comment">/*</span>
00195 <span class="comment">             * We need to change contexts for the callback</span>
00196 <span class="comment">             */</span>
00197             pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(ahwndEvent[i]);
00198             <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00199                 <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(pti, pwnd, &amp;tlpwnd);
00200                 <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_DDEMLEVENT, 0, (LPARAM)pep2);
00201                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00202             }
00203         }
00204         <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(pti, &amp;tlahwndEvent);
00205     }
00206     <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(pti, &amp;tlpep2);
00207 
00208     <span class="keywordflow">return</span> DMLERR_NO_ERROR;
00209 }
00210 
00211 
00212 
00213 
00214 <span class="comment">/***************************************************************************\</span>
00215 <span class="comment">* xxxEventWndProc</span>
00216 <span class="comment">*</span>
00217 <span class="comment">* Description:</span>
00218 <span class="comment">*   Window proc for DDEML event windows.  These windows serve to get user</span>
00219 <span class="comment">*   into the proper context for callbacks to DDEML applications.</span>
00220 <span class="comment">*</span>
00221 <span class="comment">* History:</span>
00222 <span class="comment">* 11-1-91   sanfords    Created.</span>
00223 <span class="comment">\***************************************************************************/</span>
<a name="l00224"></a><a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a10">00224</a> LRESULT <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a10">xxxEventWndProc</a>(
00225 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00226 UINT message,
00227 WPARAM wParam,
00228 LPARAM lParam)
00229 {
00230     <a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html">PSVR_INSTANCE_INFO</a> psii;
00231 
00232     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00233     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00234 
00235     psii = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>((HANDLE)<a class="code" href="../../d6/d0/usercli_8h.html#a165">_GetWindowLongPtr</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a161">GWLP_PSII</a>),
00236                                  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a245">TYPE_DDEACCESS</a>);
00237     <span class="keywordflow">if</span> (psii == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00238         <span class="keywordflow">goto</span> CallDWP;
00239     }
00240 
00241     <span class="keywordflow">switch</span> (message) {
00242     <span class="keywordflow">case</span> WM_DDEMLEVENT:
00243 <span class="preprocessor">#define pep ((PEVENT_PACKET)lParam)</span>
00244 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (((psii-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o3">afCmd</a> &amp; <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>-&gt;EventType) &amp;&amp; <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>-&gt;fSense) ||
00245                 (!(psii-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o3">afCmd</a> &amp; <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>-&gt;EventType) &amp;&amp; !<a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>-&gt;fSense)) {
00246             <a class="code" href="../../d2/d4/ddemlsvr_8h.html#a13">ClientEventCallback</a>(psii-&gt;<a class="code" href="../../d6/d7/structtagSVR__INSTANCE__INFO.html#o5">pcii</a>, <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>);
00247         }
00248 <span class="preprocessor">#undef pep</span>
00249 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
00250 
00251     <span class="keywordflow">case</span> WM_DESTROY:
00252         <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a8">xxxChangeMonitorFlags</a>(psii, 0);
00253         <span class="keywordflow">break</span>;
00254 
00255     <span class="keywordflow">default</span>:
00256 CallDWP:
00257         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1632">xxxDefWindowProc</a>(pwnd, message, wParam, lParam);
00258     }
00259     <span class="keywordflow">return</span> 0;
00260 }
00261 
00262 
00263 
00264 <span class="comment">/***************************************************************************\</span>
00265 <span class="comment">* xxxMessageEvent</span>
00266 <span class="comment">*</span>
00267 <span class="comment">* Description:  Called when a hooked DDE message is sent or posted.  flags</span>
00268 <span class="comment">*   specifies the applicable MF_ flag.  This is called in the server side</span>
00269 <span class="comment">*   context of the sender or poster which may or may not be a DDEML process.</span>
00270 <span class="comment">*   pdmhd contains DDE data extracted and copied from the client side.</span>
00271 <span class="comment">*</span>
00272 <span class="comment">* History:</span>
00273 <span class="comment">* 12-1-91   sanfords    Created.</span>
00274 <span class="comment">\***************************************************************************/</span>
<a name="l00275"></a><a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a11">00275</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a11">xxxMessageEvent</a>(
00276 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndTo,
00277 UINT message,
00278 WPARAM wParam,
00279 LPARAM lParam,
00280 DWORD flag,
00281 PDDEML_MSG_HOOK_DATA pdmhd)
00282 {
00283     <a class="code" href="../../d7/d4/structtagEVENT__PACKET.html">PEVENT_PACKET</a> <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>;
00284     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFrom;
00285     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpep;
00286     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
00287 
00288     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00289 
00290     <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a> = (<a class="code" href="../../d7/d4/structtagEVENT__PACKET.html">PEVENT_PACKET</a>)UserAllocPoolWithQuota(<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d4/structtagEVENT__PACKET.html">EVENT_PACKET</a>) -
00291             <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) + <span class="keyword">sizeof</span>(MONMSGSTRUCT), TAG_DDE8);
00292     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00293         <span class="keywordflow">return</span>;
00294     }
00295     <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>-&gt;EventType = flag;
00296     <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>-&gt;fSense = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00297     <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>-&gt;cbEventData = <span class="keyword">sizeof</span>(MONMSGSTRUCT);
00298 <span class="preprocessor">#define pmsgs ((MONMSGSTRUCT *)&amp;pep-&gt;Data)</span>
00299 <span class="preprocessor"></span>    <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a3">pmsgs</a>-&gt;cb = <span class="keyword">sizeof</span>(MONMSGSTRUCT);
00300     <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a3">pmsgs</a>-&gt;hwndTo = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwndTo);
00301     <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a3">pmsgs</a>-&gt;dwTime = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
00302 
00303     pwndFrom = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>((HWND)wParam);
00304     <span class="keywordflow">if</span> (pwndFrom != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00305         <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a3">pmsgs</a>-&gt;hTask = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndFrom)-&gt;pEThread-&gt;Cid.UniqueThread;
00306     } <span class="keywordflow">else</span> {
00307         <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a3">pmsgs</a>-&gt;hTask = 0;
00308     }
00309 
00310     <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a3">pmsgs</a>-&gt;wMsg = message;
00311     <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a3">pmsgs</a>-&gt;wParam = wParam;
00312     <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a3">pmsgs</a>-&gt;lParam = lParam;
00313     <span class="keywordflow">if</span> (pdmhd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00314         <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a3">pmsgs</a>-&gt;dmhd = *pdmhd;
00315     }
00316 <span class="preprocessor">#undef pmsgs</span>
00317 <span class="preprocessor"></span>    pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00318     <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(pti, <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>, &amp;tlpep);
00319     <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a9">xxxCsEvent</a>(<a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>, <span class="keyword">sizeof</span>(MONMSGSTRUCT));
00320     <a class="code" href="../../d4/d1/userk_8h.html#a139">ThreadUnlockAndFreePool</a>(pti, &amp;tlpep);
00321 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:56 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
