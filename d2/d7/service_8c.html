<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: service.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>service.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/w32_2ntuser_2kernel_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d3/d6/service_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>HWINSTA&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/service_8c.html#a0">xxxConnectService</a> (PUNICODE_STRING pstrWinSta, HDESK *phdesk)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="service.c::xxxConnectService" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HWINSTA xxxConnectService           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>pstrWinSta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HDESK *&nbsp;</td>
          <td class="mdname" nowrap> <em>phdesk</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/service_8c-source.html#l00025">25</a> of file <a class="el" href="../../d3/d6/service_8c-source.html">service.c</a>.
<p>
References <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00037">AllocAce()</a>, <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00091">CreateSecurityDescriptor()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/ex_8c-source.html#l00017">OpenEffectiveToken()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00377">_SE_EXPORTS::SeAliasAdminsSid</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01590">SeExports</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01704">ThreadLockPool</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01707">ThreadUnlockPool</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01116">TRACE_INIT</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l01797">xxxCreateDesktop()</a>, and <a class="el" href="../../d9/d7/winsta_8c-source.html#l00243">xxxCreateWindowStation()</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/desktop_8c-source.html#l04821">xxxResolveDesktop()</a>.
<p>
<pre class="fragment"><div>00028 {
00029     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00030     HANDLE hToken;
00031     ULONG ulLength;
00032     PTOKEN_USER ptuService;
00033     PSECURITY_DESCRIPTOR psdService;
00034     PSID psid;
00035     PACCESS_ALLOWED_ACE paceService = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pace;
00036     OBJECT_ATTRIBUTES ObjService;
00037     HWINSTA hwinsta;
00038     UNICODE_STRING strDesktop;
00039     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlPoolSdService, tlPoolAceService, tlPoolToken;
00040 
00041     <span class="comment">/*</span>
00042 <span class="comment">     * Open the token of the service.</span>
00043 <span class="comment">     */</span>
00044     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a960">OpenEffectiveToken</a>(&amp;hToken);
00045     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00046         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ConnectService: Could not open process/thread token (0x%X)"</span>, Status);
00047         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00048     }
00049 
00050     <span class="comment">/*</span>
00051 <span class="comment">     * Get the user SID assigned to the service.</span>
00052 <span class="comment">     */</span>
00053     ptuService = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00054     paceService = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00055     psdService = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00056     hwinsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00057     ZwQueryInformationToken(hToken, TokenUser, NULL, 0, &amp;ulLength);
00058     ptuService = (PTOKEN_USER)UserAllocPool(ulLength, TAG_TOKEN);
00059     <span class="keywordflow">if</span> (ptuService == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00060         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ConnectService: Can't alloc buffer (size=%d) for token info"</span>, ulLength);
00061         <span class="keywordflow">goto</span> sd_error;
00062     }
00063     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryInformationToken(hToken, TokenUser, ptuService,
00064             ulLength, &amp;ulLength);
00065     ZwClose(hToken);
00066     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00067         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ConnectService: QueryInformationToken failed (0x%X)"</span>, Status);
00068         <span class="keywordflow">goto</span> sd_error;
00069     }
00070     psid = ptuService-&gt;User.Sid;
00071 
00072     <span class="comment">/*</span>
00073 <span class="comment">     * Create ACE list.</span>
00074 <span class="comment">     */</span>
00075     paceService = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(NULL, ACCESS_ALLOWED_ACE_TYPE, 0,
00076             WINSTA_CREATEDESKTOP | WINSTA_READATTRIBUTES |
00077                 WINSTA_ACCESSGLOBALATOMS | WINSTA_EXITWINDOWS |
00078                 WINSTA_ACCESSCLIPBOARD | STANDARD_RIGHTS_REQUIRED,
00079             psid, &amp;ulLength);
00080     <span class="keywordflow">if</span> (paceService == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00081         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ConnectService: AllocAce for WindowStation attributes failed"</span>);
00082         <span class="keywordflow">goto</span> sd_error;
00083     }
00084     pace = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(paceService, ACCESS_ALLOWED_ACE_TYPE, OBJECT_INHERIT_ACE |
00085             INHERIT_ONLY_ACE | NO_PROPAGATE_INHERIT_ACE,
00086             DESKTOP_READOBJECTS | DESKTOP_WRITEOBJECTS | DESKTOP_ENUMERATE |
00087                 DESKTOP_CREATEWINDOW | DESKTOP_CREATEMENU | DESKTOP_HOOKCONTROL |
00088                 STANDARD_RIGHTS_REQUIRED,
00089             psid, &amp;ulLength);
00090     <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00091         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ConnectService: AllocAce for Desktop Attributes failed"</span>);
00092         <span class="keywordflow">goto</span> sd_error;
00093     }
00094     paceService = pace;
00095     pace = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(pace, ACCESS_ALLOWED_ACE_TYPE, 0,
00096             WINSTA_ENUMERATE,
00097             <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o34">SeAliasAdminsSid</a>, &amp;ulLength);
00098     <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00099         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ConnectService: AllocAce for admin WinSta enumerate failed"</span>);
00100         <span class="keywordflow">goto</span> sd_error;
00101     }
00102     paceService = pace;
00103     pace = <a class="code" href="../../d4/d1/userk_8h.html#a1269">AllocAce</a>(pace, ACCESS_ALLOWED_ACE_TYPE, OBJECT_INHERIT_ACE |
00104             INHERIT_ONLY_ACE | NO_PROPAGATE_INHERIT_ACE,
00105             DESKTOP_READOBJECTS | DESKTOP_WRITEOBJECTS | DESKTOP_ENUMERATE,
00106             <a class="code" href="../../d0/d5/se_8h.html#a37">SeExports</a>-&gt;<a class="code" href="../../d2/d0/struct__SE__EXPORTS.html#o34">SeAliasAdminsSid</a>, &amp;ulLength);
00107     <span class="keywordflow">if</span> (pace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00108         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ConnectService: AllocAce for admin Desktop access failed"</span>);
00109         <span class="keywordflow">goto</span> sd_error;
00110     }
00111     paceService = pace;
00112 
00113     <span class="comment">/*</span>
00114 <span class="comment">     * Initialize the SD</span>
00115 <span class="comment">     */</span>
00116     psdService = <a class="code" href="../../d4/d1/userk_8h.html#a1268">CreateSecurityDescriptor</a>(paceService, ulLength, FALSE);
00117     <span class="keywordflow">if</span> (psdService == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00118         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ConnectService: CreateSecurityDescriptor failed"</span>);
00119         <span class="keywordflow">goto</span> sd_error;
00120     }
00121 
00122     <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), ptuService,  &amp;tlPoolToken);
00123     <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), paceService, &amp;tlPoolAceService);
00124     <a class="code" href="../../d4/d1/userk_8h.html#a137">ThreadLockPool</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), psdService,  &amp;tlPoolSdService);
00125 
00126     <span class="comment">/*</span>
00127 <span class="comment">     * The windowstation does not exist and must be created.</span>
00128 <span class="comment">     */</span>
00129     InitializeObjectAttributes(&amp;ObjService, pstrWinSta,
00130             OBJ_OPENIF, NULL, psdService);
00131     hwinsta = <a class="code" href="../../d8/d8/winsta_8c.html#a3">xxxCreateWindowStation</a>(&amp;ObjService,
00132                                      KernelMode,
00133                                      MAXIMUM_ALLOWED,
00134                                      NULL, 0, NULL, 0);
00135     <span class="keywordflow">if</span> (hwinsta != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00136 
00137         <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Service windowstation created\n"</span>));
00138 
00139         <span class="comment">/*</span>
00140 <span class="comment">         * We have the windowstation, now create the desktop.  The security</span>
00141 <span class="comment">         * descriptor will be inherited from the windowstation.  Save the</span>
00142 <span class="comment">         * winsta handle because the access struct may be moved by the</span>
00143 <span class="comment">         * desktop creation.</span>
00144 <span class="comment">         */</span>
00145         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;strDesktop, TEXT(<span class="stringliteral">"Default"</span>));
00146         InitializeObjectAttributes(&amp;ObjService, &amp;strDesktop,
00147                 OBJ_OPENIF | OBJ_CASE_INSENSITIVE, hwinsta, NULL);
00148 
00149         *phdesk = <a class="code" href="../../d4/d1/userk_8h.html#a1795">xxxCreateDesktop</a>(&amp;ObjService, KernelMode,
00150                 NULL, NULL, 0, MAXIMUM_ALLOWED);
00151 
00152         <span class="keywordflow">if</span> (*phdesk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00153 
00154             <span class="comment">/*</span>
00155 <span class="comment">             * The creation failed, wake the desktop thread, close the</span>
00156 <span class="comment">             * windowstation and leave.</span>
00157 <span class="comment">             */</span>
00158             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ConnectService: CreateDesktop('Default') failed."</span>);
00159 
00160             ZwClose(hwinsta);
00161             hwinsta = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00162         } <span class="keywordflow">else</span> {
00163             <a class="code" href="../../d4/d1/userk_8h.html#a91">TRACE_INIT</a>((<span class="stringliteral">"Default desktop in Service windowstation created\n"</span>));
00164         }
00165     } <span class="keywordflow">else</span> {
00166         *phdesk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00167     }
00168 
00169     <a class="code" href="../../d4/d1/userk_8h.html#a138">ThreadUnlockPool</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), &amp;tlPoolSdService);
00170     <a class="code" href="../../d4/d1/userk_8h.html#a138">ThreadUnlockPool</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), &amp;tlPoolAceService);
00171     <a class="code" href="../../d4/d1/userk_8h.html#a138">ThreadUnlockPool</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), &amp;tlPoolToken);
00172 
00173 sd_error:
00174     <span class="keywordflow">if</span> (ptuService != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00175         UserFreePool(ptuService);
00176     <span class="keywordflow">if</span> (paceService != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00177         UserFreePool(paceService);
00178     <span class="keywordflow">if</span> (psdService != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00179         UserFreePool(psdService);
00180 
00181     <span class="keywordflow">return</span> hwinsta;
00182 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:37 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
