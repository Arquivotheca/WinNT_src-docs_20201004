<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: report.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>report.c</h1><a href="../../d1/d8/report_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    report.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the subroutines used to report resources used by</span>
00012 <span class="comment">    the drivers and the HAL into the registry resource map.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Andre Vachon (andreva) 15-Dec-1992</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode, local to I/O system</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00028 
<a name="l00029"></a><a class="code" href="../../d1/d8/report_8c.html#a0">00029</a> <span class="preprocessor">#define DBG_AR 0</span>
00030 <span class="preprocessor"></span>
<a name="l00031"></a><a class="code" href="../../d1/d8/report_8c.html#a1">00031</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d3/d5/iodata_8c.html#a75">IopWstrRaw</a>[];
<a name="l00032"></a><a class="code" href="../../d1/d8/report_8c.html#a2">00032</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d7/d9/assign_8c.html#a28">IopWstrTranslated</a>[];
<a name="l00033"></a><a class="code" href="../../d1/d8/report_8c.html#a3">00033</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d7/d9/assign_8c.html#a29">IopWstrBusTranslated</a>[];
<a name="l00034"></a><a class="code" href="../../d1/d8/report_8c.html#a4">00034</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d7/d9/assign_8c.html#a21">IopWstrOtherDrivers</a>[];
00035 
<a name="l00036"></a><a class="code" href="../../d1/d8/report_8c.html#a5">00036</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d3/d5/iodata_8c.html#a89">IopWstrHal</a>[];
<a name="l00037"></a><a class="code" href="../../d1/d8/report_8c.html#a6">00037</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d3/d5/iodata_8c.html#a90">IopWstrSystem</a>[];
<a name="l00038"></a><a class="code" href="../../d1/d8/report_8c.html#a7">00038</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d3/d5/iodata_8c.html#a91">IopWstrPhysicalMemory</a>[];
<a name="l00039"></a><a class="code" href="../../d1/d8/report_8c.html#a8">00039</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d3/d5/iodata_8c.html#a92">IopWstrSpecialMemory</a>[];
00040 
00041 BOOLEAN
00042 <a class="code" href="../../d1/d8/report_8c.html#a9">IopChangeInterfaceType</a>(
00043     IN OUT PIO_RESOURCE_REQUIREMENTS_LIST IoResources,
00044     IN OUT PCM_RESOURCE_LIST *AllocatedResource
00045     );
00046 
00047 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoReportResourceUsageInternal)</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoReportResourceUsage)</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoReportResourceForDetection)</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopChangeInterfaceType)</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopWriteResourceList)</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, IopInitializeResourceMap)</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, IoReportHalResourceUsage)</span>
00055 <span class="preprocessor"></span><span class="comment">// BUGBUG - For now we want the following two dbg routines for free build.</span>
00056 <span class="comment">//          So, we can track resource allocation on free build by enabling</span>
00057 <span class="comment">//          a debug flag.</span>
00058 <span class="comment">//#if DBG</span>
00059 <span class="preprocessor">#pragma alloc_text(PAGE, IopDumpCmResourceDescriptor)</span>
00060 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDumpCmResourceList)</span>
00061 <span class="preprocessor"></span><span class="comment">//#endif</span>
00062 <span class="preprocessor">#endif</span>
00063 <span class="preprocessor"></span>
00064 
00065 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00066"></a><a class="code" href="../../d1/d8/report_8c.html#a10">00066</a> <a class="code" href="../../d1/d8/report_8c.html#a10">IopInitializeResourceMap</a> (
00067     <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00068     )
00069 <span class="comment">/*++</span>
00070 <span class="comment"></span>
00071 <span class="comment">    Initializes the resource map by adding in the physical memory</span>
00072 <span class="comment">    which is in use by the system.</span>
00073 <span class="comment"></span>
00074 <span class="comment">--*/</span>
00075 {
00076     ULONG i, j, pass, length;
00077     LARGE_INTEGER li;
00078     HANDLE keyHandle;
00079     UNICODE_STRING  unicodeString, systemString, listString;
00080     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00081     PCM_RESOURCE_LIST ResourceList;
00082     PCM_PARTIAL_RESOURCE_DESCRIPTOR CmDescriptor;
00083     BOOLEAN IncludeType[<a class="code" href="../../d1/d9/arc_8h.html#a320a278">LoaderMaximum</a>];
00084     ULONG MemoryAlloc[(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PHYSICAL_MEMORY_DESCRIPTOR</a>) +
00085             <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a>)*<a class="code" href="../../d2/d1/mm_8h.html#a0">MAX_PHYSICAL_MEMORY_FRAGMENTS</a>) /
00086               <span class="keyword">sizeof</span>(ULONG)];
00087     <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> MemoryBlock;
00088 
00089     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;systemString,  <a class="code" href="../../d3/d5/iodata_8c.html#a90">IopWstrSystem</a>);
00090     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;listString, <a class="code" href="../../d7/d9/assign_8c.html#a28">IopWstrTranslated</a> );
00091 
00092     <span class="keywordflow">for</span> (pass=0; pass &lt; 2; pass++) {
00093         <span class="keywordflow">switch</span> (pass) {
00094             <span class="keywordflow">case</span> 0:
00095                 <span class="comment">//</span>
00096                 <span class="comment">// Add MmPhysicalMemoryBlock to regitry</span>
00097                 <span class="comment">//</span>
00098 
00099                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, <a class="code" href="../../d3/d5/iodata_8c.html#a91">IopWstrPhysicalMemory</a>);
00100                 MemoryBlock = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>;
00101                 <span class="keywordflow">break</span>;
00102 
00103             <span class="keywordflow">case</span> 1:
00104 
00105                 <span class="comment">//</span>
00106                 <span class="comment">// Add LoadSpecialMemory to registry</span>
00107                 <span class="comment">//</span>
00108 
00109                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, <a class="code" href="../../d3/d5/iodata_8c.html#a92">IopWstrSpecialMemory</a>);
00110 
00111                 <span class="comment">//</span>
00112                 <span class="comment">// Computer memory limits of LoaderSpecialMemory</span>
00113                 <span class="comment">//</span>
00114 
00115                 MemoryBlock = (<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a>)&amp;MemoryAlloc;
00116                 MemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> = <a class="code" href="../../d2/d1/mm_8h.html#a0">MAX_PHYSICAL_MEMORY_FRAGMENTS</a>;
00117 
00118                 <span class="keywordflow">for</span> (j=0; j &lt; <a class="code" href="../../d1/d9/arc_8h.html#a320a278">LoaderMaximum</a>; j++) {
00119                     IncludeType[j] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00120                 }
00121                 IncludeType[<a class="code" href="../../d1/d9/arc_8h.html#a320a276">LoaderSpecialMemory</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00122                 <a class="code" href="../../d5/d1/mminit_8c.html#a52">MmInitializeMemoryLimits</a>(
00123                     LoaderBlock,
00124                     IncludeType,
00125                     MemoryBlock
00126                     );
00127 
00128                 <span class="keywordflow">break</span>;
00129         }
00130 
00131         <span class="comment">//</span>
00132         <span class="comment">// Allocate and build a CM_RESOURCE_LIST to describe all</span>
00133         <span class="comment">// of physical memory</span>
00134         <span class="comment">//</span>
00135 
00136         j = MemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>;
00137         <span class="keywordflow">if</span> (j == 0) {
00138             <span class="keywordflow">continue</span>;
00139         }
00140 
00141         length = <span class="keyword">sizeof</span>(CM_RESOURCE_LIST) + (j-1) * <span class="keyword">sizeof</span> (CM_PARTIAL_RESOURCE_DESCRIPTOR);
00142         ResourceList = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, length);
00143         <span class="keywordflow">if</span> (!ResourceList) {
00144             <span class="keywordflow">return</span>;
00145         }
00146         RtlZeroMemory ((PVOID) ResourceList, length);
00147 
00148         ResourceList-&gt;Count = 1;
00149         ResourceList-&gt;List[0].PartialResourceList.Count = j;
00150         CmDescriptor = ResourceList-&gt;List[0].PartialResourceList.PartialDescriptors;
00151 
00152         <span class="keywordflow">for</span> (i=0; i &lt; j; i++) {
00153             CmDescriptor-&gt;Type = CmResourceTypeMemory;
00154             CmDescriptor-&gt;ShareDisposition = CmResourceShareDeviceExclusive;
00155             li.QuadPart = (LONGLONG)(MemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>);
00156             li.QuadPart &lt;&lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00157             CmDescriptor-&gt;u.Memory.Start  = li;
00158 
00159             <span class="comment">// fixfix - handle page frame numbers greater than 32 bits.</span>
00160 
00161             CmDescriptor-&gt;u.Memory.Length =
00162                 (ULONG)(MemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00163 
00164             CmDescriptor++;
00165         }
00166 
00167 
00168         <span class="comment">//</span>
00169         <span class="comment">// Add the resoruce list to the resorucemap</span>
00170         <span class="comment">//</span>
00171 
00172         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;keyHandle,
00173                                      (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00174                                      &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a19">CmRegistryMachineHardwareResourceMapName</a>,
00175                                      KEY_READ | KEY_WRITE,
00176                                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00177         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00178             <a class="code" href="../../d1/d8/report_8c.html#a15">IopWriteResourceList</a> ( keyHandle,
00179                                    &amp;systemString,
00180                                    &amp;unicodeString,
00181                                    &amp;listString,
00182                                    ResourceList,
00183                                    length
00184                                    );
00185             ZwClose( keyHandle );
00186         }
00187         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ResourceList);
00188     }
00189 }
00190 
00191 
00192 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00193"></a><a class="code" href="../../d1/d8/report_8c.html#a11">00193</a> <a class="code" href="../../d1/d8/report_8c.html#a11">IoReportHalResourceUsage</a>(
00194     IN PUNICODE_STRING HalName,
00195     IN PCM_RESOURCE_LIST RawResourceList,
00196     IN PCM_RESOURCE_LIST TranslatedResourceList,
00197     IN ULONG ResourceListSize
00198     )
00199 
00200 <span class="comment">/*++</span>
00201 <span class="comment"></span>
00202 <span class="comment">Routine Description:</span>
00203 <span class="comment"></span>
00204 <span class="comment">    This routine is called by the HAL to report its resources.</span>
00205 <span class="comment">    The Hal is the first component to report its resources, so we don't need</span>
00206 <span class="comment">    to acquire the resourcemap semaphore, and we do not need to check for</span>
00207 <span class="comment">    conflicts.</span>
00208 <span class="comment"></span>
00209 <span class="comment">Arguments:</span>
00210 <span class="comment"></span>
00211 <span class="comment">    HalName - Name of the HAL reporting the resources.</span>
00212 <span class="comment"></span>
00213 <span class="comment">    RawResourceList - Pointer to the HAL's raw resource list.</span>
00214 <span class="comment"></span>
00215 <span class="comment">    TranslatedResourceList - Pointer to the HAL's translated resource list.</span>
00216 <span class="comment"></span>
00217 <span class="comment">    DriverListSize - Value determining the size of the HAL's resource list.</span>
00218 <span class="comment"></span>
00219 <span class="comment">Return Value:</span>
00220 <span class="comment"></span>
00221 <span class="comment">    The status returned is the final completion status of the operation.</span>
00222 <span class="comment"></span>
00223 <span class="comment">--*/</span>
00224 
00225 {
00226     HANDLE keyHandle;
00227     UNICODE_STRING halString;
00228     UNICODE_STRING listString;
00229     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00230 
00231     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00232 
00233     <span class="comment">//</span>
00234     <span class="comment">// First open a handle to the RESOURCEMAP key.</span>
00235     <span class="comment">//</span>
00236 
00237     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;halString, <a class="code" href="../../d3/d5/iodata_8c.html#a89">IopWstrHal</a> );
00238 
00239     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;keyHandle,
00240                                  (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00241                                  &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a19">CmRegistryMachineHardwareResourceMapName</a>,
00242                                  KEY_READ | KEY_WRITE,
00243                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00244 
00245     <span class="comment">//</span>
00246     <span class="comment">// Write out the raw resource list</span>
00247     <span class="comment">//</span>
00248 
00249     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00250 
00251         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;listString, <a class="code" href="../../d3/d5/iodata_8c.html#a75">IopWstrRaw</a>);
00252 
00253         status = <a class="code" href="../../d1/d8/report_8c.html#a15">IopWriteResourceList</a>( keyHandle,
00254                                        &amp;halString,
00255                                        HalName,
00256                                        &amp;listString,
00257                                        RawResourceList,
00258                                        ResourceListSize );
00259 
00260         <span class="comment">//</span>
00261         <span class="comment">// If we successfully wrote out the raw resource list, write out</span>
00262         <span class="comment">// the translated resource list.</span>
00263         <span class="comment">//</span>
00264 
00265         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00266 
00267             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;listString, <a class="code" href="../../d7/d9/assign_8c.html#a28">IopWstrTranslated</a>);
00268             status = <a class="code" href="../../d1/d8/report_8c.html#a15">IopWriteResourceList</a>( keyHandle,
00269                                            &amp;halString,
00270                                            HalName,
00271                                            &amp;listString,
00272                                            TranslatedResourceList,
00273                                            ResourceListSize );
00274 
00275         }
00276         ZwClose( keyHandle );
00277     }
00278 
00279     <span class="comment">//</span>
00280     <span class="comment">// If every looks fine, we will make a copy of the Hal resources so will</span>
00281     <span class="comment">// can call Arbiters to reserve the resources after they initialized.</span>
00282     <span class="comment">//</span>
00283 
00284     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00285         <a class="code" href="../../d1/d0/pnpdata_8c.html#a2">IopInitHalResources</a> = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, ResourceListSize);
00286         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a2">IopInitHalResources</a>) {
00287             RtlMoveMemory(<a class="code" href="../../d1/d0/pnpdata_8c.html#a2">IopInitHalResources</a>, RawResourceList, ResourceListSize);
00288         } <span class="keywordflow">else</span> {
00289             status = STATUS_INSUFFICIENT_RESOURCES;
00290         }
00291     }
00292 
00293     <span class="keywordflow">return</span> status;
00294 }
00295 
00296 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00297"></a><a class="code" href="../../d1/d8/report_8c.html#a12">00297</a> <a class="code" href="../../d1/d8/report_8c.html#a12">IoReportResourceForDetection</a>(
00298     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00299     IN PCM_RESOURCE_LIST DriverList OPTIONAL,
00300     IN ULONG DriverListSize OPTIONAL,
00301     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL,
00302     IN PCM_RESOURCE_LIST DeviceList OPTIONAL,
00303     IN ULONG DeviceListSize OPTIONAL,
00304     OUT PBOOLEAN ConflictDetected
00305     )
00306 
00307 <span class="comment">/*++</span>
00308 <span class="comment"></span>
00309 <span class="comment">Routine Description:</span>
00310 <span class="comment"></span>
00311 <span class="comment">    This routine will automatically search through the configuration</span>
00312 <span class="comment">    registry for resource conflicts between resources requested by a device</span>
00313 <span class="comment">    and the resources already claimed by previously installed drivers. The</span>
00314 <span class="comment">    contents of the DriverList and the DeviceList will be matched against</span>
00315 <span class="comment">    all the other resource list stored in the registry to determine</span>
00316 <span class="comment">    conflicts.</span>
00317 <span class="comment"></span>
00318 <span class="comment">    The function may be called more than once for a given device or driver.</span>
00319 <span class="comment">    If a new resource list is given, the previous resource list stored in</span>
00320 <span class="comment">    the registry will be replaced by the new list.</span>
00321 <span class="comment"></span>
00322 <span class="comment">    Note, this function is for the drivers acquiring resources for detection.</span>
00323 <span class="comment"></span>
00324 <span class="comment">Arguments:</span>
00325 <span class="comment"></span>
00326 <span class="comment">    DriverObject - Pointer to the driver's driver object.</span>
00327 <span class="comment"></span>
00328 <span class="comment">    DriverList - Optional pointer to the driver's resource list.</span>
00329 <span class="comment"></span>
00330 <span class="comment">    DriverListSize - Optional value determining the size of the driver's</span>
00331 <span class="comment">        resource list.</span>
00332 <span class="comment"></span>
00333 <span class="comment">    DeviceObject - Optional pointer to driver's device object.</span>
00334 <span class="comment"></span>
00335 <span class="comment">    DeviceList - Optional pointer to the device's resource list.</span>
00336 <span class="comment"></span>
00337 <span class="comment">    DriverListSize - Optional value determining the size of the device's</span>
00338 <span class="comment">        resource list.</span>
00339 <span class="comment"></span>
00340 <span class="comment">    ConflictDetected - Supplies a pointer to a boolean that is set to TRUE</span>
00341 <span class="comment">        if the resource list conflicts with an already existing resource</span>
00342 <span class="comment">        list in the configuration registry.</span>
00343 <span class="comment"></span>
00344 <span class="comment">Return Value:</span>
00345 <span class="comment"></span>
00346 <span class="comment">    The status returned is the final completion status of the operation.</span>
00347 <span class="comment"></span>
00348 <span class="comment">--*/</span>
00349 
00350 {
00351     <span class="comment">//</span>
00352     <span class="comment">// Sanity check that the caller did not pass in a PnP PDO.</span>
00353     <span class="comment">//</span>
00354 
00355     <span class="keywordflow">if</span> (DeviceObject) {
00356 
00357         <span class="keywordflow">if</span> (    DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode &amp;&amp;
00358                 !(((<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode)-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a34">DNF_LEGACY_RESOURCE_DEVICENODE</a>)) {
00359 
00360             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(PNP_DETECTED_FATAL_ERROR, <a class="code" href="../../d9/d0/pnpiop_8h.html#a48">PNP_ERR_INVALID_PDO</a>, (ULONG_PTR)DeviceObject, 0, 0);
00361 
00362         }
00363 
00364     }
00365 
00366     <span class="keywordflow">return</span> <a class="code" href="../../d1/d8/report_8c.html#a14">IoReportResourceUsageInternal</a>(   <a class="code" href="../../d6/d9/pnp_8h.html#a174a129">ArbiterRequestPnpDetected</a>,
00367                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00368                                             DriverObject,
00369                                             DriverList,
00370                                             DriverListSize,
00371                                             DeviceObject,
00372                                             DeviceList,
00373                                             DeviceListSize,
00374                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00375                                             ConflictDetected);
00376 }
00377 
00378 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00379"></a><a class="code" href="../../d1/d8/report_8c.html#a13">00379</a> <a class="code" href="../../d1/d8/report_8c.html#a13">IoReportResourceUsage</a>(
00380     IN PUNICODE_STRING DriverClassName OPTIONAL,
00381     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00382     IN PCM_RESOURCE_LIST DriverList OPTIONAL,
00383     IN ULONG DriverListSize OPTIONAL,
00384     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL,
00385     IN PCM_RESOURCE_LIST DeviceList OPTIONAL,
00386     IN ULONG DeviceListSize OPTIONAL,
00387     IN BOOLEAN OverrideConflict,
00388     OUT PBOOLEAN ConflictDetected
00389     )
00390 
00391 <span class="comment">/*++</span>
00392 <span class="comment"></span>
00393 <span class="comment">Routine Description:</span>
00394 <span class="comment"></span>
00395 <span class="comment">    This routine will automatically search through the configuration</span>
00396 <span class="comment">    registry for resource conflicts between resources requested by a device</span>
00397 <span class="comment">    and the resources already claimed by previously installed drivers. The</span>
00398 <span class="comment">    contents of the DriverList and the DeviceList will be matched against</span>
00399 <span class="comment">    all the other resource list stored in the registry to determine</span>
00400 <span class="comment">    conflicts.</span>
00401 <span class="comment"></span>
00402 <span class="comment">    If not conflict was detected, or if the OverrideConflict flag is set,</span>
00403 <span class="comment">    this routine will create appropriate entries in the system resource map</span>
00404 <span class="comment">    (in the registry) that will contain the specified resource lists.</span>
00405 <span class="comment"></span>
00406 <span class="comment">    The function may be called more than once for a given device or driver.</span>
00407 <span class="comment">    If a new resource list is given, the previous resource list stored in</span>
00408 <span class="comment">    the registry will be replaced by the new list.</span>
00409 <span class="comment"></span>
00410 <span class="comment">Arguments:</span>
00411 <span class="comment"></span>
00412 <span class="comment">    DriverClassName - Optional pointer to a UNICODE_STRING which describes</span>
00413 <span class="comment">        the class of driver under which the driver information should be</span>
00414 <span class="comment">        stored. A default type is used if none is given.</span>
00415 <span class="comment"></span>
00416 <span class="comment">    DriverObject - Pointer to the driver's driver object.</span>
00417 <span class="comment"></span>
00418 <span class="comment">    DriverList - Optional pointer to the driver's resource list.</span>
00419 <span class="comment"></span>
00420 <span class="comment">    DriverListSize - Optional value determining the size of the driver's</span>
00421 <span class="comment">        resource list.</span>
00422 <span class="comment"></span>
00423 <span class="comment">    DeviceObject - Optional pointer to driver's device object.</span>
00424 <span class="comment"></span>
00425 <span class="comment">    DeviceList - Optional pointer to the device's resource list.</span>
00426 <span class="comment"></span>
00427 <span class="comment">    DriverListSize - Optional value determining the size of the driver's</span>
00428 <span class="comment">        resource list.</span>
00429 <span class="comment"></span>
00430 <span class="comment">    OverrideConflict - Determines if the information should be reported</span>
00431 <span class="comment">        in the configuration registry eventhough a conflict was found with</span>
00432 <span class="comment">        another driver or device.</span>
00433 <span class="comment"></span>
00434 <span class="comment">    ConflictDetected - Supplies a pointer to a boolean that is set to TRUE</span>
00435 <span class="comment">        if the resource list conflicts with an already existing resource</span>
00436 <span class="comment">        list in the configuration registry.</span>
00437 <span class="comment"></span>
00438 <span class="comment">Return Value:</span>
00439 <span class="comment"></span>
00440 <span class="comment">    The status returned is the final completion status of the operation.</span>
00441 <span class="comment"></span>
00442 <span class="comment">--*/</span>
00443 
00444 {
00445     <span class="keywordflow">if</span> (DeviceObject) {
00446 
00447         <span class="keywordflow">if</span> (    DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode &amp;&amp;
00448                 !(((<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode)-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a34">DNF_LEGACY_RESOURCE_DEVICENODE</a>)) {
00449 
00450             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(PNP_DETECTED_FATAL_ERROR, <a class="code" href="../../d9/d0/pnpiop_8h.html#a48">PNP_ERR_INVALID_PDO</a>, (ULONG_PTR)DeviceObject, 0, 0);
00451 
00452         }
00453 
00454     }
00455 
00456     <span class="keywordflow">return</span> <a class="code" href="../../d1/d8/report_8c.html#a14">IoReportResourceUsageInternal</a>(   <a class="code" href="../../d6/d9/pnp_8h.html#a174a126">ArbiterRequestLegacyReported</a>,
00457                                             DriverClassName,
00458                                             DriverObject,
00459                                             DriverList,
00460                                             DriverListSize,
00461                                             DeviceObject,
00462                                             DeviceList,
00463                                             DeviceListSize,
00464                                             OverrideConflict,
00465                                             ConflictDetected);
00466 }
00467 
00468 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00469"></a><a class="code" href="../../d1/d8/report_8c.html#a14">00469</a> <a class="code" href="../../d1/d8/report_8c.html#a14">IoReportResourceUsageInternal</a>(
00470     IN ARBITER_REQUEST_SOURCE AllocationType,
00471     IN PUNICODE_STRING DriverClassName OPTIONAL,
00472     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00473     IN PCM_RESOURCE_LIST DriverList OPTIONAL,
00474     IN ULONG DriverListSize OPTIONAL,
00475     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL,
00476     IN PCM_RESOURCE_LIST DeviceList OPTIONAL,
00477     IN ULONG DeviceListSize OPTIONAL,
00478     IN BOOLEAN OverrideConflict,
00479     OUT PBOOLEAN ConflictDetected
00480     )
00481 
00482 <span class="comment">/*++</span>
00483 <span class="comment"></span>
00484 <span class="comment">Routine Description:</span>
00485 <span class="comment"></span>
00486 <span class="comment">    This internal routine will do all the work for IoReportResourceUsage.</span>
00487 <span class="comment"></span>
00488 <span class="comment">Arguments:</span>
00489 <span class="comment"></span>
00490 <span class="comment">    AllocationType - Specifies the request type.</span>
00491 <span class="comment"></span>
00492 <span class="comment">    DriverClassName - Optional pointer to a UNICODE_STRING which describes</span>
00493 <span class="comment">        the class of driver under which the driver information should be</span>
00494 <span class="comment">        stored. A default type is used if none is given.</span>
00495 <span class="comment"></span>
00496 <span class="comment">    DriverObject - Pointer to the driver's driver object.</span>
00497 <span class="comment"></span>
00498 <span class="comment">    DriverList - Optional pointer to the driver's resource list.</span>
00499 <span class="comment"></span>
00500 <span class="comment">    DriverListSize - Optional value determining the size of the driver's</span>
00501 <span class="comment">        resource list.</span>
00502 <span class="comment"></span>
00503 <span class="comment">    DeviceObject - Optional pointer to driver's device object.</span>
00504 <span class="comment"></span>
00505 <span class="comment">    DeviceList - Optional pointer to the device's resource list.</span>
00506 <span class="comment"></span>
00507 <span class="comment">    DriverListSize - Optional value determining the size of the driver's</span>
00508 <span class="comment">        resource list.</span>
00509 <span class="comment"></span>
00510 <span class="comment">    OverrideConflict - Determines if the information should be reported</span>
00511 <span class="comment">        in the configuration registry eventhough a conflict was found with</span>
00512 <span class="comment">        another driver or device.</span>
00513 <span class="comment"></span>
00514 <span class="comment">    ConflictDetected - Supplies a pointer to a boolean that is set to TRUE</span>
00515 <span class="comment">        if the resource list conflicts with an already existing resource</span>
00516 <span class="comment">        list in the configuration registry.</span>
00517 <span class="comment"></span>
00518 <span class="comment">Return Value:</span>
00519 <span class="comment"></span>
00520 <span class="comment">    The status returned is the final completion status of the operation.</span>
00521 <span class="comment"></span>
00522 <span class="comment">--*/</span>
00523 
00524 {
00525     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status = STATUS_UNSUCCESSFUL;
00526     PCM_RESOURCE_LIST               resourceList;
00527     PCM_RESOURCE_LIST               allocatedResources;
00528     PIO_RESOURCE_REQUIREMENTS_LIST  resourceRequirements;
00529     ULONG                           attempt;
00530     BOOLEAN                         freeAllocatedResources;
00531 
00532     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DriverObject &amp;&amp; ConflictDetected);
00533 
00534     <span class="keywordflow">if</span> (DeviceList) {
00535 
00536         resourceList = DeviceList;
00537 
00538     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DriverList) {
00539 
00540         resourceList = DriverList;
00541 
00542     } <span class="keywordflow">else</span> {
00543 
00544         resourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00545 
00546     }
00547 
00548     resourceRequirements = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00549 
00550     <span class="keywordflow">if</span> (resourceList) {
00551 
00552         <span class="keywordflow">if</span> (resourceList-&gt;Count &amp;&amp; resourceList-&gt;List[0].PartialResourceList.Count) {
00553 
00554             resourceRequirements = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (0, resourceList, LCPRI_NORMAL);
00555 
00556             <span class="keywordflow">if</span> (resourceRequirements == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00557 
00558                 <span class="keywordflow">return</span> status;
00559 
00560             }
00561 
00562         } <span class="keywordflow">else</span> {
00563 
00564             resourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00565 
00566         }
00567 
00568     }
00569 
00570     *ConflictDetected = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00571     attempt = 0;
00572     allocatedResources = resourceList;
00573     freeAllocatedResources = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00574     <span class="keywordflow">do</span> {
00575 
00576         <span class="comment">//</span>
00577         <span class="comment">// Do the legacy resource allocation.</span>
00578         <span class="comment">//</span>
00579 
00580         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a107">IopLegacyResourceAllocation</a> (  AllocationType,
00581                                                 DriverObject,
00582                                                 DeviceObject,
00583                                                 resourceRequirements,
00584                                                 &amp;allocatedResources);
00585 
00586         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00587 
00588             *ConflictDetected = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00589             <span class="keywordflow">break</span>;
00590         }
00591 
00592         <span class="comment">//</span>
00593         <span class="comment">// Change the interface type and try again.</span>
00594         <span class="comment">//</span>
00595 
00596         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d8/report_8c.html#a9">IopChangeInterfaceType</a>(resourceRequirements, &amp;allocatedResources)) {
00597 
00598             <span class="keywordflow">break</span>;
00599         }
00600         freeAllocatedResources = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00601 
00602     } <span class="keywordflow">while</span> (++attempt &lt; 2);
00603 
00604     <span class="keywordflow">if</span> (resourceRequirements) {
00605 
00606         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(resourceRequirements);
00607 
00608     }
00609 
00610     <span class="keywordflow">if</span> (freeAllocatedResources) {
00611 
00612         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(allocatedResources);
00613     }
00614 
00615     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00616 
00617         status = STATUS_SUCCESS;
00618 
00619     } <span class="keywordflow">else</span> {
00620 
00621         status = STATUS_INSUFFICIENT_RESOURCES;
00622 
00623     }
00624 
00625     <span class="keywordflow">return</span> status;
00626 }
00627 
00628 BOOLEAN
<a name="l00629"></a><a class="code" href="../../d1/d8/report_8c.html#a9">00629</a> <a class="code" href="../../d1/d8/report_8c.html#a9">IopChangeInterfaceType</a>(
00630     IN OUT PIO_RESOURCE_REQUIREMENTS_LIST IoResources,
00631     IN OUT PCM_RESOURCE_LIST *AllocatedResources
00632     )
00633 
00634 <span class="comment">/*++</span>
00635 <span class="comment"></span>
00636 <span class="comment">Routine Description:</span>
00637 <span class="comment"></span>
00638 <span class="comment">    This routine takes an Io resourcelist and changes its interfacetype</span>
00639 <span class="comment">    from internal to default type (isa or eisa or mca).</span>
00640 <span class="comment"></span>
00641 <span class="comment">Arguments:</span>
00642 <span class="comment"></span>
00643 <span class="comment">    IoResources - Pointer to requirement list.</span>
00644 <span class="comment"></span>
00645 <span class="comment">    AllocatedResources - Pointer to a variable that receives the pointer to the resource list.</span>
00646 <span class="comment"></span>
00647 <span class="comment">Return Value:</span>
00648 <span class="comment"></span>
00649 <span class="comment">    BOOLEAN value to indicates if change made or not.</span>
00650 <span class="comment"></span>
00651 <span class="comment">--*/</span>
00652 
00653 {
00654     PIO_RESOURCE_LIST       IoResourceList;
00655     PIO_RESOURCE_DESCRIPTOR IoResourceDescriptor;
00656     PIO_RESOURCE_DESCRIPTOR IoResourceDescriptorEnd;
00657     LONG                    IoResourceListCount;
00658     BOOLEAN                 changed;
00659 
00660     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AllocatedResources);
00661 
00662     changed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00663 
00664     <span class="keywordflow">if</span> (!IoResources) {
00665 
00666         <span class="keywordflow">return</span> changed;
00667 
00668     }
00669 
00670     <span class="keywordflow">if</span> (IoResources-&gt;InterfaceType == Internal) {
00671 
00672         IoResources-&gt;InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
00673         changed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00674 
00675     }
00676 
00677     IoResourceList = IoResources-&gt;List;
00678     IoResourceListCount = IoResources-&gt;AlternativeLists;
00679     <span class="keywordflow">while</span> (--IoResourceListCount &gt;= 0) {
00680 
00681         IoResourceDescriptor = IoResourceList-&gt;Descriptors;
00682         IoResourceDescriptorEnd = IoResourceDescriptor + IoResourceList-&gt;Count;
00683 
00684         <span class="keywordflow">for</span> (;IoResourceDescriptor &lt; IoResourceDescriptorEnd; IoResourceDescriptor++) {
00685 
00686             <span class="keywordflow">if</span> (IoResourceDescriptor-&gt;Type == <a class="code" href="../../d9/d0/pnpiop_8h.html#a74">CmResourceTypeReserved</a> &amp;&amp;
00687                 IoResourceDescriptor-&gt;u.DevicePrivate.Data[0] == Internal) {
00688 
00689                 IoResourceDescriptor-&gt;u.DevicePrivate.Data[0] = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
00690                 changed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00691 
00692             }
00693         }
00694         IoResourceList = (PIO_RESOURCE_LIST) IoResourceDescriptorEnd;
00695     }
00696 
00697     <span class="keywordflow">if</span> (changed) {
00698 
00699         PCM_RESOURCE_LIST               oldResources = *AllocatedResources;
00700         PCM_RESOURCE_LIST               newResources;
00701         PCM_FULL_RESOURCE_DESCRIPTOR    cmFullDesc;
00702         PCM_PARTIAL_RESOURCE_DESCRIPTOR cmPartDesc;
00703         ULONG                           size;
00704 
00705         <span class="keywordflow">if</span> (oldResources) {
00706 
00707             size = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(oldResources);
00708             newResources = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, size);
00709             <span class="keywordflow">if</span> (newResources == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00710 
00711                 changed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00712 
00713             } <span class="keywordflow">else</span> {
00714 
00715                 ULONG   i;
00716                 ULONG   j;
00717 
00718 
00719                 RtlCopyMemory(newResources, oldResources, size);
00720 
00721                 <span class="comment">//</span>
00722                 <span class="comment">// Fix up the interface type</span>
00723                 <span class="comment">//</span>
00724 
00725                 cmFullDesc = &amp;newResources-&gt;List[0];
00726                 <span class="keywordflow">for</span> (i = 0; i &lt; oldResources-&gt;Count; i++) {
00727 
00728                     <span class="keywordflow">if</span> (cmFullDesc-&gt;InterfaceType == Internal) {
00729 
00730                         cmFullDesc-&gt;InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
00731 
00732                     }
00733                     cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
00734                     <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
00735 
00736                         size = 0;
00737                         <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
00738 
00739                         <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
00740                             size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
00741                             <span class="keywordflow">break</span>;
00742 
00743                         }
00744                         cmPartDesc++;
00745                         cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
00746                     }
00747 
00748                     cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
00749                 }
00750 
00751                 *AllocatedResources = newResources;
00752             }
00753         }
00754     }
00755 
00756     <span class="keywordflow">return</span> changed;
00757 }
00758 
00759 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00760"></a><a class="code" href="../../d1/d8/report_8c.html#a15">00760</a> <a class="code" href="../../d1/d8/report_8c.html#a15">IopWriteResourceList</a>(
00761     HANDLE ResourceMapKey,
00762     PUNICODE_STRING ClassName,
00763     PUNICODE_STRING DriverName,
00764     PUNICODE_STRING DeviceName,
00765     PCM_RESOURCE_LIST ResourceList,
00766     ULONG ResourceListSize
00767     )
00768 
00769 <span class="comment">/*++</span>
00770 <span class="comment"></span>
00771 <span class="comment">Routine Description:</span>
00772 <span class="comment"></span>
00773 <span class="comment">    This routine takes a resourcelist and stores it in the registry resource</span>
00774 <span class="comment">    map, using the ClassName, DriverName and DeviceName as the path of the</span>
00775 <span class="comment">    key to store it in.</span>
00776 <span class="comment"></span>
00777 <span class="comment">Arguments:</span>
00778 <span class="comment"></span>
00779 <span class="comment">    ResourceMapKey - Handle to the root of the resource map.</span>
00780 <span class="comment"></span>
00781 <span class="comment">    ClassName - Pointer to a Unicode String that contains the name of the Class</span>
00782 <span class="comment">        for this resource list.</span>
00783 <span class="comment"></span>
00784 <span class="comment">    DriverName - Pointer to a Unicode String that contains the name of the</span>
00785 <span class="comment">        Driver for this resource list.</span>
00786 <span class="comment"></span>
00787 <span class="comment">    DeviceName - Pointer to a Unicode String that contains the name of the</span>
00788 <span class="comment">        Device for this resource list.</span>
00789 <span class="comment"></span>
00790 <span class="comment">    ResourceList - P to the resource list.</span>
00791 <span class="comment"></span>
00792 <span class="comment">    ResourceListSize - Value determining the size of the resource list.</span>
00793 <span class="comment"></span>
00794 <span class="comment">Return Value:</span>
00795 <span class="comment"></span>
00796 <span class="comment">    The status returned is the final completion status of the operation.</span>
00797 <span class="comment"></span>
00798 <span class="comment">--*/</span>
00799 
00800 
00801 {
00802     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00803     HANDLE classKeyHandle;
00804     HANDLE driverKeyHandle;
00805 
00806     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00807 
00808     status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;classKeyHandle,
00809                                  ResourceMapKey,
00810                                  ClassName,
00811                                  KEY_READ | KEY_WRITE,
00812                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00813 
00814     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00815 
00816         <span class="comment">//</span>
00817         <span class="comment">// Take the resulting name to create the key.</span>
00818         <span class="comment">//</span>
00819 
00820         status = <a class="code" href="../../d0/d6/iop_8h.html#a198">IopOpenRegistryKey</a>( &amp;driverKeyHandle,
00821                                      classKeyHandle,
00822                                      DriverName,
00823                                      KEY_READ | KEY_WRITE,
00824                                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00825 
00826         ZwClose( classKeyHandle );
00827 
00828 
00829         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00830 
00831             <span class="comment">//</span>
00832             <span class="comment">// With this key handle, we can now store the required information</span>
00833             <span class="comment">// in the value entries of the key.</span>
00834             <span class="comment">//</span>
00835 
00836             <span class="comment">//</span>
00837             <span class="comment">// Store the device name as a value name and the device information</span>
00838             <span class="comment">// as the rest of the data.</span>
00839             <span class="comment">// Only store the information if the CM_RESOURCE_LIST was present.</span>
00840             <span class="comment">//</span>
00841 
00842             <span class="keywordflow">if</span> (ResourceList-&gt;Count == 0) {
00843 
00844                 status = ZwDeleteValueKey( driverKeyHandle,
00845                                            DeviceName );
00846 
00847             } <span class="keywordflow">else</span> {
00848 
00849                 status = ZwSetValueKey( driverKeyHandle,
00850                                         DeviceName,
00851                                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00852                                         REG_RESOURCE_LIST,
00853                                         ResourceList,
00854                                         ResourceListSize );
00855 
00856             }
00857 
00858             ZwClose( driverKeyHandle );
00859 
00860         }
00861     }
00862 
00863     <span class="keywordflow">return</span> status;
00864 }
00865 <span class="comment">//#if DBG</span>
00866 
00867 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00868"></a><a class="code" href="../../d1/d8/report_8c.html#a16">00868</a> <a class="code" href="../../d1/d8/report_8c.html#a16">IopDumpCmResourceDescriptor</a> (
00869     IN PUCHAR Indent,
00870     IN PCM_PARTIAL_RESOURCE_DESCRIPTOR Desc
00871     )
00872 <span class="comment">/*++</span>
00873 <span class="comment"></span>
00874 <span class="comment">Routine Description:</span>
00875 <span class="comment"></span>
00876 <span class="comment">    This routine processes a IO_RESOURCE_DESCRIPTOR and displays it.</span>
00877 <span class="comment"></span>
00878 <span class="comment">Arguments:</span>
00879 <span class="comment"></span>
00880 <span class="comment">    Indent - # char of indentation.</span>
00881 <span class="comment"></span>
00882 <span class="comment">    Desc - supplies a pointer to the IO_RESOURCE_DESCRIPTOR to be displayed.</span>
00883 <span class="comment"></span>
00884 <span class="comment">Return Value:</span>
00885 <span class="comment"></span>
00886 <span class="comment">    None.</span>
00887 <span class="comment"></span>
00888 <span class="comment">--*/</span>
00889 {
00890     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00891 
00892     <span class="keywordflow">switch</span> (Desc-&gt;Type) {
00893         <span class="keywordflow">case</span> CmResourceTypePort:
00894             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"%sIO  Start: %x:%08x, Length:  %x\n"</span>,
00895                 Indent,
00896                 Desc-&gt;u.Port.Start.HighPart, Desc-&gt;u.Port.Start.LowPart,
00897                 Desc-&gt;u.Port.Length
00898                 );
00899             <span class="keywordflow">break</span>;
00900 
00901         <span class="keywordflow">case</span> CmResourceTypeMemory:
00902             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"%sMEM Start: %x:%08x, Length:  %x\n"</span>,
00903                 Indent,
00904                 Desc-&gt;u.Memory.Start.HighPart, Desc-&gt;u.Memory.Start.LowPart,
00905                 Desc-&gt;u.Memory.Length
00906                 );
00907             <span class="keywordflow">break</span>;
00908 
00909         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
00910             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"%sINT Level: %x, Vector: %x, Affinity: %x\n"</span>,
00911                 Indent,
00912                 Desc-&gt;u.Interrupt.Level,
00913                 Desc-&gt;u.Interrupt.Vector,
00914                 Desc-&gt;u.Interrupt.Affinity
00915                 );
00916             <span class="keywordflow">break</span>;
00917 
00918         <span class="keywordflow">case</span> CmResourceTypeDma:
00919             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"%sDMA Channel: %x, Port: %x\n"</span>,
00920                 Indent,
00921                 Desc-&gt;u.Dma.Channel,
00922                 Desc-&gt;u.Dma.Port
00923                 );
00924             <span class="keywordflow">break</span>;
00925     }
00926 }
00927 
00928 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00929"></a><a class="code" href="../../d1/d8/report_8c.html#a17">00929</a> <a class="code" href="../../d1/d8/report_8c.html#a17">IopDumpCmResourceList</a> (
00930     IN PCM_RESOURCE_LIST CmList
00931     )
00932 <span class="comment">/*++</span>
00933 <span class="comment"></span>
00934 <span class="comment">Routine Description:</span>
00935 <span class="comment"></span>
00936 <span class="comment">    This routine displays CM resource list.</span>
00937 <span class="comment"></span>
00938 <span class="comment">Arguments:</span>
00939 <span class="comment"></span>
00940 <span class="comment">    CmList - supplies a pointer to CM resource list</span>
00941 <span class="comment"></span>
00942 <span class="comment">Return Value:</span>
00943 <span class="comment"></span>
00944 <span class="comment">    None.</span>
00945 <span class="comment"></span>
00946 <span class="comment">--*/</span>
00947 {
00948     PCM_FULL_RESOURCE_DESCRIPTOR fullDesc;
00949     PCM_PARTIAL_RESOURCE_LIST partialDesc;
00950     PCM_PARTIAL_RESOURCE_DESCRIPTOR desc;
00951     ULONG count, i;
00952 
00953     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00954 
00955     <span class="keywordflow">if</span> (CmList-&gt;Count &gt; 0) {
00956         <span class="keywordflow">if</span> (CmList) {
00957             fullDesc = &amp;CmList-&gt;List[0];
00958             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Cm Resource List -\n"</span>);
00959             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"  List Count = %x, Bus Number = %x\n"</span>, CmList-&gt;Count, fullDesc-&gt;BusNumber);
00960             partialDesc = &amp;fullDesc-&gt;PartialResourceList;
00961             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"  Version = %x, Revision = %x, Desc count = %x\n"</span>, partialDesc-&gt;Version,
00962                      partialDesc-&gt;Revision, partialDesc-&gt;Count);
00963             count = partialDesc-&gt;Count;
00964             desc = &amp;partialDesc-&gt;PartialDescriptors[0];
00965             <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
00966                 <a class="code" href="../../d1/d8/report_8c.html#a16">IopDumpCmResourceDescriptor</a>(<span class="stringliteral">"    "</span>, desc);
00967                 desc++;
00968             }
00969         }
00970     }
00971 }
00972 <span class="comment">//#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:38 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
