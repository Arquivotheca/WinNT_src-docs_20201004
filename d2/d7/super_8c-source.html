<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: super.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>super.c</h1><a href="../../d1/d8/super_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   super.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines which implement the SuperSection</span>
00012 <span class="comment">    object.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 4-Apr-92</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00023 <span class="preprocessor">#include "zwapi.h"</span>
00024 
00025 
00026 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00027 <a class="code" href="../../d1/d8/super_8c.html#a7">MiSuperSectionDelete</a> (
00028     PVOID Object
00029     );
00030 
00031 BOOLEAN
00032 <a class="code" href="../../d1/d8/super_8c.html#a8">MiSuperSectionInitialization</a> (
00033     );
00034 
00035 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiSuperSectionInitialization)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00038 <span class="preprocessor"></span>
<a name="l00039"></a><a class="code" href="../../d1/d8/super_8c.html#a0">00039</a> <span class="preprocessor">#define MM_MAX_SUPERSECTION_COUNT (32)</span>
00040 <span class="preprocessor"></span>
<a name="l00041"></a><a class="code" href="../../d1/d8/super_8c.html#a3">00041</a> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d1/d8/super_8c.html#a3">MmSuperSectionObjectType</a>;
00042 
<a name="l00043"></a><a class="code" href="../../d1/d8/super_8c.html#a1">00043</a> <span class="preprocessor">#define STATUS_TOO_MANY_SECTIONS ((NTSTATUS)0xC0033333)</span>
<a name="l00044"></a><a class="code" href="../../d1/d8/super_8c.html#a2">00044</a> <span class="preprocessor"></span><span class="preprocessor">#define STATUS_INCOMPLETE_MAP    ((NTSTATUS)0xC0033334)</span>
00045 <span class="preprocessor"></span>
00046 
<a name="l00047"></a><a class="code" href="../../d1/d8/super_8c.html#a4">00047</a> <span class="keyword">extern</span> GENERIC_MAPPING <a class="code" href="../../d5/d5/sectsup_8c.html#a7">MiSectionMapping</a>;
00048 
<a name="l00049"></a><a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html">00049</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html">_MMSUPER_SECTION</a> {
<a name="l00050"></a><a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html#o0">00050</a>     ULONG <a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html#o0">NumberOfSections</a>;
<a name="l00051"></a><a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html#o1">00051</a>     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> <a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html#o1">SectionPointers</a>[1];
00052 } <a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html">MMSUPER_SECTION</a>, *<a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html">PMMSUPER_SECTION</a>;
00053 
00054 
00055 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00056"></a><a class="code" href="../../d1/d8/super_8c.html#a9">00056</a> <a class="code" href="../../d1/d8/super_8c.html#a9">NtCreateSuperSection</a> (
00057     OUT PHANDLE SuperSectionHandle,
00058     IN ACCESS_MASK DesiredAccess,
00059     IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
00060     IN ULONG Count,
00061     IN HANDLE SectionHandles[]
00062     )
00063 
00064 <span class="comment">/*++</span>
00065 <span class="comment"></span>
00066 <span class="comment">Routine Description:</span>
00067 <span class="comment"></span>
00068 <span class="comment">    This routine creates a super section object.  A supersection</span>
00069 <span class="comment">    object consists a group of sections that are mapped as images.</span>
00070 <span class="comment"></span>
00071 <span class="comment">Arguments:</span>
00072 <span class="comment"></span>
00073 <span class="comment">    SuperSectionHandle - Returns a handle to the created supersection.</span>
00074 <span class="comment"></span>
00075 <span class="comment">    DesiredAccess - Supplies the desired access for the super section.</span>
00076 <span class="comment"></span>
00077 <span class="comment">    ObjectAttributes - Supplies the object attributes for the super</span>
00078 <span class="comment">                       section.</span>
00079 <span class="comment"></span>
00080 <span class="comment">    Count - Supplies the number of sections contained in the section</span>
00081 <span class="comment">            handle array.</span>
00082 <span class="comment"></span>
00083 <span class="comment">    SectionHandles[] - Supplies the section handles to place into</span>
00084 <span class="comment">                       the supersection.</span>
00085 <span class="comment"></span>
00086 <span class="comment"></span>
00087 <span class="comment">Return Value:</span>
00088 <span class="comment"></span>
00089 <span class="comment">    Returns the status</span>
00090 <span class="comment"></span>
00091 <span class="comment">    TBS</span>
00092 <span class="comment"></span>
00093 <span class="comment">--*/</span>
00094 
00095 {
00096     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00097     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> Section;
00098     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00099     HANDLE CapturedHandle;
00100     HANDLE CapturedHandles[<a class="code" href="../../d1/d8/super_8c.html#a0">MM_MAX_SUPERSECTION_COUNT</a>];
00101     <a class="code" href="../../d1/d8/super_8c.html#a6">PMMSUPER_SECTION</a> SuperSection;
00102     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00103     ULONG <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a>;
00104     ULONG i;
00105     KIRQL OldIrql;
00106 
00107     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &gt; <a class="code" href="../../d1/d8/super_8c.html#a0">MM_MAX_SUPERSECTION_COUNT</a>) {
00108         <span class="keywordflow">return</span> <a class="code" href="../../d1/d8/super_8c.html#a1">STATUS_TOO_MANY_SECTIONS</a>;
00109     }
00110 
00111     <span class="keywordflow">try</span> {
00112 
00113         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00114             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a> (SuperSectionHandle);
00115         }
00116 
00117         i= 0;
00118         <span class="keywordflow">do</span> {
00119             CapturedHandles[i] = SectionHandles[i];
00120             i += 1;
00121         } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00122 
00123     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00124 
00125         <span class="comment">//</span>
00126         <span class="comment">// If an exception occurs during the probe or capture</span>
00127         <span class="comment">// of the initial values, then handle the exception and</span>
00128         <span class="comment">// return the exception code as the status value.</span>
00129         <span class="comment">//</span>
00130 
00131         <span class="keywordflow">return</span> GetExceptionCode();
00132     }
00133 
00134     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a> (PreviousMode,
00135                              <a class="code" href="../../d1/d8/super_8c.html#a3">MmSuperSectionObjectType</a>,
00136                              <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00137                              PreviousMode,
00138                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00139                              <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html">MMSUPER_SECTION</a>) +
00140                                        (<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>) * (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - 1)),
00141                              <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/super_8c.html#a5">MMSUPER_SECTION</a>) +
00142                                        (<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>) * (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - 1)),
00143                              0,
00144                              (PVOID *)&amp;SuperSection);
00145 
00146     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00147         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00148     }
00149 
00150     SuperSection-&gt;NumberOfSections = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00151 
00152     i = 0;
00153     <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a> = 0;
00154     <span class="keywordflow">do</span> {
00155 
00156         <span class="comment">//</span>
00157         <span class="comment">// Get a referenced pointer to the specified objects with</span>
00158         <span class="comment">// the desired access.</span>
00159         <span class="comment">//</span>
00160 
00161         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(CapturedHandles[i],
00162                                            DesiredAccess,
00163                                            <a class="code" href="../../d2/d1/mm_8h.html#a133">MmSectionObjectType</a>,
00164                                            PreviousMode,
00165                                            (PVOID *)&amp;Section,
00166                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00167 
00168         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00169             <span class="keywordflow">if</span> (Section-&gt;u.Flags.Image == 0) {
00170 
00171                 <span class="comment">//</span>
00172                 <span class="comment">// This is not an image section, return an error.</span>
00173                 <span class="comment">//</span>
00174 
00175                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SECTION_NOT_IMAGE;
00176                 <span class="keywordflow">goto</span> ServiceFailed;
00177             }
00178             <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a> += 1;
00179             SuperSection-&gt;SectionPointers[i] = Section;
00180         } <span class="keywordflow">else</span> {
00181             <span class="keywordflow">goto</span> ServiceFailed;
00182         }
00183 
00184         i += 1;
00185     } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00186 
00187     i= 0;
00188     <span class="keywordflow">do</span> {
00189 
00190         <span class="comment">//</span>
00191         <span class="comment">// For each section increment the number of section references</span>
00192         <span class="comment">// count.</span>
00193         <span class="comment">//</span>
00194 
00195         ControlArea = SuperSection-&gt;SectionPointers[i]-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
00196 
00197         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00198         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> += 1;
00199         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> += 1;
00200         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00201         i++;
00202 
00203     } <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00204 
00205 
00206     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a> (SuperSection,
00207                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00208                              DesiredAccess,
00209                              0,
00210                              (PVOID *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00211                              &amp;CapturedHandle);
00212 
00213     <span class="keywordflow">try</span> {
00214         *SuperSectionHandle = CapturedHandle;
00215     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00216         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00217     }
00218     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00219 
00220 ServiceFailed:
00221     <span class="keywordflow">while</span> (<a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a> &gt; 0) {
00222         <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a> -= 1;
00223         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(SuperSection-&gt;SectionPointers[<a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a>]);
00224     }
00225 
00226     <span class="comment">//</span>
00227     <span class="comment">// Delete the supersection object as it was never inserted into</span>
00228     <span class="comment">// a handle table.</span>
00229     <span class="comment">//</span>
00230 
00231     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SuperSection);
00232     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00233 }
00234 
00235 
00236 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00237"></a><a class="code" href="../../d1/d8/super_8c.html#a10">00237</a> <a class="code" href="../../d1/d8/super_8c.html#a10">NtOpenSuperSection</a> (
00238     OUT PHANDLE SuperSectionHandle,
00239     IN ACCESS_MASK DesiredAccess,
00240     IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
00241     )
00242 
00243 <span class="comment">/*++</span>
00244 <span class="comment"></span>
00245 <span class="comment">Routine Description:</span>
00246 <span class="comment"></span>
00247 <span class="comment">    This routine opens a super section object.  A supersection</span>
00248 <span class="comment">    object consists a group of sections that are mapped as images.</span>
00249 <span class="comment"></span>
00250 <span class="comment">Arguments:</span>
00251 <span class="comment"></span>
00252 <span class="comment">    SuperSectionHandle - Returns a handle to the created supersection.</span>
00253 <span class="comment"></span>
00254 <span class="comment">    DesiredAccess - Supplies the desired access for the super section.</span>
00255 <span class="comment"></span>
00256 <span class="comment">    ObjectAttributes - Supplies the object attributes for the super</span>
00257 <span class="comment">                       section.</span>
00258 <span class="comment"></span>
00259 <span class="comment"></span>
00260 <span class="comment">Return Value:</span>
00261 <span class="comment"></span>
00262 <span class="comment">    Returns the status</span>
00263 <span class="comment"></span>
00264 <span class="comment">    TBS</span>
00265 <span class="comment"></span>
00266 <span class="comment">--*/</span>
00267 
00268 {
00269     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00270     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00271     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00272 
00273     <span class="comment">//</span>
00274     <span class="comment">// Get previous processor mode and probe output arguments if necessary.</span>
00275     <span class="comment">//</span>
00276 
00277     PreviousMode = KeGetPreviousMode();
00278     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00279         <span class="keywordflow">try</span> {
00280             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(SuperSectionHandle);
00281         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00282             <span class="keywordflow">return</span> GetExceptionCode();
00283         }
00284     }
00285 
00286     <span class="comment">//</span>
00287     <span class="comment">// Open handle to the super section object with the specified desired</span>
00288     <span class="comment">// access.</span>
00289     <span class="comment">//</span>
00290 
00291     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00292                                  <a class="code" href="../../d1/d8/super_8c.html#a3">MmSuperSectionObjectType</a>,
00293                                  PreviousMode,
00294                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00295                                  DesiredAccess,
00296                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00297                                  &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>
00298                                  );
00299 
00300     <span class="keywordflow">try</span> {
00301         *SuperSectionHandle = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00302     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00303         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00304     }
00305 
00306     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00307 }
00308 
00309 
00310 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00311"></a><a class="code" href="../../d1/d8/super_8c.html#a11">00311</a> <a class="code" href="../../d1/d8/super_8c.html#a11">NtMapViewOfSuperSection</a> (
00312     IN HANDLE SuperSectionHandle,
00313     IN HANDLE ProcessHandle,
00314     IN OUT PULONG Count,
00315     OUT PVOID BaseAddress[],
00316     OUT ULONG ViewSize[],
00317     IN SECTION_INHERIT InheritDisposition,
00318     )
00319 
00320 <span class="comment">/*++</span>
00321 <span class="comment"></span>
00322 <span class="comment">Routine Description:</span>
00323 <span class="comment"></span>
00324 <span class="comment">    This routine maps into the specified process a view of each</span>
00325 <span class="comment">    section contained within the supersection.</span>
00326 <span class="comment"></span>
00327 <span class="comment">Arguments:</span>
00328 <span class="comment"></span>
00329 <span class="comment">    SuperSectionHandle - Supplies a handle to the supersection.</span>
00330 <span class="comment"></span>
00331 <span class="comment">    ProcessHandle - Supplies a handle to the process in which to</span>
00332 <span class="comment">                    map the supersection's sections.</span>
00333 <span class="comment"></span>
00334 <span class="comment">    Count - Supplies the number of elements in the BaseAddress and</span>
00335 <span class="comment">            ViewSize arrays, returns the number of views actually</span>
00336 <span class="comment">            mapped.</span>
00337 <span class="comment"></span>
00338 <span class="comment"></span>
00339 <span class="comment">    BaseAddresses[] - Returns the base address of each view that was mapped.</span>
00340 <span class="comment"></span>
00341 <span class="comment">    ViewSize[] - Returns the view size of each view that was mapped.</span>
00342 <span class="comment"></span>
00343 <span class="comment">    InheritDisposition - Supplies the inherit disposition to be applied</span>
00344 <span class="comment">                         to each section which is contained in the</span>
00345 <span class="comment">                         super section.</span>
00346 <span class="comment"></span>
00347 <span class="comment">Return Value:</span>
00348 <span class="comment"></span>
00349 <span class="comment">    Returns the status</span>
00350 <span class="comment"></span>
00351 <span class="comment">    TBS</span>
00352 <span class="comment"></span>
00353 <span class="comment">--*/</span>
00354 
00355 {
00356     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00357     PVOID CapturedBases[<a class="code" href="../../d1/d8/super_8c.html#a0">MM_MAX_SUPERSECTION_COUNT</a>];
00358     ULONG CapturedViews[<a class="code" href="../../d1/d8/super_8c.html#a0">MM_MAX_SUPERSECTION_COUNT</a>];
00359     <a class="code" href="../../d1/d8/super_8c.html#a6">PMMSUPER_SECTION</a> SuperSection;
00360     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00361     ULONG i;
00362     ULONG CapturedCount;
00363     ULONG NumberMapped;
00364     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00365     LARGE_INTEGER LargeZero = {0,0};
00366 
00367 
00368     PreviousMode = KeGetPreviousMode();
00369 
00370     <span class="keywordflow">try</span> {
00371         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00372         CapturedCount = *<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00373 
00374         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00375             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> (BaseAddress,
00376                            <span class="keyword">sizeof</span>(PVOID) * CapturedCount,
00377                            <span class="keyword">sizeof</span>(PVOID));
00378             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> (ViewSize,
00379                            <span class="keyword">sizeof</span>(ULONG) * CapturedCount,
00380                            <span class="keyword">sizeof</span>(ULONG));
00381         }
00382 
00383     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00384 
00385         <span class="comment">//</span>
00386         <span class="comment">// If an exception occurs during the probe or capture</span>
00387         <span class="comment">// of the initial values, then handle the exception and</span>
00388         <span class="comment">// return the exception code as the status value.</span>
00389         <span class="comment">//</span>
00390 
00391         <span class="keywordflow">return</span> GetExceptionCode();
00392     }
00393 
00394     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( ProcessHandle,
00395                                          PROCESS_VM_OPERATION,
00396                                          <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00397                                          PreviousMode,
00398                                          (PVOID *)&amp;Process,
00399                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00400     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00401         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00402     }
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// Reference the supersection object.</span>
00406     <span class="comment">//</span>
00407 
00408     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( SuperSectionHandle,
00409                                          SECTION_MAP_EXECUTE,
00410                                          <a class="code" href="../../d1/d8/super_8c.html#a3">MmSuperSectionObjectType</a>,
00411                                          PreviousMode,
00412                                          (PVOID *)&amp;SuperSection,
00413                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00414 
00415     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00416         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
00417         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00418     }
00419 
00420     <span class="keywordflow">if</span> (CapturedCount &lt; SuperSection-&gt;NumberOfSections) {
00421         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
00422         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SuperSection);
00423         <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00424     }
00425 
00426     NumberMapped = 0;
00427     <span class="keywordflow">do</span> {
00428 
00429         <span class="comment">//</span>
00430         <span class="comment">// For each section within the supersection, map a view in</span>
00431         <span class="comment">// the specified process.</span>
00432         <span class="comment">//</span>
00433 
00434         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a> (SuperSection-&gt;SectionPointers[i],
00435                                      Process,
00436                                      &amp;CapturedBases[i],
00437                                      0,
00438                                      0,
00439                                      &amp;LargeZero,
00440                                      &amp;CapturedViews[i],
00441                                      InheritDisposition,
00442                                      0,
00443                                      PAGE_EXECUTE);
00444 
00445         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00446             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/super_8c.html#a2">STATUS_INCOMPLETE_MAP</a>;
00447             <span class="keywordflow">break</span>;
00448         }
00449         NumberMapped++;
00450     } <span class="keywordflow">while</span> (NumberMapped &lt; SuperSection-&gt;NumberOfSections);
00451 
00452     <span class="comment">//</span>
00453     <span class="comment">// Dereference the supersection and the process.</span>
00454     <span class="comment">//</span>
00455 
00456     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SuperSection);
00457     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
00458 
00459     <span class="keywordflow">try</span> {
00460         *<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = NumberMapped;
00461         i = 0;
00462 
00463         <span class="keywordflow">do</span> {
00464 
00465             <span class="comment">//</span>
00466             <span class="comment">// Store the captured view base and sizes for each section</span>
00467             <span class="comment">// that was mapped.</span>
00468             <span class="comment">//</span>
00469 
00470             BaseAddress[i] = CapturedBases[i];
00471             ViewSize[i] = CapturedViews[i];
00472 
00473             i++;
00474         } <span class="keywordflow">while</span> (i &lt; NumberMapped);
00475 
00476     } except (<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00477         NOTHING;
00478     }
00479 
00480     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00481 }
00482 
00483 
00484 
00485 <span class="preprocessor">#if 0</span>
00486 <span class="preprocessor"></span>
00487 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00488 NtQuerySuperSection (
00489     IN HANDLE SuperSectionHandle,
00490     IN SUPERSECTION_INFORMATION_CLASS SectionInformationClass,
00491     OUT PVOID SuperSectionInformation,
00492     IN ULONG SuperSectionInformationLength,
00493     OUT PULONG ReturnLength OPTIONAL
00494     )
00495 
00496 Routine <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a>:
00497 
00498    This function returns information about an opened supersection object.
00499    This function provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> capability to determine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> basic section
00500    information about each section in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supersection or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image
00501    information about each section in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supersection.
00502 
00503 Arguments:
00504 
00505     SuperSectionHandle - Supplies an open handle to a section object.
00506 
00507     SectionInformationClass - The section information <span class="keyword">class </span>about
00508         which to retrieve information.
00509 
00510     SuperSectionInformation - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a buffer that receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00511         specified information.  The <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> and content of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer
00512         depend on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section class.
00513 
00514 
00515     SuperSectionInformationLength - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00516         section information buffer.
00517 
00518     ReturnLength - An optional pointer which, if specified, receives
00519         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section information buffer.
00520 
00521 
00522 Return Value:
00523 
00524     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
00525 
00526     TBS
00527 
00528 
00529 --*/
00530 
00531 
00532 #endif <span class="comment">//0</span>
00533 
00534 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00535"></a><a class="code" href="../../d1/d8/super_8c.html#a7">00535</a> <a class="code" href="../../d1/d8/super_8c.html#a7">MiSuperSectionDelete</a> (
00536     PVOID Object
00537     )
00538 
00539 <span class="comment">/*++</span>
00540 <span class="comment"></span>
00541 <span class="comment">Routine Description:</span>
00542 <span class="comment"></span>
00543 <span class="comment"></span>
00544 <span class="comment">    This routine is called by the object management procedures whenever</span>
00545 <span class="comment">    the last reference to a super section object has been removed.</span>
00546 <span class="comment">    This routine dereferences the associated segment objects.</span>
00547 <span class="comment"></span>
00548 <span class="comment">Arguments:</span>
00549 <span class="comment"></span>
00550 <span class="comment">    Object - a pointer to the body of the supersection object.</span>
00551 <span class="comment"></span>
00552 <span class="comment">Return Value:</span>
00553 <span class="comment"></span>
00554 <span class="comment">    None.</span>
00555 <span class="comment"></span>
00556 <span class="comment">--*/</span>
00557 
00558 {
00559     <a class="code" href="../../d1/d8/super_8c.html#a6">PMMSUPER_SECTION</a> SuperSection;
00560     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00561     KIRQL OldIrql;
00562     ULONG i = 0;
00563 
00564     SuperSection = (<a class="code" href="../../d1/d8/super_8c.html#a6">PMMSUPER_SECTION</a>)Object;
00565 
00566     <span class="keywordflow">do</span> {
00567 
00568         <span class="comment">//</span>
00569         <span class="comment">// For each section increment the number of section references</span>
00570         <span class="comment">// count.</span>
00571         <span class="comment">//</span>
00572 
00573         ControlArea = SuperSection-&gt;<a class="code" href="../../d2/d6/struct__MMSUPER__SECTION.html#o1">SectionPointers</a>[i]-&gt;Segment-&gt;ControlArea;
00574 
00575         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00576         ControlArea-&gt;NumberOfSectionReferences -= 1;
00577         ControlArea-&gt;NumberOfUserReferences -= 1;
00578         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00579         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SuperSection-&gt;SectionPointers[i]);
00580         i++;
00581 
00582     } <span class="keywordflow">while</span> (i &lt; SuperSection-&gt;NumberOfSections);
00583 
00584     <span class="keywordflow">return</span>;
00585 }
00586 
00587 BOOLEAN
<a name="l00588"></a><a class="code" href="../../d1/d8/super_8c.html#a8">00588</a> <a class="code" href="../../d1/d8/super_8c.html#a8">MiSuperSectionInitialization</a> (
00589     )
00590 
00591 <span class="comment">/*++</span>
00592 <span class="comment"></span>
00593 <span class="comment">Routine Description:</span>
00594 <span class="comment"></span>
00595 <span class="comment">    This function creates the section object type descriptor at system</span>
00596 <span class="comment">    initialization and stores the address of the object type descriptor</span>
00597 <span class="comment">    in global storage.</span>
00598 <span class="comment"></span>
00599 <span class="comment">Arguments:</span>
00600 <span class="comment"></span>
00601 <span class="comment">    None.</span>
00602 <span class="comment"></span>
00603 <span class="comment">Return Value:</span>
00604 <span class="comment"></span>
00605 <span class="comment">    TRUE - Initialization was successful.</span>
00606 <span class="comment"></span>
00607 <span class="comment">    FALSE - Initialization Failed.</span>
00608 <span class="comment"></span>
00609 <span class="comment"></span>
00610 <span class="comment"></span>
00611 <span class="comment">--*/</span>
00612 
00613 {
00614     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
00615     UNICODE_STRING TypeName;
00616 
00617     <span class="comment">//</span>
00618     <span class="comment">// Initialize the common fields of the Object Type Initializer record</span>
00619     <span class="comment">//</span>
00620 
00621     RtlZeroMemory( &amp;ObjectTypeInitializer, <span class="keyword">sizeof</span>( ObjectTypeInitializer ) );
00622     ObjectTypeInitializer.Length = <span class="keyword">sizeof</span>( ObjectTypeInitializer );
00623     ObjectTypeInitializer.InvalidAttributes = OBJ_OPENLINK;
00624     ObjectTypeInitializer.GenericMapping = <a class="code" href="../../d5/d5/sectsup_8c.html#a7">MiSectionMapping</a>;
00625     ObjectTypeInitializer.PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
00626 
00627     <span class="comment">//</span>
00628     <span class="comment">// Initialize string descriptor.</span>
00629     <span class="comment">//</span>
00630 
00631     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;TypeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SuperSection"</span>);
00632 
00633     <span class="comment">//</span>
00634     <span class="comment">// Create the section object type descriptor</span>
00635     <span class="comment">//</span>
00636 
00637     ObjectTypeInitializer.ValidAccessMask = SECTION_ALL_ACCESS;
00638     ObjectTypeInitializer.DeleteProcedure = <a class="code" href="../../d1/d8/super_8c.html#a7">MiSuperSectionDelete</a>;
00639     ObjectTypeInitializer.GenericMapping = <a class="code" href="../../d5/d5/sectsup_8c.html#a7">MiSectionMapping</a>;
00640     ObjectTypeInitializer.UseDefaultObject = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00641     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;TypeName,
00642                                      &amp;ObjectTypeInitializer,
00643                                      (PSECURITY_DESCRIPTOR) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00644                                      &amp;<a class="code" href="../../d1/d8/super_8c.html#a3">MmSuperSectionObjectType</a>
00645                                      )) ) {
00646         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00647     }
00648 
00649     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00650 
00651 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:54 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
