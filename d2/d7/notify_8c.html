<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: notify.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>notify.c File Reference</h1><code>#include "FsRtlP.h"</code><br>

<p>
<a href="../../d3/d6/notify_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">_REAL_NOTIFY_SYNC</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/struct__NOTIFY__CHANGE.html">_NOTIFY_CHANGE</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a0">Dbg</a>&nbsp;&nbsp;&nbsp;(0x04000000)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a1">NOTIFY_WATCH_TREE</a>&nbsp;&nbsp;&nbsp;(0x0001)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a2">NOTIFY_IMMEDIATE_NOTIFY</a>&nbsp;&nbsp;&nbsp;(0x0002)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a3">NOTIFY_CLEANUP_CALLED</a>&nbsp;&nbsp;&nbsp;(0x0004)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a4">NOTIFY_DEFER_NOTIFY</a>&nbsp;&nbsp;&nbsp;(0x0008)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a5">NOTIFY_DIR_IS_ROOT</a>&nbsp;&nbsp;&nbsp;(0x0010)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a6">NOTIFY_STREAM_IS_DELETED</a>&nbsp;&nbsp;&nbsp;(0x0020)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>(PTR, INC, CAST)&nbsp;&nbsp;&nbsp;((CAST)((PUCHAR)(PTR) + (INC)))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a8">PtrOffset</a>(BASE, OFFSET)&nbsp;&nbsp;&nbsp;((ULONG)((PCHAR)(OFFSET) - (PCHAR)(BASE)))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a9">SetFlag</a>(F, SF)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a10">ClearFlag</a>(F, SF)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a11">AcquireNotifySync</a>(NS)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a12">ReleaseNotifySync</a>(NS)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a13">MODULE_POOL_TAG</a>&nbsp;&nbsp;&nbsp;('NrSF')</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">_REAL_NOTIFY_SYNC</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a14">REAL_NOTIFY_SYNC</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">_REAL_NOTIFY_SYNC</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a15">PREAL_NOTIFY_SYNC</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d3/struct__NOTIFY__CHANGE.html">_NOTIFY_CHANGE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a16">NOTIFY_CHANGE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d3/struct__NOTIFY__CHANGE.html">_NOTIFY_CHANGE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a18">FsRtlIsNotifyOnList</a> (IN PLIST_ENTRY NotifyListHead, IN PVOID FsContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a19">FsRtlNotifyCompleteIrp</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> NotifyIrp, IN <a class="el" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a> Notify, IN ULONG DataLength, IN NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>, IN ULONG CheckCancel)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a20">FsRtlNotifySetCancelRoutine</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> NotifyIrp, IN <a class="el" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a> Notify OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a21">FsRtlNotifyUpdateBuffer</a> (IN PFILE_NOTIFY_INFORMATION NotifyInfo, IN ULONG FileAction, IN PSTRING ParentName, IN PSTRING TargetName, IN PSTRING StreamName OPTIONAL, IN BOOLEAN UnicodeName, IN ULONG SizeOfEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a22">FsRtlNotifyCompleteIrpList</a> (IN <a class="el" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a> Notify, IN NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a23">FsRtlCancelNotify</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> ThisIrp)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a24">FsRtlCheckNotifyForDelete</a> (IN PLIST_ENTRY NotifyListHead, IN PVOID FsContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a25">FsRtlNotifyInitializeSync</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> *NotifySync)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a26">FsRtlNotifyUninitializeSync</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> *NotifySync)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a27">FsRtlNotifyChangeDirectory</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> NotifySync, IN PVOID FsContext, IN PSTRING FullDirectoryName, IN PLIST_ENTRY NotifyList, IN BOOLEAN <a class="el" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>, IN ULONG CompletionFilter, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> NotifyIrp)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a28">FsRtlNotifyFullChangeDirectory</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> NotifySync, IN PLIST_ENTRY NotifyList, IN PVOID FsContext, IN PSTRING FullDirectoryName, IN BOOLEAN <a class="el" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>, IN BOOLEAN IgnoreBuffer, IN ULONG CompletionFilter, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> NotifyIrp, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a82">PCHECK_FOR_TRAVERSE_ACCESS</a> TraverseCallback OPTIONAL, IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a29">FsRtlNotifyReportChange</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> NotifySync, IN PLIST_ENTRY NotifyList, IN PSTRING FullTargetName, IN PSTRING TargetName, IN ULONG FilterMatch)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a30">FsRtlNotifyFullReportChange</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> NotifySync, IN PLIST_ENTRY NotifyList, IN PSTRING FullTargetName, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> TargetNameOffset, IN PSTRING StreamName OPTIONAL, IN PSTRING NormalizedParentName OPTIONAL, IN ULONG FilterMatch, IN ULONG <a class="el" href="../../d9/d3/rules_8c.html#a7">Action</a>, IN PVOID TargetContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a31">FsRtlNotifyCleanup</a> (IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> NotifySync, IN PLIST_ENTRY NotifyList, IN PVOID FsContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/notify_8c.html#a32">FsRtlNotifyCompleteIrpList</a> (IN OUT <a class="el" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a> Notify, IN NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a11" doxytag="notify.c::AcquireNotifySync" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define AcquireNotifySync          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">NS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                             \
    <a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> _CurrentThread;                                        \
    _CurrentThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>) <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();               \
    <span class="keywordflow">if</span> (_CurrentThread != ((<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">PREAL_NOTIFY_SYNC</a>) (NS))-&gt;OwningThread) {       \
        <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a>( &amp;((<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">PREAL_NOTIFY_SYNC</a>) (NS))-&gt;FastMutex ); \
        ((<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">PREAL_NOTIFY_SYNC</a>) (NS))-&gt;OwningThread = _CurrentThread;          \
    }                                                                       \
    ((<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">PREAL_NOTIFY_SYNC</a>) (NS))-&gt;OwnerCount += 1;                            \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00274">274</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l02555">FsRtlCancelNotify()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l01795">FsRtlNotifyCleanup()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00973">FsRtlNotifyFullReportChange()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="notify.c::Add2Ptr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Add2Ptr          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PTR,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>INC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>CAST&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((CAST)((PUCHAR)(PTR) + (INC)))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">236</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l00973">FsRtlNotifyFullReportChange()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02286">FsRtlNotifyUpdateBuffer()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00339">LfsCopyReadLogRecord()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00809">LfsFindLogRecord()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00551">LfsFlushLfcb()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00150">LfsInitializeLogFile()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l02046">LfsIsClientAreaValid()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l01885">LfsIsRestartAreaValid()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00248">LfsPinOrMapLogRecordHeader()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00072">LfsReadLogRecord()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l01402">LfsReadRestart()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">LfsReadRestartArea()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00447">LfsSetBaseLsn()</a>, <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00556">LfsTransferLogBytes()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02697">LfsUpdateLfcbFromRestart()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l02964">LfsUpdateRestartAreaFromLfcb()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01273">LfsVerifyLogFile()</a>, <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">LfsWriteLfsRestart()</a>, <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00055">LfsWriteLogRecordIntoLogPage()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">LfsWriteRestartArea()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00096">UdfDissectName()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01280">UdfFinishBuffers()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04103">UdfGetNextAllocation()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04144">UdfGetNextAllocationPostProcessing()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04013">UdfInitializeAllocationContext()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00367">UdfInitializePcb()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00064">UdfInsertPrefix()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01406">UdfLoadSparingTables()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03790">UdfLookupActiveIcbInExtent()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00916">UdfLookupDirEntryPostProcessing()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03278">UdfLookupEa()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00165">UdfLookupInitialDirEntry()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00287">UdfLookupNextDirEntry()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00201">UdfNonCachedRead()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00809">UdfNormalizeFileNames()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00883">UdfPrepareBuffers()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>, and <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00360">UdfUpdateDirNames()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="notify.c::ClearFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ClearFlag          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">F,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SF&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{   \
    (F) &amp;= ~(SF);           \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00258">258</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="notify.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(0x04000000)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00067">67</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="notify.c::MODULE_POOL_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MODULE_POOL_TAG&nbsp;&nbsp;&nbsp;('NrSF')          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00297">297</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="notify.c::NOTIFY_CLEANUP_CALLED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NOTIFY_CLEANUP_CALLED&nbsp;&nbsp;&nbsp;(0x0004)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00216">216</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l01795">FsRtlNotifyCleanup()</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="notify.c::NOTIFY_DEFER_NOTIFY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NOTIFY_DEFER_NOTIFY&nbsp;&nbsp;&nbsp;(0x0008)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00217">217</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00973">FsRtlNotifyFullReportChange()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="notify.c::NOTIFY_DIR_IS_ROOT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NOTIFY_DIR_IS_ROOT&nbsp;&nbsp;&nbsp;(0x0010)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00218">218</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00973">FsRtlNotifyFullReportChange()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="notify.c::NOTIFY_IMMEDIATE_NOTIFY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NOTIFY_IMMEDIATE_NOTIFY&nbsp;&nbsp;&nbsp;(0x0002)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00215">215</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l02555">FsRtlCancelNotify()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02467">FsRtlNotifyCompleteIrpList()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00973">FsRtlNotifyFullReportChange()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="notify.c::NOTIFY_STREAM_IS_DELETED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NOTIFY_STREAM_IS_DELETED&nbsp;&nbsp;&nbsp;(0x0020)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00219">219</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l02873">FsRtlCheckNotifyForDelete()</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="notify.c::NOTIFY_WATCH_TREE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NOTIFY_WATCH_TREE&nbsp;&nbsp;&nbsp;(0x0001)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00214">214</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00973">FsRtlNotifyFullReportChange()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="notify.c::PtrOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PtrOffset          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">BASE,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OFFSET&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((ULONG)((PCHAR)(OFFSET) - (PCHAR)(BASE)))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00238">238</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00366">LfsOpenLogFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="notify.c::ReleaseNotifySync" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ReleaseNotifySync          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">NS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                             \
    ((<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">PREAL_NOTIFY_SYNC</a>) (NS))-&gt;OwnerCount -= 1;                            \
    <span class="keywordflow">if</span> (((<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">PREAL_NOTIFY_SYNC</a>) (NS))-&gt;OwnerCount == 0) {                      \
        ((<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">PREAL_NOTIFY_SYNC</a>) (NS))-&gt;OwningThread = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>) 0;    \
        <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a>(&amp;((<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">PREAL_NOTIFY_SYNC</a>) (NS))-&gt;FastMutex);   \
    }                                                                       \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00284">284</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l02555">FsRtlCancelNotify()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l01795">FsRtlNotifyCleanup()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00973">FsRtlNotifyFullReportChange()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="notify.c::SetFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SetFlag          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">F,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SF&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{     \
    (F) |= (SF);            \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00254">254</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a16" doxytag="notify.c::NOTIFY_CHANGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d3/struct__NOTIFY__CHANGE.html">_NOTIFY_CHANGE</a>  <a class="el" href="../../d9/d3/struct__NOTIFY__CHANGE.html">NOTIFY_CHANGE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="notify.c::PNOTIFY_CHANGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d3/struct__NOTIFY__CHANGE.html">_NOTIFY_CHANGE</a> * <a class="el" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l02555">FsRtlCancelNotify()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02873">FsRtlCheckNotifyForDelete()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l01920">FsRtlIsNotifyOnList()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l01795">FsRtlNotifyCleanup()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00973">FsRtlNotifyFullReportChange()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="notify.c::PREAL_NOTIFY_SYNC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">_REAL_NOTIFY_SYNC</a> * <a class="el" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">PREAL_NOTIFY_SYNC</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00371">FsRtlNotifyInitializeSync()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="notify.c::REAL_NOTIFY_SYNC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">_REAL_NOTIFY_SYNC</a>  <a class="el" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">REAL_NOTIFY_SYNC</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a23" doxytag="notify.c::FsRtlCancelNotify" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlCancelNotify           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ThisIrp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l02555">2555</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00274">AcquireNotifySync</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00187">_NOTIFY_CHANGE::AllocatedBuffer</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00188">_NOTIFY_CHANGE::Buffer</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00189">_NOTIFY_CHANGE::BufferLength</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00191">_NOTIFY_CHANGE::DataLength</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00056">EXCEPTION_CONTINUE_SEARCH</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00159">_NOTIFY_CHANGE::Flags</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">FsRtlEnterFileSystem</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">FsRtlExitFileSystem</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00082">FsRtlIsNtstatusExpected()</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00040">FsRtlpAllocatePool</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00139">_NOTIFY_CHANGE::FullDirectoryName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00192">_NOTIFY_CHANGE::LastEntry</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01874">MmGetSystemAddressForMdl</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00215">NOTIFY_IMMEDIATE_NOTIFY</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00153">_NOTIFY_CHANGE::NotifyIrps</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00094">_NOTIFY_CHANGE::NotifySync</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00210">_NOTIFY_CHANGE::OwningProcess</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01443">PNOTIFY_SYNC</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00246">PsChargePoolQuota()</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00203">_NOTIFY_CHANGE::ReferenceCount</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00284">ReleaseNotifySync</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00130">_NOTIFY_CHANGE::SubjectContext</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00190">_NOTIFY_CHANGE::ThisBufferLength</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l02195">FsRtlNotifySetCancelRoutine()</a>.
<p>
<pre class="fragment"><div>02562                    :
02563 
02564     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being cancelled.  We Null <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cancel
02565     routine and then walk through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Irps <span class="keywordflow">for</span> <span class="keyword">this</span> notify structure and
02566     complete all cancelled Irps.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> possible there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> pending notify
02567     stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer <span class="keywordflow">for</span> <span class="keyword">this</span> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.  In <span class="keyword">this</span> <span class="keywordflow">case</span> we want to copy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02568     data to a system buffer <span class="keywordflow">if</span> possible.
02569 
02570 Arguments:
02571 
02572     DeviceObject - Ignored.
02573 
02574     ThisIrp  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to cancel.
02575 
02576 Return Value:
02577 
02578     None.
02579 
02580 --*/
02581 
02582 {
02583     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02584 
02585     <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a> Notify;
02586     <a class="code" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> NotifySync;
02587     LONG ExceptionCode;
02588 
02589     UNREFERENCED_PARAMETER( DeviceObject );
02590 
02591     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlCancelNotify:  Entered\n"</span>, 0 );
02592     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Irp   -&gt; %08lx\n"</span>, Irp );
02593 
02594     <span class="comment">//</span>
02595     <span class="comment">//  Capture the notify structure.</span>
02596     <span class="comment">//</span>
02597 
02598     Notify = (<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a>) ThisIrp-&gt;IoStatus.Information;
02599 
02600     <span class="comment">//</span>
02601     <span class="comment">//  Void the cancel routine and release the cancel spinlock.</span>
02602     <span class="comment">//</span>
02603 
02604     <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( ThisIrp, NULL );
02605     ThisIrp-&gt;IoStatus.Information = 0;
02606     <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( ThisIrp-&gt;CancelIrql );
02607 
02608     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
02609 
02610     <span class="comment">//</span>
02611     <span class="comment">//  Grab the mutex for this structure.</span>
02612     <span class="comment">//</span>
02613 
02614     NotifySync = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o0">NotifySync</a>;
02615     <a class="code" href="../../d2/d7/notify_8c.html#a11">AcquireNotifySync</a>( NotifySync );
02616 
02617     <span class="comment">//</span>
02618     <span class="comment">//  Use a try finally to faciltate cleanup.</span>
02619     <span class="comment">//</span>
02620 
02621     <span class="keywordflow">try</span> {
02622 
02623         <span class="comment">//</span>
02624         <span class="comment">//  Remove the Irp from the queue.</span>
02625         <span class="comment">//</span>
02626 
02627         RemoveEntryList( &amp;ThisIrp-&gt;Tail.Overlay.ListEntry );
02628 
02629         <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( ThisIrp );
02630 
02631         <span class="comment">//</span>
02632         <span class="comment">//  We now have the Irp.  Check to see if there is data stored</span>
02633         <span class="comment">//  in the buffer for this Irp.</span>
02634         <span class="comment">//</span>
02635 
02636         <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02637             &amp;&amp; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02638 
02639             &amp;&amp; ((ThisIrp-&gt;MdlAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02640                  &amp;&amp; <a class="code" href="../../d2/d1/mm_8h.html#a26">MmGetSystemAddressForMdl</a>( ThisIrp-&gt;MdlAddress ) == Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a>)
02641 
02642                 || (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> == ThisIrp-&gt;AssociatedIrp.SystemBuffer))) {
02643 
02644             <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> NextIrp;
02645             PVOID NewBuffer;
02646             ULONG NewBufferLength;
02647             <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>  IrpSp;
02648 
02649             <span class="comment">//</span>
02650             <span class="comment">//  Initialize the above values.</span>
02651             <span class="comment">//</span>
02652 
02653             NewBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02654             NewBufferLength = 0;
02655 
02656             <span class="comment">//</span>
02657             <span class="comment">//  Remember the next Irp on the list.  Find the length of any</span>
02658             <span class="comment">//  buffer it might have.  Also keep a pointer to the buffer</span>
02659             <span class="comment">//  if present.</span>
02660             <span class="comment">//</span>
02661 
02662             <span class="keywordflow">if</span> (!IsListEmpty( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a> )) {
02663 
02664                 NextIrp = CONTAINING_RECORD( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a>.Flink,
02665                                              <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>,
02666                                              Tail.Overlay.ListEntry );
02667 
02668                 IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( NextIrp );
02669 
02670                 <span class="comment">//</span>
02671                 <span class="comment">//  If the buffer here is large enough to hold the data we</span>
02672                 <span class="comment">//  can use that buffer.</span>
02673                 <span class="comment">//</span>
02674 
02675                 <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.NotifyDirectory.Length &gt;= Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a>) {
02676 
02677                     <span class="comment">//</span>
02678                     <span class="comment">//  If there is a system buffer or Mdl then get a new</span>
02679                     <span class="comment">//  buffer there.</span>
02680                     <span class="comment">//</span>
02681 
02682                     <span class="keywordflow">if</span> (NextIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02683 
02684                         NewBuffer = NextIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
02685 
02686                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NextIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02687 
02688                         NewBuffer = <a class="code" href="../../d2/d1/mm_8h.html#a26">MmGetSystemAddressForMdl</a>( NextIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> );
02689                     }
02690 
02691                     NewBufferLength = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.NotifyDirectory.Length;
02692 
02693                     <span class="keywordflow">if</span> (NewBufferLength &gt; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a>) {
02694 
02695                         NewBufferLength = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a>;
02696                     }
02697                 }
02698 
02699             <span class="comment">//</span>
02700             <span class="comment">//  Otherwise check if the user's original buffer is larger than</span>
02701             <span class="comment">//  the current buffer.</span>
02702             <span class="comment">//</span>
02703 
02704             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a> &gt;= Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a>) {
02705 
02706                 NewBufferLength = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a>;
02707             }
02708 
02709             <span class="comment">//</span>
02710             <span class="comment">//  If we have a new buffer length then we either have a new</span>
02711             <span class="comment">//  buffer or need to allocate one.  We will do this under</span>
02712             <span class="comment">//  the protection of a try-except in order to continue in the</span>
02713             <span class="comment">//  event of a failure.</span>
02714             <span class="comment">//</span>
02715 
02716             <span class="keywordflow">if</span> (NewBufferLength != 0) {
02717 
02718                 BOOLEAN ChargedQuota;
02719 
02720                 <span class="keywordflow">try</span> {
02721 
02722                     ChargedQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02723 
02724                     <span class="keywordflow">if</span> (NewBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02725 
02726                         <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
02727                                            PagedPool,
02728                                            NewBufferLength );
02729 
02730                         ChargedQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02731 
02732                         <span class="comment">//</span>
02733                         <span class="comment">//  If we didn't get an error then attempt to</span>
02734                         <span class="comment">//  allocate the pool.  If there is an error</span>
02735                         <span class="comment">//  don't forget to release the quota.</span>
02736                         <span class="comment">//</span>
02737 
02738                         NewBuffer = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( PagedPool,
02739                                                         NewBufferLength );
02740 
02741                         Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> = NewBuffer;
02742                     }
02743 
02744                     <span class="comment">//</span>
02745                     <span class="comment">//  Now copy the data over to the new buffer.</span>
02746                     <span class="comment">//</span>
02747 
02748                     RtlCopyMemory( NewBuffer,
02749                                    Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a>,
02750                                    Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> );
02751 
02752                     <span class="comment">//</span>
02753                     <span class="comment">//  It is possible that the buffer size changed.</span>
02754                     <span class="comment">//</span>
02755 
02756                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> = NewBufferLength;
02757                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> = NewBuffer;
02758 
02759                 } except( <a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>( ExceptionCode = GetExceptionCode()) ?
02760                           EXCEPTION_EXECUTE_HANDLER :
02761                           EXCEPTION_CONTINUE_SEARCH ) {
02762 
02763                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ExceptionCode == STATUS_INSUFFICIENT_RESOURCES) ||
02764                             (ExceptionCode == STATUS_QUOTA_EXCEEDED) );
02765                     
02766                     <span class="comment">//</span>
02767                     <span class="comment">//  Return quota if we allocated the buffer.</span>
02768                     <span class="comment">//</span>
02769 
02770                     <span class="keywordflow">if</span> (ChargedQuota) {
02771 
02772                         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
02773                                            PagedPool,
02774                                            NewBufferLength );
02775                     }
02776 
02777                     <span class="comment">//</span>
02778                     <span class="comment">//  Forget any current buffer and resort to immediate</span>
02779                     <span class="comment">//  notify.</span>
02780                     <span class="comment">//</span>
02781 
02782                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_IMMEDIATE_NOTIFY );
02783                 }
02784 
02785             <span class="comment">//</span>
02786             <span class="comment">//  Otherwise set the immediate notify flag.</span>
02787             <span class="comment">//</span>
02788 
02789             } <span class="keywordflow">else</span> {
02790 
02791                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_IMMEDIATE_NOTIFY );
02792             }
02793 
02794             <span class="comment">//</span>
02795             <span class="comment">//  If the immediate notify flag is set then clear the other</span>
02796             <span class="comment">//  values in the notify structures.</span>
02797             <span class="comment">//</span>
02798 
02799             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_IMMEDIATE_NOTIFY )) {
02800 
02801                 <span class="comment">//</span>
02802                 <span class="comment">//  Forget any current buffer and resort to immediate</span>
02803                 <span class="comment">//  notify.</span>
02804                 <span class="comment">//</span>
02805 
02806                 Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02807 
02808                 Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> =
02809                 Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a> = 0;
02810             }
02811         }
02812 
02813         <span class="comment">//</span>
02814         <span class="comment">//  Complete the Irp with status cancelled.</span>
02815         <span class="comment">//</span>
02816 
02817         <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( ThisIrp, STATUS_CANCELLED );
02818 
02819         <span class="comment">//</span>
02820         <span class="comment">//  Decrement the count of Irps that might go through the cancel path.</span>
02821         <span class="comment">//</span>
02822 
02823         InterlockedDecrement( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">ReferenceCount</a> );
02824 
02825         <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">ReferenceCount</a> == 0) {
02826 
02827             <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02828 
02829                 <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
02830                                    PagedPool,
02831                                    Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> );
02832 
02833                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> );
02834             }
02835 
02836             <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02837 
02838                 SubjectContext = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o4">SubjectContext</a>;
02839             }
02840 
02841             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Notify );
02842             Notify = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02843         }
02844 
02845     } finally {
02846 
02847         <span class="comment">//</span>
02848         <span class="comment">//  No matter how we exit, we release the mutex.</span>
02849         <span class="comment">//</span>
02850 
02851         <a class="code" href="../../d2/d7/notify_8c.html#a12">ReleaseNotifySync</a>( NotifySync );
02852 
02853         <span class="keywordflow">if</span> (SubjectContext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02854 
02855             <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( SubjectContext );
02856             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( SubjectContext );
02857         }
02858 
02859         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
02860 
02861         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlCancelNotify:  Exit\n"</span>, 0 );
02862     }
02863 
02864     <span class="keywordflow">return</span>;
02865 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="notify.c::FsRtlCheckNotifyForDelete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlCheckNotifyForDelete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyListHead</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FsContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l02873">2873</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00159">_NOTIFY_CHANGE::Flags</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02467">FsRtlNotifyCompleteIrpList()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00219">NOTIFY_STREAM_IS_DELETED</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00153">_NOTIFY_CHANGE::NotifyIrps</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00111">_NOTIFY_CHANGE::StreamID</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>.
<p>
<pre class="fragment"><div>02880                    :
02881 
02882     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a stream <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being marked <span class="keywordflow">for</span> <span class="keyword">delete</span>.  We will
02883     walk through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structures looking <span class="keywordflow">for</span> an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same stream.
02884     We will complete these Irps with STATUS_DELETE_PENDING.
02885 
02886 Arguments:
02887 
02888     NotifyListHead  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify list.
02889 
02890     StreamID  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Context <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> used to identify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stream.
02891 
02892 Return Value:
02893 
02894     None.
02895 
02896 --*/
02897 
02898 {
02899     PLIST_ENTRY Link;
02900 
02901     <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a> ThisNotify;
02902 
02903     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02904 
02905     <span class="comment">//</span>
02906     <span class="comment">//  Walk through all the entries on the list looking for a match.</span>
02907     <span class="comment">//</span>
02908 
02909     <span class="keywordflow">for</span> (Link = NotifyListHead-&gt;Flink;
02910          Link != NotifyListHead;
02911          Link = Link-&gt;Flink) {
02912 
02913         <span class="comment">//</span>
02914         <span class="comment">//  Obtain the notify structure from the link.</span>
02915         <span class="comment">//</span>
02916 
02917         ThisNotify = CONTAINING_RECORD( Link, <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">NOTIFY_CHANGE</a>, NotifyList );
02918 
02919         <span class="comment">//</span>
02920         <span class="comment">//  If the context field matches, then complete any waiting Irps.</span>
02921         <span class="comment">//</span>
02922 
02923         <span class="keywordflow">if</span> (ThisNotify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o2">StreamID</a> == StreamID) {
02924 
02925             <span class="comment">//</span>
02926             <span class="comment">//  Start by marking the notify structure as file deleted.</span>
02927             <span class="comment">//</span>
02928 
02929             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( ThisNotify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_STREAM_IS_DELETED );
02930 
02931             <span class="comment">//</span>
02932             <span class="comment">//  Now complete all of the Irps on this list.</span>
02933             <span class="comment">//</span>
02934 
02935             <span class="keywordflow">if</span> (!IsListEmpty( &amp;ThisNotify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a> )) {
02936 
02937                 <a class="code" href="../../d2/d7/notify_8c.html#a32">FsRtlNotifyCompleteIrpList</a>( ThisNotify, STATUS_DELETE_PENDING );
02938             }
02939         }
02940     }
02941 
02942     <span class="keywordflow">return</span>;
02943 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="notify.c::FsRtlIsNotifyOnList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a> FsRtlIsNotifyOnList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyListHead</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FsContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l01920">1920</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00103">_NOTIFY_CHANGE::FsContext</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l01795">FsRtlNotifyCleanup()</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>.
<p>
<pre class="fragment"><div>01927                    :
01928 
01929     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to walk through a notify list searching <span class="keywordflow">for</span>
01930     a member associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FsContext value.
01931 
01932 Arguments:
01933 
01934     NotifyListHead  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify list.
01935 
01936     FsContext  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system so that <span class="keyword">this</span> notify
01937                   structure can be uniquely identified.
01938 
01939 Return Value:
01940 
01941     <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> structure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01942                      <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure isn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> present.
01943 
01944 --*/
01945 
01946 {
01947     PLIST_ENTRY Link;
01948 
01949     <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a> ThisNotify;
01950     <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a> Notify;
01951 
01952     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01953 
01954     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlIsNotifyOnList:  Entered\n"</span>, 0 );
01955 
01956     <span class="comment">//</span>
01957     <span class="comment">//  Assume we won't have a match.</span>
01958     <span class="comment">//</span>
01959 
01960     Notify = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01961 
01962     <span class="comment">//</span>
01963     <span class="comment">//  Walk through all the entries on the list looking for a match.</span>
01964     <span class="comment">//</span>
01965 
01966     <span class="keywordflow">for</span> (Link = NotifyListHead-&gt;Flink;
01967          Link != NotifyListHead;
01968          Link = Link-&gt;Flink) {
01969 
01970         <span class="comment">//</span>
01971         <span class="comment">//  Obtain the notify structure from the link.</span>
01972         <span class="comment">//</span>
01973 
01974         ThisNotify = CONTAINING_RECORD( Link, <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">NOTIFY_CHANGE</a>, NotifyList );
01975 
01976         <span class="comment">//</span>
01977         <span class="comment">//  If the context field matches, remember this structure and</span>
01978         <span class="comment">//  exit.</span>
01979         <span class="comment">//</span>
01980 
01981         <span class="keywordflow">if</span> (ThisNotify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o1">FsContext</a> == FsContext) {
01982 
01983             Notify = ThisNotify;
01984             <span class="keywordflow">break</span>;
01985         }
01986     }
01987 
01988     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Notify Structure  -&gt; %08lx\n"</span>, Notify );
01989     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlIsNotifyOnList:  Exit\n"</span>, 0 );
01990 
01991     <span class="keywordflow">return</span> Notify;
01992 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="notify.c::FsRtlNotifyChangeDirectory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlNotifyChangeDirectory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifySync</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FsContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FullDirectoryName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WatchTree</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CompletionFilter</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyIrp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00469">469</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00070">WatchTree</a>.
<p>
<pre class="fragment"><div>00481                    :
00482 
00483     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system which has received a NotifyChange
00484     request.  This routine checks <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already a notify structure and
00485     inserts one <span class="keywordflow">if</span> not present.  With a notify structure in hand, we check
00486     whether we already have a pending notify and report <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span> so.  If there
00487     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no pending notify, we check <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> has already been cancelled and
00488     completes <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span> so.  Otherwise we add <span class="keyword">this</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of Irps waiting
00489     <span class="keywordflow">for</span> notification.
00490 
00491 Arguments:
00492 
00493     NotifySync  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> controlling fast mutex <span class="keywordflow">for</span> <span class="keyword">this</span> notify list.
00494         It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored here so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be found <span class="keywordflow">for</span> an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00495         cancelled.
00496 
00497     FsContext  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system so that <span class="keyword">this</span> notify
00498                   structure can be uniquely identified.
00499 
00500     FullDirectoryName  -  Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full name <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory associated
00501                           with <span class="keyword">this</span> notify structure.
00502 
00503     NotifyList  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify list to add <span class="keyword">this</span>
00504                    structure to.
00505 
00506     <a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>  -  This indicates whether all subdirectories <span class="keywordflow">for</span> <span class="keyword">this</span> directory
00507                   should be watched, or just <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory itself.
00508 
00509     CompletionFilter  -  This provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mask to determine which operations
00510                          will trigger <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify operations.
00511 
00512     NotifyIrp  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to complete on notify change.
00513 
00514 Return Value:
00515 
00516     None.
00517 
00518 --*/
00519 
00520 {
00521     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00522 
00523     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlNotifyChangeDirectory:  Entered\n"</span>, 0 );
00524 
00525     <span class="comment">//</span>
00526     <span class="comment">//  We will simply call the full notify routine to do the real work.</span>
00527     <span class="comment">//</span>
00528 
00529     <a class="code" href="../../d1/d8/fsrtl_8h.html#a172">FsRtlNotifyFullChangeDirectory</a>( NotifySync,
00530                                     NotifyList,
00531                                     FsContext,
00532                                     FullDirectoryName,
00533                                     WatchTree,
00534                                     TRUE,
00535                                     CompletionFilter,
00536                                     NotifyIrp,
00537                                     NULL,
00538                                     NULL );
00539 
00540     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyChangeDirectory:  Exit\n"</span>, 0 );
00541 
00542     <span class="keywordflow">return</span>;
00543 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="notify.c::FsRtlNotifyCleanup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlNotifyCleanup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifySync</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FsContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l01795">1795</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00274">AcquireNotifySync</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00187">_NOTIFY_CHANGE::AllocatedBuffer</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00159">_NOTIFY_CHANGE::Flags</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l01920">FsRtlIsNotifyOnList()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02467">FsRtlNotifyCompleteIrpList()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00139">_NOTIFY_CHANGE::FullDirectoryName</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00216">NOTIFY_CLEANUP_CALLED</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00153">_NOTIFY_CHANGE::NotifyIrps</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00146">_NOTIFY_CHANGE::NotifyList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00210">_NOTIFY_CHANGE::OwningProcess</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00203">_NOTIFY_CHANGE::ReferenceCount</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00284">ReleaseNotifySync</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00130">_NOTIFY_CHANGE::SubjectContext</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00190">_NOTIFY_CHANGE::ThisBufferLength</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>.
<p>
<pre class="fragment"><div>01803                    :
01804 
01805     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> a cleanup of a user directory handle.  We
01806     walk through our notify structures looking <span class="keywordflow">for</span> a <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> context field.
01807     We complete all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pending notify Irps <span class="keywordflow">for</span> <span class="keyword">this</span> Notify structure, remove
01808     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structure and deallocate <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01809 
01810 Arguments:
01811 
01812     NotifySync  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> controlling fast mutex <span class="keywordflow">for</span> <span class="keyword">this</span> notify list.
01813         It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored here so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be found <span class="keywordflow">for</span> an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
01814         cancelled.
01815 
01816     NotifyList  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify list to add <span class="keyword">this</span>
01817                    structure to.
01818 
01819     FsContext  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a unique value assigned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system to
01820                   identify a particular notify structure.
01821 
01822 Return Value:
01823 
01824     None.
01825 
01826 --*/
01827 
01828 {
01829     <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a> Notify;
01830     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01831 
01832     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01833 
01834     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlNotifyCleanup:  Entered\n"</span>, 0 );
01835     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Mutex             -&gt; %08lx\n"</span>, Mutex );
01836     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Notify List       -&gt; %08lx\n"</span>, NotifyList );
01837     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"FsContext         -&gt; %08lx\n"</span>, FsContext );
01838 
01839     <span class="comment">//</span>
01840     <span class="comment">//  Acquire exclusive access to the list by acquiring the mutex.</span>
01841     <span class="comment">//</span>
01842 
01843     <a class="code" href="../../d2/d7/notify_8c.html#a11">AcquireNotifySync</a>( NotifySync );
01844 
01845     <span class="comment">//</span>
01846     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01847     <span class="comment">//</span>
01848 
01849     <span class="keywordflow">try</span> {
01850 
01851         <span class="comment">//</span>
01852         <span class="comment">//  Search for a match on the list.</span>
01853         <span class="comment">//</span>
01854 
01855         Notify = <a class="code" href="../../d2/d7/notify_8c.html#a18">FsRtlIsNotifyOnList</a>( NotifyList, FsContext );
01856 
01857         <span class="comment">//</span>
01858         <span class="comment">//  If found, then complete all the Irps with STATUS_NOTIFY_CLEANUP</span>
01859         <span class="comment">//</span>
01860 
01861         <span class="keywordflow">if</span> (Notify != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01862 
01863             <span class="comment">//</span>
01864             <span class="comment">//  Set the flag to indicate that we have been called with cleanup.</span>
01865             <span class="comment">//</span>
01866 
01867             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_CLEANUP_CALLED );
01868 
01869             <span class="keywordflow">if</span> (!IsListEmpty( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a> )) {
01870 
01871                 <a class="code" href="../../d2/d7/notify_8c.html#a32">FsRtlNotifyCompleteIrpList</a>( Notify, STATUS_NOTIFY_CLEANUP );
01872             }
01873 
01874             RemoveEntryList( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o6">NotifyList</a> );
01875 
01876             InterlockedDecrement( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">ReferenceCount</a> );
01877 
01878             <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">ReferenceCount</a> == 0) {
01879                 
01880                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01881 
01882                     <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
01883                                        PagedPool,
01884                                        Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> );
01885 
01886                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> );
01887                 }
01888 
01889                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01890 
01891                     SubjectContext = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o4">SubjectContext</a>;
01892                 }
01893 
01894                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Notify );
01895             }
01896         }
01897 
01898     } finally {
01899 
01900         <a class="code" href="../../d2/d7/notify_8c.html#a12">ReleaseNotifySync</a>( NotifySync );
01901 
01902         <span class="keywordflow">if</span> (SubjectContext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01903 
01904             <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( SubjectContext );
01905             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( SubjectContext );
01906         }
01907 
01908         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyCleanup:  Exit\n"</span>, 0 );
01909     }
01910 
01911     <span class="keywordflow">return</span>;
01912 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="notify.c::FsRtlNotifyCompleteIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlNotifyCompleteIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyIrp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Notify</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DataLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>Status</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CheckCancel</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l02000">2000</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l02031">_IO_STACK_LOCATION::Control</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02195">FsRtlNotifySetCancelRoutine()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01556">IRP_INPUT_OPERATION</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01874">MmGetSystemAddressForMdl</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01845">SL_PENDING_RETURNED</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l02467">FsRtlNotifyCompleteIrpList()</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>.
<p>
<pre class="fragment"><div>02010                    :
02011 
02012     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to complete an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">NOTIFY_CHANGE</a>
02013     structure.
02014 
02015 Arguments:
02016 
02017     NotifyIrp  -  <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to complete.
02018 
02019     Notify  -  Notify structure which contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data.
02020 
02021     DataLength  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify
02022         structure.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of zero indicates that we should complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02023         request with STATUS_NOTIFY_ENUM_DIR.
02024 
02025     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>  -  Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status to complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> with.
02026 
02027     CheckCancel - Indicates <span class="keywordflow">if</span> we should <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> irp <span class="keywordflow">if</span> we clear <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cancel routine
02028         ourselves.
02029 
02030 Return Value:
02031 
02032     None.
02033 
02034 --*/
02035 
02036 {
02037     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
02038 
02039     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02040 
02041     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlIsNotifyCompleteIrp:  Entered\n"</span>, 0 );
02042 
02043     <span class="comment">//</span>
02044     <span class="comment">//  Attempt to clear the cancel routine.  If this routine owns the cancel</span>
02045     <span class="comment">//  routine then it can complete the irp.  Otherwise there is a cancel underway</span>
02046     <span class="comment">//  on this.</span>
02047     <span class="comment">//</span>
02048 
02049     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/notify_8c.html#a20">FsRtlNotifySetCancelRoutine</a>( NotifyIrp, Notify ) || !CheckCancel) {
02050 
02051         <span class="comment">//</span>
02052         <span class="comment">//  We only process the buffer if the status is STATUS_SUCCESS.</span>
02053         <span class="comment">//</span>
02054 
02055         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
02056 
02057             <span class="comment">//</span>
02058             <span class="comment">//  Get the current Stack location</span>
02059             <span class="comment">//</span>
02060 
02061             IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( NotifyIrp );
02062 
02063             <span class="comment">//</span>
02064             <span class="comment">//  If the data won't fit in the user's buffer or there was already a</span>
02065             <span class="comment">//  buffer overflow then return the alternate status code.  If the data</span>
02066             <span class="comment">//  was already stored in the Irp buffer then we know that we won't</span>
02067             <span class="comment">//  take this path.  Otherwise we wouldn't be cleaning up the Irp</span>
02068             <span class="comment">//  correctly.</span>
02069             <span class="comment">//</span>
02070 
02071             <span class="keywordflow">if</span> (DataLength == 0
02072                 || IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.NotifyDirectory.Length &lt; DataLength) {
02073 
02074                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOTIFY_ENUM_DIR;
02075 
02076             <span class="comment">//</span>
02077             <span class="comment">//  We have to carefully return the buffer to the user and handle all</span>
02078             <span class="comment">//  of the different buffer cases.  If there is no allocated buffer</span>
02079             <span class="comment">//  in the notify structure it means that we have already used the</span>
02080             <span class="comment">//  caller's buffer.</span>
02081             <span class="comment">//</span>
02082             <span class="comment">//  1 - If the system allocated an associated system buffer we</span>
02083             <span class="comment">//      can simply fill that in.</span>
02084             <span class="comment">//</span>
02085             <span class="comment">//  2 - If there is an Mdl then we get a system address for the Mdl</span>
02086             <span class="comment">//      and copy the data into it.</span>
02087             <span class="comment">//</span>
02088             <span class="comment">//  3 - If there is only a user's buffer and pending has not been</span>
02089             <span class="comment">//      returned, we can fill the user's buffer in directly.</span>
02090             <span class="comment">//</span>
02091             <span class="comment">//  4 - If there is only a user's buffer and pending has been returned</span>
02092             <span class="comment">//      then we are not in the user's address space.  We dress up</span>
02093             <span class="comment">//      the Irp with our system buffer and let the Io system</span>
02094             <span class="comment">//      copy the data in.</span>
02095             <span class="comment">//</span>
02096 
02097             } <span class="keywordflow">else</span> {
02098 
02099                 <span class="keywordflow">if</span> (Notify-&gt;AllocatedBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02100 
02101                     <span class="comment">//</span>
02102                     <span class="comment">//  Protect the copy with a try-except and ignore the buffer</span>
02103                     <span class="comment">//  if we have some error in copying it to the buffer.</span>
02104                     <span class="comment">//</span>
02105 
02106                     <span class="keywordflow">try</span> {
02107 
02108                         <span class="keywordflow">if</span> (NotifyIrp-&gt;AssociatedIrp.SystemBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02109 
02110                             RtlCopyMemory( NotifyIrp-&gt;AssociatedIrp.SystemBuffer,
02111                                            Notify-&gt;AllocatedBuffer,
02112                                            DataLength );
02113 
02114                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NotifyIrp-&gt;MdlAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02115 
02116                             RtlCopyMemory( <a class="code" href="../../d2/d1/mm_8h.html#a26">MmGetSystemAddressForMdl</a>( NotifyIrp-&gt;MdlAddress ),
02117                                            Notify-&gt;AllocatedBuffer,
02118                                            DataLength );
02119 
02120                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o3">Control</a>, SL_PENDING_RETURNED )) {
02121 
02122                             RtlCopyMemory( NotifyIrp-&gt;UserBuffer,
02123                                            Notify-&gt;AllocatedBuffer,
02124                                            DataLength );
02125 
02126                         } <span class="keywordflow">else</span> {
02127 
02128                             NotifyIrp-&gt;Flags |= (<a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a180">IRP_INPUT_OPERATION</a> | <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>);
02129                             NotifyIrp-&gt;AssociatedIrp.SystemBuffer = Notify-&gt;AllocatedBuffer;
02130 
02131                         }
02132 
02133                     } except( EXCEPTION_EXECUTE_HANDLER ) {
02134 
02135                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOTIFY_ENUM_DIR;
02136                         DataLength = 0;
02137                     }
02138 
02139                     <span class="comment">//</span>
02140                     <span class="comment">//  Return the quota and deallocate the buffer if we didn't pass it</span>
02141                     <span class="comment">//  back via the irp.</span>
02142                     <span class="comment">//</span>
02143 
02144                     <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Notify-&gt;OwningProcess, PagedPool, Notify-&gt;ThisBufferLength );
02145 
02146                     <span class="keywordflow">if</span> (Notify-&gt;AllocatedBuffer != NotifyIrp-&gt;AssociatedIrp.SystemBuffer
02147                         &amp;&amp; Notify-&gt;AllocatedBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02148 
02149                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Notify-&gt;AllocatedBuffer );
02150                     }
02151 
02152                     Notify-&gt;AllocatedBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02153                     Notify-&gt;ThisBufferLength = 0;
02154                 }
02155 
02156                 <span class="comment">//</span>
02157                 <span class="comment">//  Update the data length in the Irp.</span>
02158                 <span class="comment">//</span>
02159 
02160                 NotifyIrp-&gt;IoStatus.Information = DataLength;
02161 
02162                 <span class="comment">//</span>
02163                 <span class="comment">//  Show that there is no buffer in the notify package</span>
02164                 <span class="comment">//  anymore.</span>
02165                 <span class="comment">//</span>
02166 
02167                 Notify-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02168             }
02169         }
02170 
02171         <span class="comment">//</span>
02172         <span class="comment">//  Make sure the Irp is marked as pending returned.</span>
02173         <span class="comment">//</span>
02174 
02175         <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( NotifyIrp );
02176 
02177         <span class="comment">//</span>
02178         <span class="comment">//  Now complete the request.</span>
02179         <span class="comment">//</span>
02180 
02181         <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( NotifyIrp, Status );
02182     }
02183 
02184     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlIsNotifyCompleteIrp:  Exit\n"</span>, 0 );
02185 
02186     <span class="keywordflow">return</span>;
02187 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="notify.c::FsRtlNotifyCompleteIrpList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlNotifyCompleteIrpList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Notify</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>Status</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l02467">2467</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02000">FsRtlNotifyCompleteIrp()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00215">NOTIFY_IMMEDIATE_NOTIFY</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l02873">FsRtlCheckNotifyForDelete()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l01795">FsRtlNotifyCleanup()</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00973">FsRtlNotifyFullReportChange()</a>.
<p>
<pre class="fragment"><div>02474                    :
02475 
02476     This routine walks through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Irps <span class="keywordflow">for</span> a particular notify structure
02477     and completes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Irps with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated status.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02478     STATUS_SUCCESS then we are completing an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> because of a notification event.
02479     In that <span class="keywordflow">case</span> we look at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structure to decide <span class="keywordflow">if</span> we can <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02480     data to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user.
02481 
02482 Arguments:
02483 
02484     Notify  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify change structure.
02485 
02486     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>  -  Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status used to complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.  If <span class="keyword">this</span> status
02487         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> STATUS_SUCCESS then we <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> want to complete one <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.  Otherwise we
02488         want complete all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Irps in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
02489 
02490 Return Value:
02491 
02492     None.
02493 
02494 --*/
02495 
02496 {
02497     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
02498     ULONG DataLength;
02499 
02500     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlNotifyCompleteIrpList:  Entered\n"</span>, 0 );
02501 
02502     DataLength = Notify-&gt;DataLength;
02503 
02504     <span class="comment">//</span>
02505     <span class="comment">//  Clear the fields to indicate that there is no more data to return.</span>
02506     <span class="comment">//</span>
02507 
02508     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Notify-&gt;Flags, NOTIFY_IMMEDIATE_NOTIFY );
02509     Notify-&gt;DataLength = 0;
02510     Notify-&gt;LastEntry = 0;
02511 
02512     <span class="comment">//</span>
02513     <span class="comment">//  Walk through all the Irps in the list.  We are never called unless</span>
02514     <span class="comment">//  there is at least one irp.</span>
02515     <span class="comment">//</span>
02516 
02517     <span class="keywordflow">do</span> {
02518 
02519         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = CONTAINING_RECORD( Notify-&gt;NotifyIrps.Flink, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, Tail.Overlay.ListEntry );
02520 
02521         RemoveHeadList( &amp;Notify-&gt;NotifyIrps );
02522 
02523         <span class="comment">//</span>
02524         <span class="comment">//  Call our completion routine to complete the request.</span>
02525         <span class="comment">//</span>
02526 
02527         <a class="code" href="../../d2/d7/notify_8c.html#a19">FsRtlNotifyCompleteIrp</a>( Irp,
02528                                 Notify,
02529                                 DataLength,
02530                                 Status,
02531                                 TRUE );
02532 
02533         <span class="comment">//</span>
02534         <span class="comment">//  If we were only to complete one Irp then break now.</span>
02535         <span class="comment">//</span>
02536 
02537         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
02538 
02539             <span class="keywordflow">break</span>;
02540         }
02541 
02542     } <span class="keywordflow">while</span> (!IsListEmpty( &amp;Notify-&gt;NotifyIrps ));
02543 
02544     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyCompleteIrpList:  Exit\n"</span>, 0 );
02545 
02546     <span class="keywordflow">return</span>;
02547 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="notify.c::FsRtlNotifyCompleteIrpList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlNotifyCompleteIrpList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Notify</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>Status</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="notify.c::FsRtlNotifyFullChangeDirectory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlNotifyFullChangeDirectory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifySync</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FsContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FullDirectoryName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WatchTree</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CompletionFilter</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyIrp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a82">PCHECK_FOR_TRAVERSE_ACCESS</a> TraverseCallback&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">547</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00274">AcquireNotifySync</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00189">_NOTIFY_CHANGE::BufferLength</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00166">_NOTIFY_CHANGE::CharacterSize</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00173">_NOTIFY_CHANGE::CompletionFilter</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00191">_NOTIFY_CHANGE::DataLength</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00159">_NOTIFY_CHANGE::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01504">FO_CLEANUP_COMPLETE</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00103">_NOTIFY_CHANGE::FsContext</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01519">_FILE_OBJECT::FsContext</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02873">FsRtlCheckNotifyForDelete()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01745">FsRtlCompleteRequest</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l01920">FsRtlIsNotifyOnList()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02000">FsRtlNotifyCompleteIrp()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02195">FsRtlNotifySetCancelRoutine()</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00040">FsRtlpAllocatePool</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00139">_NOTIFY_CHANGE::FullDirectoryName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00192">_NOTIFY_CHANGE::LastEntry</a>, <a class="el" href="../../d2/d7/notify_8c.html#a16">NOTIFY_CHANGE</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00216">NOTIFY_CLEANUP_CALLED</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00217">NOTIFY_DEFER_NOTIFY</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00218">NOTIFY_DIR_IS_ROOT</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00215">NOTIFY_IMMEDIATE_NOTIFY</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00219">NOTIFY_STREAM_IS_DELETED</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00214">NOTIFY_WATCH_TREE</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00153">_NOTIFY_CHANGE::NotifyIrps</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00146">_NOTIFY_CHANGE::NotifyList</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00094">_NOTIFY_CHANGE::NotifySync</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00210">_NOTIFY_CHANGE::OwningProcess</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a>, <a class="el" href="../../d2/d7/notify_8c.html#a15">PREAL_NOTIFY_SYNC</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00203">_NOTIFY_CHANGE::ReferenceCount</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00284">ReleaseNotifySync</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00196">SeReleaseSubjectContext()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00111">_NOTIFY_CHANGE::StreamID</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00130">_NOTIFY_CHANGE::SubjectContext</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00120">_NOTIFY_CHANGE::TraverseCallback</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>, and <a class="el" href="../../d6/d1/rtnotify_8c-source.html#l00070">WatchTree</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l00469">FsRtlNotifyChangeDirectory()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00904">UdfNotifyChangeDirectory()</a>.
<p>
<pre class="fragment"><div>00562                    :
00563 
00564     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system which has received a NotifyChange
00565     request.  This routine checks <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already a notify structure and
00566     inserts one <span class="keywordflow">if</span> not present.  With a notify structure in hand, we check
00567     whether we already have a pending notify and report <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span> so.  If there
00568     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no pending notify, we check <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> has already been cancelled and
00569     completes <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">if</span> so.  Otherwise we add <span class="keyword">this</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of Irps waiting
00570     <span class="keywordflow">for</span> notification.
00571 
00572     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> version of <span class="keyword">this</span> routine which understands about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's
00573     buffer and will fill <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> in on a reported change.
00574 
00575 Arguments:
00576 
00577     NotifySync  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> controlling fast mutex <span class="keywordflow">for</span> <span class="keyword">this</span> notify list.
00578         It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored here so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be found <span class="keywordflow">for</span> an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00579         cancelled.
00580 
00581     NotifyList  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify list to add <span class="keyword">this</span>
00582         structure to.
00583 
00584     FsContext  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system so that <span class="keyword">this</span> notify
00585         structure can be uniquely identified.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NotifyIrp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified
00586         then <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to identify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stream and <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will match <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FsContext
00587         field in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object of a stream being deleted.
00588 
00589     FullDirectoryName  -  Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full name <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory associated
00590         with <span class="keyword">this</span> notify structure.  Ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NotifyIrp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified.
00591 
00592     <a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>  -  This indicates whether all subdirectories <span class="keywordflow">for</span> <span class="keyword">this</span> directory
00593         should be watched, or just <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory itself.  Ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00594         NotifyIrp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified.
00595 
00596     IgnoreBuffer  -  Indicates whether we will always ignore any user buffer
00597         and force <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory to be reenumerated.  This will speed up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00598         operation.  Ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NotifyIrp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified.
00599 
00600     CompletionFilter  -  This provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mask to determine which operations
00601         will trigger <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify operations.  Ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NotifyIrp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00602         specified.
00603 
00604     NotifyIrp  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to complete on notify change.  If <span class="keyword">this</span> irp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00605         not specified <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> means that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stream represented by <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object
00606         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being deleted.
00607 
00608     TraverseCallback  -  If specified we must call <span class="keyword">this</span> routine when a change
00609         has occurred in a subdirectory being watched in a tree.  This will
00610         let <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filesystem check <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> watcher has traverse access to that
00611         directory.  Ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NotifyIrp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified.
00612 
00613     SubjectContext - If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a traverse callback routine then we will
00614         pass <span class="keyword">this</span> subject context as a parameter to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call.  We will release
00615         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context and free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure when done with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  Ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00616         NotifyIrp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified.
00617 
00618 Return Value:
00619 
00620     None.
00621 
00622 --*/
00623 
00624 {
00625     <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a> Notify;
00626     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00627 
00628     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00629 
00630     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlNotifyFullChangeDirectory:  Entered\n"</span>, 0 );
00631 
00632     <span class="comment">//</span>
00633     <span class="comment">//  Acquire exclusive access to the list by acquiring the mutex.</span>
00634     <span class="comment">//</span>
00635 
00636     <a class="code" href="../../d2/d7/notify_8c.html#a11">AcquireNotifySync</a>( NotifySync );
00637 
00638     <span class="comment">//</span>
00639     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00640     <span class="comment">//</span>
00641 
00642     <span class="keywordflow">try</span> {
00643 
00644         <span class="comment">//</span>
00645         <span class="comment">//  If there is no Irp then find all of the pending Irps whose file objects</span>
00646         <span class="comment">//  refer to the same stream and complete them with STATUS_DELETE_PENDING.</span>
00647         <span class="comment">//</span>
00648 
00649         <span class="keywordflow">if</span> (NotifyIrp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00650 
00651             <a class="code" href="../../d2/d7/notify_8c.html#a24">FsRtlCheckNotifyForDelete</a>( NotifyList, FsContext );
00652             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00653         }
00654 
00655         <span class="comment">//</span>
00656         <span class="comment">//  Get the current Stack location</span>
00657         <span class="comment">//</span>
00658 
00659         IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( NotifyIrp );
00660 
00661         <span class="comment">//</span>
00662         <span class="comment">//  Clear the Iosb in the Irp.</span>
00663         <span class="comment">//</span>
00664 
00665         NotifyIrp-&gt;IoStatus.Status = STATUS_SUCCESS;
00666         NotifyIrp-&gt;IoStatus.Information = 0;
00667 
00668         <span class="comment">//</span>
00669         <span class="comment">//  If the file object has already gone through cleanup, then complete</span>
00670         <span class="comment">//  the request immediately.</span>
00671         <span class="comment">//</span>
00672 
00673         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, FO_CLEANUP_COMPLETE )) {
00674 
00675             <span class="comment">//</span>
00676             <span class="comment">//  Always mark this Irp as pending returned.</span>
00677             <span class="comment">//</span>
00678 
00679             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( NotifyIrp );
00680 
00681             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( NotifyIrp, STATUS_NOTIFY_CLEANUP );
00682             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00683         }
00684 
00685         <span class="comment">//</span>
00686         <span class="comment">//  If the notify structure is not already in the list, add it</span>
00687         <span class="comment">//  now.</span>
00688         <span class="comment">//</span>
00689 
00690         Notify = <a class="code" href="../../d2/d7/notify_8c.html#a18">FsRtlIsNotifyOnList</a>( NotifyList, FsContext );
00691 
00692         <span class="keywordflow">if</span> (Notify == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00693 
00694             <span class="comment">//</span>
00695             <span class="comment">//  Allocate and initialize the structure.</span>
00696             <span class="comment">//</span>
00697 
00698             Notify = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( PagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">NOTIFY_CHANGE</a> ));
00699             RtlZeroMemory( Notify, <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">NOTIFY_CHANGE</a> ));
00700 
00701             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o0">NotifySync</a> = (<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">PREAL_NOTIFY_SYNC</a>) NotifySync;
00702             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o1">FsContext</a> = FsContext;
00703             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o2">StreamID</a> = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o4">FsContext</a>;
00704 
00705             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o3">TraverseCallback</a> = TraverseCallback;
00706             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o4">SubjectContext</a> = SubjectContext;
00707             SubjectContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00708 
00709             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a> = FullDirectoryName;
00710 
00711             InitializeListHead( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a> );
00712 
00713             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/rtnotify_8c.html#a4">WatchTree</a>) {
00714 
00715                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_WATCH_TREE );
00716             }
00717 
00718             <span class="keywordflow">if</span> (FullDirectoryName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00719 
00720                 <span class="comment">//</span>
00721                 <span class="comment">//  In the view index we aren't using this buffer to hold a</span>
00722                 <span class="comment">//  unicode string.</span>
00723                 <span class="comment">//</span>
00724 
00725                 Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> );
00726 
00727             } <span class="keywordflow">else</span> {
00728 
00729                 <span class="comment">//</span>
00730                 <span class="comment">//  We look at the directory name to decide if we have a unicode</span>
00731                 <span class="comment">//  name.</span>
00732                 <span class="comment">//</span>
00733 
00734                 <span class="keywordflow">if</span> (FullDirectoryName-&gt;Length &gt;= 2
00735                     &amp;&amp; FullDirectoryName-&gt;Buffer[1] == <span class="charliteral">'\0'</span>) {
00736 
00737                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> = <span class="keyword">sizeof</span>( WCHAR );
00738 
00739                 } <span class="keywordflow">else</span> {
00740 
00741                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> );
00742                 }
00743 
00744                 <span class="keywordflow">if</span> (FullDirectoryName-&gt;Length == Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>) {
00745 
00746                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_DIR_IS_ROOT );
00747                 }
00748             }
00749 
00750             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o10">CompletionFilter</a> = CompletionFilter;
00751 
00752             <span class="comment">//</span>
00753             <span class="comment">//  If we are to return data to the user then look for the length</span>
00754             <span class="comment">//  of the original buffer in the IrpSp.</span>
00755             <span class="comment">//</span>
00756 
00757             <span class="keywordflow">if</span> (!IgnoreBuffer) {
00758 
00759                 Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a> = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.NotifyDirectory.Length;
00760             }
00761 
00762             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a> = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>( NotifyIrp-&gt;Tail.Overlay.Thread );
00763             InsertTailList( NotifyList, &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o6">NotifyList</a> );
00764 
00765             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">ReferenceCount</a> = 1;
00766 
00767         <span class="comment">//</span>
00768         <span class="comment">//  If we have already been called with cleanup then complete</span>
00769         <span class="comment">//  the request immediately.</span>
00770         <span class="comment">//</span>
00771 
00772         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_CLEANUP_CALLED )) {
00773 
00774             <span class="comment">//</span>
00775             <span class="comment">//  Always mark this Irp as pending returned.</span>
00776             <span class="comment">//</span>
00777 
00778             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( NotifyIrp );
00779 
00780             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( NotifyIrp, STATUS_NOTIFY_CLEANUP );
00781             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00782 
00783         <span class="comment">//</span>
00784         <span class="comment">//  If this file has been deleted then complete with STATUS_DELETE_PENDING.</span>
00785         <span class="comment">//</span>
00786 
00787         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_STREAM_IS_DELETED )) {
00788 
00789             <span class="comment">//</span>
00790             <span class="comment">//  Always mark this Irp as pending returned.</span>
00791             <span class="comment">//</span>
00792 
00793             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( NotifyIrp );
00794 
00795             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( NotifyIrp, STATUS_DELETE_PENDING );
00796             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00797 
00798         <span class="comment">//</span>
00799         <span class="comment">//  If the notify pending flag is set or there is data in an internal buffer</span>
00800         <span class="comment">//  we complete this Irp immediately and exit.</span>
00801         <span class="comment">//</span>
00802 
00803         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_IMMEDIATE_NOTIFY )
00804                    &amp;&amp; !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_DEFER_NOTIFY )) {
00805 
00806             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Notify has been pending\n"</span>, 0 );
00807 
00808             <span class="comment">//</span>
00809             <span class="comment">//  Clear the flag in our notify structure before completing the</span>
00810             <span class="comment">//  Irp.  This will prevent a caller who reposts in his completion</span>
00811             <span class="comment">//  routine from looping in the completion routine.</span>
00812             <span class="comment">//</span>
00813 
00814             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_IMMEDIATE_NOTIFY );
00815 
00816             <span class="comment">//</span>
00817             <span class="comment">//  Always mark this Irp as pending returned.</span>
00818             <span class="comment">//</span>
00819 
00820             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( NotifyIrp );
00821 
00822             <a class="code" href="../../d1/d8/fsrtl_8h.html#a47">FsRtlCompleteRequest</a>( NotifyIrp, STATUS_NOTIFY_ENUM_DIR );
00823             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00824 
00825         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> != 0
00826                    &amp;&amp; !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_DEFER_NOTIFY )) {
00827 
00828             ULONG ThisDataLength = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a>;
00829 
00830             <span class="comment">//</span>
00831             <span class="comment">//  Now set our buffer pointers back to indicate an empty buffer.</span>
00832             <span class="comment">//</span>
00833 
00834             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> = 0;
00835             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a> = 0;
00836 
00837             <a class="code" href="../../d2/d7/notify_8c.html#a19">FsRtlNotifyCompleteIrp</a>( NotifyIrp,
00838                                     Notify,
00839                                     ThisDataLength,
00840                                     STATUS_SUCCESS,
00841                                     FALSE );
00842 
00843             <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00844         }
00845 
00846         <span class="comment">//</span>
00847         <span class="comment">//  Add the Irp to the tail of the notify queue.</span>
00848         <span class="comment">//</span>
00849 
00850         NotifyIrp-&gt;IoStatus.Information = (ULONG_PTR) Notify;
00851         <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( NotifyIrp );
00852         InsertTailList( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a>, &amp;NotifyIrp-&gt;Tail.Overlay.ListEntry );
00853 
00854         <span class="comment">//</span>
00855         <span class="comment">//  Increment the reference count to indicate that Irp might go through cancel.</span>
00856         <span class="comment">//</span>
00857 
00858         InterlockedIncrement( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o17">ReferenceCount</a> );
00859 
00860         <span class="comment">//</span>
00861         <span class="comment">//  Call the routine to set the cancel routine.</span>
00862         <span class="comment">//</span>
00863 
00864         <a class="code" href="../../d2/d7/notify_8c.html#a20">FsRtlNotifySetCancelRoutine</a>( NotifyIrp, NULL );
00865 
00866     try_exit:  NOTHING;
00867     } finally {
00868 
00869         <span class="comment">//</span>
00870         <span class="comment">//  Release the mutex.</span>
00871         <span class="comment">//</span>
00872 
00873         <a class="code" href="../../d2/d7/notify_8c.html#a12">ReleaseNotifySync</a>( NotifySync );
00874 
00875         <span class="comment">//</span>
00876         <span class="comment">//  If there is still a subject context then release it and deallocate</span>
00877         <span class="comment">//  the structure.  Remember that if FullDirectoryName is null, it means</span>
00878         <span class="comment">//  this is a view index, not a directory index, and the SubjectContext</span>
00879         <span class="comment">//  is really a piece of file system context information.</span>
00880         <span class="comment">//</span>
00881 
00882         <span class="keywordflow">if</span> ((SubjectContext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00883             (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00884 
00885             <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( SubjectContext );
00886             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( SubjectContext );
00887         }
00888 
00889         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyFullChangeDirectory:  Exit\n"</span>, 0 );
00890     }
00891 
00892     <span class="keywordflow">return</span>;
00893 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="notify.c::FsRtlNotifyFullReportChange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlNotifyFullReportChange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifySync</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FullTargetName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetNameOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING StreamName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING NormalizedParentName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FilterMatch</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Action</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00973">973</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00274">AcquireNotifySync</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00090">Action</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00187">_NOTIFY_CHANGE::AllocatedBuffer</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00147">ASSERTMSG</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00188">_NOTIFY_CHANGE::Buffer</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00189">_NOTIFY_CHANGE::BufferLength</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00166">_NOTIFY_CHANGE::CharacterSize</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00173">_NOTIFY_CHANGE::CompletionFilter</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00191">_NOTIFY_CHANGE::DataLength</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00056">EXCEPTION_CONTINUE_SEARCH</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00159">_NOTIFY_CHANGE::Flags</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00103">_NOTIFY_CHANGE::FsContext</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00082">FsRtlIsNtstatusExpected()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02467">FsRtlNotifyCompleteIrpList()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02286">FsRtlNotifyUpdateBuffer()</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00040">FsRtlpAllocatePool</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00139">_NOTIFY_CHANGE::FullDirectoryName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00192">_NOTIFY_CHANGE::LastEntry</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00194">LongAlign</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01874">MmGetSystemAddressForMdl</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00217">NOTIFY_DEFER_NOTIFY</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00218">NOTIFY_DIR_IS_ROOT</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00215">NOTIFY_IMMEDIATE_NOTIFY</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00214">NOTIFY_WATCH_TREE</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00153">_NOTIFY_CHANGE::NotifyIrps</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00210">_NOTIFY_CHANGE::OwningProcess</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d2/d7/notify_8c.html#a17">PNOTIFY_CHANGE</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00246">PsChargePoolQuota()</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00284">ReleaseNotifySync</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00130">_NOTIFY_CHANGE::SubjectContext</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00190">_NOTIFY_CHANGE::ThisBufferLength</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00120">_NOTIFY_CHANGE::TraverseCallback</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l00897">FsRtlNotifyReportChange()</a>.
<p>
<pre class="fragment"><div>00987                    :
00988 
00989     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system when a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> has been modified in
00990     such a way that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will cause a notify change <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to complete.  We walk
00991     through all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structures looking <span class="keywordflow">for</span> those structures which
00992     would be associated with an ancestor directory of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name.
00993 
00994     We look <span class="keywordflow">for</span> all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structures which have a filter match and
00995     then check that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory name in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a
00996     proper prefix of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full target name.
00997 
00998     If we find a notify structure which matches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> above conditions, we
00999     complete all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Irps <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structure.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure has
01000     no Irps, we mark <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify pending field.
01001 
01002 Arguments:
01003 
01004     NotifySync  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> controlling fast mutex <span class="keywordflow">for</span> <span class="keyword">this</span> notify list.
01005         It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored here so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be found <span class="keywordflow">for</span> an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
01006         cancelled.
01007 
01008     NotifyList  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify list to add <span class="keyword">this</span>
01009         structure to.
01010 
01011     FullTargetName - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
01012 
01013     TargetNameOffset - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> component
01014         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name.
01015 
01016     StreamName  -  If present then <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stream name to store with
01017         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filename.
01018 
01019     NormalizedParentName  -  If present <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent name
01020         but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DOS-ONLY names have been replaced with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> associated <span class="keywordtype">long</span> name.
01021 
01022     FilterMatch  -  This flag field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> compared with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion filter
01023         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structure.  If any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding bits in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01024         completion filter are set, then a notify condition exists.
01025 
01026     <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a>  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> action code to store in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user's buffer <span class="keywordflow">if</span>
01027         present.
01028 
01029     TargetContext  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context pointers to pass to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
01030         system <span class="keywordflow">if</span> performing a traverse check in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> of a tree being
01031         watched.
01032 
01033 Return Value:
01034 
01035     None.
01036 
01037 --*/
01038 
01039 {
01040     PLIST_ENTRY NotifyLinks;
01041 
01042     STRING NormalizedParent;
01043     STRING ParentName;
01044     STRING TargetName;
01045 
01046     <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a> Notify;
01047     STRING TargetParent;
01048     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> NotifyIrp;
01049 
01050     BOOLEAN NotifyIsParent;
01051     BOOLEAN ViewIndex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01052     UCHAR ComponentCount;
01053     ULONG SizeOfEntry;
01054     ULONG CurrentOffset;
01055     ULONG NextEntryOffset;
01056     ULONG ExceptionCode;
01057 
01058     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01059 
01060     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlNotifyFullReportChange:  Entered\n"</span>, 0 );
01061 
01062     <span class="comment">//</span>
01063     <span class="comment">//  If this is a change to the root directory then return immediately.</span>
01064     <span class="comment">//</span>
01065 
01066     <span class="keywordflow">if</span> ((TargetNameOffset == 0) &amp;&amp; (FullTargetName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01067 
01068         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyFullReportChange:  Exit\n"</span>, 0 );
01069         <span class="keywordflow">return</span>;
01070     }
01071 
01072     ParentName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01073     TargetName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01074 
01075     <span class="comment">//</span>
01076     <span class="comment">//  Acquire exclusive access to the list by acquiring the mutex.</span>
01077     <span class="comment">//</span>
01078 
01079     <a class="code" href="../../d2/d7/notify_8c.html#a11">AcquireNotifySync</a>( NotifySync );
01080 
01081     <span class="comment">//</span>
01082     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01083     <span class="comment">//</span>
01084 
01085     <span class="keywordflow">try</span> {
01086 
01087         <span class="comment">//</span>
01088         <span class="comment">//  Walk through all the notify blocks.</span>
01089         <span class="comment">//</span>
01090 
01091         <span class="keywordflow">for</span> (NotifyLinks = NotifyList-&gt;Flink;
01092              NotifyLinks != NotifyList;
01093              NotifyLinks = NotifyLinks-&gt;Flink) {
01094 
01095             <span class="comment">//</span>
01096             <span class="comment">//  Obtain the Notify structure from the list entry.</span>
01097             <span class="comment">//</span>
01098 
01099             Notify = CONTAINING_RECORD( NotifyLinks, <a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html">NOTIFY_CHANGE</a>, NotifyList );
01100 
01101             <span class="comment">//</span>
01102             <span class="comment">//  The rules for deciding whether this notification applies are</span>
01103             <span class="comment">//  different for view indices versus file name indices (directories).</span>
01104             <span class="comment">//</span>
01105 
01106             <span class="keywordflow">if</span> (FullTargetName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01107 
01108                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>( <span class="stringliteral">"Directory notify handle in view index notify list!"</span>, Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a> == NULL);
01109 
01110                 <span class="comment">//</span>
01111                 <span class="comment">//  Make sure this is the Fcb being watched.</span>
01112                 <span class="comment">//</span>
01113 
01114                 <span class="keywordflow">if</span> (TargetContext != Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o4">SubjectContext</a>) {
01115 
01116                     <span class="keywordflow">continue</span>;
01117                 }
01118 
01119                 TargetParent.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01120                 TargetParent.Length = 0;
01121 
01122                 ViewIndex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01123 
01124             <span class="comment">//</span>
01125             <span class="comment">//  Handle the directory case.</span>
01126             <span class="comment">//</span>
01127 
01128             } <span class="keywordflow">else</span> {
01129 
01130                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>( <span class="stringliteral">"View index notify handle in directory notify list!"</span>, Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a> != NULL);
01131 
01132                 <span class="comment">//</span>
01133                 <span class="comment">//  If the length of the name in the notify block is currently zero then</span>
01134                 <span class="comment">//  someone is doing a rename and we can skip this block.</span>
01135                 <span class="comment">//</span>
01136 
01137                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length == 0) {
01138 
01139                     <span class="keywordflow">continue</span>;
01140                 }
01141 
01142                 <span class="comment">//</span>
01143                 <span class="comment">//  If this filter match is not part of the completion filter then continue.</span>
01144                 <span class="comment">//</span>
01145 
01146                 <span class="keywordflow">if</span> (!(FilterMatch &amp; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o10">CompletionFilter</a>)) {
01147 
01148                     <span class="keywordflow">continue</span>;
01149                 }
01150 
01151                 <span class="comment">//</span>
01152                 <span class="comment">//  If there is no normalized name then set its value from the full</span>
01153                 <span class="comment">//  file name.</span>
01154                 <span class="comment">//</span>
01155 
01156                 <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( NormalizedParentName )) {
01157                     NormalizedParent.Buffer = FullTargetName-&gt;Buffer;
01158                     NormalizedParent.Length = TargetNameOffset;
01159 
01160                     <span class="keywordflow">if</span> (NormalizedParent.Length != Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>) {
01161 
01162                         NormalizedParent.Length -= Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>;
01163                     }
01164 
01165                     NormalizedParent.MaximumLength = NormalizedParent.Length;
01166 
01167                     NormalizedParentName = &amp;NormalizedParent;
01168                 }
01169 
01170                 <span class="comment">//</span>
01171                 <span class="comment">//  If the length of the directory being watched is longer than the</span>
01172                 <span class="comment">//  parent of the modified file then it can't be an ancestor of the</span>
01173                 <span class="comment">//  modified file.</span>
01174                 <span class="comment">//</span>
01175 
01176                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length &gt; NormalizedParentName-&gt;Length) {
01177 
01178                     <span class="keywordflow">continue</span>;
01179                 }
01180 
01181                 <span class="comment">//</span>
01182                 <span class="comment">//  If the lengths match exactly then this can only be the parent of</span>
01183                 <span class="comment">//  the modified file.</span>
01184                 <span class="comment">//</span>
01185 
01186                 <span class="keywordflow">if</span> (NormalizedParentName-&gt;Length == Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length) {
01187 
01188                     NotifyIsParent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01189 
01190                 <span class="comment">//</span>
01191                 <span class="comment">//  If we are not watching the subtree of this directory then continue.</span>
01192                 <span class="comment">//</span>
01193 
01194                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_WATCH_TREE )) {
01195 
01196                     <span class="keywordflow">continue</span>;
01197 
01198                 <span class="comment">//</span>
01199                 <span class="comment">//  The watched directory can only be an ancestor of the modified</span>
01200                 <span class="comment">//  file.  Make sure that there is legal pathname separator immediately</span>
01201                 <span class="comment">//  after the end of the watched directory name within the normalized name.</span>
01202                 <span class="comment">//  If the watched directory is the root then we know this condition is TRUE.</span>
01203                 <span class="comment">//</span>
01204 
01205                 } <span class="keywordflow">else</span> {
01206 
01207                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_DIR_IS_ROOT )) {
01208 
01209                         <span class="comment">//</span>
01210                         <span class="comment">//  Check for the character size.</span>
01211                         <span class="comment">//</span>
01212 
01213                         <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> )) {
01214 
01215                             <span class="keywordflow">if</span> (*(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NormalizedParentName-&gt;Buffer,
01216                                            Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length,
01217                                            PCHAR )) != <span class="charliteral">'\\'</span>) {
01218 
01219                                 <span class="keywordflow">continue</span>;
01220                             }
01221 
01222                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NormalizedParentName-&gt;Buffer,
01223                                               Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length,
01224                                               PWCHAR )) != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
01225 
01226                             <span class="keywordflow">continue</span>;
01227                         }
01228                     }
01229 
01230                     NotifyIsParent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01231                 }
01232 
01233                 <span class="comment">//</span>
01234                 <span class="comment">//  We now have a correct match of the name lengths.  Now verify that the</span>
01235                 <span class="comment">//  characters match exactly.</span>
01236                 <span class="comment">//</span>
01237 
01238                 <span class="keywordflow">if</span> (!RtlEqualMemory( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Buffer,
01239                                      NormalizedParentName-&gt;Buffer,
01240                                      Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length )) {
01241 
01242                     <span class="keywordflow">continue</span>;
01243                 }
01244 
01245                 <span class="comment">//</span>
01246                 <span class="comment">//  The characters are correct.  Now check in the case of a non-parent</span>
01247                 <span class="comment">//  notify that we have traverse callback.</span>
01248                 <span class="comment">//</span>
01249 
01250                 <span class="keywordflow">if</span> (!NotifyIsParent &amp;&amp;
01251                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o3">TraverseCallback</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01252                     !Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o3">TraverseCallback</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o1">FsContext</a>,
01253                                                TargetContext,
01254                                                Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o4">SubjectContext</a> )) {
01255 
01256                     <span class="keywordflow">continue</span>;
01257                 }
01258             }
01259 
01260             <span class="comment">//</span>
01261             <span class="comment">//  If this entry is going into a buffer then check that</span>
01262             <span class="comment">//  it will fit.</span>
01263             <span class="comment">//</span>
01264 
01265             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_IMMEDIATE_NOTIFY )
01266                 &amp;&amp; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a> != 0) {
01267 
01268                 ULONG AllocationLength;
01269 
01270                 AllocationLength = 0;
01271                 NotifyIrp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01272 
01273                 <span class="comment">//</span>
01274                 <span class="comment">//  If we don't already have a buffer then check to see</span>
01275                 <span class="comment">//  if we have any Irps in the list and use the buffer</span>
01276                 <span class="comment">//  length in the Irp.</span>
01277                 <span class="comment">//</span>
01278 
01279                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> == 0) {
01280 
01281                     <span class="comment">//</span>
01282                     <span class="comment">//  If there is an entry in the list then get the length.</span>
01283                     <span class="comment">//</span>
01284 
01285                     <span class="keywordflow">if</span> (!IsListEmpty( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a> )) {
01286 
01287                         <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
01288 
01289                         NotifyIrp = CONTAINING_RECORD( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a>.Flink,
01290                                                        <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>,
01291                                                        Tail.Overlay.ListEntry );
01292 
01293                         IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( NotifyIrp );
01294 
01295                         AllocationLength = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.NotifyDirectory.Length;
01296 
01297                     <span class="comment">//</span>
01298                     <span class="comment">//  Otherwise use the caller's last buffer size.</span>
01299                     <span class="comment">//</span>
01300 
01301                     } <span class="keywordflow">else</span> {
01302 
01303                         AllocationLength = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o13">BufferLength</a>;
01304                     }
01305 
01306                 <span class="comment">//</span>
01307                 <span class="comment">//  Otherwise use the length of the current buffer.</span>
01308                 <span class="comment">//</span>
01309 
01310                 } <span class="keywordflow">else</span> {
01311 
01312                     AllocationLength = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a>;
01313                 }
01314 
01315                 <span class="comment">//</span>
01316                 <span class="comment">//  Build the strings for the relative name.  This includes</span>
01317                 <span class="comment">//  the strings for the parent name, file name and stream</span>
01318                 <span class="comment">//  name.</span>
01319                 <span class="comment">//</span>
01320 
01321                 <span class="keywordflow">if</span> (!NotifyIsParent) {
01322 
01323                     <span class="comment">//</span>
01324                     <span class="comment">//  We need to find the string for the ancestor of this</span>
01325                     <span class="comment">//  file from the watched directory.  If the normalized parent</span>
01326                     <span class="comment">//  name is the same as the parent name then we can use</span>
01327                     <span class="comment">//  the tail of the parent directly.  Otherwise we need to</span>
01328                     <span class="comment">//  count the matching name components and capture the</span>
01329                     <span class="comment">//  final components.</span>
01330                     <span class="comment">//</span>
01331 
01332                     <span class="keywordflow">if</span> (!ViewIndex) {
01333 
01334                         <span class="comment">//</span>
01335                         <span class="comment">//  If the watched directory is the root then we just use the full</span>
01336                         <span class="comment">//  parent name.</span>
01337                         <span class="comment">//</span>
01338 
01339                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_DIR_IS_ROOT ) ||
01340                             NormalizedParentName-&gt;Buffer != FullTargetName-&gt;Buffer) {
01341 
01342                             <span class="comment">//</span>
01343                             <span class="comment">//  If we don't have a string for the parent then construct</span>
01344                             <span class="comment">//  it now.</span>
01345                             <span class="comment">//</span>
01346 
01347                             <span class="keywordflow">if</span> (ParentName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01348 
01349                                 ParentName.Buffer = FullTargetName-&gt;Buffer;
01350                                 ParentName.Length = TargetNameOffset;
01351 
01352                                 <span class="keywordflow">if</span> (ParentName.Length != Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>) {
01353 
01354                                     ParentName.Length -= Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>;
01355                                 }
01356 
01357                                 ParentName.MaximumLength = ParentName.Length;
01358                             }
01359 
01360                             <span class="comment">//</span>
01361                             <span class="comment">//  Count through the components of the parent until we have</span>
01362                             <span class="comment">//  swallowed the same number of name components as in the</span>
01363                             <span class="comment">//  watched directory name.  We have the unicode version and</span>
01364                             <span class="comment">//  the Ansi version to watch for.</span>
01365                             <span class="comment">//</span>
01366 
01367                             ComponentCount = 0;
01368                             CurrentOffset = 0;
01369 
01370                             <span class="comment">//</span>
01371                             <span class="comment">//  If this is the root then there is no more to do.</span>
01372                             <span class="comment">//</span>
01373 
01374                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_DIR_IS_ROOT )) {
01375 
01376                                 NOTHING;
01377 
01378                             } <span class="keywordflow">else</span> {
01379 
01380                                 ULONG ParentComponentCount;
01381                                 ULONG ParentOffset;
01382 
01383                                 ParentComponentCount = 1;
01384                                 ParentOffset = 0;
01385 
01386                                 <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> )) {
01387 
01388                                     <span class="comment">//</span>
01389                                     <span class="comment">//  Find the number of components in the parent.  We</span>
01390                                     <span class="comment">//  have to do this for each one because this name and</span>
01391                                     <span class="comment">//  the number of components could have changed.</span>
01392                                     <span class="comment">//</span>
01393 
01394                                     <span class="keywordflow">while</span> (ParentOffset &lt; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length) {
01395 
01396                                         <span class="keywordflow">if</span> (*((PCHAR) Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Buffer + ParentOffset) == <span class="charliteral">'\\'</span>) {
01397 
01398                                             ParentComponentCount += 1;
01399                                         }
01400 
01401                                         ParentOffset += 1;
01402                                     }
01403 
01404                                     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01405 
01406                                         <span class="keywordflow">if</span> (*((PCHAR) ParentName.Buffer + CurrentOffset) == <span class="charliteral">'\\'</span>) {
01407 
01408                                             ComponentCount += 1;
01409 
01410                                             <span class="keywordflow">if</span> (ComponentCount == ParentComponentCount) {
01411 
01412                                                 <span class="keywordflow">break</span>;
01413                                             }
01414 
01415                                         }
01416 
01417                                         CurrentOffset += 1;
01418                                     }
01419 
01420                                 } <span class="keywordflow">else</span> {
01421 
01422                                     <span class="comment">//</span>
01423                                     <span class="comment">//  Find the number of components in the parent.  We</span>
01424                                     <span class="comment">//  have to do this for each one because this name and</span>
01425                                     <span class="comment">//  the number of components could have changed.</span>
01426                                     <span class="comment">//</span>
01427 
01428                                     <span class="keywordflow">while</span> (ParentOffset &lt; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length / <span class="keyword">sizeof</span>( WCHAR )) {
01429 
01430                                         <span class="keywordflow">if</span> (*((PWCHAR) Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Buffer + ParentOffset) == <span class="charliteral">'\\'</span>) {
01431 
01432                                             ParentComponentCount += 1;
01433                                         }
01434 
01435                                         ParentOffset += 1;
01436                                     }
01437 
01438                                     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01439 
01440                                         <span class="keywordflow">if</span> (*((PWCHAR) ParentName.Buffer + CurrentOffset) == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
01441 
01442                                             ComponentCount += 1;
01443 
01444                                             <span class="keywordflow">if</span> (ComponentCount == ParentComponentCount) {
01445 
01446                                                 <span class="keywordflow">break</span>;
01447                                             }
01448                                         }
01449 
01450                                         CurrentOffset += 1;
01451                                     }
01452 
01453                                     <span class="comment">//</span>
01454                                     <span class="comment">//  Convert characters to bytes.</span>
01455                                     <span class="comment">//</span>
01456 
01457                                     CurrentOffset *= Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>;
01458                                 }
01459                             }
01460 
01461                             <span class="comment">//</span>
01462                             <span class="comment">//  We now know the offset into the parent name of the separator</span>
01463                             <span class="comment">//  immediately preceding the relative parent name.  Construct the</span>
01464                             <span class="comment">//  target parent name for the buffer.</span>
01465                             <span class="comment">//</span>
01466 
01467                             CurrentOffset += Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>;
01468 
01469                             TargetParent.Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( ParentName.Buffer,
01470                                                            CurrentOffset,
01471                                                            PCHAR );
01472                             TargetParent.MaximumLength =
01473                             TargetParent.Length = ParentName.Length - (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) CurrentOffset;
01474 
01475                         <span class="comment">//</span>
01476                         <span class="comment">//  If the normalized is the same as the parent name use the portion</span>
01477                         <span class="comment">//  after the match with the watched directory.</span>
01478                         <span class="comment">//</span>
01479 
01480                         } <span class="keywordflow">else</span> {
01481 
01482                             TargetParent.Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NormalizedParentName-&gt;Buffer,
01483                                                            (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length +
01484                                                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>),
01485                                                            PCHAR );
01486 
01487                             TargetParent.MaximumLength =
01488                             TargetParent.Length = NormalizedParentName-&gt;Length -
01489                                                   Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o5">FullDirectoryName</a>-&gt;Length -
01490                                                   Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a>;
01491 
01492                         }
01493                     }
01494 
01495                 } <span class="keywordflow">else</span> {
01496 
01497                     <span class="comment">//</span>
01498                     <span class="comment">//  The length of the target parent is zero.</span>
01499                     <span class="comment">//</span>
01500 
01501                     TargetParent.Length = 0;
01502                 }
01503 
01504                 <span class="comment">//</span>
01505                 <span class="comment">//  Compute how much buffer space this report will take.</span>
01506                 <span class="comment">//</span>
01507 
01508                 SizeOfEntry = FIELD_OFFSET( FILE_NOTIFY_INFORMATION, FileName );
01509 
01510                 <span class="keywordflow">if</span> (ViewIndex) {
01511 
01512                     <span class="comment">//</span>
01513                     <span class="comment">//  In the view index case, the information to copy to the</span>
01514                     <span class="comment">//  buffer comes to us in the stream name, and that is all</span>
01515                     <span class="comment">//  the room we need to worry about having.</span>
01516                     <span class="comment">//</span>
01517 
01518                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ARGUMENT_PRESENT( StreamName ));
01519 
01520                     SizeOfEntry += StreamName-&gt;Length;
01521 
01522                 } <span class="keywordflow">else</span> {
01523 
01524                     <span class="comment">//</span>
01525                     <span class="comment">//  If there is a parent to report, find the size and include a separator</span>
01526                     <span class="comment">//  character.</span>
01527                     <span class="comment">//</span>
01528 
01529                     <span class="keywordflow">if</span> (!NotifyIsParent) {
01530 
01531                         <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> )) {
01532 
01533                             SizeOfEntry += RtlOemStringToCountedUnicodeSize( &amp;TargetParent );
01534 
01535                         } <span class="keywordflow">else</span> {
01536 
01537                             SizeOfEntry += TargetParent.Length;
01538                         }
01539 
01540                         <span class="comment">//</span>
01541                         <span class="comment">//  Include the separator.  This is always a unicode character.</span>
01542                         <span class="comment">//</span>
01543 
01544                         SizeOfEntry += <span class="keyword">sizeof</span>( WCHAR );
01545                     }
01546 
01547                     <span class="comment">//</span>
01548                     <span class="comment">//  If we don't have the string for the target then construct it now.</span>
01549                     <span class="comment">//</span>
01550 
01551                     <span class="keywordflow">if</span> (TargetName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01552 
01553                         TargetName.Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( FullTargetName-&gt;Buffer, TargetNameOffset, PCHAR );
01554                         TargetName.MaximumLength =
01555                         TargetName.Length = FullTargetName-&gt;Length - TargetNameOffset;
01556                     }
01557 
01558                     <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> )) {
01559 
01560                         SizeOfEntry += RtlOemStringToCountedUnicodeSize( &amp;TargetName );
01561 
01562                     } <span class="keywordflow">else</span> {
01563 
01564                         SizeOfEntry += TargetName.Length;
01565                     }
01566 
01567                     <span class="comment">//</span>
01568                     <span class="comment">//  If there is a stream name then add the bytes needed</span>
01569                     <span class="comment">//  for that.</span>
01570                     <span class="comment">//</span>
01571 
01572                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( StreamName )) {
01573 
01574                         <span class="comment">//</span>
01575                         <span class="comment">//  Add the space needed for the ':' separator.</span>
01576                         <span class="comment">//</span>
01577 
01578                         <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( WCHAR )) {
01579 
01580                             SizeOfEntry += (StreamName-&gt;Length + <span class="keyword">sizeof</span>( WCHAR ));
01581 
01582                         } <span class="keywordflow">else</span> {
01583 
01584                             SizeOfEntry += (RtlOemStringToCountedUnicodeSize( StreamName )
01585                                             + <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> ));
01586                         }
01587                     }
01588                 }
01589 
01590                 <span class="comment">//</span>
01591                 <span class="comment">//  Remember if this report would overflow the buffer.</span>
01592                 <span class="comment">//</span>
01593 
01594                 NextEntryOffset = (ULONG)<a class="code" href="../../d3/d8/fsrtlp_8h.html#a10">LongAlign</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> );
01595 
01596                 <span class="keywordflow">if</span> (SizeOfEntry &lt;= AllocationLength
01597                     &amp;&amp; (NextEntryOffset + SizeOfEntry) &lt;= AllocationLength) {
01598 
01599                     PFILE_NOTIFY_INFORMATION NotifyInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01600 
01601                     <span class="comment">//</span>
01602                     <span class="comment">//  If there is already a notify buffer, we append this</span>
01603                     <span class="comment">//  data to it.</span>
01604                     <span class="comment">//</span>
01605 
01606                     <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01607 
01608                         NotifyInfo = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a>,
01609                                               Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a>,
01610                                               PFILE_NOTIFY_INFORMATION );
01611 
01612                         NotifyInfo-&gt;NextEntryOffset = NextEntryOffset - Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a>;
01613 
01614                         Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a> = NextEntryOffset;
01615 
01616                         NotifyInfo = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a>,
01617                                               Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a>,
01618                                               PFILE_NOTIFY_INFORMATION );
01619 
01620                     <span class="comment">//</span>
01621                     <span class="comment">//  If there is an Irp list we check whether we will need</span>
01622                     <span class="comment">//  to allocate a new buffer.</span>
01623                     <span class="comment">//</span>
01624 
01625                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NotifyIrp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01626 
01627                         <span class="keywordflow">if</span> (NotifyIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01628 
01629                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> =
01630                             NotifyInfo = NotifyIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
01631 
01632                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> = AllocationLength;
01633 
01634                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NotifyIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01635 
01636                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> =
01637                             NotifyInfo = <a class="code" href="../../d2/d1/mm_8h.html#a26">MmGetSystemAddressForMdl</a>( NotifyIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> );
01638 
01639                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> = AllocationLength;
01640                         }
01641                     }
01642 
01643                     <span class="comment">//</span>
01644                     <span class="comment">//  If we need to allocate a buffer, we will charge quota</span>
01645                     <span class="comment">//  to the original process and allocate paged pool.</span>
01646                     <span class="comment">//</span>
01647 
01648                     <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01649 
01650                         BOOLEAN ChargedQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01651 
01652                         <span class="keywordflow">try</span> {
01653 
01654                             <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
01655                                                PagedPool,
01656                                                AllocationLength );
01657 
01658                             ChargedQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01659 
01660                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> =
01661                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( PagedPool,
01662                                                                  AllocationLength );
01663 
01664                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> = AllocationLength;
01665 
01666                             NotifyInfo = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a>;
01667 
01668                         } except(( ExceptionCode = GetExceptionCode(), <a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>(ExceptionCode))
01669                                   ? EXCEPTION_EXECUTE_HANDLER
01670                                   : EXCEPTION_CONTINUE_SEARCH ) {
01671 
01672                             
01673                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (ExceptionCode == STATUS_INSUFFICIENT_RESOURCES) ||
01674                                     (ExceptionCode == STATUS_QUOTA_EXCEEDED) );
01675 
01676                             <span class="comment">//</span>
01677                             <span class="comment">//  Return quota if we allocated the buffer.</span>
01678                             <span class="comment">//</span>
01679 
01680                             <span class="keywordflow">if</span> (ChargedQuota) {
01681 
01682                                 <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
01683                                                    PagedPool,
01684                                                    AllocationLength );
01685 
01686                             }
01687 
01688                             <span class="comment">//</span>
01689                             <span class="comment">//  Forget any current buffer and resort to immediate</span>
01690                             <span class="comment">//  notify.</span>
01691                             <span class="comment">//</span>
01692 
01693                             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_IMMEDIATE_NOTIFY );
01694                         }
01695                     }
01696 
01697                     <span class="comment">//</span>
01698                     <span class="comment">//  If we have a buffer then fill in the results</span>
01699                     <span class="comment">//  from this operation.  Otherwise we remember</span>
01700                     <span class="comment">//  to simply alert the caller.</span>
01701                     <span class="comment">//</span>
01702 
01703                     <span class="keywordflow">if</span> (NotifyInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01704 
01705                         <span class="comment">//</span>
01706                         <span class="comment">//  Update the buffer with the current data.</span>
01707                         <span class="comment">//</span>
01708 
01709                         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/notify_8c.html#a21">FsRtlNotifyUpdateBuffer</a>( NotifyInfo,
01710                                                      Action,
01711                                                      &amp;TargetParent,
01712                                                      &amp;TargetName,
01713                                                      StreamName,
01714                                                      (BOOLEAN) (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o9">CharacterSize</a> == <span class="keyword">sizeof</span>( WCHAR )),
01715                                                      SizeOfEntry )) {
01716 
01717                             <span class="comment">//</span>
01718                             <span class="comment">//  Update the buffer data length.</span>
01719                             <span class="comment">//</span>
01720 
01721                             Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> = NextEntryOffset + SizeOfEntry;
01722 
01723                         <span class="comment">//</span>
01724                         <span class="comment">//  We couldn't copy the data into the buffer.  Just</span>
01725                         <span class="comment">//  notify without any additional information.</span>
01726                         <span class="comment">//</span>
01727 
01728                         } <span class="keywordflow">else</span> {
01729 
01730                             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_IMMEDIATE_NOTIFY );
01731                         }
01732                     }
01733 
01734                 } <span class="keywordflow">else</span> {
01735 
01736                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_IMMEDIATE_NOTIFY );
01737                 }
01738 
01739                 <span class="comment">//</span>
01740                 <span class="comment">//  If we have a buffer but can't use it then clear all of the</span>
01741                 <span class="comment">//  buffer related fields.  Also deallocate any buffer allocated</span>
01742                 <span class="comment">//  by us.</span>
01743                 <span class="comment">//</span>
01744 
01745                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_IMMEDIATE_NOTIFY )
01746                     &amp;&amp; Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01747 
01748                     <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01749 
01750                         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o18">OwningProcess</a>,
01751                                            PagedPool,
01752                                            Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> );
01753 
01754                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> );
01755                     }
01756 
01757                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o11">AllocatedBuffer</a> = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o12">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01758 
01759                     Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o14">ThisBufferLength</a> = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o15">DataLength</a> = Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o16">LastEntry</a> = 0;
01760                 }
01761             }
01762 
01763             <span class="comment">//</span>
01764             <span class="comment">//  Complete the next entry on the list if we aren't holding</span>
01765             <span class="comment">//  up notification.</span>
01766             <span class="comment">//</span>
01767 
01768             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == FILE_ACTION_RENAMED_OLD_NAME) {
01769 
01770                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_DEFER_NOTIFY );
01771 
01772             } <span class="keywordflow">else</span> {
01773 
01774                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o8">Flags</a>, NOTIFY_DEFER_NOTIFY );
01775 
01776                 <span class="keywordflow">if</span> (!IsListEmpty( &amp;Notify-&gt;<a class="code" href="../../d9/d3/struct__NOTIFY__CHANGE.html#o7">NotifyIrps</a> )) {
01777 
01778                     <a class="code" href="../../d2/d7/notify_8c.html#a32">FsRtlNotifyCompleteIrpList</a>( Notify, STATUS_SUCCESS );
01779                 }
01780             }
01781         }
01782 
01783     } finally {
01784 
01785         <a class="code" href="../../d2/d7/notify_8c.html#a12">ReleaseNotifySync</a>( NotifySync );
01786 
01787         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyFullReportChange:  Exit\n"</span>, 0 );
01788     }
01789 
01790     <span class="keywordflow">return</span>;
01791 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="notify.c::FsRtlNotifyInitializeSync" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlNotifyInitializeSync           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NotifySync</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00371">371</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02274">ERESOURCE_THREAD</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00076">_REAL_NOTIFY_SYNC::FastMutex</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00040">FsRtlpAllocatePool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00078">_REAL_NOTIFY_SYNC::OwnerCount</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00077">_REAL_NOTIFY_SYNC::OwningThread</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01443">PNOTIFY_SYNC</a>, and <a class="el" href="../../d2/d7/notify_8c.html#a15">PREAL_NOTIFY_SYNC</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00331">UdfInitializeVcb()</a>.
<p>
<pre class="fragment"><div>00377                    :
00378 
00379     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to allocate and initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> synchronization object
00380     <span class="keywordflow">for</span> <span class="keyword">this</span> notify list.
00381 
00382 Arguments:
00383 
00384     NotifySync  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure we allocate.
00385 
00386 Return Value:
00387 
00388     None.
00389 
00390 --*/
00391 
00392 {
00393     <a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">PREAL_NOTIFY_SYNC</a> RealSync;
00394 
00395     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00396 
00397     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlNotifyInitializeSync:  Entered\n"</span>, 0 );
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">//  Clear the pointer and then attempt to allocate a non-paged</span>
00401     <span class="comment">//  structure.</span>
00402     <span class="comment">//</span>
00403 
00404     *NotifySync = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00405 
00406     RealSync = (<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">PREAL_NOTIFY_SYNC</a>) <a class="code" href="../../d3/d8/fsrtlp_8h.html#a2">FsRtlpAllocatePool</a>( NonPagedPool,
00407                                                        <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html">REAL_NOTIFY_SYNC</a> ));
00408 
00409     <span class="comment">//</span>
00410     <span class="comment">//  Initialize the structure.</span>
00411     <span class="comment">//</span>
00412 
00413     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( &amp;RealSync-&gt;<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html#o0">FastMutex</a> );
00414     RealSync-&gt;<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html#o1">OwningThread</a> = (<a class="code" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>) 0;
00415     RealSync-&gt;<a class="code" href="../../d7/d2/struct__REAL__NOTIFY__SYNC.html#o2">OwnerCount</a> = 0;
00416 
00417     *NotifySync = (<a class="code" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a>) RealSync;
00418 
00419     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyInitializeSync:  Exit\n"</span>, 0 );
00420     <span class="keywordflow">return</span>;
00421 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="notify.c::FsRtlNotifyReportChange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlNotifyReportChange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifySync</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FullTargetName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FilterMatch</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00897">897</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00973">FsRtlNotifyFullReportChange()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00907                    :
00908 
00909     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system when a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> has been modified in
00910     such a way that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will cause a notify change <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to complete.  We walk
00911     through all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structures looking <span class="keywordflow">for</span> those structures which
00912     would be associated with an ancestor directory of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name.
00913 
00914     We look <span class="keywordflow">for</span> all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structures which have a filter match and
00915     then check that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory name in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a
00916     proper prefix of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full target name.
00917 
00918     If we find a notify structure which matches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> above conditions, we
00919     complete all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Irps <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structure.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure has
00920     no Irps, we mark <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify pending field.
00921 
00922 Arguments:
00923 
00924     NotifySync  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> controlling fast mutex <span class="keywordflow">for</span> <span class="keyword">this</span> notify list.
00925         It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> stored here so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be found <span class="keywordflow">for</span> an <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00926         cancelled.
00927 
00928     NotifyList  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify list to add <span class="keyword">this</span>
00929                    structure to.
00930 
00931     FullTargetName  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> which has been
00932                        changed.
00933 
00934     TargetName  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> component of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00935 
00936     FilterMatch  -  This flag field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> compared with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion filter
00937                     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notify structure.  If any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding
00938                     bits in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> completion filter are set, then a notify
00939                     condition exists.
00940 
00941 Return Value:
00942 
00943     None.
00944 
00945 --*/
00946 
00947 {
00948     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00949 
00950     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlNotifyReportChange:  Entered\n"</span>, 0 );
00951 
00952     <span class="comment">//</span>
00953     <span class="comment">//  Call the full notify routine to do the actual work.</span>
00954     <span class="comment">//</span>
00955 
00956     <a class="code" href="../../d1/d8/fsrtl_8h.html#a174">FsRtlNotifyFullReportChange</a>( NotifySync,
00957                                  NotifyList,
00958                                  FullTargetName,
00959                                  (USHORT) (FullTargetName-&gt;Length - TargetName-&gt;Length),
00960                                  NULL,
00961                                  NULL,
00962                                  FilterMatch,
00963                                  0,
00964                                  NULL );
00965 
00966     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyReportChange:  Exit\n"</span>, 0 );
00967 
00968     <span class="keywordflow">return</span>;
00969 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="notify.c::FsRtlNotifySetCancelRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlNotifySetCancelRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyIrp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d3/struct__NOTIFY__CHANGE.html">PNOTIFY_CHANGE</a> Notify&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l02195">2195</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02555">FsRtlCancelNotify()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00100">IoAcquireCancelSpinLock()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09613">IoReleaseCancelSpinLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03867">IoSetCancelRoutine</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00547">PDRIVER_CANCEL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l02000">FsRtlNotifyCompleteIrp()</a>, and <a class="el" href="../../d3/d6/notify_8c-source.html#l00547">FsRtlNotifyFullChangeDirectory()</a>.
<p>
<pre class="fragment"><div>02202                    :
02203 
02204     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a separate routine because <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> cannot be paged.
02205 
02206 Arguments:
02207 
02208     NotifyIrp  -  Set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cancel routine in <span class="keyword">this</span> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
02209 
02210     Notify - If <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> then we are setting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cancel routine.  If not-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> then we
02211         are clearing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cancel routine.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cancel routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not-null then
02212         we need to decrement <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count on <span class="keyword">this</span> Notify structure
02213 
02214 Return Value:
02215 
02216     BOOLEAN - Only meaningfull <span class="keywordflow">if</span> Notify <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified.  It indicates <span class="keywordflow">if</span> <span class="keyword">this</span>
02217         routine cleared <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cancel routine.  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cancel
02218         routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> processing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
02219 
02220 --*/
02221 
02222 {
02223     BOOLEAN ClearedCancel = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02224     <a class="code" href="../../d0/d5/io_8h.html#a286">PDRIVER_CANCEL</a> CurrentCancel;
02225 
02226     <span class="comment">//</span>
02227     <span class="comment">//  Grab the cancel spinlock and set our cancel routine in the Irp.</span>
02228     <span class="comment">//</span>
02229 
02230     <a class="code" href="../../d4/d6/iosubs_8c.html#a9">IoAcquireCancelSpinLock</a>( &amp;NotifyIrp-&gt;CancelIrql );
02231 
02232     <span class="comment">//</span>
02233     <span class="comment">//  If we are completing an Irp then clear the cancel routine and</span>
02234     <span class="comment">//  the information field.</span>
02235     <span class="comment">//</span>
02236 
02237     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Notify )) {
02238 
02239         CurrentCancel = <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( NotifyIrp, NULL );
02240         NotifyIrp-&gt;IoStatus.Information = 0;
02241 
02242         <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( NotifyIrp-&gt;CancelIrql );
02243 
02244         <span class="comment">//</span>
02245         <span class="comment">//  If the current cancel routine is non-NULL then decrement the reference count</span>
02246         <span class="comment">//  in the Notify.</span>
02247         <span class="comment">//</span>
02248 
02249         <span class="keywordflow">if</span> (CurrentCancel != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02250 
02251             InterlockedDecrement( &amp;Notify-&gt;ReferenceCount );
02252             ClearedCancel = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02253         }
02254 
02255     <span class="comment">//</span>
02256     <span class="comment">//  If the cancel flag is set, we complete the Irp with cancelled</span>
02257     <span class="comment">//  status and exit.</span>
02258     <span class="comment">//</span>
02259 
02260     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NotifyIrp-&gt;Cancel) {
02261 
02262             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Irp has been cancelled\n"</span>, 0 );
02263 
02264             <a class="code" href="../../d2/d7/notify_8c.html#a23">FsRtlCancelNotify</a>( NULL, NotifyIrp );
02265 
02266     } <span class="keywordflow">else</span> {
02267 
02268         <span class="comment">//</span>
02269         <span class="comment">//  Set our cancel routine in the Irp.</span>
02270         <span class="comment">//</span>
02271 
02272         <a class="code" href="../../d0/d5/io_8h.html#a236">IoSetCancelRoutine</a>( NotifyIrp, FsRtlCancelNotify );
02273 
02274         <a class="code" href="../../d4/d6/iosubs_8c.html#a101">IoReleaseCancelSpinLock</a>( NotifyIrp-&gt;CancelIrql );
02275     }
02276 
02277     <span class="keywordflow">return</span> ClearedCancel;
02278 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="notify.c::FsRtlNotifyUninitializeSync" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FsRtlNotifyUninitializeSync           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a81">PNOTIFY_SYNC</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NotifySync</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l00426">426</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01210">UdfDeleteVcb()</a>.
<p>
<pre class="fragment"><div>00432                    :
00433 
00434     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to uninitialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> synchronization object
00435     <span class="keywordflow">for</span> <span class="keyword">this</span> notify list.
00436 
00437 Arguments:
00438 
00439     NotifySync  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to our synchronization
00440         object.
00441 
00442 Return Value:
00443 
00444     None.
00445 
00446 --*/
00447 
00448 {
00449     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00450 
00451     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlNotifyUninitializeSync:  Entered\n"</span>, 0 );
00452 
00453     <span class="comment">//</span>
00454     <span class="comment">//  Free the structure if present and clear the pointer.</span>
00455     <span class="comment">//</span>
00456 
00457     <span class="keywordflow">if</span> (*NotifySync != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00458 
00459         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( *NotifySync );
00460         *NotifySync = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00461     }
00462 
00463     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyUninitializeSync:  Exit\n"</span>, 0 );
00464     <span class="keywordflow">return</span>;
00465 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="notify.c::FsRtlNotifyUpdateBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlNotifyUpdateBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PFILE_NOTIFY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>NotifyInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileAction</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING StreamName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>UnicodeName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SizeOfEntry</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/notify_8c-source.html#l02286">2286</a> of file <a class="el" href="../../d3/d6/notify_8c-source.html">notify.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d6/nlsxlat_8c-source.html#l00576">RtlOemToUnicodeN()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/notify_8c-source.html#l00973">FsRtlNotifyFullReportChange()</a>.
<p>
<pre class="fragment"><div>02298                    :
02299 
02300     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to fill in a FILE_NOTIFY_INFORMATION structure <span class="keywordflow">for</span> a
02301     notify change event.  The <a class="code" href="../../d3/d9/arcinst_8c.html#a19">main</a> work <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in converting an OEM string to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.
02302 
02303 Arguments:
02304 
02305     NotifyInfo  -  Information structure to complete.
02306 
02307     FileAction  -  <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> which triggered <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> notification event.
02308 
02309     ParentName  -  Relative <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> changed <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02310         directory being watched.  The length <span class="keywordflow">for</span> <span class="keyword">this</span> will be zero <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified
02311         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> watched directory.
02312 
02313     TargetName  -  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
02314 
02315     StreamName  -  If present there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a stream name to append to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filename.
02316 
02317     UnicodeName  -  Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> above name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> or Oem.
02318 
02319     SizeOfEntry  -  Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to be used in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
02320 
02321 Return Value:
02322 
02323     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> we were able to update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
02324 
02325 --*/
02326 
02327 {
02328     BOOLEAN CopiedToBuffer;
02329     ULONG BufferOffset = 0;
02330 
02331     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02332 
02333     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"FsRtlNotifyUpdateBuffer:  Entered\n"</span>, 0 );
02334 
02335     <span class="comment">//</span>
02336     <span class="comment">//  Protect the entire call with a try-except.  If we had an error</span>
02337     <span class="comment">//  we will assume that we have a bad buffer and we won't return</span>
02338     <span class="comment">//  the data in the buffer.</span>
02339     <span class="comment">//</span>
02340 
02341     <span class="keywordflow">try</span> {
02342 
02343         <span class="comment">//</span>
02344         <span class="comment">//  Update the common fields in the notify information.</span>
02345         <span class="comment">//</span>
02346 
02347         NotifyInfo-&gt;NextEntryOffset = 0;
02348         NotifyInfo-&gt;Action = FileAction;
02349 
02350         NotifyInfo-&gt;FileNameLength = SizeOfEntry - FIELD_OFFSET( FILE_NOTIFY_INFORMATION, FileName );
02351 
02352         <span class="comment">//</span>
02353         <span class="comment">//  If we have a unicode name, then copy the data directly into the output buffer.</span>
02354         <span class="comment">//</span>
02355 
02356         <span class="keywordflow">if</span> (UnicodeName) {
02357 
02358             <span class="keywordflow">if</span> (ParentName-&gt;Length != 0) {
02359 
02360                 RtlCopyMemory( NotifyInfo-&gt;FileName,
02361                                ParentName-&gt;Buffer,
02362                                ParentName-&gt;Length );
02363 
02364                 *(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName, ParentName-&gt;Length, PWCHAR )) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>;
02365                 BufferOffset = ParentName-&gt;Length + <span class="keyword">sizeof</span>( WCHAR );
02366             }
02367 
02368             RtlCopyMemory( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName,
02369                                     BufferOffset,
02370                                     PVOID ),
02371                            TargetName-&gt;Buffer,
02372                            TargetName-&gt;Length );
02373 
02374             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( StreamName )) {
02375 
02376                 BufferOffset += TargetName-&gt;Length;
02377 
02378                 *(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName, BufferOffset, PWCHAR )) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">':'</span>;
02379 
02380                 RtlCopyMemory( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName,
02381                                         BufferOffset + <span class="keyword">sizeof</span>( WCHAR ),
02382                                         PVOID ),
02383                                StreamName-&gt;Buffer,
02384                                StreamName-&gt;Length );
02385             }
02386 
02387         <span class="comment">//</span>
02388         <span class="comment">//  For a non-unicode name, use the conversion routines.</span>
02389         <span class="comment">//</span>
02390 
02391         } <span class="keywordflow">else</span> {
02392 
02393             ULONG BufferLength;
02394 
02395             <span class="keywordflow">if</span> (ParentName-&gt;Length != 0) {
02396 
02397                 <a class="code" href="../../d9/d6/nlsxlat_8c.html#a34">RtlOemToUnicodeN</a>( NotifyInfo-&gt;FileName,
02398                                   NotifyInfo-&gt;FileNameLength,
02399                                   &amp;BufferLength,
02400                                   ParentName-&gt;Buffer,
02401                                   ParentName-&gt;Length );
02402 
02403                 *(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName, BufferLength, PWCHAR )) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>;
02404 
02405                 BufferOffset = BufferLength + <span class="keyword">sizeof</span>( WCHAR );
02406             }
02407 
02408             <span class="comment">//</span>
02409             <span class="comment">//  For view indices, we do not have a parent name.</span>
02410             <span class="comment">//</span>
02411 
02412             <span class="keywordflow">if</span> (ParentName-&gt;Length == 0) {
02413 
02414                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ARGUMENT_PRESENT( StreamName ));
02415 
02416                 RtlCopyMemory( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName,
02417                                            BufferOffset,
02418                                            PCHAR ),
02419                                StreamName-&gt;Buffer,
02420                                StreamName-&gt;Length );
02421 
02422             } <span class="keywordflow">else</span> {
02423 
02424                 <a class="code" href="../../d9/d6/nlsxlat_8c.html#a34">RtlOemToUnicodeN</a>( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName,
02425                                            BufferOffset,
02426                                            PWCHAR ),
02427                                   NotifyInfo-&gt;FileNameLength,
02428                                   &amp;BufferLength,
02429                                   TargetName-&gt;Buffer,
02430                                   TargetName-&gt;Length );
02431 
02432                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( StreamName )) {
02433 
02434                     BufferOffset += BufferLength;
02435 
02436                     *(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName, BufferOffset, PWCHAR )) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">':'</span>;
02437 
02438                     <a class="code" href="../../d9/d6/nlsxlat_8c.html#a34">RtlOemToUnicodeN</a>( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NotifyInfo-&gt;FileName,
02439                                                BufferOffset + <span class="keyword">sizeof</span>( WCHAR ),
02440                                                PWCHAR ),
02441                                       NotifyInfo-&gt;FileNameLength,
02442                                       &amp;BufferLength,
02443                                       StreamName-&gt;Buffer,
02444                                       StreamName-&gt;Length );
02445                 }
02446             }
02447         }
02448 
02449         CopiedToBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02450 
02451     } except( EXCEPTION_EXECUTE_HANDLER ) {
02452 
02453         CopiedToBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02454     }
02455 
02456     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"FsRtlNotifyUpdateBuffer:  Exit\n"</span>, 0 );
02457 
02458     <span class="keywordflow">return</span> CopiedToBuffer;
02459 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:51 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
