<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: waitsup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>waitsup.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d3/d6/waitsup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/waitsup_8c.html#a0">KiUnwaitThread</a> (IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread, IN LONG_PTR WaitStatus, IN KPRIORITY Increment)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/waitsup_8c.html#a1">KeBoostCurrentThread</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/waitsup_8c.html#a2">KiWaitSatisfyAll</a> (IN <a class="el" href="../../d4/d8/struct__KWAIT__BLOCK.html">PRKWAIT_BLOCK</a> WaitBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a> (IN PVOID Object, IN KPRIORITY Increment)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="waitsup.c::KeBoostCurrentThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeBoostCurrentThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/waitsup_8c-source.html#l00154">154</a> of file <a class="el" href="../../d3/d6/waitsup_8c-source.html">waitsup.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00590">_KTHREAD::BasePriority</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00591">_KTHREAD::DecrementCount</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01838">KeSetPriorityThread()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00574">_KTHREAD::Priority</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00592">_KTHREAD::PriorityDecrement</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00244">_KAPC_STATE::Process</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00593">_KTHREAD::Quantum</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00042">ROUND_TRIP_DECREMENT_COUNT</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00769">_KPROCESS::ThreadQuantum</a>.
<p>
<pre class="fragment"><div>00160                    :
00161 
00162     This function boosts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> priority of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread <span class="keywordflow">for</span> one quantum,
00163     then reduce <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread priority to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base priority of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.
00164 
00165 Arguments:
00166 
00167     None.
00168 
00169 Return Value:
00170 
00171     None.
00172 
00173 --*/
00174 
00175 {
00176 
00177     KIRQL OldIrql;
00178     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00179 
00180     <span class="comment">//</span>
00181     <span class="comment">// Get current thread address, raise IRQL to synchronization level, and</span>
00182     <span class="comment">// lock the dispatcher database</span>
00183     <span class="comment">//</span>
00184 
00185     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00186 
00187 redoboost:
00188     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00189 
00190     <span class="comment">//</span>
00191     <span class="comment">// If a priority boost is not already active for the current thread</span>
00192     <span class="comment">// and the thread priority is less than 14, then boost the thread</span>
00193     <span class="comment">// priority to 14 and give the thread a large quantum. Otherwise,</span>
00194     <span class="comment">// if a priority boost is active, then decrement the round trip</span>
00195     <span class="comment">// count. If the count goes to zero, then release the dispatcher</span>
00196     <span class="comment">// database lock, lower the thread priority to the base priority,</span>
00197     <span class="comment">// and then attempt to boost the priority again. This will give</span>
00198     <span class="comment">// other threads a chance to run. If the count does not reach zero,</span>
00199     <span class="comment">// then give the thread another large qunatum.</span>
00200     <span class="comment">//</span>
00201     <span class="comment">// If the thread priority is above 14, then no boost is applied.</span>
00202     <span class="comment">//</span>
00203 
00204     <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o26">PriorityDecrement</a> == 0) &amp;&amp; (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o13">Priority</a> &lt; 14)) {
00205         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o26">PriorityDecrement</a> = 14 - Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o24">BasePriority</a>;
00206         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o25">DecrementCount</a> = <a class="code" href="../../d4/d9/ke_8h.html#a4">ROUND_TRIP_DECREMENT_COUNT</a>;
00207         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o13">Priority</a> = 14;
00208         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a> * 2;
00209 
00210     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o26">PriorityDecrement</a> != 0) {
00211         Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o25">DecrementCount</a> -= 1;
00212         <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o25">DecrementCount</a> == 0) {
00213             <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00214             <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a>(Thread, Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o24">BasePriority</a>);
00215             <span class="keywordflow">goto</span> redoboost;
00216 
00217         } <span class="keywordflow">else</span> {
00218             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a> * 2;
00219         }
00220     }
00221 
00222     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00223     <span class="keywordflow">return</span>;
00224 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="waitsup.c::KiUnwaitThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL KiUnwaitThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KPRIORITY&nbsp;</td>
          <td class="mdname" nowrap> <em>Increment</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/waitsup_8c-source.html#l00031">31</a> of file <a class="el" href="../../d3/d6/waitsup_8c-source.html">waitsup.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00768">_KPROCESS::BasePriority</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00500">_KQUEUE::CurrentCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00522">_KTIMER::Header</a>, <a class="el" href="../../d7/d3/rtl_2random_8c-source.html#l00032">Increment</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00261">_DISPATCHER_HEADER::Inserted</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00270">KiReadyThread()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00755">KiRemoveTreeTimer</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00043">MEMORY_PRIORITY_FOREGROUND</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00283">_KWAIT_BLOCK::NextWaitBlock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d9/ke_8h.html#a91">PKQUEUE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00573">PsPrioritySeperation</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00769">_KPROCESS::ThreadQuantum</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00044">TIME_CRITICAL_PRIORITY_BOUND</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00029">WAIT_QUANTUM_DECREMENT</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00280">_KWAIT_BLOCK::WaitListEntry</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00365">KeAlertResumeThread()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00281">KeAlertThread()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00458">KeSetEventBoostPriority()</a>, <a class="el" href="../../d9/d2/queueobj_8c-source.html#l00649">KiActivateWaiterQueue()</a>, <a class="el" href="../../d7/d6/apcsup_8c-source.html#l00223">KiInsertQueueApc()</a>, and <a class="el" href="../../d3/d6/waitsup_8c-source.html#l00277">KiWaitTest()</a>.
<p>
<pre class="fragment"><div>00039                    :
00040 
00041     This function unwaits a thread, sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's wait completion status,
00042     calculates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's <span class="keyword">new</span> priority, and readies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <span class="keywordflow">for</span> execution.
00043 
00044 Arguments:
00045 
00046     Thread - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> thread.
00047 
00048     WaitStatus - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait completion status.
00049 
00050     <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> priority increment that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be applied to
00051         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's priority.
00052 
00053 Return Value:
00054 
00055     None.
00056 
00057 --*/
00058 
00059 {
00060 
00061     KPRIORITY NewPriority;
00062     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00063     <a class="code" href="../../d7/d7/struct__KQUEUE.html">PKQUEUE</a> Queue;
00064     <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer;
00065     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PRKWAIT_BLOCK</a> WaitBlock;
00066 
00067     <span class="comment">//</span>
00068     <span class="comment">// Set wait completion status, remove wait blocks from object wait</span>
00069     <span class="comment">// lists, and remove thread from wait list.</span>
00070     <span class="comment">//</span>
00071 
00072     Thread-&gt;WaitStatus |= WaitStatus;
00073     WaitBlock = Thread-&gt;WaitBlockList;
00074     <span class="keywordflow">do</span> {
00075         RemoveEntryList(&amp;WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o0">WaitListEntry</a>);
00076         WaitBlock = WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o3">NextWaitBlock</a>;
00077     } <span class="keywordflow">while</span> (WaitBlock != Thread-&gt;WaitBlockList);
00078 
00079     RemoveEntryList(&amp;Thread-&gt;WaitListEntry);
00080 
00081     <span class="comment">//</span>
00082     <span class="comment">// If thread timer is still active, then cancel thread timer.</span>
00083     <span class="comment">//</span>
00084 
00085     Timer = &amp;Thread-&gt;Timer;
00086     <span class="keywordflow">if</span> (Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o3">Inserted</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00087         <a class="code" href="../../d0/d0/ki_8h.html#a22">KiRemoveTreeTimer</a>(Timer);
00088     }
00089 
00090     <span class="comment">//</span>
00091     <span class="comment">// If the thread is processing a queue entry, then increment the</span>
00092     <span class="comment">// count of currently active threads.</span>
00093     <span class="comment">//</span>
00094 
00095     Queue = Thread-&gt;Queue;
00096     <span class="keywordflow">if</span> (Queue != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00097         Queue-&gt;<a class="code" href="../../d7/d7/struct__KQUEUE.html#o2">CurrentCount</a> += 1;
00098     }
00099 
00100     <span class="comment">//</span>
00101     <span class="comment">// If the thread runs at a realtime priority level, then reset the</span>
00102     <span class="comment">// thread quantum. Otherwise, compute the next thread priority and</span>
00103     <span class="comment">// charge the thread for the wait operation.</span>
00104     <span class="comment">//</span>
00105 
00106     Process = Thread-&gt;ApcState.Process;
00107     <span class="keywordflow">if</span> (Thread-&gt;Priority &lt; LOW_REALTIME_PRIORITY) {
00108         <span class="keywordflow">if</span> ((Thread-&gt;PriorityDecrement == 0) &amp;&amp;
00109             (Thread-&gt;DisableBoost == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00110             NewPriority = Thread-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o12">BasePriority</a> + <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a>;
00111             <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)Process)-&gt;Vm.MemoryPriority == <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>) {
00112                 NewPriority += <a class="code" href="../../d1/d9/ps_8h.html#a47">PsPrioritySeperation</a>;
00113             }
00114 
00115             <span class="keywordflow">if</span> (NewPriority &gt; Thread-&gt;Priority) {
00116                 <span class="keywordflow">if</span> (NewPriority &gt;= LOW_REALTIME_PRIORITY) {
00117                     Thread-&gt;Priority = LOW_REALTIME_PRIORITY - 1;
00118 
00119                 } <span class="keywordflow">else</span> {
00120                     Thread-&gt;Priority = (SCHAR)NewPriority;
00121                 }
00122             }
00123         }
00124 
00125         <span class="keywordflow">if</span> (Thread-&gt;BasePriority &gt;= <a class="code" href="../../d0/d0/ki_8h.html#a4">TIME_CRITICAL_PRIORITY_BOUND</a>) {
00126             Thread-&gt;Quantum = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a>;
00127 
00128         } <span class="keywordflow">else</span> {
00129             Thread-&gt;Quantum -= <a class="code" href="../../d4/d9/ke_8h.html#a1">WAIT_QUANTUM_DECREMENT</a>;
00130             <span class="keywordflow">if</span> (Thread-&gt;Quantum &lt;= 0) {
00131                 Thread-&gt;Quantum = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a>;
00132                 Thread-&gt;Priority -= (Thread-&gt;PriorityDecrement + 1);
00133                 <span class="keywordflow">if</span> (Thread-&gt;Priority &lt; Thread-&gt;BasePriority) {
00134                     Thread-&gt;Priority = Thread-&gt;BasePriority;
00135                 }
00136 
00137                 Thread-&gt;PriorityDecrement = 0;
00138             }
00139         }
00140 
00141     } <span class="keywordflow">else</span> {
00142         Thread-&gt;Quantum = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a>;
00143     }
00144 
00145     <span class="comment">//</span>
00146     <span class="comment">// Reready the thread for execution.</span>
00147     <span class="comment">//</span>
00148 
00149     <a class="code" href="../../d0/d2/thredsup_8c.html#a3">KiReadyThread</a>(Thread);
00150     <span class="keywordflow">return</span>;
00151 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="waitsup.c::KiWaitSatisfyAll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL KiWaitSatisfyAll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d8/struct__KWAIT__BLOCK.html">PRKWAIT_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>WaitBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/waitsup_8c-source.html#l00228">228</a> of file <a class="el" href="../../d3/d6/waitsup_8c-source.html">waitsup.c</a>.
<p>
References <a class="el" href="../../d1/d9/ki_8h-source.html#l00913">KiWaitSatisfyAny</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00283">_KWAIT_BLOCK::NextWaitBlock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00282">_KWAIT_BLOCK::Object</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00281">_KWAIT_BLOCK::Thread</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00284">_KWAIT_BLOCK::WaitKey</a>.
<p>
Referenced by <a class="el" href="../../d2/d6/wait_8c-source.html#l00395">KeWaitForMultipleObjects()</a>, and <a class="el" href="../../d3/d6/waitsup_8c-source.html#l00277">KiWaitTest()</a>.
<p>
<pre class="fragment"><div>00234                    :
00235 
00236     This function satisfies a wait all and performs any side effects that
00237     are necessary.
00238 
00239 Arguments:
00240 
00241     WaitBlock - Supplies a pointer to a wait block.
00242 
00243 Return Value:
00244 
00245     None.
00246 
00247 --*/
00248 
00249 {
00250 
00251     <a class="code" href="../../d3/d7/struct__KMUTANT.html">PKMUTANT</a> Object;
00252     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
00253     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PRKWAIT_BLOCK</a> WaitBlock1;
00254 
00255     <span class="comment">//</span>
00256     <span class="comment">// If the wait type was WaitAny, then perform neccessary side effects on</span>
00257     <span class="comment">// the object specified by the wait block. Else perform necessary side</span>
00258     <span class="comment">// effects on all the objects that were involved in the wait operation.</span>
00259     <span class="comment">//</span>
00260 
00261     WaitBlock1 = WaitBlock;
00262     Thread = WaitBlock1-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o1">Thread</a>;
00263     <span class="keywordflow">do</span> {
00264         <span class="keywordflow">if</span> (WaitBlock1-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o4">WaitKey</a> != (CSHORT)STATUS_TIMEOUT) {
00265             Object = (<a class="code" href="../../d3/d7/struct__KMUTANT.html">PKMUTANT</a>)WaitBlock1-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o2">Object</a>;
00266             <a class="code" href="../../d0/d0/ki_8h.html#a25">KiWaitSatisfyAny</a>(Object, Thread);
00267         }
00268 
00269         WaitBlock1 = WaitBlock1-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o3">NextWaitBlock</a>;
00270     } <span class="keywordflow">while</span> (WaitBlock1 != WaitBlock);
00271 
00272     <span class="keywordflow">return</span>;
00273 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="waitsup.c::KiWaitTest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL KiWaitTest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KPRIORITY&nbsp;</td>
          <td class="mdname" nowrap> <em>Increment</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/waitsup_8c-source.html#l00277">277</a> of file <a class="el" href="../../d3/d6/waitsup_8c-source.html">waitsup.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00485">_KMUTANT::Header</a>, <a class="el" href="../../d7/d3/rtl_2random_8c-source.html#l00032">Increment</a>, <a class="el" href="../../d3/d6/waitsup_8c-source.html#l00031">KiUnwaitThread()</a>, <a class="el" href="../../d3/d6/waitsup_8c-source.html#l00228">KiWaitSatisfyAll()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00913">KiWaitSatisfyAny</a>, <a class="el" href="../../d4/d9/ke_8h.html#a402a159">MutantObject</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00283">_KWAIT_BLOCK::NextWaitBlock</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00282">_KWAIT_BLOCK::Object</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00487">_KMUTANT::OwnerThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00262">_DISPATCHER_HEADER::SignalState</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00281">_KWAIT_BLOCK::Thread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00258">_DISPATCHER_HEADER::Type</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00284">_KWAIT_BLOCK::WaitKey</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00285">_KWAIT_BLOCK::WaitType</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00365">KeAlertResumeThread()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00688">KeForceResumeThread()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00167">KePulseEvent()</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00178">KeReleaseMutant()</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01079">KeResumeThread()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01218">KeRundownThread()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00656">KeSetProcess()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00285">KeSetTimerEx()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01996">KeTerminateThread()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l02190">KeThawAllThreads()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00512">KeUnstackDetachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00955">KiAttachProcess()</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00270">KiReadyThread()</a>, and <a class="el" href="../../d6/d0/dpcsup_8c-source.html#l00333">KiTimerListExpire()</a>.
<p>
<pre class="fragment"><div>00284                    :
00285 
00286     This function tests <span class="keywordflow">if</span> a wait can be satisfied when an object attains
00287     a state of signaled. If a wait can be satisfied, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subject thread
00288     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unwaited with a completion status that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> WaitKey of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait
00289     block from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object wait list. As many waits as possible are satisfied.
00290 
00291 Arguments:
00292 
00293     Object - Supplies a pointer to a dispatcher object.
00294 
00295 Return Value:
00296 
00297     None.
00298 
00299 --*/
00300 
00301 {
00302 
00303     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00304     PLIST_ENTRY ListHead;
00305     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PRKWAIT_BLOCK</a> NextBlock;
00306     <a class="code" href="../../d3/d7/struct__KMUTANT.html">PKMUTANT</a> Mutant;
00307     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
00308     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PRKWAIT_BLOCK</a> WaitBlock;
00309     PLIST_ENTRY WaitEntry;
00310 
00311     <span class="comment">//</span>
00312     <span class="comment">// As long as the signal state of the specified object is Signaled and</span>
00313     <span class="comment">// there are waiters in the object wait list, then try to satisfy a wait.</span>
00314     <span class="comment">//</span>
00315 
00316     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)Object;
00317     ListHead = &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Header.WaitListHead;
00318     WaitEntry = ListHead-&gt;Flink;
00319     <span class="keywordflow">while</span> ((<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Header.SignalState &gt; 0) &amp;&amp;
00320            (WaitEntry != ListHead)) {
00321         WaitBlock = CONTAINING_RECORD(WaitEntry, <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">KWAIT_BLOCK</a>, WaitListEntry);
00322         Thread = WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o1">Thread</a>;
00323         <span class="keywordflow">if</span> (WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o5">WaitType</a> != WaitAny) {
00324 
00325             <span class="comment">//</span>
00326             <span class="comment">// The wait type is wait all - if all the objects are in</span>
00327             <span class="comment">// a Signaled state, then satisfy the wait.</span>
00328             <span class="comment">//</span>
00329 
00330             NextBlock = WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o3">NextWaitBlock</a>;
00331             <span class="keywordflow">while</span> (NextBlock != WaitBlock) {
00332                 <span class="keywordflow">if</span> (NextBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o4">WaitKey</a> != (CSHORT)(STATUS_TIMEOUT)) {
00333                     Mutant = (<a class="code" href="../../d3/d7/struct__KMUTANT.html">PKMUTANT</a>)NextBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o2">Object</a>;
00334                     <span class="keywordflow">if</span> ((Mutant-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o0">Type</a> == <a class="code" href="../../d4/d9/ke_8h.html#a402a159">MutantObject</a>) &amp;&amp;
00335                         (Mutant-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> &lt;= 0) &amp;&amp;
00336                         (Thread == Mutant-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o2">OwnerThread</a>)) {
00337                         <span class="keywordflow">goto</span> next;
00338 
00339                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Mutant-&gt;<a class="code" href="../../d3/d7/struct__KMUTANT.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> &lt;= 0) {
00340                         <span class="keywordflow">goto</span> scan;
00341                     }
00342                 }
00343 
00344             next:
00345                 NextBlock = NextBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o3">NextWaitBlock</a>;
00346             }
00347 
00348             <span class="comment">//</span>
00349             <span class="comment">// All objects associated with the wait are in the Signaled</span>
00350             <span class="comment">// state - satisfy the wait.</span>
00351             <span class="comment">//</span>
00352 
00353             WaitEntry = WaitEntry-&gt;Blink;
00354             <a class="code" href="../../d2/d7/waitsup_8c.html#a2">KiWaitSatisfyAll</a>(WaitBlock);
00355 
00356         } <span class="keywordflow">else</span> {
00357 
00358             <span class="comment">//</span>
00359             <span class="comment">// The wait type is wait any - satisfy the wait.</span>
00360             <span class="comment">//</span>
00361 
00362             WaitEntry = WaitEntry-&gt;Blink;
00363             <a class="code" href="../../d0/d0/ki_8h.html#a25">KiWaitSatisfyAny</a>((<a class="code" href="../../d3/d7/struct__KMUTANT.html">PKMUTANT</a>)Event, Thread);
00364         }
00365 
00366         <a class="code" href="../../d2/d7/waitsup_8c.html#a0">KiUnwaitThread</a>(Thread, (NTSTATUS)WaitBlock-&gt;<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html#o4">WaitKey</a>, Increment);
00367 
00368     scan:
00369         WaitEntry = WaitEntry-&gt;Flink;
00370     }
00371 
00372     <span class="keywordflow">return</span>;
00373 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:46:08 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
