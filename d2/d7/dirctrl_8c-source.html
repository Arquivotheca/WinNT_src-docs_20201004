<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dirctrl.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dirctrl.c</h1><a href="../../d1/d8/dirctrl_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    DirCtrl.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the File Directory Control routines for Udfs called</span>
00012 <span class="comment">    by the Fsd/Fsp dispatch drivers.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Dan Lovinger    [DanLo]     27-Nov-1996</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "UdfProcs.h"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">//  The Bug check file id for this module</span>
00026 <span class="comment">//</span>
00027 
<a name="l00028"></a><a class="code" href="../../d1/d8/dirctrl_8c.html#a0">00028</a> <span class="preprocessor">#define BugCheckFileId                   (UDFS_BUG_CHECK_DIRCTRL)</span>
00029 <span class="preprocessor"></span>
00030 <span class="comment">//</span>
00031 <span class="comment">//  The local debug trace level</span>
00032 <span class="comment">//</span>
00033 
<a name="l00034"></a><a class="code" href="../../d1/d8/dirctrl_8c.html#a1">00034</a> <span class="preprocessor">#define Dbg                              (UDFS_DEBUG_LEVEL_DIRCTRL)</span>
00035 <span class="preprocessor"></span>
00036 <span class="comment">//</span>
00037 <span class="comment">//  Local structures</span>
00038 <span class="comment">//</span>
00039 
00040 <span class="comment">//</span>
00041 <span class="comment">//  The following is used for the more complete enumeration required in the DirectoryControl path</span>
00042 <span class="comment">//  and encapsulates the structures for enumerating both directories and ICBs, as well as converted</span>
00043 <span class="comment">//  data from the ICB.</span>
00044 <span class="comment">//</span>
00045 
<a name="l00046"></a><a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">00046</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">_COMPOUND_DIR_ENUM_CONTEXT</a> {
00047 
00048     <span class="comment">//</span>
00049     <span class="comment">//  Standard enumeration contexts.  For this enumeration we walk the directory and lift the</span>
00050     <span class="comment">//  associated ICB for each entry.</span>
00051     <span class="comment">//</span>
00052     
<a name="l00053"></a><a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">00053</a>     <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">DIR_ENUM_CONTEXT</a> <a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>;
<a name="l00054"></a><a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o1">00054</a>     <a class="code" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">ICB_SEARCH_CONTEXT</a> <a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o1">IcbContext</a>;
00055 
00056     <span class="comment">//</span>
00057     <span class="comment">//  Timestamps converted from the ICB into NT-native form.</span>
00058     <span class="comment">//</span>
00059 
<a name="l00060"></a><a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o2">00060</a>     <a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html">TIMESTAMP_BUNDLE</a> <a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o2">Timestamps</a>;
00061 
00062     <span class="comment">//</span>
00063     <span class="comment">//  File index corresponding to the current position in the enumeration.</span>
00064     <span class="comment">//</span>
00065 
<a name="l00066"></a><a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">00066</a>     LARGE_INTEGER <a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">FileIndex</a>;
00067 
00068 } <a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">COMPOUND_DIR_ENUM_CONTEXT</a>, *<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">PCOMPOUND_DIR_ENUM_CONTEXT</a>;
00069 
00070 <span class="comment">//</span>
00071 <span class="comment">//  Local macros</span>
00072 <span class="comment">//</span>
00073 
00074 <span class="comment">//</span>
00075 <span class="comment">//  Constants defining the space of FileIndices for directory enumeration.</span>
00076 <span class="comment">//</span>
00077 
00078 <span class="comment">//</span>
00079 <span class="comment">//  The virtual (synthesized) file indices</span>
00080 <span class="comment">//</span>
00081 
<a name="l00082"></a><a class="code" href="../../d1/d8/dirctrl_8c.html#a2">00082</a> <span class="preprocessor">#define UDF_FILE_INDEX_VIRTUAL_SELF         0</span>
00083 <span class="preprocessor"></span>
00084 <span class="comment">//</span>
00085 <span class="comment">//  The file index where the physical directory entries begin</span>
00086 <span class="comment">//</span>
00087 
<a name="l00088"></a><a class="code" href="../../d1/d8/dirctrl_8c.html#a3">00088</a> <span class="preprocessor">#define UDF_FILE_INDEX_PHYSICAL             1</span>
00089 <span class="preprocessor"></span>
00090 <span class="comment">//</span>
00091 <span class="comment">//  Provide initialization and cleanup for compound enumeration contexts.</span>
00092 <span class="comment">//</span>
00093 
00094 <a class="code" href="../../d5/d3/filelock_8c.html#a1">INLINE</a>
00095 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00096"></a><a class="code" href="../../d1/d8/dirctrl_8c.html#a6">00096</a> <a class="code" href="../../d1/d8/dirctrl_8c.html#a6">UdfInitializeCompoundDirContext</a> (
00097     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00098     IN PCOMPOUND_DIR_ENUM_CONTEXT CompoundDirContext
00099     )
00100 {
00101 
00102     <a class="code" href="../../d3/d8/udfprocs_8h.html#a167">UdfInitializeDirContext</a>( IrpContext, &amp;CompoundDirContext-&gt;DirContext );
00103     <a class="code" href="../../d3/d8/udfprocs_8h.html#a222">UdfFastInitializeIcbContext</a>( IrpContext, &amp;CompoundDirContext-&gt;IcbContext );
00104 
00105     RtlZeroMemory( &amp;CompoundDirContext-&gt;Timestamps, <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html">TIMESTAMP_BUNDLE</a> ));
00106 
00107     CompoundDirContext-&gt;FileIndex.QuadPart = 0;
00108 }
00109 
00110 <a class="code" href="../../d5/d3/filelock_8c.html#a1">INLINE</a>
00111 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00112"></a><a class="code" href="../../d1/d8/dirctrl_8c.html#a7">00112</a> <a class="code" href="../../d1/d8/dirctrl_8c.html#a7">UdfCleanupCompoundDirContext</a> (
00113     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00114     IN PCOMPOUND_DIR_ENUM_CONTEXT CompoundDirContext
00115     )
00116 {
00117 
00118     <a class="code" href="../../d3/d8/udfprocs_8h.html#a168">UdfCleanupDirContext</a>( IrpContext, &amp;CompoundDirContext-&gt;DirContext );
00119     <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;CompoundDirContext-&gt;IcbContext );
00120 }
00121 
00122 <span class="comment">//</span>
00123 <span class="comment">//  UDF directories are unsorted (UDF 1.0.1 2.3.5.3) and do not contain self</span>
00124 <span class="comment">//  entries.  For directory enumeration we must provide a way for a restart to</span>
00125 <span class="comment">//  occur at a random entry (SL_INDEX_SPECIFIED), but the key used is only</span>
00126 <span class="comment">//  32bits.  Since the directory is unsorted, the filename is unsuitable for</span>
00127 <span class="comment">//  quickly finding a restart point (even assuming that it was sorted,</span>
00128 <span class="comment">//  discovering a directory entry is still not fast).  Additionally, we must</span>
00129 <span class="comment">//  synthesize the self-entry.  So, here is how we map the space of file</span>
00130 <span class="comment">//  indices to directory entries:</span>
00131 <span class="comment">//</span>
00132 <span class="comment">//    File Index              Directory Entry</span>
00133 <span class="comment">//  </span>
00134 <span class="comment">//    0                       self ('.')</span>
00135 <span class="comment">//    1                       at byte offset 0 in the stream</span>
00136 <span class="comment">//    N                       at byte offset N-1 in the stream</span>
00137 <span class="comment">//  </span>
00138 <span class="comment">//  The highest 32bit FileIndex returned will be stashed in the Ccb.</span>
00139 <span class="comment">//  </span>
00140 <span class="comment">//  For FileIndex &gt; 2^32, we will return FileIndex 0 in the query structure.</span>
00141 <span class="comment">//  On a restart, we will notice a FileIndex of zero and use the saved high</span>
00142 <span class="comment">//  32bit FileIndex as the starting point for a linear scan to find the named</span>
00143 <span class="comment">//  directory entry in the restart request.  In this way we only penalize the</span>
00144 <span class="comment">//  improbable case of a directory stream &gt; 2^32 bytes.</span>
00145 <span class="comment">//</span>
00146 <span class="comment">//  The following inline routines assist with this mapping.</span>
00147 <span class="comment">//</span>
00148 
00149 <a class="code" href="../../d5/d3/filelock_8c.html#a1">INLINE</a>
00150 LONGLONG
<a name="l00151"></a><a class="code" href="../../d1/d8/dirctrl_8c.html#a8">00151</a> <a class="code" href="../../d1/d8/dirctrl_8c.html#a8">UdfFileIndexToPhysicalOffset</a>(
00152     LONGLONG FileIndex
00153     )
00154 {
00155 
00156     <span class="keywordflow">return</span> FileIndex - <a class="code" href="../../d1/d8/dirctrl_8c.html#a3">UDF_FILE_INDEX_PHYSICAL</a>;
00157 }
00158 
00159 <a class="code" href="../../d5/d3/filelock_8c.html#a1">INLINE</a>
00160 LONGLONG
<a name="l00161"></a><a class="code" href="../../d1/d8/dirctrl_8c.html#a9">00161</a> <a class="code" href="../../d1/d8/dirctrl_8c.html#a9">UdfPhysicalOffsetToFileIndex</a>(
00162     LONGLONG PhysicalOffset
00163     )
00164 {
00165 
00166     <span class="keywordflow">return</span> PhysicalOffset + <a class="code" href="../../d1/d8/dirctrl_8c.html#a3">UDF_FILE_INDEX_PHYSICAL</a>;
00167 }
00168 
00169 <a class="code" href="../../d5/d3/filelock_8c.html#a1">INLINE</a>
00170 BOOLEAN
<a name="l00171"></a><a class="code" href="../../d1/d8/dirctrl_8c.html#a10">00171</a> <a class="code" href="../../d1/d8/dirctrl_8c.html#a10">UdfIsFileIndexVirtual</a>(
00172    LONGLONG FileIndex
00173    )
00174 {
00175 
00176     <span class="keywordflow">return</span> FileIndex &lt; <a class="code" href="../../d1/d8/dirctrl_8c.html#a3">UDF_FILE_INDEX_PHYSICAL</a>;
00177 }
00178 
00179 <span class="comment">//</span>
00180 <span class="comment">//  Local support routines</span>
00181 <span class="comment">//</span>
00182 
00183 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00184 <a class="code" href="../../d1/d8/dirctrl_8c.html#a11">UdfQueryDirectory</a> (
00185     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00186     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00187     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
00188     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00189     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb
00190     );
00191 
00192 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00193 <a class="code" href="../../d1/d8/dirctrl_8c.html#a12">UdfNotifyChangeDirectory</a> (
00194     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00195     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00196     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
00197     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb
00198     );
00199 
00200 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00201 <a class="code" href="../../d1/d8/dirctrl_8c.html#a13">UdfInitializeEnumeration</a> (
00202     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00203     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
00204     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00205     IN OUT <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb,
00206     IN OUT PCOMPOUND_DIR_ENUM_CONTEXT CompoundDirContext,
00207     OUT PBOOLEAN ReturnNextEntry,
00208     OUT PBOOLEAN ReturnSingleEntry,
00209     OUT PBOOLEAN InitialQuery
00210     );
00211 
00212 BOOLEAN
00213 <a class="code" href="../../d1/d8/dirctrl_8c.html#a14">UdfEnumerateIndex</a> (
00214     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00215     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb,
00216     IN OUT PCOMPOUND_DIR_ENUM_CONTEXT CompoundDirContext,
00217     IN BOOLEAN ReturnNextEntry
00218     );
00219 
00220 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00221 <a class="code" href="../../d1/d8/dirctrl_8c.html#a15">UdfLookupFileEntryInEnumeration</a> (
00222     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00223     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00224     IN PCOMPOUND_DIR_ENUM_CONTEXT CompoundDirContext
00225     );
00226 
00227 BOOLEAN
00228 <a class="code" href="../../d1/d8/dirctrl_8c.html#a16">UdfLookupInitialFileIndex</a> (
00229     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00230     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00231     IN PCOMPOUND_DIR_ENUM_CONTEXT CompoundDirContext,
00232     IN PLONGLONG InitialIndex
00233     );
00234 
00235 BOOLEAN
00236 <a class="code" href="../../d1/d8/dirctrl_8c.html#a17">UdfLookupNextFileIndex</a> (
00237     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00238     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00239     IN PCOMPOUND_DIR_ENUM_CONTEXT CompoundDirContext
00240     );
00241 
00242 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00243 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfCommonDirControl)</span>
00244 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfEnumerateIndex)</span>
00245 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfInitializeEnumeration)</span>
00246 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfLookupFileEntryInEnumeration)</span>
00247 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfLookupInitialFileIndex)</span>
00248 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfLookupNextFileIndex)</span>
00249 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfNotifyChangeDirectory)</span>
00250 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfQueryDirectory)</span>
00251 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00252 <span class="preprocessor"></span>
00253 
00254 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00255"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a255">00255</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a255">UdfCommonDirControl</a> (
00256     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00257     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00258     )
00259 
00260 <span class="comment">/*++</span>
00261 <span class="comment"></span>
00262 <span class="comment">Routine Description:</span>
00263 <span class="comment"></span>
00264 <span class="comment">    This routine is the entry point for the directory control operations.  These</span>
00265 <span class="comment">    are directory enumerations and directory notify calls.  We verify the</span>
00266 <span class="comment">    user's handle is for a directory and then call the appropriate routine.</span>
00267 <span class="comment"></span>
00268 <span class="comment">Arguments:</span>
00269 <span class="comment"></span>
00270 <span class="comment">    Irp - Irp for this request.</span>
00271 <span class="comment"></span>
00272 <span class="comment">Return Value:</span>
00273 <span class="comment"></span>
00274 <span class="comment">    NTSTATUS - Status returned from the lower level routines.</span>
00275 <span class="comment"></span>
00276 <span class="comment">--*/</span>
00277 
00278 {
00279     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00280     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00281 
00282     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00283     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00284 
00285     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">//  Decode the user file object and fail this request if it is not</span>
00289     <span class="comment">//  a user directory.</span>
00290     <span class="comment">//</span>
00291 
00292     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
00293                              &amp;Fcb,
00294                              &amp;Ccb ) != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>) {
00295 
00296         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_INVALID_PARAMETER );
00297         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00298     }
00299 
00300     <span class="comment">//</span>
00301     <span class="comment">//  We know this is a directory control so we'll case on the</span>
00302     <span class="comment">//  minor function, and call a internal worker routine to complete</span>
00303     <span class="comment">//  the irp.</span>
00304     <span class="comment">//</span>
00305 
00306     <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a>) {
00307 
00308     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a44">IRP_MN_QUERY_DIRECTORY</a>:
00309 
00310         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/dirctrl_8c.html#a11">UdfQueryDirectory</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IrpSp, Fcb, Ccb );
00311         <span class="keywordflow">break</span>;
00312 
00313     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a45">IRP_MN_NOTIFY_CHANGE_DIRECTORY</a>:
00314 
00315         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/dirctrl_8c.html#a12">UdfNotifyChangeDirectory</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IrpSp, Ccb );
00316         <span class="keywordflow">break</span>;
00317 
00318     <span class="keywordflow">default</span>:
00319 
00320         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_INVALID_DEVICE_REQUEST );
00321         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_DEVICE_REQUEST;
00322         <span class="keywordflow">break</span>;
00323     }
00324 
00325     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00326 }
00327 
00328 
00329 <span class="comment">//</span>
00330 <span class="comment">//  Local support routines</span>
00331 <span class="comment">//</span>
00332 
00333 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00334"></a><a class="code" href="../../d1/d8/dirctrl_8c.html#a11">00334</a> <a class="code" href="../../d1/d8/dirctrl_8c.html#a11">UdfQueryDirectory</a> (
00335     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00336     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00337     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
00338     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00339     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb
00340     )
00341 
00342 <span class="comment">/*++</span>
00343 <span class="comment"></span>
00344 <span class="comment">Routine Description:</span>
00345 <span class="comment"></span>
00346 <span class="comment">    This routine performs the query directory operation.  It is responsible</span>
00347 <span class="comment">    for either completing of enqueuing the input Irp.  We store the state of the</span>
00348 <span class="comment">    search in the Ccb.</span>
00349 <span class="comment"></span>
00350 <span class="comment">Arguments:</span>
00351 <span class="comment"></span>
00352 <span class="comment">    Irp - Supplies the Irp to process</span>
00353 <span class="comment"></span>
00354 <span class="comment">    IrpSp - Stack location for this Irp.</span>
00355 <span class="comment"></span>
00356 <span class="comment">    Fcb - Fcb for this directory.</span>
00357 <span class="comment"></span>
00358 <span class="comment">    Ccb - Ccb for this directory open.</span>
00359 <span class="comment"></span>
00360 <span class="comment">Return Value:</span>
00361 <span class="comment"></span>
00362 <span class="comment">    NTSTATUS - The return status for the operation</span>
00363 <span class="comment"></span>
00364 <span class="comment">--*/</span>
00365 
00366 {
00367     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00368     ULONG Information = 0;
00369 
00370     ULONG LastEntry = 0;
00371     ULONG NextEntry = 0;
00372 
00373     ULONG FileNameBytes;
00374     ULONG BytesConverted;
00375 
00376     <a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html">COMPOUND_DIR_ENUM_CONTEXT</a> CompoundDirContext;
00377 
00378     <a class="code" href="../../d1/d2/structNSR__FID.html">PNSR_FID</a> ThisFid;
00379     <a class="code" href="../../d8/d0/structICBFILE.html">PICBFILE</a> ThisFe;
00380     
00381     BOOLEAN InitialQuery;
00382     BOOLEAN ReturnNextEntry;
00383     BOOLEAN ReturnSingleEntry;
00384     BOOLEAN Found;
00385 
00386     PCHAR UserBuffer;
00387     ULONG BytesRemainingInBuffer;
00388 
00389     ULONG BaseLength;
00390 
00391     PFILE_BOTH_DIR_INFORMATION DirInfo;
00392     PFILE_NAMES_INFORMATION NamesInfo;
00393 
00394     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00395 
00396     <span class="comment">//</span>
00397     <span class="comment">//  Check if we support this search mode.  Also remember the size of the base part of</span>
00398     <span class="comment">//  each of these structures.</span>
00399     <span class="comment">//</span>
00400 
00401     <span class="keywordflow">switch</span> (IrpSp-&gt;Parameters.QueryDirectory.FileInformationClass) {
00402 
00403     <span class="keywordflow">case</span> FileDirectoryInformation:
00404 
00405         BaseLength = FIELD_OFFSET( FILE_DIRECTORY_INFORMATION,
00406                                    <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>[0] );
00407         <span class="keywordflow">break</span>;
00408 
00409     <span class="keywordflow">case</span> FileFullDirectoryInformation:
00410 
00411         BaseLength = FIELD_OFFSET( FILE_FULL_DIR_INFORMATION,
00412                                    <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>[0] );
00413         <span class="keywordflow">break</span>;
00414 
00415     <span class="keywordflow">case</span> FileNamesInformation:
00416 
00417         BaseLength = FIELD_OFFSET( FILE_NAMES_INFORMATION,
00418                                    <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>[0] );
00419         <span class="keywordflow">break</span>;
00420 
00421     <span class="keywordflow">case</span> FileBothDirectoryInformation:
00422 
00423         BaseLength = FIELD_OFFSET( FILE_BOTH_DIR_INFORMATION,
00424                                    <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>[0] );
00425         <span class="keywordflow">break</span>;
00426 
00427     <span class="keywordflow">default</span>:
00428 
00429         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_INVALID_INFO_CLASS );
00430         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00431     }
00432 
00433     <span class="comment">//</span>
00434     <span class="comment">//  Get the user buffer.</span>
00435     <span class="comment">//</span>
00436 
00437     <a class="code" href="../../d3/d8/udfprocs_8h.html#a70">UdfMapUserBuffer</a>( IrpContext, &amp;UserBuffer);
00438 
00439     <span class="comment">//</span>
00440     <span class="comment">//  Initialize our search context.</span>
00441     <span class="comment">//</span>
00442 
00443     <a class="code" href="../../d1/d8/dirctrl_8c.html#a6">UdfInitializeCompoundDirContext</a>( IrpContext, &amp;CompoundDirContext );
00444     
00445     <span class="comment">//</span>
00446     <span class="comment">//  Acquire the directory.</span>
00447     <span class="comment">//</span>
00448 
00449     <a class="code" href="../../d3/d8/udfprocs_8h.html#a80">UdfAcquireFileShared</a>( IrpContext, Fcb );
00450 
00451     <span class="comment">//</span>
00452     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00453     <span class="comment">//</span>
00454 
00455     <span class="keywordflow">try</span> {
00456 
00457         <span class="comment">//</span>
00458         <span class="comment">//  Verify the Fcb is still good.</span>
00459         <span class="comment">//</span>
00460 
00461         <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( IrpContext, Fcb );
00462 
00463         <span class="comment">//</span>
00464         <span class="comment">//  Start by getting the initial state for the enumeration.  This will set up the Ccb with</span>
00465         <span class="comment">//  the initial search parameters and let us know the starting offset in the directory</span>
00466         <span class="comment">//  to search.</span>
00467         <span class="comment">//</span>
00468 
00469         <a class="code" href="../../d1/d8/dirctrl_8c.html#a13">UdfInitializeEnumeration</a>( IrpContext,
00470                                   IrpSp,
00471                                   Fcb,
00472                                   Ccb,
00473                                   &amp;CompoundDirContext,
00474                                   &amp;ReturnNextEntry,
00475                                   &amp;ReturnSingleEntry,
00476                                   &amp;InitialQuery );
00477 
00478         <span class="comment">//</span>
00479         <span class="comment">//  At this point we are about to enter our query loop.  We have</span>
00480         <span class="comment">//  determined the index into the directory file to begin the</span>
00481         <span class="comment">//  search.  LastEntry and NextEntry are used to index into the user</span>
00482         <span class="comment">//  buffer.  LastEntry is the last entry we've added, NextEntry is</span>
00483         <span class="comment">//  current one we're working on.  If NextEntry is non-zero, then</span>
00484         <span class="comment">//  at least one entry was added.</span>
00485         <span class="comment">//</span>
00486 
00487         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00488 
00489             <span class="comment">//</span>
00490             <span class="comment">//  If the user had requested only a single match and we have</span>
00491             <span class="comment">//  returned that, then we stop at this point.  We update the Ccb with</span>
00492             <span class="comment">//  the status based on the last entry returned.</span>
00493             <span class="comment">//</span>
00494 
00495             <span class="keywordflow">if</span> ((NextEntry != 0) &amp;&amp; ReturnSingleEntry) {
00496 
00497                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00498             }
00499 
00500             <span class="comment">//</span>
00501             <span class="comment">//  We try to locate the next matching dirent.  Our search if based on a starting</span>
00502             <span class="comment">//  dirent offset, whether we should return the current or next entry, whether</span>
00503             <span class="comment">//  we should be doing a short name search and finally whether we should be</span>
00504             <span class="comment">//  checking for a version match.</span>
00505             <span class="comment">//</span>
00506 
00507             Found = <a class="code" href="../../d1/d8/dirctrl_8c.html#a14">UdfEnumerateIndex</a>( IrpContext, Ccb, &amp;CompoundDirContext, ReturnNextEntry );
00508 
00509             <span class="comment">//</span>
00510             <span class="comment">//  Initialize the value for the next search.</span>
00511             <span class="comment">//</span>
00512 
00513             ReturnNextEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00514 
00515             <span class="comment">//</span>
00516             <span class="comment">//  If we didn't receive a dirent, then we are at the end of the</span>
00517             <span class="comment">//  directory.  If we have returned any files, we exit with</span>
00518             <span class="comment">//  success, otherwise we return STATUS_NO_MORE_FILES.</span>
00519             <span class="comment">//</span>
00520 
00521             <span class="keywordflow">if</span> (!Found) {
00522 
00523                 <span class="keywordflow">if</span> (NextEntry == 0) {
00524 
00525                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MORE_FILES;
00526 
00527                     <span class="keywordflow">if</span> (InitialQuery) {
00528 
00529                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_SUCH_FILE;
00530                     }
00531                 }
00532 
00533                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00534             }
00535 
00536             <span class="comment">//</span>
00537             <span class="comment">//  Remember the dirent/file entry for the file we just found.</span>
00538             <span class="comment">//</span>
00539 
00540             ThisFid = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o5">Fid</a>;
00541 
00542             <span class="comment">//</span>
00543             <span class="comment">//  Here are the rules concerning filling up the buffer:</span>
00544             <span class="comment">//</span>
00545             <span class="comment">//  1.  The Io system garentees that there will always be</span>
00546             <span class="comment">//      enough room for at least one base record.</span>
00547             <span class="comment">//</span>
00548             <span class="comment">//  2.  If the full first record (including file name) cannot</span>
00549             <span class="comment">//      fit, as much of the name as possible is copied and</span>
00550             <span class="comment">//      STATUS_BUFFER_OVERFLOW is returned.</span>
00551             <span class="comment">//</span>
00552             <span class="comment">//  3.  If a subsequent record cannot completely fit into the</span>
00553             <span class="comment">//      buffer, none of it (as in 0 bytes) is copied, and</span>
00554             <span class="comment">//      STATUS_SUCCESS is returned.  A subsequent query will</span>
00555             <span class="comment">//      pick up with this record.</span>
00556             <span class="comment">//</span>
00557 
00558             <span class="comment">//</span>
00559             <span class="comment">//  We can look directly at the dirent that we found.</span>
00560             <span class="comment">//</span>
00561 
00562             FileNameBytes = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o9">CaseObjectName</a>.Length;
00563 
00564             <span class="comment">//</span>
00565             <span class="comment">//  If the slot for the next entry would be beyond the length of the</span>
00566             <span class="comment">//  user's buffer just exit (we know we've returned at least one entry</span>
00567             <span class="comment">//  already). This will happen when we align the pointer past the end.</span>
00568             <span class="comment">//</span>
00569 
00570             <span class="keywordflow">if</span> (NextEntry &gt; IrpSp-&gt;Parameters.QueryDirectory.Length) {
00571 
00572                 ReturnNextEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00573                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS );
00574             }
00575 
00576             <span class="comment">//</span>
00577             <span class="comment">//  Compute the number of bytes remaining in the buffer.  Round this</span>
00578             <span class="comment">//  down to a WCHAR boundary so we can copy full characters.</span>
00579             <span class="comment">//</span>
00580 
00581             BytesRemainingInBuffer = IrpSp-&gt;Parameters.QueryDirectory.Length - NextEntry;
00582             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( BytesRemainingInBuffer, 1 );
00583 
00584             <span class="comment">//</span>
00585             <span class="comment">//  If this won't fit and we have returned a previous entry then just</span>
00586             <span class="comment">//  return STATUS_SUCCESS.</span>
00587             <span class="comment">//</span>
00588 
00589             <span class="keywordflow">if</span> ((BaseLength + FileNameBytes) &gt; BytesRemainingInBuffer) {
00590 
00591                 <span class="comment">//</span>
00592                 <span class="comment">//  If we already found an entry then just exit.</span>
00593                 <span class="comment">//</span>
00594 
00595                 <span class="keywordflow">if</span> (NextEntry != 0) {
00596 
00597                     ReturnNextEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00598                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS );
00599                 }
00600 
00601                 <span class="comment">//</span>
00602                 <span class="comment">//  Reduce the FileNameBytes to just fit in the buffer.</span>
00603                 <span class="comment">//</span>
00604 
00605                 FileNameBytes = BytesRemainingInBuffer - BaseLength;
00606 
00607                 <span class="comment">//</span>
00608                 <span class="comment">//  Use a status code of STATUS_BUFFER_OVERFLOW.  Also set</span>
00609                 <span class="comment">//  ReturnSingleEntry so that we will exit the loop at the top.</span>
00610                 <span class="comment">//</span>
00611 
00612                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_OVERFLOW;
00613                 ReturnSingleEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00614             }
00615 
00616             <span class="comment">//</span>
00617             <span class="comment">//  Protect access to the user buffer with an exception handler.</span>
00618             <span class="comment">//  Since (at our request) IO doesn't buffer these requests, we have</span>
00619             <span class="comment">//  to guard against a user messing with the page protection and other</span>
00620             <span class="comment">//  such trickery.</span>
00621             <span class="comment">//</span>
00622 
00623             <span class="keywordflow">try</span> {
00624                 
00625                 <span class="comment">//</span>
00626                 <span class="comment">//  Zero and initialize the base part of the current entry.</span>
00627                 <span class="comment">//</span>
00628 
00629                 RtlZeroMemory( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( UserBuffer, NextEntry, PVOID ),
00630                                BaseLength );
00631     
00632                 <span class="comment">//</span>
00633                 <span class="comment">//  Now we have an entry to return to our caller.</span>
00634                 <span class="comment">//  We'll case on the type of information requested and fill up</span>
00635                 <span class="comment">//  the user buffer if everything fits.</span>
00636                 <span class="comment">//</span>
00637     
00638                 <span class="keywordflow">switch</span> (IrpSp-&gt;Parameters.QueryDirectory.FileInformationClass) {
00639     
00640                 <span class="keywordflow">case</span> FileBothDirectoryInformation:
00641                 <span class="keywordflow">case</span> FileFullDirectoryInformation:
00642                 <span class="keywordflow">case</span> FileDirectoryInformation:
00643     
00644                     DirInfo = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( UserBuffer, NextEntry, PFILE_BOTH_DIR_INFORMATION );
00645     
00646                     <span class="comment">//</span>
00647                     <span class="comment">//  These information types require we look up the file entry.</span>
00648                     <span class="comment">//</span>
00649                     
00650                     <a class="code" href="../../d1/d8/dirctrl_8c.html#a15">UdfLookupFileEntryInEnumeration</a>( IrpContext,
00651                                                      Fcb,
00652                                                      &amp;CompoundDirContext );
00653                     <span class="comment">//</span>
00654                     <span class="comment">//  Directly reference the file entry we just looked up.</span>
00655                     <span class="comment">//</span>
00656                     
00657                     ThisFe = (<a class="code" href="../../d8/d0/structICBFILE.html">PICBFILE</a>) CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o1">IcbContext</a>.<a class="code" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html#o2">Active</a>.<a class="code" href="../../d6/d6/struct__MAPPED__PVIEW.html#o0">View</a>;
00658                     
00659                     <span class="comment">//</span>
00660                     <span class="comment">//  Now go gather all of the timestamps for this guy.</span>
00661                     <span class="comment">//</span>
00662             
00663                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a226">UdfUpdateTimestampsFromIcbContext</a> ( IrpContext,
00664                                                         &amp;CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o1">IcbContext</a>,
00665                                                         &amp;CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o2">Timestamps</a> );
00666                     
00667                     DirInfo-&gt;CreationTime = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o2">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o0">CreationTime</a>;
00668     
00669                     DirInfo-&gt;LastWriteTime =
00670                     DirInfo-&gt;ChangeTime = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o2">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o2">ModificationTime</a>;
00671     
00672                     DirInfo-&gt;LastAccessTime = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o2">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o1">AccessTime</a>;
00673     
00674                     <span class="comment">//</span>
00675                     <span class="comment">//  Set the attributes and sizes separately for directories and</span>
00676                     <span class="comment">//  files.</span>
00677                     <span class="comment">//</span>
00678     
00679                     <span class="keywordflow">if</span> (ThisFe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> == <a class="code" href="../../d0/d7/iso13346_8h.html#a102">ICBTAG_FILE_T_DIRECTORY</a>) {
00680     
00681                         DirInfo-&gt;EndOfFile.QuadPart = DirInfo-&gt;AllocationSize.QuadPart = 0;
00682     
00683                         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( DirInfo-&gt;FileAttributes, FILE_ATTRIBUTE_DIRECTORY );
00684     
00685                     } <span class="keywordflow">else</span> {
00686     
00687                         DirInfo-&gt;EndOfFile.QuadPart = ThisFe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o9">InfoLength</a>;
00688                         DirInfo-&gt;AllocationSize.QuadPart = <a class="code" href="../../d3/d8/udfprocs_8h.html#a46">LlBlockAlign</a>( Fcb-&gt;Vcb, ThisFe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o9">InfoLength</a> );
00689                     }
00690 
00691                     <span class="comment">//</span>
00692                     <span class="comment">//  All Cdrom files are readonly.  We also copy the existence</span>
00693                     <span class="comment">//  bit to the hidden attribute, assuming that synthesized FIDs</span>
00694                     <span class="comment">//  are never hidden.</span>
00695                     <span class="comment">//</span>
00696 
00697                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( DirInfo-&gt;FileAttributes, FILE_ATTRIBUTE_READONLY );
00698     
00699                     <span class="keywordflow">if</span> (ThisFid &amp;&amp; <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ThisFid-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o2">Flags</a>, <a class="code" href="../../d0/d7/iso13346_8h.html#a88">NSR_FID_F_HIDDEN</a> )) {
00700     
00701                         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( DirInfo-&gt;FileAttributes, FILE_ATTRIBUTE_HIDDEN );
00702                     }
00703     
00704                     <span class="comment">//</span>
00705                     <span class="comment">//  The file index for real file indices &gt; 2^32 is zero.  When asked to</span>
00706                     <span class="comment">//  restart at an index of zero, we will know to use a stashed starting</span>
00707                     <span class="comment">//  point to beging to search, by name, for the correct restart point.</span>
00708                     <span class="comment">//</span>
00709                     
00710                     <span class="keywordflow">if</span> (CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">FileIndex</a>.HighPart == 0) {
00711                         
00712                         DirInfo-&gt;FileIndex = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">FileIndex</a>.LowPart;
00713                     
00714                     } <span class="keywordflow">else</span> {
00715     
00716                         DirInfo-&gt;FileIndex = 0;
00717                     }
00718     
00719                     DirInfo-&gt;FileNameLength = FileNameBytes;
00720     
00721                     <span class="keywordflow">break</span>;
00722     
00723                 <span class="keywordflow">case</span> FileNamesInformation:
00724     
00725                     NamesInfo = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( UserBuffer, NextEntry, PFILE_NAMES_INFORMATION );
00726     
00727                     <span class="keywordflow">if</span> (CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">FileIndex</a>.HighPart == 0) {
00728                         
00729                         NamesInfo-&gt;FileIndex = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">FileIndex</a>.LowPart;
00730                     
00731                     } <span class="keywordflow">else</span> {
00732     
00733                         NamesInfo-&gt;FileIndex = 0;
00734                     }
00735     
00736                     NamesInfo-&gt;FileNameLength = FileNameBytes;
00737     
00738                     <span class="keywordflow">break</span>;
00739                 }
00740 
00741                 <span class="comment">//</span>
00742                 <span class="comment">//  Now copy as much of the name as possible.</span>
00743                 <span class="comment">//</span>
00744     
00745                 <span class="keywordflow">if</span> (FileNameBytes != 0) {
00746     
00747                     <span class="comment">//</span>
00748                     <span class="comment">//  This is a Unicode name, we can copy the bytes directly.</span>
00749                     <span class="comment">//</span>
00750     
00751                     RtlCopyMemory( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( UserBuffer, NextEntry + BaseLength, PVOID ),
00752                                    CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o8">ObjectName</a>.Buffer,
00753                                    FileNameBytes );
00754                 }
00755 
00756                 <span class="comment">//</span>
00757                 <span class="comment">//  Fill in the short name if we got STATUS_SUCCESS.  The short name</span>
00758                 <span class="comment">//  may already be in the file context, otherwise we will check</span>
00759                 <span class="comment">//  whether the long name is 8.3.  Special case the self and parent</span>
00760                 <span class="comment">//  directory names.</span>
00761                 <span class="comment">//</span>
00762     
00763                 <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) &amp;&amp;
00764                     (IrpSp-&gt;Parameters.QueryDirectory.FileInformationClass == FileBothDirectoryInformation) &amp;&amp;
00765                     <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o7">Flags</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a52">DIR_CONTEXT_FLAG_SEEN_NONCONSTANT</a> )) {
00766     
00767                     <span class="comment">//</span>
00768                     <span class="comment">//  If we already have the short name then copy into the user's buffer.</span>
00769                     <span class="comment">//</span>
00770     
00771                     <span class="keywordflow">if</span> (CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.Length != 0) {
00772     
00773                         RtlCopyMemory( DirInfo-&gt;ShortName,
00774                                        CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.Buffer,
00775                                        CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.Length );
00776     
00777                         DirInfo-&gt;ShortNameLength = (CCHAR) CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.Length;
00778     
00779                     <span class="comment">//</span>
00780                     <span class="comment">//  If the short name length is currently zero then check if</span>
00781                     <span class="comment">//  the long name is not 8.3.  We can copy the short name in</span>
00782                     <span class="comment">//  unicode form directly into the caller's buffer.</span>
00783                     <span class="comment">//</span>
00784     
00785                     } <span class="keywordflow">else</span> {
00786     
00787                         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a178">UdfIs8dot3Name</a>( IrpContext,
00788                                              CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o8">ObjectName</a> )) {
00789     
00790                             UNICODE_STRING ShortName;
00791     
00792                             ShortName.Buffer = DirInfo-&gt;ShortName;
00793                             ShortName.MaximumLength = <a class="code" href="../../d9/d7/udf_8h.html#a11">BYTE_COUNT_8_DOT_3</a>;
00794                             
00795                             <a class="code" href="../../d3/d8/udfprocs_8h.html#a180">UdfGenerate8dot3Name</a>( IrpContext,
00796                                                   &amp;CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o0">DirContext</a>.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o10">PureObjectName</a>,
00797                                                   &amp;ShortName );
00798     
00799                             DirInfo-&gt;ShortNameLength = (CCHAR) ShortName.Length;
00800                         }
00801                     }
00802                 }
00803 
00804                 <span class="comment">//</span>
00805                 <span class="comment">//  Update the information with the number of bytes stored in the</span>
00806                 <span class="comment">//  buffer.  We quad-align the existing buffer to add any necessary</span>
00807                 <span class="comment">//  pad bytes.</span>
00808                 <span class="comment">//</span>
00809 
00810                 Information = NextEntry + BaseLength + FileNameBytes;
00811 
00812                 <span class="comment">//</span>
00813                 <span class="comment">//  Go back to the previous entry and fill in the update to this entry.</span>
00814                 <span class="comment">//</span>
00815 
00816                 *(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( UserBuffer, LastEntry, PULONG )) = NextEntry - LastEntry;
00817 
00818                 <span class="comment">//</span>
00819                 <span class="comment">//  Set up our variables for the next dirent.</span>
00820                 <span class="comment">//</span>
00821 
00822                 InitialQuery = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00823 
00824                 LastEntry = NextEntry;
00825                 NextEntry = <a class="code" href="../../d5/d5/cc_8h.html#a62">QuadAlign</a>( Information );
00826             
00827             } except (!<a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>(GetExceptionCode()) ?
00828                       <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a>) {
00829 
00830                   <span class="comment">//</span>
00831                   <span class="comment">//  We must have had a problem filling in the user's buffer, so stop</span>
00832                   <span class="comment">//  and fail this request.</span>
00833                   <span class="comment">//</span>
00834                   
00835                   Information = 0;
00836                   <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode());
00837             }
00838         }
00839 
00840     } finally {
00841 
00842         <span class="keywordflow">if</span> (!AbnormalTermination() &amp;&amp; !<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00843         
00844             <span class="comment">//</span>
00845             <span class="comment">//  Update the Ccb to show the current state of the enumeration.</span>
00846             <span class="comment">//</span>
00847     
00848             <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
00849     
00850             Ccb-&gt;CurrentFileIndex = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">FileIndex</a>.QuadPart;
00851 
00852             <span class="comment">//</span>
00853             <span class="comment">//  Update our notion of a high 32bit file index.  We only do this once to avoid the hit</span>
00854             <span class="comment">//  of thrashing the Fcb mutex to do this for every entry.  If it is ever neccesary to use</span>
00855             <span class="comment">//  this information, the difference of a few dozen entries from the optimal pick-up point</span>
00856             <span class="comment">//  will be trivial.</span>
00857             <span class="comment">//</span>
00858             
00859             <span class="keywordflow">if</span> (CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">FileIndex</a>.HighPart == 0 &amp;&amp;
00860                 CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">FileIndex</a>.LowPart &gt; Ccb-&gt;HighestReturnableFileIndex) {
00861 
00862                     Ccb-&gt;HighestReturnableFileIndex = CompoundDirContext.<a class="code" href="../../d1/d8/struct__COMPOUND__DIR__ENUM__CONTEXT.html#o3">FileIndex</a>.LowPart;
00863             }
00864             
00865             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Ccb-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a25">CCB_FLAG_ENUM_RETURN_NEXT</a> );
00866     
00867             <span class="keywordflow">if</span> (ReturnNextEntry) {
00868     
00869                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Ccb-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a25">CCB_FLAG_ENUM_RETURN_NEXT</a> );
00870             }
00871     
00872             <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00873         }
00874 
00875         <span class="comment">//</span>
00876         <span class="comment">//  Cleanup our search context.</span>
00877         <span class="comment">//</span>
00878 
00879         <a class="code" href="../../d1/d8/dirctrl_8c.html#a7">UdfCleanupCompoundDirContext</a>( IrpContext, &amp;CompoundDirContext );
00880 
00881         <span class="comment">//</span>
00882         <span class="comment">//  Release the Fcb.</span>
00883         <span class="comment">//</span>
00884 
00885         <a class="code" href="../../d3/d8/udfprocs_8h.html#a82">UdfReleaseFile</a>( IrpContext, Fcb );
00886     }
00887 
00888     <span class="comment">//</span>
00889     <span class="comment">//  Complete the request here.</span>
00890     <span class="comment">//</span>
00891 
00892     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = Information;
00893 
00894     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00895     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00896 }
00897 
00898 
00899 <span class="comment">//</span>
00900 <span class="comment">//  Local support routines</span>
00901 <span class="comment">//</span>
00902 
00903 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00904"></a><a class="code" href="../../d1/d8/dirctrl_8c.html#a12">00904</a> <a class="code" href="../../d1/d8/dirctrl_8c.html#a12">UdfNotifyChangeDirectory</a> (
00905     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00906     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp,
00907     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
00908     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb
00909     )
00910 
00911 <span class="comment">/*++</span>
00912 <span class="comment"></span>
00913 <span class="comment">Routine Description:</span>
00914 <span class="comment"></span>
00915 <span class="comment">    This routine performs the notify change directory operation.  It is</span>
00916 <span class="comment">    responsible for either completing of enqueuing the input Irp.  Although there</span>
00917 <span class="comment">    will never be a notify signalled on a readonly disk we still support this call.</span>
00918 <span class="comment"></span>
00919 <span class="comment">    We have already checked that this is not an OpenById handle.</span>
00920 <span class="comment"></span>
00921 <span class="comment">Arguments:</span>
00922 <span class="comment"></span>
00923 <span class="comment">    Irp - Supplies the Irp to process</span>
00924 <span class="comment"></span>
00925 <span class="comment">    IrpSp - Io stack location for this request.</span>
00926 <span class="comment"></span>
00927 <span class="comment">    Ccb - Handle to the directory being watched.</span>
00928 <span class="comment"></span>
00929 <span class="comment">Return Value:</span>
00930 <span class="comment"></span>
00931 <span class="comment">    NTSTATUS - STATUS_PENDING, any other error will raise.</span>
00932 <span class="comment"></span>
00933 <span class="comment">--*/</span>
00934 
00935 {
00936     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00937 
00938     <span class="comment">//</span>
00939     <span class="comment">//  Always set the wait bit in the IrpContext so the initial wait can't fail.</span>
00940     <span class="comment">//</span>
00941 
00942     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a30">IRP_CONTEXT_FLAG_WAIT</a> );
00943 
00944     <span class="comment">//</span>
00945     <span class="comment">//  Acquire the Vcb shared.</span>
00946     <span class="comment">//</span>
00947 
00948     <a class="code" href="../../d3/d8/udfprocs_8h.html#a75">UdfAcquireVcbShared</a>( IrpContext, IrpContext-&gt;Vcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00949 
00950     <span class="comment">//</span>
00951     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00952     <span class="comment">//</span>
00953 
00954     <span class="keywordflow">try</span> {
00955 
00956         <span class="comment">//</span>
00957         <span class="comment">//  Verify the Vcb.</span>
00958         <span class="comment">//</span>
00959 
00960         <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a5">UdfVerifyVcb</a>( IrpContext, IrpContext-&gt;Vcb );
00961 
00962         <span class="comment">//</span>
00963         <span class="comment">//  Call the Fsrtl package to process the request.  We cast the</span>
00964         <span class="comment">//  unicode strings to ansi strings as the dir notify package</span>
00965         <span class="comment">//  only deals with memory matching.</span>
00966         <span class="comment">//</span>
00967 
00968         <a class="code" href="../../d1/d8/fsrtl_8h.html#a172">FsRtlNotifyFullChangeDirectory</a>( IrpContext-&gt;Vcb-&gt;NotifySync,
00969                                         &amp;IrpContext-&gt;Vcb-&gt;DirNotifyList,
00970                                         Ccb,
00971                                         (PSTRING) &amp;IrpSp-&gt;FileObject-&gt;FileName,
00972                                         <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( IrpSp-&gt;Flags, <a class="code" href="../../d0/d5/io_8h.html#a211">SL_WATCH_TREE</a> ),
00973                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00974                                         IrpSp-&gt;Parameters.NotifyDirectory.CompletionFilter,
00975                                         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>,
00976                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00977                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00978 
00979     } finally {
00980 
00981         <span class="comment">//</span>
00982         <span class="comment">//  Release the Vcb.</span>
00983         <span class="comment">//</span>
00984 
00985         <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, IrpContext-&gt;Vcb );
00986     }
00987 
00988     <span class="comment">//</span>
00989     <span class="comment">//  Cleanup the IrpContext.</span>
00990     <span class="comment">//</span>
00991 
00992     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, STATUS_SUCCESS );
00993 
00994     <span class="keywordflow">return</span> STATUS_PENDING;
00995 }
00996 
00997 
00998 <span class="comment">//</span>
00999 <span class="comment">//  Local support routine</span>
01000 <span class="comment">//</span>
01001 
01002 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01003"></a><a class="code" href="../../d1/d8/dirctrl_8c.html#a13">01003</a> <a class="code" href="../../d1/d8/dirctrl_8c.html#a13">UdfInitializeEnumeration</a> (
01004     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
01005     IN <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp,
01006     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
01007     IN OUT <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb,
01008     IN OUT PCOMPOUND_DIR_ENUM_CONTEXT CompoundDirContext,
01009     OUT PBOOLEAN ReturnNextEntry,
01010     OUT PBOOLEAN ReturnSingleEntry,
01011     OUT PBOOLEAN InitialQuery
01012     )
01013 
01014 <span class="comment">/*++</span>
01015 <span class="comment"></span>
01016 <span class="comment">Routine Description:</span>
01017 <span class="comment"></span>
01018 <span class="comment">    This routine is called to initialize the enumeration variables and structures.</span>
01019 <span class="comment">    We look at the state of a previous enumeration from the Ccb as well as any</span>
01020 <span class="comment">    input values from the user.  On exit we will position the DirContext at</span>
01021 <span class="comment">    a file in the directory and let the caller know whether this entry or the</span>
01022 <span class="comment">    next entry should be returned.</span>
01023 <span class="comment"></span>
01024 <span class="comment">Arguments:</span>
01025 <span class="comment"></span>
01026 <span class="comment">    IrpSp - Irp stack location for this request.</span>
01027 <span class="comment"></span>
01028 <span class="comment">    Fcb - Fcb for this directory.</span>
01029 <span class="comment"></span>
01030 <span class="comment">    Ccb - Ccb for the directory handle.</span>
01031 <span class="comment"></span>
01032 <span class="comment">    CompoundDirContext - Context to use for this enumeration.</span>
01033 <span class="comment"></span>
01034 <span class="comment">    ReturnNextEntry - Address to store whether we should return the entry at</span>
01035 <span class="comment">        the context position or the next entry.</span>
01036 <span class="comment"></span>
01037 <span class="comment">    ReturnSingleEntry - Address to store whether we should only return</span>
01038 <span class="comment">        a single entry.</span>
01039 <span class="comment"></span>
01040 <span class="comment">    InitialQuery - Address to store whether this is the first enumeration</span>
01041 <span class="comment">        query on this handle.</span>
01042 <span class="comment"></span>
01043 <span class="comment">Return Value:</span>
01044 <span class="comment"></span>
01045 <span class="comment">    None.</span>
01046 <span class="comment"></span>
01047 <span class="comment">--*/</span>
01048 
01049 {
01050     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01051 
01052     PUNICODE_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
01053     UNICODE_STRING SearchExpression;
01054 
01055     PUNICODE_STRING RestartName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01056     
01057     ULONG CcbFlags;
01058 
01059     LONGLONG FileIndex;
01060     ULONG HighFileIndex;
01061     BOOLEAN KnownIndex;
01062 
01063     BOOLEAN Found;
01064 
01065     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01066 
01067     <span class="comment">//</span>
01068     <span class="comment">//  Check inputs.</span>
01069     <span class="comment">//</span>
01070 
01071     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
01072     <a class="code" href="../../d1/d8/udfdata_8h.html#a18">ASSERT_FCB_INDEX</a>( Fcb );
01073     <a class="code" href="../../d1/d8/udfdata_8h.html#a22">ASSERT_CCB</a>( Ccb );
01074 
01075     <span class="comment">//</span>
01076     <span class="comment">//  If this is the initial query then build a search expression from the input</span>
01077     <span class="comment">//  file name.</span>
01078     <span class="comment">//</span>
01079 
01080     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Ccb-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a26">CCB_FLAG_ENUM_INITIALIZED</a> )) {
01081 
01082         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = (PUNICODE_STRING) IrpSp-&gt;Parameters.QueryDirectory.FileName;
01083 
01084         CcbFlags = 0;
01085 
01086         <span class="comment">//</span>
01087         <span class="comment">//  If the filename is not specified or is a single '*' then we will</span>
01088         <span class="comment">//  match all names.</span>
01089         <span class="comment">//</span>
01090 
01091         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01092             (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01093             (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length == 0) ||
01094             ((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length == <span class="keyword">sizeof</span>( WCHAR )) &amp;&amp;
01095              (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[0] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'*'</span>))) {
01096 
01097             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( CcbFlags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a24">CCB_FLAG_ENUM_MATCH_ALL</a> );
01098 
01099             SearchExpression.Length =
01100             SearchExpression.MaximumLength = 0;
01101             SearchExpression.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01102 
01103         <span class="comment">//</span>
01104         <span class="comment">//  Otherwise build the name from the name in the stack location.</span>
01105         <span class="comment">//  This involves checking for wild card characters and upcasing the</span>
01106         <span class="comment">//  string if this is a case-insensitive search.</span>
01107         <span class="comment">//</span>
01108 
01109         } <span class="keywordflow">else</span> {
01110 
01111             <span class="comment">//</span>
01112             <span class="comment">//  The name better have at least one character.</span>
01113             <span class="comment">//</span>
01114 
01115             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length == 0) {
01116 
01117                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_INVALID_PARAMETER );
01118             }
01119 
01120             <span class="comment">//</span>
01121             <span class="comment">//  Check for wildcards in the separate components.</span>
01122             <span class="comment">//</span>
01123 
01124             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a177">FsRtlDoesNameContainWildCards</a>( <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>)) {
01125 
01126                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( CcbFlags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a23">CCB_FLAG_ENUM_NAME_EXP_HAS_WILD</a> );
01127             }
01128             
01129             <span class="comment">//</span>
01130             <span class="comment">//  Now create the search expression to store in the Ccb.</span>
01131             <span class="comment">//</span>
01132 
01133             SearchExpression.Buffer = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( <a class="code" href="../../d3/d8/udfprocs_8h.html#a65">UdfPagedPool</a>,
01134                                                                 <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length,
01135                                                                 <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a70">TAG_ENUM_EXPRESSION</a> );
01136 
01137             SearchExpression.MaximumLength = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length;
01138 
01139             <span class="comment">//</span>
01140             <span class="comment">//  Either copy the name directly or perform the upcase.</span>
01141             <span class="comment">//</span>
01142 
01143             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Ccb-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a22">CCB_FLAG_IGNORE_CASE</a> )) {
01144 
01145                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a31">RtlUpcaseUnicodeString</a>( &amp;SearchExpression,
01146                                                  <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,
01147                                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01148 
01149                 <span class="comment">//</span>
01150                 <span class="comment">//  This should never fail.</span>
01151                 <span class="comment">//</span>
01152 
01153                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS );
01154 
01155             } <span class="keywordflow">else</span> {
01156 
01157                 RtlCopyMemory( SearchExpression.Buffer,
01158                                <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer,
01159                                <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length );
01160             }
01161 
01162             SearchExpression.Length = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length;
01163         }
01164 
01165         <span class="comment">//</span>
01166         <span class="comment">//  But we do not want to return the constant "." and ".." entries for</span>
01167         <span class="comment">//  the root directory, for consistency with the rest of Microsoft's</span>
01168         <span class="comment">//  filesystems.</span>
01169         <span class="comment">//</span>
01170 
01171         <span class="keywordflow">if</span> (Fcb == Fcb-&gt;Vcb-&gt;RootIndexFcb) {
01172 
01173             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( CcbFlags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a27">CCB_FLAG_ENUM_NOMATCH_CONSTANT_ENTRY</a> );
01174         }
01175 
01176         <span class="comment">//</span>
01177         <span class="comment">//  Now lock the Fcb in order to update the Ccb with the inital</span>
01178         <span class="comment">//  enumeration values.</span>
01179         <span class="comment">//</span>
01180 
01181         <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
01182 
01183         <span class="comment">//</span>
01184         <span class="comment">//  Check again that this is the initial search.</span>
01185         <span class="comment">//</span>
01186 
01187         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Ccb-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a26">CCB_FLAG_ENUM_INITIALIZED</a> )) {
01188 
01189             <span class="comment">//</span>
01190             <span class="comment">//  Update the values in the Ccb.</span>
01191             <span class="comment">//</span>
01192 
01193             Ccb-&gt;CurrentFileIndex = 0;
01194             Ccb-&gt;SearchExpression = SearchExpression;
01195 
01196             <span class="comment">//</span>
01197             <span class="comment">//  Set the appropriate flags in the Ccb.</span>
01198             <span class="comment">//</span>
01199 
01200             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Ccb-&gt;Flags, CcbFlags | <a class="code" href="../../d6/d8/udfstruc_8h.html#a26">CCB_FLAG_ENUM_INITIALIZED</a> );
01201 
01202         <span class="comment">//</span>
01203         <span class="comment">//  Otherwise cleanup any buffer allocated here.</span>
01204         <span class="comment">//</span>
01205 
01206         } <span class="keywordflow">else</span> {
01207 
01208             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( CcbFlags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a24">CCB_FLAG_ENUM_MATCH_ALL</a> )) {
01209 
01210                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;SearchExpression.Buffer );
01211             }
01212         }
01213 
01214     <span class="comment">//</span>
01215     <span class="comment">//  Otherwise lock the Fcb so we can read the current enumeration values.</span>
01216     <span class="comment">//</span>
01217 
01218     } <span class="keywordflow">else</span> {
01219 
01220         <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
01221     }
01222 
01223     <span class="comment">//</span>
01224     <span class="comment">//  Capture the current state of the enumeration.</span>
01225     <span class="comment">//</span>
01226     <span class="comment">//  If the user specified an index then use his offset.  We always</span>
01227     <span class="comment">//  return the next entry in this case.  If  no name is specified,</span>
01228     <span class="comment">//  then we can't perform the restart.</span>
01229     <span class="comment">//</span>
01230 
01231     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;Flags, <a class="code" href="../../d0/d5/io_8h.html#a210">SL_INDEX_SPECIFIED</a> ) &amp;&amp;
01232         IrpSp-&gt;Parameters.QueryDirectory.FileName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01233 
01234         KnownIndex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01235         FileIndex = IrpSp-&gt;Parameters.QueryDirectory.FileIndex;
01236         RestartName = (PUNICODE_STRING) IrpSp-&gt;Parameters.QueryDirectory.FileName;
01237         *ReturnNextEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01238 
01239         <span class="comment">//</span>
01240         <span class="comment">//  We will use the highest file index reportable to the caller as a</span>
01241         <span class="comment">//  starting point as required if we cannot directly land at the</span>
01242         <span class="comment">//  specified location.</span>
01243         <span class="comment">//</span>
01244         
01245         HighFileIndex = Ccb-&gt;HighestReturnableFileIndex;
01246 
01247     <span class="comment">//</span>
01248     <span class="comment">//  If we are restarting the scan then go from the self entry.</span>
01249     <span class="comment">//</span>
01250 
01251     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;Flags, <a class="code" href="../../d0/d5/io_8h.html#a208">SL_RESTART_SCAN</a> )) {
01252 
01253         KnownIndex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01254         FileIndex = 0;
01255         *ReturnNextEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01256 
01257     <span class="comment">//</span>
01258     <span class="comment">//  Otherwise use the values from the Ccb.</span>
01259     <span class="comment">//</span>
01260 
01261     } <span class="keywordflow">else</span> {
01262 
01263         KnownIndex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01264         FileIndex = Ccb-&gt;CurrentFileIndex;
01265         *ReturnNextEntry = <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( Ccb-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a25">CCB_FLAG_ENUM_RETURN_NEXT</a> );
01266     }
01267 
01268     <span class="comment">//</span>
01269     <span class="comment">//  Unlock the Fcb.</span>
01270     <span class="comment">//</span>
01271 
01272     <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
01273 
01274     <span class="comment">//</span>
01275     <span class="comment">//  We have the starting offset in the directory and whether to return</span>
01276     <span class="comment">//  that entry or the next.  If we are at the beginning of the directory</span>
01277     <span class="comment">//  and are returning that entry, then tell our caller this is the</span>
01278     <span class="comment">//  initial query.</span>
01279     <span class="comment">//</span>
01280 
01281     *InitialQuery = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01282 
01283     <span class="keywordflow">if</span> ((FileIndex == 0) &amp;&amp;
01284         !(*ReturnNextEntry)) {
01285 
01286         *InitialQuery = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01287     }
01288 
01289     <span class="comment">//</span>
01290     <span class="comment">//  Determine the offset in the stream to position the context and</span>
01291     <span class="comment">//  whether this offset is known to be a file offset.</span>
01292     <span class="comment">//</span>
01293     <span class="comment">//  If this offset is known to be safe then go ahead and position the</span>
01294     <span class="comment">//  context.  This handles the cases where the offset is the beginning</span>
01295     <span class="comment">//  of the stream, the offset is from a previous search or this is the</span>
01296     <span class="comment">//  initial query.</span>
01297     <span class="comment">//</span>
01298 
01299     <span class="keywordflow">if</span> (KnownIndex) {
01300 
01301         Found = <a class="code" href="../../d1/d8/dirctrl_8c.html#a16">UdfLookupInitialFileIndex</a>( IrpContext, Fcb, CompoundDirContext, &amp;FileIndex );
01302 
01303         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Found );
01304         
01305     <span class="comment">//</span>
01306     <span class="comment">//  Try to directly jump to the specified file index.  Otherwise we walk through</span>
01307     <span class="comment">//  the directory from the beginning (or the saved highest known offset if that is</span>
01308     <span class="comment">//  useful) until we reach the entry which contains this offset.</span>
01309     <span class="comment">//</span>
01310 
01311     } <span class="keywordflow">else</span> {
01312         
01313         <span class="comment">//</span>
01314         <span class="comment">//  We need to handle the special case of a restart from a synthesized</span>
01315         <span class="comment">//  entry - this is the one time where the restart index can be zero</span>
01316         <span class="comment">//  without requiring us to search above the 2^32 byte mark.</span>
01317         <span class="comment">//</span>
01318         
01319         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a185">UdfFullCompareNames</a>( IrpContext,
01320                                  RestartName,
01321                                  &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a6">UdfUnicodeDirectoryNames</a>[<a class="code" href="../../d1/d8/udfdata_8h.html#a5">SELF_ENTRY</a>] ) == <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a90">EqualTo</a>) {
01322 
01323             FileIndex = <a class="code" href="../../d1/d8/dirctrl_8c.html#a2">UDF_FILE_INDEX_VIRTUAL_SELF</a>;
01324 
01325             Found = <a class="code" href="../../d1/d8/dirctrl_8c.html#a16">UdfLookupInitialFileIndex</a>( IrpContext, Fcb, CompoundDirContext, &amp;FileIndex );
01326     
01327             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Found );
01328             
01329         <span class="comment">//</span>
01330         <span class="comment">//  We are restarting from a physical entry.  If the restart index is zero, we were</span>
01331         <span class="comment">//  unable to inform the caller as to the "real" file index due to the dispartity</span>
01332         <span class="comment">//  between the ULONG FileIndex in the return structures and the LONGLONG offsets</span>
01333         <span class="comment">//  possible in directory streams.  In this case, we will go as high as we were able</span>
01334         <span class="comment">//  to inform the caller of and search linearly from that point forward.</span>
01335         <span class="comment">//</span>
01336         <span class="comment">//  It is also possible (realistic? unknown) that the restart index is somewhere in the</span>
01337         <span class="comment">//  middle of an entry and we won't find anything useable.  In this case we try to find</span>
01338         <span class="comment">//  the entry which contains this index, using it as the real restart point.</span>
01339         <span class="comment">//</span>
01340         
01341         } <span class="keywordflow">else</span> {
01342 
01343             <span class="comment">//</span>
01344             <span class="comment">//  See if we need the high water mark.</span>
01345             <span class="comment">//</span>
01346             
01347             <span class="keywordflow">if</span> (FileIndex == 0) {
01348 
01349                 <span class="comment">//</span>
01350                 <span class="comment">//  We know that this is good.</span>
01351                 <span class="comment">//</span>
01352                 
01353                 FileIndex = <a class="code" href="../../d3/d8/udfprocs_8h.html#a4">Max</a>( Ccb-&gt;HighestReturnableFileIndex, <a class="code" href="../../d1/d8/dirctrl_8c.html#a3">UDF_FILE_INDEX_PHYSICAL</a> );;
01354                 KnownIndex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01355             
01356             }
01357             
01358             <span class="comment">//</span>
01359             <span class="comment">//  The file index is now useful, falling into two cases</span>
01360             <span class="comment">//</span>
01361             <span class="comment">//      1) KnownIndex == FALSE - searching by index</span>
01362             <span class="comment">//      2) KnownIndex == TRUE  - searching by name</span>
01363             <span class="comment">//</span>
01364             <span class="comment">//  Go set up our inquiry.</span>
01365             <span class="comment">//</span>
01366 
01367             Found = <a class="code" href="../../d1/d8/dirctrl_8c.html#a16">UdfLookupInitialFileIndex</a>( IrpContext, Fcb, CompoundDirContext, &amp;FileIndex );
01368             
01369             <span class="keywordflow">if</span> (KnownIndex) {
01370                 
01371                 <span class="comment">//</span>
01372                 <span class="comment">//  Walk forward to discover an entry named per the caller's expectation.</span>
01373                 <span class="comment">//</span>
01374                 
01375                 <span class="keywordflow">do</span> {
01376     
01377                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a171">UdfUpdateDirNames</a>( IrpContext,
01378                                        &amp;CompoundDirContext-&gt;DirContext,
01379                                        <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( Ccb-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a22">CCB_FLAG_IGNORE_CASE</a> ));
01380                     
01381                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a185">UdfFullCompareNames</a>( IrpContext,
01382                                              &amp;CompoundDirContext-&gt;DirContext.CaseObjectName,
01383                                              RestartName ) == <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a90">EqualTo</a>) {
01384 
01385                         <span class="keywordflow">break</span>;
01386                     }
01387 
01388                     Found = <a class="code" href="../../d1/d8/dirctrl_8c.html#a17">UdfLookupNextFileIndex</a>( IrpContext, Fcb, CompoundDirContext );
01389     
01390                 } <span class="keywordflow">while</span> (Found);
01391             
01392             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!Found) {
01393 
01394                 LONGLONG LastFileIndex;
01395 
01396                 <span class="comment">//</span>
01397                 <span class="comment">//  Perform the search for the entry by index from the beginning of the physical directory.</span>
01398                 <span class="comment">//</span>
01399 
01400                 LastFileIndex = <a class="code" href="../../d1/d8/dirctrl_8c.html#a3">UDF_FILE_INDEX_PHYSICAL</a>;
01401 
01402                 Found = <a class="code" href="../../d1/d8/dirctrl_8c.html#a16">UdfLookupInitialFileIndex</a>( IrpContext, Fcb, CompoundDirContext, &amp;LastFileIndex );
01403 
01404                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Found );
01405 
01406                 <span class="comment">//</span>
01407                 <span class="comment">//  Keep walking through the directory until we run out of</span>
01408                 <span class="comment">//  entries or we find an entry which ends beyond the input</span>
01409                 <span class="comment">//  index value (index search case) or corresponds to the</span>
01410                 <span class="comment">//  name we are looking for (name search case).</span>
01411                 <span class="comment">//</span>
01412     
01413                 <span class="keywordflow">do</span> {
01414     
01415                     <span class="comment">//</span>
01416                     <span class="comment">//  If we have passed the index value then exit.</span>
01417                     <span class="comment">//</span>
01418 
01419                     <span class="keywordflow">if</span> (CompoundDirContext-&gt;FileIndex.QuadPart &gt; FileIndex) {
01420 
01421                         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01422                         <span class="keywordflow">break</span>;
01423                     }
01424 
01425                     <span class="comment">//</span>
01426                     <span class="comment">//  Remember the current position in case we need to go back.</span>
01427                     <span class="comment">//</span>
01428 
01429                     LastFileIndex = CompoundDirContext-&gt;FileIndex.QuadPart;
01430 
01431                     <span class="comment">//</span>
01432                     <span class="comment">//  Exit if the next entry is beyond the desired index value.</span>
01433                     <span class="comment">//</span>
01434 
01435                     <span class="keywordflow">if</span> (LastFileIndex + <a class="code" href="../../d0/d7/iso13346_8h.html#a87">ISONsrFidSize</a>( CompoundDirContext-&gt;DirContext.Fid ) &gt; FileIndex) {
01436 
01437                         <span class="keywordflow">break</span>;
01438                     }
01439     
01440                     Found = <a class="code" href="../../d1/d8/dirctrl_8c.html#a17">UdfLookupNextFileIndex</a>( IrpContext, Fcb, CompoundDirContext );
01441     
01442                 } <span class="keywordflow">while</span> (Found);
01443     
01444                 <span class="comment">//</span>
01445                 <span class="comment">//  If we didn't find the entry then go back to the last known entry.</span>
01446                 <span class="comment">//</span>
01447     
01448                 <span class="keywordflow">if</span> (!Found) {
01449     
01450                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a168">UdfCleanupDirContext</a>( IrpContext, &amp;CompoundDirContext-&gt;DirContext );
01451                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a167">UdfInitializeDirContext</a>( IrpContext, &amp;CompoundDirContext-&gt;DirContext );
01452     
01453                     Found = <a class="code" href="../../d1/d8/dirctrl_8c.html#a16">UdfLookupInitialFileIndex</a>( IrpContext, Fcb, CompoundDirContext, &amp;LastFileIndex );
01454 
01455                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Found );
01456                 }
01457             }
01458         }
01459     }
01460 
01461     <span class="comment">//</span>
01462     <span class="comment">//  Only update the dirent name if we will need it for some reason.</span>
01463     <span class="comment">//  Don't update this name if we are returning the next entry, and</span>
01464     <span class="comment">//  don't update it if it was already done.</span>
01465     <span class="comment">//</span>
01466 
01467     <span class="keywordflow">if</span> (!(*ReturnNextEntry) &amp;&amp;
01468         CompoundDirContext-&gt;DirContext.PureObjectName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01469 
01470         <span class="comment">//</span>
01471         <span class="comment">//  Update the names in the dirent.</span>
01472         <span class="comment">//</span>
01473 
01474         <a class="code" href="../../d3/d8/udfprocs_8h.html#a171">UdfUpdateDirNames</a>( IrpContext,
01475                            &amp;CompoundDirContext-&gt;DirContext,
01476                            <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( Ccb-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a22">CCB_FLAG_IGNORE_CASE</a> ));
01477     }
01478 
01479     <span class="comment">//</span>
01480     <span class="comment">//  Look at the flag in the IrpSp indicating whether to return just</span>
01481     <span class="comment">//  one entry.</span>
01482     <span class="comment">//</span>
01483 
01484     *ReturnSingleEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01485 
01486     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;Flags, <a class="code" href="../../d0/d5/io_8h.html#a209">SL_RETURN_SINGLE_ENTRY</a> )) {
01487 
01488         *ReturnSingleEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01489     }
01490 
01491     <span class="keywordflow">return</span>;
01492 }
01493 
01494 
01495 <span class="comment">//</span>
01496 <span class="comment">//  Local support routine</span>
01497 <span class="comment">//</span>
01498 
01499 BOOLEAN
<a name="l01500"></a><a class="code" href="../../d1/d8/dirctrl_8c.html#a14">01500</a> <a class="code" href="../../d1/d8/dirctrl_8c.html#a14">UdfEnumerateIndex</a> (
01501     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
01502     IN <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb,
01503     IN OUT PCOMPOUND_DIR_ENUM_CONTEXT CompoundDirContext,
01504     IN BOOLEAN ReturnNextEntry
01505     )
01506 
01507 <span class="comment">/*++</span>
01508 <span class="comment"></span>
01509 <span class="comment">Routine Description:</span>
01510 <span class="comment"></span>
01511 <span class="comment">    This routine is the worker routine for index enumeration.  We are positioned</span>
01512 <span class="comment">    at some dirent in the directory and will either return the first match</span>
01513 <span class="comment">    at that point or look to the next entry.  The Ccb contains details about</span>
01514 <span class="comment">    the type of matching to do.</span>
01515 <span class="comment"></span>
01516 <span class="comment">Arguments:</span>
01517 <span class="comment"></span>
01518 <span class="comment">    Ccb - Ccb for this directory handle.</span>
01519 <span class="comment"></span>
01520 <span class="comment">    CompoundDirContext - context already positioned at some entry in the directory.</span>
01521 <span class="comment"></span>
01522 <span class="comment">    ReturnNextEntry - Indicates if we are returning this entry or should start</span>
01523 <span class="comment">        with the next entry.</span>
01524 <span class="comment"></span>
01525 <span class="comment">Return Value:</span>
01526 <span class="comment"></span>
01527 <span class="comment">    BOOLEAN - TRUE if next entry is found, FALSE otherwise.</span>
01528 <span class="comment"></span>
01529 <span class="comment">--*/</span>
01530 
01531 {
01532     BOOLEAN Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01533     <a class="code" href="../../d1/d2/structNSR__FID.html">PNSR_FID</a> Fid;
01534     <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext;
01535 
01536     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01537 
01538     <span class="comment">//</span>
01539     <span class="comment">//  Check inputs.</span>
01540     <span class="comment">//</span>
01541 
01542     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
01543     <a class="code" href="../../d1/d8/udfdata_8h.html#a22">ASSERT_CCB</a>( Ccb );
01544 
01545     <span class="comment">//</span>
01546     <span class="comment">//  Directly reference the directory enumeration context for convenience.</span>
01547     <span class="comment">//</span>
01548 
01549     DirContext = &amp;CompoundDirContext-&gt;DirContext;
01550 
01551     <span class="comment">//</span>
01552     <span class="comment">//  Loop until we find a match or exaust the directory.</span>
01553     <span class="comment">//</span>
01554 
01555     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01556 
01557         <span class="comment">//</span>
01558         <span class="comment">//  Move to the next entry unless we want to consider the current</span>
01559         <span class="comment">//  entry.</span>
01560         <span class="comment">//</span>
01561 
01562         <span class="keywordflow">if</span> (ReturnNextEntry) {
01563 
01564             <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d8/dirctrl_8c.html#a17">UdfLookupNextFileIndex</a>( IrpContext, Ccb-&gt;Fcb, CompoundDirContext )) {
01565 
01566                 <span class="keywordflow">break</span>;
01567             }
01568 
01569             <a class="code" href="../../d3/d8/udfprocs_8h.html#a171">UdfUpdateDirNames</a>( IrpContext,
01570                                DirContext,
01571                                <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( Ccb-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a22">CCB_FLAG_IGNORE_CASE</a> ));
01572         } <span class="keywordflow">else</span> {
01573 
01574             ReturnNextEntry = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01575         }
01576 
01577         <span class="comment">//</span>
01578         <span class="comment">//  Don't bother if we have a constant entry and are ignoring them.</span>
01579         <span class="comment">//</span>
01580         
01581         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o7">Flags</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a52">DIR_CONTEXT_FLAG_SEEN_NONCONSTANT</a> ) &amp;&amp;
01582             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Ccb-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a27">CCB_FLAG_ENUM_NOMATCH_CONSTANT_ENTRY</a> )) {
01583 
01584             <span class="keywordflow">continue</span>;
01585         }
01586 
01587         <span class="comment">//</span>
01588         <span class="comment">//  Directly reference the Fid for convenience.</span>
01589         <span class="comment">//</span>
01590 
01591         Fid = DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o5">Fid</a>;
01592 
01593         <span class="comment">//</span>
01594         <span class="comment">//  Look at the current entry if it is pointing at real space on the disk.  If the Fid is NULL, this</span>
01595         <span class="comment">//  means it is to be synthesized (and thus interesting to look at).</span>
01596         <span class="comment">//</span>
01597 
01598         <span class="keywordflow">if</span> (Fid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fid-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o2">Flags</a>, <a class="code" href="../../d0/d7/iso13346_8h.html#a90">NSR_FID_F_DELETED</a> )) {
01599 
01600             <span class="comment">//</span>
01601             <span class="comment">//  If we match all names then return to our caller.</span>
01602             <span class="comment">//</span>
01603 
01604             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Ccb-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a24">CCB_FLAG_ENUM_MATCH_ALL</a> )) {
01605 
01606                 DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.Length = 0;
01607                 Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01608 
01609                 <span class="keywordflow">break</span>;
01610             }
01611 
01612             <span class="comment">//</span>
01613             <span class="comment">//  Check if the long name matches the search expression.</span>
01614             <span class="comment">//</span>
01615 
01616             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a184">UdfIsNameInExpression</a>( IrpContext,
01617                                        &amp;DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o9">CaseObjectName</a>,
01618                                        &amp;Ccb-&gt;SearchExpression,
01619                                        <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( Ccb-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a23">CCB_FLAG_ENUM_NAME_EXP_HAS_WILD</a> ))) {
01620 
01621                 <span class="comment">//</span>
01622                 <span class="comment">//  Let our caller know we found an entry.</span>
01623                 <span class="comment">//</span>
01624 
01625                 DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.Length = 0;
01626                 Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01627 
01628                 <span class="keywordflow">break</span>;
01629             }
01630 
01631             <span class="comment">//</span>
01632             <span class="comment">//  The long name didn't match so we need to check for a</span>
01633             <span class="comment">//  possible short name match.  There is no match if the</span>
01634             <span class="comment">//  long name is one of the constant entries or already</span>
01635             <span class="comment">//  is 8dot3.</span>
01636             <span class="comment">//</span>
01637 
01638             <span class="keywordflow">if</span> (!(!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o7">Flags</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a52">DIR_CONTEXT_FLAG_SEEN_NONCONSTANT</a> ) ||
01639                   <a class="code" href="../../d3/d8/udfprocs_8h.html#a178">UdfIs8dot3Name</a>( IrpContext,
01640                                   DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o9">CaseObjectName</a> ))) {
01641 
01642                 <span class="comment">//</span>
01643                 <span class="comment">//  Allocate the shortname if it isn't already done.</span>
01644                 <span class="comment">//</span>
01645                 
01646                 <span class="keywordflow">if</span> (DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01647 
01648                     DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.Buffer = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( <a class="code" href="../../d3/d8/udfprocs_8h.html#a65">UdfPagedPool</a>,
01649                                                                                    <a class="code" href="../../d9/d7/udf_8h.html#a11">BYTE_COUNT_8_DOT_3</a>,
01650                                                                                    <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a83">TAG_SHORT_FILE_NAME</a> );
01651                     DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>.MaximumLength = <a class="code" href="../../d9/d7/udf_8h.html#a11">BYTE_COUNT_8_DOT_3</a>;
01652                 }
01653 
01654                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a180">UdfGenerate8dot3Name</a>( IrpContext,
01655                                       &amp;DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o10">PureObjectName</a>,
01656                                       &amp;DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a> );
01657 
01658                 <span class="comment">//</span>
01659                 <span class="comment">//  Check if this name matches.</span>
01660                 <span class="comment">//</span>
01661 
01662                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a184">UdfIsNameInExpression</a>( IrpContext,
01663                                            &amp;DirContext-&gt;<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o11">ShortObjectName</a>,
01664                                            &amp;Ccb-&gt;SearchExpression,
01665                                            <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( Ccb-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a23">CCB_FLAG_ENUM_NAME_EXP_HAS_WILD</a> ))) {
01666                     
01667                     <span class="comment">//</span>
01668                     <span class="comment">//  Let our caller know we found an entry.</span>
01669                     <span class="comment">//</span>
01670 
01671                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01672     
01673                     <span class="keywordflow">break</span>;
01674                 }
01675             }
01676         }
01677     }
01678 
01679     <span class="keywordflow">return</span> Found;
01680 }
01681 
01682 
01683 <span class="comment">//</span>
01684 <span class="comment">//  Local support routine</span>
01685 <span class="comment">//</span>
01686 
01687 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01688"></a><a class="code" href="../../d1/d8/dirctrl_8c.html#a15">01688</a> <a class="code" href="../../d1/d8/dirctrl_8c.html#a15">UdfLookupFileEntryInEnumeration</a> (
01689     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
01690     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
01691     IN PCOMPOUND_DIR_ENUM_CONTEXT CompoundDirContext
01692     )
01693 
01694 <span class="comment">/*++</span>
01695 <span class="comment"></span>
01696 <span class="comment">Routine Description:</span>
01697 <span class="comment"></span>
01698 <span class="comment">    This routine retrieves the file entry associated with the current location in</span>
01699 <span class="comment">    the enumeration of a compound directory context.</span>
01700 <span class="comment">  </span>
01701 <span class="comment">Arguments:</span>
01702 <span class="comment"></span>
01703 <span class="comment">    Fcb - the directory being enumerated.</span>
01704 <span class="comment">    </span>
01705 <span class="comment">    CompoundDirContext - a corresponding context for the enumeration.</span>
01706 <span class="comment">    </span>
01707 <span class="comment">Return Value:</span>
01708 <span class="comment"></span>
01709 <span class="comment">    None.  Status may be raised on discovery of corruption.</span>
01710 <span class="comment"></span>
01711 <span class="comment">--*/</span>
01712 
01713 {
01714     <a class="code" href="../../d1/d2/structNSR__FID.html">PNSR_FID</a> Fid;
01715     <a class="code" href="../../d8/d0/structICBFILE.html">PICBFILE</a> Fe;
01716 
01717     Fid = CompoundDirContext-&gt;DirContext.Fid;
01718 
01719     <span class="comment">//</span>
01720     <span class="comment">//  Figure out where the ICB we want is.</span>
01721     <span class="comment">//</span>
01722     
01723     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/dirctrl_8c.html#a10">UdfIsFileIndexVirtual</a>( CompoundDirContext-&gt;FileIndex.QuadPart )) {
01724 
01725         <span class="comment">//</span>
01726         <span class="comment">//  Synthesize!  We only have to synthesize the self entry.  The name is already done,</span>
01727         <span class="comment">//  so the remaining work is trivial.</span>
01728         <span class="comment">//</span>
01729 
01730         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Fid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01731 
01732         <span class="comment">//</span>
01733         <span class="comment">//  Lift the FE corresponding to this directory</span>
01734         <span class="comment">//</span>
01735 
01736         <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;CompoundDirContext-&gt;IcbContext );
01737         
01738         <a class="code" href="../../d3/d8/udfprocs_8h.html#a220">UdfInitializeIcbContextFromFcb</a>( IrpContext,
01739                                         &amp;CompoundDirContext-&gt;IcbContext,
01740                                         Fcb );
01741 
01742     } <span class="keywordflow">else</span> {
01743 
01744         <span class="comment">//</span>
01745         <span class="comment">//  Lift the FE corresponding to this FID.</span>
01746         <span class="comment">//</span>
01747 
01748         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Fid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01749 
01750         <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;CompoundDirContext-&gt;IcbContext );
01751 
01752         <a class="code" href="../../d3/d8/udfprocs_8h.html#a221">UdfInitializeIcbContext</a>( IrpContext,
01753                                  &amp;CompoundDirContext-&gt;IcbContext,
01754                                  Fcb-&gt;Vcb,
01755                                  <a class="code" href="../../d0/d7/iso13346_8h.html#a54">DESTAG_ID_NSR_FILE</a>,
01756                                  Fid-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o4">Icb</a>.<a class="code" href="../../d4/d9/structLONGAD.html#o1">Start</a>.<a class="code" href="../../d6/d3/structNSRLBA.html#o1">Partition</a>,
01757                                  Fid-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o4">Icb</a>.<a class="code" href="../../d4/d9/structLONGAD.html#o1">Start</a>.<a class="code" href="../../d6/d3/structNSRLBA.html#o0">Lbn</a>,
01758                                  Fid-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o4">Icb</a>.<a class="code" href="../../d4/d9/structLONGAD.html#o0">Length</a>.<a class="code" href="../../d7/d3/structNSRLENGTH.html#o0">Length</a> );
01759     }
01760 
01761     <span class="comment">//</span>
01762     <span class="comment">//  Retrieve the ICB for inspection.</span>
01763     <span class="comment">//</span>
01764     
01765     <a class="code" href="../../d3/d8/udfprocs_8h.html#a223">UdfLookupActiveIcb</a>( IrpContext, &amp;CompoundDirContext-&gt;IcbContext );
01766 
01767     Fe = (<a class="code" href="../../d8/d0/structICBFILE.html">PICBFILE</a>) CompoundDirContext-&gt;IcbContext.Active.View;
01768 
01769     <span class="comment">//</span>
01770     <span class="comment">//  Perform some basic verification that the FE is of the proper type and that</span>
01771     <span class="comment">//  FID and FE agree as to the type of the object.  We explicitly check that</span>
01772     <span class="comment">//  a legal filesystem-level FE type is discovered, even though we don't support</span>
01773     <span class="comment">//  them in other paths.</span>
01774     <span class="comment">//</span>
01775 
01776     <span class="keywordflow">if</span> (Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o0">Destag</a>.<a class="code" href="../../d7/d7/structDESTAG.html#o0">Ident</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a54">DESTAG_ID_NSR_FILE</a> ||
01777 
01778         (((Fid &amp;&amp; <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fid-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o2">Flags</a>, <a class="code" href="../../d0/d7/iso13346_8h.html#a89">NSR_FID_F_DIRECTORY</a> )) ||
01779           Fid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01780          Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a102">ICBTAG_FILE_T_DIRECTORY</a>) ||
01781 
01782         (Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a103">ICBTAG_FILE_T_FILE</a> &amp;&amp;
01783          Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a102">ICBTAG_FILE_T_DIRECTORY</a> &amp;&amp;
01784          Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a104">ICBTAG_FILE_T_BLOCK_DEV</a> &amp;&amp;
01785          Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a105">ICBTAG_FILE_T_CHAR_DEV</a> &amp;&amp;
01786          Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a107">ICBTAG_FILE_T_FIFO</a> &amp;&amp;
01787          Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a108">ICBTAG_FILE_T_C_ISSOCK</a> &amp;&amp;
01788          Fe-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a110">ICBTAG_FILE_T_PATHLINK</a>)) {
01789 
01790         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
01791     }
01792 }
01793 
01794 
01795 <span class="comment">//</span>
01796 <span class="comment">//  Local support routine</span>
01797 <span class="comment">//</span>
01798 
01799 BOOLEAN
<a name="l01800"></a><a class="code" href="../../d1/d8/dirctrl_8c.html#a16">01800</a> <a class="code" href="../../d1/d8/dirctrl_8c.html#a16">UdfLookupInitialFileIndex</a> (
01801     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
01802     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
01803     IN PCOMPOUND_DIR_ENUM_CONTEXT CompoundDirContext,
01804     IN PLONGLONG InitialIndex
01805     )
01806 
01807 <span class="comment">/*++</span>
01808 <span class="comment"></span>
01809 <span class="comment">Routine Description:</span>
01810 <span class="comment"></span>
01811 <span class="comment">    This routine begins the enumeration of a directory by setting the context</span>
01812 <span class="comment">    at the first avaliable virtual directory entry.</span>
01813 <span class="comment">  </span>
01814 <span class="comment">Arguments:</span>
01815 <span class="comment"></span>
01816 <span class="comment">    Fcb - the directory being enumerated.</span>
01817 <span class="comment">    </span>
01818 <span class="comment">    CompoundDirContext - a corresponding context for the enumeration.</span>
01819 <span class="comment">    </span>
01820 <span class="comment">    InitialIndex - an optional starting file index to base the enumeration.</span>
01821 <span class="comment">    </span>
01822 <span class="comment">Return Value:</span>
01823 <span class="comment"></span>
01824 <span class="comment">   TRUE will be returned if a valid entry is found at this offset, FALSE otherwise.</span>
01825 <span class="comment"></span>
01826 <span class="comment">--*/</span>
01827 
01828 {
01829     LONGLONG DirOffset;
01830 
01831     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/dirctrl_8c.html#a10">UdfIsFileIndexVirtual</a>( *InitialIndex )) {
01832 
01833         <span class="comment">//</span>
01834         <span class="comment">//  We only synthesize a single virtual directory entry.  Position the context</span>
01835         <span class="comment">//  at the virtual self entry.</span>
01836         <span class="comment">//</span>
01837         
01838         CompoundDirContext-&gt;FileIndex.QuadPart = <a class="code" href="../../d1/d8/dirctrl_8c.html#a2">UDF_FILE_INDEX_VIRTUAL_SELF</a>;
01839         
01840         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01841     }
01842 
01843     CompoundDirContext-&gt;FileIndex.QuadPart = *InitialIndex;
01844 
01845     <span class="comment">//</span>
01846     <span class="comment">//  Find the base offset in the directory and look it up.</span>
01847     <span class="comment">//</span>
01848     
01849     DirOffset = <a class="code" href="../../d1/d8/dirctrl_8c.html#a8">UdfFileIndexToPhysicalOffset</a>( *InitialIndex );
01850         
01851     <span class="keywordflow">return</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a169">UdfLookupInitialDirEntry</a>( IrpContext,
01852                                      Fcb,
01853                                      &amp;CompoundDirContext-&gt;DirContext,
01854                                      &amp;DirOffset );
01855 }
01856 
01857 
01858 <span class="comment">//</span>
01859 <span class="comment">//  Local support routine</span>
01860 <span class="comment">//</span>
01861 
01862 BOOLEAN
<a name="l01863"></a><a class="code" href="../../d1/d8/dirctrl_8c.html#a17">01863</a> <a class="code" href="../../d1/d8/dirctrl_8c.html#a17">UdfLookupNextFileIndex</a> (
01864     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
01865     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
01866     IN PCOMPOUND_DIR_ENUM_CONTEXT CompoundDirContext
01867     )
01868 
01869 <span class="comment">/*++</span>
01870 <span class="comment"></span>
01871 <span class="comment">Routine Description:</span>
01872 <span class="comment"></span>
01873 <span class="comment">    This routine advances the enumeration of a virtual directory by one entry.</span>
01874 <span class="comment"></span>
01875 <span class="comment">Arguments:</span>
01876 <span class="comment"></span>
01877 <span class="comment">    Fcb - the directory being enumerated.</span>
01878 <span class="comment">    </span>
01879 <span class="comment">    CompoundDirContext - a corresponding context for the enumeration.</span>
01880 <span class="comment"></span>
01881 <span class="comment">Return Value:</span>
01882 <span class="comment"></span>
01883 <span class="comment">    BOOLEAN True if another Fid is avaliable, False if we are at the end.</span>
01884 <span class="comment"></span>
01885 <span class="comment">--*/</span>
01886 
01887 {
01888     ULONG Advance;
01889     BOOLEAN Result;
01890 
01891     <span class="comment">//</span>
01892     <span class="comment">//  Advance from the synthesized to the physical directory.</span>
01893     <span class="comment">//</span>
01894     
01895     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/dirctrl_8c.html#a10">UdfIsFileIndexVirtual</a>( CompoundDirContext-&gt;FileIndex.QuadPart )) {
01896 
01897         Result = <a class="code" href="../../d3/d8/udfprocs_8h.html#a169">UdfLookupInitialDirEntry</a>( IrpContext,
01898                                            Fcb,
01899                                            &amp;CompoundDirContext-&gt;DirContext,
01900                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01901         
01902         <span class="keywordflow">if</span> (Result) {
01903             
01904             CompoundDirContext-&gt;FileIndex.QuadPart = <a class="code" href="../../d1/d8/dirctrl_8c.html#a3">UDF_FILE_INDEX_PHYSICAL</a>;
01905         }
01906 
01907         <span class="keywordflow">return</span> Result;
01908     }
01909     
01910     Advance = <a class="code" href="../../d0/d7/iso13346_8h.html#a87">ISONsrFidSize</a>( CompoundDirContext-&gt;DirContext.Fid );
01911     
01912     <span class="comment">//</span>
01913     <span class="comment">//  Advance to the next entry in this directory.</span>
01914     <span class="comment">//</span>
01915     
01916     Result = <a class="code" href="../../d3/d8/udfprocs_8h.html#a170">UdfLookupNextDirEntry</a>( IrpContext, Fcb, &amp;CompoundDirContext-&gt;DirContext );
01917 
01918     <span class="keywordflow">if</span> (Result) {
01919 
01920         CompoundDirContext-&gt;FileIndex.QuadPart += Advance;
01921     }
01922     
01923     <span class="keywordflow">return</span> Result;
01924 }
01925 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:44 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
