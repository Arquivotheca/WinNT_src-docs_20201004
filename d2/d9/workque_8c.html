<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: workque.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>workque.c File Reference</h1><code>#include "UdfProcs.h"</code><br>

<p>
<a href="../../d3/d8/workque_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d9/workque_8c.html#a0">BugCheckFileId</a>&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_WORKQUE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d9/workque_8c.html#a1">Dbg</a>&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_WORKQUE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d9/workque_8c.html#a2">FSP_PER_DEVICE_THRESHOLD</a>&nbsp;&nbsp;&nbsp;(2)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d9/workque_8c.html#a3">UdfAddToWorkque</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d9/workque_8c.html#a4">UdfFsdPostRequest</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d9/workque_8c.html#a5">UdfPrePostIrp</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d9/workque_8c.html#a6">UdfOplockComplete</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="workque.c::BugCheckFileId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BugCheckFileId&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_WORKQUE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/workque_8c-source.html#l00028">28</a> of file <a class="el" href="../../d3/d8/workque_8c-source.html">workque.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="workque.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_WORKQUE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/workque_8c-source.html#l00034">34</a> of file <a class="el" href="../../d3/d8/workque_8c-source.html">workque.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="workque.c::FSP_PER_DEVICE_THRESHOLD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSP_PER_DEVICE_THRESHOLD&nbsp;&nbsp;&nbsp;(2)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/workque_8c-source.html#l00041">41</a> of file <a class="el" href="../../d3/d8/workque_8c-source.html">workque.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/workque_8c-source.html#l00316">UdfAddToWorkque()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="workque.c::UdfAddToWorkque" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfAddToWorkque           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/workque_8c-source.html#l00316">316</a> of file <a class="el" href="../../d3/d8/workque_8c-source.html">workque.c</a>.
<p>
References <a class="el" href="../../d5/d8/ex_8h.html#a332a205">CriticalWorkQueue</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00041">FSP_PER_DEVICE_THRESHOLD</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02007">KeAcquireSpinLock</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00724">_VOLUME_DEVICE_OBJECT::OverflowQueue</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00716">_VOLUME_DEVICE_OBJECT::OverflowQueueCount</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00730">_VOLUME_DEVICE_OBJECT::OverflowQueueSpinLock</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00709">_VOLUME_DEVICE_OBJECT::PostedRequestCount</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/workque_8c-source.html#l00061">UdfFsdPostRequest()</a>, and <a class="el" href="../../d3/d8/workque_8c-source.html#l00222">UdfOplockComplete()</a>.
<p>
<pre class="fragment"><div>00323                    :
00324 
00325     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to acually store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> posted <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fsp
00326     workque.
00327 
00328 Arguments:
00329 
00330     IrpContext - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpContext to be queued to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fsp
00331 
00332     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet.
00333 
00334 Return Value:
00335 
00336     None.
00337 
00338 --*/
00339 
00340 {
00341     <a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">PVOLUME_DEVICE_OBJECT</a> Vdo;
00342     KIRQL SavedIrql;
00343     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00344 
00345     <span class="comment">//</span>
00346     <span class="comment">//  Check if this request has an associated file object, and thus volume</span>
00347     <span class="comment">//  device object.</span>
00348     <span class="comment">//</span>
00349 
00350     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00351 
00352 
00353         Vdo = CONTAINING_RECORD( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>,
00354                                  <a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">VOLUME_DEVICE_OBJECT</a>,
00355                                  DeviceObject );
00356 
00357         <span class="comment">//</span>
00358         <span class="comment">//  Check to see if this request should be sent to the overflow</span>
00359         <span class="comment">//  queue.  If not, then send it off to an exworker thread.</span>
00360         <span class="comment">//</span>
00361 
00362         <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>( &amp;Vdo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o4">OverflowQueueSpinLock</a>, &amp;SavedIrql );
00363 
00364         <span class="keywordflow">if</span> (Vdo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o1">PostedRequestCount</a> &gt; <a class="code" href="../../d2/d9/workque_8c.html#a2">FSP_PER_DEVICE_THRESHOLD</a>) {
00365 
00366             <span class="comment">//</span>
00367             <span class="comment">//  We cannot currently respond to this IRP so we'll just enqueue it</span>
00368             <span class="comment">//  to the overflow queue on the volume.</span>
00369             <span class="comment">//</span>
00370 
00371             InsertTailList( &amp;Vdo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o3">OverflowQueue</a>,
00372                             &amp;IrpContext-&gt;WorkQueueItem.List );
00373 
00374             Vdo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o2">OverflowQueueCount</a> += 1;
00375 
00376             <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>( &amp;Vdo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o4">OverflowQueueSpinLock</a>, SavedIrql );
00377 
00378             <span class="keywordflow">return</span>;
00379 
00380         } <span class="keywordflow">else</span> {
00381 
00382             <span class="comment">//</span>
00383             <span class="comment">//  We are going to send this Irp to an ex worker thread so up</span>
00384             <span class="comment">//  the count.</span>
00385             <span class="comment">//</span>
00386 
00387             Vdo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o1">PostedRequestCount</a> += 1;
00388 
00389             <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>( &amp;Vdo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o4">OverflowQueueSpinLock</a>, SavedIrql );
00390         }
00391     }
00392 
00393     <span class="comment">//</span>
00394     <span class="comment">//  Send it off.....</span>
00395     <span class="comment">//</span>
00396 
00397     <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;IrpContext-&gt;WorkQueueItem,
00398                           UdfFspDispatch,
00399                           IrpContext );
00400 
00401     <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;IrpContext-&gt;WorkQueueItem, CriticalWorkQueue );
00402 
00403     <span class="keywordflow">return</span>;
00404 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="workque.c::UdfFsdPostRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfFsdPostRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/workque_8c-source.html#l00061">61</a> of file <a class="el" href="../../d3/d8/workque_8c-source.html">workque.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00356">ASSERT_IRP</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00316">UdfAddToWorkque()</a>, and <a class="el" href="../../d3/d8/workque_8c-source.html#l00111">UdfPrePostIrp()</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00042">UdfPerformVerify()</a>, and <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00539">UdfProcessException()</a>.
<p>
<pre class="fragment"><div>00068                    :
00069 
00070     This routine enqueues <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request packet specified by IrpContext to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00071     work queue associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileSystemDeviceObject.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a FSD
00072     routine.
00073 
00074 Arguments:
00075 
00076     IrpContext - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpContext to be queued to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fsp.
00077 
00078     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet.
00079 
00080 Return Value:
00081 
00082     STATUS_PENDING
00083 
00084 --*/
00085 
00086 {
00087     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00088 
00089     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00090     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( Irp );
00091 
00092     <span class="comment">//</span>
00093     <span class="comment">//  Posting is a three step operation.  First lock down any buffers</span>
00094     <span class="comment">//  in the Irp.  Next cleanup the IrpContext for the post and finally</span>
00095     <span class="comment">//  add this to a workque.</span>
00096     <span class="comment">//</span>
00097 
00098     <a class="code" href="../../d2/d9/workque_8c.html#a5">UdfPrePostIrp</a>( IrpContext, Irp );
00099 
00100     <a class="code" href="../../d2/d9/workque_8c.html#a3">UdfAddToWorkque</a>( IrpContext, Irp );
00101 
00102     <span class="comment">//</span>
00103     <span class="comment">//  And return to our caller</span>
00104     <span class="comment">//</span>
00105 
00106     <span class="keywordflow">return</span> STATUS_PENDING;
00107 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="workque.c::UdfOplockComplete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfOplockComplete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/workque_8c-source.html#l00222">222</a> of file <a class="el" href="../../d3/d8/workque_8c-source.html">workque.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00055">IRP_MJ_CREATE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00316">UdfAddToWorkque()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01548">UdfReleaseFcb</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>.
<p>
Referenced by <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, and <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>.
<p>
<pre class="fragment"><div>00229                    :
00230 
00231     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oplock <span class="keyword">package </span>when an oplock break has
00232     completed, allowing an Irp to resume execution.  If the status in
00233     the Irp is STATUS_SUCCESS, then we queue the Irp to the Fsp queue.
00234     Otherwise we complete the Irp with the status in the Irp.
00235 
00236     If we are completing due to an error then check if there is any
00237     cleanup to do.
00238 
00239 Arguments:
00240 
00241     Irp - I/O Request Packet.
00242 
00243 Return Value:
00244 
00245     None.
00246 
00247 --*/
00248 
00249 {
00250     BOOLEAN RemovedFcb;
00251 
00252     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00253 
00254     <span class="comment">//</span>
00255     <span class="comment">//  Check on the return value in the Irp.  If success then we</span>
00256     <span class="comment">//  are to post this request.</span>
00257     <span class="comment">//</span>
00258 
00259     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status == STATUS_SUCCESS) {
00260 
00261         <span class="comment">//</span>
00262         <span class="comment">//  Check if there is any cleanup work to do.</span>
00263         <span class="comment">//</span>
00264 
00265         <span class="keywordflow">switch</span> (IrpContext-&gt;MajorFunction) {
00266 
00267         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a> :
00268 
00269             <span class="comment">//</span>
00270             <span class="comment">//  If called from the oplock package then there is an</span>
00271             <span class="comment">//  Fcb to possibly teardown.  We will call the teardown</span>
00272             <span class="comment">//  routine and release the Fcb if still present.  The cleanup</span>
00273             <span class="comment">//  code in create will know not to release this Fcb because</span>
00274             <span class="comment">//  we will clear the pointer.</span>
00275             <span class="comment">//</span>
00276 
00277             <span class="keywordflow">if</span> (IrpContext-&gt;TeardownFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00278 
00279                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, *(IrpContext-&gt;TeardownFcb), FALSE, &amp;RemovedFcb );
00280 
00281                 <span class="keywordflow">if</span> (!RemovedFcb) {
00282 
00283                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, *(IrpContext-&gt;TeardownFcb) );
00284                 }
00285 
00286                 *(IrpContext-&gt;TeardownFcb) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00287                 IrpContext-&gt;TeardownFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00288             }
00289 
00290             <span class="keywordflow">break</span>;
00291         }
00292         <span class="comment">//</span>
00293         <span class="comment">//  Insert the Irp context in the workqueue.</span>
00294         <span class="comment">//</span>
00295 
00296         <a class="code" href="../../d2/d9/workque_8c.html#a3">UdfAddToWorkque</a>( IrpContext, Irp );
00297 
00298     <span class="comment">//</span>
00299     <span class="comment">//  Otherwise complete the request.</span>
00300     <span class="comment">//</span>
00301 
00302     } <span class="keywordflow">else</span> {
00303 
00304         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status );
00305     }
00306 
00307     <span class="keywordflow">return</span>;
00308 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="workque.c::UdfPrePostIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfPrePostIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/workque_8c-source.html#l00111">111</a> of file <a class="el" href="../../d3/d8/workque_8c-source.html">workque.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00356">ASSERT_IRP</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01234">IRP_CONTEXT_FLAG_MORE_PROCESSING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00055">IRP_MJ_CREATE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00067">IRP_MJ_DIRECTORY_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00058">IRP_MJ_READ</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00140">IRP_MN_MDL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00103">IRP_MN_QUERY_DIRECTORY</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01437">UdfCleanupIrpContext()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00911">UdfLockUserBuffer</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01548">UdfReleaseFcb</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>, and <a class="el" href="../../d3/d8/workque_8c-source.html#l00061">UdfFsdPostRequest()</a>.
<p>
<pre class="fragment"><div>00118                    :
00119 
00120     This routine performs any neccessary work before STATUS_PENDING <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00121     returned with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fsd thread.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00122     filesystem and by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oplock package.
00123 
00124 Arguments:
00125 
00126     Context - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpContext to be queued to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fsp
00127 
00128     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet.
00129 
00130 Return Value:
00131 
00132     None.
00133 
00134 --*/
00135 
00136 {
00137     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00138     BOOLEAN RemovedFcb;
00139 
00140     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00141 
00142     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00143     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( Irp );
00144 
00145     <span class="comment">//</span>
00146     <span class="comment">//  Case on the type of the operation.</span>
00147     <span class="comment">//</span>
00148 
00149     <span class="keywordflow">switch</span> (IrpContext-&gt;MajorFunction) {
00150 
00151     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a> :
00152 
00153         <span class="comment">//</span>
00154         <span class="comment">//  If called from the oplock package then there is an</span>
00155         <span class="comment">//  Fcb to possibly teardown.  We will call the teardown</span>
00156         <span class="comment">//  routine and release the Fcb if still present.  The cleanup</span>
00157         <span class="comment">//  code in create will know not to release this Fcb because</span>
00158         <span class="comment">//  we will clear the pointer.</span>
00159         <span class="comment">//</span>
00160 
00161         <span class="keywordflow">if</span> ((IrpContext-&gt;TeardownFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00162             *(IrpContext-&gt;TeardownFcb) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00163 
00164             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, *(IrpContext-&gt;TeardownFcb), FALSE, &amp;RemovedFcb );
00165 
00166             <span class="keywordflow">if</span> (!RemovedFcb) {
00167 
00168                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, *(IrpContext-&gt;TeardownFcb) );
00169             }
00170 
00171             *(IrpContext-&gt;TeardownFcb) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00172             IrpContext-&gt;TeardownFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00173         }
00174 
00175         <span class="keywordflow">break</span>;
00176 
00177     <span class="comment">//</span>
00178     <span class="comment">//  We need to lock the user's buffer, unless this is an MDL-read,</span>
00179     <span class="comment">//  in which case there is no user buffer.</span>
00180     <span class="comment">//</span>
00181 
00182     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a> :
00183 
00184         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;MinorFunction, IRP_MN_MDL )) {
00185 
00186             <a class="code" href="../../d3/d8/udfprocs_8h.html#a71">UdfLockUserBuffer</a>( IrpContext, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.Length );
00187         }
00188 
00189         <span class="keywordflow">break</span>;
00190 
00191     <span class="comment">//</span>
00192     <span class="comment">//  We also need to check whether this is a query file operation.</span>
00193     <span class="comment">//</span>
00194     
00195     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a25">IRP_MJ_DIRECTORY_CONTROL</a> :
00196 
00197         <span class="keywordflow">if</span> (IrpContext-&gt;MinorFunction == <a class="code" href="../../d0/d5/io_8h.html#a44">IRP_MN_QUERY_DIRECTORY</a>) {
00198 
00199             <a class="code" href="../../d3/d8/udfprocs_8h.html#a71">UdfLockUserBuffer</a>( IrpContext, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDirectory.Length );
00200         }
00201 
00202         <span class="keywordflow">break</span>;
00203     }
00204     <span class="comment">//</span>
00205     <span class="comment">//  Cleanup the IrpContext for the post.</span>
00206     <span class="comment">//</span>
00207 
00208     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_MORE_PROCESSING );
00209     <a class="code" href="../../d3/d8/udfprocs_8h.html#a208">UdfCleanupIrpContext</a>( IrpContext, TRUE );
00210 
00211     <span class="comment">//</span>
00212     <span class="comment">//  Mark the Irp to show that we've already returned pending to the user.</span>
00213     <span class="comment">//</span>
00214 
00215     <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( Irp );
00216 
00217     <span class="keywordflow">return</span>;
00218 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:46:09 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
