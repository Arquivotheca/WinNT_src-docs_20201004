<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: imehotky.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>imehotky.c</h1><a href="../../d1/d0/imehotky_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: imehotky.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Contents:   Manage IME hotkey</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* There are the following two kind of hotkeys defined in the IME specification.</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* 1) IME hotkeys that changes the mode/status of current IME</span>
00011 <span class="comment">* 2) IME hotkeys that causes IME (keyboard layout) change</span>
00012 <span class="comment">*</span>
00013 <span class="comment">* History:</span>
00014 <span class="comment">* 10-Sep-1995 takaok   Created for NT 3.51.</span>
00015 <span class="comment">* 15-Mar-1996 takaok   Ported to NT 4.0</span>
00016 <span class="comment">\***************************************************************************/</span>
00017 
00018 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00019 <span class="preprocessor">#pragma hdrstop</span>
00020 <span class="preprocessor"></span>
00021 <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> <a class="code" href="../../d1/d0/imehotky_8c.html#a9">DeleteImeHotKey</a>(<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> *ppHead, <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> pDelete);
00022 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d1/d0/imehotky_8c.html#a10">AddImeHotKey</a>(<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> *ppHead, <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> pAdd);
00023 <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> <a class="code" href="../../d1/d0/imehotky_8c.html#a11">FindImeHotKeyByKey</a>(<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> pHead, UINT uModifyKeys, UINT uRL, UINT uVKey);
00024 <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> <a class="code" href="../../d1/d0/imehotky_8c.html#a12">FindImeHotKeyByID</a>(<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> pHead, DWORD dwHotKeyID);
00025 <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> <a class="code" href="../../d1/d0/imehotky_8c.html#a13">FindImeHotKeyByKeyWithLang</a>(<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> pHead, UINT uModifyKeys, UINT uRL, UINT uVKey, LANGID langId);
00026 
00027 
<a name="l00028"></a><a class="code" href="../../d1/d0/imehotky_8c.html#a0">00028</a> <span class="preprocessor">#define L_CHS   MAKELANGID(LANG_CHINESE, SUBLANG_CHINESE_SIMPLIFIED)</span>
<a name="l00029"></a><a class="code" href="../../d1/d0/imehotky_8c.html#a1">00029</a> <span class="preprocessor"></span><span class="preprocessor">#define L_JPN   MAKELANGID(LANG_JAPANESE, SUBLANG_DEFAULT)</span>
<a name="l00030"></a><a class="code" href="../../d1/d0/imehotky_8c.html#a2">00030</a> <span class="preprocessor"></span><span class="preprocessor">#define L_KOR   MAKELANGID(LANG_KOREAN, SUBLANG_DEFAULT)</span>
<a name="l00031"></a><a class="code" href="../../d1/d0/imehotky_8c.html#a3">00031</a> <span class="preprocessor"></span><span class="preprocessor">#define L_CHT   MAKELANGID(LANG_CHINESE, SUBLANG_CHINESE_TRADITIONAL)</span>
00032 <span class="preprocessor"></span>
00033 <span class="keyword">enum</span> {
00034     <a class="code" href="../../d1/d0/imehotky_8c.html#a20a5">ILANG_NO_MATCH</a> = 0,         <span class="comment">// 0: does not match.</span>
00035     <a class="code" href="../../d1/d0/imehotky_8c.html#a20a6">ILANG_MATCH_SYSTEM</a>,         <span class="comment">// 1: matches the system locale</span>
00036     <a class="code" href="../../d1/d0/imehotky_8c.html#a20a7">ILANG_MATCH_THREAD</a>,         <span class="comment">// 2: matches the thread locale</span>
00037     <a class="code" href="../../d1/d0/imehotky_8c.html#a20a8">ILANG_MATCH_PERFECT</a>,        <span class="comment">// 3: matches the current HKL, or direct KL switching hotkey.</span>
00038 };
00039 
00040 
00041 <span class="comment">// Make sure constants are within the range we expect</span>
00042 <span class="preprocessor">#if IME_CHOTKEY_FIRST != 0x10 || IME_JHOTKEY_FIRST != 0x30 || IME_KHOTKEY_FIRST != 0x50 || IME_THOTKEY_FIRST != 0x70</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#error unexpected IME_xHOTKEY range !</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00045 <span class="preprocessor"></span>
<a name="l00046"></a><a class="code" href="../../d1/d0/imehotky_8c.html#a14">00046</a> LANGID <a class="code" href="../../d1/d0/imehotky_8c.html#a14">GetHotKeyLangID</a>(DWORD dwHotKeyID)
00047 {
00048     LANGID langId = -1;
00049     <span class="keyword">static</span> CONST LANGID aLangId[] = {
00050         ~0,             <span class="comment">// 0x00 - 0x0f: illegal</span>
00051         <a class="code" href="../../d1/d0/imehotky_8c.html#a0">L_CHS</a>, <a class="code" href="../../d1/d0/imehotky_8c.html#a0">L_CHS</a>,   <span class="comment">// 0x10 - 0x2f</span>
00052         <a class="code" href="../../d1/d0/imehotky_8c.html#a1">L_JPN</a>, <a class="code" href="../../d1/d0/imehotky_8c.html#a1">L_JPN</a>,   <span class="comment">// 0x30 - 0x4f</span>
00053         <a class="code" href="../../d1/d0/imehotky_8c.html#a2">L_KOR</a>, <a class="code" href="../../d1/d0/imehotky_8c.html#a2">L_KOR</a>,   <span class="comment">// 0x50 - 0x6f</span>
00054         <a class="code" href="../../d1/d0/imehotky_8c.html#a3">L_CHT</a>, <a class="code" href="../../d1/d0/imehotky_8c.html#a3">L_CHT</a>,   <span class="comment">// 0x70 - 0x8f</span>
00055     };
00056 
00057     <span class="keywordflow">if</span> (dwHotKeyID &gt;= IME_CHOTKEY_FIRST &amp;&amp; dwHotKeyID &lt;= IME_THOTKEY_LAST) {
00058         langId = aLangId[dwHotKeyID &gt;&gt; 4];
00059     }
00060     <span class="keywordflow">else</span> {
00061         langId = LANG_NEUTRAL;
00062     }
00063 
00064     <span class="comment">// Because KOR IME does not want IME hot key handling</span>
00065     UserAssert(langId != <a class="code" href="../../d1/d0/imehotky_8c.html#a2">L_KOR</a>);
00066 
00067     <span class="keywordflow">return</span> langId;
00068 }
00069 
00070 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00071"></a><a class="code" href="../../d4/d1/userk_8h.html#a2048">00071</a> <a class="code" href="../../d4/d1/userk_8h.html#a2048">GetImeHotKey</a>(
00072     DWORD dwHotKeyID,
00073     PUINT puModifiers,
00074     PUINT puVKey,
00075     HKL   *phKL )
00076 {
00077     <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> ph;
00078 
00079     ph = <a class="code" href="../../d1/d0/imehotky_8c.html#a12">FindImeHotKeyByID</a>( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a119">gpImeHotKeyListHeader</a>, dwHotKeyID );
00080     <span class="keywordflow">if</span> ( ph == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00081         RIPERR0(ERROR_HOTKEY_NOT_REGISTERED, RIP_VERBOSE, <span class="stringliteral">"No such IME hotkey"</span>);
00082         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00083     }
00084 
00085     <span class="comment">//</span>
00086     <span class="comment">// it is OK for NULL phKL, if the target hKL is NULL</span>
00087     <span class="comment">//</span>
00088     <span class="keywordflow">if</span> ( phKL ) {
00089        *phKL = ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o3">hKL</a>;
00090     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o3">hKL</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00091         RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"phKL is null"</span>);
00092         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00093     }
00094 
00095     *puModifiers = ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o2">uModifiers</a>;
00096     *puVKey = ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o1">uVKey</a>;
00097 
00098     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00099 }
00100 
00101 <span class="comment">//</span>
00102 <span class="comment">// Insert/remove the specified IME hotkey into/from</span>
00103 <span class="comment">// the IME hotkey list (gpImeHotKeyListHeader).</span>
00104 <span class="comment">//</span>
00105 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00106"></a><a class="code" href="../../d4/d1/userk_8h.html#a2049">00106</a> <a class="code" href="../../d4/d1/userk_8h.html#a2049">SetImeHotKey</a>(
00107     DWORD  dwHotKeyID,
00108     UINT   uModifiers,
00109     UINT   uVKey,
00110     HKL    hKL,
00111     DWORD  dwAction )
00112 {
00113     <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> ph;
00114 
00115     <span class="keywordflow">switch</span> ( dwAction ) {
00116     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a28">ISHK_REMOVE</a>:
00117         ph = <a class="code" href="../../d1/d0/imehotky_8c.html#a12">FindImeHotKeyByID</a>( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a119">gpImeHotKeyListHeader</a>, dwHotKeyID );
00118         <span class="keywordflow">if</span> ( ph != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00119             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/imehotky_8c.html#a9">DeleteImeHotKey</a>( &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a119">gpImeHotKeyListHeader</a>, ph ) == ph ) {
00120                 UserFreePool( ph );
00121                 <span class="keywordflow">return</span> ( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00122             } <span class="keywordflow">else</span> {
00123                 RIPMSG0( RIP_ERROR, <span class="stringliteral">"IME hotkey list is messed up"</span> );
00124                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00125             }
00126         } <span class="keywordflow">else</span> {
00127             RIPERR0( ERROR_INVALID_PARAMETER,
00128                      RIP_WARNING,
00129                      <span class="stringliteral">"no such IME hotkey registered"</span>);
00130             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00131         }
00132         <span class="keywordflow">break</span>;
00133 
00134     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a30">ISHK_INITIALIZE</a>:
00135         ph = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a119">gpImeHotKeyListHeader</a>;
00136         <span class="keywordflow">while</span> ( ph != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00137             <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> phNext;
00138 
00139             phNext = ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o0">pNext</a>;
00140             UserFreePool( ph );
00141             ph = phNext;
00142         }
00143         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a119">gpImeHotKeyListHeader</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00144         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00145 
00146     <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/immstruc_8h.html#a29">ISHK_ADD</a>:
00147         <span class="keywordflow">if</span> (dwHotKeyID &gt;= IME_KHOTKEY_FIRST &amp;&amp; dwHotKeyID &lt;= IME_KHOTKEY_LAST) {
00148             <span class="comment">// Korean IME does not want any IMM hotkey handling.</span>
00149             <span class="comment">// We should not register any Korean IME hot keys.</span>
00150             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00151         }
00152 
00153         <span class="keywordflow">if</span> ((WORD)uVKey == VK_PACKET) {
00154             <span class="comment">//</span>
00155             <span class="comment">// VK_PACKET should not be a IME hot key.</span>
00156             <span class="comment">//</span>
00157             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00158         }
00159 
00160         ph = <a class="code" href="../../d1/d0/imehotky_8c.html#a13">FindImeHotKeyByKeyWithLang</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a119">gpImeHotKeyListHeader</a>,
00161                                 uModifiers &amp; <a class="code" href="../../d8/d0/immstruc_8h.html#a26">MOD_MODIFY_KEYS</a>,
00162                                 uModifiers &amp; <a class="code" href="../../d8/d0/immstruc_8h.html#a27">MOD_BOTH_SIDES</a>,
00163                                 uVKey,
00164                                 <a class="code" href="../../d1/d0/imehotky_8c.html#a14">GetHotKeyLangID</a>(dwHotKeyID));
00165         <span class="keywordflow">if</span> ( ph != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00166             <span class="keywordflow">if</span> ( ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o0">dwHotKeyID</a> != dwHotKeyID ) {
00167                 RIPERR0( ERROR_HOTKEY_ALREADY_REGISTERED,
00168                          RIP_WARNING,
00169                          <span class="stringliteral">"There is an IME hotkey that has the same vkey/modifiers/Lang Id"</span>);
00170                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00171             }
00172             <span class="comment">// So far we found a hotkey that has the</span>
00173             <span class="comment">// same vkey and same ID.</span>
00174             <span class="comment">// But because modifiers may be slightly</span>
00175             <span class="comment">// different, so go ahead and change it.</span>
00176         } <span class="keywordflow">else</span> {
00177             <span class="comment">//</span>
00178             <span class="comment">// the specified vkey/modifiers combination cound not be found</span>
00179             <span class="comment">// in the hotkey list. The caller may want to change the key</span>
00180             <span class="comment">// assignment of an existing hotkey or add a new hotkey.</span>
00181             <span class="comment">//</span>
00182             ph = <a class="code" href="../../d1/d0/imehotky_8c.html#a12">FindImeHotKeyByID</a>( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a119">gpImeHotKeyListHeader</a>, dwHotKeyID );
00183         }
00184 
00185         <span class="keywordflow">if</span> ( ph == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00186         <span class="comment">//</span>
00187         <span class="comment">// adding a new hotkey</span>
00188         <span class="comment">//</span>
00189             ph = (<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a>)UserAllocPool( <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">IMEHOTKEYOBJ</a>), TAG_IMEHOTKEY );
00190             <span class="keywordflow">if</span> ( ph == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00191                 RIPERR0( ERROR_OUTOFMEMORY,
00192                          RIP_WARNING,
00193                         <span class="stringliteral">"Memory allocation failed in SetImeHotKey"</span>);
00194                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00195             }
00196             ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o0">dwHotKeyID</a> = dwHotKeyID;
00197             ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o2">uModifiers</a> = uModifiers;
00198             ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o1">uVKey</a> = uVKey;
00199             ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o3">hKL</a> = hKL;
00200             ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o0">pNext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00201             <a class="code" href="../../d1/d0/imehotky_8c.html#a10">AddImeHotKey</a>( &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a119">gpImeHotKeyListHeader</a>, ph );
00202 
00203         } <span class="keywordflow">else</span> {
00204         <span class="comment">//</span>
00205         <span class="comment">// changing an existing hotkey</span>
00206         <span class="comment">//</span>
00207             ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o2">uModifiers</a> = uModifiers;
00208             ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o1">uVKey</a> = uVKey;
00209             ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o3">hKL</a> = hKL;
00210 
00211         }
00212         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00213     }
00214 
00215     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00216 }
00217 
00218 
<a name="l00219"></a><a class="code" href="../../d1/d0/imehotky_8c.html#a9">00219</a> <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> <a class="code" href="../../d1/d0/imehotky_8c.html#a9">DeleteImeHotKey</a>( <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> *ppHead, <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> pDelete )
00220 {
00221     <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> ph;
00222 
00223     <span class="keywordflow">if</span> ( pDelete == *ppHead ) {
00224         *ppHead = pDelete-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o0">pNext</a>;
00225         <span class="keywordflow">return</span> pDelete;
00226     }
00227 
00228     <span class="keywordflow">for</span> ( ph = *ppHead; ph != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ph = ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o0">pNext</a> ) {
00229         <span class="keywordflow">if</span> ( ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o0">pNext</a> == pDelete ) {
00230             ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o0">pNext</a> = pDelete-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o0">pNext</a>;
00231             <span class="keywordflow">return</span> pDelete;
00232         }
00233     }
00234     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00235 }
00236 
<a name="l00237"></a><a class="code" href="../../d1/d0/imehotky_8c.html#a10">00237</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d1/d0/imehotky_8c.html#a10">AddImeHotKey</a>( <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> *ppHead, <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> pAdd )
00238 {
00239     <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> ph;
00240 
00241     <span class="keywordflow">if</span> ( *ppHead == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00242         *ppHead = pAdd;
00243     } <span class="keywordflow">else</span> {
00244         ph = *ppHead;
00245         <span class="keywordflow">while</span>( ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o0">pNext</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
00246             ph = ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o0">pNext</a>;
00247         ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o0">pNext</a> = pAdd;
00248     }
00249     <span class="keywordflow">return</span>;
00250 }
00251 
<a name="l00252"></a><a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a25">00252</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d7/d1/w32_2ntuser_2kernel_2init_8c.html#a25">FreeImeHotKeys</a>(VOID)
00253 {
00254     <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> phk;
00255 
00256     <span class="keywordflow">while</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a119">gpImeHotKeyListHeader</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00257         phk = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a119">gpImeHotKeyListHeader</a>-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o0">pNext</a>;
00258         UserFreePool(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a119">gpImeHotKeyListHeader</a>);
00259         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a119">gpImeHotKeyListHeader</a> = phk;
00260     }
00261 }
00262 
00263 
<a name="l00264"></a><a class="code" href="../../d1/d0/imehotky_8c.html#a4">00264</a> LCID <a class="code" href="../../d1/d0/imehotky_8c.html#a4">glcidSystem</a>;
00265 
<a name="l00266"></a><a class="code" href="../../d1/d0/imehotky_8c.html#a18">00266</a> <span class="keywordtype">int</span> <a class="code" href="../../d1/d0/imehotky_8c.html#a18">GetLangIdMatchLevel</a>(HKL hkl, LANGID langId)
00267 {
00268 
00269     <span class="keywordflow">if</span> (langId == LANG_NEUTRAL) {
00270         <span class="comment">//</span>
00271         <span class="comment">// If langId is LANG_NEUTRAL, the hot key does not depend on</span>
00272         <span class="comment">// the current HKL. Make it perfect match always.</span>
00273         <span class="comment">//</span>
00274         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/imehotky_8c.html#a20a8">ILANG_MATCH_PERFECT</a>;
00275     }
00276 
00277     {
00278         LCID lcid;
00279 
00280         <span class="keywordflow">if</span> (LOWORD(HandleToUlong(hkl)) == langId) {
00281             <span class="comment">// langId matches the current KL locale</span>
00282             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/imehotky_8c.html#a20a8">ILANG_MATCH_PERFECT</a>;
00283         }
00284 
00285         lcid = NtCurrentTeb()-&gt;CurrentLocale;
00286         <span class="keywordflow">if</span> (LANGIDFROMLCID(lcid) == langId) {
00287             <span class="comment">// langId matches the current thread's locale</span>
00288             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/imehotky_8c.html#a20a7">ILANG_MATCH_THREAD</a>;
00289         }
00290 
00291         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/imehotky_8c.html#a4">glcidSystem</a> == 0) {
00292             <span class="comment">// If we've not got system default locale yet, get it here.</span>
00293             ZwQueryDefaultLocale(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;<a class="code" href="../../d1/d0/imehotky_8c.html#a4">glcidSystem</a>);
00294         }
00295         <span class="keywordflow">if</span> (LANGIDFROMLCID(<a class="code" href="../../d1/d0/imehotky_8c.html#a4">glcidSystem</a>) == langId) {
00296             <span class="comment">// langId matches the system locale.</span>
00297             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/imehotky_8c.html#a20a6">ILANG_MATCH_SYSTEM</a>;
00298         }
00299     }
00300 
00301     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/imehotky_8c.html#a20a5">ILANG_NO_MATCH</a>;
00302 }
00303 
00305 <span class="comment">// FindImeHotKeyByKey()</span>
00306 <span class="comment">// Return Value:</span>
00307 <span class="comment">//      pHotKey - IMEHOTKEY pointer with the key,</span>
00308 <span class="comment">//      else NULL - failure</span>
00309 <span class="comment">//</span>
00310 <span class="comment">// Finds the best matching of IME hot keys considering the current</span>
00311 <span class="comment">// input locale.</span>
00312 <span class="comment">//</span>
00314 <span class="comment"></span>
<a name="l00315"></a><a class="code" href="../../d1/d0/imehotky_8c.html#a11">00315</a> <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> <a class="code" href="../../d1/d0/imehotky_8c.html#a11">FindImeHotKeyByKey</a>(   <span class="comment">// Finds pHotKey with this input key</span>
00316     <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> pHead,
00317     UINT uModifyKeys,               <span class="comment">// the modify keys of this input key</span>
00318     UINT uRL,                       <span class="comment">// the right and left hand side</span>
00319     UINT uVKey)                     <span class="comment">// the input key</span>
00320 {
00321     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00322     <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> phResult = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00323     <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> ph;
00324     HKL hkl = <a class="code" href="../../d6/d8/ntinput_8c.html#a43">GetActiveHKL</a>();
00325     WORD langPrimary = PRIMARYLANGID(LOWORD(HandleToUlong(hkl)));
00326     <span class="keywordtype">int</span> iLevel = <a class="code" href="../../d1/d0/imehotky_8c.html#a20a5">ILANG_NO_MATCH</a>;
00327 
00328     <span class="keywordflow">for</span> (ph = pHead; ph != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ph = ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o0">pNext</a>) {
00329 
00330         <span class="keywordflow">if</span> (ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o1">uVKey</a> == uVKey) {
00331             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fDoCheck = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00332 
00333             <span class="comment">// Check if the modifiers match</span>
00334             <span class="keywordflow">if</span> ((ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o2">uModifiers</a> &amp; MOD_IGNORE_ALL_MODIFIER)) {
00335                 fDoCheck = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00336             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o2">uModifiers</a> &amp; <a class="code" href="../../d8/d0/immstruc_8h.html#a26">MOD_MODIFY_KEYS</a>) != uModifyKeys) {
00337                 <span class="keywordflow">continue</span>;
00338             }
00339 
00340             <span class="keywordflow">if</span> ((ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o2">uModifiers</a> &amp; <a class="code" href="../../d8/d0/immstruc_8h.html#a27">MOD_BOTH_SIDES</a>) == uRL ||
00341                     (ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o2">uModifiers</a> &amp; <a class="code" href="../../d8/d0/immstruc_8h.html#a27">MOD_BOTH_SIDES</a>) &amp; uRL) {
00342                 fDoCheck = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00343             }
00344 
00345             <span class="keywordflow">if</span> (fDoCheck) {
00346                 LANGID langId = <a class="code" href="../../d1/d0/imehotky_8c.html#a14">GetHotKeyLangID</a>(ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o0">dwHotKeyID</a>);
00347                 <span class="keywordtype">int</span> iMatch = <a class="code" href="../../d1/d0/imehotky_8c.html#a18">GetLangIdMatchLevel</a>(hkl, langId);
00348 
00349 <span class="preprocessor">#if 0   // Test only</span>
00350 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (iMatch != <a class="code" href="../../d1/d0/imehotky_8c.html#a20a5">ILANG_NO_MATCH</a>) {
00351                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"GetIdMatchLevel(%X, %X)=%d\n"</span>, hkl, langId);
00352                 }
00353 <span class="preprocessor">#endif</span>
00354 <span class="preprocessor"></span>
00355                 <span class="keywordflow">if</span> (iMatch == <a class="code" href="../../d1/d0/imehotky_8c.html#a20a8">ILANG_MATCH_PERFECT</a>) {
00356                     <span class="comment">// Perfect match !</span>
00357                     <span class="keywordflow">return</span> ph;
00358                 }
00359 
00360                 <span class="comment">// If the hotkey is DSWITCH, GetLangIdMatchLevel() must return 3.</span>
00361                 UserAssert(ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o0">dwHotKeyID</a> &lt; IME_HOTKEY_DSWITCH_FIRST ||
00362                            ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o0">dwHotKeyID</a> &gt; IME_HOTKEY_DSWITCH_LAST);
00363 
00364                 <span class="keywordflow">if</span> (langPrimary == LANG_KOREAN) {
00365                     <span class="comment">// Korean IME wants no hotkeys except the direct</span>
00366                     <span class="comment">// keyboard layout switching hotkeys.</span>
00367                     <span class="keywordflow">continue</span>;
00368                 }
00369 
00370                 <span class="keywordflow">if</span> (iMatch == <a class="code" href="../../d1/d0/imehotky_8c.html#a20a5">ILANG_NO_MATCH</a>) {
00371                     <span class="comment">// Special case for CHT/CHS toggle</span>
00372                     <span class="keywordflow">if</span> (ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o0">dwHotKeyID</a> == IME_CHOTKEY_IME_NONIME_TOGGLE ||
00373                             ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o0">dwHotKeyID</a> == IME_THOTKEY_IME_NONIME_TOGGLE) {
00374                         <span class="comment">//</span>
00375                         <span class="comment">// If the key is for CHT/CHS toggle and the previous</span>
00376                         <span class="comment">// hkl is either CHT/CHS, it is a IME hotkey.</span>
00377                         <span class="comment">//</span>
00378                         <span class="keywordflow">if</span> (LOWORD(HandleToUlong(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o41">hklPrev</a>)) == langId) {
00379 <span class="preprocessor">#if 0   // Test only</span>
00380 <span class="preprocessor"></span>                            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"FindImeHotKeyByKey() found CHT/CHS hotkey.\n"</span>);
00381 <span class="preprocessor">#endif</span>
00382 <span class="preprocessor"></span>                            <span class="keywordflow">return</span> ph;
00383                         }
00384                     }
00385                 }
00386                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iMatch &gt; iLevel) {
00387                     <span class="comment">// Current ph is the strongest candidate so far.</span>
00388                     iLevel = iMatch;
00389                     phResult = ph;
00390                 }
00391             }
00392         }
00393     }
00394 
00395     <span class="keywordflow">return</span> phResult;
00396 }
00397 
00398 <span class="comment">/**********************************************************************/</span>
00399 <span class="comment">/* FindImeHotKeyByID()                                                */</span>
00400 <span class="comment">/* Return Value:                                                      */</span>
00401 <span class="comment">/*      pHotKey   - IMEHOTKEY pointer with the dwHotKeyID,            */</span>
00402 <span class="comment">/*      else NULL - failure                                           */</span>
00403 <span class="comment">/**********************************************************************/</span>
<a name="l00404"></a><a class="code" href="../../d1/d0/imehotky_8c.html#a12">00404</a> <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> <a class="code" href="../../d1/d0/imehotky_8c.html#a12">FindImeHotKeyByID</a>( <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> pHead, DWORD dwHotKeyID )
00405 {
00406     <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> ph;
00407 
00408     <span class="keywordflow">for</span> ( ph = pHead; ph != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ph = ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o0">pNext</a> ) {
00409         <span class="keywordflow">if</span> ( ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o0">dwHotKeyID</a> == dwHotKeyID )
00410                 <span class="keywordflow">return</span> (ph);
00411     }
00412     <span class="keywordflow">return</span> (<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00413 }
00414 
00415 <span class="comment">/**********************************************************************/</span>
00416 <span class="comment">/* FindImeHotKeyByKeyWithLang()                                       */</span>
00417 <span class="comment">/* Return Value:                                                      */</span>
00418 <span class="comment">/*      pHotKey - IMEHOTKEY pointer with the key,                     */</span>
00419 <span class="comment">/*      else NULL - failure                                           */</span>
00420 <span class="comment">/**********************************************************************/</span>
<a name="l00421"></a><a class="code" href="../../d1/d0/imehotky_8c.html#a13">00421</a> <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> <a class="code" href="../../d1/d0/imehotky_8c.html#a13">FindImeHotKeyByKeyWithLang</a>(      <span class="comment">// Finds pHotKey with this input key</span>
00422     <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> pHead,
00423     UINT uModifyKeys,               <span class="comment">// the modify keys of this input key</span>
00424     UINT uRL,                       <span class="comment">// the right and left hand side</span>
00425     UINT uVKey,                     <span class="comment">// the input key</span>
00426     LANGID langIdKey)               <span class="comment">// the language id</span>
00427 {
00428     <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> ph;
00429 
00430     <span class="keywordflow">for</span> (ph = pHead; ph != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ph = ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o0">pNext</a>) {
00431 
00432         <span class="keywordflow">if</span> (ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o1">uVKey</a> == uVKey) {
00433             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fDoCheck = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00434 
00435             <span class="comment">// Check if the modifiers match</span>
00436             <span class="keywordflow">if</span> ((ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o2">uModifiers</a> &amp; MOD_IGNORE_ALL_MODIFIER)) {
00437                 fDoCheck = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00438             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o2">uModifiers</a> &amp; <a class="code" href="../../d8/d0/immstruc_8h.html#a26">MOD_MODIFY_KEYS</a>) != uModifyKeys) {
00439                 <span class="keywordflow">continue</span>;
00440             }
00441 
00442             <span class="keywordflow">if</span> ((ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o2">uModifiers</a> &amp; <a class="code" href="../../d8/d0/immstruc_8h.html#a27">MOD_BOTH_SIDES</a>) == uRL ||
00443                     (ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o2">uModifiers</a> &amp; <a class="code" href="../../d8/d0/immstruc_8h.html#a27">MOD_BOTH_SIDES</a>) &amp; uRL) {
00444                 fDoCheck = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00445             }
00446 
00447             <span class="keywordflow">if</span> (fDoCheck) {
00448                 LANGID langId = <a class="code" href="../../d1/d0/imehotky_8c.html#a14">GetHotKeyLangID</a>(ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o0">dwHotKeyID</a>);
00449 
00450                 <span class="keywordflow">if</span> (langIdKey == langId || langId == LANG_NEUTRAL) {
00451                     <span class="keywordflow">return</span> ph;
00452                 }
00453             }
00454         }
00455     }
00456 
00457     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00458 }
00459 
00460 <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a>
<a name="l00461"></a><a class="code" href="../../d4/d1/userk_8h.html#a2050">00461</a> <a class="code" href="../../d4/d1/userk_8h.html#a2050">CheckImeHotKey</a>(
00462     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>   pq,            <span class="comment">// input queue</span>
00463     UINT uVKey,         <span class="comment">// virtual key</span>
00464     LPARAM lParam       <span class="comment">// lparam of WM_KEYxxx message</span>
00465     )
00466 {
00467     <span class="keyword">static</span> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uVKeySaved = 0;
00468     <a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html">PIMEHOTKEYOBJ</a> ph;
00469     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uModifiers = 0;
00470     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fKeyUp;
00471 
00472     <span class="comment">//</span>
00473     <span class="comment">// early return for key up message</span>
00474     <span class="comment">//</span>
00475     fKeyUp = ( lParam &amp; 0x80000000 ) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00476     <span class="keywordflow">if</span> ( fKeyUp ) {
00477         <span class="comment">//</span>
00478         <span class="comment">// if the uVKey is not same as the vkey</span>
00479         <span class="comment">// we previously saved, there is no chance</span>
00480         <span class="comment">// that this is a hotkey.</span>
00481         <span class="comment">//</span>
00482         <span class="keywordflow">if</span> ( uVKeySaved != uVKey ) {
00483             uVKeySaved = 0;
00484             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00485         }
00486         uVKeySaved = 0;
00487         <span class="comment">//</span>
00488         <span class="comment">// If it's same, we still need to check</span>
00489         <span class="comment">// the hotkey list because there is a</span>
00490         <span class="comment">// chance that the hotkey list is modified</span>
00491         <span class="comment">// between the key make and break.</span>
00492         <span class="comment">//</span>
00493     }
00494 
00495     <span class="comment">//</span>
00496     <span class="comment">// Current specification doesn't allow us to use a complex</span>
00497     <span class="comment">// hotkey such as LSHIFT+RMENU+SPACE</span>
00498     <span class="comment">//</span>
00499 
00500     <span class="comment">//</span>
00501     <span class="comment">// Setup the shift, control, alt key states</span>
00502     <span class="comment">//</span>
00503     uModifiers |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pq, VK_LSHIFT) ? (MOD_SHIFT | MOD_LEFT) : 0;
00504     uModifiers |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pq, VK_RSHIFT) ? (MOD_SHIFT | MOD_RIGHT) : 0;
00505 
00506     uModifiers |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pq, VK_LCONTROL) ? (MOD_CONTROL | MOD_LEFT) : 0;
00507     uModifiers |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pq, VK_RCONTROL) ? (MOD_CONTROL | MOD_RIGHT) : 0;
00508 
00509     uModifiers |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pq, VK_LMENU) ? (MOD_ALT | MOD_LEFT) : 0;
00510     uModifiers |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(pq, VK_RMENU) ? (MOD_ALT | MOD_RIGHT) : 0;
00511 
00512     ph = <a class="code" href="../../d1/d0/imehotky_8c.html#a11">FindImeHotKeyByKey</a>( <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a119">gpImeHotKeyListHeader</a>,
00513                              uModifiers &amp; <a class="code" href="../../d8/d0/immstruc_8h.html#a26">MOD_MODIFY_KEYS</a>,
00514                              uModifiers &amp; <a class="code" href="../../d8/d0/immstruc_8h.html#a27">MOD_BOTH_SIDES</a>,
00515                              uVKey );
00516 
00517     <span class="keywordflow">if</span> ( ph != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00518         <span class="keywordflow">if</span> ( fKeyUp ) {
00519             <span class="keywordflow">if</span> ( ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o2">uModifiers</a> &amp; MOD_ON_KEYUP ) {
00520                 <span class="keywordflow">return</span> ph;
00521             }
00522         } <span class="keywordflow">else</span> {
00523             <span class="keywordflow">if</span> ( ph-&gt;<a class="code" href="../../d8/d8/struct__tagIMEHOTKEYOBJ.html#o1">hk</a>.<a class="code" href="../../d7/d8/struct__tagIMEHOTKEY.html#o2">uModifiers</a> &amp; MOD_ON_KEYUP ) {
00524             <span class="comment">//</span>
00525             <span class="comment">// save vkey for next keyup message time</span>
00526             <span class="comment">//</span>
00527             <span class="comment">// when ALT+Z is a hotkey, we don't want</span>
00528             <span class="comment">// to handle #2 as the hotkey sequence.</span>
00529             <span class="comment">// 1) ALT make -&gt; 'Z' make -&gt; 'Z' break</span>
00530             <span class="comment">// 2) 'Z' make -&gt; ALT make -&gt; 'Z' break</span>
00531             <span class="comment">//</span>
00532                 uVKeySaved = uVKey;
00533             } <span class="keywordflow">else</span> {
00534                 <span class="keywordflow">return</span> ph;
00535             }
00536         }
00537     }
00538 
00539     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00540 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:20 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
