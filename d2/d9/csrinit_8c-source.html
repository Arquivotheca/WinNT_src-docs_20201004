<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: csrinit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>csrinit.c</h1><a href="../../d1/d0/csrinit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    dllinit.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the initialization code for the Client-Server (CS)</span>
00012 <span class="comment">    Client DLL.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Steve Wood (stevewo) 8-Oct-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    User Mode only</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d9/d9/csrdll_8h.html">csrdll.h</a>"</span>
00027 <span class="preprocessor">#include "<a class="code" href="../../d9/d2/ldrp_8h.html">ldrp.h</a>"</span>
00028 
00029 BOOLEAN
<a name="l00030"></a><a class="code" href="../../d1/d0/csrinit_8c.html#a0">00030</a> <a class="code" href="../../d1/d0/csrinit_8c.html#a0">CsrDllInitialize</a>(
00031     IN PVOID DllHandle,
00032     IN ULONG Reason,
00033     IN PCONTEXT Context OPTIONAL
00034     )
00035 
00036 <span class="comment">/*++</span>
00037 <span class="comment"></span>
00038 <span class="comment">Routine Description:</span>
00039 <span class="comment"></span>
00040 <span class="comment">    This function is the DLL initialization routine for the Client DLL</span>
00041 <span class="comment">    This function gets control when the application links to this DLL</span>
00042 <span class="comment">    are snapped.</span>
00043 <span class="comment"></span>
00044 <span class="comment">Arguments:</span>
00045 <span class="comment"></span>
00046 <span class="comment">    Context - Supplies an optional context buffer that will be restore</span>
00047 <span class="comment">              after all DLL initialization has been completed.  If this</span>
00048 <span class="comment">              parameter is NULL then this is a dynamic snap of this module.</span>
00049 <span class="comment">              Otherwise this is a static snap prior to the user process</span>
00050 <span class="comment">              gaining control.</span>
00051 <span class="comment"></span>
00052 <span class="comment">Return Value:</span>
00053 <span class="comment"></span>
00054 <span class="comment">    Status value.</span>
00055 <span class="comment"></span>
00056 <span class="comment">--*/</span>
00057 
00058 {
00059     Context;
00060 
00061     <span class="keywordflow">if</span> (Reason != DLL_PROCESS_ATTACH) {
00062         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00063         }
00064 
00065     <span class="comment">//</span>
00066     <span class="comment">// Remember our DLL handle in a global variable.</span>
00067     <span class="comment">//</span>
00068 
00069     <a class="code" href="../../d9/d9/csrdll_8h.html#a19">CsrDllHandle</a> = DllHandle;
00070 
00071     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00072 }
00073 
00074 
00075 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00076"></a><a class="code" href="../../d1/d0/csrinit_8c.html#a1">00076</a> <a class="code" href="../../d1/d0/csrinit_8c.html#a1">CsrOneTimeInitialize</a>( VOID )
00077 {
00078     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00079 
00080     <span class="comment">//</span>
00081     <span class="comment">// Save away system information in a global variable</span>
00082     <span class="comment">//</span>
00083 
00084     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a49">NtQuerySystemInformation</a>( SystemBasicInformation,
00085                                        &amp;<a class="code" href="../../d9/d9/csrdll_8h.html#a11">CsrNtSysInfo</a>,
00086                                        <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d9/csrdll_8h.html#a11">CsrNtSysInfo</a> ),
00087                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00088                                      );
00089     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00090         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00091         }
00092 
00093     <span class="comment">//</span>
00094     <span class="comment">// Use the process heap for memory allocation.</span>
00095     <span class="comment">//</span>
00096 
00097     <a class="code" href="../../d9/d9/csrdll_8h.html#a13">CsrHeap</a> = RtlProcessHeap();
00098 
00099     <a class="code" href="../../d9/d9/csrdll_8h.html#a8">CsrInitOnceDone</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00100 
00101     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00102 }
00103 
00104 
00105 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00106"></a><a class="code" href="../../d1/d0/csrinit_8c.html#a2">00106</a> <a class="code" href="../../d8/d9/wow64csr_8c.html#a0">CsrClientConnectToServer</a>(
00107     IN PWSTR ObjectDirectory,
00108     IN ULONG ServerDllIndex,
00109     IN PCSR_CALLBACK_INFO CallbackInformation OPTIONAL,
00110     IN PVOID ConnectionInformation,
00111     IN OUT PULONG ConnectionInformationLength OPTIONAL,
00112     OUT PBOOLEAN CalledFromServer OPTIONAL
00113     )
00114 
00115 <span class="comment">/*++</span>
00116 <span class="comment"></span>
00117 <span class="comment">Routine Description:</span>
00118 <span class="comment"></span>
00119 <span class="comment">    This function is called by the client side DLL to connect with its</span>
00120 <span class="comment">    server side DLL.</span>
00121 <span class="comment"></span>
00122 <span class="comment">Arguments:</span>
00123 <span class="comment"></span>
00124 <span class="comment">    ObjectDirectory - Points to a null terminate string that is the same</span>
00125 <span class="comment">        as the value of the ObjectDirectory= argument passed to the CSRSS</span>
00126 <span class="comment">        program.</span>
00127 <span class="comment"></span>
00128 <span class="comment">    ServerDllIndex - Index of the server DLL that is being connected to.</span>
00129 <span class="comment">        It should match one of the ServerDll= arguments passed to the CSRSS</span>
00130 <span class="comment">        program.</span>
00131 <span class="comment"></span>
00132 <span class="comment">    CallbackInformation - An optional pointer to a structure that contains</span>
00133 <span class="comment">        a pointer to the client callback function dispatch table.</span>
00134 <span class="comment"></span>
00135 <span class="comment">    ConnectionInformation - An optional pointer to uninterpreted data.</span>
00136 <span class="comment">        This data is intended for clients to pass package, version and</span>
00137 <span class="comment">        protocol identification information to the server to allow the</span>
00138 <span class="comment">        server to determine if it can satisify the client before</span>
00139 <span class="comment">        accepting the connection.  Upon return to the client, the</span>
00140 <span class="comment">        ConnectionInformation data block contains any information passed</span>
00141 <span class="comment">        back from the server DLL by its call to the</span>
00142 <span class="comment">        CsrCompleteConnection call.  The output data overwrites the</span>
00143 <span class="comment">        input data.</span>
00144 <span class="comment"></span>
00145 <span class="comment">    ConnectionInformationLength - Pointer to the length of the</span>
00146 <span class="comment">        ConnectionInformation data block.  The output value is the</span>
00147 <span class="comment">        length of the data stored in the ConnectionInformation data</span>
00148 <span class="comment">        block by the server's call to the NtCompleteConnectPort</span>
00149 <span class="comment">        service.  This parameter is OPTIONAL only if the</span>
00150 <span class="comment">        ConnectionInformation parameter is NULL, otherwise it is</span>
00151 <span class="comment">        required.</span>
00152 <span class="comment"></span>
00153 <span class="comment">    CalledFromServer - On output, TRUE if the dll has been called from</span>
00154 <span class="comment">        a server process.</span>
00155 <span class="comment"></span>
00156 <span class="comment">Return Value:</span>
00157 <span class="comment"></span>
00158 <span class="comment">    Status value.</span>
00159 <span class="comment"></span>
00160 <span class="comment">--*/</span>
00161 
00162 {
00163     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00164     CSR_API_MSG m;
00165     PCSR_CLIENTCONNECT_MSG a = &amp;m.u.ClientConnect;
00166     PCSR_CAPTURE_HEADER CaptureBuffer;
00167     HANDLE CsrServerModuleHandle;
00168     STRING ProcedureName;
00169     ANSI_STRING DllName;
00170     UNICODE_STRING DllName_U;
00171     PIMAGE_NT_HEADERS NtHeaders;
00172 
00173     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformation ) &amp;&amp;
00174         (!ARGUMENT_PRESENT( ConnectionInformationLength ) ||
00175           *ConnectionInformationLength == 0
00176         )
00177        ) {
00178         <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00179         }
00180 
00181     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/csrdll_8h.html#a8">CsrInitOnceDone</a>) {
00182         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/csrinit_8c.html#a1">CsrOneTimeInitialize</a>();
00183         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00184             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00185             }
00186         }
00187 
00188     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( CallbackInformation )) {
00189         <a class="code" href="../../d9/d9/csrdll_8h.html#a21">CsrLoadedClientDll</a>[ ServerDllIndex ] = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( <a class="code" href="../../d9/d9/csrdll_8h.html#a13">CsrHeap</a>, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a12">CSR_TAG</a> ), <span class="keyword">sizeof</span>(CSR_CALLBACK_INFO) );
00190         <span class="keywordflow">if</span> ( !<a class="code" href="../../d9/d9/csrdll_8h.html#a21">CsrLoadedClientDll</a>[ ServerDllIndex ] ) {
00191             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00192             }
00193         <a class="code" href="../../d9/d9/csrdll_8h.html#a21">CsrLoadedClientDll</a>[ ServerDllIndex ]-&gt;ApiNumberBase =
00194                 CallbackInformation-&gt;ApiNumberBase;
00195         <a class="code" href="../../d9/d9/csrdll_8h.html#a21">CsrLoadedClientDll</a>[ ServerDllIndex ]-&gt;MaxApiNumber =
00196                 CallbackInformation-&gt;MaxApiNumber;
00197         <a class="code" href="../../d9/d9/csrdll_8h.html#a21">CsrLoadedClientDll</a>[ ServerDllIndex ]-&gt;CallbackDispatchTable =
00198                 CallbackInformation-&gt;CallbackDispatchTable;
00199     }
00200 
00201     <span class="comment">//</span>
00202     <span class="comment">// if we are being called by a server process, skip lpc port initialization</span>
00203     <span class="comment">// and call to server connect routine and just initialize heap.  the</span>
00204     <span class="comment">// dll initialization routine will do any necessary initialization.  this</span>
00205     <span class="comment">// stuff only needs to be done for the first connect.</span>
00206     <span class="comment">//</span>
00207 
00208     <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d9/csrdll_8h.html#a9">CsrServerProcess</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) {
00209         *CalledFromServer = <a class="code" href="../../d9/d9/csrdll_8h.html#a9">CsrServerProcess</a>;
00210         <span class="keywordflow">return</span> STATUS_SUCCESS;
00211         }
00212 
00213     <span class="comment">//</span>
00214     <span class="comment">// If the image is an NT Native image, we are running in the</span>
00215     <span class="comment">// context of the server.</span>
00216     <span class="comment">//</span>
00217 
00218     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(NtCurrentPeb()-&gt;ImageBaseAddress);
00219     <a class="code" href="../../d9/d9/csrdll_8h.html#a9">CsrServerProcess</a> =
00220         (NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_NATIVE) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00221 
00222     <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d9/csrdll_8h.html#a9">CsrServerProcess</a> ) {
00223         <span class="keyword">extern</span> PVOID <a class="code" href="../../d8/d2/ldrinit_8c.html#a5">NtDllBase</a>;
00224         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;DllName, <span class="stringliteral">"csrsrv"</span> );
00225         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;DllName_U, &amp;DllName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00226         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00227 
00228         <a class="code" href="../../d4/d2/ldrapi_8c.html#a5">LdrDisableThreadCalloutsForDll</a>(<a class="code" href="../../d8/d2/ldrinit_8c.html#a5">NtDllBase</a>);
00229 
00230         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d2/ldrapi_8c.html#a4">LdrGetDllHandle</a>(
00231                         UNICODE_NULL,
00232                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00233                         &amp;DllName_U,
00234                     (PVOID *)&amp;CsrServerModuleHandle
00235                     );
00236 
00237         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;DllName_U);
00238 
00239         <a class="code" href="../../d9/d9/csrdll_8h.html#a9">CsrServerProcess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00240 
00241         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>(&amp;ProcedureName,<span class="stringliteral">"CsrCallServerFromServer"</span>);
00242         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d2/ldrapi_8c.html#a7">LdrGetProcedureAddress</a>(
00243                         CsrServerModuleHandle,
00244                         &amp;ProcedureName,
00245                         0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00246                         (PVOID *)&amp;<a class="code" href="../../d9/d9/csrdll_8h.html#a10">CsrServerApiRoutine</a>
00247                         );
00248         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00249 
00250         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d9/d9/csrdll_8h.html#a16">CsrPortHeap</a>==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00251         <a class="code" href="../../d9/d9/csrdll_8h.html#a16">CsrPortHeap</a> = RtlProcessHeap();
00252 
00253         <a class="code" href="../../d9/d9/csrdll_8h.html#a18">CsrPortBaseTag</a> = <a class="code" href="../../d5/d9/heapdll_8c.html#a28">RtlCreateTagHeap</a>( <a class="code" href="../../d9/d9/csrdll_8h.html#a16">CsrPortHeap</a>,
00254                                            0,
00255                                            <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CSRPORT!"</span>,
00256                                            <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CAPTURE\0"</span>
00257                                          );
00258 
00259         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CalledFromServer)) {
00260             *CalledFromServer = <a class="code" href="../../d9/d9/csrdll_8h.html#a9">CsrServerProcess</a>;
00261             }
00262         <span class="keywordflow">return</span> STATUS_SUCCESS;
00263         }
00264 
00265     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ConnectionInformation) ) {
00266         <a class="code" href="../../d9/d9/csrdll_8h.html#a9">CsrServerProcess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00267         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/csrdll_8h.html#a15">CsrPortHandle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00268             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/csrinit_8c.html#a4">CsrpConnectToServer</a>( ObjectDirectory );
00269             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00270                 <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00271                 }
00272             }
00273 
00274         a-&gt;ServerDllIndex = ServerDllIndex;
00275         a-&gt;ConnectionInformationLength = *ConnectionInformationLength;
00276         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformation )) {
00277             CaptureBuffer = <a class="code" href="../../d8/d9/wow64csr_8c.html#a5">CsrAllocateCaptureBuffer</a>( 1,
00278                                                       a-&gt;ConnectionInformationLength
00279                                                     );
00280             <span class="keywordflow">if</span> (CaptureBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00281                 <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
00282                 }
00283 
00284             <a class="code" href="../../d8/d9/wow64csr_8c.html#a7">CsrAllocateMessagePointer</a>( CaptureBuffer,
00285                                        a-&gt;ConnectionInformationLength,
00286                                        (PVOID *)&amp;a-&gt;ConnectionInformation
00287                                      );
00288             RtlMoveMemory( a-&gt;ConnectionInformation,
00289                            ConnectionInformation,
00290                            a-&gt;ConnectionInformationLength
00291                          );
00292 
00293             *ConnectionInformationLength = a-&gt;ConnectionInformationLength;
00294             }
00295         <span class="keywordflow">else</span> {
00296             CaptureBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00297             }
00298 
00299         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( &amp;m,
00300                                       CaptureBuffer,
00301                                       CSR_MAKE_API_NUMBER( CSRSRV_SERVERDLL_INDEX,
00302                                                            CsrpClientConnect
00303                                                          ),
00304                                       <span class="keyword">sizeof</span>( *a )
00305                                     );
00306 
00307         <span class="keywordflow">if</span> (CaptureBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00308             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformation )) {
00309                 RtlMoveMemory( ConnectionInformation,
00310                                a-&gt;ConnectionInformation,
00311                                *ConnectionInformationLength
00312                              );
00313                 }
00314 
00315             <a class="code" href="../../d8/d9/wow64csr_8c.html#a6">CsrFreeCaptureBuffer</a>( CaptureBuffer );
00316             }
00317         }
00318     <span class="keywordflow">else</span> {
00319         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00320         }
00321 
00322     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CalledFromServer)) {
00323         *CalledFromServer = <a class="code" href="../../d9/d9/csrdll_8h.html#a9">CsrServerProcess</a>;
00324         }
00325     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00326 }
00327 
00328 BOOLEAN
<a name="l00329"></a><a class="code" href="../../d1/d0/csrinit_8c.html#a3">00329</a> <a class="code" href="../../d1/d0/csrinit_8c.html#a3">xProtectHandle</a>(
00330     HANDLE hObject
00331     )
00332 {
00333     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00334     OBJECT_HANDLE_FLAG_INFORMATION HandleInfo;
00335 
00336     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a5">NtQueryObject</a>( hObject,
00337                             ObjectHandleFlagInformation,
00338                             &amp;HandleInfo,
00339                             <span class="keyword">sizeof</span>( HandleInfo ),
00340                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00341                           );
00342     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00343         HandleInfo.ProtectFromClose = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00344 
00345         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a6">NtSetInformationObject</a>( hObject,
00346                                          ObjectHandleFlagInformation,
00347                                          &amp;HandleInfo,
00348                                          <span class="keyword">sizeof</span>( HandleInfo )
00349                                        );
00350         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00351             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00352             }
00353         }
00354 
00355     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00356 }
00357 
00358 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00359"></a><a class="code" href="../../d1/d0/csrinit_8c.html#a4">00359</a> <a class="code" href="../../d1/d0/csrinit_8c.html#a4">CsrpConnectToServer</a>(
00360     IN PWSTR ObjectDirectory
00361     )
00362 {
00363     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00364     REMOTE_PORT_VIEW ServerView;
00365     ULONG MaxMessageLength;
00366     ULONG ConnectionInformationLength;
00367     CSR_API_CONNECTINFO ConnectionInformation;
00368     SECURITY_QUALITY_OF_SERVICE <a class="code" href="../../d3/d9/ulpc_8h.html#a4">DynamicQos</a>;
00369     HANDLE PortSection;
00370     PORT_VIEW ClientView;
00371     ULONG <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00372     LARGE_INTEGER SectionSize;
00373     SID_IDENTIFIER_AUTHORITY NtAuthority = SECURITY_NT_AUTHORITY;
00374     PSID SystemSid;
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">// Create the port name string by combining the passed in object directory</span>
00378     <span class="comment">// name with the port name.</span>
00379     <span class="comment">//</span>
00380 
00381     <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = ((wcslen( ObjectDirectory ) + 1) * <span class="keyword">sizeof</span>( WCHAR )) +
00382         <span class="keyword">sizeof</span>( CSR_API_PORT_NAME );
00383     <a class="code" href="../../d9/d9/csrdll_8h.html#a14">CsrPortName</a>.Length = 0;
00384     <a class="code" href="../../d9/d9/csrdll_8h.html#a14">CsrPortName</a>.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00385     <a class="code" href="../../d9/d9/csrdll_8h.html#a14">CsrPortName</a>.Buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( <a class="code" href="../../d9/d9/csrdll_8h.html#a13">CsrHeap</a>, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a12">CSR_TAG</a> ), <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> );
00386     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/csrdll_8h.html#a14">CsrPortName</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00387         <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
00388         }
00389     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;<a class="code" href="../../d9/d9/csrdll_8h.html#a14">CsrPortName</a>, ObjectDirectory );
00390     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;<a class="code" href="../../d9/d9/csrdll_8h.html#a14">CsrPortName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span> );
00391     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;<a class="code" href="../../d9/d9/csrdll_8h.html#a14">CsrPortName</a>, CSR_API_PORT_NAME );
00392 
00393     <span class="comment">//</span>
00394     <span class="comment">// Set up the security quality of service parameters to use over the</span>
00395     <span class="comment">// port.  Use the most efficient (least overhead) - which is dynamic</span>
00396     <span class="comment">// rather than static tracking.</span>
00397     <span class="comment">//</span>
00398 
00399     <a class="code" href="../../d3/d9/ulpc_8h.html#a4">DynamicQos</a>.ImpersonationLevel = SecurityImpersonation;
00400     <a class="code" href="../../d3/d9/ulpc_8h.html#a4">DynamicQos</a>.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
00401     <a class="code" href="../../d3/d9/ulpc_8h.html#a4">DynamicQos</a>.EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00402 
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// Create a section to contain the Port Memory.  Port Memory is private</span>
00406     <span class="comment">// memory that is shared between the client and server processes.</span>
00407     <span class="comment">// This allows data that is too large to fit into an API request message</span>
00408     <span class="comment">// to be passed to the server.</span>
00409     <span class="comment">//</span>
00410 
00411     SectionSize.LowPart = <a class="code" href="../../d9/d9/csrdll_8h.html#a2">CSR_PORT_MEMORY_SIZE</a>;
00412     SectionSize.HighPart = 0;
00413 
00414     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a19">NtCreateSection</a>( &amp;PortSection,
00415                               SECTION_ALL_ACCESS,
00416                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00417                               &amp;SectionSize,
00418                               PAGE_READWRITE,
00419                               SEC_RESERVE,
00420                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00421                             );
00422     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00423         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00424         }
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// Connect to the server.  This includes a description of the Port Memory</span>
00428     <span class="comment">// section so that the LPC connection logic can make the section visible</span>
00429     <span class="comment">// to both the client and server processes.  Also pass information the</span>
00430     <span class="comment">// server needs in the connection information structure.</span>
00431     <span class="comment">//</span>
00432 
00433     ClientView.Length = <span class="keyword">sizeof</span>( ClientView );
00434     ClientView.SectionHandle = PortSection;
00435     ClientView.SectionOffset = 0;
00436     ClientView.ViewSize = SectionSize.LowPart;
00437     ClientView.ViewBase = 0;
00438     ClientView.ViewRemoteBase = 0;
00439 
00440     ServerView.Length = <span class="keyword">sizeof</span>( ServerView );
00441     ServerView.ViewSize = 0;
00442     ServerView.ViewBase = 0;
00443 
00444     ConnectionInformationLength = <span class="keyword">sizeof</span>( ConnectionInformation );
00445     ConnectionInformation.ExpectedVersion = CSR_VERSION;
00446 
00447     SystemSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00448     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a39">RtlAllocateAndInitializeSid</a>( &amp;NtAuthority,
00449                                           1,
00450                                           SECURITY_LOCAL_SYSTEM_RID,
00451                                           0, 0, 0, 0, 0, 0, 0,
00452                                           &amp;SystemSid
00453                                         );
00454     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d6/lpcconn_8c.html#a2">NtSecureConnectPort</a>( &amp;<a class="code" href="../../d9/d9/csrdll_8h.html#a15">CsrPortHandle</a>,
00455                           &amp;<a class="code" href="../../d9/d9/csrdll_8h.html#a14">CsrPortName</a>,
00456                           &amp;<a class="code" href="../../d3/d9/ulpc_8h.html#a4">DynamicQos</a>,
00457                           &amp;ClientView,
00458                           SystemSid,
00459                           &amp;ServerView,
00460                           (PULONG)&amp;MaxMessageLength,
00461                           (PVOID)&amp;ConnectionInformation,
00462                           (PULONG)&amp;ConnectionInformationLength
00463                         );
00464     <a class="code" href="../../d8/d6/sertl_8c.html#a41">RtlFreeSid</a>( SystemSid );
00465     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( PortSection );
00466     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00467         <a class="code" href="../../d0/d9/ntosdef_8h.html#a9">IF_DEBUG</a> {
00468             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"CSRDLL: Unable to connect to %wZ Server - Status == %X\n"</span>,
00469                       &amp;<a class="code" href="../../d9/d9/csrdll_8h.html#a14">CsrPortName</a>,
00470                       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
00471                     );
00472             }
00473 
00474         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00475         }
00476     <a class="code" href="../../d1/d0/csrinit_8c.html#a3">xProtectHandle</a>(<a class="code" href="../../d9/d9/csrdll_8h.html#a15">CsrPortHandle</a>);
00477 
00478     NtCurrentPeb()-&gt;ReadOnlySharedMemoryBase = ConnectionInformation.SharedSectionBase;
00479     NtCurrentPeb()-&gt;ReadOnlySharedMemoryHeap = ConnectionInformation.SharedSectionHeap;
00480     NtCurrentPeb()-&gt;ReadOnlyStaticServerData = (PVOID *)ConnectionInformation.SharedStaticServerData;
00481 
00482 <span class="preprocessor">#if DBG</span>
00483 <span class="preprocessor"></span>    CsrDebug = ConnectionInformation.DebugFlags;
00484 <span class="preprocessor">#endif</span>
00485 <span class="preprocessor"></span>    <a class="code" href="../../d9/d9/csrdll_8h.html#a20">CsrObjectDirectory</a> = ConnectionInformation.ObjectDirectory;
00486 
00487     <a class="code" href="../../d9/d9/csrdll_8h.html#a17">CsrPortMemoryRemoteDelta</a> = (ULONG_PTR)ClientView.ViewRemoteBase -
00488                                (ULONG_PTR)ClientView.ViewBase;
00489 
00490     <a class="code" href="../../d9/d9/csrdll_8h.html#a0">IF_CSR_DEBUG</a>( LPC ) {
00491         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"CSRDLL: ClientView: Base=%p  RemoteBase=%p  Delta: %lX  Size=%lX\n"</span>,
00492                   ClientView.ViewBase,
00493                   ClientView.ViewRemoteBase,
00494                   <a class="code" href="../../d9/d9/csrdll_8h.html#a17">CsrPortMemoryRemoteDelta</a>,
00495                   (ULONG)ClientView.ViewSize
00496                 );
00497         }
00498 
00499     <span class="comment">//</span>
00500     <span class="comment">// Create a sparse heap in the share memory section.  Initially</span>
00501     <span class="comment">// commit just one page.</span>
00502     <span class="comment">//</span>
00503 
00504     <a class="code" href="../../d9/d9/csrdll_8h.html#a16">CsrPortHeap</a> = <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a15">RtlCreateHeap</a>( HEAP_CLASS_8,                      <span class="comment">// Flags</span>
00505                                  ClientView.ViewBase,               <span class="comment">// HeapBase</span>
00506                                  ClientView.ViewSize,               <span class="comment">// ReserveSize</span>
00507                                  <a class="code" href="../../d9/d9/csrdll_8h.html#a11">CsrNtSysInfo</a>.PageSize,             <span class="comment">// CommitSize</span>
00508                                  0,                                 <span class="comment">// Reserved</span>
00509                                  0                                  <span class="comment">// GrowthThreshold</span>
00510                                );
00511     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/csrdll_8h.html#a16">CsrPortHeap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00512         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d9/d9/csrdll_8h.html#a15">CsrPortHandle</a> );
00513         <a class="code" href="../../d9/d9/csrdll_8h.html#a15">CsrPortHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00514 
00515         <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
00516         }
00517 
00518     <a class="code" href="../../d9/d9/csrdll_8h.html#a18">CsrPortBaseTag</a> = <a class="code" href="../../d5/d9/heapdll_8c.html#a28">RtlCreateTagHeap</a>( <a class="code" href="../../d9/d9/csrdll_8h.html#a16">CsrPortHeap</a>,
00519                                        0,
00520                                        <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CSRPORT!"</span>,
00521                                        <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"!CSRPORT\0"</span>
00522                                        <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CAPTURE\0"</span>
00523                                      );
00524 
00525     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00526 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:36 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
