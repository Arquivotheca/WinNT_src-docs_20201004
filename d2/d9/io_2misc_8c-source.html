<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: misc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>misc.c</h1><a href="../../d1/d0/io_2misc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    misc.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the code to implement the NtFlushBuffersFile,</span>
00012 <span class="comment">    NtSetNewSizeFile, IoQueueWorkItem, and NtCancelIoFile system services</span>
00013 <span class="comment">    for the NT I/O system.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Darryl E. Havens (darrylh) 22-Jun-1989</span>
00018 <span class="comment"></span>
00019 <span class="comment">Environment:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Kernel mode only</span>
00022 <span class="comment"></span>
00023 <span class="comment">Revision History:</span>
00024 <span class="comment"></span>
00025 <span class="comment"></span>
00026 <span class="comment">--*/</span>
00027 
00028 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00029 
00030 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtCancelIoFile)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtDeleteFile)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtFlushBuffersFile)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtQueryAttributesFile)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtQueryFullAttributesFile)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00037 <span class="preprocessor"></span>
00038 <span class="comment">//</span>
00039 <span class="comment">// Local function prototypes follow</span>
00040 <span class="comment">//</span>
00041 
00042 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00043 <a class="code" href="../../d1/d0/io_2misc_8c.html#a0">IopProcessWorkItem</a>(
00044     IN PVOID Parameter
00045     );
00046 
00047 
00048 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00049"></a><a class="code" href="../../d1/d0/io_2misc_8c.html#a1">00049</a> <a class="code" href="../../d1/d0/io_2misc_8c.html#a1">NtCancelIoFile</a>(
00050     IN HANDLE FileHandle,
00051     OUT PIO_STATUS_BLOCK IoStatusBlock
00052     )
00053 
00054 <span class="comment">/*++</span>
00055 <span class="comment"></span>
00056 <span class="comment">Routine Description:</span>
00057 <span class="comment"></span>
00058 <span class="comment">    This service causes all pending I/O operations for the specified file to be</span>
00059 <span class="comment">    marked as canceled.  Most types of operations can be canceled immediately,</span>
00060 <span class="comment">    while others may continue toward completion before they are actually</span>
00061 <span class="comment">    canceled and the caller is notified.</span>
00062 <span class="comment"></span>
00063 <span class="comment">    Only those pending operations that were issued by the current thread using</span>
00064 <span class="comment">    the specified handle are canceled.  Any operations issued for the file by</span>
00065 <span class="comment">    any other thread or any other process continues normally.</span>
00066 <span class="comment"></span>
00067 <span class="comment">Arguments:</span>
00068 <span class="comment"></span>
00069 <span class="comment">    FileHandle - Supplies a handle to the file whose operations are to be</span>
00070 <span class="comment">        canceled.</span>
00071 <span class="comment"></span>
00072 <span class="comment">    IoStatusBlock - Address of the caller's I/O status block.</span>
00073 <span class="comment"></span>
00074 <span class="comment">Return Value:</span>
00075 <span class="comment"></span>
00076 <span class="comment">    The status returned is the final completion status of the operation.</span>
00077 <span class="comment"></span>
00078 <span class="comment">--*/</span>
00079 
00080 {
00081     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00082     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00083     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00084     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
00085     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> thread;
00086     BOOLEAN found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00087     PLIST_ENTRY header;
00088     PLIST_ENTRY entry;
00089     KIRQL irql;
00090 
00091     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00092 
00093     <span class="comment">//</span>
00094     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00095     <span class="comment">//</span>
00096 
00097     requestorMode = KeGetPreviousMode();
00098 
00099     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00100 
00101         <span class="comment">//</span>
00102         <span class="comment">// The caller's access mode is user, so probe each of the arguments</span>
00103         <span class="comment">// and capture them as necessary.  If any failures occur, the condition</span>
00104         <span class="comment">// handler will be invoked to handle them.  It will simply cleanup and</span>
00105         <span class="comment">// return an access violation status code back to the system service</span>
00106         <span class="comment">// dispatcher.</span>
00107         <span class="comment">//</span>
00108 
00109         <span class="keywordflow">try</span> {
00110 
00111             <span class="comment">//</span>
00112             <span class="comment">// The IoStatusBlock parameter must be writeable by the caller.</span>
00113             <span class="comment">//</span>
00114 
00115             <a class="code" href="../../d5/d8/ex_8h.html#a31">ProbeForWriteIoStatus</a>( IoStatusBlock );
00116 
00117         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00118 
00119             <span class="comment">//</span>
00120             <span class="comment">// An exception was incurred attempting to probe the caller'</span>
00121             <span class="comment">// I/O status block.  Simply return an appropriate error status</span>
00122             <span class="comment">// code.</span>
00123             <span class="comment">//</span>
00124 
00125             <span class="keywordflow">return</span> GetExceptionCode();
00126         }
00127     }
00128 
00129     <span class="comment">//</span>
00130     <span class="comment">// There were no blatant errors so far, so reference the file object so</span>
00131     <span class="comment">// the target device object can be found.  Note that if the handle does</span>
00132     <span class="comment">// not refer to a file object, or if the caller does not have the required</span>
00133     <span class="comment">// access to the file, then it will fail.</span>
00134     <span class="comment">//</span>
00135 
00136     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
00137                                         0,
00138                                         <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>,
00139                                         requestorMode,
00140                                         (PVOID *) &amp;fileObject,
00141                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00142     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00143         <span class="keywordflow">return</span>(status);
00144     }
00145 
00146     <span class="comment">//</span>
00147     <span class="comment">// Note that here the I/O system would normally make a check to determine</span>
00148     <span class="comment">// whether or not the file was opened for synchronous I/O.  If it was, then</span>
00149     <span class="comment">// it would attempt to exclusively acquire the file object lock.  However,</span>
00150     <span class="comment">// since this service is attempting to cancel all of the I/O for the file,</span>
00151     <span class="comment">// it does not make much sense to wait until it has all completed before</span>
00152     <span class="comment">// attempting to cancel it.</span>
00153     <span class="comment">//</span>
00154 
00155     <span class="comment">//</span>
00156     <span class="comment">// Get the address of the current thread.  The thread contains a list of</span>
00157     <span class="comment">// the pending operations for this file.</span>
00158     <span class="comment">//</span>
00159 
00160     thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">// Update the operation count statistic for the current process for</span>
00164     <span class="comment">// operations other than read and write.</span>
00165     <span class="comment">//</span>
00166 
00167     <a class="code" href="../../d4/d6/iosubs_8c.html#a129">IopUpdateOtherOperationCount</a>();
00168 
00169     <span class="comment">//</span>
00170     <span class="comment">// Walk the list of IRPs on the thread's pending I/O queue looking for IRPs</span>
00171     <span class="comment">// which specify the same file as the FileHandle refers to.  For each IRP</span>
00172     <span class="comment">// found, set its cancel flag.  If no IRPs are found, simply complete the</span>
00173     <span class="comment">// I/O here.  The only synchronization needed here is to block out all APCs</span>
00174     <span class="comment">// for this thread so that no I/O can complete and remove packets from the</span>
00175     <span class="comment">// queue.  No considerations need be made for multi-processing since this</span>
00176     <span class="comment">// thread can only be running on one processor at a time and this routine</span>
00177     <span class="comment">// has control of the thread for now.</span>
00178     <span class="comment">//</span>
00179 
00180     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;irql );
00181 
00182     header = &amp;thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o18">IrpList</a>;
00183     entry = thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o18">IrpList</a>.Flink;
00184 
00185     <span class="keywordflow">while</span> (header != entry) {
00186 
00187         <span class="comment">//</span>
00188         <span class="comment">// An IRP has been found for this thread.  If the IRP refers to the</span>
00189         <span class="comment">// appropriate file object, set its cancel flag and remember that it</span>
00190         <span class="comment">// was found;  otherwise, simply continue the loop.</span>
00191         <span class="comment">//</span>
00192 
00193         irp = CONTAINING_RECORD( entry, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, ThreadListEntry );
00194         <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject == fileObject) {
00195             found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00196             <a class="code" href="../../d4/d6/iosubs_8c.html#a30">IoCancelIrp</a>( irp );
00197         }
00198 
00199         entry = entry-&gt;Flink;
00200     }
00201 
00202     <span class="comment">//</span>
00203     <span class="comment">// Lower the IRQL back down to what it was on entry to this procedure.</span>
00204     <span class="comment">//</span>
00205 
00206     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
00207 
00208     <span class="keywordflow">if</span> (found) {
00209 
00210         LARGE_INTEGER interval;
00211 
00212         <span class="comment">//</span>
00213         <span class="comment">// Delay execution for a time and let the request</span>
00214         <span class="comment">// finish.  The delay time is 10ms.</span>
00215         <span class="comment">//</span>
00216 
00217         interval.QuadPart = -10 * 1000 * 10;
00218 
00219         <span class="comment">//</span>
00220         <span class="comment">// Wait for a while so the canceled requests can complete.</span>
00221         <span class="comment">//</span>
00222 
00223         <span class="keywordflow">while</span> (found) {
00224 
00225             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;interval );
00226 
00227             found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00228 
00229             <span class="comment">//</span>
00230             <span class="comment">// Raise the IRQL to prevent modification to the IRP list by the</span>
00231             <span class="comment">// thread's APC routine.</span>
00232             <span class="comment">//</span>
00233 
00234             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;irql );
00235 
00236             <span class="comment">//</span>
00237             <span class="comment">// Check the IRP list for requests which refer to the specified</span>
00238             <span class="comment">// file object.</span>
00239             <span class="comment">//</span>
00240 
00241             entry = thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o18">IrpList</a>.Flink;
00242 
00243             <span class="keywordflow">while</span> (header != entry) {
00244 
00245                 <span class="comment">//</span>
00246                 <span class="comment">// An IRP has been found for this thread.  If the IRP refers</span>
00247                 <span class="comment">// to the appropriate file object,  remember that it</span>
00248                 <span class="comment">// was found;  otherwise, simply continue the loop.</span>
00249                 <span class="comment">//</span>
00250 
00251                 irp = CONTAINING_RECORD( entry, <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>, ThreadListEntry );
00252                 <span class="keywordflow">if</span> (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject == fileObject) {
00253                     found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00254                     <span class="keywordflow">break</span>;
00255                 }
00256 
00257                 entry = entry-&gt;Flink;
00258             }
00259 
00260             <span class="comment">//</span>
00261             <span class="comment">// Lower the IRQL back down to what it was on entry to this procedure.</span>
00262             <span class="comment">//</span>
00263 
00264             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
00265 
00266         }
00267     }
00268 
00269     <span class="keywordflow">try</span> {
00270 
00271         <span class="comment">//</span>
00272         <span class="comment">// Write the status back to the user.</span>
00273         <span class="comment">//</span>
00274 
00275         IoStatusBlock-&gt;Status = STATUS_SUCCESS;
00276         IoStatusBlock-&gt;Information = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00277 
00278     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00279 
00280         <span class="comment">//</span>
00281         <span class="comment">// An exception was incurred attempting to write the caller's</span>
00282         <span class="comment">// I/O status block; however, the service completed sucessfully so</span>
00283         <span class="comment">// just return sucess.</span>
00284         <span class="comment">//</span>
00285 
00286     }
00287 
00288     <span class="comment">//</span>
00289     <span class="comment">// Dereference the file object.</span>
00290     <span class="comment">//</span>
00291 
00292     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00293 
00294     <span class="keywordflow">return</span> STATUS_SUCCESS;
00295 }
00296 
00297 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00298"></a><a class="code" href="../../d1/d0/io_2misc_8c.html#a2">00298</a> <a class="code" href="../../d1/d0/io_2misc_8c.html#a2">NtDeleteFile</a>(
00299     IN POBJECT_ATTRIBUTES ObjectAttributes
00300     )
00301 
00302 <span class="comment">/*++</span>
00303 <span class="comment"></span>
00304 <span class="comment">Routine Description:</span>
00305 <span class="comment"></span>
00306 <span class="comment">    This service deletes the specified file.</span>
00307 <span class="comment"></span>
00308 <span class="comment">Arguments:</span>
00309 <span class="comment"></span>
00310 <span class="comment">    ObjectAttributes - Supplies the attributes to be used for file object (name,</span>
00311 <span class="comment">        SECURITY_DESCRIPTOR, etc.)</span>
00312 <span class="comment"></span>
00313 <span class="comment">Return Value:</span>
00314 <span class="comment"></span>
00315 <span class="comment">    The status returned is the final completion status of the operation.</span>
00316 <span class="comment"></span>
00317 <span class="comment">--*/</span>
00318 
00319 {
00320     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
00321     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00322     <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">OPEN_PACKET</a> openPacket;
00323     <a class="code" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html">DUMMY_FILE_OBJECT</a> localFileObject;
00324     HANDLE handle;
00325 
00326     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00327 
00328     <span class="comment">//</span>
00329     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00330     <span class="comment">//</span>
00331 
00332     requestorMode = KeGetPreviousMode();
00333 
00334     <span class="comment">//</span>
00335     <span class="comment">// Build a parse open packet that tells the parse method to open the file</span>
00336     <span class="comment">// for open for delete access w/the delete bit set, and then close it.</span>
00337     <span class="comment">//</span>
00338 
00339     RtlZeroMemory( &amp;openPacket, <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">OPEN_PACKET</a> ) );
00340 
00341     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o0">Type</a> = <a class="code" href="../../d0/d5/io_8h.html#a7">IO_TYPE_OPEN_PACKET</a>;
00342     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o1">Size</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d6/iop_8h.html#a55">OPEN_PACKET</a> );
00343     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o8">CreateOptions</a> = FILE_DELETE_ON_CLOSE;
00344     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o10">ShareAccess</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE;
00345     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o14">Disposition</a> = FILE_OPEN;
00346     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o21">DeleteOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00347     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o23">LocalFileObject</a> = &amp;localFileObject;
00348 
00349     <span class="comment">//</span>
00350     <span class="comment">// Update the open count for this process.</span>
00351     <span class="comment">//</span>
00352 
00353     <a class="code" href="../../d4/d6/iosubs_8c.html#a129">IopUpdateOtherOperationCount</a>();
00354 
00355     <span class="comment">//</span>
00356     <span class="comment">// Open the object by its name.  Because of the special DeleteOnly flag</span>
00357     <span class="comment">// set in the open packet, the parse routine will open the file, and</span>
00358     <span class="comment">// then realize that it is only deleting the file, and will therefore</span>
00359     <span class="comment">// immediately dereference the file.  This will cause the cleanup and</span>
00360     <span class="comment">// the close to be sent to the file system, thus causing the file to</span>
00361     <span class="comment">// be deleted.</span>
00362     <span class="comment">//</span>
00363 
00364     status = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00365                                  (<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00366                                  requestorMode,
00367                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00368                                  DELETE,
00369                                  &amp;openPacket,
00370                                  &amp;handle );
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">// The operation is successful if the parse check field of the open packet</span>
00374     <span class="comment">// indicates that the parse routine was actually invoked, and the final</span>
00375     <span class="comment">// status field of the packet is set to success.</span>
00376     <span class="comment">//</span>
00377 
00378     <span class="keywordflow">if</span> (openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o5">ParseCheck</a> != <a class="code" href="../../d0/d6/iop_8h.html#a3">OPEN_PACKET_PATTERN</a>) {
00379         <span class="keywordflow">return</span> status;
00380     } <span class="keywordflow">else</span> {
00381         <span class="keywordflow">return</span> openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o3">FinalStatus</a>;
00382     }
00383 }
00384 
00385 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00386"></a><a class="code" href="../../d1/d0/io_2misc_8c.html#a3">00386</a> <a class="code" href="../../d1/d0/io_2misc_8c.html#a3">NtFlushBuffersFile</a>(
00387     IN HANDLE FileHandle,
00388     OUT PIO_STATUS_BLOCK IoStatusBlock
00389     )
00390 
00391 <span class="comment">/*++</span>
00392 <span class="comment"></span>
00393 <span class="comment">Routine Description:</span>
00394 <span class="comment"></span>
00395 <span class="comment">    This service causes all buffered data to the file to be written.</span>
00396 <span class="comment"></span>
00397 <span class="comment">Arguments:</span>
00398 <span class="comment"></span>
00399 <span class="comment">    FileHandle - Supplies a handle to the file whose buffers should be flushed.</span>
00400 <span class="comment"></span>
00401 <span class="comment">    IoStatusBlock - Address of the caller's I/O status block.</span>
00402 <span class="comment"></span>
00403 <span class="comment">Return Value:</span>
00404 <span class="comment"></span>
00405 <span class="comment">    The status returned is the final completion status of the operation.</span>
00406 <span class="comment"></span>
00407 <span class="comment">--*/</span>
00408 
00409 {
00410     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00411     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00412     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00413     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00414     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> event;
00415     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
00416     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00417     IO_STATUS_BLOCK localIoStatus;
00418     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> objectHandleInformation;
00419     BOOLEAN synchronousIo;
00420 
00421     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00422 
00423     <span class="comment">//</span>
00424     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00425     <span class="comment">//</span>
00426 
00427     requestorMode = KeGetPreviousMode();
00428 
00429     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00430 
00431         <span class="comment">//</span>
00432         <span class="comment">// The caller's access mode is not kernel so probe each of the arguments</span>
00433         <span class="comment">// and capture them as necessary.  If any failures occur, the condition</span>
00434         <span class="comment">// handler will be invoked to handle them.  It will simply cleanup and</span>
00435         <span class="comment">// return an access violation status code back to the system service</span>
00436         <span class="comment">// dispatcher.</span>
00437         <span class="comment">//</span>
00438 
00439         <span class="keywordflow">try</span> {
00440 
00441             <span class="comment">//</span>
00442             <span class="comment">// The IoStatusBlock parameter must be writeable by the caller.</span>
00443             <span class="comment">//</span>
00444 
00445             <a class="code" href="../../d5/d8/ex_8h.html#a31">ProbeForWriteIoStatus</a>( IoStatusBlock );
00446 
00447         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00448 
00449             <span class="comment">//</span>
00450             <span class="comment">// An exception was incurred attempting to probe the caller's</span>
00451             <span class="comment">// I/O status block.  Simply return an appropriate error status</span>
00452             <span class="comment">// code.</span>
00453             <span class="comment">//</span>
00454 
00455             <span class="keywordflow">return</span> GetExceptionCode();
00456 
00457         }
00458     }
00459 
00460     <span class="comment">//</span>
00461     <span class="comment">// There were no blatant errors so far, so reference the file object so</span>
00462     <span class="comment">// the target device object can be found.  Note that if the handle does</span>
00463     <span class="comment">// not refer to a file object, or if the caller does not have the required</span>
00464     <span class="comment">// access to the file, then it will fail.</span>
00465     <span class="comment">//</span>
00466 
00467     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
00468                                         0,
00469                                         <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>,
00470                                         requestorMode,
00471                                         (PVOID *) &amp;fileObject,
00472                                         &amp;objectHandleInformation );
00473     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00474         <span class="keywordflow">return</span> status;
00475     }
00476 
00477     <span class="comment">//</span>
00478     <span class="comment">// Ensure that the caller has either WRITE or APPEND access to the file</span>
00479     <span class="comment">// before allowing this call to continue.  This is especially important</span>
00480     <span class="comment">// if the caller opened a volume, where a flush operation may flush more</span>
00481     <span class="comment">// than what this opener has written to buffers.  Note however that if</span>
00482     <span class="comment">// this is a pipe, then the APPEND access cannot be made since this</span>
00483     <span class="comment">// access code is overlaid with the CREATE_PIPE_INSTANCE access.</span>
00484     <span class="comment">//</span>
00485 
00486     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/se_8h.html#a9">SeComputeGrantedAccesses</a>( objectHandleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a>,
00487                                   (!(fileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a157">FO_NAMED_PIPE</a>) ?
00488                                   FILE_APPEND_DATA : 0) |
00489                                   FILE_WRITE_DATA ) == 0) {
00490         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00491         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00492     }
00493 
00494     <span class="comment">//</span>
00495     <span class="comment">// Make a special check here to determine whether this is a synchronous</span>
00496     <span class="comment">// I/O operation.  If it is, then wait here until the file is owned by</span>
00497     <span class="comment">// the current thread.  If this is not a (serialized) synchronous I/O</span>
00498     <span class="comment">// operation, then allocate and initialize the local event.</span>
00499     <span class="comment">//</span>
00500 
00501     <span class="keywordflow">if</span> (fileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
00502 
00503         BOOLEAN interrupted;
00504 
00505         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
00506             status = <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
00507                                                requestorMode,
00508                                                (BOOLEAN) ((fileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a152">FO_ALERTABLE_IO</a>) != 0),
00509                                                &amp;interrupted );
00510             <span class="keywordflow">if</span> (interrupted) {
00511                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00512                 <span class="keywordflow">return</span> status;
00513             }
00514         }
00515         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00516     } <span class="keywordflow">else</span> {
00517 
00518         <span class="comment">//</span>
00519         <span class="comment">// This is a synchronous API being invoked for a file that is opened</span>
00520         <span class="comment">// for asynchronous I/O.  This means that this system service is</span>
00521         <span class="comment">// to synchronize the completion of the operation before returning</span>
00522         <span class="comment">// to the caller.  A local event is used to do this.</span>
00523         <span class="comment">//</span>
00524 
00525         event = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> ) );
00526         <span class="keywordflow">if</span> (event == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00527             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00528             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00529         }
00530         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( event, SynchronizationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00531         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00532     }
00533 
00534     <span class="comment">//</span>
00535     <span class="comment">// Set the file object to the Not-Signaled state.</span>
00536     <span class="comment">//</span>
00537 
00538     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;Event );
00539 
00540     <span class="comment">//</span>
00541     <span class="comment">// Get the address of the target device object.</span>
00542     <span class="comment">//</span>
00543 
00544     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
00545 
00546     <span class="comment">//</span>
00547     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
00548     <span class="comment">// The allocation is performed with an exception handler in case the</span>
00549     <span class="comment">// caller does not have enough quota to allocate the packet.</span>
00550 
00551     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00552     <span class="keywordflow">if</span> (!irp) {
00553 
00554         <span class="comment">//</span>
00555         <span class="comment">// An exception was incurred while attempting to allocate the IRP.</span>
00556         <span class="comment">// Cleanup and return an appropriate error status code.</span>
00557         <span class="comment">//</span>
00558 
00559         <span class="keywordflow">if</span> (!(fileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>)) {
00560             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( event );
00561         }
00562 
00563         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( fileObject, (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00564 
00565         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00566     }
00567     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
00568     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00569     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = requestorMode;
00570 
00571     <span class="comment">//</span>
00572     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
00573     <span class="comment">//</span>
00574 
00575     <span class="keywordflow">if</span> (synchronousIo) {
00576         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00577         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = IoStatusBlock;
00578     } <span class="keywordflow">else</span> {
00579         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = event;
00580         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;localIoStatus;
00581         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
00582     }
00583     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00584 
00585     <span class="comment">//</span>
00586     <span class="comment">// Get a pointer to the stack location for the first driver.  This is used</span>
00587     <span class="comment">// to pass the original function codes and parameters.</span>
00588     <span class="comment">//</span>
00589 
00590     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00591     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a22">IRP_MJ_FLUSH_BUFFERS</a>;
00592     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
00593 
00594     <span class="comment">//</span>
00595     <span class="comment">// Queue the packet, call the driver, and synchronize appopriately with</span>
00596     <span class="comment">// I/O completion.</span>
00597     <span class="comment">//</span>
00598 
00599     status = <a class="code" href="../../d0/d6/iop_8h.html#a212">IopSynchronousServiceTail</a>( deviceObject,
00600                                         irp,
00601                                         fileObject,
00602                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00603                                         requestorMode,
00604                                         synchronousIo,
00605                                         <a class="code" href="../../d0/d6/iop_8h.html#a240a140">OtherTransfer</a> );
00606 
00607     <span class="comment">//</span>
00608     <span class="comment">// If the file for this operation was not opened for synchronous I/O, then</span>
00609     <span class="comment">// synchronization of completion of the I/O operation has not yet occurred</span>
00610     <span class="comment">// since the allocated event must be used for synchronous APIs on files</span>
00611     <span class="comment">// opened for asynchronous I/O.  Synchronize the completion of the I/O</span>
00612     <span class="comment">// operation now.</span>
00613     <span class="comment">//</span>
00614 
00615     <span class="keywordflow">if</span> (!synchronousIo) {
00616 
00617         status = <a class="code" href="../../d0/d6/iop_8h.html#a211">IopSynchronousApiServiceTail</a>( status,
00618                                                event,
00619                                                irp,
00620                                                requestorMode,
00621                                                &amp;localIoStatus,
00622                                                IoStatusBlock );
00623     }
00624 
00625     <span class="keywordflow">return</span> status;
00626 }
00627 
00628 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00629"></a><a class="code" href="../../d1/d0/io_2misc_8c.html#a4">00629</a> <a class="code" href="../../d1/d0/io_2misc_8c.html#a4">NtQueryAttributesFile</a>(
00630     IN POBJECT_ATTRIBUTES ObjectAttributes,
00631     OUT PFILE_BASIC_INFORMATION FileInformation
00632     )
00633 
00634 <span class="comment">/*++</span>
00635 <span class="comment"></span>
00636 <span class="comment">Routine Description:</span>
00637 <span class="comment"></span>
00638 <span class="comment">    This service queries the basic attributes information for a specified file.</span>
00639 <span class="comment"></span>
00640 <span class="comment">Arguments:</span>
00641 <span class="comment"></span>
00642 <span class="comment">    ObjectAttributes - Supplies the attributes to be used for file object (name,</span>
00643 <span class="comment">        SECURITY_DESCRIPTOR, etc.)</span>
00644 <span class="comment"></span>
00645 <span class="comment">    FileInformation - Supplies an output buffer to receive the returned file</span>
00646 <span class="comment">        attributes information.</span>
00647 <span class="comment"></span>
00648 <span class="comment">Return Value:</span>
00649 <span class="comment"></span>
00650 <span class="comment">    The status returned is the final completion status of the operation.</span>
00651 <span class="comment"></span>
00652 <span class="comment">--*/</span>
00653 
00654 {
00655     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
00656     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00657     <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">OPEN_PACKET</a> openPacket;
00658     <a class="code" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html">DUMMY_FILE_OBJECT</a> localFileObject;
00659     FILE_NETWORK_OPEN_INFORMATION networkInformation;
00660     HANDLE handle;
00661 
00662     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00663 
00664     <span class="comment">//</span>
00665     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00666     <span class="comment">//</span>
00667 
00668     requestorMode = KeGetPreviousMode();
00669 
00670     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00671 
00672         <span class="keywordflow">try</span> {
00673 
00674             <span class="comment">//</span>
00675             <span class="comment">// The caller's mode is not kernel, so probe the output buffer.</span>
00676             <span class="comment">//</span>
00677 
00678             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( FileInformation,
00679                            <span class="keyword">sizeof</span>( FILE_BASIC_INFORMATION ),
00680                            <span class="keyword">sizeof</span>( ULONG ));
00681 
00682         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00683 
00684             <span class="comment">//</span>
00685             <span class="comment">// An exception was incurred while probing the caller's parameters.</span>
00686             <span class="comment">// Simply return an appropriate error status code.</span>
00687             <span class="comment">//</span>
00688 
00689             <span class="keywordflow">return</span> GetExceptionCode();
00690         }
00691     }
00692 
00693     <span class="comment">//</span>
00694     <span class="comment">// Build a parse open packet that tells the parse method to open the file,</span>
00695     <span class="comment">// query the file's basic attributes, and close the file.</span>
00696     <span class="comment">//</span>
00697 
00698     RtlZeroMemory( &amp;openPacket, <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">OPEN_PACKET</a> ) );
00699 
00700     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o0">Type</a> = <a class="code" href="../../d0/d5/io_8h.html#a7">IO_TYPE_OPEN_PACKET</a>;
00701     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o1">Size</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d6/iop_8h.html#a55">OPEN_PACKET</a> );
00702     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o10">ShareAccess</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE;
00703     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o14">Disposition</a> = FILE_OPEN;
00704     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o8">CreateOptions</a> = FILE_OPEN_REPARSE_POINT;
00705     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o15">BasicInformation</a> = FileInformation;
00706     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o16">NetworkInformation</a> = &amp;networkInformation;
00707     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o20">QueryOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00708     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o23">LocalFileObject</a> = &amp;localFileObject;
00709 
00710     <span class="comment">//</span>
00711     <span class="comment">// Update the open count for this process.</span>
00712     <span class="comment">//</span>
00713 
00714     <a class="code" href="../../d4/d6/iosubs_8c.html#a129">IopUpdateOtherOperationCount</a>();
00715 
00716     <span class="comment">//</span>
00717     <span class="comment">// Open the object by its name.  Because of the special QueryOnly flag set</span>
00718     <span class="comment">// in the open packet, the parse routine will open the file, and then</span>
00719     <span class="comment">// realize that it is only performing a query.  It will therefore perform</span>
00720     <span class="comment">// the query, and immediately close the file.</span>
00721     <span class="comment">//</span>
00722 
00723     status = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00724                                  (<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00725                                  requestorMode,
00726                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00727                                  FILE_READ_ATTRIBUTES,
00728                                  &amp;openPacket,
00729                                  &amp;handle );
00730 
00731     <span class="comment">//</span>
00732     <span class="comment">// The operation is successful if the parse check field of the open packet</span>
00733     <span class="comment">// indicates that the parse routine was actually invoked, and the final</span>
00734     <span class="comment">// status field of the packet is set to success.</span>
00735     <span class="comment">//</span>
00736 
00737     <span class="keywordflow">if</span> (openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o5">ParseCheck</a> != <a class="code" href="../../d0/d6/iop_8h.html#a3">OPEN_PACKET_PATTERN</a>) {
00738         <span class="keywordflow">return</span> status;
00739     } <span class="keywordflow">else</span> {
00740         <span class="keywordflow">return</span> openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o3">FinalStatus</a>;
00741     }
00742 }
00743 
00744 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00745"></a><a class="code" href="../../d1/d0/io_2misc_8c.html#a5">00745</a> <a class="code" href="../../d1/d0/io_2misc_8c.html#a5">NtQueryFullAttributesFile</a>(
00746     IN POBJECT_ATTRIBUTES ObjectAttributes,
00747     OUT PFILE_NETWORK_OPEN_INFORMATION FileInformation
00748     )
00749 
00750 <span class="comment">/*++</span>
00751 <span class="comment"></span>
00752 <span class="comment">Routine Description:</span>
00753 <span class="comment"></span>
00754 <span class="comment">    This service queries the network attributes information for a specified</span>
00755 <span class="comment">    file.</span>
00756 <span class="comment"></span>
00757 <span class="comment">Arguments:</span>
00758 <span class="comment"></span>
00759 <span class="comment">    ObjectAttributes - Supplies the attributes to be used for file object (name,</span>
00760 <span class="comment">        SECURITY_DESCRIPTOR, etc.)</span>
00761 <span class="comment"></span>
00762 <span class="comment">    FileInformation - Supplies an output buffer to receive the returned file</span>
00763 <span class="comment">        attributes information.</span>
00764 <span class="comment"></span>
00765 <span class="comment">Return Value:</span>
00766 <span class="comment"></span>
00767 <span class="comment">    The status returned is the final completion status of the operation.</span>
00768 <span class="comment"></span>
00769 <span class="comment">--*/</span>
00770 
00771 {
00772     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
00773     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00774     <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">OPEN_PACKET</a> openPacket;
00775     <a class="code" href="../../d0/d1/struct__DUMMY__FILE__OBJECT.html">DUMMY_FILE_OBJECT</a> localFileObject;
00776     FILE_NETWORK_OPEN_INFORMATION networkInformation;
00777     HANDLE handle;
00778 
00779     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00780 
00781     <span class="comment">//</span>
00782     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00783     <span class="comment">//</span>
00784 
00785     requestorMode = KeGetPreviousMode();
00786 
00787     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00788 
00789         <span class="keywordflow">try</span> {
00790 
00791             <span class="comment">//</span>
00792             <span class="comment">// The caller's mode is not kernel, so probe the output buffer.</span>
00793             <span class="comment">//</span>
00794 
00795             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( FileInformation,
00796                            <span class="keyword">sizeof</span>( FILE_NETWORK_OPEN_INFORMATION ),
00797 #<span class="keywordflow">if</span> defined(<a class="code" href="../../d3/d3/i386_8c.html#a0">_X86_</a>)
00798                            <span class="keyword">sizeof</span>( LONG ));
00799 <span class="preprocessor">#else</span>
00800 <span class="preprocessor"></span>                           <span class="keyword">sizeof</span>( LONGLONG ));
00801 <span class="preprocessor">#endif // defined(_X86_)</span>
00802 <span class="preprocessor"></span>
00803         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00804 
00805             <span class="comment">//</span>
00806             <span class="comment">// An exception was incurred while probing the caller's parameters.</span>
00807             <span class="comment">// Simply return an appropriate error status code.</span>
00808             <span class="comment">//</span>
00809 
00810             <span class="keywordflow">return</span> GetExceptionCode();
00811         }
00812     }
00813 
00814     <span class="comment">//</span>
00815     <span class="comment">// Build a parse open packet that tells the parse method to open the file,</span>
00816     <span class="comment">// query the file's full attributes, and close the file.</span>
00817     <span class="comment">//</span>
00818 
00819     RtlZeroMemory( &amp;openPacket, <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d7/struct__OPEN__PACKET.html">OPEN_PACKET</a> ) );
00820 
00821     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o0">Type</a> = <a class="code" href="../../d0/d5/io_8h.html#a7">IO_TYPE_OPEN_PACKET</a>;
00822     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o1">Size</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d6/iop_8h.html#a55">OPEN_PACKET</a> );
00823     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o10">ShareAccess</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE;
00824     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o14">Disposition</a> = FILE_OPEN;
00825     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o8">CreateOptions</a> = FILE_OPEN_REPARSE_POINT;
00826     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o20">QueryOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00827     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o22">FullAttributes</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00828     openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o23">LocalFileObject</a> = &amp;localFileObject;
00829     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00830         openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o16">NetworkInformation</a> = &amp;networkInformation;
00831     } <span class="keywordflow">else</span> {
00832         openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o16">NetworkInformation</a> = FileInformation;
00833     }
00834 
00835     <span class="comment">//</span>
00836     <span class="comment">// Update the open count for this process.</span>
00837     <span class="comment">//</span>
00838 
00839     <a class="code" href="../../d4/d6/iosubs_8c.html#a129">IopUpdateOtherOperationCount</a>();
00840 
00841     <span class="comment">//</span>
00842     <span class="comment">// Open the object by its name.  Because of the special QueryOnly flag set</span>
00843     <span class="comment">// in the open packet, the parse routine will open the file, and then</span>
00844     <span class="comment">// realize that it is only performing a query.  It will therefore perform</span>
00845     <span class="comment">// the query, and immediately close the file.</span>
00846     <span class="comment">//</span>
00847 
00848     status = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00849                                  (<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00850                                  requestorMode,
00851                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00852                                  FILE_READ_ATTRIBUTES,
00853                                  &amp;openPacket,
00854                                  &amp;handle );
00855 
00856     <span class="comment">//</span>
00857     <span class="comment">// The operation is successful if the parse check field of the open packet</span>
00858     <span class="comment">// indicates that the parse routine was actually invoked, and the final</span>
00859     <span class="comment">// status field of the packet is set to success.</span>
00860     <span class="comment">//</span>
00861 
00862     <span class="keywordflow">if</span> (openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o5">ParseCheck</a> != <a class="code" href="../../d0/d6/iop_8h.html#a3">OPEN_PACKET_PATTERN</a>) {
00863         <span class="keywordflow">return</span> status;
00864     } <span class="keywordflow">else</span> {
00865         status = openPacket.<a class="code" href="../../d3/d7/struct__OPEN__PACKET.html#o3">FinalStatus</a>;
00866     }
00867 
00868     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00869         <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00870             <span class="keywordflow">try</span> {
00871 
00872                 <span class="comment">//</span>
00873                 <span class="comment">// The query worked, so copy the returned information to the</span>
00874                 <span class="comment">// caller's output buffer.</span>
00875                 <span class="comment">//</span>
00876 
00877                 RtlMoveMemory( FileInformation,
00878                                &amp;networkInformation,
00879                                <span class="keyword">sizeof</span>( FILE_NETWORK_OPEN_INFORMATION ) );
00880 
00881             } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00882                 status = GetExceptionCode();
00883             }
00884         }
00885     }
00886 
00887     <span class="keywordflow">return</span> status;
00888 }
00889 
00890 <a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">PIO_WORKITEM</a>
<a name="l00891"></a><a class="code" href="../../d1/d0/io_2misc_8c.html#a6">00891</a> <a class="code" href="../../d1/d0/io_2misc_8c.html#a6">IoAllocateWorkItem</a>(
00892     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
00893     )
00894 {
00895     <a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">PIO_WORKITEM</a> ioWorkItem;
00896     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a> exWorkItem;
00897 
00898     <span class="comment">//</span>
00899     <span class="comment">// Allocate a new workitem structure.</span>
00900     <span class="comment">// </span>
00901 
00902     ioWorkItem = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">IO_WORKITEM</a> ));
00903     <span class="keywordflow">if</span> (ioWorkItem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00904 
00905         <span class="comment">//</span>
00906         <span class="comment">// Initialize the invariant portions of both ioWorkItem and</span>
00907         <span class="comment">// exWorkItem.</span>
00908         <span class="comment">//</span>
00909 
00910 <span class="preprocessor">#if DBG</span>
00911 <span class="preprocessor"></span>        ioWorkItem-&gt;Size = <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d6/iop_8h.html#a41">IO_WORKITEM</a> );
00912 <span class="preprocessor">#endif</span>
00913 <span class="preprocessor"></span>
00914         ioWorkItem-&gt;<a class="code" href="../../d5/d9/struct__IO__WORKITEM.html#o2">DeviceObject</a> = DeviceObject;
00915 
00916         exWorkItem = &amp;ioWorkItem-&gt;<a class="code" href="../../d5/d9/struct__IO__WORKITEM.html#o0">WorkItem</a>;
00917         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( exWorkItem, <a class="code" href="../../d1/d0/io_2misc_8c.html#a0">IopProcessWorkItem</a>, ioWorkItem );
00918     }
00919 
00920     <span class="keywordflow">return</span> ioWorkItem;
00921 }
00922 
00923 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00924"></a><a class="code" href="../../d1/d0/io_2misc_8c.html#a7">00924</a> <a class="code" href="../../d1/d0/io_2misc_8c.html#a7">IoFreeWorkItem</a>(
00925     <a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">PIO_WORKITEM</a> IoWorkItem
00926     )
00927 
00928 <span class="comment">/*++</span>
00929 <span class="comment"></span>
00930 <span class="comment">Routine Description:</span>
00931 <span class="comment"></span>
00932 <span class="comment">    This function is the "wrapper" routine for IoQueueWorkItem.  It calls</span>
00933 <span class="comment">    the original worker function, then dereferences the device object to</span>
00934 <span class="comment">    (possibly) allow the driver object to go away.</span>
00935 <span class="comment"></span>
00936 <span class="comment">Arguments:</span>
00937 <span class="comment"></span>
00938 <span class="comment">    Parameter - Supplies a pointer to an IO_WORKITEM for us to process.</span>
00939 <span class="comment"></span>
00940 <span class="comment">Return Value:</span>
00941 <span class="comment"></span>
00942 <span class="comment">    None</span>
00943 <span class="comment"></span>
00944 <span class="comment">--*/</span>
00945 
00946 {
00947     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IoWorkItem-&gt;Size == <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">IO_WORKITEM</a> ));
00948 
00949     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( IoWorkItem );
00950 }
00951 
00952 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00953"></a><a class="code" href="../../d1/d0/io_2misc_8c.html#a8">00953</a> <a class="code" href="../../d1/d0/io_2misc_8c.html#a8">IoQueueWorkItem</a>(
00954     IN <a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">PIO_WORKITEM</a> IoWorkItem,
00955     IN PIO_WORKITEM_ROUTINE WorkerRoutine,
00956     IN WORK_QUEUE_TYPE QueueType,
00957     IN PVOID Context
00958     )
00959 <span class="comment">/*++</span>
00960 <span class="comment"></span>
00961 <span class="comment">Routine Description:</span>
00962 <span class="comment"></span>
00963 <span class="comment">    This function inserts a work item into a work queue that is processed</span>
00964 <span class="comment">    by a worker thread of the corresponding type.  It effectively</span>
00965 <span class="comment">    "wraps" ExQueueWorkItem, ensuring that the device object is referenced</span>
00966 <span class="comment">    for the duration of the call.</span>
00967 <span class="comment"></span>
00968 <span class="comment">Arguments:</span>
00969 <span class="comment"></span>
00970 <span class="comment">    IoWorkItem - Supplies a pointer to the work item to add the the queue.</span>
00971 <span class="comment">        This structure must have been allocated via IoAllocateWorkItem().</span>
00972 <span class="comment"></span>
00973 <span class="comment">    WorkerRoutine - Supplies a pointer to the routine that is to be called</span>
00974 <span class="comment">        in system thread context.</span>
00975 <span class="comment"></span>
00976 <span class="comment">    QueueType - Specifies the type of work queue that the work item</span>
00977 <span class="comment">        should be placed in.</span>
00978 <span class="comment"></span>
00979 <span class="comment">    Context - Supplies the context parameter for the callback routine.</span>
00980 <span class="comment"></span>
00981 <span class="comment">Return Value:</span>
00982 <span class="comment"></span>
00983 <span class="comment">    None</span>
00984 <span class="comment"></span>
00985 <span class="comment">--*/</span>
00986 
00987 {
00988     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a> exWorkItem;
00989 
00990     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> );
00991     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IoWorkItem-&gt;Size == <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">IO_WORKITEM</a> ));
00992 
00993     <span class="comment">//</span>
00994     <span class="comment">// Keep a reference on the device object so it doesn't go away.</span>
00995     <span class="comment">//</span>
00996 
00997     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( IoWorkItem-&gt;DeviceObject );
00998 
00999     <span class="comment">//</span>
01000     <span class="comment">// Initialize the fields in IoWorkItem</span>
01001     <span class="comment">//</span>
01002 
01003     IoWorkItem-&gt;Routine = WorkerRoutine;
01004     IoWorkItem-&gt;Context = Context;
01005 
01006     <span class="comment">//</span>
01007     <span class="comment">// Get a pointer to the ExWorkItem, queue it, and return.</span>
01008     <span class="comment">// IopProcessWorkItem() will perform the dereference.</span>
01009     <span class="comment">// </span>
01010 
01011     exWorkItem = &amp;IoWorkItem-&gt;WorkItem;
01012     <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( exWorkItem, QueueType );
01013 }
01014 
01015 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01016"></a><a class="code" href="../../d1/d0/io_2misc_8c.html#a0">01016</a> <a class="code" href="../../d1/d0/io_2misc_8c.html#a0">IopProcessWorkItem</a>(
01017     IN PVOID Parameter
01018     )
01019 
01020 <span class="comment">/*++</span>
01021 <span class="comment"></span>
01022 <span class="comment">Routine Description:</span>
01023 <span class="comment"></span>
01024 <span class="comment">    This function is the "wrapper" routine for IoQueueWorkItem.  It calls</span>
01025 <span class="comment">    the original worker function, then dereferences the device object to</span>
01026 <span class="comment">    (possibly) allow the driver object to go away.</span>
01027 <span class="comment"></span>
01028 <span class="comment">Arguments:</span>
01029 <span class="comment"></span>
01030 <span class="comment">    Parameter - Supplies a pointer to an IO_WORKITEM for us to process.</span>
01031 <span class="comment"></span>
01032 <span class="comment">Return Value:</span>
01033 <span class="comment"></span>
01034 <span class="comment">    None</span>
01035 <span class="comment"></span>
01036 <span class="comment">--*/</span>
01037 
01038 {
01039     <a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">PIO_WORKITEM</a> ioWorkItem;
01040     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
01041 
01042     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01043 
01044     <span class="comment">//</span>
01045     <span class="comment">// Get a pointer to the ioWorkItem and store a copy of DeviceObject</span>
01046     <span class="comment">// locally.  This allow us to function properly if the worker routine</span>
01047     <span class="comment">// elects to free the work item.</span>
01048     <span class="comment">//</span>
01049 
01050     ioWorkItem = (<a class="code" href="../../d5/d9/struct__IO__WORKITEM.html">PIO_WORKITEM</a>)Parameter;
01051     deviceObject = ioWorkItem-&gt;<a class="code" href="../../d5/d9/struct__IO__WORKITEM.html#o2">DeviceObject</a>;
01052 
01053     <span class="comment">//</span>
01054     <span class="comment">// Call the original worker.</span>
01055     <span class="comment">//</span>
01056 
01057     ioWorkItem-&gt;<a class="code" href="../../d5/d9/struct__IO__WORKITEM.html#o1">Routine</a>( deviceObject,
01058                          ioWorkItem-&gt;<a class="code" href="../../d5/d9/struct__IO__WORKITEM.html#o3">Context</a> );
01059 
01060     <span class="comment">//</span>
01061     <span class="comment">// Now we can dereference the device object, since its code is no longer</span>
01062     <span class="comment">// being executed for this work item.</span>
01063     <span class="comment">//</span>
01064 
01065     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( deviceObject );
01066 }
01067 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:49 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
