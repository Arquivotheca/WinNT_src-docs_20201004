<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pinsup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pinsup.c File Reference</h1><code>#include "<a class="el" href="../../d6/d4/cc_8h-source.html">cc.h</a>"</code><br>

<p>
<a href="../../d3/d8/pinsup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d9/pinsup_8c.html#a0">me</a>&nbsp;&nbsp;&nbsp;0x00000008</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d4/struct__OBCB.html">POBCB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d9/pinsup_8c.html#a1">CcAllocateObcb</a> (IN PLARGE_INTEGER FileOffset, IN ULONG Length, IN <a class="el" href="../../d4/d3/struct__BCB.html">PBCB</a> FirstBcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d9/pinsup_8c.html#a2">CcMapData</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER FileOffset, IN ULONG Length, IN BOOLEAN Wait, OUT PVOID *Bcb, OUT PVOID *<a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d9/pinsup_8c.html#a3">CcPinMappedData</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER FileOffset, IN ULONG Length, IN ULONG Flags, IN OUT PVOID *Bcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d9/pinsup_8c.html#a4">CcPinRead</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER FileOffset, IN ULONG Length, IN ULONG Flags, OUT PVOID *Bcb, OUT PVOID *<a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d9/pinsup_8c.html#a5">CcPreparePinWrite</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER FileOffset, IN ULONG Length, IN BOOLEAN <a class="el" href="../../d6/d6/ttime_8c.html#a0">Zero</a>, IN ULONG Flags, OUT PVOID *Bcb, OUT PVOID *<a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d9/pinsup_8c.html#a6">CcUnpinData</a> (IN PVOID Bcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d9/pinsup_8c.html#a7">CcSetBcbOwnerPointer</a> (IN PVOID Bcb, IN PVOID OwnerPointer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d9/pinsup_8c.html#a8">CcUnpinDataForThread</a> (IN PVOID Bcb, IN <a class="el" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a> ResourceThreadId)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="pinsup.c::me" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define me&nbsp;&nbsp;&nbsp;0x00000008          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00028">28</a> of file <a class="el" href="../../d3/d8/pinsup_8c-source.html">pinsup.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="pinsup.c::CcAllocateObcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d4/struct__OBCB.html">POBCB</a> CcAllocateObcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d3/struct__BCB.html">PBCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FirstBcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01230">1230</a> of file <a class="el" href="../../d3/d8/pinsup_8c-source.html">pinsup.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l01370">_OBCB::Bcbs</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01363">_OBCB::ByteLength</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01254">_BCB::ByteLength</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00158">CACHE_NTC_OBCB</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01364">_OBCB::FileOffset</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01255">_BCB::FileOffset</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01101">FsRtlAllocatePoolWithTag</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01357">_OBCB::NodeByteSize</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01356">_OBCB::NodeTypeCode</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/cc_8h.html#a111">OBCB</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00271">CcPinMappedData()</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00524">CcPinRead()</a>, and <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00767">CcPreparePinWrite()</a>.
<p>
<pre class="fragment"><div>01238                    :
01239 
01240     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> various pinning <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> to allocate and
01241     initialize an overlap Bcb.
01242 
01243 Arguments:
01244 
01245     FileOffset - Starting <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> offset <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Obcb (An Obcb starts with a
01246                  <span class="keyword">public</span> structure, which someone could use)
01247 
01248     Length - Length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range covered by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Obcb
01249 
01250     FirstBcb - First Bcb already created, which <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> covers <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of
01251                <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired range (low order bit may be set to indicate ReadOnly)
01252 
01253 Return Value:
01254 
01255     Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated Obcb
01256 
01257 --*/
01258 
01259 {
01260     ULONG LengthToAllocate;
01261     <a class="code" href="../../d6/d4/struct__OBCB.html">POBCB</a> Obcb;
01262     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> Bcb = (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)((ULONG_PTR)FirstBcb &amp; ~1);
01263 
01264     <span class="comment">//</span>
01265     <span class="comment">//  Allocate according to the worst case, assuming that we</span>
01266     <span class="comment">//  will need as many additional Bcbs as there are pages</span>
01267     <span class="comment">//  remaining. Also throw in one more pointer to guarantee</span>
01268     <span class="comment">//  users of the OBCB can always terminate on NULL.</span>
01269     <span class="comment">//</span>
01270     <span class="comment">//  We remove fron consideration the range described by the</span>
01271     <span class="comment">//  first Bcb (note that the range of the Obcb is not strictly</span>
01272     <span class="comment">//  starting at the first Bcb) and add in locations for the first</span>
01273     <span class="comment">//  bcb and the null.</span>
01274     <span class="comment">//</span>
01275 
01276     LengthToAllocate = FIELD_OFFSET(<a class="code" href="../../d6/d4/struct__OBCB.html">OBCB</a>, Bcbs) + (2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)) +
01277                        ((Length -
01278                          (Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o2">ByteLength</a> -
01279                           (FileOffset-&gt;HighPart?
01280                            (ULONG)(FileOffset-&gt;QuadPart - Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o3">FileOffset</a>.QuadPart) :
01281                            FileOffset-&gt;LowPart - Bcb-&gt;<a class="code" href="../../d4/d3/struct__BCB.html#o3">FileOffset</a>.LowPart)) +
01282                          <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>);
01283 
01284     Obcb = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( NonPagedPool, LengthToAllocate, 'bOcC' );
01285     RtlZeroMemory( Obcb, LengthToAllocate );
01286     Obcb-&gt;<a class="code" href="../../d6/d4/struct__OBCB.html#o0">NodeTypeCode</a> = <a class="code" href="../../d5/d5/cc_8h.html#a17">CACHE_NTC_OBCB</a>;
01287     Obcb-&gt;<a class="code" href="../../d6/d4/struct__OBCB.html#o1">NodeByteSize</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)LengthToAllocate;
01288     Obcb-&gt;<a class="code" href="../../d6/d4/struct__OBCB.html#o2">ByteLength</a> = Length;
01289     Obcb-&gt;<a class="code" href="../../d6/d4/struct__OBCB.html#o3">FileOffset</a> = *FileOffset;
01290     Obcb-&gt;<a class="code" href="../../d6/d4/struct__OBCB.html#o4">Bcbs</a>[0] = FirstBcb;
01291 
01292     <span class="keywordflow">return</span> Obcb;
01293 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="pinsup.c::CcMapData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CcMapData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Bcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00052">52</a> of file <a class="el" href="../../d3/d8/pinsup_8c-source.html">pinsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01998">CcBcbSpinLock</a>, <a class="el" href="../../d6/d2/vacbsup_8c-source.html#l00310">CcGetVirtualAddress()</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00176">CcMapDataNoWait</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00178">CcMapDataNoWaitMiss</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00177">CcMapDataWait</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00179">CcMapDataWaitMiss</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00206">CcMissCounter</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00116">CcPinFileData()</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00160">CcThrowAway</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00974">CcUnpinFileData()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00033">me</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01053">MmResetPageFaultReadAhead</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00983">MmSavePageFaultReadAhead</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01018">MmSetPageFaultReadAhead</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d5/cc_8h.html#a211a171">UNPIN</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00551">LfsFlushLfcb()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00084">LfsPinOrMapData()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00916">UdfLookupDirEntryPostProcessing()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00165">UdfLookupInitialDirEntry()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01017">UdfLookupPsnOfExtent()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00337">UdfMapMetadataView()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.
<p>
<pre class="fragment"><div>00063                    :
00064 
00065     This routine attempts to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache.
00066     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache.
00067 
00068     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller does not want to block on <span class="keyword">this</span> call, then
00069     Wait should be supplied as <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.  If Wait was supplied as <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> and
00070     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> currently impossible to supply <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested data without
00071     blocking, then <span class="keyword">this</span> routine will <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.  However, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00072     data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> immediately accessible in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache and no blocking <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00073     required, <span class="keyword">this</span> routine returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> with a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data.
00074 
00075     Note that a call to <span class="keyword">this</span> routine with Wait supplied as <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00076     considerably faster than a call with Wait supplies as <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, because
00077     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Wait <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">case</span> we <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> have to make sure <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mapped
00078     in order to <span class="keywordflow">return</span>.
00079 
00080     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> illegal to modify data that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> mapped, and can in fact lead
00081     to serious problems.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> impossible to check <span class="keywordflow">for</span> <span class="keyword">this</span> in all cases,
00082     however <a class="code" href="../../d6/d2/cachesub_8c.html#a18">CcSetDirtyPinnedData</a> may implement some Assertions to check <span class="keywordflow">for</span>
00083     <span class="keyword">this</span>.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller wishes to modify data that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> has <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> mapped, then
00084     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must *first* call <a class="code" href="../../d2/d9/pinsup_8c.html#a3">CcPinMappedData</a>.
00085 
00086     In any <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller MUST subsequently call <a class="code" href="../../d2/d9/pinsup_8c.html#a6">CcUnpinData</a>.
00087     Naturally <span class="keywordflow">if</span> <a class="code" href="../../d2/d9/pinsup_8c.html#a4">CcPinRead</a> or <a class="code" href="../../d2/d9/pinsup_8c.html#a5">CcPreparePinWrite</a> were called multiple
00088     times <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same data, <a class="code" href="../../d2/d9/pinsup_8c.html#a6">CcUnpinData</a> must be called <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same number
00089     of times.
00090 
00091     The returned <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> pointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unpinned, at
00092     which point <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invalid to use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer further.  This buffer pointer
00093     will remain valid <span class="keywordflow">if</span> <a class="code" href="../../d2/d9/pinsup_8c.html#a3">CcPinMappedData</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00094 
00095     Note that under some circumstances (like Wait supplied as FALSE or more
00096     than a page is requested), <span class="keyword">this</span> routine may actually pin <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data, however
00097     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not necessary, and in fact not correct, <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to be concerned
00098     about <span class="keyword">this</span>.
00099 
00100 Arguments:
00101 
00102     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> which was
00103                  opened with NO_INTERMEDIATE_BUFFERING clear, i.e., <span class="keywordflow">for</span>
00104                  which <a class="code" href="../../d5/d8/fssup_8c.html#a9">CcInitializeCacheMap</a> was called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system.
00105 
00106     FileOffset - Byte offset in <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> desired data.
00107 
00108     Length - Length of desired data in bytes.
00109 
00110     Wait - <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> caller may not block, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> otherwise (see description
00111            above)
00112 
00113     Bcb - On <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first call <span class="keyword">this</span> returns a pointer to a Bcb
00114           parameter which must be supplied as input on all subsequent
00115           calls, <span class="keywordflow">for</span> <span class="keyword">this</span> buffer
00116 
00117     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Returns pointer to desired data, valid until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00118              unpinned or freed.  This pointer will remain valid <span class="keywordflow">if</span> <a class="code" href="../../d2/d9/pinsup_8c.html#a3">CcPinMappedData</a>
00119              <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00120 
00121 Return Value:
00122 
00123     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <span class="keywordflow">if</span> Wait was supplied as <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data was not delivered
00124 
00125     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being delivered
00126 
00127 --*/
00128 
00129 {
00130     <a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">PSHARED_CACHE_MAP</a> SharedCacheMap;
00131     LARGE_INTEGER BeyondLastByte;
00132     ULONG ReceivedLength;
00133     ULONG SavedState;
00134     <span class="keyword">volatile</span> UCHAR ch;
00135     ULONG PageCount = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a>((ULongToPtr(FileOffset-&gt;LowPart)), Length);
00136     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00137 
00138     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, me, <span class="stringliteral">"CcMapData\n"</span>, 0 );
00139 
00140     <a class="code" href="../../d2/d1/mm_8h.html#a19">MmSavePageFaultReadAhead</a>( Thread, &amp;SavedState );
00141 
00142     <span class="comment">//</span>
00143     <span class="comment">//  Increment performance counters</span>
00144     <span class="comment">//</span>
00145 
00146     <span class="keywordflow">if</span> (Wait) {
00147 
00148         <a class="code" href="../../d5/d2/cachedat_8c.html#a53">CcMapDataWait</a> += 1;
00149 
00150         <span class="comment">//</span>
00151         <span class="comment">//  Initialize the indirect pointer to our miss counter.</span>
00152         <span class="comment">//</span>
00153 
00154         <a class="code" href="../../d5/d2/cachedat_8c.html#a75">CcMissCounter</a> = &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a55">CcMapDataWaitMiss</a>;
00155 
00156     } <span class="keywordflow">else</span> {
00157         <a class="code" href="../../d5/d2/cachedat_8c.html#a52">CcMapDataNoWait</a> += 1;
00158     }
00159 
00160     <span class="comment">//</span>
00161     <span class="comment">//  Get pointer to SharedCacheMap.</span>
00162     <span class="comment">//</span>
00163 
00164     SharedCacheMap = *(<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">PSHARED_CACHE_MAP</a> *)((PCHAR)FileObject-&gt;SectionObjectPointer
00165                                             + <span class="keyword">sizeof</span>(PVOID));
00166 
00167     <span class="comment">//</span>
00168     <span class="comment">//  Call local routine to Map or Access the file data.  If we cannot map</span>
00169     <span class="comment">//  the data because of a Wait condition, return FALSE.</span>
00170     <span class="comment">//</span>
00171 
00172     <span class="keywordflow">if</span> (Wait) {
00173 
00174         *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d5/d3/vacbsup_8c.html#a15">CcGetVirtualAddress</a>( SharedCacheMap,
00175                                        *FileOffset,
00176                                        (<a class="code" href="../../d2/d5/struct__VACB.html">PVACB</a> *)Bcb,
00177                                        &amp;ReceivedLength );
00178 
00179         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ReceivedLength &gt;= Length );
00180 
00181     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a175">CcPinFileData</a>( FileObject,
00182                                FileOffset,
00183                                Length,
00184                                TRUE,
00185                                FALSE,
00186                                Wait,
00187                                (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *)Bcb,
00188                                Buffer,
00189                                &amp;BeyondLastByte )) {
00190 
00191         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, me, <span class="stringliteral">"CcMapData -&gt; FALSE\n"</span>, 0 );
00192 
00193         <a class="code" href="../../d5/d2/cachedat_8c.html#a54">CcMapDataNoWaitMiss</a> += 1;
00194 
00195         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00196 
00197     } <span class="keywordflow">else</span> {
00198 
00199         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (BeyondLastByte.QuadPart - FileOffset-&gt;QuadPart) &gt;= Length );
00200 
00201 <span class="preprocessor">#if LIST_DBG</span>
00202 <span class="preprocessor"></span>        {
00203             KIRQL OldIrql;
00204             <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> BcbTemp = (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)*Bcb;
00205 
00206             ExAcquireSpinLock( &amp;CcBcbSpinLock, &amp;OldIrql );
00207 
00208             <span class="keywordflow">if</span> (BcbTemp-&gt;CcBcbLinks.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00209 
00210                 InsertTailList( &amp;CcBcbList, &amp;BcbTemp-&gt;CcBcbLinks );
00211                 CcBcbCount += 1;
00212                 ExReleaseSpinLock( &amp;CcBcbSpinLock, OldIrql );
00213                 SetCallersAddress( BcbTemp );
00214 
00215             } <span class="keywordflow">else</span> {
00216                 ExReleaseSpinLock( &amp;CcBcbSpinLock, OldIrql );
00217             }
00218 
00219         }
00220 <span class="preprocessor">#endif</span>
00221 <span class="preprocessor"></span>
00222     }
00223 
00224     <span class="comment">//</span>
00225     <span class="comment">//  Now let's just sit here and take the miss(es) like a man (and count them).</span>
00226     <span class="comment">//</span>
00227 
00228     <span class="keywordflow">try</span> {
00229 
00230         <span class="comment">//</span>
00231         <span class="comment">//  Loop to touch each page</span>
00232         <span class="comment">//</span>
00233 
00234         BeyondLastByte.LowPart = 0;
00235 
00236         <span class="keywordflow">while</span> (PageCount != 0) {
00237 
00238             <a class="code" href="../../d2/d1/mm_8h.html#a20">MmSetPageFaultReadAhead</a>( Thread, PageCount - 1 );
00239 
00240             ch = *((<span class="keyword">volatile</span> UCHAR *)(*Buffer) + BeyondLastByte.LowPart);
00241 
00242             BeyondLastByte.LowPart += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00243             PageCount -= 1;
00244         }
00245 
00246     } finally {
00247 
00248         <a class="code" href="../../d2/d1/mm_8h.html#a21">MmResetPageFaultReadAhead</a>( Thread, SavedState );
00249 
00250         <span class="keywordflow">if</span> (AbnormalTermination() &amp;&amp; (*Bcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00251             <a class="code" href="../../d5/d5/cc_8h.html#a176">CcUnpinFileData</a>( (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)*Bcb, TRUE, UNPIN );
00252             *Bcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00253         }
00254     }
00255 
00256     <a class="code" href="../../d5/d2/cachedat_8c.html#a75">CcMissCounter</a> = &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a43">CcThrowAway</a>;
00257 
00258     <span class="comment">//</span>
00259     <span class="comment">// Increment the pointer as a reminder that it is read only.</span>
00260     <span class="comment">//</span>
00261 
00262     *(PCHAR *)Bcb += 1;
00263 
00264     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, me, <span class="stringliteral">"CcMapData -&gt; TRUE\n"</span>, 0 );
00265 
00266     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00267 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="pinsup.c::CcPinMappedData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CcPinMappedData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Bcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00271">271</a> of file <a class="el" href="../../d3/d8/pinsup_8c-source.html">pinsup.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00501">BooleanFlagOn</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00155">CACHE_NTC_BCB</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01230">CcAllocateObcb()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01998">CcBcbSpinLock</a>, <a class="el" href="../../d6/d2/vacbsup_8c-source.html#l00862">CcFreeVirtualAddress()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00116">CcPinFileData()</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00181">CcPinMappedDataCount</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01014">ExAcquireSharedStarveExclusive()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00832">_SHARED_CACHE_MAP::Flags</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00033">me</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01077">MODIFIED_WRITE_DISABLED</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d1/cache_8h-source.html#l00582">PIN_WAIT</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>.
<p>
<pre class="fragment"><div>00281                    :
00282 
00283     This routine attempts to pin data that was previously <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> mapped.
00284     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine determines that in fact <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> was necessary to actually
00285     pin <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data when <a class="code" href="../../d2/d9/pinsup_8c.html#a2">CcMapData</a> was called, then <span class="keyword">this</span> routine does not
00286     have to <span class="keywordflow">do</span> anything.
00287 
00288     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller does not want to block on <span class="keyword">this</span> call, then
00289     Wait should be supplied as <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.  If Wait was supplied as <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> and
00290     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> currently impossible to supply <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested data without
00291     blocking, then <span class="keyword">this</span> routine will <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.  However, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00292     data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> immediately accessible in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache and no blocking <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00293     required, <span class="keyword">this</span> routine returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> with a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data.
00294 
00295     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not returned in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first call, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
00296     may request <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data later with Wait = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not required
00297     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller request <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data later.
00298 
00299     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller subsequently modifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> should call
00300     <a class="code" href="../../d6/d2/cachesub_8c.html#a18">CcSetDirtyPinnedData</a>.
00301 
00302     In any <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller MUST subsequently call <a class="code" href="../../d2/d9/pinsup_8c.html#a6">CcUnpinData</a>.
00303     Naturally <span class="keywordflow">if</span> <a class="code" href="../../d2/d9/pinsup_8c.html#a4">CcPinRead</a> or <a class="code" href="../../d2/d9/pinsup_8c.html#a5">CcPreparePinWrite</a> were called multiple
00304     times <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same data, <a class="code" href="../../d2/d9/pinsup_8c.html#a6">CcUnpinData</a> must be called <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same number
00305     of times.
00306 
00307     Note there are no performance counters in <span class="keyword">this</span> routine, as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> misses
00308     will almost always occur on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map above, and there will seldom be a
00309     miss on <span class="keyword">this</span> conversion.
00310 
00311 Arguments:
00312 
00313     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> which was
00314                  opened with NO_INTERMEDIATE_BUFFERING clear, i.e., <span class="keywordflow">for</span>
00315                  which <a class="code" href="../../d5/d8/fssup_8c.html#a9">CcInitializeCacheMap</a> was called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system.
00316 
00317     FileOffset - Byte offset in <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> desired data.
00318 
00319     Length - Length of desired data in bytes.
00320 
00321     Flags - (<a class="code" href="../../d4/d2/cache_8h.html#a6">PIN_WAIT</a>, <a class="code" href="../../d4/d2/cache_8h.html#a7">PIN_EXCLUSIVE</a>, <a class="code" href="../../d4/d2/cache_8h.html#a8">PIN_NO_READ</a>, etc. as defined in cache.h)
00322             If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller specifies <a class="code" href="../../d4/d2/cache_8h.html#a8">PIN_NO_READ</a> and <a class="code" href="../../d4/d2/cache_8h.html#a7">PIN_EXCLUSIVE</a>, then he must
00323             guarantee that no one <span class="keywordflow">else</span> will be attempting to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view, <span class="keywordflow">if</span> he
00324             wants to guarantee that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Bcb <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not mapped (view may be purged).
00325             If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller specifies <a class="code" href="../../d4/d2/cache_8h.html#a8">PIN_NO_READ</a> without <a class="code" href="../../d4/d2/cache_8h.html#a7">PIN_EXCLUSIVE</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data
00326             may or may not be mapped in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> Bcb.
00327 
00328     Bcb - On <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first call <span class="keyword">this</span> returns a pointer to a Bcb
00329           parameter which must be supplied as input on all subsequent
00330           calls, <span class="keywordflow">for</span> <span class="keyword">this</span> buffer
00331 
00332 Return Value:
00333 
00334     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <span class="keywordflow">if</span> Wait was not set and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data was not delivered
00335 
00336     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being delivered
00337 
00338 --*/
00339 
00340 {
00341     PVOID <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00342     LARGE_INTEGER BeyondLastByte;
00343     <a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">PSHARED_CACHE_MAP</a> SharedCacheMap;
00344     LARGE_INTEGER LocalFileOffset = *FileOffset;
00345     <a class="code" href="../../d6/d4/struct__OBCB.html">POBCB</a> MyBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00346     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *CurrentBcbPtr = (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *)&amp;MyBcb;
00347     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00348 
00349     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, me, <span class="stringliteral">"CcPinMappedData\n"</span>, 0 );
00350 
00351     <span class="comment">//</span>
00352     <span class="comment">// If the Bcb is no longer ReadOnly, then just return.</span>
00353     <span class="comment">//</span>
00354 
00355     <span class="keywordflow">if</span> ((*(PULONG)Bcb &amp; 1) == 0) {
00356         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00357     }
00358 
00359     <span class="comment">//</span>
00360     <span class="comment">// Remove the Read Only flag</span>
00361     <span class="comment">//</span>
00362 
00363     *(PCHAR *)Bcb -= 1;
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">//  Get pointer to SharedCacheMap.</span>
00367     <span class="comment">//</span>
00368 
00369     SharedCacheMap = *(<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">PSHARED_CACHE_MAP</a> *)((PCHAR)FileObject-&gt;SectionObjectPointer
00370                                             + <span class="keyword">sizeof</span>(PVOID));
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">//  We only count the calls to this routine, since they are almost guaranteed</span>
00374     <span class="comment">//  to be hits.</span>
00375     <span class="comment">//</span>
00376 
00377     <a class="code" href="../../d5/d2/cachedat_8c.html#a56">CcPinMappedDataCount</a> += 1;
00378 
00379     <span class="comment">//</span>
00380     <span class="comment">//  Guarantee we will put the flag back if required.</span>
00381     <span class="comment">//</span>
00382 
00383     <span class="keywordflow">try</span> {
00384 
00385         <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)*Bcb)-&gt;NodeTypeCode != <a class="code" href="../../d5/d5/cc_8h.html#a14">CACHE_NTC_BCB</a>) {
00386 
00387             <span class="comment">//</span>
00388             <span class="comment">//  Form loop to handle occassional overlapped Bcb case.</span>
00389             <span class="comment">//</span>
00390 
00391             <span class="keywordflow">do</span> {
00392 
00393                 <span class="comment">//</span>
00394                 <span class="comment">//  If we have already been through the loop, then adjust</span>
00395                 <span class="comment">//  our file offset and length from the last time.</span>
00396                 <span class="comment">//</span>
00397 
00398                 <span class="keywordflow">if</span> (MyBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00399 
00400                     <span class="comment">//</span>
00401                     <span class="comment">//  If this is the second time through the loop, then it is time</span>
00402                     <span class="comment">//  to handle the overlap case and allocate an OBCB.</span>
00403                     <span class="comment">//</span>
00404 
00405                     <span class="keywordflow">if</span> (CurrentBcbPtr == (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *)&amp;MyBcb) {
00406 
00407                         MyBcb = <a class="code" href="../../d2/d9/pinsup_8c.html#a1">CcAllocateObcb</a>( FileOffset, Length, (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)MyBcb );
00408 
00409                         <span class="comment">//</span>
00410                         <span class="comment">//  Set CurrentBcbPtr to point at the first entry in</span>
00411                         <span class="comment">//  the vector (which is already filled in), before</span>
00412                         <span class="comment">//  advancing it below.</span>
00413                         <span class="comment">//</span>
00414 
00415                         CurrentBcbPtr = &amp;MyBcb-&gt;<a class="code" href="../../d6/d4/struct__OBCB.html#o4">Bcbs</a>[0];
00416                     }
00417 
00418                     Length -= (ULONG)(BeyondLastByte.QuadPart - LocalFileOffset.QuadPart);
00419                     LocalFileOffset.QuadPart = BeyondLastByte.QuadPart;
00420                     CurrentBcbPtr += 1;
00421                 }
00422 
00423                 <span class="comment">//</span>
00424                 <span class="comment">//  Call local routine to Map or Access the file data.  If we cannot map</span>
00425                 <span class="comment">//  the data because of a Wait condition, return FALSE.</span>
00426                 <span class="comment">//</span>
00427 
00428                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a175">CcPinFileData</a>( FileObject,
00429                                     &amp;LocalFileOffset,
00430                                     Length,
00431                                     (BOOLEAN)!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, MODIFIED_WRITE_DISABLED),
00432                                     FALSE,
00433                                     Flags,
00434                                     CurrentBcbPtr,
00435                                     &amp;Buffer,
00436                                     &amp;BeyondLastByte )) {
00437 
00438                     <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Result = FALSE );
00439                 }
00440 
00441             <span class="comment">//</span>
00442             <span class="comment">//  Continue looping if we did not get everything.</span>
00443             <span class="comment">//</span>
00444 
00445             } <span class="keywordflow">while</span>((BeyondLastByte.QuadPart - LocalFileOffset.QuadPart) &lt; Length);
00446 
00447             <span class="comment">//</span>
00448             <span class="comment">//  Free the Vacb before going on.</span>
00449             <span class="comment">//</span>
00450 
00451             <a class="code" href="../../d5/d3/vacbsup_8c.html#a16">CcFreeVirtualAddress</a>( (<a class="code" href="../../d2/d5/struct__VACB.html">PVACB</a>)*Bcb );
00452 
00453             *Bcb = MyBcb;
00454 
00455             <span class="comment">//</span>
00456             <span class="comment">//  Debug routines used to insert and remove Bcbs from the global list</span>
00457             <span class="comment">//</span>
00458 
00459 <span class="preprocessor">#if LIST_DBG</span>
00460 <span class="preprocessor"></span>            {
00461                 KIRQL OldIrql;
00462                 <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> BcbTemp = (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)*Bcb;
00463 
00464                 ExAcquireSpinLock( &amp;CcBcbSpinLock, &amp;OldIrql );
00465 
00466                 <span class="keywordflow">if</span> (BcbTemp-&gt;CcBcbLinks.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00467 
00468                     InsertTailList( &amp;CcBcbList, &amp;BcbTemp-&gt;CcBcbLinks );
00469                     CcBcbCount += 1;
00470                     ExReleaseSpinLock( &amp;CcBcbSpinLock, OldIrql );
00471                     SetCallersAddress( BcbTemp );
00472 
00473                 } <span class="keywordflow">else</span> {
00474                     ExReleaseSpinLock( &amp;CcBcbSpinLock, OldIrql );
00475                 }
00476 
00477             }
00478 <span class="preprocessor">#endif</span>
00479 <span class="preprocessor"></span>        }
00480 
00481         <span class="comment">//</span>
00482         <span class="comment">//  If he really has a Bcb, all we have to do is acquire it shared since he is</span>
00483         <span class="comment">//  no longer ReadOnly.</span>
00484         <span class="comment">//</span>
00485 
00486         <span class="keywordflow">else</span> {
00487 
00488             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a270">ExAcquireSharedStarveExclusive</a>( &amp;((<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)*Bcb)-&gt;Resource, <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>(Flags, PIN_WAIT))) {
00489 
00490                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Result = FALSE );
00491             }
00492         }
00493 
00494         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00495 
00496     try_exit: NOTHING;
00497     }
00498     finally {
00499 
00500         <span class="keywordflow">if</span> (!Result) {
00501 
00502             <span class="comment">//</span>
00503             <span class="comment">//  Put the Read Only flag back</span>
00504             <span class="comment">//</span>
00505 
00506             *(PCHAR *)Bcb += 1;
00507 
00508             <span class="comment">//</span>
00509             <span class="comment">//  We may have gotten partway through</span>
00510             <span class="comment">//</span>
00511 
00512             <span class="keywordflow">if</span> (MyBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00513                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( MyBcb );
00514             }
00515         }
00516 
00517         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, me, <span class="stringliteral">"CcPinMappedData -&gt; %02lx\n"</span>, Result );
00518     }
00519     <span class="keywordflow">return</span> Result;
00520 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="pinsup.c::CcPinRead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CcPinRead           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Bcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00524">524</a> of file <a class="el" href="../../d3/d8/pinsup_8c-source.html">pinsup.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01230">CcAllocateObcb()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01998">CcBcbSpinLock</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00206">CcMissCounter</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00116">CcPinFileData()</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00183">CcPinReadNoWait</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00185">CcPinReadNoWaitMiss</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00184">CcPinReadWait</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00186">CcPinReadWaitMiss</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00160">CcThrowAway</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00832">_SHARED_CACHE_MAP::Flags</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00033">me</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01077">MODIFIED_WRITE_DISABLED</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d1/cache_8h-source.html#l00582">PIN_WAIT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00084">LfsPinOrMapData()</a>.
<p>
<pre class="fragment"><div>00535                    :
00536 
00537     This routine attempts to pin <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache.
00538     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache.  This routine
00539     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> intended <span class="keywordflow">for</span> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> System support and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not intended to be called
00540     from Dpc level.
00541 
00542     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller does not want to block on <span class="keyword">this</span> call, then
00543     Wait should be supplied as <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.  If Wait was supplied as <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> and
00544     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> currently impossible to supply <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested data without
00545     blocking, then <span class="keyword">this</span> routine will <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.  However, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00546     data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> immediately accessible in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache and no blocking <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00547     required, <span class="keyword">this</span> routine returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> with a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data.
00548 
00549     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not returned in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first call, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
00550     may request <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data later with Wait = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not required
00551     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller request <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data later.
00552 
00553     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller subsequently modifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> should call
00554     <a class="code" href="../../d6/d2/cachesub_8c.html#a18">CcSetDirtyPinnedData</a>.
00555 
00556     In any <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller MUST subsequently call <a class="code" href="../../d2/d9/pinsup_8c.html#a6">CcUnpinData</a>.
00557     Naturally <span class="keywordflow">if</span> <a class="code" href="../../d2/d9/pinsup_8c.html#a4">CcPinRead</a> or <a class="code" href="../../d2/d9/pinsup_8c.html#a5">CcPreparePinWrite</a> were called multiple
00558     times <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same data, <a class="code" href="../../d2/d9/pinsup_8c.html#a6">CcUnpinData</a> must be called <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same number
00559     of times.
00560 
00561     The returned <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> pointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unpinned, at
00562     which point <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invalid to use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer further.
00563 
00564 Arguments:
00565 
00566     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> which was
00567                  opened with NO_INTERMEDIATE_BUFFERING clear, i.e., <span class="keywordflow">for</span>
00568                  which <a class="code" href="../../d5/d8/fssup_8c.html#a9">CcInitializeCacheMap</a> was called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system.
00569 
00570     FileOffset - Byte offset in <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> desired data.
00571 
00572     Length - Length of desired data in bytes.
00573 
00574     Flags - (<a class="code" href="../../d4/d2/cache_8h.html#a6">PIN_WAIT</a>, <a class="code" href="../../d4/d2/cache_8h.html#a7">PIN_EXCLUSIVE</a>, <a class="code" href="../../d4/d2/cache_8h.html#a8">PIN_NO_READ</a>, etc. as defined in cache.h)
00575             If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller specifies <a class="code" href="../../d4/d2/cache_8h.html#a8">PIN_NO_READ</a> and <a class="code" href="../../d4/d2/cache_8h.html#a7">PIN_EXCLUSIVE</a>, then he must
00576             guarantee that no one <span class="keywordflow">else</span> will be attempting to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view, <span class="keywordflow">if</span> he
00577             wants to guarantee that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Bcb <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not mapped (view may be purged).
00578             If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller specifies <a class="code" href="../../d4/d2/cache_8h.html#a8">PIN_NO_READ</a> without <a class="code" href="../../d4/d2/cache_8h.html#a7">PIN_EXCLUSIVE</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data
00579             may or may not be mapped in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> Bcb.
00580 
00581     Bcb - On <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first call <span class="keyword">this</span> returns a pointer to a Bcb
00582           parameter which must be supplied as input on all subsequent
00583           calls, <span class="keywordflow">for</span> <span class="keyword">this</span> buffer
00584 
00585     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Returns pointer to desired data, valid until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00586              unpinned or freed.
00587 
00588 Return Value:
00589 
00590     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <span class="keywordflow">if</span> Wait was not set and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data was not delivered
00591 
00592     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being delivered
00593 
00594 --*/
00595 
00596 {
00597     <a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">PSHARED_CACHE_MAP</a> SharedCacheMap;
00598     PVOID LocalBuffer;
00599     LARGE_INTEGER BeyondLastByte;
00600     LARGE_INTEGER LocalFileOffset = *FileOffset;
00601     <a class="code" href="../../d6/d4/struct__OBCB.html">POBCB</a> MyBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00602     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *CurrentBcbPtr = (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *)&amp;MyBcb;
00603     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00604 
00605     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, me, <span class="stringliteral">"CcPinRead\n"</span>, 0 );
00606 
00607     <span class="comment">//</span>
00608     <span class="comment">//  Increment performance counters</span>
00609     <span class="comment">//</span>
00610 
00611     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(Flags, PIN_WAIT)) {
00612 
00613         <a class="code" href="../../d5/d2/cachedat_8c.html#a58">CcPinReadWait</a> += 1;
00614 
00615         <span class="comment">//</span>
00616         <span class="comment">//  Initialize the indirect pointer to our miss counter.</span>
00617         <span class="comment">//</span>
00618 
00619         <a class="code" href="../../d5/d2/cachedat_8c.html#a75">CcMissCounter</a> = &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a60">CcPinReadWaitMiss</a>;
00620 
00621     } <span class="keywordflow">else</span> {
00622         <a class="code" href="../../d5/d2/cachedat_8c.html#a57">CcPinReadNoWait</a> += 1;
00623     }
00624 
00625     <span class="comment">//</span>
00626     <span class="comment">//  Get pointer to SharedCacheMap.</span>
00627     <span class="comment">//</span>
00628 
00629     SharedCacheMap = *(<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">PSHARED_CACHE_MAP</a> *)((PCHAR)FileObject-&gt;SectionObjectPointer
00630                                             + <span class="keyword">sizeof</span>(PVOID));
00631 
00632     <span class="keywordflow">try</span> {
00633 
00634         <span class="comment">//</span>
00635         <span class="comment">//  Form loop to handle occassional overlapped Bcb case.</span>
00636         <span class="comment">//</span>
00637 
00638         <span class="keywordflow">do</span> {
00639 
00640             <span class="comment">//</span>
00641             <span class="comment">//  If we have already been through the loop, then adjust</span>
00642             <span class="comment">//  our file offset and length from the last time.</span>
00643             <span class="comment">//</span>
00644 
00645             <span class="keywordflow">if</span> (MyBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00646 
00647                 <span class="comment">//</span>
00648                 <span class="comment">//  If this is the second time through the loop, then it is time</span>
00649                 <span class="comment">//  to handle the overlap case and allocate an OBCB.</span>
00650                 <span class="comment">//</span>
00651 
00652                 <span class="keywordflow">if</span> (CurrentBcbPtr == (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *)&amp;MyBcb) {
00653 
00654                     MyBcb = <a class="code" href="../../d2/d9/pinsup_8c.html#a1">CcAllocateObcb</a>( FileOffset, Length, (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)MyBcb );
00655 
00656                     <span class="comment">//</span>
00657                     <span class="comment">//  Set CurrentBcbPtr to point at the first entry in</span>
00658                     <span class="comment">//  the vector (which is already filled in), before</span>
00659                     <span class="comment">//  advancing it below.</span>
00660                     <span class="comment">//</span>
00661 
00662                     CurrentBcbPtr = &amp;MyBcb-&gt;<a class="code" href="../../d6/d4/struct__OBCB.html#o4">Bcbs</a>[0];
00663 
00664                     <span class="comment">//</span>
00665                     <span class="comment">//  Also on second time through, return starting Buffer</span>
00666                     <span class="comment">//</span>
00667 
00668                     *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = LocalBuffer;
00669                 }
00670 
00671                 Length -= (ULONG)(BeyondLastByte.QuadPart - LocalFileOffset.QuadPart);
00672                 LocalFileOffset.QuadPart = BeyondLastByte.QuadPart;
00673                 CurrentBcbPtr += 1;
00674             }
00675 
00676             <span class="comment">//</span>
00677             <span class="comment">//  Call local routine to Map or Access the file data.  If we cannot map</span>
00678             <span class="comment">//  the data because of a Wait condition, return FALSE.</span>
00679             <span class="comment">//</span>
00680 
00681             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a175">CcPinFileData</a>( FileObject,
00682                                 &amp;LocalFileOffset,
00683                                 Length,
00684                                 (BOOLEAN)!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, MODIFIED_WRITE_DISABLED),
00685                                 FALSE,
00686                                 Flags,
00687                                 CurrentBcbPtr,
00688                                 &amp;LocalBuffer,
00689                                 &amp;BeyondLastByte )) {
00690 
00691                 <a class="code" href="../../d5/d2/cachedat_8c.html#a59">CcPinReadNoWaitMiss</a> += 1;
00692 
00693                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Result = FALSE );
00694             }
00695 
00696         <span class="comment">//</span>
00697         <span class="comment">//  Continue looping if we did not get everything.</span>
00698         <span class="comment">//</span>
00699 
00700         } <span class="keywordflow">while</span>((BeyondLastByte.QuadPart - LocalFileOffset.QuadPart) &lt; Length);
00701 
00702         *Bcb = MyBcb;
00703 
00704         <span class="comment">//</span>
00705         <span class="comment">//  Debug routines used to insert and remove Bcbs from the global list</span>
00706         <span class="comment">//</span>
00707 
00708 <span class="preprocessor">#if LIST_DBG</span>
00709 <span class="preprocessor"></span>
00710         {
00711             KIRQL OldIrql;
00712             <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> BcbTemp = (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)*Bcb;
00713 
00714             ExAcquireSpinLock( &amp;CcBcbSpinLock, &amp;OldIrql );
00715 
00716             <span class="keywordflow">if</span> (BcbTemp-&gt;CcBcbLinks.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00717 
00718                 InsertTailList( &amp;CcBcbList, &amp;BcbTemp-&gt;CcBcbLinks );
00719                 CcBcbCount += 1;
00720                 ExReleaseSpinLock( &amp;CcBcbSpinLock, OldIrql );
00721                 SetCallersAddress( BcbTemp );
00722 
00723             } <span class="keywordflow">else</span> {
00724                 ExReleaseSpinLock( &amp;CcBcbSpinLock, OldIrql );
00725             }
00726 
00727         }
00728 
00729 <span class="preprocessor">#endif</span>
00730 <span class="preprocessor"></span>
00731         <span class="comment">//</span>
00732         <span class="comment">//  In the normal (nonoverlapping) case we return the</span>
00733         <span class="comment">//  correct buffer address here.</span>
00734         <span class="comment">//</span>
00735 
00736         <span class="keywordflow">if</span> (CurrentBcbPtr == (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *)&amp;MyBcb) {
00737             *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = LocalBuffer;
00738         }
00739 
00740         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00741 
00742     try_exit: NOTHING;
00743     }
00744     finally {
00745 
00746         <a class="code" href="../../d5/d2/cachedat_8c.html#a75">CcMissCounter</a> = &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a43">CcThrowAway</a>;
00747 
00748         <span class="keywordflow">if</span> (!Result) {
00749 
00750             <span class="comment">//</span>
00751             <span class="comment">//  We may have gotten partway through</span>
00752             <span class="comment">//</span>
00753 
00754             <span class="keywordflow">if</span> (MyBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00755                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( MyBcb );
00756             }
00757         }
00758 
00759         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, me, <span class="stringliteral">"CcPinRead -&gt; %02lx\n"</span>, Result );
00760     }
00761 
00762     <span class="keywordflow">return</span> Result;
00763 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="pinsup.c::CcPreparePinWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CcPreparePinWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Zero</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Bcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00767">767</a> of file <a class="el" href="../../d3/d8/pinsup_8c-source.html">pinsup.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01230">CcAllocateObcb()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01998">CcBcbSpinLock</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00206">CcMissCounter</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00116">CcPinFileData()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l02560">CcSetDirtyPinnedData()</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00160">CcThrowAway</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00033">me</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>, and <a class="el" href="../../d7/d5/ttime_8c-source.html#l00031">Zero</a>.
<p>
<pre class="fragment"><div>00779                    :
00780 
00781     This routine attempts to lock <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache
00782     and <span class="keywordflow">return</span> a pointer to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> along with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> correct
00783     I/O status.  Pages to be completely overwritten may be satisfied
00784     with emtpy pages.
00785 
00786     If not all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages can be prepared, and Wait was supplied as
00787     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, then <span class="keyword">this</span> routine will <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, and its outputs will
00788     be meaningless.  The caller may request <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data later with
00789     Wait = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.  However, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not required that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller request
00790     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data later.
00791 
00792     If Wait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied as <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, and all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages can be prepared
00793     without blocking, <span class="keyword">this</span> call will <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> immediately.  Otherwise,
00794     <span class="keyword">this</span> call will block until all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages can be prepared, and
00795     then <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.
00796 
00797     When <span class="keyword">this</span> call returns with <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller may immediately begin
00798     to transfer data into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffers via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> pointer.  The
00799     buffer will already be marked dirty.
00800 
00801     The caller MUST subsequently call <a class="code" href="../../d2/d9/pinsup_8c.html#a6">CcUnpinData</a>.
00802     Naturally <span class="keywordflow">if</span> <a class="code" href="../../d2/d9/pinsup_8c.html#a4">CcPinRead</a> or <a class="code" href="../../d2/d9/pinsup_8c.html#a5">CcPreparePinWrite</a> were called multiple
00803     times <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same data, <a class="code" href="../../d2/d9/pinsup_8c.html#a6">CcUnpinData</a> must be called <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same number
00804     of times.
00805 
00806     The returned <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> pointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unpinned, at
00807     which point <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invalid to use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer further.
00808 
00809 Arguments:
00810 
00811     FileObject - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> which was
00812                  opened with NO_INTERMEDIATE_BUFFERING clear, i.e., <span class="keywordflow">for</span>
00813                  which <a class="code" href="../../d5/d8/fssup_8c.html#a9">CcInitializeCacheMap</a> was called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system.
00814 
00815     FileOffset - Byte offset in <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> desired data.
00816 
00817     Length - Length of desired data in bytes.
00818 
00819     <a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a> - If supplied as <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer will be zeroed on <span class="keywordflow">return</span>.
00820 
00821     Flags - (<a class="code" href="../../d4/d2/cache_8h.html#a6">PIN_WAIT</a>, <a class="code" href="../../d4/d2/cache_8h.html#a7">PIN_EXCLUSIVE</a>, <a class="code" href="../../d4/d2/cache_8h.html#a8">PIN_NO_READ</a>, etc. as defined in cache.h)
00822             If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller specifies <a class="code" href="../../d4/d2/cache_8h.html#a8">PIN_NO_READ</a> and <a class="code" href="../../d4/d2/cache_8h.html#a7">PIN_EXCLUSIVE</a>, then he must
00823             guarantee that no one <span class="keywordflow">else</span> will be attempting to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view, <span class="keywordflow">if</span> he
00824             wants to guarantee that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Bcb <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not mapped (view may be purged).
00825             If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller specifies <a class="code" href="../../d4/d2/cache_8h.html#a8">PIN_NO_READ</a> without <a class="code" href="../../d4/d2/cache_8h.html#a7">PIN_EXCLUSIVE</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data
00826             may or may not be mapped in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> Bcb.
00827 
00828     Bcb - This returns a pointer to a Bcb parameter which must be
00829           supplied as input to CcPinWriteComplete.
00830 
00831     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Returns pointer to desired data, valid until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00832              unpinned or freed.
00833 
00834 Return Value:
00835 
00836     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <span class="keywordflow">if</span> Wait was not set and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data was not delivered
00837 
00838     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are being delivered
00839 
00840 --*/
00841 
00842 {
00843     <a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">PSHARED_CACHE_MAP</a> SharedCacheMap;
00844     PVOID LocalBuffer;
00845     LARGE_INTEGER BeyondLastByte;
00846     LARGE_INTEGER LocalFileOffset = *FileOffset;
00847     <a class="code" href="../../d6/d4/struct__OBCB.html">POBCB</a> MyBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00848     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *CurrentBcbPtr = (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *)&amp;MyBcb;
00849     ULONG OriginalLength = Length;
00850     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00851 
00852     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, me, <span class="stringliteral">"CcPreparePinWrite\n"</span>, 0 );
00853 
00854     <span class="comment">//</span>
00855     <span class="comment">//  Get pointer to SharedCacheMap.</span>
00856     <span class="comment">//</span>
00857 
00858     SharedCacheMap = *(<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">PSHARED_CACHE_MAP</a> *)((PCHAR)FileObject-&gt;SectionObjectPointer
00859                                             + <span class="keyword">sizeof</span>(PVOID));
00860 
00861     <span class="keywordflow">try</span> {
00862 
00863         <span class="comment">//</span>
00864         <span class="comment">//  Form loop to handle occassional overlapped Bcb case.</span>
00865         <span class="comment">//</span>
00866 
00867         <span class="keywordflow">do</span> {
00868 
00869             <span class="comment">//</span>
00870             <span class="comment">//  If we have already been through the loop, then adjust</span>
00871             <span class="comment">//  our file offset and length from the last time.</span>
00872             <span class="comment">//</span>
00873 
00874             <span class="keywordflow">if</span> (MyBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00875 
00876                 <span class="comment">//</span>
00877                 <span class="comment">//  If this is the second time through the loop, then it is time</span>
00878                 <span class="comment">//  to handle the overlap case and allocate an OBCB.</span>
00879                 <span class="comment">//</span>
00880 
00881                 <span class="keywordflow">if</span> (CurrentBcbPtr == (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *)&amp;MyBcb) {
00882 
00883                     MyBcb = <a class="code" href="../../d2/d9/pinsup_8c.html#a1">CcAllocateObcb</a>( FileOffset, Length, (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)MyBcb );
00884 
00885                     <span class="comment">//</span>
00886                     <span class="comment">//  Set CurrentBcbPtr to point at the first entry in</span>
00887                     <span class="comment">//  the vector (which is already filled in), before</span>
00888                     <span class="comment">//  advancing it below.</span>
00889                     <span class="comment">//</span>
00890 
00891                     CurrentBcbPtr = &amp;MyBcb-&gt;<a class="code" href="../../d6/d4/struct__OBCB.html#o4">Bcbs</a>[0];
00892 
00893                     <span class="comment">//</span>
00894                     <span class="comment">//  Also on second time through, return starting Buffer</span>
00895                     <span class="comment">//</span>
00896 
00897                     *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = LocalBuffer;
00898                 }
00899 
00900                 Length -= (ULONG)(BeyondLastByte.QuadPart - LocalFileOffset.QuadPart);
00901                 LocalFileOffset.QuadPart = BeyondLastByte.QuadPart;
00902                 CurrentBcbPtr += 1;
00903             }
00904 
00905             <span class="comment">//</span>
00906             <span class="comment">//  Call local routine to Map or Access the file data.  If we cannot map</span>
00907             <span class="comment">//  the data because of a Wait condition, return FALSE.</span>
00908             <span class="comment">//</span>
00909 
00910             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a175">CcPinFileData</a>( FileObject,
00911                                 &amp;LocalFileOffset,
00912                                 Length,
00913                                 FALSE,
00914                                 TRUE,
00915                                 Flags,
00916                                 CurrentBcbPtr,
00917                                 &amp;LocalBuffer,
00918                                 &amp;BeyondLastByte )) {
00919 
00920                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( Result = FALSE );
00921             }
00922 
00923         <span class="comment">//</span>
00924         <span class="comment">//  Continue looping if we did not get everything.</span>
00925         <span class="comment">//</span>
00926 
00927         } <span class="keywordflow">while</span>((BeyondLastByte.QuadPart - LocalFileOffset.QuadPart) &lt; Length);
00928 
00929         *Bcb = MyBcb;
00930 
00931         <span class="comment">//</span>
00932         <span class="comment">//  Debug routines used to insert and remove Bcbs from the global list</span>
00933         <span class="comment">//</span>
00934 
00935 <span class="preprocessor">#if LIST_DBG</span>
00936 <span class="preprocessor"></span>
00937         {
00938             KIRQL OldIrql;
00939             <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> BcbTemp = (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)*Bcb;
00940 
00941             ExAcquireSpinLock( &amp;CcBcbSpinLock, &amp;OldIrql );
00942 
00943             <span class="keywordflow">if</span> (BcbTemp-&gt;CcBcbLinks.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00944 
00945                 InsertTailList( &amp;CcBcbList, &amp;BcbTemp-&gt;CcBcbLinks );
00946                 CcBcbCount += 1;
00947                 ExReleaseSpinLock( &amp;CcBcbSpinLock, OldIrql );
00948                 SetCallersAddress( BcbTemp );
00949 
00950             } <span class="keywordflow">else</span> {
00951                 ExReleaseSpinLock( &amp;CcBcbSpinLock, OldIrql );
00952             }
00953 
00954         }
00955 
00956 <span class="preprocessor">#endif</span>
00957 <span class="preprocessor"></span>
00958         <span class="comment">//</span>
00959         <span class="comment">//  In the normal (nonoverlapping) case we return the</span>
00960         <span class="comment">//  correct buffer address here.</span>
00961         <span class="comment">//</span>
00962 
00963         <span class="keywordflow">if</span> (CurrentBcbPtr == (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *)&amp;MyBcb) {
00964             *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = LocalBuffer;
00965         }
00966 
00967         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a>) {
00968             RtlZeroMemory( *Buffer, OriginalLength );
00969         }
00970 
00971         <a class="code" href="../../d4/d2/cache_8h.html#a91">CcSetDirtyPinnedData</a>( MyBcb, NULL );
00972 
00973         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00974 
00975     try_exit: NOTHING;
00976     }
00977     finally {
00978 
00979         <a class="code" href="../../d5/d2/cachedat_8c.html#a75">CcMissCounter</a> = &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a43">CcThrowAway</a>;
00980 
00981         <span class="keywordflow">if</span> (!Result) {
00982 
00983             <span class="comment">//</span>
00984             <span class="comment">//  We may have gotten partway through</span>
00985             <span class="comment">//</span>
00986 
00987             <span class="keywordflow">if</span> (MyBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00988                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( MyBcb );
00989             }
00990         }
00991 
00992         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, me, <span class="stringliteral">"CcPreparePinWrite -&gt; %02lx\n"</span>, Result );
00993     }
00994 
00995     <span class="keywordflow">return</span> Result;
00996 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="pinsup.c::CcSetBcbOwnerPointer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CcSetBcbOwnerPointer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Bcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>OwnerPointer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01078">1078</a> of file <a class="el" href="../../d3/d8/pinsup_8c-source.html">pinsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00158">CACHE_NTC_OBCB</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01820">ExSetResourceOwnerPointer()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00311">LfsGetLbcb()</a>.
<p>
<pre class="fragment"><div>01085                    :
01086 
01087     This routine may be called to set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource owner <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Bcb resource,
01088     <span class="keywordflow">for</span> cases where another thread will <span class="keywordflow">do</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unpin *and* <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread
01089     may <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>.
01090 
01091 Arguments:
01092 
01093     Bcb - Bcb parameter returned from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last call to <a class="code" href="../../d2/d9/pinsup_8c.html#a4">CcPinRead</a>.
01094 
01095     OwnerPointer - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> valid resource owner pointer, which means a pointer to
01096                    an allocated system address, with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a>-order two bits
01097                    set.  The address may not be deallocated until after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01098                    unpin call.
01099 
01100 Return Value:
01101 
01102     None.
01103 
01104 --*/
01105 
01106 {
01107     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((ULONG_PTR)Bcb &amp; 1) == 0);
01108 
01109     <span class="comment">//</span>
01110     <span class="comment">//  Handle the overlapped Bcb case.</span>
01111     <span class="comment">//</span>
01112 
01113     <span class="keywordflow">if</span> (((<a class="code" href="../../d6/d4/struct__OBCB.html">POBCB</a>)Bcb)-&gt;NodeTypeCode == <a class="code" href="../../d5/d5/cc_8h.html#a17">CACHE_NTC_OBCB</a>) {
01114 
01115         <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *BcbPtrPtr = &amp;((<a class="code" href="../../d6/d4/struct__OBCB.html">POBCB</a>)Bcb)-&gt;Bcbs[0];
01116 
01117         <span class="comment">//</span>
01118         <span class="comment">//  Loop to set owner for all Bcbs.</span>
01119         <span class="comment">//</span>
01120 
01121         <span class="keywordflow">while</span> (*BcbPtrPtr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01122             <a class="code" href="../../d5/d8/ex_8h.html#a275">ExSetResourceOwnerPointer</a>( &amp;(*BcbPtrPtr)-&gt;Resource, OwnerPointer );
01123             BcbPtrPtr++;
01124         }
01125 
01126     <span class="comment">//</span>
01127     <span class="comment">//  Otherwise, it is a normal Bcb</span>
01128     <span class="comment">//</span>
01129 
01130     } <span class="keywordflow">else</span> {
01131 
01132         <span class="comment">//</span>
01133         <span class="comment">//  Handle normal case.</span>
01134         <span class="comment">//</span>
01135 
01136         <a class="code" href="../../d5/d8/ex_8h.html#a275">ExSetResourceOwnerPointer</a>( &amp;((<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)Bcb)-&gt;Resource, OwnerPointer );
01137     }
01138 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="pinsup.c::CcUnpinData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CcUnpinData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Bcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">1000</a> of file <a class="el" href="../../d3/d8/pinsup_8c-source.html">pinsup.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00158">CACHE_NTC_OBCB</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00974">CcUnpinFileData()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00033">me</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d5/cc_8h.html#a211a171">UNPIN</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00271">CcPinMappedData()</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00524">CcPinRead()</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00767">CcPreparePinWrite()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00339">LfsCopyReadLogRecord()</a>, <a class="el" href="../../d9/d6/lfs_2strucsup_8c-source.html#l00518">LfsDeallocateLcb()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03193">LfsFindLastLsn()</a>, <a class="el" href="../../d0/d7/lsnsup_8c-source.html#l00148">LfsFindNextLsn()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00551">LfsFlushLfcb()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l04321">LfsFlushLogPage()</a>, <a class="el" href="../../d8/d0/lbcbsup_8c-source.html#l00311">LfsGetLbcb()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l03065">LfsInitializeLogFilePriv()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00084">LfsPinOrMapData()</a>, <a class="el" href="../../d4/d2/querylog_8c-source.html#l00299">LfsReadNextLogRecord()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l01402">LfsReadRestart()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">LfsReadRestartArea()</a>, <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l01534">LfsRestartLogFile()</a>, and <a class="el" href="../../d4/d2/querylog_8c-source.html#l01116">LfsSearchForwardByClient()</a>.
<p>
<pre class="fragment"><div>01006                    :
01007 
01008     This routine must be called at IPL0, some time after calling <a class="code" href="../../d2/d9/pinsup_8c.html#a4">CcPinRead</a>
01009     or <a class="code" href="../../d2/d9/pinsup_8c.html#a5">CcPreparePinWrite</a>.  It performs any cleanup that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary.
01010 
01011 Arguments:
01012 
01013     Bcb - Bcb parameter returned from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last call to <a class="code" href="../../d2/d9/pinsup_8c.html#a4">CcPinRead</a>.
01014 
01015 Return Value:
01016 
01017     None.
01018 
01019 --*/
01020 
01021 {
01022     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, me, <span class="stringliteral">"CcUnpinData:\n"</span>, 0 );
01023     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, me, <span class="stringliteral">"    &gt;Bcb = %08lx\n"</span>, Bcb );
01024 
01025     <span class="comment">//</span>
01026     <span class="comment">//  Test for ReadOnly and unpin accordingly.</span>
01027     <span class="comment">//</span>
01028 
01029     <span class="keywordflow">if</span> (((ULONG_PTR)Bcb &amp; 1) != 0) {
01030 
01031         <span class="comment">//</span>
01032         <span class="comment">//  Remove the Read Only flag</span>
01033         <span class="comment">//</span>
01034 
01035         (PCHAR)Bcb -= 1;
01036 
01037         <a class="code" href="../../d5/d5/cc_8h.html#a176">CcUnpinFileData</a>( (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)Bcb, TRUE, UNPIN );
01038 
01039     } <span class="keywordflow">else</span> {
01040 
01041         <span class="comment">//</span>
01042         <span class="comment">//  Handle the overlapped Bcb case.</span>
01043         <span class="comment">//</span>
01044 
01045         <span class="keywordflow">if</span> (((<a class="code" href="../../d6/d4/struct__OBCB.html">POBCB</a>)Bcb)-&gt;NodeTypeCode == <a class="code" href="../../d5/d5/cc_8h.html#a17">CACHE_NTC_OBCB</a>) {
01046 
01047             <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *BcbPtrPtr = &amp;((<a class="code" href="../../d6/d4/struct__OBCB.html">POBCB</a>)Bcb)-&gt;Bcbs[0];
01048 
01049             <span class="comment">//</span>
01050             <span class="comment">//  Loop to free all Bcbs with recursive calls</span>
01051             <span class="comment">//  (rather than dealing with RO for this uncommon case).</span>
01052             <span class="comment">//</span>
01053 
01054             <span class="keywordflow">while</span> (*BcbPtrPtr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01055                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>(*(BcbPtrPtr++));
01056             }
01057 
01058             <span class="comment">//</span>
01059             <span class="comment">//  Then free the pool for the Obcb</span>
01060             <span class="comment">//</span>
01061 
01062             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Bcb );
01063 
01064         <span class="comment">//</span>
01065         <span class="comment">//  Otherwise, it is a normal Bcb</span>
01066         <span class="comment">//</span>
01067 
01068         } <span class="keywordflow">else</span> {
01069             <a class="code" href="../../d5/d5/cc_8h.html#a176">CcUnpinFileData</a>( (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)Bcb, FALSE, UNPIN );
01070         }
01071     }
01072 
01073     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, me, <span class="stringliteral">"CcUnPinData -&gt; VOID\n"</span>, 0 );
01074 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="pinsup.c::CcUnpinDataForThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CcUnpinDataForThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Bcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a121">ERESOURCE_THREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceThreadId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01142">1142</a> of file <a class="el" href="../../d3/d8/pinsup_8c-source.html">pinsup.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00158">CACHE_NTC_OBCB</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00974">CcUnpinFileData()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02476">ExReleaseResourceForThread</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00033">me</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d5/cc_8h.html#a211a171">UNPIN</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/lfs_2registry_8c-source.html#l00706">LfsCloseLogFile()</a>, and <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00551">LfsFlushLfcb()</a>.
<p>
<pre class="fragment"><div>01149                    :
01150 
01151     This routine must be called at IPL0, some time after calling <a class="code" href="../../d2/d9/pinsup_8c.html#a4">CcPinRead</a>
01152     or <a class="code" href="../../d2/d9/pinsup_8c.html#a5">CcPreparePinWrite</a>.  It performs any cleanup that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> necessary,
01153     releasing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Bcb resource <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given thread.
01154 
01155 Arguments:
01156 
01157     Bcb - Bcb parameter returned from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last call to <a class="code" href="../../d2/d9/pinsup_8c.html#a4">CcPinRead</a>.
01158 
01159 Return Value:
01160 
01161     None.
01162 
01163 --*/
01164 
01165 {
01166     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, me, <span class="stringliteral">"CcUnpinDataForThread:\n"</span>, 0 );
01167     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, me, <span class="stringliteral">"    &gt;Bcb = %08lx\n"</span>, Bcb );
01168     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, me, <span class="stringliteral">"    &gt;ResoureceThreadId = %08lx\n"</span>, ResoureceThreadId );
01169 
01170     <span class="comment">//</span>
01171     <span class="comment">//  Test for ReadOnly and unpin accordingly.</span>
01172     <span class="comment">//</span>
01173 
01174     <span class="keywordflow">if</span> (((ULONG_PTR)Bcb &amp; 1) != 0) {
01175 
01176         <span class="comment">//</span>
01177         <span class="comment">//  Remove the Read Only flag</span>
01178         <span class="comment">//</span>
01179 
01180         (PCHAR)Bcb -= 1;
01181 
01182         <a class="code" href="../../d5/d5/cc_8h.html#a176">CcUnpinFileData</a>( (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)Bcb, TRUE, UNPIN );
01183 
01184     } <span class="keywordflow">else</span> {
01185 
01186         <span class="comment">//</span>
01187         <span class="comment">//  Handle the overlapped Bcb case.</span>
01188         <span class="comment">//</span>
01189 
01190         <span class="keywordflow">if</span> (((<a class="code" href="../../d6/d4/struct__OBCB.html">POBCB</a>)Bcb)-&gt;NodeTypeCode == <a class="code" href="../../d5/d5/cc_8h.html#a17">CACHE_NTC_OBCB</a>) {
01191 
01192             <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *BcbPtrPtr = &amp;((<a class="code" href="../../d6/d4/struct__OBCB.html">POBCB</a>)Bcb)-&gt;Bcbs[0];
01193 
01194             <span class="comment">//</span>
01195             <span class="comment">//  Loop to free all Bcbs with recursive calls</span>
01196             <span class="comment">//  (rather than dealing with RO for this uncommon case).</span>
01197             <span class="comment">//</span>
01198 
01199             <span class="keywordflow">while</span> (*BcbPtrPtr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01200                 <a class="code" href="../../d4/d2/cache_8h.html#a94">CcUnpinDataForThread</a>( *(BcbPtrPtr++), ResourceThreadId );
01201             }
01202 
01203             <span class="comment">//</span>
01204             <span class="comment">//  Then free the pool for the Obcb</span>
01205             <span class="comment">//</span>
01206 
01207             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Bcb );
01208 
01209         <span class="comment">//</span>
01210         <span class="comment">//  Otherwise, it is a normal Bcb</span>
01211         <span class="comment">//</span>
01212 
01213         } <span class="keywordflow">else</span> {
01214 
01215             <span class="comment">//</span>
01216             <span class="comment">//  If not readonly, we can release the resource for the thread first,</span>
01217             <span class="comment">//  and then call CcUnpinFileData.  Release resource first in case</span>
01218             <span class="comment">//  Bcb gets deallocated.</span>
01219             <span class="comment">//</span>
01220 
01221             <a class="code" href="../../d5/d8/ex_8h.html#a71">ExReleaseResourceForThread</a>( &amp;((<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)Bcb)-&gt;Resource, ResourceThreadId );
01222             <a class="code" href="../../d5/d5/cc_8h.html#a176">CcUnpinFileData</a>( (<a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a>)Bcb, TRUE, UNPIN );
01223         }
01224     }
01225     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, me, <span class="stringliteral">"CcUnpinDataForThread -&gt; VOID\n"</span>, 0 );
01226 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:09 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
