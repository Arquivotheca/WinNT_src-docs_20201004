<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rtlinit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>rtlinit.c</h1><a href="../../d1/d2/rtlinit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: rtlinit.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains all the init code for the USERRTL.DLL.  When the DLL is</span>
00007 <span class="comment">* dynlinked its initialization procedure (UserRtlDllInitialize) is called by</span>
00008 <span class="comment">* the loader.</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* History:</span>
00011 <span class="comment">* 14-Jan-1991 mikeke</span>
00012 <span class="comment">\***************************************************************************/</span>
00013 
<a name="l00014"></a><a class="code" href="../../d1/d2/rtlinit_8c.html#a0">00014</a> <span class="preprocessor">#define MOVE_TO_RTL</span>
00015 <span class="preprocessor"></span>
00016 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00017 <span class="preprocessor">#pragma hdrstop</span>
00018 <span class="preprocessor"></span><span class="preprocessor">#include "ntimage.h"</span>
00019 
00020 
00021 <span class="comment">/**************************************************************************\</span>
00022 <span class="comment">* RtlCaptureAnsiString</span>
00023 <span class="comment">*</span>
00024 <span class="comment">* Converts a NULL-terminated ANSI string into a counted</span>
00025 <span class="comment">* unicode string.</span>
00026 <span class="comment">*</span>
00027 <span class="comment">* 03-22-95 JimA         Created.</span>
00028 <span class="comment">\**************************************************************************/</span>
00029 
<a name="l00030"></a><a class="code" href="../../d6/d0/usercli_8h.html#a429">00030</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a429">RtlCaptureAnsiString</a>(
00031     <a class="code" href="../../d8/d1/struct__IN__STRING.html">PIN_STRING</a> pstr,
00032     LPCSTR psz,
00033     BOOL fForceAlloc)
00034 {
00035     <span class="keywordtype">int</span> cbSrc;
00036     <span class="keywordtype">int</span> cbDst;
00037 
00038     pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00039     <span class="keywordflow">if</span> (psz) {
00040         cbSrc = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(psz) + 1;
00041         <span class="keywordflow">if</span> (cbSrc &gt; MAXUSHORT) {
00042             RIPMSG0(RIP_WARNING, <span class="stringliteral">"String too long for standard string"</span>);
00043             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00044         }
00045 
00046         <span class="comment">/*</span>
00047 <span class="comment">         * If the allocation is forced or if the string is</span>
00048 <span class="comment">         * too long to fit in the TEB, allocate a buffer.</span>
00049 <span class="comment">         * Otherwise, store the result in the TEB.</span>
00050 <span class="comment">         */</span>
00051         <span class="keywordflow">if</span> (fForceAlloc ||
00052                 cbSrc &gt; (STATIC_UNICODE_BUFFER_LENGTH / <span class="keyword">sizeof</span>(WCHAR))) {
00053             pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>.Buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a11">pUserHeap</a>,
00054                     0, cbSrc * <span class="keyword">sizeof</span>(WCHAR));
00055             <span class="keywordflow">if</span> (pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00056                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00057             pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00058             pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a> = &amp;pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>;
00059             pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(cbSrc * <span class="keyword">sizeof</span>(WCHAR));
00060         } <span class="keywordflow">else</span> {
00061             pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a> = &amp;NtCurrentTeb()-&gt;StaticUnicodeString;
00062         }
00063 
00064         <span class="comment">/*</span>
00065 <span class="comment">         * Convert the string to Unicode</span>
00066 <span class="comment">         */</span>
00067         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d6/nlsxlat_8c.html#a33">RtlMultiByteToUnicodeN</a>(pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>-&gt;Buffer,
00068                 (ULONG)pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>-&gt;MaximumLength, &amp;cbDst,
00069                 (LPSTR)psz, cbSrc)) {
00070             RIPMSG0(RIP_WARNING, <span class="stringliteral">"Unicode conversion failed"</span>);
00071             <span class="keywordflow">if</span> (pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a>) {
00072                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a11">pUserHeap</a>, 0, pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>.Buffer);
00073                 pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00074             }
00075             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00076         }
00077         pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)cbDst - <span class="keyword">sizeof</span>(WCHAR);
00078     } <span class="keywordflow">else</span> {
00079         pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a> = &amp;pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>;
00080         pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>.Length = pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>.MaximumLength = 0;
00081         pstr-&gt;<a class="code" href="../../d8/d1/struct__IN__STRING.html#o0">strCapture</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00082     }
00083     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00084 }
00085 
00086 <span class="comment">/**************************************************************************\</span>
00087 <span class="comment">* RtlCaptureLargeAnsiString</span>
00088 <span class="comment">*</span>
00089 <span class="comment">* Captures a large ANSI string in the same manner as</span>
00090 <span class="comment">* RtlCaptureAnsiString.</span>
00091 <span class="comment">*</span>
00092 <span class="comment">* 03-22-95 JimA         Created.</span>
00093 <span class="comment">\**************************************************************************/</span>
00094 
<a name="l00095"></a><a class="code" href="../../d6/d0/usercli_8h.html#a430">00095</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a430">RtlCaptureLargeAnsiString</a>(
00096     <a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html">PLARGE_IN_STRING</a> plstr,
00097     LPCSTR psz,
00098     BOOL fForceAlloc)
00099 {
00100     <span class="keywordtype">int</span> cchSrc;
00101     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uLength;
00102 
00103     plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00104     plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o1">pstr</a> = &amp;plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>;
00105 
00106     <span class="keywordflow">if</span> (psz) {
00107         cchSrc = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(psz) + 1;
00108 
00109         <span class="comment">/*</span>
00110 <span class="comment">         * If the allocation is forced or if the string is</span>
00111 <span class="comment">         * too long to fit in the TEB, allocate a buffer.</span>
00112 <span class="comment">         * Otherwise, store the result in the TEB.</span>
00113 <span class="comment">         */</span>
00114         <span class="keywordflow">if</span> (fForceAlloc || cchSrc &gt; STATIC_UNICODE_BUFFER_LENGTH) {
00115             plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a> = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a11">pUserHeap</a>,
00116                     0, cchSrc * <span class="keyword">sizeof</span>(WCHAR));
00117             <span class="keywordflow">if</span> (plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00118                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00119             plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00120             plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o1">MaximumLength</a> = cchSrc * <span class="keyword">sizeof</span>(WCHAR);
00121         } <span class="keywordflow">else</span> {
00122             plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a> = NtCurrentTeb()-&gt;StaticUnicodeBuffer;
00123             plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o1">MaximumLength</a> =
00124                     (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(STATIC_UNICODE_BUFFER_LENGTH * <span class="keyword">sizeof</span>(WCHAR));
00125         }
00126 
00127         <span class="comment">/*</span>
00128 <span class="comment">         * Convert the string to Unicode</span>
00129 <span class="comment">         */</span>
00130         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d6/nlsxlat_8c.html#a33">RtlMultiByteToUnicodeN</a>(plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o1">pstr</a>-&gt;<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a>,
00131                 plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o1">pstr</a>-&gt;<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o1">MaximumLength</a>, &amp;uLength,
00132                 (LPSTR)psz, cchSrc)) {
00133             RIPMSG0(RIP_WARNING, <span class="stringliteral">"Unicode conversion failed"</span>);
00134             <span class="keywordflow">if</span> (plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o2">fAllocated</a>) {
00135                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(<a class="code" href="../../d1/d8/clglobal_8c.html#a11">pUserHeap</a>, 0, plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a>);
00136                 plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00137             }
00138             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00139         }
00140         plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o1">pstr</a>-&gt;<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> = uLength - <span class="keyword">sizeof</span>(WCHAR);
00141     } <span class="keywordflow">else</span> {
00142         plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> = plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o1">MaximumLength</a> = 0;
00143         plstr-&gt;<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>.<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00144     }
00145     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00146 }
00147 
00148 <span class="comment">//++</span>
00149 <span class="comment">//</span>
00150 <span class="comment">// PVOID</span>
00151 <span class="comment">// AllocateFromZone(</span>
00152 <span class="comment">//     IN PZONE_HEADER Zone</span>
00153 <span class="comment">//     )</span>
00154 <span class="comment">//</span>
00155 <span class="comment">// Routine Description:</span>
00156 <span class="comment">//</span>
00157 <span class="comment">//     This routine removes an entry from the zone and returns a pointer to it.</span>
00158 <span class="comment">//</span>
00159 <span class="comment">// Arguments:</span>
00160 <span class="comment">//</span>
00161 <span class="comment">//     Zone - Pointer to the zone header controlling the storage from which the</span>
00162 <span class="comment">//         entry is to be allocated.</span>
00163 <span class="comment">//</span>
00164 <span class="comment">// Return Value:</span>
00165 <span class="comment">//</span>
00166 <span class="comment">//     The function value is a pointer to the storage allocated from the zone.</span>
00167 <span class="comment">//</span>
00168 <span class="comment">/***************************************************************************\</span>
00169 <span class="comment">\***************************************************************************/</span>
00170 
<a name="l00171"></a><a class="code" href="../../d1/d2/rtlinit_8c.html#a1">00171</a> <span class="preprocessor">#define AllocateFromZone(Zone) \</span>
00172 <span class="preprocessor">    (PVOID)((Zone)-&gt;FreeList.Next); \</span>
00173 <span class="preprocessor">    if ( (Zone)-&gt;FreeList.Next ) (Zone)-&gt;FreeList.Next = (Zone)-&gt;FreeList.Next-&gt;Next</span>
00174 <span class="preprocessor"></span>
00175 
00176 <span class="comment">//++</span>
00177 <span class="comment">//</span>
00178 <span class="comment">// PVOID</span>
00179 <span class="comment">// FreeToZone(</span>
00180 <span class="comment">//     IN PZONE_HEADER Zone,</span>
00181 <span class="comment">//     IN PVOID Block</span>
00182 <span class="comment">//     )</span>
00183 <span class="comment">//</span>
00184 <span class="comment">// Routine Description:</span>
00185 <span class="comment">//</span>
00186 <span class="comment">//     This routine places the specified block of storage back onto the free</span>
00187 <span class="comment">//     list in the specified zone.</span>
00188 <span class="comment">//</span>
00189 <span class="comment">// Arguments:</span>
00190 <span class="comment">//</span>
00191 <span class="comment">//     Zone - Pointer to the zone header controlling the storage to which the</span>
00192 <span class="comment">//         entry is to be inserted.</span>
00193 <span class="comment">//</span>
00194 <span class="comment">//     Block - Pointer to the block of storage to be freed back to the zone.</span>
00195 <span class="comment">//</span>
00196 <span class="comment">// Return Value:</span>
00197 <span class="comment">//</span>
00198 <span class="comment">//     Pointer to previous block of storage that was at the head of the free</span>
00199 <span class="comment">//         list.  NULL implies the zone went from no available free blocks to</span>
00200 <span class="comment">//         at least one free block.</span>
00201 <span class="comment">//</span>
00202 <span class="comment">/***************************************************************************\</span>
00203 <span class="comment">\***************************************************************************/</span>
00204 
<a name="l00205"></a><a class="code" href="../../d1/d2/rtlinit_8c.html#a2">00205</a> <span class="preprocessor">#define FreeToZone(Zone,Block)                                    \</span>
00206 <span class="preprocessor">    ( ((PSINGLE_LIST_ENTRY)(Block))-&gt;Next = (Zone)-&gt;FreeList.Next,  \</span>
00207 <span class="preprocessor">      (Zone)-&gt;FreeList.Next = ((PSINGLE_LIST_ENTRY)(Block)),        \</span>
00208 <span class="preprocessor">      ((PSINGLE_LIST_ENTRY)(Block))-&gt;Next                           \</span>
00209 <span class="preprocessor">    )</span>
00210 <span class="preprocessor"></span>
00211 <span class="comment">/***************************************************************************\</span>
00212 <span class="comment">* InitLookaside</span>
00213 <span class="comment">*</span>
00214 <span class="comment">* Initializes the lookaside list. This improves control locality</span>
00215 <span class="comment">* by keeping control entries in a single page</span>
00216 <span class="comment">*</span>
00217 <span class="comment">* 05-04-95 JimA         Created.</span>
00218 <span class="comment">\***************************************************************************/</span>
00219 
00220 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00221"></a><a class="code" href="../../d6/d0/usercli_8h.html#a406">00221</a> <a class="code" href="../../d6/d0/usercli_8h.html#a406">InitLookaside</a>(
00222     <a class="code" href="../../d2/d4/struct__LOOKASIDE.html">PLOOKASIDE</a> pla,
00223     DWORD cbEntry,
00224     DWORD cEntries)
00225 {
00226     ULONG i;
00227     PCH p;
00228     ULONG <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>;
00229     <a class="code" href="../../d0/d0/struct__ZONE__HEADER.html">PZONE_HEADER</a> Zone;
00230     PVOID InitialSegment;
00231     ULONG InitialSegmentSize;
00232 
00233     InitialSegmentSize = (cEntries * cbEntry) + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">ZONE_SEGMENT_HEADER</a>);
00234 
00235     p = (PCH)<a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, InitialSegmentSize);
00236 
00237     <span class="keywordflow">if</span> ( !p ) {
00238         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00239         }
00240 
00241     RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a22">gcsLookaside</a>);
00242 
00243     <span class="comment">//</span>
00244     <span class="comment">// If the lookaside list has already been initialized, we're done.</span>
00245     <span class="comment">//</span>
00246 
00247     <span class="keywordflow">if</span> (pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o0">LookasideBase</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o3">EntrySize</a> == cbEntry) {
00248         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a22">gcsLookaside</a>);
00249         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(p);
00250         <span class="keywordflow">return</span> STATUS_SUCCESS;
00251     }
00252 
00253     pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o0">LookasideBase</a> = (PVOID)p;
00254     pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o1">LookasideBounds</a> = (PVOID)(p + InitialSegmentSize);
00255     pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o3">EntrySize</a> = cbEntry;
00256 
00257     <span class="comment">//</span>
00258     <span class="comment">// Using the ExZone-like code, slice up the page into QMSG's</span>
00259     <span class="comment">//</span>
00260 
00261     Zone = &amp;pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o2">LookasideZone</a>;
00262     <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a> = cbEntry;
00263     InitialSegment = pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o0">LookasideBase</a>;
00264 
00265     Zone-&gt;<a class="code" href="../../d0/d0/struct__ZONE__HEADER.html#o2">BlockSize</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>;
00266 
00267     Zone-&gt;<a class="code" href="../../d0/d0/struct__ZONE__HEADER.html#o1">SegmentList</a>.Next = &amp;((<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">PZONE_SEGMENT_HEADER</a>) InitialSegment)-&gt;SegmentList;
00268     ((<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">PZONE_SEGMENT_HEADER</a>) InitialSegment)-&gt;SegmentList.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00269     ((<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">PZONE_SEGMENT_HEADER</a>) InitialSegment)-&gt;Reserved = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00270 
00271     Zone-&gt;<a class="code" href="../../d0/d0/struct__ZONE__HEADER.html#o0">FreeList</a>.Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00272 
00273     p = (PCH)InitialSegment + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">ZONE_SEGMENT_HEADER</a>);
00274 
00275     <span class="keywordflow">for</span> (i = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/struct__ZONE__SEGMENT__HEADER.html">ZONE_SEGMENT_HEADER</a>);
00276          i &lt;= InitialSegmentSize - <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>;
00277          i += <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>
00278         ) {
00279         ((PSINGLE_LIST_ENTRY)p)-&gt;Next = Zone-&gt;<a class="code" href="../../d0/d0/struct__ZONE__HEADER.html#o0">FreeList</a>.Next;
00280         Zone-&gt;<a class="code" href="../../d0/d0/struct__ZONE__HEADER.html#o0">FreeList</a>.Next = (PSINGLE_LIST_ENTRY)p;
00281         p += <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>;
00282     }
00283     Zone-&gt;<a class="code" href="../../d0/d0/struct__ZONE__HEADER.html#o3">TotalSegmentSize</a> = i;
00284 
00285     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a22">gcsLookaside</a>);
00286 
00287     <span class="keywordflow">return</span> STATUS_SUCCESS;
00288 
00289 }
00290 
00291 <span class="comment">/***************************************************************************\</span>
00292 <span class="comment">* AllocLookasideEntry</span>
00293 <span class="comment">*</span>
00294 <span class="comment">* Allocates an entry from the lookaside list.</span>
00295 <span class="comment">*</span>
00296 <span class="comment">* 05-04-95 JimA         Created.</span>
00297 <span class="comment">\***************************************************************************/</span>
00298 
<a name="l00299"></a><a class="code" href="../../d6/d0/usercli_8h.html#a407">00299</a> PVOID <a class="code" href="../../d6/d0/usercli_8h.html#a407">AllocLookasideEntry</a>(
00300     <a class="code" href="../../d2/d4/struct__LOOKASIDE.html">PLOOKASIDE</a> pla)
00301 {
00302     PVOID pEntry;
00303 
00304     <span class="comment">//</span>
00305     <span class="comment">// Attempt to get an entry from the zone. If this fails, then</span>
00306     <span class="comment">// LocalAlloc the entry</span>
00307     <span class="comment">//</span>
00308 
00309     RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a22">gcsLookaside</a>);
00310     pEntry = <a class="code" href="../../d1/d2/rtlinit_8c.html#a1">AllocateFromZone</a>(&amp;pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o2">LookasideZone</a>);
00311     RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a22">gcsLookaside</a>);
00312 
00313     <span class="keywordflow">if</span> ( !pEntry ) {
00314 
00315         <span class="comment">/*</span>
00316 <span class="comment">         * Allocate a local structure.</span>
00317 <span class="comment">         */</span>
00318 <span class="preprocessor">#if DBG</span>
00319 <span class="preprocessor"></span>        pla-&gt;AllocSlowCalls++;
00320 <span class="preprocessor">#endif // DBG</span>
00321 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((pEntry = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o3">EntrySize</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00322             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00323         }
00324     RtlZeroMemory(pEntry, pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o3">EntrySize</a>);
00325 <span class="preprocessor">#if DBG</span>
00326 <span class="preprocessor"></span>    pla-&gt;AllocCalls++;
00327 
00328     <span class="keywordflow">if</span> (pla-&gt;AllocCalls - pla-&gt;DelCalls &gt; pla-&gt;AllocHiWater ) {
00329         pla-&gt;AllocHiWater = pla-&gt;AllocCalls - pla-&gt;DelCalls;
00330         }
00331 <span class="preprocessor">#endif // DBG</span>
00332 <span class="preprocessor"></span>
00333     <span class="keywordflow">return</span> pEntry;
00334 }
00335 
00336 <span class="comment">/***************************************************************************\</span>
00337 <span class="comment">* FreeLookasideEntry</span>
00338 <span class="comment">*</span>
00339 <span class="comment">* Returns a qmsg to the lookaside buffer or free the memory.</span>
00340 <span class="comment">*</span>
00341 <span class="comment">* 05-04-95 JimA         Created.</span>
00342 <span class="comment">\***************************************************************************/</span>
00343 
<a name="l00344"></a><a class="code" href="../../d6/d0/usercli_8h.html#a408">00344</a> <span class="keywordtype">void</span> <a class="code" href="../../d6/d0/usercli_8h.html#a408">FreeLookasideEntry</a>(
00345     <a class="code" href="../../d2/d4/struct__LOOKASIDE.html">PLOOKASIDE</a> pla,
00346     PVOID pEntry)
00347 {
00348 <span class="preprocessor">#if DBG</span>
00349 <span class="preprocessor"></span>    pla-&gt;DelCalls++;
00350 <span class="preprocessor">#endif // DBG</span>
00351 <span class="preprocessor"></span>
00352     <span class="comment">//</span>
00353     <span class="comment">// If the pEntry was from zone, then free to zone</span>
00354     <span class="comment">//</span>
00355     <span class="keywordflow">if</span> ( (PVOID)pEntry &gt;= pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o0">LookasideBase</a> &amp;&amp; (PVOID)pEntry &lt; pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o1">LookasideBounds</a> ) {
00356         RtlEnterCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a22">gcsLookaside</a>);
00357         <a class="code" href="../../d1/d2/rtlinit_8c.html#a2">FreeToZone</a>(&amp;pla-&gt;<a class="code" href="../../d2/d4/struct__LOOKASIDE.html#o2">LookasideZone</a>,pEntry);
00358         RtlLeaveCriticalSection(&amp;<a class="code" href="../../d1/d8/clglobal_8c.html#a22">gcsLookaside</a>);
00359     } <span class="keywordflow">else</span> {
00360 <span class="preprocessor">#if DBG</span>
00361 <span class="preprocessor"></span>        pla-&gt;DelSlowCalls++;
00362 <span class="preprocessor">#endif // DBG</span>
00363 <span class="preprocessor"></span>        <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pEntry);
00364     }
00365 }
00366 
00367 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:41 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
