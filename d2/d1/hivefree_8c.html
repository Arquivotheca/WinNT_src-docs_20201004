<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hivefree.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hivefree.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d3/d0/hivefree_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/hivefree_8c.html#a0">HvFreeHive</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/hivefree_8c.html#a1">HvFreeHivePartial</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a> Type)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="hivefree.c::HvFreeHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvFreeHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">34</a> of file <a class="el" href="../../d3/d0/hivefree_8c-source.html">hivefree.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00249">CML_BIN</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00269">CMS_BIN_MAP</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00609">_HHIVE::DirtyAlloc</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00346">_HBASE_BLOCK::FileName</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00589">_FREE_HBIN::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00616">_HHIVE::Flat</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00583">FREE_HBIN_DISCARDABLE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00111">HCELL_TYPE_MASK</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00414">HMAP_DISCARDABLE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00413">HMAP_NEWALLOC</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00132">HTABLE_SLOTS</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00807">HvpFreeMap()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00200">_HBIN::MemAlloc</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00587">_FREE_HBIN::Size</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cmsavres_8c-source.html#l01490">CmpDestroyTemporaryHive()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04077">CmpValidateAlternate()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02293">CmReplaceKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l02079">CmUnloadKey()</a>.
<p>
<pre class="fragment"><div>00039                    :
00040 
00041     Free all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pieces of a hive.
00042 
00043 Arguments:
00044 
00045     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive to free.
00046             <span class="keyword">this</span> structure itself will NOT be freed, but everything <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00047             points to will.
00048 
00049 Return Value:
00050 
00051     NONE.
00052 
00053 --*/
00054 {
00055     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> Dir;
00056     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00057     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     Address;
00058     ULONG           Type;
00059     ULONG           Length;
00060     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00061     ULONG           Tables;
00062     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>      FreeBin;
00063 
00064     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> == FALSE);
00065     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00066     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Stable == 0);
00067     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Volatile == 1);
00068 
00069     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BIN, CMS_BIN_MAP) {
00070         KdPrint((<span class="stringliteral">"HvFreeHive(%ws) :\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o11">FileName</a>));
00071     }
00072     <span class="comment">//</span>
00073     <span class="comment">// Iterate through both types of storage</span>
00074     <span class="comment">//</span>
00075     <span class="keywordflow">for</span> (Type = 0; Type &lt;= <a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>; Type++) {
00076 
00077         Address = <a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a> * Type;
00078         Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length + (<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a> * Type);
00079 
00080         <span class="keywordflow">if</span> (Length &gt; (<a class="code" href="../../d0/d1/hivedata_8h.html#a7">HCELL_TYPE_MASK</a> * Type)) {
00081 
00082             <span class="comment">//</span>
00083             <span class="comment">// Sweep through bin set</span>
00084             <span class="comment">//</span>
00085             <span class="keywordflow">do</span> {
00086                 Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Address);
00087                 <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Address);
00088                 <span class="keywordflow">if</span> (Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) {
00089                     <span class="comment">//</span>
00090                     <span class="comment">// hbin is either discarded or discardable, check the tombstone</span>
00091                     <span class="comment">//</span>
00092                     FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
00093                     Address += FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>;
00094                     <span class="keywordflow">if</span> (FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>) {
00095                         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>((<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; HMAP_BASE), FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>);
00096                     }
00097                     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(FreeBin, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>));
00098                 } <span class="keywordflow">else</span> {
00099                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00100                     Address += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>;
00101 <span class="preprocessor">#if DBG</span>
00102 <span class="preprocessor"></span>                    <span class="comment">//</span>
00103                     <span class="comment">// Make sure that the next bin in the list is</span>
00104                     <span class="comment">// actually the start of an alloc before freeing it</span>
00105                     <span class="comment">//</span>
00106                     <span class="keywordflow">if</span> (Address &lt; Length) {
00107                         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Address);
00108                         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Address);
00109                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; HMAP_NEWALLOC);
00110                     }
00111 <span class="preprocessor">#endif</span>
00112 <span class="preprocessor"></span>
00113                     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BIN, CMS_BIN_MAP) {
00114                         <span class="keywordflow">if</span>( Type == <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a> ) {
00115                             KdPrint((<span class="stringliteral">"HvFreeHive: BinAddress = 0x%08lx\t Size = 0x%lx\n"</span>, Bin, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>));
00116                         }
00117                     }
00118 
00119                     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(Bin, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>);
00120                 }
00121 
00122             } <span class="keywordflow">while</span> (Address &lt; Length);
00123 
00124             <span class="comment">//</span>
00125             <span class="comment">// Free map table storage</span>
00126             <span class="comment">//</span>
00127             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length != (HCELL_TYPE_MASK * Type));
00128             Tables = (((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length) / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>)-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00129             Dir = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Map;
00130             <a class="code" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a>(Hive, Dir, 0, Tables);
00131 
00132             <span class="keywordflow">if</span> (Tables &gt; 0) {
00133                 <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Map, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">HMAP_DIRECTORY</a>));  <span class="comment">// free dir if it exists</span>
00134             }
00135         }
00136         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length = 0;
00137     }
00138 
00139     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BIN, CMS_BIN_MAP) {
00140         KdPrint((<span class="stringliteral">"\n"</span>));
00141     }
00142     <span class="comment">//</span>
00143     <span class="comment">// Free the base block</span>
00144     <span class="comment">//</span>
00145     (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00146     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">// Free the dirty vector</span>
00150     <span class="comment">//</span>
00151     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00152         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>((PVOID)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.Buffer), <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o11">DirtyAlloc</a>);
00153     }
00154 
00155     <span class="keywordflow">return</span>;
00156 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="hivefree.c::HvFreeHivePartial" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvFreeHivePartial           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Start</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a77">HSTORAGE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00160">160</a> of file <a class="el" href="../../d3/d0/hivefree_8c-source.html">hivefree.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00417">_HMAP_ENTRY::BlockAddress</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00265">CmpReleaseGlobalQuota()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00589">_FREE_HBIN::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00616">_HHIVE::Flat</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00583">FREE_HBIN_DISCARDABLE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00111">HCELL_TYPE_MASK</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00414">HMAP_DISCARDABLE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00132">HTABLE_SLOTS</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00807">HvpFreeMap()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00285">HvpGetCellMap()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00586">_FREE_HBIN::ListEntry</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00200">_HBIN::MemAlloc</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01508">RtlClearBits()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00587">_FREE_HBIN::Size</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00049">Start</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00378">VALIDATE_CELL_MAP</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01946">HvpTruncateBins()</a>, and <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01584">HvRefreshHive()</a>.
<p>
<pre class="fragment"><div>00167                    :
00168 
00169     Free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory and associated maps <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of a hive
00170     starting at <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>.  The baseblock, hive, etc will not be touched.
00171 
00172 Arguments:
00173 
00174     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive to
00175             partially free.
00176 
00177     <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> of first bin to free, will free from <span class="keyword">this</span>
00178             bin (inclusive) to the end of the hives stable storage.
00179 
00180     Type - Type of storage (Stable or Volatile) to be freed.
00181 
00182 Return Value:
00183 
00184     NONE.
00185 
00186 --*/
00187 {
00188     <a class="code" href="../../d1/d8/struct__HMAP__DIRECTORY.html">PHMAP_DIRECTORY</a> Dir;
00189     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00190     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     Address;
00191     ULONG           StartTable;
00192     ULONG           Length;
00193     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00194     ULONG           Tables;
00195     ULONG           FirstBit;
00196     ULONG           LastBit;
00197     <a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>      FreeBin;
00198 
00199     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> == FALSE);
00200     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> == FALSE);
00201 
00202     Address = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00203     Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length;
00204     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Address &lt;= Length);
00205 
00206     <span class="keywordflow">if</span> (Address == Length) {
00207         <span class="keywordflow">return</span>;
00208     }
00209 
00210     <span class="comment">//</span>
00211     <span class="comment">// Sweep through bin set</span>
00212     <span class="comment">//</span>
00213     <span class="keywordflow">do</span> {
00214         Me = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, Address + (Type*HCELL_TYPE_MASK));
00215         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,Me,Hive,Address + (Type*HCELL_TYPE_MASK));
00216         <span class="keywordflow">if</span> (Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a36">HMAP_DISCARDABLE</a>) {
00217             FreeBin = (<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">PFREE_HBIN</a>)Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o0">BlockAddress</a>;
00218             <span class="keywordflow">if</span> (FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a48">FREE_HBIN_DISCARDABLE</a>) {
00219                 <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>((PVOID)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; HMAP_BASE), FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>);
00220             } <span class="keywordflow">else</span> {
00221                 <span class="comment">//</span>
00222                 <span class="comment">// The bin has been freed, but quota is still charged.</span>
00223                 <span class="comment">// Since the file will now shrink, the quota must be</span>
00224                 <span class="comment">// returned here.</span>
00225                 <span class="comment">//</span>
00226                 <a class="code" href="../../d1/d2/cmp_8h.html#a248">CmpReleaseGlobalQuota</a>(FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>);
00227             }
00228             RemoveEntryList(&amp;FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o0">ListEntry</a>);
00229             Address += FreeBin-&gt;<a class="code" href="../../d6/d0/struct__FREE__HBIN.html#o1">Size</a>;
00230             <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(FreeBin, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d0/struct__FREE__HBIN.html">FREE_HBIN</a>));
00231 
00232         } <span class="keywordflow">else</span> {
00233             <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00234 
00235             Address += <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>;
00236             <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(Bin, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>);
00237         }
00238     } <span class="keywordflow">while</span> (Address &lt; Length);
00239 
00240     <span class="comment">//</span>
00241     <span class="comment">// Free map table storage</span>
00242     <span class="comment">//</span>
00243     Tables = (((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length) / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) - 1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00244     Dir = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Map;
00245     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &gt; 0) {
00246         StartTable = ((<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00247     } <span class="keywordflow">else</span> {
00248         StartTable = (ULONG)-1;
00249     }
00250     <a class="code" href="../../d7/d1/hivemap_8c.html#a12">HvpFreeMap</a>(Hive, Dir, StartTable+1, Tables);
00251 
00252     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Type].Length = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00253 
00254     <span class="keywordflow">if</span> (Type==<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>) {
00255         <span class="comment">//</span>
00256         <span class="comment">// Clear dirty vector for data past Hive-&gt;Storage[Stable].Length</span>
00257         <span class="comment">//</span>
00258         FirstBit = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>;
00259         LastBit = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap;
00260         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> == <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00261         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>, FirstBit, LastBit-FirstBit);
00262         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00263     }
00264 
00265     <span class="keywordflow">return</span>;
00266 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:05 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
