<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mnaccel.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mnaccel.c</h1><a href="../../d1/d2/mnaccel_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************** Module Header ********************************\</span>
00002 <span class="comment">* Module Name: mnaccel.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Keyboard Accelerator Routines</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 10-10-90 JimA       Cleanup.</span>
00010 <span class="comment">* 03-18-91 IanJa      Window revalidation added</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <span class="comment">/***************************************************************************\</span>
00017 <span class="comment">*</span>
00018 <span class="comment">*</span>
00019 <span class="comment">* History:</span>
00020 <span class="comment">\***************************************************************************/</span>
00021 
<a name="l00022"></a><a class="code" href="../../d1/d2/mnaccel_8c.html#a1">00022</a> <span class="keywordtype">int</span> <a class="code" href="../../d1/d2/mnaccel_8c.html#a1">ItemContainingSubMenu</a>(
00023     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmainMenu,
00024     ULONG_PTR wID)
00025 {
00026     <span class="keywordtype">int</span> i;
00027     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem;
00028 
00029     <span class="keywordflow">if</span> ((i = pmainMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> - 1) == -1)
00030         <span class="keywordflow">return</span> -1;
00031 
00032     pItem = &amp;pmainMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[i];
00033 
00034     <span class="comment">/*</span>
00035 <span class="comment">     * Scan through mainMenu's items (bottom up) until an item is found</span>
00036 <span class="comment">     * that either has subMenu or an ancestor of subMenu as it's drop</span>
00037 <span class="comment">     * down menu</span>
00038 <span class="comment">     */</span>
00039 
00040     <span class="comment">/*</span>
00041 <span class="comment">     * Make sure this works for new apps that set IDs for popup items that</span>
00042 <span class="comment">     * aren't the same as the HMENU_16 value of the submenu.  Accelerators</span>
00043 <span class="comment">     * for disabled items will get generated otherwise, like in Exchange.</span>
00044 <span class="comment">     */</span>
00045     <span class="keywordflow">while</span> (i &gt;= 0)
00046     {
00047         <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00048         {
00049             <span class="comment">//</span>
00050             <span class="comment">// Does this command match?</span>
00051             <span class="comment">//</span>
00052             <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o2">wID</a> == wID)
00053                 <span class="keywordflow">break</span>;
00054         }
00055         <span class="keywordflow">else</span>
00056         {
00057             <span class="comment">//</span>
00058             <span class="comment">// Does this popup match?</span>
00059             <span class="comment">//</span>
00060             <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> == (<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>)wID)
00061                 <span class="keywordflow">break</span>;
00062 
00063             <span class="comment">//</span>
00064             <span class="comment">// Go recurse through this popup and see if we have a match on</span>
00065             <span class="comment">// one of our children.</span>
00066             <span class="comment">//</span>
00067             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/mnaccel_8c.html#a1">ItemContainingSubMenu</a>(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>, wID) != -1)
00068                 <span class="keywordflow">break</span>;
00069         }
00070 
00071         i--;
00072         pItem--;
00073     }
00074 
00075     <span class="keywordflow">return</span> i;
00076 }
00077 
00078 <span class="comment">/***************************************************************************\</span>
00079 <span class="comment">* UT_FindTopLevelMenuIndex</span>
00080 <span class="comment">*</span>
00081 <span class="comment">* !</span>
00082 <span class="comment">*</span>
00083 <span class="comment">* History:</span>
00084 <span class="comment">\***************************************************************************/</span>
00085 
<a name="l00086"></a><a class="code" href="../../d1/d2/mnaccel_8c.html#a2">00086</a> <span class="keywordtype">int</span> <a class="code" href="../../d1/d2/mnaccel_8c.html#a2">UT_FindTopLevelMenuIndex</a>(
00087     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00088     UINT cmd)
00089 {
00090     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenuItemIsOn;
00091     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>  pItem;
00092 
00093     <span class="comment">/*</span>
00094 <span class="comment">     * Get a pointer to the item we are searching for.</span>
00095 <span class="comment">     */</span>
00096     pItem = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a10">MNLookUpItem</a>(pMenu, cmd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;pMenuItemIsOn);
00097     <span class="keywordflow">if</span> ((pItem == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
00098         <span class="keywordflow">return</span>(-1);
00099 
00100     <span class="comment">/*</span>
00101 <span class="comment">     * We want to search for the item that contains pMenuItemIsOn,</span>
00102 <span class="comment">     * unless this is a top-level item without a dropdown, in which</span>
00103 <span class="comment">     * case we want to search for cmd.</span>
00104 <span class="comment">     */</span>
00105     <span class="keywordflow">return</span> <a class="code" href="../../d1/d2/mnaccel_8c.html#a1">ItemContainingSubMenu</a>(pMenu,
00106                     pMenuItemIsOn != pMenu ? (ULONG_PTR)pMenuItemIsOn : cmd);
00107 }
00108 
00109 <span class="comment">/***************************************************************************\</span>
00110 <span class="comment">* xxxHiliteMenuItem</span>
00111 <span class="comment">*</span>
00112 <span class="comment">* !</span>
00113 <span class="comment">*</span>
00114 <span class="comment">* History:</span>
00115 <span class="comment">\***************************************************************************/</span>
00116 
<a name="l00117"></a><a class="code" href="../../d4/d1/userk_8h.html#a1899">00117</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1899">xxxHiliteMenuItem</a>(
00118     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00119     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00120     UINT cmd,
00121     UINT flags)
00122 {
00123 
00124     <span class="keywordflow">if</span> (!(flags &amp; MF_BYPOSITION))
00125         cmd = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d1/d2/mnaccel_8c.html#a2">UT_FindTopLevelMenuIndex</a>(pMenu, cmd);
00126 
00127     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a142">MFISPOPUP</a>))
00128         <a class="code" href="../../d4/d1/userk_8h.html#a1382">xxxMNRecomputeBarIfNeeded</a>(pwnd, pMenu);
00129 
00130     <a class="code" href="../../d4/d1/userk_8h.html#a1388">xxxMNInvertItem</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pMenu, cmd, pwnd, (flags &amp; MF_HILITE));
00131 
00132     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00133 }
00134 
00135 <span class="comment">/***************************************************************************\</span>
00136 <span class="comment">* xxxTA_AccelerateMenu</span>
00137 <span class="comment">*</span>
00138 <span class="comment">* !</span>
00139 <span class="comment">*</span>
00140 <span class="comment">* History:</span>
00141 <span class="comment">\***************************************************************************/</span>
00142 
<a name="l00143"></a><a class="code" href="../../d1/d2/mnaccel_8c.html#a0">00143</a> <span class="preprocessor">#define TA_DISABLED 1</span>
00144 <span class="preprocessor"></span>
<a name="l00145"></a><a class="code" href="../../d1/d2/mnaccel_8c.html#a4">00145</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d1/d2/mnaccel_8c.html#a4">xxxTA_AccelerateMenu</a>(
00146     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00147     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00148     UINT cmd,
00149     HMENU *phmenuInit)
00150 {
00151     <span class="keywordtype">int</span> i;
00152     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem;
00153     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fDisabledTop;
00154     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fDisabled;
00155     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> rgfItem;
00156     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenuItemIsOn;
00157 
00158     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00159     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pMenu);
00160 
00161     rgfItem = 0;
00162     <span class="keywordflow">if</span> (pMenu != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00163         <span class="keywordflow">if</span> ((i = <a class="code" href="../../d1/d2/mnaccel_8c.html#a2">UT_FindTopLevelMenuIndex</a>(pMenu, cmd)) != -1) {
00164 
00165             <span class="comment">/*</span>
00166 <span class="comment">             * 2 means we found an item</span>
00167 <span class="comment">             */</span>
00168             rgfItem = 2;
00169 
00170             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_INITMENU, (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pMenu), 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00171             <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)i &gt;= pMenu-&gt;cItems)
00172                 <span class="keywordflow">return</span> 0;
00173 
00174             pItem = &amp;pMenu-&gt;rgItems[i];
00175             <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00176                 *phmenuInit = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a449">PtoHq</a>(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>);
00177                 <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_INITMENUPOPUP, (WPARAM)*phmenuInit,
00178                         (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)i);
00179                 <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)i &gt;= pMenu-&gt;cItems)
00180                     <span class="keywordflow">return</span> 0;
00181                 fDisabledTop = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a788">TestMFS</a>(pItem,MFS_GRAYED);
00182             } <span class="keywordflow">else</span> {
00183                 fDisabledTop = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00184             }
00185 
00186             pItem = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a10">MNLookUpItem</a>(pMenu, cmd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;pMenuItemIsOn);
00187 
00188             <span class="comment">/*</span>
00189 <span class="comment">             * If the item was removed by the app in response to either of</span>
00190 <span class="comment">             * the above messages, pItem will be NULL.</span>
00191 <span class="comment">             */</span>
00192             <span class="keywordflow">if</span> (pItem == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00193                 rgfItem = 0;
00194             } <span class="keywordflow">else</span> {
00195                 fDisabled = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a788">TestMFS</a>(pItem,MFS_GRAYED);
00196 
00197                 <span class="comment">/*</span>
00198 <span class="comment">                 * This 1 bit means it's disabled or it's 'parent' is disabled.</span>
00199 <span class="comment">                 */</span>
00200                 <span class="keywordflow">if</span> (fDisabled || fDisabledTop)
00201                     rgfItem |= <a class="code" href="../../d1/d2/mnaccel_8c.html#a0">TA_DISABLED</a>;
00202             }
00203         }
00204     }
00205 
00206     <span class="keywordflow">return</span> rgfItem;
00207 }
00208 
00209 <span class="comment">/***************************************************************************\</span>
00210 <span class="comment">* _CreateAcceleratorTable</span>
00211 <span class="comment">*</span>
00212 <span class="comment">* History:</span>
00213 <span class="comment">* 05-01-91 ScottLu      Changed to work client/server</span>
00214 <span class="comment">* 02-26-91 mikeke       Created.</span>
00215 <span class="comment">\***************************************************************************/</span>
00216 
<a name="l00217"></a><a class="code" href="../../d4/d1/userk_8h.html#a1783">00217</a> HANDLE <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a> <a class="code" href="../../d4/d1/userk_8h.html#a1783">_CreateAcceleratorTable</a>(
00218     LPACCEL ccxpaccel,
00219     <span class="keywordtype">int</span> cbAccel)
00220 {
00221     <a class="code" href="../../d0/d8/structtagACCELTABLE.html">LPACCELTABLE</a> pat;
00222     <span class="keywordtype">int</span> size;
00223 
00224     size = cbAccel + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/structtagACCELTABLE.html">ACCELTABLE</a>) - <span class="keyword">sizeof</span>(ACCEL);
00225 
00226     pat = (<a class="code" href="../../d0/d8/structtagACCELTABLE.html">LPACCELTABLE</a>)<a class="code" href="../../d4/d1/userk_8h.html#a969">HMAllocObject</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a244">TYPE_ACCELTABLE</a>, size);
00227     <span class="keywordflow">if</span> (pat == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00228         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00229 
00230     <span class="keywordflow">try</span> {
00231         RtlCopyMemory(pat-&gt;<a class="code" href="../../d0/d8/structtagACCELTABLE.html#o2">accel</a>, ccxpaccel, cbAccel);
00232     } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
00233         <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pat);
00234         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00235     }
00236 
00237     pat-&gt;<a class="code" href="../../d0/d8/structtagACCELTABLE.html#o1">cAccel</a> = cbAccel / <span class="keyword">sizeof</span>(ACCEL);
00238     pat-&gt;<a class="code" href="../../d0/d8/structtagACCELTABLE.html#o2">accel</a>[pat-&gt;<a class="code" href="../../d0/d8/structtagACCELTABLE.html#o1">cAccel</a> - 1].fVirt |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a190">FLASTKEY</a>;
00239 
00240     <span class="keywordflow">return</span> pat;
00241 }
00242 
00243 <span class="comment">/***************************************************************************\</span>
00244 <span class="comment">* xxxTranslateAccelerator</span>
00245 <span class="comment">*</span>
00246 <span class="comment">* !</span>
00247 <span class="comment">*</span>
00248 <span class="comment">* History:</span>
00249 <span class="comment">\***************************************************************************/</span>
00250 
<a name="l00251"></a><a class="code" href="../../d4/d1/userk_8h.html#a1585">00251</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a1585">xxxTranslateAccelerator</a>(
00252     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00253     <a class="code" href="../../d0/d8/structtagACCELTABLE.html">LPACCELTABLE</a> pat,
00254     LPMSG lpMsg)
00255 {
00256     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cmd;
00257     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fVirt;
00258     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu;
00259     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFound;
00260     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> flags;
00261     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> keystate;
00262     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> message;
00263     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> rgfItem;
00264     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fDisabled;
00265     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSystemMenu;
00266     LPACCEL paccel;
00267     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpMenu;
00268     <span class="keywordtype">int</span> vkAlt, vkCtrl;
00269     HMENU hmenuInit = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00270 
00271     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00272     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pat);
00273 
00274     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a67">gfInNumpadHexInput</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a489">NUMPAD_HEXMODE_HL</a>) {
00275         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00276     }
00277 
00278     paccel = pat-&gt;<a class="code" href="../../d0/d8/structtagACCELTABLE.html#o2">accel</a>;
00279 
00280     fFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00281 
00282     message = <a class="code" href="../../d4/d1/userk_8h.html#a1517">SystoChar</a>(lpMsg-&gt;message, lpMsg-&gt;lParam);
00283 
00284     <span class="keywordflow">switch</span> (message) {
00285     <span class="keywordflow">case</span> WM_KEYDOWN:
00286     <span class="keywordflow">case</span> WM_SYSKEYDOWN:
00287         fVirt = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00288         <span class="keywordflow">break</span>;
00289 
00290     <span class="keywordflow">case</span> WM_CHAR:
00291     <span class="keywordflow">case</span> WM_SYSCHAR:
00292         fVirt = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00293         <span class="keywordflow">break</span>;
00294 
00295     <span class="keywordflow">default</span>:
00296         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00297     }
00298 
00299     <span class="comment">/*</span>
00300 <span class="comment">     * Many kbd layouts use the r.h. Alt key like a shift key to generate some</span>
00301 <span class="comment">     * additional chars: this r.h. Alt (or "AltGr") key synthesizes a left Ctrl</span>
00302 <span class="comment">     * (for backward compatibility with 84-key kbds), so when the AltGr key is</span>
00303 <span class="comment">     * down neither the left Ctrl nor the right Alt should be counted as part</span>
00304 <span class="comment">     * of the keystate.</span>
00305 <span class="comment">     * Note: Don't expect spklActive == NULL (winlogon should have loaded kbd</span>
00306 <span class="comment">     * layouts already), but test it  anyway to be robust. #99321)</span>
00307 <span class="comment">     */</span>
00308     keystate = 0;
00309     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;spklActive != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);   <span class="comment">// #99321</span>
00310     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;spklActive &amp;&amp;
00311             (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;spklActive-&gt;spkf-&gt;pKbdTbl-&gt;fLocaleFlags &amp; KLLF_ALTGR) &amp;&amp;
00312             (<a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_RMENU) &amp; 0x8000)) {
00313         <span class="comment">/*</span>
00314 <span class="comment">         * count only right hand Ctrl as a Ctrl keystate</span>
00315 <span class="comment">         * count only left hand Alt as a Alt keystate</span>
00316 <span class="comment">         */</span>
00317         vkCtrl = VK_RCONTROL;
00318         vkAlt = VK_LMENU;
00319     } <span class="keywordflow">else</span> {
00320         <span class="comment">/*</span>
00321 <span class="comment">         * count left or right hand Ctrl as a Ctrl keystate</span>
00322 <span class="comment">         * count left or right hand Alt as a Alt keystate</span>
00323 <span class="comment">         */</span>
00324         vkAlt = VK_MENU;
00325         vkCtrl = VK_CONTROL;
00326     }
00327 
00328     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(vkCtrl) &amp; 0x8000) {
00329         keystate |= FCONTROL;
00330     }
00331     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(vkAlt) &amp; 0x8000) {
00332         keystate |= FALT;
00333     }
00334     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_SHIFT) &amp; 0x8000) {
00335         keystate |= FSHIFT;
00336     }
00337 
00338     <span class="keywordflow">do</span>
00339     {
00340         flags = paccel-&gt;fVirt;
00341         <span class="keywordflow">if</span> ( (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)paccel-&gt;key != lpMsg-&gt;wParam ||
00342              ((fVirt != 0) != ((flags &amp; FVIRTKEY) != 0))) {
00343             <span class="keywordflow">goto</span> Next;
00344         }
00345 
00346         <span class="keywordflow">if</span> (fVirt &amp;&amp; ((keystate &amp; (FSHIFT | FCONTROL)) != (flags &amp; (FSHIFT | FCONTROL)))) {
00347             <span class="keywordflow">goto</span> Next;
00348         }
00349 
00350         <span class="keywordflow">if</span> ((keystate &amp; FALT) != (flags &amp; FALT)) {
00351             <span class="keywordflow">goto</span> Next;
00352         }
00353 
00354         fFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00355         fSystemMenu = 0;
00356         rgfItem = 0;
00357 
00358         cmd = paccel-&gt;cmd;
00359         <span class="keywordflow">if</span> (cmd != 0) {
00360 
00361             <span class="comment">/*</span>
00362 <span class="comment">             * The order of these next two if's is important for default</span>
00363 <span class="comment">             * situations.  Also, just check accelerators in the system</span>
00364 <span class="comment">             * menu of child windows passed to TranslateAccelerator.</span>
00365 <span class="comment">             */</span>
00366             pMenu = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o16">spmenu</a>;
00367             rgfItem = 0;
00368 
00369             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>)) {
00370                 <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pMenu, &amp;tlpMenu);
00371                 rgfItem = <a class="code" href="../../d1/d2/mnaccel_8c.html#a4">xxxTA_AccelerateMenu</a>(pwnd, pMenu, cmd, &amp;hmenuInit);
00372                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpMenu);
00373             }
00374 
00375             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>) || rgfItem == 0) {
00376                 UserAssert(hmenuInit == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00377                 pMenu = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o15">spmenuSys</a>;
00378                 <span class="keywordflow">if</span> (pMenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a639">WFSYSMENU</a>)) {
00379 
00380                     <span class="comment">/*</span>
00381 <span class="comment">                     * Change owner so this app can access this menu.</span>
00382 <span class="comment">                     */</span>
00383                     pMenu = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;spmenuSys;
00384                     <span class="keywordflow">if</span> (pMenu == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00385                         pMenu = <a class="code" href="../../d4/d1/userk_8h.html#a1605">xxxLoadSysDesktopMenu</a> (&amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;spmenuSys, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a753">ID_SYSMENU</a>);
00386                     }
00387                     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pMenu, &amp;tlpMenu);
00388                     <span class="comment">/*</span>
00389 <span class="comment">                     * Must reset the system menu for this window.</span>
00390 <span class="comment">                     */</span>
00391                     <a class="code" href="../../d4/d1/userk_8h.html#a1402">xxxSetSysMenu</a>(pwnd);
00392                 } <span class="keywordflow">else</span> {
00393                     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pMenu, &amp;tlpMenu);
00394                 }
00395 
00396                 <span class="keywordflow">if</span> ((rgfItem = <a class="code" href="../../d1/d2/mnaccel_8c.html#a4">xxxTA_AccelerateMenu</a>(pwnd, pMenu, cmd, &amp;hmenuInit)) != 0) {
00397                     fSystemMenu = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00398                 }
00399                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpMenu);
00400             }
00401         }
00402 
00403         fDisabled = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>);
00404 
00405         <span class="comment">/*</span>
00406 <span class="comment">         * Send only if:  1.  The Item is not disabled, AND</span>
00407 <span class="comment">         *                2.  The Window's not being captured AND</span>
00408 <span class="comment">         *                3.  The Window's not minimzed, OR</span>
00409 <span class="comment">         *                4.  The Window's minimized but the Item is in</span>
00410 <span class="comment">         *                   the System Menu.</span>
00411 <span class="comment">         */</span>
00412         <span class="keywordflow">if</span> (!(rgfItem &amp; <a class="code" href="../../d1/d2/mnaccel_8c.html#a0">TA_DISABLED</a>) &amp;&amp;
00413                 !(rgfItem &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a658">WFICONIC</a>) &amp;&amp; !fSystemMenu)) {
00414             <span class="keywordflow">if</span> (!(rgfItem != 0 &amp;&amp; (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq-&gt;spwndCapture != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00415                     fDisabled))) {
00416 
00417                 <span class="keywordflow">if</span> (fSystemMenu) {
00418                     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_SYSCOMMAND, cmd, 0x00010000L);
00419                 } <span class="keywordflow">else</span> {
00420                     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_COMMAND, MAKELONG(cmd, 1), 0);
00421                 }
00422 
00423                 <span class="comment">/*</span>
00424 <span class="comment">                 * Get outta here</span>
00425 <span class="comment">                 */</span>
00426                 flags = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a190">FLASTKEY</a>;
00427             }
00428         }
00429 
00430         <span class="comment">/*</span>
00431 <span class="comment">         * Send matching WM_UNINITMENUPOPUP if needed</span>
00432 <span class="comment">         */</span>
00433         <span class="keywordflow">if</span> (hmenuInit != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00434             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_UNINITMENUPOPUP, (WPARAM)hmenuInit, 0);
00435             hmenuInit = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00436         }
00437 
00438     Next:
00439         paccel++;
00440 
00441     } <span class="keywordflow">while</span> (!(flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a190">FLASTKEY</a>) &amp;&amp; !fFound);
00442 
00443 
00444     <span class="keywordflow">return</span> fFound;
00445 }
00446 
00447 <span class="comment">/***************************************************************************\</span>
00448 <span class="comment">* SystoChar</span>
00449 <span class="comment">*</span>
00450 <span class="comment">* EXIT: If the message was not made with the ALT key down, convert</span>
00451 <span class="comment">*       the message from a WM_SYSKEY* to a WM_KEY* message.</span>
00452 <span class="comment">*</span>
00453 <span class="comment">* IMPLEMENTATION:</span>
00454 <span class="comment">*     The 0x2000 bit in the hi word of lParam is set if the key was</span>
00455 <span class="comment">*     made with the ALT key down.</span>
00456 <span class="comment">*</span>
00457 <span class="comment">* History:</span>
00458 <span class="comment">*   11/30/90 JimA       Ported.</span>
00459 <span class="comment">\***************************************************************************/</span>
00460 
<a name="l00461"></a><a class="code" href="../../d4/d1/userk_8h.html#a1517">00461</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d1/userk_8h.html#a1517">SystoChar</a>(
00462     UINT message,
00463     LPARAM lParam)
00464 {
00465     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a823">CheckMsgFilter</a>(message, WM_SYSKEYDOWN, WM_SYSDEADCHAR) &amp;&amp;
00466             !(HIWORD(lParam) &amp; <a class="code" href="../../d3/d5/editsl_8c.html#a0">SYS_ALTERNATE</a>))
00467         <span class="keywordflow">return</span> (message - (WM_SYSKEYDOWN - WM_KEYDOWN));
00468 
00469     <span class="keywordflow">return</span> message;
00470 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:50 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
