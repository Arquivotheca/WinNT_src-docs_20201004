<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: time.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>time.c</h1><a href="../../d1/d2/time_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    Time.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the absolute time conversion routines for NT.</span>
00012 <span class="comment"></span>
00013 <span class="comment">    Absolute LARGE_INTEGER in NT is represented by a 64-bit large integer accurate</span>
00014 <span class="comment">    to 100ns resolution.  The smallest time resolution used by this package</span>
00015 <span class="comment">    is One millisecond.  The basis for NT time is the start of 1601 which</span>
00016 <span class="comment">    was chosen because it is the start of a new quadricentury.  Some facts</span>
00017 <span class="comment">    to note are:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    o At 100ns resolution 32 bits is good for about 429 seconds (or 7 minutes)</span>
00020 <span class="comment"></span>
00021 <span class="comment">    o At 100ns resolution a large integer (i.e., 63 bits) is good for</span>
00022 <span class="comment">      about 29,247 years, or around 10,682,247 days.</span>
00023 <span class="comment"></span>
00024 <span class="comment">    o At 1 second resolution 31 bits is good for about 68 years</span>
00025 <span class="comment"></span>
00026 <span class="comment">    o At 1 second resolution 32 bits is good for about 136 years</span>
00027 <span class="comment"></span>
00028 <span class="comment">    o 100ns Time (ignoring time less than a millisecond) can be expressed</span>
00029 <span class="comment">      as two values, Days and Milliseconds.  Where Days is the number of</span>
00030 <span class="comment">      whole days and Milliseconds is the number of milliseconds for the</span>
00031 <span class="comment">      partial day.  Both of these values are ULONG.</span>
00032 <span class="comment"></span>
00033 <span class="comment">    Given these facts most of the conversions are done by first splitting</span>
00034 <span class="comment">    LARGE_INTEGER into Days and Milliseconds.</span>
00035 <span class="comment"></span>
00036 <span class="comment">Author:</span>
00037 <span class="comment"></span>
00038 <span class="comment">    Gary Kimura     [GaryKi]    26-Aug-1989</span>
00039 <span class="comment"></span>
00040 <span class="comment">Environment:</span>
00041 <span class="comment"></span>
00042 <span class="comment">    Pure utility routine</span>
00043 <span class="comment"></span>
00044 <span class="comment">Revision History:</span>
00045 <span class="comment"></span>
00046 <span class="comment">--*/</span>
00047 
00048 <span class="preprocessor">#include "<a class="code" href="../../d5/d9/ntrtlp_8h.html">ntrtlp.h</a>"</span>
00049 
00050 <span class="preprocessor">#if defined(ALLOC_PRAGMA) &amp;&amp; defined(NTOS_KERNEL_RUNTIME)</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlCutoverTimeToSystemTime)</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, RtlTimeToElapsedTimeFields)</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00054 <span class="preprocessor"></span>
00055 
00056 <span class="comment">//</span>
00057 <span class="comment">//  The following two tables map a day offset within a year to the month</span>
00058 <span class="comment">//  containing the day.  Both tables are zero based.  For example, day</span>
00059 <span class="comment">//  offset of 0 to 30 map to 0 (which is Jan).</span>
00060 <span class="comment">//</span>
00061 
<a name="l00062"></a><a class="code" href="../../d1/d2/time_8c.html#a14">00062</a> CONST UCHAR <a class="code" href="../../d1/d2/time_8c.html#a14">LeapYearDayToMonth</a>[366] = {
00063      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  <span class="comment">// January</span>
00064      1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,        <span class="comment">// February</span>
00065      2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,  <span class="comment">// March</span>
00066      3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3,     <span class="comment">// April</span>
00067      4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,  <span class="comment">// May</span>
00068      5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,     <span class="comment">// June</span>
00069      6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6,  <span class="comment">// July</span>
00070      7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,  <span class="comment">// August</span>
00071      8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8,     <span class="comment">// September</span>
00072      9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9,  <span class="comment">// October</span>
00073     10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,     <span class="comment">// November</span>
00074     11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11}; <span class="comment">// December</span>
00075 
<a name="l00076"></a><a class="code" href="../../d1/d2/time_8c.html#a15">00076</a> CONST UCHAR <a class="code" href="../../d1/d2/time_8c.html#a15">NormalYearDayToMonth</a>[365] = {
00077      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  <span class="comment">// January</span>
00078      1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,           <span class="comment">// February</span>
00079      2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,  <span class="comment">// March</span>
00080      3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3,     <span class="comment">// April</span>
00081      4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,  <span class="comment">// May</span>
00082      5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,     <span class="comment">// June</span>
00083      6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6,  <span class="comment">// July</span>
00084      7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,  <span class="comment">// August</span>
00085      8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8,     <span class="comment">// September</span>
00086      9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9,  <span class="comment">// October</span>
00087     10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,     <span class="comment">// November</span>
00088     11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11}; <span class="comment">// December</span>
00089 
00090 <span class="comment">//</span>
00091 <span class="comment">//  The following two tables map a month index to the number of days preceding</span>
00092 <span class="comment">//  the month in the year.  Both tables are zero based.  For example, 1 (Feb)</span>
00093 <span class="comment">//  has 31 days preceding it.  To help calculate the maximum number of days</span>
00094 <span class="comment">//  in a month each table has 13 entries, so the number of days in a month</span>
00095 <span class="comment">//  of index i is the table entry of i+1 minus the table entry of i.</span>
00096 <span class="comment">//</span>
00097 
<a name="l00098"></a><a class="code" href="../../d1/d2/time_8c.html#a16">00098</a> CONST CSHORT <a class="code" href="../../d1/d2/time_8c.html#a16">LeapYearDaysPrecedingMonth</a>[13] = {
00099     0,                                 <span class="comment">// January</span>
00100     31,                                <span class="comment">// February</span>
00101     31+29,                             <span class="comment">// March</span>
00102     31+29+31,                          <span class="comment">// April</span>
00103     31+29+31+30,                       <span class="comment">// May</span>
00104     31+29+31+30+31,                    <span class="comment">// June</span>
00105     31+29+31+30+31+30,                 <span class="comment">// July</span>
00106     31+29+31+30+31+30+31,              <span class="comment">// August</span>
00107     31+29+31+30+31+30+31+31,           <span class="comment">// September</span>
00108     31+29+31+30+31+30+31+31+30,        <span class="comment">// October</span>
00109     31+29+31+30+31+30+31+31+30+31,     <span class="comment">// November</span>
00110     31+29+31+30+31+30+31+31+30+31+30,  <span class="comment">// December</span>
00111     31+29+31+30+31+30+31+31+30+31+30+31};
00112 
<a name="l00113"></a><a class="code" href="../../d1/d2/time_8c.html#a17">00113</a> CONST CSHORT <a class="code" href="../../d1/d2/time_8c.html#a17">NormalYearDaysPrecedingMonth</a>[13] = {
00114     0,                                 <span class="comment">// January</span>
00115     31,                                <span class="comment">// February</span>
00116     31+28,                             <span class="comment">// March</span>
00117     31+28+31,                          <span class="comment">// April</span>
00118     31+28+31+30,                       <span class="comment">// May</span>
00119     31+28+31+30+31,                    <span class="comment">// June</span>
00120     31+28+31+30+31+30,                 <span class="comment">// July</span>
00121     31+28+31+30+31+30+31,              <span class="comment">// August</span>
00122     31+28+31+30+31+30+31+31,           <span class="comment">// September</span>
00123     31+28+31+30+31+30+31+31+30,        <span class="comment">// October</span>
00124     31+28+31+30+31+30+31+31+30+31,     <span class="comment">// November</span>
00125     31+28+31+30+31+30+31+31+30+31+30,  <span class="comment">// December</span>
00126     31+28+31+30+31+30+31+31+30+31+30+31};
00127 
00128 
00129 <span class="comment">//</span>
00130 <span class="comment">//  The following definitions and declarations are some important constants</span>
00131 <span class="comment">//  used in the time conversion routines</span>
00132 <span class="comment">//</span>
00133 
00134 <span class="comment">//</span>
00135 <span class="comment">//  This is the week day that January 1st, 1601 fell on (a Monday)</span>
00136 <span class="comment">//</span>
00137 
<a name="l00138"></a><a class="code" href="../../d1/d2/time_8c.html#a0">00138</a> <span class="preprocessor">#define WEEKDAY_OF_1601                  1</span>
00139 <span class="preprocessor"></span>
00140 <span class="comment">//</span>
00141 <span class="comment">//  These are known constants used to convert 1970 and 1980 times to 1601</span>
00142 <span class="comment">//  times.  They are the number of seconds from the 1601 base to the start</span>
00143 <span class="comment">//  of 1970 and the start of 1980.  The number of seconds from 1601 to</span>
00144 <span class="comment">//  1970 is 369 years worth, or (369 * 365) + 89 leap days = 134774 days, or</span>
00145 <span class="comment">//  134774 * 864000 seconds, which is equal to the large integer defined</span>
00146 <span class="comment">//  below.  The number of seconds from 1601 to 1980 is 379 years worth, or etc.</span>
00147 <span class="comment">//</span>
00148 
<a name="l00149"></a><a class="code" href="../../d1/d2/time_8c.html#a18">00149</a> <span class="keyword">const</span> LARGE_INTEGER <a class="code" href="../../d3/d6/stdtimep_8h.html#a32">SecondsToStartOf1970</a> = {0xb6109100, 0x00000002};
00150 
<a name="l00151"></a><a class="code" href="../../d1/d2/time_8c.html#a19">00151</a> <span class="keyword">const</span> LARGE_INTEGER <a class="code" href="../../d3/d6/stdtimep_8h.html#a33">SecondsToStartOf1980</a> = {0xc8df3700, 0x00000002};
00152 
00153 <span class="comment">//</span>
00154 <span class="comment">//  These are the magic numbers needed to do our extended division.  The</span>
00155 <span class="comment">//  only numbers we ever need to divide by are</span>
00156 <span class="comment">//</span>
00157 <span class="comment">//      10,000 = convert 100ns tics to millisecond tics</span>
00158 <span class="comment">//</span>
00159 <span class="comment">//      10,000,000 = convert 100ns tics to one second tics</span>
00160 <span class="comment">//</span>
00161 <span class="comment">//      86,400,000 = convert Millisecond tics to one day tics</span>
00162 <span class="comment">//</span>
00163 
<a name="l00164"></a><a class="code" href="../../d1/d2/time_8c.html#a20">00164</a> <span class="keyword">const</span> LARGE_INTEGER <a class="code" href="../../d8/d3/kdapi_8c.html#a2">Magic10000</a>    = {0xe219652c, 0xd1b71758};
<a name="l00165"></a><a class="code" href="../../d1/d2/time_8c.html#a1">00165</a> <span class="preprocessor">#define SHIFT10000                       13</span>
00166 <span class="preprocessor"></span>
<a name="l00167"></a><a class="code" href="../../d1/d2/time_8c.html#a21">00167</a> <span class="keyword">const</span> LARGE_INTEGER <a class="code" href="../../d3/d6/stdtimep_8h.html#a30">Magic10000000</a> = {0xe57a42bd, 0xd6bf94d5};
<a name="l00168"></a><a class="code" href="../../d1/d2/time_8c.html#a2">00168</a> <span class="preprocessor">#define SHIFT10000000                    23</span>
00169 <span class="preprocessor"></span>
<a name="l00170"></a><a class="code" href="../../d1/d2/time_8c.html#a22">00170</a> <span class="keyword">const</span> LARGE_INTEGER <a class="code" href="../../d3/d6/stdtimep_8h.html#a31">Magic86400000</a> = {0xfa67b90e, 0xc6d750eb};
<a name="l00171"></a><a class="code" href="../../d1/d2/time_8c.html#a3">00171</a> <span class="preprocessor">#define SHIFT86400000                    26</span>
00172 <span class="preprocessor"></span>
00173 <span class="comment">//</span>
00174 <span class="comment">//  To make the code more readable we'll also define some macros to</span>
00175 <span class="comment">//  do the actual division for use</span>
00176 <span class="comment">//</span>
00177 
<a name="l00178"></a><a class="code" href="../../d1/d2/time_8c.html#a4">00178</a> <span class="preprocessor">#define Convert100nsToMilliseconds(LARGE_INTEGER) (                         \</span>
00179 <span class="preprocessor">    RtlExtendedMagicDivide( (LARGE_INTEGER), Magic10000, SHIFT10000 )       \</span>
00180 <span class="preprocessor">    )</span>
00181 <span class="preprocessor"></span>
<a name="l00182"></a><a class="code" href="../../d1/d2/time_8c.html#a5">00182</a> <span class="preprocessor">#define ConvertMillisecondsTo100ns(MILLISECONDS) (                 \</span>
00183 <span class="preprocessor">    RtlExtendedIntegerMultiply( (MILLISECONDS), 10000 )            \</span>
00184 <span class="preprocessor">    )</span>
00185 <span class="preprocessor"></span>
<a name="l00186"></a><a class="code" href="../../d1/d2/time_8c.html#a6">00186</a> <span class="preprocessor">#define Convert100nsToSeconds(LARGE_INTEGER) (                              \</span>
00187 <span class="preprocessor">    RtlExtendedMagicDivide( (LARGE_INTEGER), Magic10000000, SHIFT10000000 ) \</span>
00188 <span class="preprocessor">    )</span>
00189 <span class="preprocessor"></span>
<a name="l00190"></a><a class="code" href="../../d1/d2/time_8c.html#a7">00190</a> <span class="preprocessor">#define ConvertSecondsTo100ns(SECONDS) (                           \</span>
00191 <span class="preprocessor">    RtlExtendedIntegerMultiply( (SECONDS), 10000000 )              \</span>
00192 <span class="preprocessor">    )</span>
00193 <span class="preprocessor"></span>
<a name="l00194"></a><a class="code" href="../../d1/d2/time_8c.html#a8">00194</a> <span class="preprocessor">#define ConvertMillisecondsToDays(LARGE_INTEGER) (                          \</span>
00195 <span class="preprocessor">    RtlExtendedMagicDivide( (LARGE_INTEGER), Magic86400000, SHIFT86400000 ) \</span>
00196 <span class="preprocessor">    )</span>
00197 <span class="preprocessor"></span>
<a name="l00198"></a><a class="code" href="../../d1/d2/time_8c.html#a9">00198</a> <span class="preprocessor">#define ConvertDaysToMilliseconds(DAYS) (                          \</span>
00199 <span class="preprocessor">    Int32x32To64( (DAYS), 86400000 )                               \</span>
00200 <span class="preprocessor">    )</span>
00201 <span class="preprocessor"></span>
00202 
00203 <span class="comment">//</span>
00204 <span class="comment">//  Local support routine</span>
00205 <span class="comment">//</span>
00206 
00207 ULONG
<a name="l00208"></a><a class="code" href="../../d1/d2/time_8c.html#a23">00208</a> <a class="code" href="../../d3/d6/stdtimep_8h.html#a24">ElapsedDaysToYears</a> (
00209     IN ULONG ElapsedDays
00210     )
00211 
00212 <span class="comment">/*++</span>
00213 <span class="comment"></span>
00214 <span class="comment">Routine Description:</span>
00215 <span class="comment"></span>
00216 <span class="comment">    This routine computes the number of total years contained in the indicated</span>
00217 <span class="comment">    number of elapsed days.  The computation is to first compute the number of</span>
00218 <span class="comment">    400 years and subtract that it, then do the 100 years and subtract that out,</span>
00219 <span class="comment">    then do the number of 4 years and subtract that out.  Then what we have left</span>
00220 <span class="comment">    is the number of days with in a normalized 4 year block.  Normalized being that</span>
00221 <span class="comment">    the first three years are not leap years.</span>
00222 <span class="comment"></span>
00223 <span class="comment">Arguments:</span>
00224 <span class="comment"></span>
00225 <span class="comment">    ElapsedDays - Supplies the number of days to use</span>
00226 <span class="comment"></span>
00227 <span class="comment">Return Value:</span>
00228 <span class="comment"></span>
00229 <span class="comment">    ULONG - Returns the number of whole years contained within the input number</span>
00230 <span class="comment">        of days.</span>
00231 <span class="comment"></span>
00232 <span class="comment">--*/</span>
00233 
00234 {
00235     ULONG NumberOf400s;
00236     ULONG NumberOf100s;
00237     ULONG NumberOf4s;
00238     ULONG Years;
00239 
00240     <span class="comment">//</span>
00241     <span class="comment">//  A 400 year time block is 365*400 + 400/4 - 400/100 + 400/400 = 146097 days</span>
00242     <span class="comment">//  long.  So we simply compute the number of whole 400 year block and the</span>
00243     <span class="comment">//  the number days contained in those whole blocks, and subtract if from the</span>
00244     <span class="comment">//  elapsed day total</span>
00245     <span class="comment">//</span>
00246 
00247     NumberOf400s = ElapsedDays / 146097;
00248     ElapsedDays -= NumberOf400s * 146097;
00249 
00250     <span class="comment">//</span>
00251     <span class="comment">//  A 100 year time block is 365*100 + 100/4 - 100/100 = 36524 days long.</span>
00252     <span class="comment">//  The computation for the number of 100 year blocks is biased by 3/4 days per</span>
00253     <span class="comment">//  100 years to account for the extra leap day thrown in on the last year</span>
00254     <span class="comment">//  of each 400 year block.</span>
00255     <span class="comment">//</span>
00256 
00257     NumberOf100s = (ElapsedDays * 100 + 75) / 3652425;
00258     ElapsedDays -= NumberOf100s * 36524;
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">//  A 4 year time block is 365*4 + 4/4 = 1461 days long.</span>
00262     <span class="comment">//</span>
00263 
00264     NumberOf4s = ElapsedDays / 1461;
00265     ElapsedDays -= NumberOf4s * 1461;
00266 
00267     <span class="comment">//</span>
00268     <span class="comment">//  Now the number of whole years is the number of 400 year blocks times 400,</span>
00269     <span class="comment">//  100 year blocks time 100, 4 year blocks times 4, and the number of elapsed</span>
00270     <span class="comment">//  whole years, taking into account the 3/4 day per year needed to handle the</span>
00271     <span class="comment">//  leap year.</span>
00272     <span class="comment">//</span>
00273 
00274     Years = (NumberOf400s * 400) +
00275             (NumberOf100s * 100) +
00276             (NumberOf4s * 4) +
00277             (ElapsedDays * 100 + 75) / 36525;
00278 
00279     <span class="keywordflow">return</span> Years;
00280 }
00281 
00282 
00283 <span class="comment">//</span>
00284 <span class="comment">//  ULONG</span>
00285 <span class="comment">//  NumberOfLeapYears (</span>
00286 <span class="comment">//      IN ULONG ElapsedYears</span>
00287 <span class="comment">//      );</span>
00288 <span class="comment">//</span>
00289 <span class="comment">//  The number of leap years is simply the number of years divided by 4</span>
00290 <span class="comment">//  minus years divided by 100 plus years divided by 400.  This says</span>
00291 <span class="comment">//  that every four years is a leap year except centuries, and the</span>
00292 <span class="comment">//  exception to the exception is the quadricenturies</span>
00293 <span class="comment">//</span>
00294 
<a name="l00295"></a><a class="code" href="../../d1/d2/time_8c.html#a10">00295</a> <span class="preprocessor">#define NumberOfLeapYears(YEARS) (                    \</span>
00296 <span class="preprocessor">    ((YEARS) / 4) - ((YEARS) / 100) + ((YEARS) / 400) \</span>
00297 <span class="preprocessor">    )</span>
00298 <span class="preprocessor"></span>
00299 <span class="comment">//</span>
00300 <span class="comment">//  ULONG</span>
00301 <span class="comment">//  ElapsedYearsToDays (</span>
00302 <span class="comment">//      IN ULONG ElapsedYears</span>
00303 <span class="comment">//      );</span>
00304 <span class="comment">//</span>
00305 <span class="comment">//  The number of days contained in elapsed years is simply the number</span>
00306 <span class="comment">//  of years times 365 (because every year has at least 365 days) plus</span>
00307 <span class="comment">//  the number of leap years there are (i.e., the number of 366 days years)</span>
00308 <span class="comment">//</span>
00309 
<a name="l00310"></a><a class="code" href="../../d1/d2/time_8c.html#a11">00310</a> <span class="preprocessor">#define ElapsedYearsToDays(YEARS) (            \</span>
00311 <span class="preprocessor">    ((YEARS) * 365) + NumberOfLeapYears(YEARS) \</span>
00312 <span class="preprocessor">    )</span>
00313 <span class="preprocessor"></span>
00314 <span class="comment">//</span>
00315 <span class="comment">//  BOOLEAN</span>
00316 <span class="comment">//  IsLeapYear (</span>
00317 <span class="comment">//      IN ULONG ElapsedYears</span>
00318 <span class="comment">//      );</span>
00319 <span class="comment">//</span>
00320 <span class="comment">//  If it is an even 400 or a non century leapyear then the</span>
00321 <span class="comment">//  answer is true otherwise it's false</span>
00322 <span class="comment">//</span>
00323 
<a name="l00324"></a><a class="code" href="../../d1/d2/time_8c.html#a12">00324</a> <span class="preprocessor">#define IsLeapYear(YEARS) (                        \</span>
00325 <span class="preprocessor">    (((YEARS) % 400 == 0) ||                       \</span>
00326 <span class="preprocessor">     ((YEARS) % 100 != 0) &amp;&amp; ((YEARS) % 4 == 0)) ? \</span>
00327 <span class="preprocessor">        TRUE                                       \</span>
00328 <span class="preprocessor">    :                                              \</span>
00329 <span class="preprocessor">        FALSE                                      \</span>
00330 <span class="preprocessor">    )</span>
00331 <span class="preprocessor"></span>
00332 <span class="comment">//</span>
00333 <span class="comment">//  ULONG</span>
00334 <span class="comment">//  MaxDaysInMonth (</span>
00335 <span class="comment">//      IN ULONG Year,</span>
00336 <span class="comment">//      IN ULONG Month</span>
00337 <span class="comment">//      );</span>
00338 <span class="comment">//</span>
00339 <span class="comment">//  The maximum number of days in a month depend on the year and month.</span>
00340 <span class="comment">//  It is the difference between the days to the month and the days</span>
00341 <span class="comment">//  to the following month</span>
00342 <span class="comment">//</span>
00343 
<a name="l00344"></a><a class="code" href="../../d1/d2/time_8c.html#a13">00344</a> <span class="preprocessor">#define MaxDaysInMonth(YEAR,MONTH) (                                      \</span>
00345 <span class="preprocessor">    IsLeapYear(YEAR) ?                                                    \</span>
00346 <span class="preprocessor">        LeapYearDaysPrecedingMonth[(MONTH) + 1] -                         \</span>
00347 <span class="preprocessor">                                    LeapYearDaysPrecedingMonth[(MONTH)]   \</span>
00348 <span class="preprocessor">    :                                                                     \</span>
00349 <span class="preprocessor">        NormalYearDaysPrecedingMonth[(MONTH) + 1] -                       \</span>
00350 <span class="preprocessor">                                    NormalYearDaysPrecedingMonth[(MONTH)] \</span>
00351 <span class="preprocessor">    )</span>
00352 <span class="preprocessor"></span>
00353 
00354 
00355 <span class="comment">//</span>
00356 <span class="comment">//  Internal Support routine</span>
00357 <span class="comment">//</span>
00358 
00359 <span class="keyword">static</span>
00360 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00361"></a><a class="code" href="../../d1/d2/time_8c.html#a24">00361</a> <a class="code" href="../../d1/d2/time_8c.html#a24">TimeToDaysAndFraction</a> (
00362     IN PLARGE_INTEGER Time,
00363     OUT PULONG ElapsedDays,
00364     OUT PULONG Milliseconds
00365     )
00366 
00367 <span class="comment">/*++</span>
00368 <span class="comment"></span>
00369 <span class="comment">Routine Description:</span>
00370 <span class="comment"></span>
00371 <span class="comment">    This routine converts an input 64-bit time value to the number</span>
00372 <span class="comment">    of total elapsed days and the number of milliseconds in the</span>
00373 <span class="comment">    partial day.</span>
00374 <span class="comment"></span>
00375 <span class="comment">Arguments:</span>
00376 <span class="comment"></span>
00377 <span class="comment">    Time - Supplies the input time to convert from</span>
00378 <span class="comment"></span>
00379 <span class="comment">    ElapsedDays - Receives the number of elapsed days</span>
00380 <span class="comment"></span>
00381 <span class="comment">    Milliseconds - Receives the number of milliseconds in the partial day</span>
00382 <span class="comment"></span>
00383 <span class="comment">Return Value:</span>
00384 <span class="comment"></span>
00385 <span class="comment">    None</span>
00386 <span class="comment"></span>
00387 <span class="comment">--*/</span>
00388 
00389 {
00390     LARGE_INTEGER TotalMilliseconds;
00391     LARGE_INTEGER Temp;
00392 
00393     <span class="comment">//</span>
00394     <span class="comment">//  Convert the input time to total milliseconds</span>
00395     <span class="comment">//</span>
00396 
00397     TotalMilliseconds = <a class="code" href="../../d8/d3/kdapi_8c.html#a1">Convert100nsToMilliseconds</a>( *(PLARGE_INTEGER)<a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> );
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">//  Convert milliseconds to total days</span>
00401     <span class="comment">//</span>
00402 
00403     Temp = <a class="code" href="../../d3/d6/stdtimep_8h.html#a7">ConvertMillisecondsToDays</a>( TotalMilliseconds );
00404 
00405     <span class="comment">//</span>
00406     <span class="comment">//  Set the elapsed days from temp, we've divided it enough so that</span>
00407     <span class="comment">//  the high part must be zero.</span>
00408     <span class="comment">//</span>
00409 
00410     *ElapsedDays = Temp.LowPart;
00411 
00412     <span class="comment">//</span>
00413     <span class="comment">//  Calculate the exact number of milliseconds in the elapsed days</span>
00414     <span class="comment">//  and subtract that from the total milliseconds to figure out</span>
00415     <span class="comment">//  the number of milliseconds left in the partial day</span>
00416     <span class="comment">//</span>
00417 
00418     Temp.QuadPart = <a class="code" href="../../d1/d2/time_8c.html#a9">ConvertDaysToMilliseconds</a>( *ElapsedDays );
00419 
00420     Temp.QuadPart = TotalMilliseconds.QuadPart - Temp.QuadPart;
00421 
00422     <span class="comment">//</span>
00423     <span class="comment">//  Set the fraction part from temp, the total number of milliseconds in</span>
00424     <span class="comment">//  a day guarantees that the high part must be zero.</span>
00425     <span class="comment">//</span>
00426 
00427     *Milliseconds = Temp.LowPart;
00428 
00429     <span class="comment">//</span>
00430     <span class="comment">//  And return to our caller</span>
00431     <span class="comment">//</span>
00432 
00433     <span class="keywordflow">return</span>;
00434 }
00435 
00436 
00437 <span class="comment">//</span>
00438 <span class="comment">//  Internal Support routine</span>
00439 <span class="comment">//</span>
00440 
00441 <span class="comment">//static</span>
00442 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00443"></a><a class="code" href="../../d1/d2/time_8c.html#a25">00443</a> <a class="code" href="../../d1/d2/time_8c.html#a25">DaysAndFractionToTime</a> (
00444     IN ULONG ElapsedDays,
00445     IN ULONG Milliseconds,
00446     OUT PLARGE_INTEGER Time
00447     )
00448 
00449 <span class="comment">/*++</span>
00450 <span class="comment"></span>
00451 <span class="comment">Routine Description:</span>
00452 <span class="comment"></span>
00453 <span class="comment">    This routine converts an input elapsed day count and partial time</span>
00454 <span class="comment">    in milliseconds to a 64-bit time value.</span>
00455 <span class="comment"></span>
00456 <span class="comment">Arguments:</span>
00457 <span class="comment"></span>
00458 <span class="comment">    ElapsedDays - Supplies the number of elapsed days</span>
00459 <span class="comment"></span>
00460 <span class="comment">    Milliseconds - Supplies the number of milliseconds in the partial day</span>
00461 <span class="comment"></span>
00462 <span class="comment">    Time - Receives the output time to value</span>
00463 <span class="comment"></span>
00464 <span class="comment">Return Value:</span>
00465 <span class="comment"></span>
00466 <span class="comment">    None</span>
00467 <span class="comment"></span>
00468 <span class="comment">--*/</span>
00469 
00470 {
00471     LARGE_INTEGER Temp;
00472     LARGE_INTEGER Temp2;
00473 
00474     <span class="comment">//</span>
00475     <span class="comment">//  Calculate the exact number of milliseconds in the elapsed days.</span>
00476     <span class="comment">//</span>
00477 
00478     Temp.QuadPart = <a class="code" href="../../d1/d2/time_8c.html#a9">ConvertDaysToMilliseconds</a>( ElapsedDays );
00479 
00480     <span class="comment">//</span>
00481     <span class="comment">//  Convert milliseconds to a large integer</span>
00482     <span class="comment">//</span>
00483 
00484     Temp2.LowPart = Milliseconds;
00485     Temp2.HighPart = 0;
00486 
00487     <span class="comment">//</span>
00488     <span class="comment">//  add milliseconds to the whole day milliseconds</span>
00489     <span class="comment">//</span>
00490 
00491     Temp.QuadPart = Temp.QuadPart + Temp2.QuadPart;
00492 
00493     <span class="comment">//</span>
00494     <span class="comment">//  Finally convert the milliseconds to 100ns resolution</span>
00495     <span class="comment">//</span>
00496 
00497     *(PLARGE_INTEGER)<a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> = <a class="code" href="../../d3/d6/stdtimep_8h.html#a4">ConvertMillisecondsTo100ns</a>( Temp );
00498 
00499     <span class="comment">//</span>
00500     <span class="comment">//  and return to our caller</span>
00501     <span class="comment">//</span>
00502 
00503     <span class="keywordflow">return</span>;
00504 }
00505 
00506 
00507 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00508"></a><a class="code" href="../../d1/d2/time_8c.html#a26">00508</a> <a class="code" href="../../d1/d2/time_8c.html#a26">RtlTimeToTimeFields</a> (
00509     IN PLARGE_INTEGER Time,
00510     OUT PTIME_FIELDS TimeFields
00511     )
00512 
00513 <span class="comment">/*++</span>
00514 <span class="comment"></span>
00515 <span class="comment">Routine Description:</span>
00516 <span class="comment"></span>
00517 <span class="comment">    This routine converts an input 64-bit LARGE_INTEGER variable to its corresponding</span>
00518 <span class="comment">    time field record.  It will tell the caller the year, month, day, hour,</span>
00519 <span class="comment">    minute, second, millisecond, and weekday corresponding to the input time</span>
00520 <span class="comment">    variable.</span>
00521 <span class="comment"></span>
00522 <span class="comment">Arguments:</span>
00523 <span class="comment"></span>
00524 <span class="comment">    Time - Supplies the time value to interpret</span>
00525 <span class="comment"></span>
00526 <span class="comment">    TimeFields - Receives a value corresponding to Time</span>
00527 <span class="comment"></span>
00528 <span class="comment">Return Value:</span>
00529 <span class="comment"></span>
00530 <span class="comment">    None</span>
00531 <span class="comment"></span>
00532 <span class="comment">--*/</span>
00533 
00534 {
00535     ULONG Years;
00536     ULONG Month;
00537     ULONG Days;
00538 
00539     ULONG Hours;
00540     ULONG Minutes;
00541     ULONG Seconds;
00542     ULONG Milliseconds;
00543 
00544     <span class="comment">//</span>
00545     <span class="comment">//  First divide the input time 64 bit time variable into</span>
00546     <span class="comment">//  the number of whole days and part days (in milliseconds)</span>
00547     <span class="comment">//</span>
00548 
00549     <a class="code" href="../../d1/d2/time_8c.html#a24">TimeToDaysAndFraction</a>( <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>, &amp;Days, &amp;Milliseconds );
00550 
00551     <span class="comment">//</span>
00552     <span class="comment">//  Compute which weekday it is and save it away now in the output</span>
00553     <span class="comment">//  variable.  We add the weekday of the base day to bias our computation</span>
00554     <span class="comment">//  which means that if one day has elapsed then we the weekday we want</span>
00555     <span class="comment">//  is the Jan 2nd, 1601.</span>
00556     <span class="comment">//</span>
00557 
00558     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Weekday = (CSHORT)((Days + <a class="code" href="../../d3/d6/stdtimep_8h.html#a23">WEEKDAY_OF_1601</a>) % 7);
00559 
00560     <span class="comment">//</span>
00561     <span class="comment">//  Calculate the number of whole years contained in the elapsed days</span>
00562     <span class="comment">//  For example if Days = 500 then Years = 1</span>
00563     <span class="comment">//</span>
00564 
00565     Years = <a class="code" href="../../d3/d6/stdtimep_8h.html#a24">ElapsedDaysToYears</a>( Days );
00566 
00567     <span class="comment">//</span>
00568     <span class="comment">//  And subtract the number of whole years from our elapsed days</span>
00569     <span class="comment">//  For example if Days = 500, Years = 1, and the new days is equal</span>
00570     <span class="comment">//  to 500 - 365 (normal year).</span>
00571     <span class="comment">//</span>
00572 
00573     Days = Days - <a class="code" href="../../d3/d6/stdtimep_8h.html#a26">ElapsedYearsToDays</a>( Years );
00574 
00575     <span class="comment">//</span>
00576     <span class="comment">//  Now test whether the year we are working on (i.e., The year</span>
00577     <span class="comment">//  after the total number of elapsed years) is a leap year</span>
00578     <span class="comment">//  or not.</span>
00579     <span class="comment">//</span>
00580 
00581     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/stdtimep_8h.html#a27">IsLeapYear</a>( Years + 1 )) {
00582 
00583         <span class="comment">//</span>
00584         <span class="comment">//  The current year is a leap year, so figure out what month</span>
00585         <span class="comment">//  it is, and then subtract the number of days preceding the</span>
00586         <span class="comment">//  month from the days to figure out what day of the month it is</span>
00587         <span class="comment">//</span>
00588 
00589         Month = <a class="code" href="../../d1/d2/time_8c.html#a14">LeapYearDayToMonth</a>[Days];
00590         Days = Days - <a class="code" href="../../d1/d2/time_8c.html#a16">LeapYearDaysPrecedingMonth</a>[Month];
00591 
00592     } <span class="keywordflow">else</span> {
00593 
00594         <span class="comment">//</span>
00595         <span class="comment">//  The current year is a normal year, so figure out the month</span>
00596         <span class="comment">//  and days as described above for the leap year case</span>
00597         <span class="comment">//</span>
00598 
00599         Month = <a class="code" href="../../d1/d2/time_8c.html#a15">NormalYearDayToMonth</a>[Days];
00600         Days = Days - <a class="code" href="../../d1/d2/time_8c.html#a17">NormalYearDaysPrecedingMonth</a>[Month];
00601 
00602     }
00603 
00604     <span class="comment">//</span>
00605     <span class="comment">//  Now we need to compute the elapsed hour, minute, second, milliseconds</span>
00606     <span class="comment">//  from the millisecond variable.  This variable currently contains</span>
00607     <span class="comment">//  the number of milliseconds in our input time variable that did not</span>
00608     <span class="comment">//  fit into a whole day.  To compute the hour, minute, second part</span>
00609     <span class="comment">//  we will actually do the arithmetic backwards computing milliseconds</span>
00610     <span class="comment">//  seconds, minutes, and then hours.  We start by computing the</span>
00611     <span class="comment">//  number of whole seconds left in the day, and then computing</span>
00612     <span class="comment">//  the millisecond remainder.</span>
00613     <span class="comment">//</span>
00614 
00615     Seconds = Milliseconds / 1000;
00616     Milliseconds = Milliseconds % 1000;
00617 
00618     <span class="comment">//</span>
00619     <span class="comment">//  Now we compute the number of whole minutes left in the day</span>
00620     <span class="comment">//  and the number of remainder seconds</span>
00621     <span class="comment">//</span>
00622 
00623     Minutes = Seconds / 60;
00624     Seconds = Seconds % 60;
00625 
00626     <span class="comment">//</span>
00627     <span class="comment">//  Now compute the number of whole hours left in the day</span>
00628     <span class="comment">//  and the number of remainder minutes</span>
00629     <span class="comment">//</span>
00630 
00631     Hours = Minutes / 60;
00632     Minutes = Minutes % 60;
00633 
00634     <span class="comment">//</span>
00635     <span class="comment">//  As our final step we put everything into the time fields</span>
00636     <span class="comment">//  output variable</span>
00637     <span class="comment">//</span>
00638 
00639     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Year         = (CSHORT)(Years + 1601);
00640     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Month        = (CSHORT)(Month + 1);
00641     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Day          = (CSHORT)(Days + 1);
00642     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Hour         = (CSHORT)Hours;
00643     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Minute       = (CSHORT)Minutes;
00644     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Second       = (CSHORT)Seconds;
00645     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Milliseconds = (CSHORT)Milliseconds;
00646 
00647     <span class="comment">//</span>
00648     <span class="comment">//  and return to our caller</span>
00649     <span class="comment">//</span>
00650 
00651     <span class="keywordflow">return</span>;
00652 }
00653 
00654 BOOLEAN
<a name="l00655"></a><a class="code" href="../../d1/d2/time_8c.html#a27">00655</a> <a class="code" href="../../d1/d2/time_8c.html#a27">RtlCutoverTimeToSystemTime</a>(
00656     PTIME_FIELDS CutoverTime,
00657     PLARGE_INTEGER SystemTime,
00658     PLARGE_INTEGER CurrentSystemTime,
00659     BOOLEAN ThisYear
00660     )
00661 {
00662     TIME_FIELDS CurrentTimeFields;
00663 
00664     <span class="comment">//</span>
00665     <span class="comment">// Get the current system time</span>
00666     <span class="comment">//</span>
00667 
00668     <a class="code" href="../../d1/d2/time_8c.html#a26">RtlTimeToTimeFields</a>(CurrentSystemTime,&amp;CurrentTimeFields);
00669 
00670     <span class="comment">//</span>
00671     <span class="comment">// check for absolute time field. If the year is specified,</span>
00672     <span class="comment">// the the time is an abosulte time</span>
00673     <span class="comment">//</span>
00674 
00675     <span class="keywordflow">if</span> ( CutoverTime-&gt;Year ) {
00676 
00677         <span class="comment">//</span>
00678         <span class="comment">// Convert this to a time value and make sure it</span>
00679         <span class="comment">// is greater than the current system time</span>
00680         <span class="comment">//</span>
00681 
00682         <span class="keywordflow">if</span> ( !<a class="code" href="../../d1/d2/time_8c.html#a28">RtlTimeFieldsToTime</a>(CutoverTime,SystemTime) ) {
00683             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00684             }
00685 
00686         <span class="keywordflow">if</span> (SystemTime-&gt;QuadPart &lt; CurrentSystemTime-&gt;QuadPart) {
00687             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00688             }
00689         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00690         }
00691     <span class="keywordflow">else</span> {
00692 
00693         TIME_FIELDS WorkingTimeField;
00694         TIME_FIELDS ScratchTimeField;
00695         LARGE_INTEGER ScratchTime;
00696         CSHORT BestWeekdayDate;
00697         CSHORT WorkingWeekdayNumber;
00698         CSHORT TargetWeekdayNumber;
00699         CSHORT TargetYear;
00700         CSHORT TargetMonth;
00701         CSHORT TargetWeekday;     <span class="comment">// range [0..6] == [Sunday..Saturday]</span>
00702         BOOLEAN MonthMatches;
00703         <span class="comment">//</span>
00704         <span class="comment">// The time is an day in the month style time</span>
00705         <span class="comment">//</span>
00706         <span class="comment">// the convention is the Day is 1-5 specifying 1st, 2nd... Last</span>
00707         <span class="comment">// day within the month. The day is WeekDay.</span>
00708         <span class="comment">//</span>
00709 
00710         <span class="comment">//</span>
00711         <span class="comment">// Compute the target month and year</span>
00712         <span class="comment">//</span>
00713 
00714         TargetWeekdayNumber = CutoverTime-&gt;Day;
00715         <span class="keywordflow">if</span> ( TargetWeekdayNumber &gt; 5 || TargetWeekdayNumber == 0 ) {
00716             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00717             }
00718         TargetWeekday = CutoverTime-&gt;Weekday;
00719         TargetMonth = CutoverTime-&gt;Month;
00720         MonthMatches = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00721         <span class="keywordflow">if</span> ( !ThisYear ) {
00722             <span class="keywordflow">if</span> ( TargetMonth &lt; CurrentTimeFields.Month ) {
00723                 TargetYear = CurrentTimeFields.Year + 1;
00724                 }
00725             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( TargetMonth &gt; CurrentTimeFields.Month ) {
00726                 TargetYear = CurrentTimeFields.Year;
00727                 }
00728             <span class="keywordflow">else</span> {
00729                 TargetYear = CurrentTimeFields.Year;
00730                 MonthMatches = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00731                 }
00732             }
00733         <span class="keywordflow">else</span> {
00734             TargetYear = CurrentTimeFields.Year;
00735             }
00736 try_next_year:
00737         BestWeekdayDate = 0;
00738 
00739         WorkingTimeField.Year = TargetYear;
00740         WorkingTimeField.Month = TargetMonth;
00741         WorkingTimeField.Day = 1;
00742         WorkingTimeField.Hour = CutoverTime-&gt;Hour;
00743         WorkingTimeField.Minute = CutoverTime-&gt;Minute;
00744         WorkingTimeField.Second = CutoverTime-&gt;Second;
00745         WorkingTimeField.Milliseconds = CutoverTime-&gt;Milliseconds;
00746         WorkingTimeField.Weekday = 0;
00747 
00748         <span class="comment">//</span>
00749         <span class="comment">// Convert to time and then back to time fields so we can determine</span>
00750         <span class="comment">// the weekday of day 1 on the month</span>
00751         <span class="comment">//</span>
00752 
00753         <span class="keywordflow">if</span> ( !<a class="code" href="../../d1/d2/time_8c.html#a28">RtlTimeFieldsToTime</a>(&amp;WorkingTimeField,&amp;ScratchTime) ) {
00754             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00755             }
00756         <a class="code" href="../../d1/d2/time_8c.html#a26">RtlTimeToTimeFields</a>(&amp;ScratchTime,&amp;ScratchTimeField);
00757 
00758         <span class="comment">//</span>
00759         <span class="comment">// Compute bias to target weekday</span>
00760         <span class="comment">//</span>
00761         <span class="keywordflow">if</span> ( ScratchTimeField.Weekday &gt; TargetWeekday ) {
00762             WorkingTimeField.Day += (7-(ScratchTimeField.Weekday - TargetWeekday));
00763             }
00764         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ScratchTimeField.Weekday &lt; TargetWeekday ) {
00765             WorkingTimeField.Day += (TargetWeekday - ScratchTimeField.Weekday);
00766             }
00767 
00768         <span class="comment">//</span>
00769         <span class="comment">// We are now at the first weekday that matches our target weekday</span>
00770         <span class="comment">//</span>
00771 
00772         BestWeekdayDate = WorkingTimeField.Day;
00773         WorkingWeekdayNumber = 1;
00774 
00775         <span class="comment">//</span>
00776         <span class="comment">// Keep going one week at a time until we either pass the</span>
00777         <span class="comment">// target weekday, or we match exactly</span>
00778         <span class="comment">//</span>
00779 
00780         <span class="keywordflow">while</span> ( WorkingWeekdayNumber &lt; TargetWeekdayNumber ) {
00781             WorkingTimeField.Day += 7;
00782             <span class="keywordflow">if</span> ( !<a class="code" href="../../d1/d2/time_8c.html#a28">RtlTimeFieldsToTime</a>(&amp;WorkingTimeField,&amp;ScratchTime) ) {
00783                 <span class="keywordflow">break</span>;
00784                 }
00785             <a class="code" href="../../d1/d2/time_8c.html#a26">RtlTimeToTimeFields</a>(&amp;ScratchTime,&amp;ScratchTimeField);
00786             WorkingWeekdayNumber++;
00787             BestWeekdayDate = ScratchTimeField.Day;
00788             }
00789         WorkingTimeField.Day = BestWeekdayDate;
00790 
00791         <span class="comment">//</span>
00792         <span class="comment">// If the months match, and the date is less than the current</span>
00793         <span class="comment">// date, then be have to go to next year.</span>
00794         <span class="comment">//</span>
00795 
00796         <span class="keywordflow">if</span> ( !<a class="code" href="../../d1/d2/time_8c.html#a28">RtlTimeFieldsToTime</a>(&amp;WorkingTimeField,&amp;ScratchTime) ) {
00797             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00798             }
00799         <span class="keywordflow">if</span> ( MonthMatches ) {
00800             <span class="keywordflow">if</span> ( WorkingTimeField.Day &lt; CurrentTimeFields.Day ) {
00801                 MonthMatches = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00802                 TargetYear++;
00803                 <span class="keywordflow">goto</span> try_next_year;
00804                 }
00805             <span class="keywordflow">if</span> ( WorkingTimeField.Day == CurrentTimeFields.Day ) {
00806 
00807                 <span class="keywordflow">if</span> (ScratchTime.QuadPart &lt; CurrentSystemTime-&gt;QuadPart) {
00808                     MonthMatches = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00809                     TargetYear++;
00810                     <span class="keywordflow">goto</span> try_next_year;
00811                     }
00812                 }
00813             }
00814         *SystemTime = ScratchTime;
00815 
00816         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00817         }
00818 }
00819 
00820 
00821 BOOLEAN
<a name="l00822"></a><a class="code" href="../../d1/d2/time_8c.html#a28">00822</a> <a class="code" href="../../d1/d2/time_8c.html#a28">RtlTimeFieldsToTime</a> (
00823     IN PTIME_FIELDS TimeFields,
00824     OUT PLARGE_INTEGER Time
00825     )
00826 
00827 <span class="comment">/*++</span>
00828 <span class="comment"></span>
00829 <span class="comment">Routine Description:</span>
00830 <span class="comment"></span>
00831 <span class="comment">    This routine converts an input Time Field variable to a 64-bit NT time</span>
00832 <span class="comment">    value.  It ignores the WeekDay of the time field.</span>
00833 <span class="comment"></span>
00834 <span class="comment">Arguments:</span>
00835 <span class="comment"></span>
00836 <span class="comment">    TimeFields - Supplies the time field record to use</span>
00837 <span class="comment"></span>
00838 <span class="comment">    Time - Receives the NT Time corresponding to TimeFields</span>
00839 <span class="comment"></span>
00840 <span class="comment">Return Value:</span>
00841 <span class="comment"></span>
00842 <span class="comment">    BOOLEAN - TRUE if the Time Fields is well formed and within the</span>
00843 <span class="comment">        range of time expressible by LARGE_INTEGER and FALSE otherwise.</span>
00844 <span class="comment"></span>
00845 <span class="comment">--*/</span>
00846 
00847 {
00848     ULONG Year;
00849     ULONG Month;
00850     ULONG Day;
00851     ULONG Hour;
00852     ULONG Minute;
00853     ULONG Second;
00854     ULONG Milliseconds;
00855 
00856     ULONG ElapsedDays;
00857     ULONG ElapsedMilliseconds;
00858 
00859     <span class="comment">//</span>
00860     <span class="comment">//  Load the time field elements into local variables.  This should</span>
00861     <span class="comment">//  ensure that the compiler will only load the input elements</span>
00862     <span class="comment">//  once, even if there are alias problems.  It will also make</span>
00863     <span class="comment">//  everything (except the year) zero based.  We cannot zero base the</span>
00864     <span class="comment">//  year because then we can't recognize cases where we're given a year</span>
00865     <span class="comment">//  before 1601.</span>
00866     <span class="comment">//</span>
00867 
00868     Year         = <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Year;
00869     Month        = <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Month - 1;
00870     Day          = <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Day - 1;
00871     Hour         = <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Hour;
00872     Minute       = <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Minute;
00873     Second       = <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Second;
00874     Milliseconds = <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Milliseconds;
00875 
00876     <span class="comment">//</span>
00877     <span class="comment">//  Check that the time field input variable contains</span>
00878     <span class="comment">//  proper values.</span>
00879     <span class="comment">//</span>
00880 
00881     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Month &lt; 1)                      ||
00882         (<a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Day &lt; 1)                        ||
00883         (Year &lt; 1601)                                ||
00884         (Month &gt; 11)                                 ||
00885         ((CSHORT)Day &gt;= <a class="code" href="../../d3/d6/stdtimep_8h.html#a28">MaxDaysInMonth</a>(Year, Month)) ||
00886         (Hour &gt; 23)                                  ||
00887         (Minute &gt; 59)                                ||
00888         (Second &gt; 59)                                ||
00889         (Milliseconds &gt; 999)) {
00890 
00891         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00892 
00893     }
00894 
00895     <span class="comment">//</span>
00896     <span class="comment">//  Compute the total number of elapsed days represented by the</span>
00897     <span class="comment">//  input time field variable</span>
00898     <span class="comment">//</span>
00899 
00900     ElapsedDays = <a class="code" href="../../d3/d6/stdtimep_8h.html#a26">ElapsedYearsToDays</a>( Year - 1601 );
00901 
00902     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/stdtimep_8h.html#a27">IsLeapYear</a>( Year - 1600 )) {
00903 
00904         ElapsedDays += <a class="code" href="../../d1/d2/time_8c.html#a16">LeapYearDaysPrecedingMonth</a>[ Month ];
00905 
00906     } <span class="keywordflow">else</span> {
00907 
00908         ElapsedDays += <a class="code" href="../../d1/d2/time_8c.html#a17">NormalYearDaysPrecedingMonth</a>[ Month ];
00909 
00910     }
00911 
00912     ElapsedDays += Day;
00913 
00914     <span class="comment">//</span>
00915     <span class="comment">//  Now compute the total number of milliseconds in the fractional</span>
00916     <span class="comment">//  part of the day</span>
00917     <span class="comment">//</span>
00918 
00919     ElapsedMilliseconds = (((Hour*60) + Minute)*60 + Second)*1000 + Milliseconds;
00920 
00921     <span class="comment">//</span>
00922     <span class="comment">//  Given the elapsed days and milliseconds we can now build</span>
00923     <span class="comment">//  the output time variable</span>
00924     <span class="comment">//</span>
00925 
00926     <a class="code" href="../../d1/d2/time_8c.html#a25">DaysAndFractionToTime</a>( ElapsedDays, ElapsedMilliseconds, <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> );
00927 
00928     <span class="comment">//</span>
00929     <span class="comment">//  And return to our caller</span>
00930     <span class="comment">//</span>
00931 
00932     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00933 }
00934 
00935 
00936 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00937"></a><a class="code" href="../../d1/d2/time_8c.html#a29">00937</a> <a class="code" href="../../d1/d2/time_8c.html#a29">RtlTimeToElapsedTimeFields</a> (
00938     IN PLARGE_INTEGER Time,
00939     OUT PTIME_FIELDS TimeFields
00940     )
00941 
00942 <span class="comment">/*++</span>
00943 <span class="comment"></span>
00944 <span class="comment">Routine Description:</span>
00945 <span class="comment"></span>
00946 <span class="comment">    This routine converts an input 64-bit LARGE_INTEGER variable to its corresponding</span>
00947 <span class="comment">    time field record.  The input time is the elapsed time (difference</span>
00948 <span class="comment">    between to times).  It will tell the caller the number of days, hour,</span>
00949 <span class="comment">    minute, second, and milliseconds that the elapsed time represents.</span>
00950 <span class="comment"></span>
00951 <span class="comment">Arguments:</span>
00952 <span class="comment"></span>
00953 <span class="comment">    Time - Supplies the time value to interpret</span>
00954 <span class="comment"></span>
00955 <span class="comment">    TimeFields - Receives a value corresponding to Time</span>
00956 <span class="comment"></span>
00957 <span class="comment">Return Value:</span>
00958 <span class="comment"></span>
00959 <span class="comment">    None</span>
00960 <span class="comment"></span>
00961 <span class="comment">--*/</span>
00962 
00963 {
00964     ULONG Days;
00965     ULONG Hours;
00966     ULONG Minutes;
00967     ULONG Seconds;
00968     ULONG Milliseconds;
00969 
00970     <span class="comment">//</span>
00971     <span class="comment">//  First divide the input time 64 bit time variable into</span>
00972     <span class="comment">//  the number of whole days and part days (in milliseconds)</span>
00973     <span class="comment">//</span>
00974 
00975     <a class="code" href="../../d1/d2/time_8c.html#a24">TimeToDaysAndFraction</a>( <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a>, &amp;Days, &amp;Milliseconds );
00976 
00977     <span class="comment">//</span>
00978     <span class="comment">//  Now we need to compute the elapsed hour, minute, second, milliseconds</span>
00979     <span class="comment">//  from the millisecond variable.  This variable currently contains</span>
00980     <span class="comment">//  the number of milliseconds in our input time variable that did not</span>
00981     <span class="comment">//  fit into a whole day.  To compute the hour, minute, second part</span>
00982     <span class="comment">//  we will actually do the arithmetic backwards computing milliseconds</span>
00983     <span class="comment">//  seconds, minutes, and then hours.  We start by computing the</span>
00984     <span class="comment">//  number of whole seconds left in the day, and then computing</span>
00985     <span class="comment">//  the millisecond remainder.</span>
00986     <span class="comment">//</span>
00987 
00988     Seconds = Milliseconds / 1000;
00989     Milliseconds = Milliseconds % 1000;
00990 
00991     <span class="comment">//</span>
00992     <span class="comment">//  Now we compute the number of whole minutes left in the day</span>
00993     <span class="comment">//  and the number of remainder seconds</span>
00994     <span class="comment">//</span>
00995 
00996     Minutes = Seconds / 60;
00997     Seconds = Seconds % 60;
00998 
00999     <span class="comment">//</span>
01000     <span class="comment">//  Now compute the number of whole hours left in the day</span>
01001     <span class="comment">//  and the number of remainder minutes</span>
01002     <span class="comment">//</span>
01003 
01004     Hours = Minutes / 60;
01005     Minutes = Minutes % 60;
01006 
01007     <span class="comment">//</span>
01008     <span class="comment">//  As our final step we put everything into the time fields</span>
01009     <span class="comment">//  output variable</span>
01010     <span class="comment">//</span>
01011 
01012     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Year         = 0;
01013     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Month        = 0;
01014     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Day          = (CSHORT)Days;
01015     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Hour         = (CSHORT)Hours;
01016     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Minute       = (CSHORT)Minutes;
01017     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Second       = (CSHORT)Seconds;
01018     <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>-&gt;Milliseconds = (CSHORT)Milliseconds;
01019 
01020     <span class="comment">//</span>
01021     <span class="comment">//  and return to our caller</span>
01022     <span class="comment">//</span>
01023 
01024     <span class="keywordflow">return</span>;
01025 }
01026 
01027 
01028 BOOLEAN
<a name="l01029"></a><a class="code" href="../../d1/d2/time_8c.html#a30">01029</a> <a class="code" href="../../d1/d2/time_8c.html#a30">RtlTimeToSecondsSince1980</a> (
01030     IN PLARGE_INTEGER Time,
01031     OUT PULONG ElapsedSeconds
01032     )
01033 
01034 <span class="comment">/*++</span>
01035 <span class="comment"></span>
01036 <span class="comment">Routine Description:</span>
01037 <span class="comment"></span>
01038 <span class="comment">    This routine converts an input 64-bit NT Time variable to the</span>
01039 <span class="comment">    number of seconds since the start of 1980.  The NT time must be</span>
01040 <span class="comment">    within the range 1980 to around 2115.</span>
01041 <span class="comment"></span>
01042 <span class="comment">Arguments:</span>
01043 <span class="comment"></span>
01044 <span class="comment">    Time - Supplies the Time to convert from</span>
01045 <span class="comment"></span>
01046 <span class="comment">    ElapsedSeconds - Receives the number of seconds since the start of 1980</span>
01047 <span class="comment">        denoted by Time</span>
01048 <span class="comment"></span>
01049 <span class="comment">Return Value:</span>
01050 <span class="comment"></span>
01051 <span class="comment">    BOOLEAN - TRUE if the input Time is within a range expressible by</span>
01052 <span class="comment">        ElapsedSeconds and FALSE otherwise</span>
01053 <span class="comment"></span>
01054 <span class="comment">--*/</span>
01055 
01056 {
01057     LARGE_INTEGER Seconds;
01058 
01059     <span class="comment">//</span>
01060     <span class="comment">//  First convert time to seconds since 1601</span>
01061     <span class="comment">//</span>
01062 
01063     Seconds = <a class="code" href="../../d3/d6/stdtimep_8h.html#a5">Convert100nsToSeconds</a>( *(PLARGE_INTEGER)<a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> );
01064 
01065     <span class="comment">//</span>
01066     <span class="comment">//  Then subtract the number of seconds from 1601 to 1980.</span>
01067     <span class="comment">//</span>
01068 
01069     Seconds.QuadPart = Seconds.QuadPart - <a class="code" href="../../d3/d6/stdtimep_8h.html#a33">SecondsToStartOf1980</a>.QuadPart;
01070 
01071     <span class="comment">//</span>
01072     <span class="comment">//  If the results is negative then the date was before 1980 or if</span>
01073     <span class="comment">//  the results is greater than a ulong then its too far in the</span>
01074     <span class="comment">//  future so we return FALSE</span>
01075     <span class="comment">//</span>
01076 
01077     <span class="keywordflow">if</span> (Seconds.HighPart != 0) {
01078 
01079         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01080 
01081     }
01082 
01083     <span class="comment">//</span>
01084     <span class="comment">//  Otherwise we have the answer</span>
01085     <span class="comment">//</span>
01086 
01087     *ElapsedSeconds = Seconds.LowPart;
01088 
01089     <span class="comment">//</span>
01090     <span class="comment">//  And return to our caller</span>
01091     <span class="comment">//</span>
01092 
01093     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01094 }
01095 
01096 
01097 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01098"></a><a class="code" href="../../d1/d2/time_8c.html#a31">01098</a> <a class="code" href="../../d1/d2/time_8c.html#a31">RtlSecondsSince1980ToTime</a> (
01099     IN ULONG ElapsedSeconds,
01100     OUT PLARGE_INTEGER Time
01101     )
01102 
01103 <span class="comment">/*++</span>
01104 <span class="comment"></span>
01105 <span class="comment">Routine Description:</span>
01106 <span class="comment"></span>
01107 <span class="comment">    This routine converts the seconds since the start of 1980 to an</span>
01108 <span class="comment">    NT Time value.</span>
01109 <span class="comment"></span>
01110 <span class="comment">Arguments:</span>
01111 <span class="comment"></span>
01112 <span class="comment">    ElapsedSeconds - Supplies the number of seconds from the start of 1980</span>
01113 <span class="comment">        to convert from</span>
01114 <span class="comment"></span>
01115 <span class="comment">    Time - Receives the converted Time value</span>
01116 <span class="comment"></span>
01117 <span class="comment">Return Value:</span>
01118 <span class="comment"></span>
01119 <span class="comment">    None</span>
01120 <span class="comment"></span>
01121 <span class="comment">--*/</span>
01122 
01123 {
01124     LARGE_INTEGER Seconds;
01125 
01126     <span class="comment">//</span>
01127     <span class="comment">//  Move elapsed seconds to a large integer</span>
01128     <span class="comment">//</span>
01129 
01130     Seconds.LowPart = ElapsedSeconds;
01131     Seconds.HighPart = 0;
01132 
01133     <span class="comment">//</span>
01134     <span class="comment">//  convert number of seconds from 1980 to number of seconds from 1601</span>
01135     <span class="comment">//</span>
01136 
01137     Seconds.QuadPart = Seconds.QuadPart + <a class="code" href="../../d3/d6/stdtimep_8h.html#a33">SecondsToStartOf1980</a>.QuadPart;
01138 
01139     <span class="comment">//</span>
01140     <span class="comment">//  Convert seconds to 100ns resolution</span>
01141     <span class="comment">//</span>
01142 
01143     *(PLARGE_INTEGER)<a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> = <a class="code" href="../../d3/d6/stdtimep_8h.html#a6">ConvertSecondsTo100ns</a>( Seconds );
01144 
01145     <span class="comment">//</span>
01146     <span class="comment">//  and return to our caller</span>
01147     <span class="comment">//</span>
01148 
01149     <span class="keywordflow">return</span>;
01150 }
01151 
01152 
01153 BOOLEAN
<a name="l01154"></a><a class="code" href="../../d1/d2/time_8c.html#a32">01154</a> <a class="code" href="../../d1/d2/time_8c.html#a32">RtlTimeToSecondsSince1970</a> (
01155     IN PLARGE_INTEGER Time,
01156     OUT PULONG ElapsedSeconds
01157     )
01158 
01159 <span class="comment">/*++</span>
01160 <span class="comment"></span>
01161 <span class="comment">Routine Description:</span>
01162 <span class="comment"></span>
01163 <span class="comment">    This routine converts an input 64-bit NT Time variable to the</span>
01164 <span class="comment">    number of seconds since the start of 1970.  The NT time must be</span>
01165 <span class="comment">    within the range 1970 to around 2105.</span>
01166 <span class="comment"></span>
01167 <span class="comment">Arguments:</span>
01168 <span class="comment"></span>
01169 <span class="comment">    Time - Supplies the Time to convert from</span>
01170 <span class="comment"></span>
01171 <span class="comment">    ElapsedSeconds - Receives the number of seconds since the start of 1970</span>
01172 <span class="comment">        denoted by Time</span>
01173 <span class="comment"></span>
01174 <span class="comment">Return Value:</span>
01175 <span class="comment"></span>
01176 <span class="comment">    BOOLEAN - TRUE if the input time is within the range expressible by</span>
01177 <span class="comment">        ElapsedSeconds and FALSE otherwise</span>
01178 <span class="comment"></span>
01179 <span class="comment">--*/</span>
01180 
01181 {
01182     LARGE_INTEGER Seconds;
01183 
01184     <span class="comment">//</span>
01185     <span class="comment">//  First convert time to seconds since 1601</span>
01186     <span class="comment">//</span>
01187 
01188     Seconds = <a class="code" href="../../d3/d6/stdtimep_8h.html#a5">Convert100nsToSeconds</a>( *(PLARGE_INTEGER)<a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> );
01189 
01190     <span class="comment">//</span>
01191     <span class="comment">//  Then subtract the number of seconds from 1601 to 1970.</span>
01192     <span class="comment">//</span>
01193 
01194     Seconds.QuadPart = Seconds.QuadPart - <a class="code" href="../../d3/d6/stdtimep_8h.html#a32">SecondsToStartOf1970</a>.QuadPart;
01195 
01196     <span class="comment">//</span>
01197     <span class="comment">//  If the results is negative then the date was before 1970 or if</span>
01198     <span class="comment">//  the results is greater than a ulong then its too far in the</span>
01199     <span class="comment">//  future so we return FALSE</span>
01200     <span class="comment">//</span>
01201 
01202     <span class="keywordflow">if</span> (Seconds.HighPart != 0) {
01203 
01204         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01205 
01206     }
01207 
01208     <span class="comment">//</span>
01209     <span class="comment">//  Otherwise we have the answer</span>
01210     <span class="comment">//</span>
01211 
01212     *ElapsedSeconds = Seconds.LowPart;
01213 
01214     <span class="comment">//</span>
01215     <span class="comment">//  And return to our caller</span>
01216     <span class="comment">//</span>
01217 
01218     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01219 }
01220 
01221 
01222 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01223"></a><a class="code" href="../../d1/d2/time_8c.html#a33">01223</a> <a class="code" href="../../d1/d2/time_8c.html#a33">RtlSecondsSince1970ToTime</a> (
01224     IN ULONG ElapsedSeconds,
01225     OUT PLARGE_INTEGER Time
01226     )
01227 
01228 <span class="comment">/*++</span>
01229 <span class="comment"></span>
01230 <span class="comment">Routine Description:</span>
01231 <span class="comment"></span>
01232 <span class="comment">    This routine converts the seconds since the start of 1970 to an</span>
01233 <span class="comment">    NT Time value</span>
01234 <span class="comment"></span>
01235 <span class="comment">Arguments:</span>
01236 <span class="comment"></span>
01237 <span class="comment">    ElapsedSeconds - Supplies the number of seconds from the start of 1970</span>
01238 <span class="comment">        to convert from</span>
01239 <span class="comment"></span>
01240 <span class="comment">    Time - Receives the converted Time value</span>
01241 <span class="comment"></span>
01242 <span class="comment">Return Value:</span>
01243 <span class="comment"></span>
01244 <span class="comment">    None</span>
01245 <span class="comment"></span>
01246 <span class="comment">--*/</span>
01247 
01248 {
01249     LARGE_INTEGER Seconds;
01250 
01251     <span class="comment">//</span>
01252     <span class="comment">//  Move elapsed seconds to a large integer</span>
01253     <span class="comment">//</span>
01254 
01255     Seconds.LowPart = ElapsedSeconds;
01256     Seconds.HighPart = 0;
01257 
01258     <span class="comment">//</span>
01259     <span class="comment">//  Convert number of seconds from 1970 to number of seconds from 1601</span>
01260     <span class="comment">//</span>
01261 
01262     Seconds.QuadPart = Seconds.QuadPart + <a class="code" href="../../d3/d6/stdtimep_8h.html#a32">SecondsToStartOf1970</a>.QuadPart;
01263 
01264     <span class="comment">//</span>
01265     <span class="comment">//  Convert seconds to 100ns resolution</span>
01266     <span class="comment">//</span>
01267 
01268     *(PLARGE_INTEGER)<a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> = <a class="code" href="../../d3/d6/stdtimep_8h.html#a6">ConvertSecondsTo100ns</a>( Seconds );
01269 
01270     <span class="comment">//</span>
01271     <span class="comment">//  return to our caller</span>
01272     <span class="comment">//</span>
01273 
01274     <span class="keywordflow">return</span>;
01275 }
01276 
01277 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01278"></a><a class="code" href="../../d1/d2/time_8c.html#a34">01278</a> <a class="code" href="../../d1/d2/time_8c.html#a34">RtlSystemTimeToLocalTime</a> (
01279     IN PLARGE_INTEGER SystemTime,
01280     OUT PLARGE_INTEGER LocalTime
01281     )
01282 {
01283     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01284     SYSTEM_TIMEOFDAY_INFORMATION TimeOfDay;
01285 
01286     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQuerySystemInformation(
01287                 SystemTimeOfDayInformation,
01288                 &amp;TimeOfDay,
01289                 <span class="keyword">sizeof</span>(TimeOfDay),
01290                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01291                 );
01292     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01293         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01294         }
01295 
01296     <span class="comment">//</span>
01297     <span class="comment">// LocalTime = SystemTime - TimeZoneBias</span>
01298     <span class="comment">//</span>
01299 
01300     LocalTime-&gt;QuadPart = SystemTime-&gt;QuadPart - TimeOfDay.TimeZoneBias.QuadPart;
01301 
01302     <span class="keywordflow">return</span> STATUS_SUCCESS;
01303 }
01304 
01305 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01306"></a><a class="code" href="../../d1/d2/time_8c.html#a35">01306</a> <a class="code" href="../../d1/d2/time_8c.html#a35">RtlLocalTimeToSystemTime</a> (
01307     IN PLARGE_INTEGER LocalTime,
01308     OUT PLARGE_INTEGER SystemTime
01309     )
01310 {
01311 
01312     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01313     SYSTEM_TIMEOFDAY_INFORMATION TimeOfDay;
01314 
01315     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQuerySystemInformation(
01316                 SystemTimeOfDayInformation,
01317                 &amp;TimeOfDay,
01318                 <span class="keyword">sizeof</span>(TimeOfDay),
01319                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01320                 );
01321     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01322         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01323         }
01324 
01325     <span class="comment">//</span>
01326     <span class="comment">// SystemTime = LocalTime + TimeZoneBias</span>
01327     <span class="comment">//</span>
01328 
01329     SystemTime-&gt;QuadPart = LocalTime-&gt;QuadPart + TimeOfDay.TimeZoneBias.QuadPart;
01330 
01331     <span class="keywordflow">return</span> STATUS_SUCCESS;
01332 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:59 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
