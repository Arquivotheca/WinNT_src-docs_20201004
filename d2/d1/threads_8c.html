<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: threads.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>threads.c File Reference</h1><code>#include &lt;<a class="el" href="../../d0/d8/ntos_8h-source.html">ntos.h</a>&gt;</code><br>
<code>#include &lt;ntrtl.h&gt;</code><br>
<code>#include &lt;nturtl.h&gt;</code><br>
<code>#include "<a class="el" href="../../d6/d8/ntrtlp_8h-source.html">ntrtlp.h</a>"</code><br>
<code>#include "<a class="el" href="../../d4/d0/threads_8h-source.html">threads.h</a>"</code><br>

<p>
<a href="../../d3/d0/threads_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a0">WORKER_IDLE_TIMEOUT</a>&nbsp;&nbsp;&nbsp;40000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a1">MAX_WORKER_SLEEP_TIME_EXPONENT</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a2">IOWORKER_IDLE_TIMEOUT</a>&nbsp;&nbsp;&nbsp;40000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a3">WAIT_IDLE_TIMEOUT</a>&nbsp;&nbsp;&nbsp;400000</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a5">RtlRegisterWait</a> (OUT PHANDLE WaitHandle, IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN WAITORTIMERCALLBACKFUNC Function, IN PVOID Context, IN ULONG Milliseconds, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a6">RtlDeregisterWait</a> (IN HANDLE WaitHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a7">RtlDeregisterWaitEx</a> (IN HANDLE WaitHandle, IN HANDLE Event)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a8">RtlQueueWorkItem</a> (IN WORKERCALLBACKFUNC Function, IN PVOID Context, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a9">RtlSetIoCompletionCallback</a> (IN HANDLE FileHandle, IN APC_CALLBACK_FUNCTION CompletionProc, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a10">RtlCreateTimerQueue</a> (OUT PHANDLE TimerQueueHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a11">RtlDeleteTimerQueue</a> (IN HANDLE TimerQueueHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a12">RtlDeleteTimerQueueEx</a> (HANDLE QueueHandle, HANDLE Event)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a13">RtlCreateTimer</a> (IN HANDLE TimerQueueHandle, OUT HANDLE *<a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN WAITORTIMERCALLBACKFUNC Function, IN PVOID Context, IN ULONG DueTime, IN ULONG Period, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a14">RtlUpdateTimer</a> (IN HANDLE TimerQueueHandle, IN HANDLE Timer, IN ULONG DueTime, IN ULONG Period)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a15">RtlDeleteTimer</a> (IN HANDLE TimerQueueHandle, IN HANDLE TimerToCancel, IN HANDLE Event)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS NTAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a16">RtlSetThreadPoolStartFunc</a> (PRTLP_START_THREAD StartFunc, PRTLP_EXIT_THREAD ExitFunc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a17">RtlThreadPoolCleanup</a> (ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a18">RtlpQueueWorkerRequest</a> (WORKERCALLBACKFUNC Function, PVOID Context, ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a19">RtlpExecuteWorkerRequest</a> (NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>, PVOID Context, PVOID WorkContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a20">RtlpQueueIOWorkerRequest</a> (WORKERCALLBACKFUNC Function, PVOID Context, ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a21">RtlpStartWorkerThread</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a22">RtlpStartIOWorkerThread</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a23">RtlpWorkerThreadTimerCallback</a> (PVOID Context, BOOLEAN NotUsed)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a24">RtlpInitializeWorkerThreadPool</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a25">RtlpWorkerThreadInitializeTimers</a> (PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a26">RtlpWorkerThread</a> (PVOID Initialized)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a27">RtlpIOWorkerThread</a> (PVOID Initialized)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a28">RtlpExecuteLongIOWorkItem</a> (PVOID Function, PVOID Context, PVOID ThreadCB)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a29">RtlpExecuteIOWorkItem</a> (PVOID Function, PVOID Context, PVOID NotUsed)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS NTAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a30">RtlpStartThread</a> (PUSER_THREAD_START_ROUTINE Function, HANDLE *<a class="el" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a31">RtlpExitThread</a> (NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a32">RtlpInitializeWaitThreadPool</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a33">RtlpWaitThread</a> (PVOID Initialized)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a34">RtlpAsyncCallbackCompletion</a> (PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a35">RtlpProcessWaitCompletion</a> (<a class="el" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> Wait, ULONG ArrayIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a36">RtlpAddWait</a> (<a class="el" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> Wait)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a37">RtlpDeregisterWait</a> (<a class="el" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> Wait, HANDLE PartialCompletionEvent, PULONG RetStatusPtr)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a38">RtlpDeactivateWait</a> (<a class="el" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> Wait)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a39">RtlpDeleteWait</a> (<a class="el" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> Wait)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a40">RtlpDoNothing</a> (PVOID NotUsed1, PVOID NotUsed2, PVOID NotUsed3)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>__inline LONGLONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a41">RtlpGet64BitTickCount</a> (LARGE_INTEGER *<a class="el" href="../../d3/d1/threads_8h.html#a109">Last64BitTickCount</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>__inline LONGLONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a42">RtlpResync64BitTickCount</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a43">RtlpProcessTimeouts</a> (<a class="el" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCB)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a44">RtlpFireTimers</a> (PLIST_ENTRY TimersToFireList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a45">RtlpFindWaitThread</a> (<a class="el" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> *ThreadCB)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a46">RtlpAddTimer</a> (PRTLP_TIMER Timer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a47">RtlpUpdateTimer</a> (PRTLP_TIMER Timer, PRTLP_TIMER UpdatedTimer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a48">RtlpCancelTimer</a> (PRTLP_TIMER Timer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a49">RtlpCancelTimerEx</a> (PRTLP_TIMER Timer, BOOLEAN DeletingQueue)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a50">RtlpDeactivateTimer</a> (PRTLP_TIMER_QUEUE Queue, PRTLP_TIMER Timer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a51">RtlpDeleteTimer</a> (PRTLP_TIMER Timer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a52">RtlpGetQueueRelativeTime</a> (PRTLP_TIMER_QUEUE Queue)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a53">RtlpGetTimeRemaining</a> (HANDLE <a class="el" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a54">RtlpResetTimer</a> (HANDLE <a class="el" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>, ULONG DueTime, <a class="el" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCB)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a55">RtlpInsertInDeltaList</a> (PLIST_ENTRY DeltaList, <a class="el" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a> NewTimer, ULONG TimeRemaining, ULONG *NewFiringTime)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a56">RtlpRemoveFromDeltaList</a> (PLIST_ENTRY DeltaList, <a class="el" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a> Timer, ULONG TimeRemaining, ULONG *NewFiringTime)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a57">RtlpReOrderDeltaList</a> (PLIST_ENTRY DeltaList, <a class="el" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a> Timer, ULONG TimeRemaining, ULONG *NewFiringTime, ULONG ChangedFiringTime)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a58">RtlpAddTimerQueue</a> (PVOID Queue)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a59">RtlpServiceTimer</a> (PVOID NotUsedArg, ULONG NotUsedLowTimer, LONG NotUsedHighTimer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a60">RtlpFireTimersAndReorder</a> (PRTLP_TIMER_QUEUE Queue, ULONG *NewFiringTime, PLIST_ENTRY TimersToFireList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a61">RtlpInsertTimersIntoDeltaList</a> (IN PLIST_ENTRY NewTimerList, IN PLIST_ENTRY DeltaTimerList, IN ULONG TimeRemaining, OUT ULONG *NewFiringTime)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a62">RtlpTimerThread</a> (PVOID Initialized)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a63">RtlpInitializeTimerThreadPool</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a64">RtlpDeleteTimerQueue</a> (PRTLP_TIMER_QUEUE Queue)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a65">RtlpDeleteTimerQueueComplete</a> (PRTLP_TIMER_QUEUE Queue)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a66">RtlpThreadCleanup</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a67">RtlpWaitForEvent</a> (HANDLE Event, HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a68">RtlpGetWaitEvent</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a69">RtlpFreeWaitEvent</a> (<a class="el" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a> Event)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a70">RtlpInitializeEventCache</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a71">PrintTimerQueue</a> (PLIST_ENTRY QNode, ULONG Delta, ULONG <a class="el" href="../../d6/d0/cmdat_8c.html#a5">Count</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a72">RtlDebugPrintTimes</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a73">RtlSetTimer</a> (IN HANDLE TimerQueueHandle, OUT HANDLE *<a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN WAITORTIMERCALLBACKFUNC Function, IN PVOID Context, IN ULONG DueTime, IN ULONG Period, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a74">RtlpForceAllocateTPHeap</a> (ULONG dwSize, ULONG <a class="el" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a75">RtlCancelTimer</a> (IN HANDLE TimerQueueHandle, IN HANDLE TimerToCancel)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/threads_8c.html#a4">DPRN</a> = 0x0000000</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a2" doxytag="threads.c::IOWORKER_IDLE_TIMEOUT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IOWORKER_IDLE_TIMEOUT&nbsp;&nbsp;&nbsp;40000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l02370">RtlpIOWorkerThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="threads.c::MAX_WORKER_SLEEP_TIME_EXPONENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_WORKER_SLEEP_TIME_EXPONENT&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l02137">RtlpWorkerThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="threads.c::WAIT_IDLE_TIMEOUT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define WAIT_IDLE_TIMEOUT&nbsp;&nbsp;&nbsp;400000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l02824">RtlpWaitThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="threads.c::WORKER_IDLE_TIMEOUT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define WORKER_IDLE_TIMEOUT&nbsp;&nbsp;&nbsp;40000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l02137">RtlpWorkerThread()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a71" doxytag="threads.c::PrintTimerQueue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PrintTimerQueue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>QNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Delta</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Count</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l05745">5745</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00045">PRTLP_TIMER</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00048">PRTLP_TIMER_QUEUE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00044">RTLP_TIMER</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00047">RTLP_TIMER_QUEUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l05767">RtlDebugPrintTimes()</a>.
<p>
<pre class="fragment"><div>05747 {
05748     PLIST_ENTRY Tnode ;
05749     <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> Timer ;
05750     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue ;
05751     
05752     Queue = CONTAINING_RECORD (QNode, RTLP_TIMER_QUEUE, List) ;
05753     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%1d&gt; Queue: %x FiringTime:%d\n"</span>, Count, (ULONG_PTR)Queue, 
05754                 Queue-&gt;DeltaFiringTime);
05755     <span class="keywordflow">for</span> (Tnode=Queue-&gt;TimerList.Flink; Tnode!=&amp;Queue-&gt;TimerList; 
05756             Tnode=Tnode-&gt;Flink) 
05757     {
05758         Timer = CONTAINING_RECORD (Tnode, RTLP_TIMER, List) ;
05759         Delta += Timer-&gt;DeltaFiringTime ;
05760         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        Timer: %x Delta:%d Period:%d\n"</span>,(ULONG_PTR)Timer,
05761                     Delta, Timer-&gt;Period);
05762     }
05763 
05764 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a75" doxytag="threads.c::RtlCancelTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlCancelTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerQueueHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerToCancel</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l05895">5895</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l01145">RtlDeleteTimer()</a>.
<p>
<pre class="fragment"><div>05901                    :
05902 
05903     This routine cancels <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer. This call <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> non-blocking. The timer Callback
05904     will not be executed after <span class="keyword">this</span> call returns.
05905 
05906 Arguments:
05907 
05908     TimerQueueHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue from which to <span class="keyword">delete</span> timer
05909 
05910     TimerToCancel - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer to cancel
05911 
05912 Return Value:
05913 
05914     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call.  The following are returned
05915 
05916         STATUS_SUCCESS - Timer cancelled. All callbacks completed.
05917         STATUS_PENDING - Timer cancelled. Some callbacks still not completed.
05918 
05919 --*/
05920 {
05921     <span class="keyword">static</span> ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
05922     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++ ==0) {
05923         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Using obsolete function call: RtlCancelTimer\n"</span>);
05924         DbgBreakPoint();
05925         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Using obsolete function call: RtlCancelTimer\n"</span>);
05926     }
05927     
05928     <span class="keywordflow">return</span> <a class="code" href="../../d2/d1/threads_8c.html#a15">RtlDeleteTimer</a>( TimerQueueHandle, TimerToCancel, NULL ) ;
05929 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="threads.c::RtlCreateTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlCreateTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerQueueHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT HANDLE *&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN WAITORTIMERCALLBACKFUNC&nbsp;</td>
          <td class="mdname" nowrap> <em>Function</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DueTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Period</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l00944">944</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00407">DPRN1</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00056">NtQueueApcThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00045">PRTLP_TIMER</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00048">PRTLP_TIMER_QUEUE</a>, <a class="el" href="../../d1/d2/ppc_2initkr_8c-source.html#l00562">RefCount</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00044">RTLP_TIMER</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03954">RtlpAddTimer()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00305">RtlpAllocateTPHeap</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00395">SET_SIGNATURE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00221">TimerThreadHandle</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l02104">RtlpWorkerThreadInitializeTimers()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l05818">RtlSetTimer()</a>.
<p>
<pre class="fragment"><div>00955                    :
00956 
00957     This routine puts a timer request in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue identified in by TimerQueueHandle.
00958     The timer request can be one shot or periodic.
00959 
00960 Arguments:
00961 
00962     TimerQueueHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer queue in which to insert <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer
00963                     request.
00964 
00965     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Specifies a location to <span class="keywordflow">return</span> a handle to <span class="keyword">this</span> timer request
00966 
00967     Function - Routine that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer fires
00968 
00969     Context - Opaque pointer passed in as an argument to WorkerProc
00970 
00971     DueTime - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time in milliseconds after which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer fires.
00972 
00973     Period - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> period of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer in milliseconds. This should be 0 <span class="keywordflow">for</span>
00974     one shot requests.
00975 
00976     Flags - Can be one of:
00977 
00978             WT_EXECUTEINTIMERTHREAD - <span class="keywordflow">if</span> WorkerProc should be invoked in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait thread
00979             <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keyword">this</span> should <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be used <span class="keywordflow">for</span> small <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>.
00980 
00981             WT_EXECUTELONGFUNCTION - <span class="keywordflow">if</span> WorkerProc can possibly block <span class="keywordflow">for</span> a <span class="keywordtype">long</span> time.
00982 
00983             WT_EXECUTEINIOTHREAD - <span class="keywordflow">if</span> WorkerProc should be invoked in IO worker thread
00984             
00985 Return Value:
00986 
00987     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call.  The following are returned
00988 
00989         STATUS_SUCCESS - Timer Queue created successfully.
00990 
00991         STATUS_NO_MEMORY - There was not sufficient heap to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00992             requested operation.
00993 
00994 --*/
00995 
00996 {
00997     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00998     <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> Timer ;
00999 
01000     Timer = (<a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a>) <a class="code" href="../../d3/d1/threads_8h.html#a18">RtlpAllocateTPHeap</a> (
01001                                 <span class="keyword">sizeof</span> (RTLP_TIMER),
01002                                 HEAP_ZERO_MEMORY
01003                                 ) ;
01004 
01005     <span class="keywordflow">if</span> (Timer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01006 
01007         <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
01008 
01009     }
01010 
01011     <span class="comment">// Initialize the allocated timer</span>
01012 
01013     Timer-&gt;DeltaFiringTime = DueTime ;
01014     Timer-&gt;Queue = (<a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a>) TimerQueueHandle ;
01015     Timer-&gt;RefCount = 1 ;
01016     Timer-&gt;Flags = Flags ;
01017     Timer-&gt;Function = Function ;
01018     Timer-&gt;Context = Context ;
01019     <span class="comment">//todo:remove below</span>
01020     Timer-&gt;Period = (Period == -1) ? 0 : Period;
01021     InitializeListHead( &amp;Timer-&gt;TimersToFireList ) ;
01022     <a class="code" href="../../d3/d1/threads_8h.html#a28">SET_SIGNATURE</a>( Timer ) ;
01023     
01024     
01025 <span class="preprocessor">    #if DBG1</span>
01026 <span class="preprocessor"></span>    Timer-&gt;DbgId = ++ Timer-&gt;Queue-&gt;NextDbgId ;
01027     Timer-&gt;ThreadId = HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
01028     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a35">DPRN1</a>)
01029     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n&lt;%d:%d:%d&gt; Timer: created by Thread:&lt;%x:%x&gt;\n\n"</span>, 
01030             Timer-&gt;Queue-&gt;DbgId, Timer-&gt;DbgId, 1,
01031             HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
01032             HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
01033 <span class="preprocessor">    #endif</span>
01034 <span class="preprocessor"></span>
01035     *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = Timer ;
01036 
01037 
01038     <span class="comment">// Increment the total number of timers in the queue</span>
01039 
01040     InterlockedIncrement( &amp;((PRTLP_TIMER_QUEUE)TimerQueueHandle)-&gt;RefCount ) ;
01041 
01042 
01043     <span class="comment">// Queue APC to timer thread</span>
01044 
01045     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
01046                     TimerThreadHandle,
01047                     (PPS_APC_ROUTINE)RtlpAddTimer,
01048                     (PVOID)Timer,
01049                     NULL,
01050                     NULL
01051                     ) ;
01052 
01053     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01054 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="threads.c::RtlCreateTimerQueue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlCreateTimerQueue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TimerQueueHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l00691">691</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00216">CompletedTimerInitialization</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00406">DPRN0</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00103">NextTimerDbgId</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00253">NumTimerQueues</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00048">PRTLP_TIMER_QUEUE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00047">RTLP_TIMER_QUEUE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00305">RtlpAllocateTPHeap</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05256">RtlpInitializeTimerThreadPool()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00395">SET_SIGNATURE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l02104">RtlpWorkerThreadInitializeTimers()</a>.
<p>
<pre class="fragment"><div>00697                    :
00698 
00699     This routine creates a queue that can be used to queue time based tasks.
00700 
00701 Arguments:
00702 
00703     TimerQueueHandle - Returns back <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer queue created.
00704 
00705 Return Value:
00706 
00707     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call.  The following are returned
00708 
00709         STATUS_SUCCESS - Timer Queue created successfully.
00710 
00711         STATUS_NO_MEMORY - There was not sufficient heap to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00712             requested operation.
00713 
00714 --*/
00715 
00716 {
00717     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue ;
00718     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00719 
00720 
00721     <span class="comment">// Initialize the timer component if it hasnt been done already</span>
00722 
00723     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a69">CompletedTimerInitialization</a> != 1) {
00724 
00725         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a63">RtlpInitializeTimerThreadPool</a> () ;
00726 
00727         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) )
00728             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00729 
00730     }
00731 
00732 
00733     InterlockedIncrement( &amp;NumTimerQueues ) ;
00734 
00735     
00736     <span class="comment">// Allocate a Queue structure</span>
00737 
00738     Queue = (<a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a>) <a class="code" href="../../d3/d1/threads_8h.html#a18">RtlpAllocateTPHeap</a> (
00739                                       <span class="keyword">sizeof</span> (RTLP_TIMER_QUEUE),
00740                                       HEAP_ZERO_MEMORY
00741                                       ) ;
00742 
00743     <span class="keywordflow">if</span> (Queue == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00744 
00745         InterlockedDecrement( &amp;NumTimerQueues ) ;
00746         
00747         <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
00748     }
00749 
00750     Queue-&gt;RefCount = 1 ;
00751 
00752     
00753     <span class="comment">// Initialize the allocated queue</span>
00754 
00755     InitializeListHead (&amp;Queue-&gt;List) ;
00756     InitializeListHead (&amp;Queue-&gt;TimerList) ;
00757     InitializeListHead (&amp;Queue-&gt;UncancelledTimerList) ;
00758     <a class="code" href="../../d3/d1/threads_8h.html#a28">SET_SIGNATURE</a>( Queue ) ;
00759 
00760     Queue-&gt;DeltaFiringTime = 0 ;
00761 
00762 <span class="preprocessor">    #if DBG1</span>
00763 <span class="preprocessor"></span>    Queue-&gt;DbgId = ++<a class="code" href="../../d3/d1/threads_8h.html#a48">NextTimerDbgId</a> ;
00764     Queue-&gt;ThreadId = HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
00765     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
00766     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d:%d&gt; TimerQueue %x created by thread:&lt;%x:%x&gt;\n\n"</span>, 
00767                 Queue-&gt;DbgId, 1, (ULONG_PTR)Queue,
00768                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
00769                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
00770 <span class="preprocessor">    #endif</span>
00771 <span class="preprocessor"></span>    
00772     *TimerQueueHandle = Queue ;
00773     
00774     <span class="keywordflow">return</span> STATUS_SUCCESS ;
00775 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a72" doxytag="threads.c::RtlDebugPrintTimes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlDebugPrintTimes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l05767">5767</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00216">CompletedTimerInitialization</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00056">NtQueueApcThread()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05745">PrintTimerQueue()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00048">PRTLP_TIMER_QUEUE</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05767">RtlDebugPrintTimes()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00047">RTLP_TIMER_QUEUE</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04378">RtlpGetTimeRemaining()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03674">RtlpResync64BitTickCount()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00252">TimerHandle</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00251">TimerQueues</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00221">TimerThreadHandle</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00222">TimerThreadId</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l05767">RtlDebugPrintTimes()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l04821">RtlpServiceTimer()</a>.
<p>
<pre class="fragment"><div>05769 {    
05770     PLIST_ENTRY QNode ;
05771     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0 ;
05772     ULONG Delta = <a class="code" href="../../d3/d1/threads_8h.html#a136">RtlpGetTimeRemaining</a> (TimerHandle) ;
05773     ULONG CurrentThreadId =  
05774                         HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
05775 
05776     <a class="code" href="../../d2/d1/threads_8c.html#a42">RtlpResync64BitTickCount</a>();
05777 
05778     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a69">CompletedTimerInitialization</a> != 1) {
05779 
05780         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"===========RtlTimerThread not yet initialized==========\n"</span>);
05781         <span class="keywordflow">return</span> ;
05782     }
05783 
05784     <span class="keywordflow">if</span> (CurrentThreadId == <a class="code" href="../../d3/d1/threads_8h.html#a73">TimerThreadId</a>)
05785     {
05786         <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue ;
05787         
05788         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"================Printing timerqueues====================\n"</span>);
05789         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"TimeRemaining: %d\n"</span>, Delta);
05790         <span class="keywordflow">for</span> (QNode = <a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>.Flink; QNode != &amp;<a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>; 
05791                 QNode = QNode-&gt;Flink)
05792         {
05793             Queue = CONTAINING_RECORD (QNode, RTLP_TIMER_QUEUE, List) ;
05794             Delta += Queue-&gt;DeltaFiringTime ;
05795             
05796             <a class="code" href="../../d2/d1/threads_8c.html#a71">PrintTimerQueue</a>(QNode, Delta, ++Count);
05797             
05798         }
05799         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"================Printed ================================\n"</span>);
05800     }
05801 
05802     <span class="keywordflow">else</span>
05803     {
05804         <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
05805                     TimerThreadHandle,
05806                     (PPS_APC_ROUTINE)RtlDebugPrintTimes,
05807                     NULL,
05808                     NULL,
05809                     NULL
05810                     );
05811     }
05812 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="threads.c::RtlDeleteTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlDeleteTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerQueueHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerToCancel</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Event</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l01145">1145</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00320">ACQUIRE_GLOBAL_TIMER_LOCK</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00398">CHECK_DEL_SIGNATURE</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00406">DPRN0</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00198">_RTLP_EVENT::Handle</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00056">NtQueueApcThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00045">PRTLP_TIMER</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00048">PRTLP_TIMER_QUEUE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00323">RELEASE_GLOBAL_TIMER_LOCK</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04120">RtlpCancelTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05648">RtlpFreeWaitEvent()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05575">RtlpGetWaitEvent()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05503">RtlpWaitForEvent()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00397">SET_DEL_SIGNATURE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00766">STATE_DONTFIRE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00221">TimerThreadHandle</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l05895">RtlCancelTimer()</a>.
<p>
<pre class="fragment"><div>01152                    :
01153 
01154     This routine cancels <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer
01155 
01156 Arguments:
01157 
01158     TimerQueueHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue from which to <span class="keyword">delete</span> timer
01159 
01160     TimerToCancel - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer to cancel
01161 
01162     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> to be signalled when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deleted
01163             (HANDLE)-1: The function creates an event and waits on <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01164             <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> : The caller passes an event. The function marks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer <span class="keywordflow">for</span> deletion,
01165                     but does not wait <span class="keywordflow">for</span> all callbacks to complete. The event <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 
01166                     signalled after all callbacks have completed.
01167             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : The function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> non-blocking. The function marks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer <span class="keywordflow">for</span> deletion,
01168                     but does not wait <span class="keywordflow">for</span> all callbacks to complete.
01169 
01170 Return Value:
01171 
01172     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call.  The following are returned
01173 
01174         STATUS_SUCCESS - Timer cancelled. No pending callbacks.
01175         STATUS_PENDING - Timer cancelled. Some callbacks still not completed.
01176 
01177 --*/
01178 {
01179     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01180     <a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a> CompletionEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
01181     <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> Timer = (<a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a>) TimerToCancel ;
01182     ULONG TimerRefCount ;
01183 <span class="preprocessor">    #if DBG1</span>
01184 <span class="preprocessor"></span>    ULONG QueueDbgId ;
01185 <span class="preprocessor">    #endif</span>
01186 <span class="preprocessor"></span>
01187 
01188     <span class="keywordflow">if</span> (!TimerQueueHandle || !TimerToCancel) {
01189         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FALSE ) ;
01190         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER ;
01191     }
01192 
01193 <span class="preprocessor">    #if DBG1</span>
01194 <span class="preprocessor"></span>    QueueDbgId = Timer-&gt;Queue-&gt;DbgId ;
01195 <span class="preprocessor">    #endif</span>
01196 <span class="preprocessor"></span>
01197 
01198     <a class="code" href="../../d3/d1/threads_8h.html#a31">CHECK_DEL_SIGNATURE</a>( Timer ) ;
01199     <a class="code" href="../../d3/d1/threads_8h.html#a30">SET_DEL_SIGNATURE</a>( Timer ) ;
01200     <a class="code" href="../../d3/d1/threads_8h.html#a31">CHECK_DEL_SIGNATURE</a>( (PRTLP_TIMER_QUEUE)TimerQueueHandle ) ;
01201 
01202     
01203     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> == (HANDLE)-1 ) {
01204 
01205         <span class="comment">// Get an event from the event cache</span>
01206 
01207         CompletionEvent = <a class="code" href="../../d3/d1/threads_8h.html#a158">RtlpGetWaitEvent</a> () ;
01208 
01209         <span class="keywordflow">if</span> (!CompletionEvent) {
01210 
01211             <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
01212         }
01213     }
01214 
01215 <span class="preprocessor">    #if DBG1</span>
01216 <span class="preprocessor"></span>    Timer-&gt;ThreadId2 = HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
01217 <span class="preprocessor">    #endif</span>
01218 <span class="preprocessor"></span><span class="preprocessor">    #if DBG1</span>
01219 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
01220     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n&lt;%d:%d:%d&gt; Timer: Cancel:(Timer:%x, Event:%x)\n\n"</span>, 
01221                 Timer-&gt;Queue-&gt;DbgId, Timer-&gt;DbgId, Timer-&gt;RefCount, 
01222                 (ULONG_PTR)Timer, (ULONG_PTR)Event) ;
01223 <span class="preprocessor">    #endif</span>
01224 <span class="preprocessor"></span>
01225     Timer-&gt;CompletionEvent = CompletionEvent
01226                             ? CompletionEvent-&gt;<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html#o1">Handle</a> 
01227                             : <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> ;
01228 
01229 
01230     <a class="code" href="../../d3/d1/threads_8h.html#a21">ACQUIRE_GLOBAL_TIMER_LOCK</a>();
01231     Timer-&gt;State |= <a class="code" href="../../d3/d1/threads_8h.html#a44">STATE_DONTFIRE</a> ;
01232     TimerRefCount = Timer-&gt;RefCount ;
01233     <a class="code" href="../../d3/d1/threads_8h.html#a22">RELEASE_GLOBAL_TIMER_LOCK</a>();
01234 
01235     
01236     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
01237                 TimerThreadHandle,
01238                 (PPS_APC_ROUTINE)RtlpCancelTimer,
01239                 (PVOID)TimerToCancel,
01240                 NULL,
01241                 NULL
01242                 );
01243 
01244     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01245 
01246         <a class="code" href="../../d3/d1/threads_8h.html#a156">RtlpFreeWaitEvent</a>( CompletionEvent ) ;
01247 
01248         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01249     }
01250 
01251 
01252     
01253     <span class="keywordflow">if</span> ( CompletionEvent ) {
01254 
01255         <span class="comment">// wait for the event to be signalled </span>
01256 
01257 <span class="preprocessor">        #if DBG1</span>
01258 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
01259         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d&gt; Timer: %x: Cancel waiting Thread&lt;%d:%d&gt;\n\n"</span>, 
01260                 QueueDbgId, (ULONG_PTR)Timer,
01261                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
01262                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
01263 <span class="preprocessor">        #endif</span>
01264 <span class="preprocessor"></span>
01265         
01266         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a163">RtlpWaitForEvent</a>( CompletionEvent-&gt;<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html#o1">Handle</a>,  TimerThreadHandle ) ;
01267 
01268         
01269 <span class="preprocessor">        #if DBG1</span>
01270 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
01271         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d&gt; Timer: %x: Cancel waiting done\n\n"</span>, QueueDbgId, 
01272                 (ULONG_PTR)Timer) ;
01273 <span class="preprocessor">        #endif</span>
01274 <span class="preprocessor"></span>
01275 
01276         <a class="code" href="../../d3/d1/threads_8h.html#a156">RtlpFreeWaitEvent</a>( CompletionEvent ) ;
01277 
01278         <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ? STATUS_SUCCESS : <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01279 
01280     } <span class="keywordflow">else</span> {
01281 
01282         <span class="keywordflow">return</span> (TimerRefCount &gt; 1) ? STATUS_PENDING : STATUS_SUCCESS;
01283     }
01284 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="threads.c::RtlDeleteTimerQueue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlDeleteTimerQueue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TimerQueueHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l00779">779</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l00809">RtlDeleteTimerQueueEx()</a>.
<p>
<pre class="fragment"><div>00785                    :
00786 
00787     This routine deletes a previously created queue. This call <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> non-blocking and 
00788     can be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> from Callbacks. Pending callbacks already queued to worker threads
00789     are not cancelled.
00790 
00791 Arguments:
00792 
00793     TimerQueueHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer queue created.
00794 
00795 Return Value:
00796 
00797     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call.
00798 
00799         STATUS_PENDING - Timer Queue created successfully.
00800         
00801 --*/
00802 
00803 {
00804     <span class="keywordflow">return</span> <a class="code" href="../../d2/d1/threads_8c.html#a12">RtlDeleteTimerQueueEx</a>( TimerQueueHandle, NULL ) ;
00805 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="threads.c::RtlDeleteTimerQueueEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlDeleteTimerQueueEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>QueueHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Event</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l00809">809</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00320">ACQUIRE_GLOBAL_TIMER_LOCK</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00398">CHECK_DEL_SIGNATURE</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00406">DPRN0</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00198">_RTLP_EVENT::Handle</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00056">NtQueueApcThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00048">PRTLP_TIMER_QUEUE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00323">RELEASE_GLOBAL_TIMER_LOCK</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05354">RtlpDeleteTimerQueue()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05648">RtlpFreeWaitEvent()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05575">RtlpGetWaitEvent()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05503">RtlpWaitForEvent()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00397">SET_DEL_SIGNATURE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00766">STATE_DONTFIRE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00221">TimerThreadHandle</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l00779">RtlDeleteTimerQueue()</a>.
<p>
<pre class="fragment"><div>00815                    :
00816 
00817     This routine deletes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> and frees all timers.
00818     This call <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> blocking or non-blocking depending on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value passed <span class="keywordflow">for</span> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.
00819     Blocking calls cannot be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> from ANY Timer callbacks. After <span class="keyword">this</span> call returns,
00820     no <span class="keyword">new</span> Callbacks will be fired <span class="keywordflow">for</span> any timer associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue.
00821 
00822 Arguments:
00823 
00824     QueueHandle - queue to <span class="keyword">delete</span>
00825 
00826     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> to wait upon.
00827             (HANDLE)-1: The function creates an event and waits on <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00828             <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> : The caller passes an event. The function marks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue <span class="keywordflow">for</span> deletion,
00829                     but does not wait <span class="keywordflow">for</span> all callbacks to complete. The event <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 
00830                     signalled after all callbacks have completed.
00831             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : The function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> non-blocking. The function marks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue <span class="keywordflow">for</span> deletion,
00832                     but does not wait <span class="keywordflow">for</span> all callbacks to complete.
00833             
00834 Return Value:
00835 
00836     STATUS_SUCCESS - All timer callbacks have completed.
00837     STATUS_PENDING - Non-Blocking call. Some timer callbacks associated with timers
00838                     in <span class="keyword">this</span> queue may not have completed.
00839     
00840 --*/
00841 {
00842     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00843     LARGE_INTEGER TimeOut ;
00844     <a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a> CompletionEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00845     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue = (<a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a>)QueueHandle ;
00846 
00847     <span class="keywordflow">if</span> (!Queue) {
00848         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FALSE ) ;
00849         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER ;
00850     }
00851 
00852     <a class="code" href="../../d3/d1/threads_8h.html#a31">CHECK_DEL_SIGNATURE</a>( Queue ) ;
00853     <a class="code" href="../../d3/d1/threads_8h.html#a30">SET_DEL_SIGNATURE</a>( Queue ) ;
00854 
00855     
00856 <span class="preprocessor">    #if DBG1</span>
00857 <span class="preprocessor"></span>    Queue-&gt;ThreadId2 = HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
00858     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
00859     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n&lt;%d:%d&gt; Queue Delete(Queue:%x Event:%x by Thread:&lt;%x:%x&gt;)\n\n"</span>, 
00860              Queue-&gt;DbgId, Queue-&gt;RefCount, (ULONG_PTR)Queue, (ULONG_PTR)Event,
00861              HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
00862              HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
00863 <span class="preprocessor">    #endif</span>
00864 <span class="preprocessor"></span>
00865 
00866     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> == (HANDLE)-1 ) {
00867 
00868         <span class="comment">// Get an event from the event cache</span>
00869 
00870         CompletionEvent = <a class="code" href="../../d3/d1/threads_8h.html#a158">RtlpGetWaitEvent</a> () ;
00871 
00872         <span class="keywordflow">if</span> (!CompletionEvent) {
00873 
00874             <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
00875 
00876         }
00877     }
00878     
00879     Queue-&gt;CompletionEvent = CompletionEvent
00880                              ? CompletionEvent-&gt;<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html#o1">Handle</a> 
00881                              : <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> ;
00882 
00883 
00884     <span class="comment">// once this flag is set, no timer will be fired</span>
00885     
00886     <a class="code" href="../../d3/d1/threads_8h.html#a21">ACQUIRE_GLOBAL_TIMER_LOCK</a>();
00887     Queue-&gt;State |= <a class="code" href="../../d3/d1/threads_8h.html#a44">STATE_DONTFIRE</a>;
00888     <a class="code" href="../../d3/d1/threads_8h.html#a22">RELEASE_GLOBAL_TIMER_LOCK</a>();
00889 
00890 
00891 
00892     <span class="comment">// queue an APC</span>
00893     
00894     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
00895                     TimerThreadHandle,
00896                     (PPS_APC_ROUTINE)RtlpDeleteTimerQueue,
00897                     (PVOID) QueueHandle,
00898                     NULL,
00899                     NULL
00900                     );
00901 
00902     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00903 
00904         <a class="code" href="../../d3/d1/threads_8h.html#a156">RtlpFreeWaitEvent</a>( CompletionEvent ) ;
00905 
00906         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00907     }
00908     
00909     <span class="keywordflow">if</span> (CompletionEvent) {
00910 
00911         <span class="comment">// wait for Event to be fired. Return if the thread has been killed.</span>
00912 
00913 
00914 <span class="preprocessor">        #if DBG1</span>
00915 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
00916         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%x&gt; Queue delete waiting Thread&lt;%d:%d&gt;\n\n"</span>,
00917                 (ULONG_PTR)Queue,
00918                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
00919                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
00920 <span class="preprocessor">        #endif</span>
00921 <span class="preprocessor"></span>
00922 
00923         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a163">RtlpWaitForEvent</a>( CompletionEvent-&gt;<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html#o1">Handle</a>, TimerThreadHandle ) ;
00924 
00925 
00926 <span class="preprocessor">        #if DBG1</span>
00927 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
00928         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%x&gt; Queue delete completed\n\n"</span>, (ULONG_PTR) Queue) ;
00929 <span class="preprocessor">        #endif</span>
00930 <span class="preprocessor"></span>
00931         <a class="code" href="../../d3/d1/threads_8h.html#a156">RtlpFreeWaitEvent</a>( CompletionEvent ) ;
00932 
00933         <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ? STATUS_SUCCESS : <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00934 
00935     } <span class="keywordflow">else</span> {
00936 
00937         <span class="keywordflow">return</span> STATUS_PENDING ;
00938     }
00939 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="threads.c::RtlDeregisterWait" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlDeregisterWait           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>WaitHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l00228">228</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l00256">RtlDeregisterWaitEx()</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00552">RtlShutdownLpcServer()</a>.
<p>
<pre class="fragment"><div>00233                    :
00234 
00235     This routine removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified wait from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> of objects being
00236     waited on. This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> non-blocking. Once <span class="keyword">this</span> call returns, no <span class="keyword">new</span>
00237     Callbacks are invoked. However, Callbacks that might already have been queued
00238     to worker threads are not cancelled.
00239 
00240 Arguments:
00241 
00242     WaitHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> indentifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait.
00243 
00244 Return Value:
00245 
00246     STATUS_SUCCESS - The deregistration was successful.
00247     STATUS_PENDING - Some callbacks associated with <span class="keyword">this</span> Wait, are still executing.
00248 --*/
00249 
00250 {
00251     <span class="keywordflow">return</span> <a class="code" href="../../d2/d1/threads_8c.html#a7">RtlDeregisterWaitEx</a>( WaitHandle, NULL ) ;    
00252 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="threads.c::RtlDeregisterWaitEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlDeregisterWaitEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Event</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l00256">256</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00398">CHECK_DEL_SIGNATURE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00125">_RTLP_WAIT::DbgId</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00406">DPRN0</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00198">_RTLP_EVENT::Handle</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00056">NtQueueApcThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00117">_RTLP_WAIT::RefCount</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03397">RtlpDeregisterWait()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05648">RtlpFreeWaitEvent()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05575">RtlpGetWaitEvent()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05503">RtlpWaitForEvent()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00397">SET_DEL_SIGNATURE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00114">_RTLP_WAIT::ThreadCB</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00139">_RTLP_WAIT_THREAD_CONTROL_BLOCK::ThreadHandle</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00127">_RTLP_WAIT::ThreadId2</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l00228">RtlDeregisterWait()</a>.
<p>
<pre class="fragment"><div>00262                    :
00263 
00264     This routine removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified wait from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> of objects being
00265     waited on. Once <span class="keyword">this</span> call returns, no <span class="keyword">new</span> Callbacks will be invoked.
00266     Depending on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call can be blocking or non-blocking.
00267     Blocking calls MUST NOT be invoked inside <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>, except
00268     when a callback being executed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Wait thread context deregisters
00269     its associated Wait (in <span class="keyword">this</span> <span class="keywordflow">case</span> there is no reason <span class="keywordflow">for</span> making blocking calls),
00270     or when a callback queued to a worker thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deregistering some other wait item
00271     (be careful of deadlocks here).
00272 
00273 Arguments:
00274 
00275     WaitHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> indentifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait.
00276 
00277     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> to wait upon.
00278             (HANDLE)-1: The function creates an event and waits on <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00279             <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> : The caller passes an <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>. The function removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait handle,
00280                     but does not wait <span class="keywordflow">for</span> all callbacks to complete. The <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 
00281                     released after all callbacks have completed.
00282             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : The function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> non-blocking. The function removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait handle,
00283                     but does not wait <span class="keywordflow">for</span> all callbacks to complete.
00284             
00285 Return Value:
00286 
00287     STATUS_SUCCESS - The deregistration was successful.
00288     STATUS_PENDING - Some callback <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> still pending.
00289 
00290 --*/
00291 
00292 {
00293     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, StatusAsync = STATUS_SUCCESS ;
00294     <a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> Wait = (<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a>) WaitHandle ;
00295     ULONG CurrentThreadId =  HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
00296     <a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a> CompletionEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00297     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> ;
00298     ULONG NonBlocking = ( <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> != (HANDLE) -1 ) ; <span class="comment">//The call returns non-blocking</span>
00299 
00300 
00301     <span class="keywordflow">if</span> (!Wait) {
00302         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FALSE ) ;
00303         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER ;
00304     }
00305     
00306     <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o0">ThreadCB</a>-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o1">ThreadHandle</a> ;
00307 
00308     
00309     <a class="code" href="../../d3/d1/threads_8h.html#a31">CHECK_DEL_SIGNATURE</a>( Wait ) ;
00310     <a class="code" href="../../d3/d1/threads_8h.html#a30">SET_DEL_SIGNATURE</a>( Wait ) ;
00311     
00312 <span class="preprocessor">    #if DBG1</span>
00313 <span class="preprocessor"></span>    Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o12">ThreadId2</a> = CurrentThreadId ;
00314 <span class="preprocessor">    #endif</span>
00315 <span class="preprocessor"></span>    
00316     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> == (HANDLE)-1) {
00317 
00318         <span class="comment">// Get an event from the event cache</span>
00319 
00320         CompletionEvent = <a class="code" href="../../d3/d1/threads_8h.html#a158">RtlpGetWaitEvent</a> () ;
00321 
00322         <span class="keywordflow">if</span> (!CompletionEvent) {
00323 
00324             <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
00325 
00326         }
00327     }
00328 
00329     
00330     Wait = (<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a>) WaitHandle ;
00331 
00332 <span class="preprocessor">    #if DBG1</span>
00333 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
00334     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d:%d&gt; Wait %x deregistering by thread:&lt;%x:%x&gt;\n\n"</span>, Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o10">DbgId</a>, 
00335                 Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o3">RefCount</a>, (ULONG_PTR)Wait,
00336                 CurrentThreadId,
00337                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
00338 <span class="preprocessor">    #endif</span>
00339 <span class="preprocessor"></span>
00340 
00341     Wait-&gt;CompletionEvent = CompletionEvent
00342                             ? CompletionEvent-&gt;<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html#o1">Handle</a>
00343                             : <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> ;
00344 
00345     <span class="comment">//</span>
00346     <span class="comment">// RtlDeregisterWaitEx is being called from within the Wait thread callback</span>
00347     <span class="comment">//</span>
00348     
00349     <span class="keywordflow">if</span> ( CurrentThreadId == Wait-&gt;ThreadCB-&gt;ThreadId ) {
00350 
00351         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a131">RtlpDeregisterWait</a> ( Wait, NULL, NULL ) ;
00352 
00353 
00354         <span class="comment">// all callback functions run in the wait thread. So cannot return PENDING</span>
00355         
00356         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( Status != STATUS_PENDING ) ;
00357           
00358     
00359     } <span class="keywordflow">else</span> {
00360 
00361         <a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a> PartialCompletionEvent = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00362 
00363         <span class="keywordflow">if</span> (NonBlocking) {
00364         
00365             PartialCompletionEvent = <a class="code" href="../../d3/d1/threads_8h.html#a158">RtlpGetWaitEvent</a> () ;
00366 
00367             <span class="keywordflow">if</span> (!PartialCompletionEvent) {
00368 
00369                 <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
00370             }
00371         }
00372         
00373         <span class="comment">// Queue an APC to the Wait Thread</span>
00374         
00375         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
00376                         Wait-&gt;ThreadCB-&gt;ThreadHandle,
00377                         (PPS_APC_ROUTINE)RtlpDeregisterWait,
00378                         (PVOID) Wait,
00379                         NonBlocking ? PartialCompletionEvent-&gt;<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html#o1">Handle</a> : NULL ,
00380                         NonBlocking ? (PVOID)&amp;StatusAsync : NULL
00381                         );
00382                         
00383         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00384 
00385             <span class="keywordflow">if</span> (CompletionEvent) <a class="code" href="../../d3/d1/threads_8h.html#a156">RtlpFreeWaitEvent</a>( CompletionEvent ) ;
00386             <span class="keywordflow">if</span> (PartialCompletionEvent) <a class="code" href="../../d3/d1/threads_8h.html#a156">RtlpFreeWaitEvent</a>( PartialCompletionEvent ) ;
00387     
00388             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00389         }
00390 
00391 
00392         <span class="comment">// block till the wait entry has been deactivated</span>
00393         
00394         <span class="keywordflow">if</span> (NonBlocking) {
00395         
00396             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a163">RtlpWaitForEvent</a>( PartialCompletionEvent-&gt;<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html#o1">Handle</a>, ThreadHandle ) ;
00397         }    
00398 
00399 
00400         <span class="keywordflow">if</span> (PartialCompletionEvent) <a class="code" href="../../d3/d1/threads_8h.html#a156">RtlpFreeWaitEvent</a>( PartialCompletionEvent ) ;
00401 
00402     }
00403 
00404     <span class="keywordflow">if</span> ( CompletionEvent ) {
00405 
00406         <span class="comment">// wait for Event to be fired. Return if the thread has been killed.</span>
00407 
00408 <span class="preprocessor">        #if DBG1</span>
00409 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
00410         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Wait %x deregister waiting ThreadId&lt;%x:%x&gt;\n\n"</span>, 
00411                 (ULONG_PTR)Wait,
00412                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
00413                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
00414 <span class="preprocessor">        #endif</span>
00415 <span class="preprocessor"></span>        
00416         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a163">RtlpWaitForEvent</a>( CompletionEvent-&gt;<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html#o1">Handle</a>, ThreadHandle ) ;
00417 
00418 <span class="preprocessor">        #if DBG1</span>
00419 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
00420         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Wait %x deregister completed\n\n"</span>, (ULONG_PTR)Wait) ;
00421 <span class="preprocessor">        #endif</span>
00422 <span class="preprocessor"></span>
00423         <a class="code" href="../../d3/d1/threads_8h.html#a156">RtlpFreeWaitEvent</a>( CompletionEvent ) ;
00424 
00425         <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ? STATUS_SUCCESS : <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00426         
00427     } <span class="keywordflow">else</span> {
00428 
00429         <span class="keywordflow">return</span> StatusAsync ;
00430     }
00431 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="threads.c::RtlpAddTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpAddTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PRTLP_TIMER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Timer</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l03954">3954</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00048">PRTLP_TIMER_QUEUE</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04271">RtlpDeleteTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04326">RtlpGetQueueRelativeTime()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04378">RtlpGetTimeRemaining()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04507">RtlpInsertInDeltaList()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04711">RtlpReOrderDeltaList()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04429">RtlpResetTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03674">RtlpResync64BitTickCount()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00760">STATE_ACTIVE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00763">STATE_DELETE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00755">STATE_REGISTERED</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00252">TimerHandle</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00251">TimerQueues</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l00944">RtlCreateTimer()</a>.
<p>
<pre class="fragment"><div>03959                    :
03960 
03961     This routine runs as an APC into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Timer thread. It adds a <span class="keyword">new</span> timer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03962     specified queue.
03963 
03964 Arguments:
03965 
03966     Timer - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer to add
03967 
03968 Return Value:
03969 
03970 
03971 --*/
03972 {
03973     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue ;
03974     ULONG TimeRemaining, QueueRelTimeRemaining ;
03975     ULONG NewFiringTime ;
03976 
03977     <a class="code" href="../../d2/d1/threads_8c.html#a42">RtlpResync64BitTickCount</a>() ;
03978 
03979     
03980     <span class="comment">// the timer was set to be deleted in a callback function.</span>
03981     
03982     <span class="keywordflow">if</span> (Timer-&gt;State &amp; <a class="code" href="../../d3/d1/threads_8h.html#a43">STATE_DELETE</a> ) {
03983     
03984         <a class="code" href="../../d3/d1/threads_8h.html#a155">RtlpDeleteTimer</a>( Timer ) ;
03985         <span class="keywordflow">return</span> ;
03986     }
03987 
03988     
03989     Queue = Timer-&gt;Queue ;
03990 
03991     
03992     <span class="comment">// TimeRemaining is the time left in the current timer + the relative time of</span>
03993     <span class="comment">// the queue it is being inserted into</span>
03994 
03995     TimeRemaining = <a class="code" href="../../d3/d1/threads_8h.html#a136">RtlpGetTimeRemaining</a> (TimerHandle) ;
03996     QueueRelTimeRemaining = TimeRemaining + <a class="code" href="../../d3/d1/threads_8h.html#a138">RtlpGetQueueRelativeTime</a> (Queue) ;
03997 
03998 
03999     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a127">RtlpInsertInDeltaList</a> (&amp;Queue-&gt;TimerList, Timer, QueueRelTimeRemaining, 
04000                                 &amp;NewFiringTime)) 
04001     {
04002 
04003         <span class="comment">// If the Queue is not attached to TimerQueues since it had no timers </span>
04004         <span class="comment">// previously then insert the queue into the TimerQueues list, else just </span>
04005         <span class="comment">// reorder its existing position.</span>
04006 
04007         <span class="keywordflow">if</span> (IsListEmpty (&amp;Queue-&gt;List)) {
04008 
04009             Queue-&gt;DeltaFiringTime = NewFiringTime ;
04010 
04011             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a127">RtlpInsertInDeltaList</a> (&amp;TimerQueues, Queue, TimeRemaining, 
04012                                         &amp;NewFiringTime)) 
04013             {
04014 
04015                 <span class="comment">// There is a new element at the head of the queue we need to reset the NT</span>
04016                 <span class="comment">// timer to fire sooner.</span>
04017 
04018                 <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (TimerHandle, NewFiringTime, NULL) ;
04019             }
04020 
04021         } <span class="keywordflow">else</span> {
04022 
04023             <span class="comment">// If we insert at the head of the timer delta list we will need to</span>
04024             <span class="comment">// make sure the queue delta list is readjusted</span>
04025 
04026             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a129">RtlpReOrderDeltaList</a>(&amp;TimerQueues, Queue, TimeRemaining, &amp;NewFiringTime, NewFiringTime)){
04027 
04028                 <span class="comment">// There is a new element at the head of the queue we need to reset the NT</span>
04029                 <span class="comment">// timer to fire sooner.</span>
04030 
04031                 <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (TimerHandle, NewFiringTime, NULL) ;
04032 
04033             }
04034         }
04035 
04036     }
04037 
04038     Timer-&gt;State |= ( <a class="code" href="../../d3/d1/threads_8h.html#a41">STATE_REGISTERED</a> | <a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a> ) ;
04039 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="threads.c::RtlpAddTimerQueue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpAddTimerQueue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Queue</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l04794">4794</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
<pre class="fragment"><div>04799                    :
04800 
04801     This routine runs as an APC into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Timer thread. It does whatever necessary to
04802     create a <span class="keyword">new</span> timer queue
04803 
04804 Arguments:
04805 
04806     Queue - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue to add
04807 
04808 Return Value:
04809 
04810 
04811 --*/
04812 {
04813 
04814     <span class="comment">// We do nothing here. The newly created queue is free floating until a timer is</span>
04815     <span class="comment">// queued onto it.</span>
04816 
04817 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="threads.c::RtlpAddWait" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpAddWait           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Wait</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l03302">3302</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00144">_RTLP_WAIT_THREAD_CONTROL_BLOCK::ActiveWaitArray</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00145">_RTLP_WAIT_THREAD_CONTROL_BLOCK::ActiveWaitPointers</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00086">_RTLP_GENERIC_TIMER::Context</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00122">_RTLP_WAIT::Context</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00055">_RTLP_GENERIC_TIMER::DeltaFiringTime</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00084">_RTLP_GENERIC_TIMER::Flags</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00120">_RTLP_WAIT::Flags</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00150">_RTLP_WAIT_THREAD_CONTROL_BLOCK::FreeTimerBlocks</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00085">_RTLP_GENERIC_TIMER::Function</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00121">_RTLP_WAIT::Function</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00277">INFINITE_TIME</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00143">_RTLP_WAIT_THREAD_CONTROL_BLOCK::NumActiveWaits</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00142">_RTLP_WAIT_THREAD_CONTROL_BLOCK::NumWaits</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00087">_RTLP_GENERIC_TIMER::Period</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00045">PRTLP_TIMER</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00082">_RTLP_GENERIC_TIMER::Queue</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00117">_RTLP_WAIT::RefCount</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00059">_RTLP_GENERIC_TIMER::RefCountPtr</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03573">RtlpDeleteWait()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04378">RtlpGetTimeRemaining()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04507">RtlpInsertInDeltaList()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04429">RtlpResetTimer()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00116">_RTLP_WAIT::State</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00062">_RTLP_GENERIC_TIMER::State</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00760">STATE_ACTIVE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00763">STATE_DELETE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00755">STATE_REGISTERED</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00114">_RTLP_WAIT::ThreadCB</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00123">_RTLP_WAIT::Timeout</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00119">_RTLP_WAIT::Timer</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00146">_RTLP_WAIT_THREAD_CONTROL_BLOCK::TimerHandle</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00147">_RTLP_WAIT_THREAD_CONTROL_BLOCK::TimerQueue</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00083">_RTLP_GENERIC_TIMER::Wait</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00115">_RTLP_WAIT::WaitHandle</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l00077">RtlRegisterWait()</a>.
<p>
<pre class="fragment"><div>03307                    :
03308 
03309     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> adding waits to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait thread. It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> executed in
03310     an APC.
03311 
03312 Arguments:
03313 
03314     Wait - The wait to add
03315 
03316 Return Value:
03317 
03318 --*/
03319 {
03320     <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCB = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o0">ThreadCB</a>;
03321 
03322 
03323     <span class="comment">// if the state is deleted, it implies that RtlDeregister was called in a</span>
03324     <span class="comment">// WaitThreadCallback for a Wait other than that which was fired. This is </span>
03325     <span class="comment">// an application bug. I Assert, but also handle it.</span>
03326     
03327     <span class="keywordflow">if</span> ( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o2">State</a> &amp; <a class="code" href="../../d3/d1/threads_8h.html#a43">STATE_DELETE</a> ) {
03328 
03329         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE) ;
03330 
03331         InterlockedDecrement( &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o3">NumWaits</a> ) ;
03332         
03333         <a class="code" href="../../d3/d1/threads_8h.html#a133">RtlpDeleteWait</a> (Wait) ;
03334 
03335         <span class="keywordflow">return</span> ;
03336     }
03337 
03338     
03339     <span class="comment">// activate Wait</span>
03340         
03341     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o5">ActiveWaitArray</a> [ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a>] = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o1">WaitHandle</a> ;
03342     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o6">ActiveWaitPointers</a>[ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a>] = Wait ;
03343     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a> ++ ;
03344     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o2">State</a> |= (<a class="code" href="../../d3/d1/threads_8h.html#a41">STATE_REGISTERED</a> | <a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a>) ;
03345     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o3">RefCount</a> = 1 ;
03346 
03347 
03348     <span class="comment">// Fill in the wait timer</span>
03349 
03350     <span class="keywordflow">if</span> (Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o9">Timeout</a> != <a class="code" href="../../d3/d1/threads_8h.html#a10">INFINITE_TIME</a>) {
03351 
03352         ULONG TimeRemaining ;
03353         ULONG NewFiringTime ;
03354 
03355         <span class="comment">// Initialize timer related fields and insert the timer in the timer queue for</span>
03356         <span class="comment">// this wait thread</span>
03357 
03358         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a> = (<a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a>) RemoveHeadList(&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o10">FreeTimerBlocks</a>);
03359         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o11">Function</a> = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o7">Function</a> ;
03360         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o12">Context</a> = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o8">Context</a> ;
03361         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o10">Flags</a> = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o6">Flags</a> ;
03362         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o9">Timeout</a> ;
03363         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o13">Period</a> = ( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o6">Flags</a> &amp; WT_EXECUTEONLYONCE )
03364                                 ? 0 
03365                                 : Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o9">Timeout</a> == <a class="code" href="../../d3/d1/threads_8h.html#a10">INFINITE_TIME</a>
03366                                 ? 0 : Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o9">Timeout</a> ;
03367 
03368         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o4">State</a> = ( <a class="code" href="../../d3/d1/threads_8h.html#a41">STATE_REGISTERED</a> | <a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a> ) ; ;
03369         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o9">Wait</a> = Wait ;
03370         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o3">RefCountPtr</a> = &amp;Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o3">RefCount</a> ;
03371         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o8">Queue</a> = &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o8">TimerQueue</a> ;
03372 
03373         
03374         TimeRemaining = <a class="code" href="../../d3/d1/threads_8h.html#a136">RtlpGetTimeRemaining</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>) ;
03375 
03376         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a127">RtlpInsertInDeltaList</a> (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o8">TimerQueue</a>.TimerList, Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>,
03377                                     TimeRemaining, &amp;NewFiringTime)) 
03378         {
03379             <span class="comment">// If the element was inserted at head of list then reset the timers</span>
03380 
03381             <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>, NewFiringTime, ThreadCB) ;
03382         }
03383 
03384     } <span class="keywordflow">else</span> {
03385 
03386         <span class="comment">// No timer with this wait</span>
03387 
03388         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
03389 
03390     }
03391 
03392     <span class="keywordflow">return</span> ;
03393 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="threads.c::RtlpAsyncCallbackCompletion" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpAsyncCallbackCompletion           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l03082">3082</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00122">_RTLP_WAIT::Context</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00354">DBG_SET_FUNCTION</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00410">DPRN4</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00121">_RTLP_WAIT::Function</a>, <a class="el" href="../../d3/d1/threads_8h.html#a57">PRTLP_ASYNC_CALLBACK</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00045">PRTLP_TIMER</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00117">_RTLP_WAIT::RefCount</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04271">RtlpDeleteTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03573">RtlpDeleteWait()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00302">RtlpFreeTPHeap</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00174">_RTLP_WAITWORKER::Timer</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00177">_RTLP_WAITWORKER::TimerCondition</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00173">_RTLP_WAITWORKER::Wait</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00176">_RTLP_WAITWORKER::WaitThreadCallback</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l03747">RtlpFireTimers()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l03172">RtlpProcessWaitCompletion()</a>.
<p>
<pre class="fragment"><div>03087                    :
03088 
03089     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in a (IO)worker thread and is used to decrement the 
03090     RefCount at the end and call RtlpDelete(Wait/Timer) if required
03091 
03092 Arguments:
03093 
03094     Context - AsyncCallback: containing pointer to Wait/Timer object, 
03095 
03096 Return Value:
03097 
03098 --*/
03099 {
03100     <a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html">PRTLP_ASYNC_CALLBACK</a> AsyncCallback ;
03101     
03102     AsyncCallback = (<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html">PRTLP_ASYNC_CALLBACK</a>) Context ;
03103 
03104     <span class="comment">// callback queued by WaitThread (event or timer)</span>
03105     
03106     <span class="keywordflow">if</span> ( AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o2">WaitThreadCallback</a> ) {
03107 
03108         <a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> Wait = AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o0">Wait</a> ;
03109 
03110         <span class="comment">//DPRN5</span>
03111         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a38">DPRN4</a>)
03112         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Calling WaitOrTimer: fn:%x  context:%x  bool:%d Thread&lt;%d:%d&gt;\n"</span>,
03113                 (ULONG_PTR)Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o7">Function</a>, (ULONG_PTR)Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o8">Context</a>,
03114                 (ULONG_PTR)AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o3">TimerCondition</a>,
03115                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
03116                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)
03117                 ) ;
03118 
03119 <span class="preprocessor">        #if (DBG1)</span>
03120 <span class="preprocessor"></span>        <a class="code" href="../../d3/d1/threads_8h.html#a24">DBG_SET_FUNCTION</a>( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o7">Function</a>, Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o8">Context</a> ) ;
03121 <span class="preprocessor">        #endif</span>
03122 <span class="preprocessor"></span>        
03123         ((WAITORTIMERCALLBACKFUNC) Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o7">Function</a>) 
03124                                 ( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o8">Context</a>, AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o3">TimerCondition</a> ) ;
03125 
03126         <span class="keywordflow">if</span> ( InterlockedDecrement( &amp;Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o3">RefCount</a> ) == 0 ) {
03127 
03128             <a class="code" href="../../d3/d1/threads_8h.html#a133">RtlpDeleteWait</a>( Wait ) ;            
03129         }
03130 
03131     }
03132 
03133     <span class="comment">// callback queued by TimerThread</span>
03134     
03135     <span class="keywordflow">else</span> {
03136 
03137         <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> Timer = AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o1">Timer</a> ;
03138 
03139         <span class="comment">//DPRN5</span>
03140         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a38">DPRN4</a>)
03141         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Calling WaitOrTimer:Timer: fn:%x  context:%x  bool:%d Thread&lt;%d:%d&gt;\n"</span>,
03142                 (ULONG_PTR)Timer-&gt;Function, (ULONG_PTR)Timer-&gt;Context,
03143                 TRUE,
03144                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
03145                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)
03146                 ) ;
03147                 
03148 <span class="preprocessor">        #if (DBG1)</span>
03149 <span class="preprocessor"></span>        <a class="code" href="../../d3/d1/threads_8h.html#a24">DBG_SET_FUNCTION</a>( Timer-&gt;Function, Timer-&gt;Context ) ;
03150 <span class="preprocessor">        #endif</span>
03151 <span class="preprocessor"></span>  
03152 
03153         ((WAITORTIMERCALLBACKFUNC) Timer-&gt;Function) ( Timer-&gt;Context , <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ;
03154 
03155 
03156         <span class="comment">// decrement RefCount after function is executed so that the context is not deleted</span>
03157         
03158         <span class="keywordflow">if</span> ( InterlockedDecrement( &amp;Timer-&gt;RefCount ) == 0 ) {
03159         
03160             <a class="code" href="../../d3/d1/threads_8h.html#a155">RtlpDeleteTimer</a>( Timer ) ;            
03161         }
03162         
03163     }
03164 
03165     
03166     <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( AsyncCallback );
03167 
03168 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="threads.c::RtlpCancelTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpCancelTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PRTLP_TIMER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Timer</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l04120">4120</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l04142">RtlpCancelTimerEx()</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l01145">RtlDeleteTimer()</a>.
<p>
<pre class="fragment"><div>04125                    :
04126 
04127     This routine executes in an APC and cancels <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified timer <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> exists
04128 
04129 Arguments:
04130 
04131     Timer - Specifies pointer to a timer structure that contains Queue and Timer information
04132 
04133 Return Value:
04134 
04135 
04136 --*/
04137 {
04138     <a class="code" href="../../d3/d1/threads_8h.html#a140">RtlpCancelTimerEx</a>( Timer, FALSE ) ; <span class="comment">// queue not being deleted</span>
04139 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="threads.c::RtlpCancelTimerEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpCancelTimerEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PRTLP_TIMER&nbsp;</td>
          <td class="mdname" nowrap> <em>Timer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DeletingQueue</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l04142">4142</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00396">CHECK_SIGNATURE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00048">PRTLP_TIMER_QUEUE</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04202">RtlpDeactivateTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04271">RtlpDeleteTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03674">RtlpResync64BitTickCount()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00760">STATE_ACTIVE</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00763">STATE_DELETE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l04120">RtlpCancelTimer()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l05354">RtlpDeleteTimerQueue()</a>.
<p>
<pre class="fragment"><div>04148                    :
04149 
04150     This routine cancels <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified timer.
04151 
04152 Arguments:
04153 
04154     Timer - Specifies pointer to a timer structure that contains Queue and Timer information
04155     DeletingQueue - <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>: routine executing in an APC. <a class="code" href="../../d9/d0/rtdelkey_8c.html#a5">Delete</a> timer <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.
04156                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : routine called by timer queue which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being deleted. So dont
04157                             reset <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue's position
04158 Return Value:
04159 
04160 
04161 --*/
04162 {
04163     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue ;
04164 
04165     <a class="code" href="../../d2/d1/threads_8c.html#a42">RtlpResync64BitTickCount</a>() ;
04166     <a class="code" href="../../d3/d1/threads_8h.html#a29">CHECK_SIGNATURE</a>( Timer ) ;
04167     
04168     Queue = Timer-&gt;Queue ;
04169 
04170 
04171     <span class="keywordflow">if</span> ( Timer-&gt;State &amp; <a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a> ) {
04172 
04173         <span class="comment">// if queue is being deleted, then the timer should not be reset</span>
04174         
04175         <span class="keywordflow">if</span> ( ! DeletingQueue )
04176             <a class="code" href="../../d3/d1/threads_8h.html#a141">RtlpDeactivateTimer</a>( Queue, Timer ) ;
04177         
04178     } <span class="keywordflow">else</span> {
04179 
04180         <span class="comment">// remove one shot Inactive timer from Queue-&gt;UncancelledTimerList</span>
04181         <span class="comment">// called only when the time queue is being deleted</span>
04182         
04183         RemoveEntryList( &amp;Timer-&gt;List ) ;
04184 
04185     }
04186 
04187     
04188     <span class="comment">// Set the State to deleted</span>
04189     
04190     Timer-&gt;State |= <a class="code" href="../../d3/d1/threads_8h.html#a43">STATE_DELETE</a> ;
04191 
04192 
04193     <span class="comment">// delete timer if refcount == 0</span>
04194     
04195     <span class="keywordflow">if</span> ( InterlockedDecrement( &amp;Timer-&gt;RefCount ) == 0 ) {
04196     
04197         <a class="code" href="../../d3/d1/threads_8h.html#a155">RtlpDeleteTimer</a>( Timer ) ;
04198     }
04199 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="threads.c::RtlpDeactivateTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpDeactivateTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PRTLP_TIMER_QUEUE&nbsp;</td>
          <td class="mdname" nowrap> <em>Queue</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PRTLP_TIMER&nbsp;</td>
          <td class="mdname" nowrap> <em>Timer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l04202">4202</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04326">RtlpGetQueueRelativeTime()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04378">RtlpGetTimeRemaining()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04631">RtlpRemoveFromDeltaList()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04711">RtlpReOrderDeltaList()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04429">RtlpResetTimer()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00252">TimerHandle</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00251">TimerQueues</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l04142">RtlpCancelTimerEx()</a>.
<p>
<pre class="fragment"><div>04208                    :
04209 
04210     This routine executes in an APC and cancels <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified timer <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> exists
04211 
04212 Arguments:
04213 
04214     Timer - Specifies pointer to a timer structure that contains Queue and Timer information
04215 
04216 Return Value:
04217 
04218 
04219 --*/
04220 {
04221     ULONG TimeRemaining, QueueRelTimeRemaining ;
04222     ULONG NewFiringTime ;
04223 
04224     
04225     <span class="comment">// Remove the timer from the appropriate queue</span>
04226 
04227     TimeRemaining = <a class="code" href="../../d3/d1/threads_8h.html#a136">RtlpGetTimeRemaining</a> (TimerHandle) ;
04228     QueueRelTimeRemaining = TimeRemaining + <a class="code" href="../../d3/d1/threads_8h.html#a138">RtlpGetQueueRelativeTime</a> (Queue) ;
04229 
04230     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a128">RtlpRemoveFromDeltaList</a> (&amp;Queue-&gt;TimerList, Timer, QueueRelTimeRemaining, &amp;NewFiringTime)) {
04231 
04232         <span class="comment">// If we removed the last timer from the queue then we should remove the queue</span>
04233         <span class="comment">// from TimerQueues, else we should readjust its position based on the delta time change</span>
04234 
04235         <span class="keywordflow">if</span> (IsListEmpty (&amp;Queue-&gt;TimerList)) {
04236 
04237             <span class="comment">// Remove the queue from TimerQueues</span>
04238 
04239             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a128">RtlpRemoveFromDeltaList</a> (&amp;TimerQueues, Queue, TimeRemaining, &amp;NewFiringTime)) {
04240 
04241                 <span class="comment">// There is a new element at the head of the queue we need to reset the NT</span>
04242                 <span class="comment">// timer to fire later</span>
04243 
04244                 <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (TimerHandle, NewFiringTime, NULL) ;
04245 
04246             }
04247 
04248             InitializeListHead (&amp;Queue-&gt;List) ;
04249 
04250         } <span class="keywordflow">else</span> {
04251 
04252             <span class="comment">// If we remove from the head of the timer delta list we will need to</span>
04253             <span class="comment">// make sure the queue delta list is readjusted</span>
04254 
04255             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a129">RtlpReOrderDeltaList</a> (&amp;TimerQueues, Queue, TimeRemaining, &amp;NewFiringTime, NewFiringTime)) {
04256 
04257                 <span class="comment">// There is a new element at the head of the queue we need to reset the NT</span>
04258                 <span class="comment">// timer to fire later</span>
04259 
04260                 <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (TimerHandle, NewFiringTime, NULL) ;
04261 
04262             }
04263 
04264         }
04265 
04266     }
04267 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="threads.c::RtlpDeactivateWait" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpDeactivateWait           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Wait</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l03483">3483</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00145">_RTLP_WAIT_THREAD_CONTROL_BLOCK::ActiveWaitPointers</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00150">_RTLP_WAIT_THREAD_CONTROL_BLOCK::FreeTimerBlocks</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00054">_RTLP_GENERIC_TIMER::List</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00143">_RTLP_WAIT_THREAD_CONTROL_BLOCK::NumActiveWaits</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00142">_RTLP_WAIT_THREAD_CONTROL_BLOCK::NumWaits</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04378">RtlpGetTimeRemaining()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04631">RtlpRemoveFromDeltaList()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04429">RtlpResetTimer()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00372">RtlpShiftWaitArray</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00062">_RTLP_GENERIC_TIMER::State</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00116">_RTLP_WAIT::State</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00760">STATE_ACTIVE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00114">_RTLP_WAIT::ThreadCB</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00119">_RTLP_WAIT::Timer</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00146">_RTLP_WAIT_THREAD_CONTROL_BLOCK::TimerHandle</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00147">_RTLP_WAIT_THREAD_CONTROL_BLOCK::TimerQueue</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l03397">RtlpDeregisterWait()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05010">RtlpFireTimersAndReorder()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l03172">RtlpProcessWaitCompletion()</a>.
<p>
<pre class="fragment"><div>03488                    :
03489 
03490     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> deactivating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified wait. It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> executed in a APC.
03491 
03492 Arguments:
03493 
03494     Wait - The wait to deactivate
03495 
03496 Return Value:
03497 
03498 --*/
03499 {
03500     <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCB = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o0">ThreadCB</a> ;
03501     ULONG ArrayIndex ; <span class="comment">//Index in ActiveWaitArray where the Wait object is placed</span>
03502     ULONG EndIndex = ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a> -1;
03503 
03504     <span class="comment">// get the index in ActiveWaitArray</span>
03505     
03506     <span class="keywordflow">for</span> (ArrayIndex = 0;  ArrayIndex &lt;= EndIndex; ArrayIndex++) {
03507 
03508         <span class="keywordflow">if</span> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o6">ActiveWaitPointers</a>[ArrayIndex] == Wait)
03509             <span class="keywordflow">break</span> ;
03510     }
03511 
03512     <span class="keywordflow">if</span> ( ArrayIndex &gt; EndIndex ) {
03513     
03514         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE) ;
03515         <span class="keywordflow">return</span> STATUS_NOT_FOUND;
03516     }
03517 
03518 
03519     <span class="comment">// Move the remaining ActiveWaitArray left.</span>
03520 
03521     <a class="code" href="../../d3/d1/threads_8h.html#a25">RtlpShiftWaitArray</a>( ThreadCB, ArrayIndex+1, ArrayIndex,
03522                     EndIndex - ArrayIndex ) ;
03523 
03524 
03525     <span class="comment">//</span>
03526     <span class="comment">// delete timer if associated with this wait</span>
03527     <span class="comment">//</span>
03528     <span class="comment">// Though timer is being "freed" here, if it is in the timersToBeFired</span>
03529     <span class="comment">// list, some of its fields will be used later</span>
03530     <span class="comment">//</span>
03531     
03532     <span class="keywordflow">if</span> ( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a> ) {
03533     
03534         ULONG TimeRemaining ;
03535         ULONG NewFiringTime ;
03536 
03537         <span class="keywordflow">if</span> (! (Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o4">State</a> &amp; <a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a>) ) {
03538         
03539             RemoveEntryList( &amp;Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o0">List</a> ) ;
03540 
03541         } <span class="keywordflow">else</span> {
03542 
03543             TimeRemaining = <a class="code" href="../../d3/d1/threads_8h.html#a136">RtlpGetTimeRemaining</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>) ;
03544             
03545             
03546             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a128">RtlpRemoveFromDeltaList</a> (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o8">TimerQueue</a>.TimerList, Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>, 
03547                                             TimeRemaining, &amp;NewFiringTime)) 
03548             {
03549 
03550                 <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>, NewFiringTime, ThreadCB) ;
03551             }
03552         }
03553 
03554         
03555         InsertTailList (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o10">FreeTimerBlocks</a>, &amp;Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o0">List</a>) ;
03556 
03557         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
03558     }
03559 
03560     <span class="comment">// Decrement the (active) wait count</span>
03561 
03562     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a>-- ;
03563     InterlockedDecrement( &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o3">NumWaits</a> ) ;
03564     
03565     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o2">State</a> &amp;= ~<a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a> ;
03566 
03567     <span class="keywordflow">return</span> STATUS_SUCCESS;
03568 
03569 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="threads.c::RtlpDeleteTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpDeleteTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PRTLP_TIMER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Timer</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l04271">4271</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00396">CHECK_SIGNATURE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00400">CLEAR_SIGNATURE</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00407">DPRN1</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00748">NtSetEvent()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00048">PRTLP_TIMER_QUEUE</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05462">RtlpDeleteTimerQueueComplete()</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00302">RtlpFreeTPHeap</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l03954">RtlpAddTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03082">RtlpAsyncCallbackCompletion()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l04142">RtlpCancelTimerEx()</a>.
<p>
<pre class="fragment"><div>04276                    :
04277 
04278     This routine executes in worker or timer thread and deletes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer 
04279     whose <a class="code" href="../../d0/d3/ppc_2initkr_8c.html#a5">RefCount</a> == 0. The function can be called outside timer thread,
04280     so no structure outside Timer can be touched (no list etc).
04281 
04282 Arguments:
04283 
04284     Timer - Specifies pointer to a timer structure that contains Queue and Timer information
04285 
04286 Return Value:
04287 
04288 
04289 --*/
04290 {
04291     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue = Timer-&gt;Queue ;
04292 
04293     <a class="code" href="../../d3/d1/threads_8h.html#a29">CHECK_SIGNATURE</a>( Timer ) ;
04294     <a class="code" href="../../d3/d1/threads_8h.html#a32">CLEAR_SIGNATURE</a>( Timer ) ;
04295 
04296 <span class="preprocessor">    #if DBG1</span>
04297 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a35">DPRN1</a>)
04298     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d&gt; Timer: %x: deleted\n\n"</span>, Timer-&gt;Queue-&gt;DbgId, 
04299             (ULONG_PTR)Timer) ;
04300 <span class="preprocessor">    #endif</span>
04301 <span class="preprocessor"></span>
04302     <span class="comment">// safe to call this. Either the timer is in the TimersToFireList and</span>
04303     <span class="comment">// the function is being called in time context or else it is not in the</span>
04304     <span class="comment">// list</span>
04305 
04306     RemoveEntryList( &amp;Timer-&gt;TimersToFireList ) ;
04307 
04308     <span class="keywordflow">if</span> ( Timer-&gt;CompletionEvent )
04309         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>( Timer-&gt;CompletionEvent, NULL ) ;
04310 
04311 
04312     <span class="comment">// decrement the total number of timers in the queue</span>
04313     
04314     <span class="keywordflow">if</span> ( InterlockedDecrement( &amp;Queue-&gt;RefCount ) == 0 )
04315 
04316         <a class="code" href="../../d3/d1/threads_8h.html#a143">RtlpDeleteTimerQueueComplete</a>( Queue ) ;
04317         
04318 
04319     <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( Timer ) ;
04320 
04321 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="threads.c::RtlpDeleteTimerQueue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpDeleteTimerQueue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PRTLP_TIMER_QUEUE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Queue</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l05354">5354</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00045">PRTLP_TIMER</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00044">RTLP_TIMER</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04142">RtlpCancelTimerEx()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05462">RtlpDeleteTimerQueueComplete()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04326">RtlpGetQueueRelativeTime()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04378">RtlpGetTimeRemaining()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04631">RtlpRemoveFromDeltaList()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04429">RtlpResetTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03674">RtlpResync64BitTickCount()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00401">SET_DEL_TIMERQ_SIGNATURE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00252">TimerHandle</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00251">TimerQueues</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l00809">RtlDeleteTimerQueueEx()</a>.
<p>
<pre class="fragment"><div>05359                    :
05360 
05361     This routine deletes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> and frees all timers
05362 
05363 Arguments:
05364 
05365     Queue - queue to <span class="keyword">delete</span>
05366 
05367     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> used <span class="keywordflow">for</span> signalling completion of request
05368 
05369 Return Value:
05370 
05371 --*/
05372 {
05373     ULONG TimeRemaining ;
05374     ULONG NewFiringTime ;
05375     PLIST_ENTRY Node ;
05376     <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> Timer ;
05377 
05378     <a class="code" href="../../d2/d1/threads_8c.html#a42">RtlpResync64BitTickCount</a>() ;
05379 
05380     <a class="code" href="../../d3/d1/threads_8h.html#a33">SET_DEL_TIMERQ_SIGNATURE</a>( Queue ) ;
05381 
05382     
05383     <span class="comment">// If there are no timers in the queue then it is not attached to TimerQueues</span>
05384     <span class="comment">// In this case simply free the memory and return. Otherwise we have to first</span>
05385     <span class="comment">// remove the queue from the TimerQueues List, update the firing time if this</span>
05386     <span class="comment">// was the first queue in the list and then walk all the timers and free them</span>
05387     <span class="comment">// before freeing the Timer Queue.</span>
05388 
05389     <span class="keywordflow">if</span> (!IsListEmpty (&amp;Queue-&gt;List)) {
05390 
05391         TimeRemaining = <a class="code" href="../../d3/d1/threads_8h.html#a136">RtlpGetTimeRemaining</a> (TimerHandle) 
05392                         + <a class="code" href="../../d3/d1/threads_8h.html#a138">RtlpGetQueueRelativeTime</a> (Queue) ;
05393 
05394         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a128">RtlpRemoveFromDeltaList</a> (&amp;TimerQueues, Queue, TimeRemaining, 
05395                                     &amp;NewFiringTime)) 
05396         {
05397 
05398             <span class="comment">// If removed from head of queue list, reset the timer</span>
05399 
05400             <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (TimerHandle, NewFiringTime, NULL) ;
05401         }
05402 
05403 
05404         <span class="comment">// Free all the timers associated with this queue</span>
05405 
05406         <span class="keywordflow">for</span> (Node = Queue-&gt;TimerList.Flink ; Node != &amp;Queue-&gt;TimerList ; ) {
05407 
05408             Timer =  CONTAINING_RECORD (Node, RTLP_TIMER, List) ;
05409             
05410             Node = Node-&gt;Flink ;
05411 
05412             <a class="code" href="../../d3/d1/threads_8h.html#a140">RtlpCancelTimerEx</a>( Timer ,TRUE ) ; <span class="comment">// Queue being deleted</span>
05413         }
05414     }
05415 
05416 
05417     <span class="comment">// Free all the uncancelled one shot timers in this queue</span>
05418 
05419     <span class="keywordflow">for</span> (Node = Queue-&gt;UncancelledTimerList.Flink ; Node != &amp;Queue-&gt;UncancelledTimerList ; ) {
05420 
05421         Timer =  CONTAINING_RECORD (Node, RTLP_TIMER, List) ;
05422         
05423         Node = Node-&gt;Flink ;
05424 
05425         <a class="code" href="../../d3/d1/threads_8h.html#a140">RtlpCancelTimerEx</a>( Timer ,TRUE ) ; <span class="comment">// Queue being deleted</span>
05426     }
05427 
05428 
05429     <span class="comment">// delete the queue completely if the RefCount is 0</span>
05430     
05431     <span class="keywordflow">if</span> ( InterlockedDecrement( &amp;Queue-&gt;RefCount ) == 0 ) {
05432     
05433         <a class="code" href="../../d3/d1/threads_8h.html#a143">RtlpDeleteTimerQueueComplete</a>( Queue ) ;
05434 
05435         <span class="keywordflow">return</span> STATUS_SUCCESS ;
05436         
05437     } <span class="keywordflow">else</span> {
05438     
05439         <span class="keywordflow">return</span> STATUS_PENDING ;
05440     }
05441 
05442 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="threads.c::RtlpDeleteTimerQueueComplete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpDeleteTimerQueueComplete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PRTLP_TIMER_QUEUE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Queue</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l05462">5462</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00407">DPRN1</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00748">NtSetEvent()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00253">NumTimerQueues</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00302">RtlpFreeTPHeap</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l04271">RtlpDeleteTimer()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l05354">RtlpDeleteTimerQueue()</a>.
<p>
<pre class="fragment"><div>05465 {
05466 <span class="preprocessor">    #if DBG1</span>
05467 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a35">DPRN1</a>)
05468     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d&gt; Queue: %x: deleted\n\n"</span>, Queue-&gt;DbgId, 
05469             (ULONG_PTR)Queue) ;
05470 <span class="preprocessor">    #endif</span>
05471 <span class="preprocessor"></span>
05472     InterlockedDecrement( &amp;NumTimerQueues ) ;    
05473 
05474     <span class="comment">// Notify the thread issuing the cancel that the request is completed</span>
05475 
05476     <span class="keywordflow">if</span> ( Queue-&gt;CompletionEvent )
05477         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a> (Queue-&gt;CompletionEvent, NULL) ;
05478     
05479     <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( Queue ) ;
05480 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="threads.c::RtlpDeleteWait" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpDeleteWait           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Wait</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l03573">3573</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00396">CHECK_SIGNATURE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00400">CLEAR_SIGNATURE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00125">_RTLP_WAIT::DbgId</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00407">DPRN1</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00748">NtSetEvent()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00302">RtlpFreeTPHeap</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l03302">RtlpAddWait()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03082">RtlpAsyncCallbackCompletion()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03397">RtlpDeregisterWait()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l03172">RtlpProcessWaitCompletion()</a>.
<p>
<pre class="fragment"><div>03578                    :
03579 
03580     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> deleting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified wait. It can be executed
03581     outside <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait thread. So structure except <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> WaitEntry
03582     can be changed. It also sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event.
03583 
03584 Arguments:
03585 
03586     Wait - The wait to <span class="keyword">delete</span>
03587 
03588 Return Value:
03589 
03590 --*/
03591 {
03592     <a class="code" href="../../d3/d1/threads_8h.html#a29">CHECK_SIGNATURE</a>( Wait ) ;
03593     <a class="code" href="../../d3/d1/threads_8h.html#a32">CLEAR_SIGNATURE</a>( Wait ) ;
03594 
03595 <span class="preprocessor">    #if DBG1</span>
03596 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a35">DPRN1</a>)
03597     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d&gt; Wait %x deleted in thread:%d\n\n"</span>, Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o10">DbgId</a>, 
03598             (ULONG_PTR)Wait,
03599             HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread)) ;
03600 <span class="preprocessor">    #endif</span>
03601 <span class="preprocessor"></span>
03602     
03603     <span class="keywordflow">if</span> ( Wait-&gt;CompletionEvent ) {
03604 
03605         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>( Wait-&gt;CompletionEvent, NULL ) ;
03606     }
03607 
03608     <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( Wait) ;
03609 
03610     <span class="keywordflow">return</span> ;
03611 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="threads.c::RtlpDeregisterWait" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpDeregisterWait           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>PartialCompletionEvent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RetStatusPtr</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l03397">3397</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00396">CHECK_SIGNATURE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00748">NtSetEvent()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00117">_RTLP_WAIT::RefCount</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03483">RtlpDeactivateWait()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03573">RtlpDeleteWait()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00116">_RTLP_WAIT::State</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00760">STATE_ACTIVE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00763">STATE_DELETE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00755">STATE_REGISTERED</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l00256">RtlDeregisterWaitEx()</a>.
<p>
<pre class="fragment"><div>03404                    :
03405 
03406     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> deregistering <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified wait.
03407 
03408 Arguments:
03409 
03410     Wait - The wait to deregister
03411 
03412 Return Value:
03413 
03414 --*/
03415 {
03416     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS ;
03417     ULONG DontUse ;
03418     PULONG RetStatus = RetStatusPtr ? RetStatusPtr : &amp;DontUse;
03419     
03420     <a class="code" href="../../d3/d1/threads_8h.html#a29">CHECK_SIGNATURE</a>(Wait) ;
03421 
03422     
03423     <span class="comment">// RtlpDeregisterWait can be called on a wait that has not yet been</span>
03424     <span class="comment">// registered. This indicates that someone calls a RtlDeregisterWait</span>
03425     <span class="comment">// inside a WaitThreadCallback for a Wait other than that was fired.</span>
03426     <span class="comment">// Application bug!! I assert but handle it</span>
03427     
03428     <span class="keywordflow">if</span> ( ! (Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o2">State</a> &amp; <a class="code" href="../../d3/d1/threads_8h.html#a41">STATE_REGISTERED</a>) ) {
03429 
03430         <span class="comment">// set state to deleted, so that it does not get registered</span>
03431         
03432         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o2">State</a> |= <a class="code" href="../../d3/d1/threads_8h.html#a43">STATE_DELETE</a> ;
03433         
03434         InterlockedDecrement( &amp;Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o3">RefCount</a> ) ;
03435 
03436         <span class="keywordflow">if</span> ( PartialCompletionEvent ) {
03437         
03438             <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>( PartialCompletionEvent, NULL ) ;
03439         }
03440 
03441         *RetStatus = STATUS_SUCCESS ;
03442         <span class="keywordflow">return</span> STATUS_SUCCESS ;
03443     }
03444 
03445 
03446     <span class="comment">// deactivate wait.</span>
03447     
03448     <span class="keywordflow">if</span> ( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o2">State</a> &amp; <a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a> ) {
03449 
03450         <span class="keywordflow">if</span> ( ! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( RtlpDeactivateWait ( Wait ) ) ) {
03451 
03452             *RetStatus = STATUS_NOT_FOUND ;
03453             <span class="keywordflow">return</span> STATUS_NOT_FOUND ;
03454         }
03455     }
03456 
03457     <span class="comment">// delete wait if RefCount == 0</span>
03458 
03459     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o2">State</a> |= <a class="code" href="../../d3/d1/threads_8h.html#a43">STATE_DELETE</a> ;
03460     
03461     <span class="keywordflow">if</span> ( InterlockedDecrement (&amp;Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o3">RefCount</a>) == 0 ) {
03462 
03463         <a class="code" href="../../d3/d1/threads_8h.html#a133">RtlpDeleteWait</a> ( Wait ) ;
03464 
03465         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = *RetStatus = STATUS_SUCCESS ;
03466 
03467     } <span class="keywordflow">else</span> {
03468 
03469         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = *RetStatus = STATUS_PENDING ;
03470     }
03471 
03472     <span class="keywordflow">if</span> ( PartialCompletionEvent ) {
03473     
03474         <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>( PartialCompletionEvent, NULL ) ;
03475     }
03476 
03477         
03478     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
03479 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="threads.c::RtlpDoNothing" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpDoNothing           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>NotUsed1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>NotUsed2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>NotUsed3</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l03617">3617</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l05503">RtlpWaitForEvent()</a>.
<p>
<pre class="fragment"><div>03624                    :
03625 
03626     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> alive
03627 
03628 Arguments:
03629 
03630     NotUsed1, NotUsed2 and NotUsed 3 - not used
03631 
03632 Return Value:
03633 
03634     None
03635 
03636 --*/
03637 {
03638 
03639 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="threads.c::RtlpExecuteIOWorkItem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpExecuteIOWorkItem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Function</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>NotUsed</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l02632">2632</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00354">DBG_SET_FUNCTION</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00227">NumIOWorkRequests</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l01638">RtlpQueueIOWorkerRequest()</a>.
<p>
<pre class="fragment"><div>02639                    :
02640 
02641     Executes an IO Work function. RUNs in a APC in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IO Worker thread.
02642 
02643 Arguments:
02644 
02645     Function - Worker function to call
02646 
02647     Context - Argument <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> worker function.
02648 
02649     NotUsed - Argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not used in <span class="keyword">this</span> function.
02650 
02651 Return Value:
02652 
02653 
02654 --*/
02655 {
02656 <span class="preprocessor">    #if (DBG1)</span>
02657 <span class="preprocessor"></span>    <a class="code" href="../../d3/d1/threads_8h.html#a24">DBG_SET_FUNCTION</a>( Function, Context ) ;
02658 <span class="preprocessor">    #endif</span>
02659 <span class="preprocessor"></span>
02660     <span class="comment">// Invoke the function</span>
02661 
02662     <span class="keywordflow">try</span> {
02663         ((WORKERCALLBACKFUNC) Function)((PVOID)Context) ;
02664     } except (EXCEPTION_EXECUTE_HANDLER) {
02665         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
02666     }
02667 
02668     <span class="comment">// Decrement pending IO requests count</span>
02669 
02670     InterlockedDecrement (&amp;NumIOWorkRequests) ;
02671 
02672 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="threads.c::RtlpExecuteLongIOWorkItem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpExecuteLongIOWorkItem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Function</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadCB</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l02583">2583</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00354">DBG_SET_FUNCTION</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00227">NumIOWorkRequests</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00228">NumLongIOWorkRequests</a>.
<p>
<pre class="fragment"><div>02590                    :
02591 
02592     Executes an IO Work function. RUNs in a APC in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IO Worker thread.
02593 
02594 Arguments:
02595 
02596     Function - Worker function to call
02597 
02598     Context - Argument <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> worker function.
02599 
02600     NotUsed - Argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not used in <span class="keyword">this</span> function.
02601 
02602 Return Value:
02603 
02604 --*/
02605 {
02606 <span class="preprocessor">    #if (DBG1)</span>
02607 <span class="preprocessor"></span>    <a class="code" href="../../d3/d1/threads_8h.html#a24">DBG_SET_FUNCTION</a>( Function, Context ) ;
02608 <span class="preprocessor">    #endif</span>
02609 <span class="preprocessor"></span>
02610     <span class="comment">// Invoke the function</span>
02611 
02612     <span class="keywordflow">try</span> {
02613         ((WORKERCALLBACKFUNC) Function)((PVOID)Context) ;
02614     } except (EXCEPTION_EXECUTE_HANDLER) {
02615         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
02616     }
02617 
02618 
02619     ((<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html">PRTLP_IOWORKER_TCB</a>)ThreadCB)-&gt;LongFunctionFlag = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02620 
02621     <span class="comment">// Decrement pending IO requests count</span>
02622 
02623     InterlockedDecrement (&amp;NumIOWorkRequests) ;
02624 
02625     <span class="comment">// decrement pending long funcitons</span>
02626 
02627     InterlockedDecrement (&amp;NumLongIOWorkRequests ) ;
02628 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="threads.c::RtlpExecuteWorkerRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpExecuteWorkerRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>Status</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l01589">1589</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00354">DBG_SET_FUNCTION</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00187">_RTLP_WORK::Flags</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00186">_RTLP_WORK::Function</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00230">NumLongWorkRequests</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00229">NumWorkRequests</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00302">RtlpFreeTPHeap</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l01506">RtlpQueueWorkerRequest()</a>.
<p>
<pre class="fragment"><div>01596                    :
01597 
01598     This routine executes a work item.
01599     
01600 Arguments:
01601 
01602     Context - contains context to be passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback function.
01603 
01604     WorkContext - contains callback function ptr and flags
01605     
01606 Return Value:
01607 
01608 Notes:
01609     This function executes in a worker thread or a timer thread <span class="keywordflow">if</span>
01610     WT_EXECUTEINTIMERTHREAD flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set.
01611 
01612 --*/
01613 
01614 {
01615     <a class="code" href="../../d6/d7/struct__RTLP__WORK.html">PRTLP_WORK</a> WorkEntry = (<a class="code" href="../../d6/d7/struct__RTLP__WORK.html">PRTLP_WORK</a>) WorkContext;
01616 
01617 <span class="preprocessor">    #if (DBG1)</span>
01618 <span class="preprocessor"></span>    <a class="code" href="../../d3/d1/threads_8h.html#a24">DBG_SET_FUNCTION</a>( WorkEntry-&gt;<a class="code" href="../../d6/d7/struct__RTLP__WORK.html#o0">Function</a>, Context ) ;
01619 <span class="preprocessor">    #endif</span>
01620 <span class="preprocessor"></span>
01621     <span class="keywordflow">try</span> {
01622         ((WORKERCALLBACKFUNC) WorkEntry-&gt;<a class="code" href="../../d6/d7/struct__RTLP__WORK.html#o0">Function</a>) ( Context ) ;
01623 
01624     } except (EXCEPTION_EXECUTE_HANDLER) {
01625 <span class="comment">//        ASSERT(FALSE);</span>
01626     }
01627     
01628     InterlockedDecrement( &amp;NumWorkRequests ) ;
01629     <span class="keywordflow">if</span> (WorkEntry-&gt;<a class="code" href="../../d6/d7/struct__RTLP__WORK.html#o1">Flags</a> &amp; WT_EXECUTELONGFUNCTION) {
01630         InterlockedDecrement( &amp;NumLongWorkRequests ) ;
01631     }
01632 
01633     <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( WorkEntry ) ;
01634 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="threads.c::RtlpExitThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpExitThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">NTSTATUS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Status</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l02738">2738</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00461">NtTerminateThread()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>02741 {
02742     <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/psdelete_8c.html#a6">NtTerminateThread</a>( NtCurrentThread(), Status );
02743 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="threads.c::RtlpFindWaitThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpFindWaitThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ThreadCB</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l03851">3851</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00310">ACQUIRE_GLOBAL_WAIT_LOCK</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00313">RELEASE_GLOBAL_WAIT_LOCK</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00261">RtlpStartThreadFunc</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02824">RtlpWaitThread()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00247">WaitThreads</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l00077">RtlRegisterWait()</a>.
<p>
<pre class="fragment"><div>03856                    :
03857 
03858     Walks thru <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of wait threads and finds one which can accomodate another wait.
03859     If one <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not found then a <span class="keyword">new</span> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created.
03860 
03861     This routine assumes that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GlobalWaitLock.
03862 
03863 Arguments:
03864 
03865     ThreadCB: returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ThreadCB of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait thread that will service <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait request.
03866 
03867 Return Value:
03868 
03869     STATUS_SUCCESS <span class="keywordflow">if</span> a wait thread was allocated,
03870 
03871 --*/
03872 {
03873     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03874     PLIST_ENTRY Node ;
03875     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> ;
03876     <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCBTmp;
03877 
03878     
03879     <a class="code" href="../../d3/d1/threads_8h.html#a19">ACQUIRE_GLOBAL_WAIT_LOCK</a>() ;
03880 
03881     <span class="keywordflow">do</span> {
03882 
03883         <span class="comment">// Walk thru the list of Wait Threads and find a Wait thread that can accomodate a</span>
03884         <span class="comment">// new wait request.</span>
03885 
03886         <span class="comment">// *Consider* finding a wait thread with least # of waits to facilitate better</span>
03887         <span class="comment">// load balancing of waits.</span>
03888 
03889 
03890         <span class="keywordflow">for</span> (Node = <a class="code" href="../../d3/d1/threads_8h.html#a92">WaitThreads</a>.Flink ; Node != &amp;<a class="code" href="../../d3/d1/threads_8h.html#a92">WaitThreads</a> ; Node = Node-&gt;Flink) {
03891 
03892             ThreadCBTmp = CONTAINING_RECORD (Node, <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">RTLP_WAIT_THREAD_CONTROL_BLOCK</a>, 
03893                                             WaitThreadsList) ;
03894 
03895 
03896             <span class="comment">// Wait Threads can accomodate upto 64 waits (NtWaitForMultipleObject limit)</span>
03897 
03898             <span class="keywordflow">if</span> ((ThreadCBTmp)-&gt;NumWaits &lt; 64) {
03899 
03900                 <span class="comment">// Found a thread with some wait slots available.</span>
03901 
03902                 InterlockedIncrement ( &amp;(ThreadCBTmp)-&gt;NumWaits) ;
03903 
03904                 *ThreadCB = ThreadCBTmp;
03905                 
03906                 <a class="code" href="../../d3/d1/threads_8h.html#a20">RELEASE_GLOBAL_WAIT_LOCK</a>() ;
03907                 
03908                 <span class="keywordflow">return</span> STATUS_SUCCESS ;
03909             }
03910 
03911         }
03912 
03913 
03914         <span class="comment">// If we reach here, we dont have any more wait threads. so create a new wait thread.</span>
03915 
03916         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a102">RtlpStartThreadFunc</a> (RtlpWaitThread, &amp;ThreadHandle) ;
03917 
03918 
03919         <span class="comment">// If thread creation fails then return the failure to caller</span>
03920 
03921         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS ) {
03922 
03923 <span class="preprocessor">            #if DBG</span>
03924 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ERROR!! ThreadPool: could not create wait thread\n"</span>);
03925 <span class="preprocessor">            #endif</span>
03926 <span class="preprocessor"></span>
03927             <a class="code" href="../../d3/d1/threads_8h.html#a20">RELEASE_GLOBAL_WAIT_LOCK</a>() ;
03928             
03929             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
03930 
03931         } <span class="keywordflow">else</span> {
03932 
03933             <span class="comment">// Close Thread handle, we dont need it.</span>
03934 
03935             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (ThreadHandle) ;
03936         }
03937 
03938         <span class="comment">// Loop back now that we have created another thread</span>
03939 
03940     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ;    <span class="comment">// Loop back to top and put new wait request in the newly created thread</span>
03941 
03942     <a class="code" href="../../d3/d1/threads_8h.html#a20">RELEASE_GLOBAL_WAIT_LOCK</a>() ;
03943     
03944     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
03945 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="threads.c::RtlpFireTimers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpFireTimers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PLIST_ENTRY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TimersToFireList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l03747">3747</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00354">DBG_SET_FUNCTION</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00410">DPRN4</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00045">PRTLP_TIMER</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00044">RTLP_TIMER</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03082">RtlpAsyncCallbackCompletion()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05847">RtlpForceAllocateTPHeap()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00302">RtlpFreeTPHeap</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00437">RtlQueueWorkItem()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00766">STATE_DONTFIRE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00174">_RTLP_WAITWORKER::Timer</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00177">_RTLP_WAITWORKER::TimerCondition</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00173">_RTLP_WAITWORKER::Wait</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00176">_RTLP_WAITWORKER::WaitThreadCallback</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l03697">RtlpProcessTimeouts()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l04821">RtlpServiceTimer()</a>.
<p>
<pre class="fragment"><div>03752                    :
03753 
03754     Finally all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timers are fired here.
03755 
03756 Arguments:
03757 
03758     TimersToFireList: <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> of timers to fire
03759 
03760 --*/
03761 
03762 {
03763     PLIST_ENTRY Node ;
03764     <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> Timer ;
03765     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03766 
03767     
03768     <span class="keywordflow">for</span> (Node = TimersToFireList-&gt;Flink;  Node != TimersToFireList; Node = TimersToFireList-&gt;Flink)
03769     {
03770         Timer = CONTAINING_RECORD (Node, RTLP_TIMER, TimersToFireList) ;
03771 
03772         RemoveEntryList( Node ) ;
03773         InitializeListHead( Node ) ;
03774 
03775         
03776         <span class="keywordflow">if</span> ( (Timer-&gt;State &amp; <a class="code" href="../../d3/d1/threads_8h.html#a44">STATE_DONTFIRE</a>) 
03777             || (Timer-&gt;Queue-&gt;State &amp; <a class="code" href="../../d3/d1/threads_8h.html#a44">STATE_DONTFIRE</a>) )
03778         {
03779             ;
03780 
03781         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( Timer-&gt;Flags &amp; (WT_EXECUTEINTIMERTHREAD | WT_EXECUTEINWAITTHREAD ) ) {
03782 
03783             <span class="comment">//DPRN5</span>
03784             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a38">DPRN4</a>)
03785             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Calling WaitOrTimer(Timer): fn:%x  context:%x  bool:%d Thread&lt;%d:%d&gt;\n"</span>,
03786                 (ULONG_PTR)Timer-&gt;Function, (ULONG_PTR)Timer-&gt;Context,
03787                 TRUE,
03788                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
03789                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)
03790                 ) ;
03791 
03792 <span class="preprocessor">            #if (DBG1)</span>
03793 <span class="preprocessor"></span>            <a class="code" href="../../d3/d1/threads_8h.html#a24">DBG_SET_FUNCTION</a>( Timer-&gt;Function, Timer-&gt;Context ) ;
03794 <span class="preprocessor">            #endif</span>
03795 <span class="preprocessor"></span>
03796 
03797             ((WAITORTIMERCALLBACKFUNC) Timer-&gt;Function) (Timer-&gt;Context, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ;
03798 
03799         } <span class="keywordflow">else</span> {
03800 
03801             <span class="comment">// create context for Callback and queue it appropriately</span>
03802             
03803             <a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html">PRTLP_ASYNC_CALLBACK</a>  AsyncCallback ;
03804             
03805             AsyncCallback = <a class="code" href="../../d3/d1/threads_8h.html#a166">RtlpForceAllocateTPHeap</a>(
03806                                     <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html">RTLP_ASYNC_CALLBACK</a> ), 
03807                                     0 );
03808             AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o3">TimerCondition</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
03809 
03810             <span class="comment">// timer associated with WaitEvents should be treated differently</span>
03811             
03812             <span class="keywordflow">if</span> ( Timer-&gt;Wait != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03813 
03814                 AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o0">Wait</a> = Timer-&gt;Wait ;
03815                 AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o2">WaitThreadCallback</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
03816                 
03817                 InterlockedIncrement( Timer-&gt;RefCountPtr ) ;
03818 
03819             } <span class="keywordflow">else</span> {
03820 
03821                 AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o1">Timer</a> = Timer ;
03822                 AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o2">WaitThreadCallback</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
03823 
03824                 InterlockedIncrement( &amp;Timer-&gt;RefCount ) ;
03825             }
03826 
03827 
03828             <span class="comment">// queue work item</span>
03829             
03830             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a8">RtlQueueWorkItem</a>( RtlpAsyncCallbackCompletion, AsyncCallback, 
03831                                 Timer-&gt;Flags );
03832                                 
03833             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03834 
03835                 <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( AsyncCallback );
03836                 <span class="keywordflow">if</span> ( Timer-&gt;Wait != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03837                     InterlockedDecrement( Timer-&gt;RefCountPtr ) ;
03838                 } <span class="keywordflow">else</span> {
03839                     InterlockedDecrement( &amp;Timer-&gt;RefCount ) ;
03840                 }
03841             }
03842             
03843         }
03844 
03845         
03846     }
03847 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="threads.c::RtlpFireTimersAndReorder" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpFireTimersAndReorder           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PRTLP_TIMER_QUEUE&nbsp;</td>
          <td class="mdname" nowrap> <em>Queue</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewFiringTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>TimersToFireList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l05010">5010</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00277">INFINITE_TIME</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00045">PRTLP_TIMER</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00044">RTLP_TIMER</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03483">RtlpDeactivateWait()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04507">RtlpInsertInDeltaList()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00760">STATE_ACTIVE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00766">STATE_DONTFIRE</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00769">STATE_ONE_SHOT_FIRED</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l03697">RtlpProcessTimeouts()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l04821">RtlpServiceTimer()</a>.
<p>
<pre class="fragment"><div>05017                    :
05018 
05019     Fires all timers in TimerList that have DeltaFiringTime == 0. After firing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timers
05020     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> reorders <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timers based on their periodic times OR frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fired one shot timers.
05021 
05022 Arguments:
05023 
05024     TimerList - Timer list to work thru.
05025 
05026     NewFiringTime - Location where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> firing time <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first timer in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delta list
05027                     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
05028 
05029 
05030 Return Value:
05031 
05032 
05033 --*/
05034 {
05035     PLIST_ENTRY TNode ;
05036     <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> Timer ;
05037     LIST_ENTRY ReinsertTimerList ;
05038     PLIST_ENTRY TimerList = &amp;Queue-&gt;TimerList ;
05039     
05040     InitializeListHead (&amp;ReinsertTimerList) ;
05041     *NewFiringTime = 0 ;
05042     
05043 
05044     <span class="keywordflow">for</span> (TNode = TimerList-&gt;Flink ; (TNode != TimerList) &amp;&amp; (*NewFiringTime == 0); 
05045             TNode = TimerList-&gt;Flink) 
05046     {
05047 
05048         Timer = CONTAINING_RECORD (TNode, RTLP_TIMER, List) ;
05049 
05050         <span class="comment">// Fire all timers with delta time of 0</span>
05051 
05052         <span class="keywordflow">if</span> (Timer-&gt;DeltaFiringTime == 0) {
05053 
05054             <span class="comment">// detach this timer from the list</span>
05055 
05056             RemoveEntryList (TNode) ;
05057 
05058             <span class="comment">// get next firing time</span>
05059             
05060             <span class="keywordflow">if</span> (!IsListEmpty(TimerList)) {
05061 
05062                 <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> TmpTimer ;
05063 
05064                 TmpTimer = CONTAINING_RECORD (TimerList-&gt;Flink, RTLP_TIMER, List) ;
05065 
05066                 *NewFiringTime  = TmpTimer-&gt;DeltaFiringTime ;
05067 
05068                 TmpTimer-&gt;DeltaFiringTime = 0 ;
05069 
05070             } <span class="keywordflow">else</span> {
05071 
05072                 *NewFiringTime = <a class="code" href="../../d3/d1/threads_8h.html#a10">INFINITE_TIME</a> ;
05073             }
05074 
05075 
05076             <span class="comment">// if timer is not periodic then remove active state. Timer will be deleted</span>
05077             <span class="comment">// when cancel timer is called.</span>
05078 
05079             <span class="keywordflow">if</span> (Timer-&gt;Period == 0) {
05080 
05081                 InsertHeadList( &amp;Queue-&gt;UncancelledTimerList, &amp;Timer-&gt;List ) ;
05082 
05083                 <span class="comment">// if one shot wait was timed out then, deactivate the wait</span>
05084                 
05085                 <span class="keywordflow">if</span> ( Timer-&gt;Wait ) {
05086 
05087                     <span class="comment">//</span>
05088                     <span class="comment">// though timer is being "freed" in this call, it can still be</span>
05089                     <span class="comment">// used after this call</span>
05090                     <span class="comment">//</span>
05091                     
05092                     <a class="code" href="../../d3/d1/threads_8h.html#a132">RtlpDeactivateWait</a>( Timer-&gt;Wait ) ;
05093                 }
05094 
05095                 <span class="keywordflow">else</span> {
05096                     <span class="comment">// should be set at the end</span>
05097                 
05098                     Timer-&gt;State &amp;= ~<a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a> ;
05099                 }
05100 
05101                 Timer-&gt;State |= <a class="code" href="../../d3/d1/threads_8h.html#a45">STATE_ONE_SHOT_FIRED</a> ;
05102                 
05103             } <span class="keywordflow">else</span> {
05104 
05105                 <span class="comment">// Set the DeltaFiringTime to be the next period</span>
05106 
05107                 Timer-&gt;DeltaFiringTime = Timer-&gt;Period ;
05108 
05109                 <span class="comment">// reinsert the timer in the list.</span>
05110                 
05111                 <a class="code" href="../../d3/d1/threads_8h.html#a127">RtlpInsertInDeltaList</a> (TimerList, Timer, *NewFiringTime, NewFiringTime) ;
05112             }
05113 
05114 
05115             <span class="comment">// Call the function associated with this timer. call it in the end</span>
05116             <span class="comment">// so that RtlTimer calls can be made in the timer function</span>
05117 
05118             <span class="keywordflow">if</span> ( (Timer-&gt;State &amp; <a class="code" href="../../d3/d1/threads_8h.html#a44">STATE_DONTFIRE</a>) 
05119                 || (Timer-&gt;Queue-&gt;State &amp; <a class="code" href="../../d3/d1/threads_8h.html#a44">STATE_DONTFIRE</a>) )
05120             {
05121                 ;
05122 
05123             } <span class="keywordflow">else</span> {
05124 
05125                 InsertTailList( TimersToFireList, &amp;Timer-&gt;TimersToFireList ) ;
05126 
05127             }
05128 
05129         } <span class="keywordflow">else</span> {
05130 
05131             <span class="comment">// No more Timers with DeltaFiringTime == 0</span>
05132 
05133             <span class="keywordflow">break</span> ;
05134 
05135         }
05136     }
05137 
05138 
05139     <span class="keywordflow">if</span> ( *NewFiringTime == 0 ) {
05140         *NewFiringTime = <a class="code" href="../../d3/d1/threads_8h.html#a10">INFINITE_TIME</a> ;
05141     }
05142 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a74" doxytag="threads.c::RtlpForceAllocateTPHeap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID RtlpForceAllocateTPHeap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>dwSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>dwFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l05847">5847</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d7/propapi_8h-source.html#l00043">dwFlags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d5/delay_8c-source.html#l00033">NtDelayExecution()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00295">ONE_SECOND_TIMEOUT</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00305">RtlpAllocateTPHeap</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l03747">RtlpFireTimers()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05575">RtlpGetWaitEvent()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03172">RtlpProcessWaitCompletion()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l01506">RtlpQueueWorkerRequest()</a>.
<p>
<pre class="fragment"><div>05852                    :
05853 
05854     This routine goes into an infinite loop trying to allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory.
05855 
05856 Arguments:
05857 
05858     dwSize - size of memory to be allocated
05859 
05860     <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> - Flags <span class="keywordflow">for</span> memory allocation
05861 
05862 Return Value:
05863 
05864     ptr to memory
05865 
05866 --*/
05867 {
05868     PVOID ptr;
05869     ptr = <a class="code" href="../../d3/d1/threads_8h.html#a18">RtlpAllocateTPHeap</a>(dwSize, dwFlags);
05870     <span class="keywordflow">if</span> (ptr)
05871         <span class="keywordflow">return</span> ptr;
05872 
05873     {
05874         LARGE_INTEGER TimeOut ;
05875         <span class="keywordflow">do</span> {
05876 
05877             <a class="code" href="../../d3/d1/threads_8h.html#a15">ONE_SECOND_TIMEOUT</a>(TimeOut) ;
05878 
05879             <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (FALSE, &amp;TimeOut) ;
05880 
05881             ptr = <a class="code" href="../../d3/d1/threads_8h.html#a18">RtlpAllocateTPHeap</a>(dwSize, dwFlags);
05882             <span class="keywordflow">if</span> (ptr)
05883                 <span class="keywordflow">break</span>;
05884 
05885         } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ;
05886     }
05887     <span class="keywordflow">return</span> ptr;
05888 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a69" doxytag="threads.c::RtlpFreeWaitEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpFreeWaitEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Event</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l05648">5648</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00248">EventCache</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00258">EventCacheCriticalSection</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00279">MAX_UNUSED_EVENTS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00239">NumUnusedEvents</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00302">RtlpFreeTPHeap</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l01145">RtlDeleteTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00809">RtlDeleteTimerQueueEx()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l00256">RtlDeregisterWaitEx()</a>.
<p>
<pre class="fragment"><div>05653                    :
05654 
05655     Frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event cache
05656 
05657 Arguments:
05658 
05659     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event <span class="keyword">struct </span>to put back into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache
05660 
05661 Return Value:
05662 
05663     Nothing
05664 
05665 --*/
05666 {
05667 
05668     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
05669         <span class="keywordflow">return</span> ;
05670         
05671     InitializeListHead (&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;List) ;
05672 
05673     RtlEnterCriticalSection (&amp;EventCacheCriticalSection) ;
05674 
05675     <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d1/threads_8h.html#a87">NumUnusedEvents</a> &gt; <a class="code" href="../../d3/d1/threads_8h.html#a12">MAX_UNUSED_EVENTS</a> ) {
05676 
05677         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Handle ) ;
05678         
05679         <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( Event ) ;
05680 
05681     } <span class="keywordflow">else</span> {
05682     
05683         InsertHeadList (&amp;EventCache, &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;List) ;
05684         <a class="code" href="../../d3/d1/threads_8h.html#a87">NumUnusedEvents</a>++ ;
05685     }
05686 
05687     
05688     RtlLeaveCriticalSection (&amp;EventCacheCriticalSection) ;
05689 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="threads.c::RtlpGet64BitTickCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> __inline LONGLONG RtlpGet64BitTickCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LARGE_INTEGER *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Last64BitTickCount</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l03644">3644</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00383">Last64BitTickCount</a>, and <a class="el" href="../../d0/d5/gettickc_8c-source.html#l00026">NtGetTickCount()</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l03697">RtlpProcessTimeouts()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04429">RtlpResetTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03674">RtlpResync64BitTickCount()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l04821">RtlpServiceTimer()</a>.
<p>
<pre class="fragment"><div>03649                    :
03650 
03651     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> getting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> latest 64bit tick count.
03652 
03653 Arguments:
03654 
03655 Return Value: 64bit tick count
03656 
03657 --*/
03658 {
03659     LARGE_INTEGER liCurTime ;
03660 
03661     liCurTime.QuadPart = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() + <a class="code" href="../../d3/d1/threads_8h.html#a109">Last64BitTickCount</a>-&gt;HighPart ;
03662 
03663     <span class="comment">// see if timer has wrapped.</span>
03664 
03665     <span class="keywordflow">if</span> (liCurTime.LowPart &lt; <a class="code" href="../../d3/d1/threads_8h.html#a109">Last64BitTickCount</a>-&gt;LowPart) {
03666         liCurTime.HighPart++ ;
03667     }
03668 
03669     <span class="keywordflow">return</span> (<a class="code" href="../../d3/d1/threads_8h.html#a109">Last64BitTickCount</a>-&gt;QuadPart = liCurTime.QuadPart) ;
03670 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="threads.c::RtlpGetQueueRelativeTime" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG RtlpGetQueueRelativeTime           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PRTLP_TIMER_QUEUE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Queue</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l04326">4326</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00048">PRTLP_TIMER_QUEUE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00047">RTLP_TIMER_QUEUE</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00251">TimerQueues</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l03954">RtlpAddTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04202">RtlpDeactivateTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05354">RtlpDeleteTimerQueue()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l04044">RtlpUpdateTimer()</a>.
<p>
<pre class="fragment"><div>04331                    :
04332 
04333     Walks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of queues and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relative firing time by adding all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04334     DeltaFiringTimes <span class="keywordflow">for</span> all queues before <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
04335 
04336 Arguments:
04337 
04338     Queue - Queue <span class="keywordflow">for</span> which to find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relative firing time
04339 
04340 Return Value:
04341 
04342     <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> in milliseconds
04343 
04344 --*/
04345 {
04346     PLIST_ENTRY Node ;
04347     ULONG RelativeTime ;
04348     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> CurrentQueue ;
04349 
04350     RelativeTime = 0 ;
04351 
04352     <span class="comment">// It the Queue is not attached to TimerQueues List because it has no timer</span>
04353     <span class="comment">// associated with it simply returns 0 as the relative time. Else run thru</span>
04354     <span class="comment">// all queues before it in the list and compute the relative firing time</span>
04355 
04356     <span class="keywordflow">if</span> (!IsListEmpty (&amp;Queue-&gt;List)) {
04357 
04358         <span class="keywordflow">for</span> (Node = <a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>.Flink; Node != &amp;Queue-&gt;List; Node=Node-&gt;Flink) {
04359 
04360             CurrentQueue = CONTAINING_RECORD (Node, RTLP_TIMER_QUEUE, List) ;
04361 
04362             RelativeTime += CurrentQueue-&gt;DeltaFiringTime ;
04363 
04364         }
04365 
04366         <span class="comment">// Add the queue's delta firing time as well</span>
04367 
04368         RelativeTime += Queue-&gt;DeltaFiringTime ;
04369         
04370     }
04371 
04372     <span class="keywordflow">return</span> RelativeTime ;
04373 
04374 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="threads.c::RtlpGetTimeRemaining" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG RtlpGetTimeRemaining           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TimerHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l04378">4378</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00822">NtQueryTimer()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00252">TimerHandle</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l05767">RtlDebugPrintTimes()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03954">RtlpAddTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03302">RtlpAddWait()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04202">RtlpDeactivateTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03483">RtlpDeactivateWait()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05354">RtlpDeleteTimerQueue()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03697">RtlpProcessTimeouts()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03172">RtlpProcessWaitCompletion()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04821">RtlpServiceTimer()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l04044">RtlpUpdateTimer()</a>.
<p>
<pre class="fragment"><div>04383                    :
04384 
04385     Gets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time remaining on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified NT timer
04386 
04387 Arguments:
04388 
04389     <a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a> - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT timer
04390 
04391 Return Value:
04392 
04393     <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> remaining on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer
04394 
04395 --*/
04396 {
04397     ULONG InfoLen ;
04398     TIMER_BASIC_INFORMATION Info ;
04399 
04400     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
04401 
04402     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d2/timer_8c.html#a14">NtQueryTimer</a> (TimerHandle, TimerBasicInformation, &amp;Info, <span class="keyword">sizeof</span>(Info), &amp;InfoLen) ;
04403 
04404     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Status == STATUS_SUCCESS) ;
04405 
04406     <span class="comment">// Return 0 if</span>
04407     <span class="comment">//</span>
04408     <span class="comment">// - the timer has already fired then return</span>
04409     <span class="comment">//   OR</span>
04410     <span class="comment">// - the timer is has more than 0x7f0000000 in its high part</span>
04411     <span class="comment">//   (which indicates that the timer was (probably) programmed for -1)</span>
04412 
04413     
04414     <span class="keywordflow">if</span> (Info.TimerState || ((ULONG)Info.RemainingTime.HighPart &gt; 0x7f000000) ) {
04415 
04416         <span class="keywordflow">return</span> 0 ;
04417 
04418     } <span class="keywordflow">else</span> {
04419 
04420         <span class="keywordflow">return</span> (ULONG) (Info.RemainingTime.QuadPart / 10000) ;
04421 
04422     }
04423 
04424 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="threads.c::RtlpGetWaitEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a> RtlpGetWaitEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l05575">5575</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00219">CompletedEventCacheInitialization</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00248">EventCache</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00258">EventCacheCriticalSection</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00180">NtCreateEvent()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d1/threads_8h.html#a60">RTLP_EVENT</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05847">RtlpForceAllocateTPHeap()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00302">RtlpFreeTPHeap</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05694">RtlpInitializeEventCache()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l01145">RtlDeleteTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00809">RtlDeleteTimerQueueEx()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l00256">RtlDeregisterWaitEx()</a>.
<p>
<pre class="fragment"><div>05580                    :
05581 
05582     Returns an event from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event cache.
05583 
05584 Arguments:
05585 
05586     None
05587 
05588 Return Value:
05589 
05590     Pointer to event structure
05591 
05592 --*/
05593 {
05594     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05595     <a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> ;
05596 
05597     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d1/threads_8h.html#a71">CompletedEventCacheInitialization</a>) {
05598 
05599         <a class="code" href="../../d3/d1/threads_8h.html#a157">RtlpInitializeEventCache</a> () ;
05600 
05601     }
05602 
05603     RtlEnterCriticalSection (&amp;EventCacheCriticalSection) ;
05604 
05605     <span class="keywordflow">if</span> (!IsListEmpty (&amp;EventCache)) {
05606 
05607         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = (<a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a>) RemoveHeadList (&amp;EventCache) ;
05608 
05609     } <span class="keywordflow">else</span> {
05610 
05611         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = <a class="code" href="../../d3/d1/threads_8h.html#a166">RtlpForceAllocateTPHeap</a>( <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">RTLP_EVENT</a> ), 0 );
05612 
05613         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>) {
05614 
05615             RtlLeaveCriticalSection (&amp;EventCacheCriticalSection) ;
05616 
05617             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
05618 
05619         }
05620 
05621         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/ex_2event_8c.html#a5">NtCreateEvent</a>(
05622                     &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Handle,
05623                     EVENT_ALL_ACCESS,
05624                     NULL,
05625                     SynchronizationEvent,
05626                     FALSE
05627                     );
05628 
05629         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
05630 
05631             <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( Event ) ;
05632 
05633             RtlLeaveCriticalSection (&amp;EventCacheCriticalSection) ;
05634 
05635             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
05636 
05637         }
05638 
05639     }
05640 
05641     RtlLeaveCriticalSection (&amp;EventCacheCriticalSection) ;
05642 
05643     <span class="keywordflow">return</span> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> ;
05644 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a70" doxytag="threads.c::RtlpInitializeEventCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpInitializeEventCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l05694">5694</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00219">CompletedEventCacheInitialization</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00248">EventCache</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00258">EventCacheCriticalSection</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d8/d5/delay_8c-source.html#l00033">NtDelayExecution()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00239">NumUnusedEvents</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00285">ONE_MILLISECOND_TIMEOUT</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01210">RtlInitializeCriticalSection()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00218">StartedEventCacheInitialization</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l05575">RtlpGetWaitEvent()</a>.
<p>
<pre class="fragment"><div>05699                    :
05700 
05701     Initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event cache
05702 
05703 Arguments:
05704 
05705     None
05706 
05707 Return Value:
05708 
05709     Nothing
05710 
05711 --*/
05712 {
05713     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05714     LARGE_INTEGER TimeOut ;
05715 
05716     <span class="keywordflow">if</span> (!InterlockedExchange(&amp;StartedEventCacheInitialization, 1L)) {
05717 
05718         InitializeListHead (&amp;EventCache) ;
05719 
05720         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;EventCacheCriticalSection) ;
05721 
05722         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Status == STATUS_SUCCESS) ;
05723 
05724         <a class="code" href="../../d3/d1/threads_8h.html#a87">NumUnusedEvents</a> = 0 ;
05725         
05726         InterlockedExchange (&amp;CompletedEventCacheInitialization, 1L) ;
05727 
05728     } <span class="keywordflow">else</span> {
05729 
05730         <span class="comment">// sleep for 1 milliseconds and see if the initialization is complete</span>
05731 
05732         <a class="code" href="../../d3/d1/threads_8h.html#a13">ONE_MILLISECOND_TIMEOUT</a>(TimeOut) ;
05733 
05734         <span class="keywordflow">while</span> (!(<span class="keyword">volatile</span> ULONG) <a class="code" href="../../d3/d1/threads_8h.html#a71">CompletedEventCacheInitialization</a>) {
05735 
05736             <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (FALSE, &amp;TimeOut) ;
05737 
05738         }
05739 
05740     }
05741 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="threads.c::RtlpInitializeTimerThreadPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpInitializeTimerThreadPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l05256">5256</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00216">CompletedTimerInitialization</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00385">Firing64BitTickCount</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00444">NtCreateTimer()</a>, <a class="el" href="../../d8/d5/delay_8c-source.html#l00033">NtDelayExecution()</a>, <a class="el" href="../../d0/d5/gettickc_8c-source.html#l00026">NtGetTickCount()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00285">ONE_MILLISECOND_TIMEOUT</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00384">Resync64BitTickCount</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01210">RtlInitializeCriticalSection()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00261">RtlpStartThreadFunc</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05201">RtlpTimerThread()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00215">StartedTimerInitialization</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00257">TimerCriticalSection</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00252">TimerHandle</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00251">TimerQueues</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00221">TimerThreadHandle</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l00691">RtlCreateTimerQueue()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l01965">RtlpInitializeWorkerThreadPool()</a>.
<p>
<pre class="fragment"><div>05260                    :
05261 
05262     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to initialize structures used <span class="keywordflow">for</span> Timer Thread
05263 
05264 Arguments:
05265 
05266 
05267 Return Value:
05268 
05269 --*/
05270 {
05271     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
05272     LARGE_INTEGER TimeOut ;
05273 
05274     <span class="comment">// In order to avoid an explicit RtlInitialize() function to initialize the wait thread pool</span>
05275     <span class="comment">// we use StartedTimerInitialization and CompletedTimerInitialization to provide us the</span>
05276     <span class="comment">// necessary synchronization to avoid multiple threads from initializing the thread pool.</span>
05277     <span class="comment">// This scheme does not work if RtlInitializeCriticalSection() or NtCreateEvent fails - but in this case the</span>
05278     <span class="comment">// caller has not choices left.</span>
05279 
05280     <span class="keywordflow">if</span> (!InterlockedExchange(&amp;StartedTimerInitialization, 1L)) {
05281 
05282         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a69">CompletedTimerInitialization</a>)
05283             InterlockedExchange(&amp;CompletedTimerInitialization, 0 ) ;
05284 
05285         <span class="keywordflow">do</span> {
05286 
05287             <span class="comment">// Initialize global timer lock</span>
05288 
05289             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>( &amp;TimerCriticalSection ) ;
05290             <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
05291                 <span class="keywordflow">break</span> ;
05292             }
05293 
05294             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d2/timer_8c.html#a11">NtCreateTimer</a>(
05295                                 &amp;TimerHandle,
05296                                 TIMER_ALL_ACCESS,
05297                                 NULL,
05298                                 NotificationTimer
05299                                 ) ;
05300 
05301             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) )
05302                 <span class="keywordflow">break</span> ;
05303                 
05304             InitializeListHead (&amp;TimerQueues) ; <span class="comment">// Initialize Timer Queue Structures</span>
05305 
05306 
05307             <span class="comment">// initialize tick count</span>
05308 
05309             <a class="code" href="../../d3/d1/threads_8h.html#a110">Resync64BitTickCount</a>.QuadPart = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>()  ;
05310             <a class="code" href="../../d3/d1/threads_8h.html#a111">Firing64BitTickCount</a>.QuadPart = 0 ;
05311 
05312             
05313             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a102">RtlpStartThreadFunc</a> (RtlpTimerThread, &amp;TimerThreadHandle) ;
05314 
05315             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) )
05316                 <span class="keywordflow">break</span> ;
05317 
05318 
05319         } <span class="keywordflow">while</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) ;
05320 
05321         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
05322 
05323             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Status == STATUS_SUCCESS) ;
05324             
05325             <a class="code" href="../../d3/d1/threads_8h.html#a68">StartedTimerInitialization</a> = 0 ;
05326             InterlockedExchange (&amp;CompletedTimerInitialization, ~0) ;
05327             
05328             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
05329         }
05330         
05331         InterlockedExchange (&amp;CompletedTimerInitialization, 1L) ;
05332 
05333     } <span class="keywordflow">else</span> {
05334 
05335         <span class="comment">// Sleep 1 ms and see if the other thread has completed initialization</span>
05336 
05337         <a class="code" href="../../d3/d1/threads_8h.html#a13">ONE_MILLISECOND_TIMEOUT</a>(TimeOut) ;
05338 
05339         <span class="keywordflow">while</span> (!(<span class="keyword">volatile</span> ULONG) <a class="code" href="../../d3/d1/threads_8h.html#a69">CompletedTimerInitialization</a>) {
05340 
05341             <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (FALSE, &amp;TimeOut) ;
05342 
05343         }
05344         
05345         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a69">CompletedTimerInitialization</a> != 1)
05346             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY ;
05347     }
05348 
05349     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ? STATUS_SUCCESS : <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
05350 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="threads.c::RtlpInitializeWaitThreadPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpInitializeWaitThreadPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l02751">2751</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00213">CompletedWaitInitialization</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d8/d5/delay_8c-source.html#l00033">NtDelayExecution()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00285">ONE_MILLISECOND_TIMEOUT</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01210">RtlInitializeCriticalSection()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00212">StartedWaitInitialization</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00256">WaitCriticalSection</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00247">WaitThreads</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l00077">RtlRegisterWait()</a>.
<p>
<pre class="fragment"><div>02755                    :
02756 
02757     This routine initializes all aspects of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
02758 
02759 Arguments:
02760 
02761     None
02762 
02763 Return Value:
02764 
02765     None
02766 
02767 --*/
02768 {
02769     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02770     LARGE_INTEGER TimeOut ;
02771 
02772     <span class="comment">// In order to avoid an explicit RtlInitialize() function to initialize the wait thread pool</span>
02773     <span class="comment">// we use StartedWaitInitialization and CompletedWait Initialization to provide us the</span>
02774     <span class="comment">// necessary synchronization to avoid multiple threads from initializing the thread pool.</span>
02775     <span class="comment">// This scheme does not work if RtlInitializeCriticalSection() or NtCreateEvent fails - but in this case the</span>
02776     <span class="comment">// caller has not choices left.</span>
02777 
02778     <span class="keywordflow">if</span> (!InterlockedExchange(&amp;StartedWaitInitialization, 1L)) {
02779 
02780         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a67">CompletedWaitInitialization</a>)
02781             InterlockedExchange (&amp;CompletedWaitInitialization, 0L) ;
02782 
02783         <span class="comment">// Initialize Critical Section</span>
02784 
02785         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>( &amp;WaitCriticalSection ) ;
02786 
02787         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
02788 
02789             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) ;
02790 
02791             <a class="code" href="../../d3/d1/threads_8h.html#a66">StartedWaitInitialization</a> = 0 ;
02792             InterlockedExchange (&amp;CompletedWaitInitialization, ~0) ;
02793             
02794             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02795         }
02796             
02797         InitializeListHead (&amp;WaitThreads);  <span class="comment">// Initialize global wait threads list</span>
02798 
02799         InterlockedExchange (&amp;CompletedWaitInitialization, 1L) ;
02800 
02801     } <span class="keywordflow">else</span> {
02802 
02803         <span class="comment">// Sleep 1 ms and see if the other thread has completed initialization</span>
02804 
02805         <a class="code" href="../../d3/d1/threads_8h.html#a13">ONE_MILLISECOND_TIMEOUT</a>(TimeOut) ;
02806 
02807         <span class="keywordflow">while</span> (!(<span class="keyword">volatile</span> ULONG) <a class="code" href="../../d3/d1/threads_8h.html#a67">CompletedWaitInitialization</a>) {
02808 
02809             <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (FALSE, &amp;TimeOut) ;
02810 
02811         }
02812 
02813         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a67">CompletedWaitInitialization</a> != 1) {
02814             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY ;
02815         }
02816     }
02817 
02818     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02819 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="threads.c::RtlpInitializeWorkerThreadPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpInitializeWorkerThreadPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l01965">1965</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00216">CompletedTimerInitialization</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00210">CompletedWorkerInitialization</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00243">IOWorkerThreads</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00051">NtCreateIoCompletion()</a>, <a class="el" href="../../d8/d5/delay_8c-source.html#l00033">NtDelayExecution()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00285">ONE_MILLISECOND_TIMEOUT</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01210">RtlInitializeCriticalSection()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05256">RtlpInitializeTimerThreadPool()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02104">RtlpWorkerThreadInitializeTimers()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00437">RtlQueueWorkItem()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00209">StartedWorkerInitialization</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00245">WorkerCompletionPort</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00255">WorkerCriticalSection</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00235">WorkerThreadTimerQueueInit</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l00437">RtlQueueWorkItem()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l00600">RtlSetIoCompletionCallback()</a>.
<p>
<pre class="fragment"><div>01969                    :
01970 
01971     This routine initializes all aspects of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01972 
01973 Arguments:
01974 
01975     None
01976 
01977 Return Value:
01978 
01979     None
01980 
01981 --*/
01982 {
01983     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS ;
01984     LARGE_INTEGER TimeOut ;
01985 
01986 
01987     <span class="comment">// Initialize the timer component if it hasnt been done already</span>
01988 
01989     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a69">CompletedTimerInitialization</a> != 1) {
01990 
01991         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a63">RtlpInitializeTimerThreadPool</a> () ;
01992 
01993         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) )
01994             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01995 
01996     }
01997 
01998     
01999     <span class="comment">// In order to avoid an explicit RtlInitialize() function to initialize the thread pool</span>
02000     <span class="comment">// we use StartedInitialization and CompletedInitialization to provide us the necessary</span>
02001     <span class="comment">// synchronization to avoid multiple threads from initializing the thread pool.</span>
02002     <span class="comment">// This scheme does not work if RtlInitializeCriticalSection() fails - but in this case the</span>
02003     <span class="comment">// caller has no choices left.</span>
02004 
02005     <span class="keywordflow">if</span> (!InterlockedExchange(&amp;StartedWorkerInitialization, 1L)) {
02006 
02007         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a65">CompletedWorkerInitialization</a>)
02008             InterlockedExchange( &amp;CompletedWorkerInitialization, 0 ) ;
02009 
02010             
02011         <span class="keywordflow">do</span> {
02012 
02013             <span class="comment">// Initialize Critical Sections</span>
02014 
02015             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>( &amp;WorkerCriticalSection );
02016             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
02017                 <span class="keywordflow">break</span> ;
02018 
02019 
02020             InitializeListHead (&amp;IOWorkerThreads) ;
02021 
02022             {            
02023                 SYSTEM_BASIC_INFORMATION BasicInfo;
02024 
02025                 <span class="comment">// get number of processors</span>
02026 
02027                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a49">NtQuerySystemInformation</a> (
02028                                     SystemBasicInformation,
02029                                     &amp;BasicInfo,
02030                                     <span class="keyword">sizeof</span>(BasicInfo),
02031                                     NULL
02032                                     ) ;
02033 
02034                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
02035                     BasicInfo.NumberOfProcessors = 1 ;
02036                 }
02037 
02038                 <span class="comment">// Create completion port used by worker threads</span>
02039 
02040                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/complete_8c.html#a1">NtCreateIoCompletion</a> (
02041                                     &amp;WorkerCompletionPort,
02042                                     IO_COMPLETION_ALL_ACCESS,
02043                                     NULL,
02044                                     BasicInfo.NumberOfProcessors
02045                                     );
02046 
02047                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
02048                     <span class="keywordflow">break</span> ;
02049 
02050             }
02051 
02052         } <span class="keywordflow">while</span> ( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) ;
02053 
02054         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
02055         
02056             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( Status == STATUS_SUCCESS ) ;
02057             <a class="code" href="../../d3/d1/threads_8h.html#a64">StartedWorkerInitialization</a> = 0 ;
02058             InterlockedExchange( &amp;CompletedWorkerInitialization, ~0 ) ;
02059             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02060         }
02061         
02062         <span class="comment">// Signal that initialization has completed</span>
02063 
02064         InterlockedExchange (&amp;CompletedWorkerInitialization, 1L) ;
02065 
02066     } <span class="keywordflow">else</span> {
02067 
02068         LARGE_INTEGER Timeout ;
02069 
02070         <span class="comment">// Sleep 1 ms and see if the other thread has completed initialization</span>
02071 
02072         <a class="code" href="../../d3/d1/threads_8h.html#a13">ONE_MILLISECOND_TIMEOUT</a>(TimeOut) ;
02073 
02074         <span class="keywordflow">while</span> (!(<span class="keyword">volatile</span> ULONG) <a class="code" href="../../d3/d1/threads_8h.html#a65">CompletedWorkerInitialization</a>) {
02075 
02076             <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (FALSE, &amp;TimeOut) ;
02077         }
02078 
02079         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a65">CompletedWorkerInitialization</a> != 1)
02080             <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
02081         
02082     }
02083 
02084 
02085     <span class="comment">//</span>
02086     <span class="comment">// create timer for worker thread. it should be created outside any worker</span>
02087     <span class="comment">// lock and the above wait loop. It should not make the RtlpInitializeWorkerThread</span>
02088     <span class="comment">// call blocking on a timer thread. so queue a work item.</span>
02089     <span class="comment">//</span>
02090     
02091     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)
02092         &amp;&amp; (InterlockedIncrement(&amp;WorkerThreadTimerQueueInit) == 1) )
02093     {
02094         <a class="code" href="../../d2/d1/threads_8c.html#a8">RtlQueueWorkItem</a>(RtlpWorkerThreadInitializeTimers, NULL, 0);
02095     }
02096     
02097 
02098     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)  ? STATUS_SUCCESS : <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02099 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="threads.c::RtlpInsertInDeltaList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpInsertInDeltaList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>DeltaList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewTimer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TimeRemaining</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewFiringTime</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l04507">4507</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00055">_RTLP_GENERIC_TIMER::DeltaFiringTime</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00054">_RTLP_GENERIC_TIMER::List</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d3/d1/threads_8h.html#a47">PRTLP_GENERIC_TIMER</a>, <a class="el" href="../../d3/d1/threads_8h.html#a46">RTLP_GENERIC_TIMER</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l03954">RtlpAddTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03302">RtlpAddWait()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05010">RtlpFireTimersAndReorder()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05146">RtlpInsertTimersIntoDeltaList()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l04711">RtlpReOrderDeltaList()</a>.
<p>
<pre class="fragment"><div>04515                    :
04516 
04517     Inserts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer element in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate place in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delta list.
04518 
04519 Arguments:
04520 
04521     DeltaList - Delta list to insert into
04522 
04523     NewTimer - Timer element to insert into list
04524 
04525     TimeRemaining - This time must be added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> head of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list to get <span class="stringliteral">"real"</span>
04526                     relative time.
04527 
04528     NewFiringTime - If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> element was inserted at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> head of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list - <span class="keyword">this</span>
04529                     will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> firing time in milliseconds. The caller
04530                     can use <span class="keyword">this</span> time to re-program <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT timer. This MUST NOT be
04531                     changed <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function returns <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
04532 
04533 Return Value:
04534 
04535     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer was inserted at head of delta list
04536 
04537     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - otherwise
04538 
04539 --*/
04540 {
04541     PLIST_ENTRY Node ;
04542     <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a> Temp ;
04543     <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a> Head ;
04544 
04545     <span class="keywordflow">if</span> (IsListEmpty (DeltaList)) {
04546 
04547         InsertHeadList (DeltaList, &amp;NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o0">List</a>) ;
04548 
04549         *NewFiringTime = NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> ;
04550         
04551         NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> = 0 ;
04552 
04553         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
04554 
04555     }
04556 
04557     <span class="comment">// Adjust the head of the list to reflect the time remaining on the NT timer</span>
04558 
04559     Head = CONTAINING_RECORD (DeltaList-&gt;Flink, <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">RTLP_GENERIC_TIMER</a>, List) ;
04560 
04561     Head-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> += TimeRemaining ;
04562 
04563 
04564     <span class="comment">// Find the appropriate location to insert this element in</span>
04565 
04566     <span class="keywordflow">for</span> (Node = DeltaList-&gt;Flink ; Node != DeltaList ; Node = Node-&gt;Flink) {
04567 
04568         Temp = CONTAINING_RECORD (Node, <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">RTLP_GENERIC_TIMER</a>, List) ;
04569 
04570 
04571         <span class="keywordflow">if</span> (Temp-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> &lt;= NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a>) {
04572 
04573             NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> -= Temp-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> ;
04574 
04575         } <span class="keywordflow">else</span> {
04576 
04577             <span class="comment">// found appropriate place to insert this timer</span>
04578 
04579             <span class="keywordflow">break</span> ;
04580 
04581         }
04582 
04583     }
04584 
04585     <span class="comment">// Either we have found the appopriate node to insert before in terms of deltas.</span>
04586     <span class="comment">// OR we have come to the end of the list. Insert this timer here.</span>
04587 
04588     InsertHeadList (Node-&gt;Blink, &amp;NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o0">List</a>) ;
04589 
04590 
04591     <span class="comment">// If this isnt the last element in the list - adjust the delta of the</span>
04592     <span class="comment">// next element</span>
04593 
04594     <span class="keywordflow">if</span> (Node != DeltaList) {
04595 
04596         Temp-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> -= NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> ;
04597 
04598     }
04599 
04600 
04601     <span class="comment">// Check if element was inserted at head of list</span>
04602 
04603     <span class="keywordflow">if</span> (DeltaList-&gt;Flink == &amp;NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o0">List</a>) {
04604 
04605         <span class="comment">// Set NewFiringTime to the time in milliseconds when the new head of list</span>
04606         <span class="comment">// should be serviced.</span>
04607 
04608         *NewFiringTime = NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> ;
04609 
04610         <span class="comment">// This means the timer must be programmed to service this request</span>
04611 
04612         NewTimer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> = 0 ;
04613 
04614         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
04615 
04616     } <span class="keywordflow">else</span> {
04617 
04618         <span class="comment">// No change to the head of the list, set the delta time back</span>
04619 
04620         Head-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> -= TimeRemaining ;
04621 
04622         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
04623 
04624     }
04625 
04626 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="threads.c::RtlpInsertTimersIntoDeltaList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpInsertTimersIntoDeltaList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>NewTimerList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>DeltaTimerList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TimeRemaining</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewFiringTime</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l05146">5146</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l04507">RtlpInsertInDeltaList()</a>.
<p>
<pre class="fragment"><div>05154                    :
05155 
05156     This routine walks thru a list of timers in NewTimerList and inserts them into a delta
05157     timers list pointed to by DeltaTimerList. The timeout associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first element
05158     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned in NewFiringTime.
05159 
05160 Arguments:
05161 
05162     NewTimerList - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> of timers that need to be inserted into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeltaTimerList
05163 
05164     DeltaTimerList - Existing delta list of zero or more timers.
05165 
05166     TimeRemaining - Firing time of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first element in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeltaTimerList
05167 
05168     NewFiringTime - Location where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> firing time will be returned
05169 
05170 Return Value:
05171 
05172 
05173 --*/
05174 {
05175     <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a> Timer ;
05176     PLIST_ENTRY TNode ;
05177     PLIST_ENTRY Temp ;
05178 
05179     <span class="keywordflow">for</span> (TNode = NewTimerList-&gt;Flink ; TNode != NewTimerList ; TNode = TNode-&gt;Flink) {
05180 
05181         Temp = TNode-&gt;Blink ;
05182 
05183         RemoveEntryList (Temp-&gt;Flink) ;
05184 
05185         Timer = CONTAINING_RECORD (TNode, <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">RTLP_GENERIC_TIMER</a>, List) ;
05186 
05187         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a127">RtlpInsertInDeltaList</a> (DeltaTimerList, Timer, TimeRemaining, NewFiringTime)) {
05188 
05189             TimeRemaining = *NewFiringTime ;
05190 
05191         }
05192 
05193         TNode = Temp ;
05194 
05195     }
05196 
05197 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="threads.c::RtlpIOWorkerThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG RtlpIOWorkerThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Initialized</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l02370">2370</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00167">_RTLP_IOWORKER_TCB::Flags</a>, <a class="el" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>, <a class="el" href="../../d2/d1/threads_8c.html#a2">IOWORKER_IDLE_TIMEOUT</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00243">IOWorkerThreads</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00165">_RTLP_IOWORKER_TCB::List</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00168">_RTLP_IOWORKER_TCB::LongFunctionFlag</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00275">NEW_THREAD_THRESHOLD</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d5/delay_8c-source.html#l00033">NtDelayExecution()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l02706">NtQueryInformationThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00224">NumIOWorkerThreads</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00227">NumIOWorkRequests</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00228">NumLongIOWorkRequests</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00263">RtlpExitThreadFunc</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00166">_RTLP_IOWORKER_TCB::ThreadHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00255">WorkerCriticalSection</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l01820">RtlpStartIOWorkerThread()</a>.
<p>
<pre class="fragment"><div>02375                    :
02376 
02377     All I/O worker threads execute in <span class="keyword">this</span> routine. All <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work requests execute as APCs
02378     in <span class="keyword">this</span> thread.
02379 
02380 Arguments:
02381 
02382     <a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a> - set to 1 when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initialization has completed
02383 
02384 Return Value:
02385 
02386 --*/
02387 {
02388 <span class="preprocessor">    #define IOWORKER_IDLE_TIMEOUT     40000    // In Milliseconds</span>
02389 <span class="preprocessor"></span>    
02390     LARGE_INTEGER TimeOut ;
02391     ULONG SleepTime = <a class="code" href="../../d2/d1/threads_8c.html#a2">IOWORKER_IDLE_TIMEOUT</a> ;
02392     <a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html">RTLP_IOWORKER_TCB</a> ThreadCB ;    <span class="comment">// Control Block allocated on the stack</span>
02393     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02394     BOOLEAN Terminate ;
02395 
02396     
02397     <span class="comment">//</span>
02398     <span class="comment">// Initialize thread control block</span>
02399     <span class="comment">// and insert it into list of IOWorker Threads</span>
02400     <span class="comment">//</span>
02401     
02402     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(
02403                 NtCurrentProcess(),
02404                 NtCurrentThread(),
02405                 NtCurrentProcess(),
02406                 &amp;ThreadCB.<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o1">ThreadHandle</a>,
02407                 0,
02408                 FALSE,
02409                 DUPLICATE_SAME_ACCESS
02410                 ) ;
02411 
02412     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02413         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE) ;
02414         InterlockedExchange ((ULONG *)Initialized, (ULONG)~0) ;
02415         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02416     }
02417 
02418     InsertHeadList (&amp;IOWorkerThreads, &amp;ThreadCB.<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o0">List</a>) ;
02419     ThreadCB.<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o2">Flags</a> = 0 ;
02420     ThreadCB.<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o3">LongFunctionFlag</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02421 
02422     InterlockedIncrement(&amp;NumIOWorkerThreads) ;
02423 
02424     
02425     <span class="comment">// We are all initialized now. Notify the starter to queue the task.</span>
02426 
02427     InterlockedExchange ((ULONG *)Initialized, 1L) ;
02428 
02429 
02430 
02431     <span class="comment">// Sleep alertably so that all the activity can take place</span>
02432     <span class="comment">// in APCs</span>
02433 
02434     <span class="keywordflow">for</span> ( ; ; ) {
02435 
02436         <span class="comment">// Set timeout for IdleTimeout</span>
02437 
02438         TimeOut.QuadPart = Int32x32To64( SleepTime, -10000 ) ;
02439 
02440 
02441         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (TRUE, &amp;TimeOut) ;
02442 
02443 
02444         <span class="comment">// Status is STATUS_SUCCESS only when it has timed out</span>
02445         
02446         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
02447             <span class="keywordflow">continue</span> ;
02448         } 
02449 
02450 
02451         <span class="comment">//</span>
02452         <span class="comment">// idle timeout. check if you can terminate the thread</span>
02453         <span class="comment">//</span>
02454         
02455         Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02456 
02457         RtlEnterCriticalSection (&amp;WorkerCriticalSection) ;
02458 
02459 
02460         <span class="comment">// dont terminate if it is a persistent thread</span>
02461         
02462         <span class="keywordflow">if</span> (ThreadCB.<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o2">Flags</a> &amp; WT_EXECUTEINPERSISTENTIOTHREAD) {
02463 
02464             TimeOut.LowPart = 0x0;
02465             TimeOut.HighPart = 0x80000000;
02466 
02467             RtlLeaveCriticalSection (&amp;WorkerCriticalSection) ;
02468 
02469             <span class="keywordflow">continue</span> ;
02470         }
02471 
02472         
02473         <span class="comment">// The thread terminates if there are &gt; 1 threads and the queue is small</span>
02474         <span class="comment">// OR if there is only 1 thread and there is no request pending</span>
02475 
02476         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a74">NumIOWorkerThreads</a> &gt;  1) {
02477 
02478 
02479             ULONG NumEffIOWorkerThreads = <a class="code" href="../../d3/d1/threads_8h.html#a74">NumIOWorkerThreads</a> - <a class="code" href="../../d3/d1/threads_8h.html#a78">NumLongIOWorkRequests</a> ;
02480             ULONG Threshold ;
02481 
02482             <span class="keywordflow">if</span> (NumEffIOWorkerThreads == 0) {
02483 
02484                 Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02485 
02486             } <span class="keywordflow">else</span> {
02487             
02488                 <span class="comment">// Check if we need to shrink worker thread pool</span>
02489 
02490                 Threshold = <a class="code" href="../../d3/d1/threads_8h.html#a8">NEW_THREAD_THRESHOLD</a> * (NumEffIOWorkerThreads-1);
02491 
02492 
02493 
02494                 <span class="keywordflow">if</span>  (<a class="code" href="../../d3/d1/threads_8h.html#a77">NumIOWorkRequests</a>-<a class="code" href="../../d3/d1/threads_8h.html#a78">NumLongIOWorkRequests</a> &lt; Threshold)  {
02495 
02496                     Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02497 
02498                 } <span class="keywordflow">else</span> {
02499 
02500                     Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02501                     SleepTime &lt;&lt;= 1 ;
02502                 }
02503             }
02504 
02505         } <span class="keywordflow">else</span> {
02506 
02507             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a77">NumIOWorkRequests</a> == 0) {
02508 
02509                 <span class="comment">// delay termination of last thread</span>
02510 
02511                 <span class="keywordflow">if</span> (SleepTime &lt; 4*<a class="code" href="../../d2/d1/threads_8c.html#a2">IOWORKER_IDLE_TIMEOUT</a>) {
02512                 
02513                     SleepTime &lt;&lt;= 1 ;
02514                     Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02515 
02516                 } <span class="keywordflow">else</span> {
02517                 
02518                     Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02519                 }
02520 
02521             } <span class="keywordflow">else</span> {
02522 
02523                 Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02524 
02525             }
02526 
02527         }
02528 
02529         <span class="comment">//</span>
02530         <span class="comment">// terminate only if no io is pending</span>
02531         <span class="comment">//</span>
02532         
02533         <span class="keywordflow">if</span> (Terminate) {
02534 
02535             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02536             THREAD_BASIC_INFORMATION ThreadInfo;
02537             ULONG IsIoPending ;
02538             
02539             Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02540             
02541             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a20">NtQueryInformationThread</a>( ThreadCB.<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o1">ThreadHandle</a>,
02542                                                ThreadIsIoPending,
02543                                                &amp;IsIoPending,
02544                                                <span class="keyword">sizeof</span>( IsIoPending ),
02545                                                NULL
02546                                              );
02547             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
02548 
02549                 <span class="keywordflow">if</span> (! IsIoPending )
02550                     Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02551             }
02552         }
02553 
02554         <span class="keywordflow">if</span> (Terminate) {
02555 
02556             InterlockedDecrement (&amp;NumIOWorkerThreads) ;
02557 
02558             RemoveEntryList (&amp;ThreadCB.<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o0">List</a>) ;
02559             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( ThreadCB.<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o1">ThreadHandle</a> ) ;
02560             
02561             RtlLeaveCriticalSection (&amp;WorkerCriticalSection) ;
02562 
02563             <a class="code" href="../../d3/d1/threads_8h.html#a104">RtlpExitThreadFunc</a>( 0 );
02564 
02565         } <span class="keywordflow">else</span> {
02566 
02567             <span class="comment">// This is the condition where a request was queued *after* the</span>
02568             <span class="comment">// thread woke up - ready to terminate because of inactivity. In</span>
02569             <span class="comment">// this case dont terminate - service the completion port.</span>
02570 
02571             RtlLeaveCriticalSection (&amp;WorkerCriticalSection) ;
02572 
02573         }
02574     }
02575 
02576     <span class="keywordflow">return</span> 0 ;  <span class="comment">// Keep compiler happy</span>
02577 
02578 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="threads.c::RtlpProcessTimeouts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpProcessTimeouts           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ThreadCB</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l03697">3697</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00152">_RTLP_WAIT_THREAD_CONTROL_BLOCK::Current64BitTickCount</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00153">_RTLP_WAIT_THREAD_CONTROL_BLOCK::Firing64BitTickCount</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03747">RtlpFireTimers()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05010">RtlpFireTimersAndReorder()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03644">RtlpGet64BitTickCount()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04378">RtlpGetTimeRemaining()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04429">RtlpResetTimer()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00146">_RTLP_WAIT_THREAD_CONTROL_BLOCK::TimerHandle</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00147">_RTLP_WAIT_THREAD_CONTROL_BLOCK::TimerQueue</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l02824">RtlpWaitThread()</a>.
<p>
<pre class="fragment"><div>03702                    :
03703 
03704     This routine processes timeouts <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait thread
03705 
03706 Arguments:
03707 
03708     ThreadCB - The wait thread to add <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait to
03709 
03710 Return Value:
03711 
03712 --*/
03713 {
03714     ULONG NewFiringTime, TimeRemaining ;
03715     LIST_ENTRY TimersToFireList ;
03716 
03717     <span class="comment">//</span>
03718     <span class="comment">// check if incorrect timer fired</span>
03719     <span class="comment">//</span>
03720     <span class="keywordflow">if</span> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o12">Firing64BitTickCount</a> &gt;
03721             <a class="code" href="../../d2/d1/threads_8c.html#a41">RtlpGet64BitTickCount</a>(&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o11">Current64BitTickCount</a>) + 200 )
03722     {
03723         <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>, 
03724                     <a class="code" href="../../d2/d1/threads_8c.html#a53">RtlpGetTimeRemaining</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>),
03725                     ThreadCB) ;
03726 
03727         <span class="keywordflow">return</span> ;
03728     }
03729  
03730     InitializeListHead( &amp;TimersToFireList ) ;
03731 
03732     
03733     <span class="comment">// Walk thru the timer list and fire all waits with DeltaFiringTime == 0</span>
03734 
03735     <a class="code" href="../../d3/d1/threads_8h.html#a124">RtlpFireTimersAndReorder</a> (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o8">TimerQueue</a>, &amp;NewFiringTime, &amp;TimersToFireList) ;
03736 
03737     <span class="comment">// Reset the NT timer</span>
03738 
03739     <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>, NewFiringTime, ThreadCB) ;
03740 
03741 
03742     <a class="code" href="../../d3/d1/threads_8h.html#a125">RtlpFireTimers</a>( &amp;TimersToFireList ) ;    
03743 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="threads.c::RtlpProcessWaitCompletion" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpProcessWaitCompletion           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ArrayIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l03172">3172</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00144">_RTLP_WAIT_THREAD_CONTROL_BLOCK::ActiveWaitArray</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00145">_RTLP_WAIT_THREAD_CONTROL_BLOCK::ActiveWaitPointers</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00122">_RTLP_WAIT::Context</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00354">DBG_SET_FUNCTION</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00410">DPRN4</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00120">_RTLP_WAIT::Flags</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00121">_RTLP_WAIT::Function</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00143">_RTLP_WAIT_THREAD_CONTROL_BLOCK::NumActiveWaits</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00087">_RTLP_GENERIC_TIMER::Period</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00117">_RTLP_WAIT::RefCount</a>, <a class="el" href="../../d3/d1/threads_8h.html#a56">RTLP_ASYNC_CALLBACK</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03082">RtlpAsyncCallbackCompletion()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03483">RtlpDeactivateWait()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03573">RtlpDeleteWait()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05847">RtlpForceAllocateTPHeap()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00302">RtlpFreeTPHeap</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04378">RtlpGetTimeRemaining()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04711">RtlpReOrderDeltaList()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04429">RtlpResetTimer()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00372">RtlpShiftWaitArray</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00437">RtlQueueWorkItem()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00114">_RTLP_WAIT::ThreadCB</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00119">_RTLP_WAIT::Timer</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00177">_RTLP_WAITWORKER::TimerCondition</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00146">_RTLP_WAIT_THREAD_CONTROL_BLOCK::TimerHandle</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00147">_RTLP_WAIT_THREAD_CONTROL_BLOCK::TimerQueue</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00173">_RTLP_WAITWORKER::Wait</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00176">_RTLP_WAITWORKER::WaitThreadCallback</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l02824">RtlpWaitThread()</a>.
<p>
<pre class="fragment"><div>03178                    :
03179 
03180     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> processing a completed wait
03181 
03182 Arguments:
03183 
03184     Wait - Wait that completed
03185 
03186 Return Value:
03187 
03188 --*/
03189 {
03190     ULONG TimeRemaining ;
03191     ULONG NewFiringTime ;
03192     LARGE_INTEGER DueTime ;
03193     <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCB ;
03194     <a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html">PRTLP_ASYNC_CALLBACK</a> AsyncCallback ;
03195 
03196     ThreadCB = Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o0">ThreadCB</a> ;
03197 
03198     <span class="comment">// deactivate wait if it is meant for single execution</span>
03199     
03200     <span class="keywordflow">if</span> ( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o6">Flags</a> &amp; WT_EXECUTEONLYONCE ) {
03201 
03202         <a class="code" href="../../d3/d1/threads_8h.html#a132">RtlpDeactivateWait</a> (Wait) ;
03203     } 
03204 
03205     <span class="keywordflow">else</span> {
03206         <span class="comment">// if wait being reactivated, then reset the timer now itself as</span>
03207         <span class="comment">// it can be deleted in the callback function</span>
03208 
03209         <span class="keywordflow">if</span>  ( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a> ) {
03210 
03211             TimeRemaining = <a class="code" href="../../d3/d1/threads_8h.html#a136">RtlpGetTimeRemaining</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>) ;
03212 
03213             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a129">RtlpReOrderDeltaList</a> (
03214                         &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o8">TimerQueue</a>.TimerList,
03215                         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>,
03216                         TimeRemaining,
03217                         &amp;NewFiringTime,
03218                         Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o5">Timer</a>-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o13">Period</a>)) {
03219 
03220                 <span class="comment">// There is a new element at the head of the queue we need to reset the NT</span>
03221                 <span class="comment">// timer to fire later</span>
03222 
03223                 <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>, NewFiringTime, ThreadCB) ;
03224             }
03225 
03226         }
03227 
03228         <span class="comment">// move the wait entry to the end, and shift elements to its right one pos towards left</span>
03229         {
03230             HANDLE HandlePtr = ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o5">ActiveWaitArray</a>[ArrayIndex];
03231             <a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> WaitPtr = ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o6">ActiveWaitPointers</a>[ArrayIndex];
03232 
03233             <a class="code" href="../../d3/d1/threads_8h.html#a25">RtlpShiftWaitArray</a>(ThreadCB, ArrayIndex+1, ArrayIndex,
03234                             ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a> -1 - ArrayIndex)
03235             ThreadCB-&gt;ActiveWaitArray[ThreadCB-&gt;NumActiveWaits-1] = HandlePtr ;
03236             ThreadCB-&gt;ActiveWaitPointers[ThreadCB-&gt;NumActiveWaits-1] = WaitPtr ;
03237         }
03238     }
03239     
03240     <span class="comment">// call callback function (FALSE since this isnt a timeout related callback)</span>
03241 
03242     if ( Wait-&gt;Flags &amp; WT_EXECUTEINWAITTHREAD ) {
03243     
03244         <span class="comment">// executing callback after RtlpDeactivateWait allows the Callback to call</span>
03245         <span class="comment">// RtlDeregisterWait Wait-&gt;RefCount is not incremented so that RtlDeregisterWait </span>
03246         <span class="comment">// will work on this Wait. Though Wait-&gt;RefCount is not incremented, others cannot</span>
03247         <span class="comment">// deregister this Wait as it has to be queued as an APC.</span>
03248 
03249         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a38">DPRN4</a>)
03250         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Calling WaitOrTimer(wait): fn:%x  context:%x  bool:%d Thread&lt;%d:%d&gt;\n"</span>,
03251                 (ULONG_PTR)Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o7">Function</a>, (ULONG_PTR)Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o8">Context</a>,
03252                 FALSE,
03253                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
03254                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)
03255                 ) ;
03256                 
03257 <span class="preprocessor">        #if (DBG1)</span>
03258 <span class="preprocessor"></span>        <a class="code" href="../../d3/d1/threads_8h.html#a24">DBG_SET_FUNCTION</a>( Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o7">Function</a>, Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o8">Context</a> ) ;
03259 <span class="preprocessor">        #endif</span>
03260 <span class="preprocessor"></span>        
03261         
03262         ((WAITORTIMERCALLBACKFUNC)(Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o7">Function</a>))(Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o8">Context</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ;
03263 
03264 
03265         <span class="comment">// Wait object could have been deleted in the above callback</span>
03266         
03267         <span class="keywordflow">return</span> ;
03268 
03269         
03270     } <span class="keywordflow">else</span> {
03271 
03272         AsyncCallback = <a class="code" href="../../d3/d1/threads_8h.html#a166">RtlpForceAllocateTPHeap</a>( <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html">RTLP_ASYNC_CALLBACK</a> ), 0 );
03273         
03274         <span class="keywordflow">if</span> ( AsyncCallback ) {
03275 
03276             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03277             
03278             AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o0">Wait</a> = Wait ;
03279             AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o2">WaitThreadCallback</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
03280             AsyncCallback-&gt;<a class="code" href="../../d4/d7/struct__RTLP__WAITWORKER.html#o3">TimerCondition</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
03281 
03282             InterlockedIncrement( &amp;Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o3">RefCount</a> ) ;
03283 
03284             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a8">RtlQueueWorkItem</a>( RtlpAsyncCallbackCompletion, AsyncCallback,
03285                                 Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o6">Flags</a> );
03286 
03287 
03288             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03289 
03290                 <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( AsyncCallback );
03291 
03292                 <span class="keywordflow">if</span> ( InterlockedDecrement( &amp;Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o3">RefCount</a> ) == 0 ) {
03293                     <a class="code" href="../../d3/d1/threads_8h.html#a133">RtlpDeleteWait</a>( Wait ) ;
03294                 }
03295             }
03296         }
03297     }
03298 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="threads.c::RtlpQueueIOWorkerRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpQueueIOWorkerRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">WORKERCALLBACKFUNC&nbsp;</td>
          <td class="mdname" nowrap> <em>Function</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l01638">1638</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00167">_RTLP_IOWORKER_TCB::Flags</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00243">IOWorkerThreads</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00165">_RTLP_IOWORKER_TCB::List</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00168">_RTLP_IOWORKER_TCB::LongFunctionFlag</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00056">NtQueueApcThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00224">NumIOWorkerThreads</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00227">NumIOWorkRequests</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00228">NumLongIOWorkRequests</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00244">PersistentIOTCB</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02632">RtlpExecuteIOWorkItem()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00166">_RTLP_IOWORKER_TCB::ThreadHandle</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l00437">RtlQueueWorkItem()</a>.
<p>
<pre class="fragment"><div>01646                    :
01647 
01648     This routine queues up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request to be executed in an IO worker thread.
01649 
01650 Arguments:
01651 
01652     Function - Routine that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> worker thread
01653 
01654     Context - Opaque pointer passed in as an argument to WorkerProc
01655 
01656 Return Value:
01657 
01658 --*/
01659 
01660 {
01661     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01662     <a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html">PRTLP_IOWORKER_TCB</a> TCB ;
01663     BOOLEAN LongFunction = (Flags &amp; WT_EXECUTELONGFUNCTION) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
01664     PLIST_ENTRY  ple ;
01665     
01666                 
01667     <span class="keywordflow">if</span> (Flags &amp; WT_EXECUTEINPERSISTENTIOTHREAD) {
01668 
01669         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d1/threads_8h.html#a90">PersistentIOTCB</a>) {
01670             <span class="keywordflow">for</span> (ple=<a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>.Flink;  ple!=&amp;<a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>;  ple=ple-&gt;Flink) {
01671                 TCB = CONTAINING_RECORD (ple, <a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html">RTLP_IOWORKER_TCB</a>, List) ;
01672                 <span class="keywordflow">if</span> (! TCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o3">LongFunctionFlag</a>)
01673                     <span class="keywordflow">break</span>;
01674             }
01675 
01676             <span class="keywordflow">if</span> (ple == &amp;<a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>) {
01677                 <span class="comment">// ASSERT(FALSE);</span>
01678                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01679             }
01680 
01681             
01682             <a class="code" href="../../d3/d1/threads_8h.html#a90">PersistentIOTCB</a> = TCB ;
01683             TCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o2">Flags</a> |= WT_EXECUTEINPERSISTENTIOTHREAD ;
01684             
01685         } <span class="keywordflow">else</span> {
01686             TCB = <a class="code" href="../../d3/d1/threads_8h.html#a90">PersistentIOTCB</a> ;
01687         }
01688 
01689     } <span class="keywordflow">else</span> {
01690         <span class="keywordflow">for</span> (ple=<a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>.Flink;  ple!=&amp;<a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>;  ple=ple-&gt;Flink) {
01691         
01692             TCB = CONTAINING_RECORD (ple, <a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html">RTLP_IOWORKER_TCB</a>, List) ;
01693 
01694             <span class="comment">// do not queue to the thread if it is executing a long function, or</span>
01695             <span class="comment">// if you are queueing a long function and the thread is a persistent thread</span>
01696             
01697             <span class="keywordflow">if</span> (! TCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o3">LongFunctionFlag</a>
01698                 &amp;&amp; (! ((TCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o2">Flags</a>&amp;WT_EXECUTEINPERSISTENTIOTHREAD)
01699                         &amp;&amp; (Flags&amp;WT_EXECUTELONGFUNCTION)))) {
01700                 <span class="keywordflow">break</span> ;
01701             }            
01702 
01703         }
01704 
01705         <span class="keywordflow">if</span> ((ple == &amp;<a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>) &amp;&amp; (<a class="code" href="../../d3/d1/threads_8h.html#a74">NumIOWorkerThreads</a>&lt;1)) {
01706 
01707 <span class="preprocessor">            #if DBG</span>
01708 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ThreadPool:ntdll.dll: Out of memory. "</span>
01709                      <span class="stringliteral">"Could not execute IOWorkItem(%x)\n"</span>, (ULONG_PTR)Function);
01710 <span class="preprocessor">            #endif</span>
01711 <span class="preprocessor"></span>                     
01712             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01713         }
01714         <span class="keywordflow">else</span> {
01715             ple = <a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>.Flink;
01716             TCB = CONTAINING_RECORD (ple, <a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html">RTLP_IOWORKER_TCB</a>, List) ;
01717 
01718             <span class="comment">// treat it as a short function so that counters work fine.</span>
01719             
01720             LongFunction = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;            
01721         }
01722 
01723         <span class="comment">// In order to implement "fair" assignment of work items between IO worker threads</span>
01724         <span class="comment">// each time remove the entry and reinsert at back.</span>
01725 
01726         RemoveEntryList (&amp;TCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o0">List</a>) ;
01727         InsertTailList (&amp;IOWorkerThreads, &amp;TCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o0">List</a>) ;
01728     }
01729 
01730              
01731     <span class="comment">// Increment the outstanding work request counter</span>
01732 
01733     InterlockedIncrement (&amp;NumIOWorkRequests) ;
01734     <span class="keywordflow">if</span> (LongFunction) {
01735         InterlockedIncrement( &amp;NumLongIOWorkRequests ) ;
01736         TCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o3">LongFunctionFlag</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
01737     }
01738 
01739     <span class="comment">// Queue an APC to the IoWorker Thread</span>
01740 
01741     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
01742                     TCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o1">ThreadHandle</a>,
01743                     LongFunction? (PPS_APC_ROUTINE)RtlpExecuteLongIOWorkItem:
01744                                   (PPS_APC_ROUTINE)RtlpExecuteIOWorkItem,
01745                     (PVOID)Function,
01746                     Context,
01747                     TCB
01748                     );
01749 
01750     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) ) {
01751         InterlockedDecrement( &amp;NumIOWorkRequests ) ;
01752         <span class="keywordflow">if</span> (LongFunction)
01753             InterlockedDecrement( &amp;NumLongIOWorkRequests ) ;
01754     }
01755     
01756     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01757 
01758 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="threads.c::RtlpQueueWorkerRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpQueueWorkerRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">WORKERCALLBACKFUNC&nbsp;</td>
          <td class="mdname" nowrap> <em>Function</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l01506">1506</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00187">_RTLP_WORK::Flags</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00186">_RTLP_WORK::Function</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00056">NtQueueApcThread()</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00417">NtSetIoCompletion()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00230">NumLongWorkRequests</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00229">NumWorkRequests</a>, <a class="el" href="../../d3/d1/threads_8h.html#a59">PRTLP_WORK</a>, <a class="el" href="../../d3/d1/threads_8h.html#a58">RTLP_WORK</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01589">RtlpExecuteWorkerRequest()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05847">RtlpForceAllocateTPHeap()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00302">RtlpFreeTPHeap</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00221">TimerThreadHandle</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00245">WorkerCompletionPort</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l00437">RtlQueueWorkItem()</a>.
<p>
<pre class="fragment"><div>01513                    :
01514 
01515     This routine queues up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request to be executed in a worker thread.
01516 
01517 Arguments:
01518 
01519     Function - Routine that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> worker thread
01520 
01521     Context - Opaque pointer passed in as an argument to WorkerProc
01522 
01523     Flags - flags passed to <a class="code" href="../../d2/d1/threads_8c.html#a8">RtlQueueWorkItem</a>
01524 
01525 Return Value:
01526 
01527 --*/
01528 
01529 {
01530     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01531     <a class="code" href="../../d6/d7/struct__RTLP__WORK.html">PRTLP_WORK</a> WorkEntry ;
01532     
01533     <span class="comment">// Increment the outstanding work request counter</span>
01534 
01535     InterlockedIncrement (&amp;NumWorkRequests) ;
01536     <span class="keywordflow">if</span> (Flags &amp; WT_EXECUTELONGFUNCTION) {
01537         InterlockedIncrement( &amp; NumLongWorkRequests ) ;
01538     }
01539 
01540     WorkEntry = (<a class="code" href="../../d6/d7/struct__RTLP__WORK.html">PRTLP_WORK</a>) <a class="code" href="../../d3/d1/threads_8h.html#a166">RtlpForceAllocateTPHeap</a> ( <span class="keyword">sizeof</span> (<a class="code" href="../../d6/d7/struct__RTLP__WORK.html">RTLP_WORK</a>),
01541                                                         HEAP_ZERO_MEMORY) ;
01542     WorkEntry-&gt;<a class="code" href="../../d6/d7/struct__RTLP__WORK.html#o0">Function</a> = Function ;
01543     WorkEntry-&gt;<a class="code" href="../../d6/d7/struct__RTLP__WORK.html#o1">Flags</a> = Flags ;
01544 
01545     <span class="keywordflow">if</span> (Flags &amp; WT_EXECUTEINPERSISTENTTHREAD) {
01546 
01547         <span class="comment">// Queue APC to timer thread</span>
01548 
01549         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
01550                         TimerThreadHandle,
01551                         (PPS_APC_ROUTINE)RtlpExecuteWorkerRequest,
01552                         (PVOID) STATUS_SUCCESS,
01553                         (PVOID) Context,
01554                         (PVOID) WorkEntry
01555                         ) ;
01556 
01557     } <span class="keywordflow">else</span> {
01558     
01559         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/complete_8c.html#a4">NtSetIoCompletion</a> (
01560                     WorkerCompletionPort,
01561                     RtlpExecuteWorkerRequest,
01562                     (PVOID) WorkEntry,
01563                     STATUS_SUCCESS,
01564                     (ULONG_PTR)Context
01565                     );
01566     }
01567     
01568     <span class="keywordflow">if</span> ( ! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01569     
01570         InterlockedDecrement (&amp;NumWorkRequests) ;
01571         <span class="keywordflow">if</span> (Flags &amp;&amp; WT_EXECUTELONGFUNCTION) {
01572             InterlockedDecrement( &amp;NumLongWorkRequests ) ;
01573         }
01574 
01575         <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( WorkEntry ) ;
01576 
01577         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE) ;
01578 
01579 <span class="preprocessor">        #if DBG</span>
01580 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ERROR!! Thread Pool (RtlQeueuWorkItem): could not queue work item\n"</span>);
01581 <span class="preprocessor">        #endif</span>
01582 <span class="preprocessor"></span>    }
01583 
01584     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01585 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="threads.c::RtlpRemoveFromDeltaList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpRemoveFromDeltaList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>DeltaList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Timer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TimeRemaining</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewFiringTime</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l04631">4631</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00055">_RTLP_GENERIC_TIMER::DeltaFiringTime</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00277">INFINITE_TIME</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00054">_RTLP_GENERIC_TIMER::List</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l04202">RtlpDeactivateTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03483">RtlpDeactivateWait()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05354">RtlpDeleteTimerQueue()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l04711">RtlpReOrderDeltaList()</a>.
<p>
<pre class="fragment"><div>04639                    :
04640 
04641     Removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified timer from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delta list
04642 
04643 Arguments:
04644 
04645     DeltaList - Delta list to insert into
04646 
04647     Timer - Timer element to insert into list
04648 
04649     <a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a> - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT Timer object
04650 
04651     TimeRemaining - This time must be added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> head of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list to get <span class="stringliteral">"real"</span>
04652                     relative time.
04653 
04654 Return Value:
04655 
04656     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer was removed from head of timer list
04657     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
04658 
04659 --*/
04660 {
04661     PLIST_ENTRY Next ;
04662     <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a> Temp ;
04663 
04664     Next = Timer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o0">List</a>.Flink ;
04665 
04666     RemoveEntryList (&amp;Timer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o0">List</a>) ;
04667 
04668     <span class="keywordflow">if</span> (IsListEmpty (DeltaList)) {
04669 
04670         *NewFiringTime = <a class="code" href="../../d3/d1/threads_8h.html#a10">INFINITE_TIME</a> ;
04671 
04672         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
04673 
04674     }
04675 
04676     <span class="keywordflow">if</span> (Next == DeltaList)  {
04677 
04678         <span class="comment">// If we removed the last element in the list nothing to do either</span>
04679 
04680         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
04681 
04682     } <span class="keywordflow">else</span> {
04683 
04684         Temp = CONTAINING_RECORD ( Next, <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">RTLP_GENERIC_TIMER</a>, List) ;
04685 
04686         Temp-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> += Timer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> ;
04687         
04688         <span class="comment">// Check if element was removed from head of list</span>
04689 
04690         <span class="keywordflow">if</span> (DeltaList-&gt;Flink == Next) {
04691 
04692             *NewFiringTime = Temp-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> + TimeRemaining ;
04693 
04694             Temp-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> = 0 ;
04695 
04696             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
04697 
04698         } <span class="keywordflow">else</span> {
04699 
04700             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
04701 
04702         }
04703 
04704     }
04705 
04706 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="threads.c::RtlpReOrderDeltaList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpReOrderDeltaList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>DeltaList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Timer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TimeRemaining</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>NewFiringTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ChangedFiringTime</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l04711">4711</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00055">_RTLP_GENERIC_TIMER::DeltaFiringTime</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04507">RtlpInsertInDeltaList()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04631">RtlpRemoveFromDeltaList()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l03954">RtlpAddTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04202">RtlpDeactivateTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03172">RtlpProcessWaitCompletion()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l04044">RtlpUpdateTimer()</a>.
<p>
<pre class="fragment"><div>04720                    :
04721 
04722     Called when a timer in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delta list needs to be re-inserted because <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> firing time
04723     has changed.
04724 
04725 Arguments:
04726 
04727     DeltaList - <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> in which to re-insert
04728 
04729     Timer - Timer <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> firing time has changed
04730 
04731     TimeRemaining - <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> head of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delta list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> fired
04732 
04733     NewFiringTime - If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> element was inserted at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> head of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list - <span class="keyword">this</span>
04734                     will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> firing time in milliseconds. The caller
04735                     can use <span class="keyword">this</span> time to re-program <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT timer.
04736 
04737     ChangedFiringTime - Changed <a class="code" href="../../d6/d6/ttime_8c.html#a14">Time</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified timer.
04738 
04739 Return Value:
04740 
04741     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer was removed from head of timer list
04742     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
04743 
04744 --*/
04745 {
04746     ULONG NewTimeRemaining ;
04747     <a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html">PRTLP_GENERIC_TIMER</a> Temp ;
04748 
04749     <span class="comment">// Remove the timer from the list</span>
04750 
04751     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a128">RtlpRemoveFromDeltaList</a> (DeltaList, Timer, TimeRemaining, NewFiringTime)) {
04752 
04753         <span class="comment">// If element was removed from the head of the list we should record that</span>
04754 
04755         NewTimeRemaining = *NewFiringTime ;
04756 
04757 
04758     } <span class="keywordflow">else</span> {
04759 
04760         <span class="comment">// Element was not removed from head of delta list, the current TimeRemaining is valid</span>
04761 
04762         NewTimeRemaining = TimeRemaining ;
04763 
04764     }
04765 
04766     <span class="comment">// Before inserting Timer, set its delta time to the ChangedFiringTime</span>
04767 
04768     Timer-&gt;<a class="code" href="../../d1/d6/struct__RTLP__GENERIC__TIMER.html#o1">DeltaFiringTime</a> = ChangedFiringTime ;
04769 
04770     <span class="comment">// Reinsert this element back in the list</span>
04771 
04772     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d1/threads_8h.html#a127">RtlpInsertInDeltaList</a> (DeltaList, Timer, NewTimeRemaining, NewFiringTime)) {
04773 
04774         <span class="comment">// If we did not add at the head of the list, then we should return TRUE if</span>
04775         <span class="comment">// RtlpRemoveFromDeltaList() had returned TRUE. We also update the NewFiringTime to</span>
04776         <span class="comment">// the reflect the new firing time returned by RtlpRemoveFromDeltaList()</span>
04777 
04778         *NewFiringTime = NewTimeRemaining ;
04779 
04780         <span class="keywordflow">return</span> (NewTimeRemaining != TimeRemaining) ;
04781 
04782     } <span class="keywordflow">else</span> {
04783 
04784         <span class="comment">// NewFiringTime contains the time the NT timer must be programmed for</span>
04785 
04786         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
04787 
04788     }
04789 
04790 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="threads.c::RtlpResetTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpResetTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DueTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadCB</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l04429">4429</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00152">_RTLP_WAIT_THREAD_CONTROL_BLOCK::Current64BitTickCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00153">_RTLP_WAIT_THREAD_CONTROL_BLOCK::Firing64BitTickCount</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00277">INFINITE_TIME</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00383">Last64BitTickCount</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00679">NtCancelTimer()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00960">NtSetTimer()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03644">RtlpGet64BitTickCount()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00387">RtlpGetResync64BitTickCount</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04821">RtlpServiceTimer()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00388">RtlpSetFiring64BitTickCount</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00252">TimerHandle</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l03954">RtlpAddTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03302">RtlpAddWait()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04202">RtlpDeactivateTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03483">RtlpDeactivateWait()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05354">RtlpDeleteTimerQueue()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03697">RtlpProcessTimeouts()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03172">RtlpProcessWaitCompletion()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04821">RtlpServiceTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05201">RtlpTimerThread()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04044">RtlpUpdateTimer()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l02824">RtlpWaitThread()</a>.
<p>
<pre class="fragment"><div>04436                    :
04437 
04438     This routine resets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer object with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> due time.
04439 
04440 Arguments:
04441 
04442     <a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a> - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer object
04443 
04444     DueTime - Relative timer due time in Milliseconds
04445 
04446 Return Value:
04447 
04448 --*/
04449 {
04450     LARGE_INTEGER LongDueTime ;
04451 
04452     <a class="code" href="../../d2/d2/timer_8c.html#a13">NtCancelTimer</a> (TimerHandle, NULL) ;
04453 
04454     <span class="comment">// If the DueTime is INFINITE_TIME then set the timer to the largest integer possible</span>
04455 
04456     <span class="keywordflow">if</span> (DueTime == <a class="code" href="../../d3/d1/threads_8h.html#a10">INFINITE_TIME</a>) {
04457 
04458         LongDueTime.LowPart = 0x0 ;
04459 
04460         LongDueTime.HighPart = 0x80000000 ;
04461 
04462     } <span class="keywordflow">else</span> {
04463 
04464         <span class="comment">//</span>
04465         <span class="comment">// set the absolute time when timer is to be fired</span>
04466         <span class="comment">//</span>
04467         
04468         <span class="keywordflow">if</span> (ThreadCB) {
04469         
04470             ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o12">Firing64BitTickCount</a> = DueTime 
04471                                 + <a class="code" href="../../d2/d1/threads_8c.html#a41">RtlpGet64BitTickCount</a>(&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o11">Current64BitTickCount</a>) ;
04472 
04473         } <span class="keywordflow">else</span> {
04474             <span class="comment">//</span>
04475             <span class="comment">// adjust for drift only if it is a global timer</span>
04476             <span class="comment">//</span>
04477         
04478             ULONG Drift ;
04479             LONGLONG llCurrentTick ;
04480             
04481             llCurrentTick = <a class="code" href="../../d2/d1/threads_8c.html#a41">RtlpGet64BitTickCount</a>(&amp;Last64BitTickCount) ;
04482             
04483             Drift = (ULONG) (llCurrentTick - <a class="code" href="../../d3/d1/threads_8h.html#a26">RtlpGetResync64BitTickCount</a>()) ;
04484             DueTime = (DueTime &gt; Drift) ? DueTime-Drift : 1 ;
04485             <a class="code" href="../../d3/d1/threads_8h.html#a27">RtlpSetFiring64BitTickCount</a>(llCurrentTick + DueTime) ;
04486         }
04487 
04488         
04489         LongDueTime.QuadPart = Int32x32To64( DueTime, -10000 );
04490 
04491     }
04492     
04493 
04494     <a class="code" href="../../d2/d2/timer_8c.html#a15">NtSetTimer</a> (
04495         TimerHandle,
04496         &amp;LongDueTime,
04497         ThreadCB ? NULL : RtlpServiceTimer,
04498         NULL,
04499         FALSE,
04500         0,
04501         NULL
04502         ) ;
04503 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="threads.c::RtlpResync64BitTickCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> __inline LONGLONG RtlpResync64BitTickCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l03674">3674</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00383">Last64BitTickCount</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00384">Resync64BitTickCount</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l03644">RtlpGet64BitTickCount()</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l05767">RtlDebugPrintTimes()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03954">RtlpAddTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04142">RtlpCancelTimerEx()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05354">RtlpDeleteTimerQueue()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04821">RtlpServiceTimer()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l04044">RtlpUpdateTimer()</a>.
<p>
<pre class="fragment"><div>03678                    :
03679 
03680     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> getting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> latest 64bit tick count.
03681 
03682 Arguments:
03683 
03684 Return Value: 64bit tick count
03685 
03686 Remarks: This call should be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first line of any APC queued
03687     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer thread and nowhere <span class="keywordflow">else</span>. It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to reduce <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> drift
03688 
03689 --*/
03690 {
03691     <span class="keywordflow">return</span> <a class="code" href="../../d3/d1/threads_8h.html#a110">Resync64BitTickCount</a>.QuadPart = 
03692                     <a class="code" href="../../d2/d1/threads_8c.html#a41">RtlpGet64BitTickCount</a>(&amp;Last64BitTickCount);
03693 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="threads.c::RtlpServiceTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpServiceTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>NotUsedArg</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NotUsedLowTimer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NotUsedHighTimer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l04821">4821</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00320">ACQUIRE_GLOBAL_TIMER_LOCK</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00408">DPRN2</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00409">DPRN3</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00385">Firing64BitTickCount</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00277">INFINITE_TIME</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00383">Last64BitTickCount</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00045">PRTLP_TIMER</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00048">PRTLP_TIMER_QUEUE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00323">RELEASE_GLOBAL_TIMER_LOCK</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05767">RtlDebugPrintTimes()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00047">RTLP_TIMER_QUEUE</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03747">RtlpFireTimers()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05010">RtlpFireTimersAndReorder()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03644">RtlpGet64BitTickCount()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04378">RtlpGetTimeRemaining()</a>, <a class="el" href="../../d3/d1/threads_8h.html#a126">RtlpInsertTimersIntoDeltaList()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04429">RtlpResetTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03674">RtlpResync64BitTickCount()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00252">TimerHandle</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00251">TimerQueues</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l04429">RtlpResetTimer()</a>.
<p>
<pre class="fragment"><div>04828                    :
04829 
04830     Services <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer. Runs in an APC.
04831 
04832 Arguments:
04833 
04834     NotUsedArg - Argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not used in <span class="keyword">this</span> function.
04835 
04836     NotUsedLowTimer - Argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not used in <span class="keyword">this</span> function.
04837 
04838     NotUsedHighTimer - Argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not used in <span class="keyword">this</span> function.
04839 
04840 Return Value:
04841 
04842 Remarks:
04843     This APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">for</span> timeouts of timer threads.
04844     
04845 --*/
04846 {
04847     <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> Timer ;
04848     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue ;
04849     PLIST_ENTRY TNode ;
04850     PLIST_ENTRY QNode ;
04851     PLIST_ENTRY Temp ;
04852     ULONG NewFiringTime ;
04853     LIST_ENTRY ReinsertTimerQueueList ;
04854     LIST_ENTRY TimersToFireList ;
04855 
04856     <a class="code" href="../../d2/d1/threads_8c.html#a42">RtlpResync64BitTickCount</a>() ;
04857     
04858     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a36">DPRN2</a>) {
04859         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Before service timer ThreadId&lt;%x:%x&gt;\n"</span>,
04860                     HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
04861                     HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess));
04862         <a class="code" href="../../d2/d1/threads_8c.html#a72">RtlDebugPrintTimes</a> ();
04863     }
04864 
04865     <a class="code" href="../../d3/d1/threads_8h.html#a21">ACQUIRE_GLOBAL_TIMER_LOCK</a>();
04866 
04867     <span class="comment">// fire it if it even 200ms ahead. else reset the timer</span>
04868     
04869     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a111">Firing64BitTickCount</a>.QuadPart &gt; <a class="code" href="../../d2/d1/threads_8c.html#a41">RtlpGet64BitTickCount</a>(&amp;Last64BitTickCount) + 200) {
04870 
04871         <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (TimerHandle, RtlpGetTimeRemaining (TimerHandle), NULL) ;
04872 
04873         <a class="code" href="../../d3/d1/threads_8h.html#a22">RELEASE_GLOBAL_TIMER_LOCK</a>() ;
04874         <span class="keywordflow">return</span> ;
04875     }
04876         
04877     InitializeListHead (&amp;ReinsertTimerQueueList) ;
04878 
04879     InitializeListHead (&amp;TimersToFireList) ;
04880 
04881 
04882     <span class="comment">// We run thru all queues with DeltaFiringTime == 0 and fire all timers that</span>
04883     <span class="comment">// have DeltaFiringTime == 0. We remove the fired timers and either free them</span>
04884     <span class="comment">// (for one shot timers) or put them in aside list (for periodic timers).</span>
04885     <span class="comment">// After we have finished firing all timers in a queue we reinsert the timers</span>
04886     <span class="comment">// in the aside list back into the queue based on their new firing times.</span>
04887     <span class="comment">//</span>
04888     <span class="comment">// Similarly, we remove each fired Queue and put it in a aside list. After firing</span>
04889     <span class="comment">// all queues with DeltaFiringTime == 0, we reinsert the Queues in the aside list</span>
04890     <span class="comment">// and reprogram the NT timer to be the firing time of the first queue in the list</span>
04891 
04892 
04893     <span class="keywordflow">for</span> (QNode = <a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>.Flink ; QNode != &amp;<a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a> ; QNode = QNode-&gt;Flink) {
04894 
04895         Queue = CONTAINING_RECORD (QNode, RTLP_TIMER_QUEUE, List) ;
04896 
04897         <span class="comment">// If the delta time in the timer queue is 0 - then this queue</span>
04898         <span class="comment">// has timers that are ready to fire. Walk the list and fire all timers with</span>
04899         <span class="comment">// Delta time of 0</span>
04900 
04901         <span class="keywordflow">if</span> (Queue-&gt;DeltaFiringTime == 0) {
04902 
04903             <span class="comment">// Walk all timers with DeltaFiringTime == 0 and fire them. After that</span>
04904             <span class="comment">// reinsert the periodic timers in the appropriate place.</span>
04905 
04906             <a class="code" href="../../d3/d1/threads_8h.html#a124">RtlpFireTimersAndReorder</a> (Queue, &amp;NewFiringTime, &amp;TimersToFireList) ;
04907 
04908             <span class="comment">// detach this Queue from the list</span>
04909 
04910             QNode = QNode-&gt;Blink ;
04911 
04912             RemoveEntryList (QNode-&gt;Flink) ;
04913 
04914             <span class="comment">// If there are timers in the queue then prepare to reinsert the queue in</span>
04915             <span class="comment">// TimerQueues.</span>
04916 
04917             <span class="keywordflow">if</span> (NewFiringTime != <a class="code" href="../../d3/d1/threads_8h.html#a10">INFINITE_TIME</a>) {
04918 
04919                 Queue-&gt;DeltaFiringTime = NewFiringTime ;
04920 
04921                 <span class="comment">// put the timer in list that we will process after we have</span>
04922                 <span class="comment">// fired all elements in this queue</span>
04923 
04924                 InsertHeadList (&amp;ReinsertTimerQueueList, &amp;Queue-&gt;List) ;
04925 
04926             } <span class="keywordflow">else</span> {
04927 
04928                 <span class="comment">// Queue has no more timers in it. Let the Queue float.</span>
04929 
04930                 InitializeListHead (&amp;Queue-&gt;List) ;
04931 
04932             }
04933 
04934 
04935         } <span class="keywordflow">else</span> {
04936 
04937             <span class="comment">// No more Queues with DeltaFiringTime == 0</span>
04938 
04939             <span class="keywordflow">break</span> ;
04940 
04941         }
04942 
04943     }
04944 
04945     <span class="comment">// At this point we have fired all the ready timers. We have two lists that need to be</span>
04946     <span class="comment">// merged - TimerQueues and ReinsertTimerQueueList. The following steps do this - at the</span>
04947     <span class="comment">// end of this we will reprogram the NT Timer.</span>
04948 
04949     <span class="keywordflow">if</span> (!IsListEmpty(&amp;TimerQueues)) {
04950 
04951         Queue = CONTAINING_RECORD (<a class="code" href="../../d3/d1/threads_8h.html#a94">TimerQueues</a>.Flink, RTLP_TIMER_QUEUE, List) ;
04952 
04953         NewFiringTime = Queue-&gt;DeltaFiringTime ;
04954 
04955         Queue-&gt;DeltaFiringTime = 0 ;
04956 
04957         <span class="keywordflow">if</span> (!IsListEmpty (&amp;ReinsertTimerQueueList)) {
04958 
04959             <span class="comment">// TimerQueues and ReinsertTimerQueueList are both non-empty. Merge them.</span>
04960 
04961             <a class="code" href="../../d3/d1/threads_8h.html#a126">RtlpInsertTimersIntoDeltaList</a> (&amp;ReinsertTimerQueueList, &amp;TimerQueues, 
04962                                             NewFiringTime, &amp;NewFiringTime) ;
04963 
04964         }
04965 
04966         <span class="comment">// NewFiringTime contains the time the NT Timer should be programmed to.</span>
04967 
04968     } <span class="keywordflow">else</span> {
04969 
04970         <span class="keywordflow">if</span> (!IsListEmpty (&amp;ReinsertTimerQueueList)) {
04971 
04972             <span class="comment">// TimerQueues is empty. ReinsertTimerQueueList is not.</span>
04973 
04974             <a class="code" href="../../d3/d1/threads_8h.html#a126">RtlpInsertTimersIntoDeltaList</a> (&amp;ReinsertTimerQueueList, &amp;TimerQueues, 0, 
04975                                             &amp;NewFiringTime) ;
04976 
04977         } <span class="keywordflow">else</span> {
04978 
04979             NewFiringTime = <a class="code" href="../../d3/d1/threads_8h.html#a10">INFINITE_TIME</a> ;
04980 
04981         }
04982 
04983         <span class="comment">// NewFiringTime contains the time the NT Timer should be programmed to.</span>
04984 
04985     }
04986 
04987 
04988     <span class="comment">// Reset the timer to reflect the Delta time associated with the first Queue</span>
04989 
04990     <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (TimerHandle, NewFiringTime, NULL) ;
04991 
04992     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a37">DPRN3</a>) {
04993         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"After service timer:ThreadId&lt;%x:%x&gt;\n"</span>,
04994                     HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
04995                     HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess));
04996         <a class="code" href="../../d2/d1/threads_8c.html#a72">RtlDebugPrintTimes</a> ();
04997     }
04998 
04999     
05000     <span class="comment">// finally fire all the timers</span>
05001     
05002     <a class="code" href="../../d3/d1/threads_8h.html#a125">RtlpFireTimers</a>( &amp;TimersToFireList ) ;
05003 
05004     <a class="code" href="../../d3/d1/threads_8h.html#a22">RELEASE_GLOBAL_TIMER_LOCK</a>();
05005 
05006 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="threads.c::RtlpStartIOWorkerThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpStartIOWorkerThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l01820">1820</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00241">LastThreadCreationTickCount</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d5/gettickc_8c-source.html#l00026">NtGetTickCount()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00224">NumIOWorkerThreads</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02370">RtlpIOWorkerThread()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00261">RtlpStartThreadFunc</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l00437">RtlQueueWorkItem()</a>.
<p>
<pre class="fragment"><div>01824                    :
01825 
01826     This routine starts an I/O worker thread
01827 
01828 Arguments:
01829 
01830 
01831 Return Value:
01832 
01833     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> error codes resulting from attempts to create a thread
01834     STATUS_SUCCESS
01835 
01836 --*/
01837 {
01838     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> ;
01839     ULONG CurrentTickCount ;
01840     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01841 
01842 
01843     <span class="comment">// Create worker thread</span>
01844 
01845     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a102">RtlpStartThreadFunc</a> (RtlpIOWorkerThread, &amp;ThreadHandle) ;
01846 
01847     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS ) {
01848 
01849         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( ThreadHandle ) ;
01850 
01851         <span class="comment">// Update the time at which the current thread was created</span>
01852 
01853         <a class="code" href="../../d3/d1/threads_8h.html#a88">LastThreadCreationTickCount</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() ;
01854 
01855     } <span class="keywordflow">else</span> {
01856 
01857         <span class="comment">// Thread creation failed. If there is even one thread present do not return</span>
01858         <span class="comment">// failure since we can still service the work request.</span>
01859 
01860         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a74">NumIOWorkerThreads</a> == 0) {
01861 
01862             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01863 
01864         }
01865     }
01866 
01867     <span class="keywordflow">return</span> STATUS_SUCCESS ;
01868 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="threads.c::RtlpStartThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NTAPI RtlpStartThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUSER_THREAD_START_ROUTINE&nbsp;</td>
          <td class="mdname" nowrap> <em>Function</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE *&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l02677">2677</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d8/d5/delay_8c-source.html#l00033">NtDelayExecution()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00285">ONE_MILLISECOND_TIMEOUT</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l01241">RtlCreateUserThread()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>.
<p>
<pre class="fragment"><div>02683                    :
02684 
02685     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used start a <span class="keyword">new</span> wait thread in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
02686 Arguments:
02687 
02688     None
02689 
02690 Return Value:
02691 
02692     STATUS_SUCCESS - Timer Queue created successfully.
02693 
02694     STATUS_NO_MEMORY - There was not sufficient heap to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested operation.
02695 
02696 --*/
02697 {
02698     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02699     ULONG <a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a> ;
02700     LARGE_INTEGER TimeOut ;
02701 
02702     <a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02703 
02704     <span class="comment">// Create the first thread. This thread never dies until the process exits</span>
02705 
02706     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/rtlexec_8c.html#a13">RtlCreateUserThread</a>(
02707                    NtCurrentProcess(), <span class="comment">// process handle</span>
02708                    NULL,               <span class="comment">// security descriptor</span>
02709                    FALSE,              <span class="comment">// Create suspended?</span>
02710                    0L,                 <span class="comment">// ZeroBits: default</span>
02711                    0L,                 <span class="comment">// Max stack size: default</span>
02712                    0L,                 <span class="comment">// Committed stack size: default</span>
02713                    Function,           <span class="comment">// Function to start in</span>
02714                    &amp;Initialized,       <span class="comment">// Event the thread signals when the thread is ready</span>
02715                    ThreadHandle,       <span class="comment">// Thread handle</span>
02716                    NULL                <span class="comment">// Thread id</span>
02717                    );
02718 
02719     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS ) {
02720 
02721         <span class="comment">// Sleep 1 ms and see if the other thread has completed initialization</span>
02722 
02723         <a class="code" href="../../d3/d1/threads_8h.html#a13">ONE_MILLISECOND_TIMEOUT</a>(TimeOut) ;
02724 
02725         <span class="keywordflow">while</span> (!(<span class="keyword">volatile</span> ULONG) <a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>) {
02726 
02727             <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (FALSE, &amp;TimeOut) ;
02728 
02729         }
02730 
02731     }
02732 
02733 
02734     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02735 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="threads.c::RtlpStartWorkerThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpStartWorkerThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l01763">1763</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00241">LastThreadCreationTickCount</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d5/gettickc_8c-source.html#l00026">NtGetTickCount()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00225">NumWorkerThreads</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00261">RtlpStartThreadFunc</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02137">RtlpWorkerThread()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l01872">RtlpWorkerThreadTimerCallback()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00437">RtlQueueWorkItem()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l00600">RtlSetIoCompletionCallback()</a>.
<p>
<pre class="fragment"><div>01767                    :
01768 
01769     This routine starts a regular worker thread
01770 
01771 Arguments:
01772 
01773 
01774 Return Value:
01775 
01776     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> error codes resulting from attempts to create a thread
01777     STATUS_SUCCESS
01778 
01779 --*/
01780 {
01781     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> ;
01782     ULONG CurrentTickCount ;
01783     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01784 
01785     <span class="comment">// Create worker thread</span>
01786     
01787     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a102">RtlpStartThreadFunc</a> (RtlpWorkerThread, &amp;ThreadHandle) ;
01788 
01789     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS ) {
01790 
01791         <span class="comment">// Update the time at which the current thread was created</span>
01792 
01793         <a class="code" href="../../d3/d1/threads_8h.html#a88">LastThreadCreationTickCount</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() ;
01794 
01795         <span class="comment">// Increment the count of the thread type created</span>
01796 
01797         InterlockedIncrement(&amp;NumWorkerThreads) ;
01798 
01799         <span class="comment">// Close Thread handle, we dont need it.</span>
01800 
01801         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (ThreadHandle) ;
01802 
01803     } <span class="keywordflow">else</span> {
01804 
01805         <span class="comment">// Thread creation failed. If there is even one thread present do not return</span>
01806         <span class="comment">// failure - else queue the request anyway.</span>
01807 
01808         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> == 0) {
01809 
01810             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01811         }
01812 
01813     }
01814 
01815     <span class="keywordflow">return</span> STATUS_SUCCESS ;
01816 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="threads.c::RtlpThreadCleanup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpThreadCleanup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l05484">5484</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00461">NtTerminateThread()</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l01320">RtlThreadPoolCleanup()</a>.
<p>
<pre class="fragment"><div>05488                    :
05489 
05490     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> exiting timer, wait and IOworker threads.
05491 
05492 Arguments:
05493 
05494 Return Value:
05495 
05496 --*/
05497 {
05498     <a class="code" href="../../d8/d0/psdelete_8c.html#a6">NtTerminateThread</a>( NtCurrentThread(), 0) ;
05499 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="threads.c::RtlpTimerThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG RtlpTimerThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Initialized</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l05201">5201</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>, <a class="el" href="../../d8/d5/delay_8c-source.html#l00033">NtDelayExecution()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04429">RtlpResetTimer()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00252">TimerHandle</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00222">TimerThreadId</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l05256">RtlpInitializeTimerThreadPool()</a>.
<p>
<pre class="fragment"><div>05206                    :
05207 
05208     All <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer activity takes place in APCs.
05209 
05210 Arguments:
05211 
05212     <a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a> - Used to notify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starter of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread that thread initialization 
05213     has completed
05214 
05215 Return Value:
05216 
05217 --*/
05218 {
05219     LARGE_INTEGER TimeOut ;
05220 
05221     <span class="comment">// no structure initializations should be done here as new timer thread</span>
05222     <span class="comment">// may be created after threadPoolCleanup</span>
05223     
05224 
05225     <a class="code" href="../../d3/d1/threads_8h.html#a73">TimerThreadId</a> = HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
05226 
05227 
05228     <span class="comment">// Reset the NT Timer to never fire initially</span>
05229 
05230     <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (TimerHandle, -1, NULL) ;
05231 
05232     <span class="comment">// Notify starter of this thread that it has initialized</span>
05233 
05234     InterlockedExchange ((ULONG *) Initialized, 1) ;
05235 
05236     <span class="comment">// Sleep alertably so that all the activity can take place</span>
05237     <span class="comment">// in APCs</span>
05238 
05239     <span class="keywordflow">for</span> ( ; ; ) {
05240 
05241         <span class="comment">// Set timeout for the largest timeout possible</span>
05242 
05243         TimeOut.LowPart = 0 ;
05244         TimeOut.HighPart = 0x80000000 ;
05245 
05246         <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (TRUE, &amp;TimeOut) ;
05247 
05248     }
05249 
05250     <span class="keywordflow">return</span> 0 ;  <span class="comment">// Keep compiler happy</span>
05251 
05252 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="threads.c::RtlpUpdateTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpUpdateTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PRTLP_TIMER&nbsp;</td>
          <td class="mdname" nowrap> <em>Timer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PRTLP_TIMER&nbsp;</td>
          <td class="mdname" nowrap> <em>UpdatedTimer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l04044">4044</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00396">CHECK_SIGNATURE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00048">PRTLP_TIMER_QUEUE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00302">RtlpFreeTPHeap</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04326">RtlpGetQueueRelativeTime()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04378">RtlpGetTimeRemaining()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04711">RtlpReOrderDeltaList()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04429">RtlpResetTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03674">RtlpResync64BitTickCount()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00760">STATE_ACTIVE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00252">TimerHandle</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00251">TimerQueues</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l01058">RtlUpdateTimer()</a>.
<p>
<pre class="fragment"><div>04050                    :
04051 
04052     This routine executes in an APC and updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified timer <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> exists
04053 
04054 Arguments:
04055 
04056     Timer - Timer that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> actually updated
04057     UpdatedTimer - Specifies pointer to a timer structure that contains Queue and
04058                 Timer information
04059 
04060 Return Value:
04061 
04062 
04063 --*/
04064 {
04065     <a class="code" href="../../d3/d1/threads_8h.html#a4">PRTLP_TIMER_QUEUE</a> Queue ;
04066     ULONG TimeRemaining, QueueRelTimeRemaining ;
04067     ULONG NewFiringTime ;
04068 
04069 
04070     <a class="code" href="../../d2/d1/threads_8c.html#a42">RtlpResync64BitTickCount</a>( ) ;
04071 
04072     <a class="code" href="../../d3/d1/threads_8h.html#a29">CHECK_SIGNATURE</a>(Timer) ;
04073 
04074     Queue = Timer-&gt;Queue ;
04075 
04076     <span class="comment">// Update the periodic time on the timer</span>
04077 
04078     Timer-&gt;Period = UpdatedTimer-&gt;Period ;
04079 
04080 
04081     <span class="comment">// if timer is not in active state, then dont update it</span>
04082     
04083     <span class="keywordflow">if</span> ( ! ( Timer-&gt;State &amp; <a class="code" href="../../d3/d1/threads_8h.html#a42">STATE_ACTIVE</a> ) ) {
04084 
04085         <span class="keywordflow">return</span> ;
04086     }
04087         
04088     <span class="comment">// Get the time remaining on the NT timer</span>
04089 
04090     TimeRemaining = <a class="code" href="../../d3/d1/threads_8h.html#a136">RtlpGetTimeRemaining</a> (TimerHandle) ;
04091     QueueRelTimeRemaining = TimeRemaining + <a class="code" href="../../d3/d1/threads_8h.html#a138">RtlpGetQueueRelativeTime</a> (Queue) ;
04092 
04093 
04094     <span class="comment">// Update the timer based on the due time</span>
04095     
04096     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a129">RtlpReOrderDeltaList</a> (&amp;Queue-&gt;TimerList, Timer, QueueRelTimeRemaining, 
04097                                 &amp;NewFiringTime, 
04098                                 UpdatedTimer-&gt;DeltaFiringTime)) 
04099     {
04100 
04101         <span class="comment">// If this update caused the timer at the head of the queue to change, then reinsert</span>
04102         <span class="comment">// this queue in the list of queues.</span>
04103 
04104         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a129">RtlpReOrderDeltaList</a> (&amp;TimerQueues, Queue, TimeRemaining, &amp;NewFiringTime, NewFiringTime)) {
04105 
04106             <span class="comment">// NT timer needs to be updated since the change caused the queue at the head of</span>
04107             <span class="comment">// the TimerQueues to change.</span>
04108 
04109             <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (TimerHandle, NewFiringTime, NULL) ;
04110 
04111         }
04112 
04113     }
04114 
04115     <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( UpdatedTimer ) ;
04116 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a67" doxytag="threads.c::RtlpWaitForEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlpWaitForEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Event</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l05503">5503</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00056">NtQueueApcThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00282">NtWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00295">ONE_SECOND_TIMEOUT</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03617">RtlpDoNothing()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l01145">RtlDeleteTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00809">RtlDeleteTimerQueueEx()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l00256">RtlDeregisterWaitEx()</a>.
<p>
<pre class="fragment"><div>05509                    :
05510 
05511     Waits <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event to be signalled. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not signalled within
05512     one second, then checks to see that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> alive
05513 
05514 Arguments:
05515 
05516     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> : <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> handle used <span class="keywordflow">for</span> signalling completion of request
05517 
05518     <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>: Thread to check whether still alive
05519 
05520 Return Value:
05521 
05522     STATUS_SUCCESS <span class="keywordflow">if</span> event was signalled
05523     <span class="keywordflow">else</span> <span class="keywordflow">return</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
05524 
05525 --*/
05526 {
05527     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
05528     LARGE_INTEGER TimeOut ;
05529     
05530     <span class="comment">// Timeout of 1 second for request to complete</span>
05531     <a class="code" href="../../d3/d1/threads_8h.html#a15">ONE_SECOND_TIMEOUT</a>(TimeOut) ;
05532 
05533 Wait:
05534 
05535     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a> (Event, FALSE, &amp;TimeOut) ;
05536     
05537     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT) {
05538 
05539         <span class="comment">// The wait timed out. Check to see if the wait thread is still alive.</span>
05540         <span class="comment">// This is done by trying to queue a dummy APC to it. There is no better</span>
05541         <span class="comment">// way known to determine if the thread has died unexpectedly.</span>
05542         <span class="comment">// If so then go back to waiting.</span>
05543 
05544         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
05545             ThreadHandle,
05546             (PPS_APC_ROUTINE)RtlpDoNothing,
05547             NULL,
05548             NULL,
05549             NULL
05550             );
05551 
05552         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
05553 
05554             <span class="comment">// Wait thread is still alive. Go back to waiting.</span>
05555 
05556             <span class="keywordflow">goto</span> Wait ;
05557 
05558         } <span class="keywordflow">else</span> {
05559 
05560             <span class="comment">// The wait thread died between the time the APC was queued and the</span>
05561             <span class="comment">// the time we started waiting on NtQueryInformationThread()</span>
05562 
05563 
05564             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Thread died before event could be signalled"</span>) ;
05565 
05566         }
05567 
05568     }
05569 
05570     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ? STATUS_SUCCESS : <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
05571 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="threads.c::RtlpWaitThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG RtlpWaitThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Initialized</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l02824">2824</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00310">ACQUIRE_GLOBAL_WAIT_LOCK</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00144">_RTLP_WAIT_THREAD_CONTROL_BLOCK::ActiveWaitArray</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00145">_RTLP_WAIT_THREAD_CONTROL_BLOCK::ActiveWaitPointers</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00152">_RTLP_WAIT_THREAD_CONTROL_BLOCK::Current64BitTickCount</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00153">_RTLP_WAIT_THREAD_CONTROL_BLOCK::Firing64BitTickCount</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00150">_RTLP_WAIT_THREAD_CONTROL_BLOCK::FreeTimerBlocks</a>, <a class="el" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00444">NtCreateTimer()</a>, <a class="el" href="../../d8/d5/delay_8c-source.html#l00033">NtDelayExecution()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d0/d5/gettickc_8c-source.html#l00026">NtGetTickCount()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00406">NtWaitForMultipleObjects()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00143">_RTLP_WAIT_THREAD_CONTROL_BLOCK::NumActiveWaits</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00142">_RTLP_WAIT_THREAD_CONTROL_BLOCK::NumWaits</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00313">RELEASE_GLOBAL_WAIT_LOCK</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00044">RTLP_TIMER</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00263">RtlpExitThreadFunc</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03697">RtlpProcessTimeouts()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03172">RtlpProcessWaitCompletion()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04429">RtlpResetTimer()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00139">_RTLP_WAIT_THREAD_CONTROL_BLOCK::ThreadHandle</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00140">_RTLP_WAIT_THREAD_CONTROL_BLOCK::ThreadId</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00148">_RTLP_WAIT_THREAD_CONTROL_BLOCK::TimerBlocks</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00146">_RTLP_WAIT_THREAD_CONTROL_BLOCK::TimerHandle</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00147">_RTLP_WAIT_THREAD_CONTROL_BLOCK::TimerQueue</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d1/threads_8c.html#a3">WAIT_IDLE_TIMEOUT</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00247">WaitThreads</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00137">_RTLP_WAIT_THREAD_CONTROL_BLOCK::WaitThreadsList</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l03851">RtlpFindWaitThread()</a>.
<p>
<pre class="fragment"><div>02829                    :
02830 
02831     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> all waits in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait thread <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
02832 
02833 Arguments:
02834 
02835     <a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a> - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to 1 when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread has initialized
02836 
02837 Return Value:
02838 
02839     Nothing. The thread never terminates.
02840 
02841 --*/
02842 {
02843     ULONG  i ;                                   <span class="comment">// Used as an index</span>
02844     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02845     LARGE_INTEGER TimeOut;                       <span class="comment">// Timeout used for waits</span>
02846     <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCB ;   <span class="comment">// Control Block allocated on the stack</span>
02847 <span class="preprocessor">#define WAIT_IDLE_TIMEOUT 400000</span>
02848 <span class="preprocessor"></span>
02849 
02850     <span class="keywordflow">try</span> {
02851         ThreadCB = (<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a>)
02852                         _alloca(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">RTLP_WAIT_THREAD_CONTROL_BLOCK</a>));
02853 
02854     } except (EXCEPTION_EXECUTE_HANDLER) {
02855     
02856         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
02857         InterlockedExchange ((ULONG *)Initialized, (ULONG)~0) ;
02858         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02859     }
02860     
02861 
02862     
02863     <span class="comment">// Initialize thread control block</span>
02864 
02865     InitializeListHead (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o0">WaitThreadsList</a>) ;
02866 
02867     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(
02868                 NtCurrentProcess(),
02869                 NtCurrentThread(),
02870                 NtCurrentProcess(),
02871                 &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o1">ThreadHandle</a>,
02872                 0,
02873                 FALSE,
02874                 DUPLICATE_SAME_ACCESS
02875                 ) ;
02876 
02877     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02878         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE) ;
02879         InterlockedExchange ((ULONG *)Initialized, (ULONG)~0) ;
02880         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02881     }
02882 
02883     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o2">ThreadId</a> =  HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
02884 
02885     RtlZeroMemory (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o5">ActiveWaitArray</a>[0], sizeof (HANDLE) * 64) ;
02886 
02887     RtlZeroMemory (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o6">ActiveWaitPointers</a>[0], sizeof (HANDLE) * 64) ;
02888 
02889 
02890 
02891     <span class="comment">// Initialize the timer related fields.</span>
02892 
02893     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d2/timer_8c.html#a11">NtCreateTimer</a>(
02894                  &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>,
02895                  TIMER_ALL_ACCESS,
02896                  NULL,
02897                  NotificationTimer
02898                  ) ;
02899 
02900     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
02901         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE);
02902         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o1">ThreadHandle</a>) ;
02903         InterlockedExchange ((ULONG *)Initialized, (ULONG)~0) ;
02904         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02905     }
02906     
02907 
02908     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o12">Firing64BitTickCount</a> = 0 ;
02909     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o11">Current64BitTickCount</a>.QuadPart = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() ;
02910 
02911     <span class="comment">// Reset the NT Timer to never fire initially</span>
02912 
02913     <a class="code" href="../../d3/d1/threads_8h.html#a123">RtlpResetTimer</a> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>, -1, ThreadCB) ;
02914     
02915     InitializeListHead (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o8">TimerQueue</a>.TimerList) ;
02916     InitializeListHead (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o8">TimerQueue</a>.UncancelledTimerList) ;
02917 
02918     
02919     <span class="comment">// Initialize the timer blocks</span>
02920 
02921     RtlZeroMemory (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o9">TimerBlocks</a>[0], sizeof (RTLP_TIMER) * 63) ;
02922 
02923     InitializeListHead (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o10">FreeTimerBlocks</a>) ;
02924 
02925     <span class="keywordflow">for</span> (i = 0 ; i &lt; 63 ; i++) {
02926 
02927         InitializeListHead (&amp;(&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o9">TimerBlocks</a>[i])-&gt;List) ;
02928         InsertHeadList (&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o10">FreeTimerBlocks</a>, &amp;(&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o9">TimerBlocks</a>[i])-&gt;List) ;
02929 
02930     }
02931 
02932 
02933     <span class="comment">// Insert this new wait thread in the WaitThreads list. Insert at the head so that</span>
02934     <span class="comment">// the request that caused this thread to be created can find it right away.</span>
02935 
02936     InsertHeadList (&amp;WaitThreads, &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o0">WaitThreadsList</a>) ;
02937 
02938 
02939     <span class="comment">// The first wait element is the timer object</span>
02940 
02941     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o5">ActiveWaitArray</a>[0] = ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a> ;
02942 
02943     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a> = ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o3">NumWaits</a> = 1 ;
02944 
02945 
02946     <span class="comment">// till here, the function is running under the global wait lock</span>
02947 
02948 
02949     
02950     <span class="comment">// We are all initialized now. Notify the starter to queue the task.</span>
02951 
02952     InterlockedExchange ((ULONG *)Initialized, 1) ;
02953 
02954 
02955     <span class="comment">// Loop forever - wait threads never, never die.</span>
02956 
02957     <span class="keywordflow">for</span> ( ; ; ) {
02958 
02959         <span class="keywordflow">if</span> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a> == 1)
02960             TimeOut.QuadPart = Int32x32To64( WAIT_IDLE_TIMEOUT, -10000 ) ;
02961 
02962         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a5">NtWaitForMultipleObjects</a> (
02963                      (CHAR) ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a>,
02964                      ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o5">ActiveWaitArray</a>,
02965                      WaitAny,
02966                      TRUE,      <span class="comment">// Wait Alertably</span>
02967                      ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o3">NumWaits</a>!=1 ? NULL : &amp;TimeOut       <span class="comment">// Wait forever</span>
02968                      ) ;
02969 
02970         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_ALERTED || <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_USER_APC) {
02971 
02972             <span class="keywordflow">continue</span> ;
02973 
02974         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &gt;= STATUS_WAIT_0 &amp;&amp; <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &lt;= STATUS_WAIT_63) {
02975 
02976             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_WAIT_0) {
02977 
02978                 <a class="code" href="../../d3/d1/threads_8h.html#a135">RtlpProcessTimeouts</a> (ThreadCB) ;
02979 
02980             } <span class="keywordflow">else</span> {
02981 
02982                 <span class="comment">// Wait completed call Callback function</span>
02983 
02984                 <a class="code" href="../../d3/d1/threads_8h.html#a134">RtlpProcessWaitCompletion</a> (
02985                         ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o6">ActiveWaitPointers</a>[Status], Status) ;
02986 
02987             }
02988 
02989         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &gt;= STATUS_ABANDONED_WAIT_0 
02990                     &amp;&amp; <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &lt;= STATUS_ABANDONED_WAIT_63) {
02991 
02992 <span class="preprocessor">            #if DBG</span>
02993 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"RTL ThreadPool Wait Thread: Abandoned wait: %d\n"</span>,
02994                         Status - STATUS_ABANDONED_WAIT_0 ) ;
02995 <span class="preprocessor">            #endif</span>
02996 <span class="preprocessor"></span>
02997             
02998             <span class="comment">// Abandoned wait</span>
02999 
03000             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE) ;
03001 
03002         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT) {
03003 
03004             <span class="comment">//</span>
03005             <span class="comment">// remove this thread from the wait list and terminate</span>
03006             <span class="comment">//</span>
03007 
03008             {
03009                 ULONG NumWaits;
03010                 
03011                 <a class="code" href="../../d3/d1/threads_8h.html#a19">ACQUIRE_GLOBAL_WAIT_LOCK</a>() ;
03012 
03013                 NumWaits = ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o3">NumWaits</a>;
03014                 
03015                 <span class="keywordflow">if</span> (ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o3">NumWaits</a> &lt;= 1) {
03016                     RemoveEntryList(&amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o0">WaitThreadsList</a>) ;
03017                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o1">ThreadHandle</a>) ;
03018                     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o7">TimerHandle</a>) ;
03019                 }
03020 
03021                 <a class="code" href="../../d3/d1/threads_8h.html#a20">RELEASE_GLOBAL_WAIT_LOCK</a>() ;
03022 
03023                 <span class="keywordflow">if</span> (NumWaits &lt;= 1) {
03024 
03025                     <a class="code" href="../../d3/d1/threads_8h.html#a104">RtlpExitThreadFunc</a>( 0 );
03026                 }
03027             }
03028             
03029         } <span class="keywordflow">else</span> {
03030 
03031             <span class="comment">// Some other error: fatal condition</span>
03032             ULONG i ;
03033             
03034 <span class="comment">//            ASSERTMSG( "Press 'i', and note the dbgprint\n", FALSE ) ;</span>
03035 
03036 <span class="preprocessor">            #if DBG</span>
03037 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"RTL Thread Pool: Application closed an object handle "</span>
03038                         <span class="stringliteral">"that the wait thread was waiting on: Code:%x ThreadId:&lt;%x:%x&gt;\n"</span>,
03039                         Status, HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
03040                         HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
03041 
03042             TimeOut.QuadPart = 0 ;
03043 
03044             <span class="keywordflow">for</span> (i=0;  i&lt;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o4">NumActiveWaits</a>;  i++) {
03045 
03046                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a5">NtWaitForMultipleObjects</a>(
03047                              (CHAR) 1,
03048                              &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o5">ActiveWaitArray</a>[i],
03049                              WaitAny,
03050                              TRUE,      <span class="comment">// Wait Alertably</span>
03051                              &amp;TimeOut   <span class="comment">// Dont 0</span>
03052                              ) ;
03053 
03054                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_HANDLE) {
03055                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Bad Handle index:%d WaitEntry Ptr:%x\n"</span>,
03056                                 i, ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o6">ActiveWaitPointers</a>[i]) ;
03057                 }
03058             }
03059             
03060 <span class="preprocessor">            #endif</span>
03061 <span class="preprocessor"></span>
03062             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FALSE ) ;
03063 
03064             
03065             <span class="comment">// Set timeout for the largest timeout possible</span>
03066 
03067             TimeOut.LowPart = 0 ;
03068             TimeOut.HighPart = 0x80000000 ;
03069 
03070             <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a> (TRUE, &amp;TimeOut) ;
03071             
03072         }
03073 
03074     } <span class="comment">// forever</span>
03075 
03076     <span class="keywordflow">return</span> 0 ; <span class="comment">// Keep compiler happy</span>
03077 
03078 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="threads.c::RtlpWorkerThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG RtlpWorkerThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Initialized</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l02137">2137</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d1/threads_8c.html#a1">MAX_WORKER_SLEEP_TIME_EXPONENT</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00275">NEW_THREAD_THRESHOLD</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l02706">NtQueryInformationThread()</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00485">NtRemoveIoCompletion()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00231">NumExecutingWorkerThreads</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00230">NumLongWorkRequests</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00226">NumMinWorkerThreads</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00225">NumWorkerThreads</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00229">NumWorkRequests</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00263">RtlpExitThreadFunc</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00232">TotalExecutedWorkRequests</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d1/threads_8c.html#a0">WORKER_IDLE_TIMEOUT</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00245">WorkerCompletionPort</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00255">WorkerCriticalSection</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l01763">RtlpStartWorkerThread()</a>.
<p>
<pre class="fragment"><div>02142                    :
02143 
02144     All non I/O worker threads execute in <span class="keyword">this</span> routine. Worker thread will <span class="keywordflow">try</span> to
02145     terminate when <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> has not serviced a request <span class="keywordflow">for</span>
02146 
02147         STARTING_WORKER_SLEEP_TIME +
02148         STARTING_WORKER_SLEEP_TIME &lt;&lt; 1 +
02149         ...
02150         STARTING_WORKER_SLEEP_TIME &lt;&lt; <a class="code" href="../../d2/d1/threads_8c.html#a1">MAX_WORKER_SLEEP_TIME_EXPONENT</a>
02151 
02152 Arguments:
02153 
02154     <a class="code" href="../../d4/d9/ke_8h.html#a406a191">Initialized</a> - Set to 1 when we are initialized
02155 
02156 Return Value:
02157 
02158 --*/
02159 {
02160     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
02161     PVOID WorkerProc ;
02162     PVOID Context ;
02163     IO_STATUS_BLOCK IoSb ;
02164     ULONG SleepTime ;
02165     LARGE_INTEGER TimeOut ;
02166     ULONG Terminate ;
02167     PVOID Overlapped ;
02168 
02169 
02170     <span class="comment">// We are all initialized now. Notify the starter to queue the task.</span>
02171 
02172     InterlockedExchange ((ULONG *)Initialized, 1L) ;
02173 
02174 
02175     <span class="comment">// Set default sleep time for 40 seconds. This time is doubled each time a timeout</span>
02176     <span class="comment">// occurs after which the thread terminates</span>
02177 
02178 <span class="preprocessor">#define WORKER_IDLE_TIMEOUT     40000    // In Milliseconds</span>
02179 <span class="preprocessor"></span><span class="preprocessor">#define MAX_WORKER_SLEEP_TIME_EXPONENT 4</span>
02180 <span class="preprocessor"></span>
02181     SleepTime = <a class="code" href="../../d2/d1/threads_8c.html#a0">WORKER_IDLE_TIMEOUT</a> ;
02182 
02183     <span class="comment">// Loop servicing I/O completion requests</span>
02184 
02185     <span class="keywordflow">for</span> ( ; ; ) {
02186 
02187         TimeOut.QuadPart = Int32x32To64( SleepTime, -10000 ) ;
02188 
02189         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/complete_8c.html#a5">NtRemoveIoCompletion</a>(
02190                     WorkerCompletionPort,
02191                     (PVOID) &amp;WorkerProc,
02192                     &amp;Overlapped,
02193                     &amp;IoSb,
02194                     &amp;TimeOut
02195                     ) ;
02196 
02197         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
02198 
02199 
02200             <a class="code" href="../../d3/d1/threads_8h.html#a82">TotalExecutedWorkRequests</a> ++ ;<span class="comment">//interlocked op not req</span>
02201             InterlockedIncrement(&amp;NumExecutingWorkerThreads) ;
02202             
02203             <span class="comment">// Call the work item. </span>
02204             <span class="comment">// If IO APC, context1 contains number of IO bytes transferred, and context2</span>
02205             <span class="comment">// contains the overlapped structure.</span>
02206             <span class="comment">// If (IO)WorkerFunction, context1 contains the actual WorkerFunction to be</span>
02207             <span class="comment">// executed and context2 contains the actual context</span>
02208 
02209             Context = (PVOID) IoSb.Information ;
02210 
02211             <span class="keywordflow">try</span> {
02212                 ((APC_CALLBACK_FUNCTION)WorkerProc) (
02213                                             IoSb.Status, 
02214                                             Context,        <span class="comment">// Number of IO bytes transferred</span>
02215                                             Overlapped      <span class="comment">// Overlapped structure</span>
02216                                             ) ;
02217             } except (EXCEPTION_EXECUTE_HANDLER) {
02218                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
02219             }
02220 
02221             SleepTime = <a class="code" href="../../d2/d1/threads_8c.html#a0">WORKER_IDLE_TIMEOUT</a> ;
02222 
02223             InterlockedDecrement(&amp;NumExecutingWorkerThreads) ;
02224 
02225         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT) {
02226 
02227             <span class="comment">// NtRemoveIoCompletion timed out. Check to see if have hit our limit</span>
02228             <span class="comment">// on waiting. If so terminate.</span>
02229 
02230             Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02231 
02232             RtlEnterCriticalSection (&amp;WorkerCriticalSection) ;
02233 
02234             <span class="comment">// The thread terminates if there are &gt; 1 threads and the queue is small</span>
02235             <span class="comment">// OR if there is only 1 thread and there is no request pending</span>
02236 
02237             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> &gt;  1) {
02238 
02239                 ULONG NumEffWorkerThreads = (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> - <a class="code" href="../../d3/d1/threads_8h.html#a80">NumLongWorkRequests</a>) ;
02240 
02241                 <span class="keywordflow">if</span> (NumEffWorkerThreads == 0) {
02242 
02243                     Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02244 
02245                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SleepTime &gt;= (<a class="code" href="../../d2/d1/threads_8c.html#a0">WORKER_IDLE_TIMEOUT</a> &lt;&lt; <a class="code" href="../../d2/d1/threads_8c.html#a1">MAX_WORKER_SLEEP_TIME_EXPONENT</a>)) {
02246 
02247                     <span class="comment">//</span>
02248                     <span class="comment">// have been idle for very long time. terminate irrespective of number of</span>
02249                     <span class="comment">// work items. (This is useful when the set of runnable threads is taking</span>
02250                     <span class="comment">// care of all the work items being queued). dont terminate if</span>
02251                     <span class="comment">// (NumEffWorkerThreads == 1)</span>
02252                     <span class="comment">//</span>
02253                     
02254                     <span class="keywordflow">if</span> (NumEffWorkerThreads &gt; 1)
02255                         Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02256 
02257                 } <span class="keywordflow">else</span> {
02258                 
02259                     ULONG Threshold ;
02260                     
02261                     <span class="comment">// Check if we need to shrink worker thread pool</span>
02262 
02263                     Threshold = NumEffWorkerThreads &lt; 7
02264                                 ? NumEffWorkerThreads*(NumEffWorkerThreads-1)
02265                                 : <a class="code" href="../../d3/d1/threads_8h.html#a8">NEW_THREAD_THRESHOLD</a> * (NumEffWorkerThreads-1);
02266 
02267 
02268                     
02269                     <span class="keywordflow">if</span>  (<a class="code" href="../../d3/d1/threads_8h.html#a79">NumWorkRequests</a>-<a class="code" href="../../d3/d1/threads_8h.html#a80">NumLongWorkRequests</a> &lt; Threshold)  {
02270 
02271                         Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02272 
02273                     } <span class="keywordflow">else</span> {
02274 
02275                         Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02276                         SleepTime &lt;&lt;= 1 ;
02277                     }
02278                 }
02279                 
02280             } <span class="keywordflow">else</span> {
02281 
02282                 <span class="keywordflow">if</span> ( (<a class="code" href="../../d3/d1/threads_8h.html#a76">NumMinWorkerThreads</a> == 0) &amp;&amp; (<a class="code" href="../../d3/d1/threads_8h.html#a79">NumWorkRequests</a> == 0) ) {
02283 
02284                     <span class="comment">// delay termination of last thread</span>
02285                     
02286                     <span class="keywordflow">if</span> (SleepTime &lt; (<a class="code" href="../../d2/d1/threads_8c.html#a0">WORKER_IDLE_TIMEOUT</a> &lt;&lt; <a class="code" href="../../d2/d1/threads_8c.html#a1">MAX_WORKER_SLEEP_TIME_EXPONENT</a>)) {
02287                         SleepTime &lt;&lt;= 1 ;
02288                         Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02289                     }
02290                     <span class="keywordflow">else</span> {
02291                         Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02292                     }
02293                     
02294                 } <span class="keywordflow">else</span> {
02295 
02296                     Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02297 
02298                 }
02299 
02300             }
02301 
02302             <span class="keywordflow">if</span> (Terminate) {
02303 
02304                 THREAD_BASIC_INFORMATION ThreadInfo;
02305                 ULONG IsIoPending ;
02306                 HANDLE CurThreadHandle ;
02307 
02308                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a4">NtDuplicateObject</a>(
02309                             NtCurrentProcess(),
02310                             NtCurrentThread(),
02311                             NtCurrentProcess(),
02312                             &amp;CurThreadHandle,
02313                             0,
02314                             FALSE,
02315                             DUPLICATE_SAME_ACCESS
02316                             ) ;
02317 
02318                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Status == STATUS_SUCCESS) ;
02319 
02320                 Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
02321 
02322                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/psquery_8c.html#a20">NtQueryInformationThread</a>( CurThreadHandle,
02323                                                    ThreadIsIoPending,
02324                                                    &amp;IsIoPending,
02325                                                    <span class="keyword">sizeof</span>( IsIoPending ),
02326                                                    NULL
02327                                                  );
02328                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
02329 
02330                     <span class="keywordflow">if</span> (! IsIoPending )
02331                         Terminate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
02332                 }
02333 
02334                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( CurThreadHandle ) ;
02335             }
02336             
02337             <span class="keywordflow">if</span> (Terminate) {
02338 
02339                 InterlockedDecrement (&amp;NumWorkerThreads) ;
02340 
02341                 RtlLeaveCriticalSection (&amp;WorkerCriticalSection) ;
02342 
02343                 <a class="code" href="../../d3/d1/threads_8h.html#a104">RtlpExitThreadFunc</a>( 0 );
02344 
02345             } <span class="keywordflow">else</span> {
02346 
02347                 <span class="comment">// This is the condition where a request was queued *after* the</span>
02348                 <span class="comment">// thread woke up - ready to terminate because of inactivity. In</span>
02349                 <span class="comment">// this case dont terminate - service the completion port.</span>
02350 
02351                 RtlLeaveCriticalSection (&amp;WorkerCriticalSection) ;
02352 
02353             }
02354 
02355         } <span class="keywordflow">else</span> {
02356 
02357             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE) ;
02358 
02359         }
02360 
02361     }
02362 
02363 
02364     <span class="keywordflow">return</span> 1 ;
02365 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="threads.c::RtlpWorkerThreadInitializeTimers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpWorkerThreadInitializeTimers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l02104">2104</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00944">RtlCreateTimer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00691">RtlCreateTimerQueue()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01872">RtlpWorkerThreadTimerCallback()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00237">WorkerThreadTimer</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00234">WorkerThreadTimerQueue</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l01965">RtlpInitializeWorkerThreadPool()</a>.
<p>
<pre class="fragment"><div>02107 {
02108     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02109     
02110 
02111     <span class="comment">// create a timer that will fire every 30 sec and check if new thread</span>
02112     <span class="comment">// should be created</span>
02113 
02114     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a10">RtlCreateTimerQueue</a>(&amp;WorkerThreadTimerQueue) ;
02115     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
02116         <span class="keywordflow">return</span> ;
02117     
02118     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a13">RtlCreateTimer</a>(
02119                         WorkerThreadTimerQueue,
02120                         &amp;WorkerThreadTimer,
02121                         RtlpWorkerThreadTimerCallback,
02122                         NULL,
02123                         30000,
02124                         30000,
02125                         WT_EXECUTEINTIMERTHREAD
02126                         ) ;
02127 
02128    <span class="keywordflow">return</span>;
02129 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="threads.c::RtlpWorkerThreadTimerCallback" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpWorkerThreadTimerCallback           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>NotUsed</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l01872">1872</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00276">MAX_WORKER_THREADS</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00275">NEW_THREAD_THRESHOLD</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00282">NtQueryIoCompletion()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00231">NumExecutingWorkerThreads</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00230">NumLongWorkRequests</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00225">NumWorkerThreads</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00233">OldTotalExecutedWorkRequests</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01763">RtlpStartWorkerThread()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00232">TotalExecutedWorkRequests</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00245">WorkerCompletionPort</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00255">WorkerCriticalSection</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l02104">RtlpWorkerThreadInitializeTimers()</a>.
<p>
<pre class="fragment"><div>01878                    :
01879 
01880     This routine checks <span class="keywordflow">if</span> <span class="keyword">new</span> worker thread has to be created
01881 
01882 Arguments:
01883     None
01884 
01885 Return Value:
01886     None
01887     
01888 --*/
01889 {
01890     IO_COMPLETION_BASIC_INFORMATION Info ;
01891     BOOLEAN bCreateThread = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
01892     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01893     ULONG QueueLength, Threshold, ShortWorkRequests ;
01894     
01895     
01896     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d4/complete_8c.html#a3">NtQueryIoCompletion</a>(
01897                 WorkerCompletionPort,
01898                 IoCompletionBasicInformation,
01899                 &amp;Info,
01900                 <span class="keyword">sizeof</span>(Info),
01901                 NULL
01902                 ) ;
01903 
01904     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
01905         <span class="keywordflow">return</span> ;
01906 
01907     QueueLength = Info.Depth ;
01908 
01909     <span class="keywordflow">if</span> (!QueueLength) {
01910         <a class="code" href="../../d3/d1/threads_8h.html#a83">OldTotalExecutedWorkRequests</a> = <a class="code" href="../../d3/d1/threads_8h.html#a82">TotalExecutedWorkRequests</a> ;
01911         <span class="keywordflow">return</span> ;
01912     }
01913 
01914 
01915     RtlEnterCriticalSection (&amp;WorkerCriticalSection) ;
01916 
01917     
01918     <span class="comment">// if there are queued work items and no new work items have been scheduled</span>
01919     <span class="comment">// in the last 30 seconds then create a new thread.</span>
01920     <span class="comment">// this will take care of deadlocks.</span>
01921 
01922     <span class="comment">// this will create a problem only if some thread is running for a long time</span>
01923     
01924     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a82">TotalExecutedWorkRequests</a> == <a class="code" href="../../d3/d1/threads_8h.html#a83">OldTotalExecutedWorkRequests</a>) {
01925 
01926         bCreateThread = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
01927     }
01928         
01929     
01930     <span class="comment">// if there are a lot of queued work items, then create a new thread</span>
01931     {
01932         ULONG NumEffWorkerThreads = (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> - <a class="code" href="../../d3/d1/threads_8h.html#a80">NumLongWorkRequests</a>) ;
01933         ULONG ShortWorkRequests ;
01934         
01935         Threshold = (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> &lt; <a class="code" href="../../d3/d1/threads_8h.html#a9">MAX_WORKER_THREADS</a>
01936                         ? (NumEffWorkerThreads &lt; 7
01937                             ? NumEffWorkerThreads*NumEffWorkerThreads
01938                             : <a class="code" href="../../d3/d1/threads_8h.html#a8">NEW_THREAD_THRESHOLD</a> * NumEffWorkerThreads )
01939                         : 0xffffffff) ;
01940 
01941         ShortWorkRequests = QueueLength + <a class="code" href="../../d3/d1/threads_8h.html#a81">NumExecutingWorkerThreads</a>
01942                                 - <a class="code" href="../../d3/d1/threads_8h.html#a80">NumLongWorkRequests</a> ;
01943 
01944         <span class="keywordflow">if</span> (ShortWorkRequests  &gt; Threshold)
01945         {
01946             bCreateThread = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
01947         }
01948     }
01949 
01950     <span class="keywordflow">if</span> (bCreateThread) {
01951 
01952         <a class="code" href="../../d2/d1/threads_8c.html#a21">RtlpStartWorkerThread</a> () ;
01953     }
01954 
01955 
01956     <a class="code" href="../../d3/d1/threads_8h.html#a83">OldTotalExecutedWorkRequests</a> = <a class="code" href="../../d3/d1/threads_8h.html#a82">TotalExecutedWorkRequests</a> ;
01957     
01958     RtlLeaveCriticalSection (&amp;WorkerCriticalSection) ;
01959 
01960 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="threads.c::RtlQueueWorkItem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlQueueWorkItem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN WORKERCALLBACKFUNC&nbsp;</td>
          <td class="mdname" nowrap> <em>Function</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l00437">437</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00210">CompletedWorkerInitialization</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00241">LastThreadCreationTickCount</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00276">MAX_WORKER_THREADS</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00275">NEW_THREAD_THRESHOLD</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d5/gettickc_8c-source.html#l00026">NtGetTickCount()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00224">NumIOWorkerThreads</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00227">NumIOWorkRequests</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00228">NumLongIOWorkRequests</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00230">NumLongWorkRequests</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00226">NumMinWorkerThreads</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00225">NumWorkerThreads</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00229">NumWorkRequests</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00244">PersistentIOTCB</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01965">RtlpInitializeWorkerThreadPool()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01638">RtlpQueueIOWorkerRequest()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01506">RtlpQueueWorkerRequest()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01820">RtlpStartIOWorkerThread()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01763">RtlpStartWorkerThread()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00272">THREAD_CREATION_DAMPING_TIME1</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00273">THREAD_CREATION_DAMPING_TIME2</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00255">WorkerCriticalSection</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/threads_8c-source.html#l03747">RtlpFireTimers()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01965">RtlpInitializeWorkerThreadPool()</a>, <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00260">RtlpLpcServerCallback()</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l03172">RtlpProcessWaitCompletion()</a>.
<p>
<pre class="fragment"><div>00445                    :
00446 
00447     This routine queues up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request to be executed in a worker thread.
00448 
00449 Arguments:
00450 
00451     Function - Routine that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> worker thread
00452 
00453     Context - Opaque pointer passed in as an argument to WorkerProc
00454 
00455     Flags - Can be:
00456 
00457             WT_EXECUTEINIOTHREAD - Specifies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> WorkerProc should be invoked
00458             by a thread that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> never destroyed when there are pending IO requests.
00459             This can be used by threads that invoke I/O and/or schedule APCs.
00460 
00461             The below flag can also be set:
00462             WT_EXECUTELONGFUNCTION - Specifies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function might block <span class="keywordflow">for</span> a
00463             <span class="keywordtype">long</span> duration.
00464 
00465 Return Value:
00466 
00467     STATUS_SUCCESS - Queued successfully.
00468 
00469     STATUS_NO_MEMORY - There was not sufficient heap to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00470         requested operation.
00471 
00472 --*/
00473 
00474 {
00475     ULONG Threshold ;
00476     ULONG CurrentTickCount ;
00477     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS ;
00478 
00479     
00480     <span class="comment">// Make sure the worker thread pool is initialized</span>
00481 
00482     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a65">CompletedWorkerInitialization</a> != 1) {
00483 
00484         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a24">RtlpInitializeWorkerThreadPool</a> () ;
00485         
00486         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) )
00487             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00488     }
00489 
00490        
00491     <span class="comment">// Take lock for the global worker thread pool</span>
00492 
00493     RtlEnterCriticalSection (&amp;WorkerCriticalSection) ;
00494 
00495 
00496     <span class="keywordflow">if</span> (Flags &amp; (WT_EXECUTEINIOTHREAD |WT_EXECUTEINUITHREAD |WT_EXECUTEINPERSISTENTIOTHREAD) ){
00497 
00498         <span class="comment">//</span>
00499         <span class="comment">// execute in IO Worker thread</span>
00500         <span class="comment">//</span>
00501 
00502         ULONG NumEffIOWorkerThreads = <a class="code" href="../../d3/d1/threads_8h.html#a74">NumIOWorkerThreads</a> - <a class="code" href="../../d3/d1/threads_8h.html#a78">NumLongIOWorkRequests</a> ;
00503         ULONG ThreadCreationDampingTime = <a class="code" href="../../d3/d1/threads_8h.html#a74">NumIOWorkerThreads</a> &lt; <a class="code" href="../../d3/d1/threads_8h.html#a8">NEW_THREAD_THRESHOLD</a>
00504                                             ? <a class="code" href="../../d3/d1/threads_8h.html#a5">THREAD_CREATION_DAMPING_TIME1</a>
00505                                             : <a class="code" href="../../d3/d1/threads_8h.html#a6">THREAD_CREATION_DAMPING_TIME2</a> ;
00506                                             
00507         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a90">PersistentIOTCB</a> &amp;&amp; (Flags&amp;WT_EXECUTELONGFUNCTION))
00508             NumEffIOWorkerThreads -- ;
00509 
00510         
00511         <span class="comment">// Check if we need to grow I/O worker thread pool</span>
00512 
00513         Threshold = (NumEffIOWorkerThreads &lt; <a class="code" href="../../d3/d1/threads_8h.html#a9">MAX_WORKER_THREADS</a> 
00514                     ? <a class="code" href="../../d3/d1/threads_8h.html#a8">NEW_THREAD_THRESHOLD</a> * NumEffIOWorkerThreads 
00515                     : 0xffffffff) ;
00516 
00517         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a88">LastThreadCreationTickCount</a> &gt; <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>())
00518             <a class="code" href="../../d3/d1/threads_8h.html#a88">LastThreadCreationTickCount</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() ;
00519 
00520         <span class="keywordflow">if</span> (NumEffIOWorkerThreads == 0
00521             || ((<a class="code" href="../../d3/d1/threads_8h.html#a77">NumIOWorkRequests</a> - <a class="code" href="../../d3/d1/threads_8h.html#a78">NumLongIOWorkRequests</a> &gt; Threshold)
00522                     &amp;&amp; (<a class="code" href="../../d3/d1/threads_8h.html#a88">LastThreadCreationTickCount</a> + ThreadCreationDampingTime 
00523                         &lt; <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>()))) {
00524 
00525             <span class="comment">// Grow the IO worker thread pool</span>
00526 
00527             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a22">RtlpStartIOWorkerThread</a> () ;
00528 
00529         }
00530 
00531         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
00532 
00533             <span class="comment">// Queue the work request</span>
00534 
00535             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a148">RtlpQueueIOWorkerRequest</a> (Function, Context, Flags) ;
00536         }
00537 
00538 
00539     } <span class="keywordflow">else</span> {
00540 
00541         <span class="comment">//</span>
00542         <span class="comment">// execute in regular worker thread</span>
00543         <span class="comment">//</span>
00544 
00545         ULONG NumEffWorkerThreads = (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> - <a class="code" href="../../d3/d1/threads_8h.html#a80">NumLongWorkRequests</a>) ;
00546         ULONG ThreadCreationDampingTime = <a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> &lt; <a class="code" href="../../d3/d1/threads_8h.html#a8">NEW_THREAD_THRESHOLD</a>
00547                                             ? <a class="code" href="../../d3/d1/threads_8h.html#a5">THREAD_CREATION_DAMPING_TIME1</a>
00548                                             : (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> &lt; 50
00549                                                 ? <a class="code" href="../../d3/d1/threads_8h.html#a6">THREAD_CREATION_DAMPING_TIME2</a>
00550                                                 : <a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> &lt;&lt; 7); <span class="comment">// *100ms</span>
00551 
00552         <span class="comment">// if io completion set, then have 1 more thread</span>
00553         
00554         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a76">NumMinWorkerThreads</a> &amp;&amp; NumEffWorkerThreads)
00555             NumEffWorkerThreads -- ;
00556 
00557 
00558         <span class="comment">// Check if we need to grow worker thread pool</span>
00559 
00560         Threshold = (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> &lt; <a class="code" href="../../d3/d1/threads_8h.html#a9">MAX_WORKER_THREADS</a> 
00561                     ? (NumEffWorkerThreads &lt; 7 
00562                         ? NumEffWorkerThreads*NumEffWorkerThreads
00563                         : <a class="code" href="../../d3/d1/threads_8h.html#a8">NEW_THREAD_THRESHOLD</a> * NumEffWorkerThreads )
00564                     : 0xffffffff) ;
00565 
00566         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a88">LastThreadCreationTickCount</a> &gt; <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>())
00567             <a class="code" href="../../d3/d1/threads_8h.html#a88">LastThreadCreationTickCount</a> = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() ;
00568 
00569         <span class="keywordflow">if</span> (NumEffWorkerThreads == 0 ||
00570             ( (<a class="code" href="../../d3/d1/threads_8h.html#a79">NumWorkRequests</a> - <a class="code" href="../../d3/d1/threads_8h.html#a80">NumLongWorkRequests</a> &gt;= Threshold)
00571                     &amp;&amp; (<a class="code" href="../../d3/d1/threads_8h.html#a88">LastThreadCreationTickCount</a> + ThreadCreationDampingTime 
00572                             &lt; <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>()))) 
00573         {
00574 
00575             <span class="comment">// Grow the worker thread pool</span>
00576 
00577             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a21">RtlpStartWorkerThread</a> () ;
00578 
00579         } 
00580 
00581         <span class="comment">// Queue the work request</span>
00582 
00583         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
00584 
00585             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a152">RtlpQueueWorkerRequest</a> (Function, Context, Flags) ;
00586         }
00587 
00588     }
00589 
00590     <span class="comment">// Release lock on the worker thread pool</span>
00591 
00592     RtlLeaveCriticalSection (&amp;WorkerCriticalSection) ;
00593 
00594     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00595 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="threads.c::RtlRegisterWait" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlRegisterWait           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>WaitHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN WAITORTIMERCALLBACKFUNC&nbsp;</td>
          <td class="mdname" nowrap> <em>Function</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Milliseconds</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l00077">77</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00213">CompletedWaitInitialization</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00122">_RTLP_WAIT::Context</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00125">_RTLP_WAIT::DbgId</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00406">DPRN0</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00120">_RTLP_WAIT::Flags</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00121">_RTLP_WAIT::Function</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00104">NextWaitDbgId</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00056">NtQueueApcThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d1/threads_8h.html#a61">PRTLP_EVENT</a>, <a class="el" href="../../d3/d1/threads_8h.html#a51">PRTLP_WAIT</a>, <a class="el" href="../../d3/d1/threads_8h.html#a53">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a>, <a class="el" href="../../d3/d1/threads_8h.html#a50">RTLP_WAIT</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03302">RtlpAddWait()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00305">RtlpAllocateTPHeap</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03851">RtlpFindWaitThread()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00302">RtlpFreeTPHeap</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02751">RtlpInitializeWaitThreadPool()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00395">SET_SIGNATURE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00114">_RTLP_WAIT::ThreadCB</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00139">_RTLP_WAIT_THREAD_CONTROL_BLOCK::ThreadHandle</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00126">_RTLP_WAIT::ThreadId</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00123">_RTLP_WAIT::Timeout</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00115">_RTLP_WAIT::WaitHandle</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00463">RtlCreateLpcServer()</a>, and <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00260">RtlpLpcServerCallback()</a>.
<p>
<pre class="fragment"><div>00088                    :
00089 
00090     This routine adds a <span class="keyword">new</span> wait request to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> of objects being waited on.
00091 
00092 Arguments:
00093 
00094     WaitHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> returned on successful completion of <span class="keyword">this</span> routine.
00095 
00096     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object to be waited on
00097 
00098     Function - Routine that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait completes or a timeout occurs
00099 
00100     Context - Opaque pointer passed in as an argument to Function
00101 
00102     Milliseconds - Timeout <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait in milliseconds. 0xffffffff means dont 
00103             timeout.
00104 
00105     Flags - Can be one of:
00106 
00107         WT_EXECUTEINWAITTHREAD - <span class="keywordflow">if</span> WorkerProc should be invoked in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait
00108                 thread itself. This should <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be used <span class="keywordflow">for</span> small <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>.
00109         WT_EXECUTEINIOTHREAD - use <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> WorkerProc should be invoked in
00110                 an IO Worker thread. Avoid <span class="keyword">using</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00111 
00112     If Flags <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not WT_EXECUTEINWAITTHREAD, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following flag can also be set:
00113     
00114         WT_EXECUTELONGFUNCTION - indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback might be blocked
00115                 <span class="keywordflow">for</span> a <span class="keywordtype">long</span> duration. Use <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being queued to a
00116                 worker thread.
00117     
00118 Return Value:
00119 
00120     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call.  The following are returned
00121 
00122     STATUS_SUCCESS - The registration was successful.
00123 
00124     STATUS_NO_MEMORY - There was not sufficient heap to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested 
00125                 operation.
00126                 
00127     or other <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> error code
00128 
00129 --*/
00130 
00131 {
00132     <a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a> Wait ;
00133     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00134     <a class="code" href="../../d0/d6/struct__RTLP__EVENT.html">PRTLP_EVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> ;
00135     LARGE_INTEGER TimeOut ;
00136     <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCB = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00137 
00138     *WaitHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00139 
00140     
00141     <span class="comment">// Initialize thread pool if it isnt already done</span>
00142 
00143     <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d1/threads_8h.html#a67">CompletedWaitInitialization</a> != 1) {
00144 
00145         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a32">RtlpInitializeWaitThreadPool</a> () ;
00146 
00147         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) )
00148             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00149     }
00150 
00151 
00152     <span class="comment">// Initialize Wait request</span>
00153 
00154     Wait = (<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">PRTLP_WAIT</a>) <a class="code" href="../../d3/d1/threads_8h.html#a18">RtlpAllocateTPHeap</a> ( <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html">RTLP_WAIT</a>),
00155                                             HEAP_ZERO_MEMORY) ;
00156 
00157     <span class="keywordflow">if</span> (!Wait) {
00158         <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
00159     }
00160     
00161     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o1">WaitHandle</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> ;
00162     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o6">Flags</a> = Flags ;
00163     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o7">Function</a> = Function ;
00164     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o8">Context</a> = Context ;
00165     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o9">Timeout</a> = Milliseconds ;
00166     <a class="code" href="../../d3/d1/threads_8h.html#a28">SET_SIGNATURE</a>(Wait) ;
00167         
00168     
00169     <span class="comment">// timer part of wait is initialized by wait thread in RtlpAddWait</span>
00170 
00171     
00172     <span class="comment">// Get a wait thread that can accomodate another wait request.</span>
00173     
00174     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d1/threads_8h.html#a145">RtlpFindWaitThread</a> (&amp;ThreadCB) ;
00175 
00176     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00177     
00178         <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( Wait ) ;
00179         
00180         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00181     }
00182 
00183     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o0">ThreadCB</a> = ThreadCB ;
00184 
00185 <span class="preprocessor">    #if DBG1</span>
00186 <span class="preprocessor"></span>    Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o10">DbgId</a> = ++<a class="code" href="../../d3/d1/threads_8h.html#a49">NextWaitDbgId</a> ;
00187     Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o11">ThreadId</a> = HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
00188     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a34">DPRN0</a>)
00189     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d:%d&gt; Wait %x created by thread:&lt;%x:%x&gt;\n\n"</span>, 
00190                 Wait-&gt;<a class="code" href="../../d2/d7/struct__RTLP__WAIT.html#o10">DbgId</a>, 1, (ULONG_PTR)Wait,
00191                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
00192                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
00193 <span class="preprocessor">    #endif</span>
00194 <span class="preprocessor"></span>
00195     <span class="comment">// Set the wait handle</span>
00196 
00197     *WaitHandle = Wait ;
00198 
00199 
00200     <span class="comment">// Queue an APC to the Wait Thread</span>
00201 
00202     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
00203                     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o1">ThreadHandle</a>,
00204                     (PPS_APC_ROUTINE)RtlpAddWait,
00205                     (PVOID)Wait,
00206                     NULL,
00207                     NULL
00208                     );
00209 
00210 
00211     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00212 
00213         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS ;
00214 
00215     } <span class="keywordflow">else</span> {
00216 
00217         *WaitHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00218         <a class="code" href="../../d3/d1/threads_8h.html#a17">RtlpFreeTPHeap</a>( Wait ) ;
00219     }
00220 
00221     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00222 
00223 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="threads.c::RtlSetIoCompletionCallback" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlSetIoCompletionCallback           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN APC_CALLBACK_FUNCTION&nbsp;</td>
          <td class="mdname" nowrap> <em>CompletionProc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l00600">600</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00210">CompletedWorkerInitialization</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00226">NumMinWorkerThreads</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00225">NumWorkerThreads</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01965">RtlpInitializeWorkerThreadPool()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01763">RtlpStartWorkerThread()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00245">WorkerCompletionPort</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00255">WorkerCriticalSection</a>.
<p>
<pre class="fragment"><div>00608                    :
00609 
00610     This routine binds an <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> and an associated callback function to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00611     IoCompletionPort which queues work items to worker threads.
00612 
00613 Arguments:
00614 
00615     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - handle to be bound to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IO completion port
00616     
00617     CompletionProc - callback function to be executed when an IO request
00618         pending on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IO handle completes.
00619 
00620     Flags - Reserved. pass 0.
00621 
00622 --*/
00623 
00624 {
00625     IO_STATUS_BLOCK IoSb ;
00626     FILE_COMPLETION_INFORMATION CompletionInfo ;
00627     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00628     
00629 
00630     <span class="comment">// Make sure that the worker thread pool is initialized as the file handle</span>
00631     <span class="comment">// is bound to IO completion port.</span>
00632 
00633     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a65">CompletedWorkerInitialization</a> != 1) {
00634 
00635         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a24">RtlpInitializeWorkerThreadPool</a> () ;
00636         
00637         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) )
00638             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00639 
00640     }
00641 
00642 
00643     <span class="comment">//</span>
00644     <span class="comment">// from now on NumMinWorkerThreads should be 1. If there is only 1 worker thread</span>
00645     <span class="comment">// create a new one.</span>
00646     <span class="comment">//</span>
00647     
00648     <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d1/threads_8h.html#a76">NumMinWorkerThreads</a> == 0 ) {
00649     
00650         <span class="comment">// Take lock for the global worker thread pool</span>
00651 
00652         RtlEnterCriticalSection (&amp;WorkerCriticalSection) ;
00653 
00654         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> == 0) {
00655 
00656             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d1/threads_8c.html#a21">RtlpStartWorkerThread</a> () ;
00657 
00658             <span class="keywordflow">if</span> ( ! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00659             
00660                 RtlLeaveCriticalSection (&amp;WorkerCriticalSection) ;
00661                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00662             }
00663         }
00664 
00665         <span class="comment">// from now on, there will be at least 1 worker thread</span>
00666         <a class="code" href="../../d3/d1/threads_8h.html#a76">NumMinWorkerThreads</a> = 1 ;
00667         
00668         RtlLeaveCriticalSection (&amp;WorkerCriticalSection) ;
00669 
00670     }
00671 
00672 
00673     <span class="comment">// bind to IoCompletionPort, which queues work items to worker threads</span>
00674 
00675     CompletionInfo.Port = <a class="code" href="../../d3/d1/threads_8h.html#a91">WorkerCompletionPort</a> ;
00676     CompletionInfo.Key = (PVOID) CompletionProc ;
00677 
00678     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d2/qsinfo_8c.html#a4">NtSetInformationFile</a> (
00679                         FileHandle,
00680                         &amp;IoSb, <span class="comment">//not initialized</span>
00681                         &amp;CompletionInfo,
00682                         <span class="keyword">sizeof</span>(CompletionInfo),
00683                         FileCompletionInformation <span class="comment">//enum flag</span>
00684                         ) ;
00685     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
00686 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="threads.c::RtlSetThreadPoolStartFunc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NTAPI RtlSetThreadPoolStartFunc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PRTLP_START_THREAD&nbsp;</td>
          <td class="mdname" nowrap> <em>StartFunc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PRTLP_EXIT_THREAD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExitFunc</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l01291">1291</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00263">RtlpExitThreadFunc</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00261">RtlpStartThreadFunc</a>.
<p>
<pre class="fragment"><div>01297                    :
01298 
01299     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>'s thread creation function.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
01300     thread safe, because <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> intended solely <span class="keywordflow">for</span> kernel32 to call <span class="keywordflow">for</span> processes
01301     that aren'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> csrss/smss.
01302 
01303 Arguments:
01304 
01305     StartFunc - Function to create a <span class="keyword">new</span> thread
01306 
01307 Return Value:
01308 
01309 --*/
01310 
01311 {
01312     <a class="code" href="../../d3/d1/threads_8h.html#a102">RtlpStartThreadFunc</a> = StartFunc ;
01313     <a class="code" href="../../d3/d1/threads_8h.html#a104">RtlpExitThreadFunc</a> = ExitFunc ;
01314     <span class="keywordflow">return</span> STATUS_SUCCESS ;
01315 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a73" doxytag="threads.c::RtlSetTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlSetTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerQueueHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT HANDLE *&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN WAITORTIMERCALLBACKFUNC&nbsp;</td>
          <td class="mdname" nowrap> <em>Function</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DueTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Period</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l05818">5818</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, and <a class="el" href="../../d3/d0/threads_8c-source.html#l00944">RtlCreateTimer()</a>.
<p>
<pre class="fragment"><div>05827 {
05828     <span class="keyword">static</span> ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
05829     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++ ==0) {
05830         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Using obsolete function call: RtlSetTimer\n"</span>);
05831         DbgBreakPoint();
05832         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Using obsolete function call: RtlSetTimer\n"</span>);
05833     }
05834     
05835     <span class="keywordflow">return</span> <a class="code" href="../../d2/d1/threads_8c.html#a13">RtlCreateTimer</a>(TimerQueueHandle,
05836                             Handle,
05837                             Function,
05838                             Context,
05839                             DueTime,
05840                             Period,
05841                             Flags
05842                             ) ;
05843 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="threads.c::RtlThreadPoolCleanup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlThreadPoolCleanup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Flags</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l01320">1320</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d4/d0/threads_8h-source.html#l00320">ACQUIRE_GLOBAL_TIMER_LOCK</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00310">ACQUIRE_GLOBAL_WAIT_LOCK</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00147">ASSERTMSG</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00216">CompletedTimerInitialization</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00213">CompletedWaitInitialization</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00210">CompletedWorkerInitialization</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00243">IOWorkerThreads</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00328">IS_COMPONENT_INITIALIZED</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00165">_RTLP_IOWORKER_TCB::List</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00056">NtQueueApcThread()</a>, <a class="el" href="../../d6/d3/complete_8c-source.html#l00417">NtSetIoCompletion()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00224">NumIOWorkerThreads</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00227">NumIOWorkRequests</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00253">NumTimerQueues</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00142">_RTLP_WAIT_THREAD_CONTROL_BLOCK::NumWaits</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00225">NumWorkerThreads</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00229">NumWorkRequests</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00323">RELEASE_GLOBAL_TIMER_LOCK</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00313">RELEASE_GLOBAL_WAIT_LOCK</a>, <a class="el" href="../../d3/d1/threads_8h.html#a54">RTLP_IOWORKER_TCB</a>, <a class="el" href="../../d3/d1/threads_8h.html#a52">RTLP_WAIT_THREAD_CONTROL_BLOCK</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05484">RtlpThreadCleanup()</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00215">StartedTimerInitialization</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00212">StartedWaitInitialization</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00209">StartedWorkerInitialization</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00139">_RTLP_WAIT_THREAD_CONTROL_BLOCK::ThreadHandle</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00166">_RTLP_IOWORKER_TCB::ThreadHandle</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00221">TimerThreadHandle</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00247">WaitThreads</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00137">_RTLP_WAIT_THREAD_CONTROL_BLOCK::WaitThreadsList</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00245">WorkerCompletionPort</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00255">WorkerCriticalSection</a>.
<p>
<pre class="fragment"><div>01325                    :
01326     This routine cleans up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01327 
01328 Arguments:
01329 
01330     None
01331     
01332 Return Value:
01333 
01334     STATUS_SUCCESS : <span class="keywordflow">if</span> none of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> components are in use.
01335     STATUS_UNSUCCESSFUL : <span class="keywordflow">if</span> some components are still in use.
01336 
01337 --*/
01338 {
01339     BOOLEAN Cleanup ;
01340     PLIST_ENTRY Node ;
01341     ULONG i ;
01342     HANDLE TmpHandle ;
01343     
01344     <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01345     
01346     <span class="comment">// cleanup timer thread</span>
01347     
01348     <a class="code" href="../../d3/d1/threads_8h.html#a23">IS_COMPONENT_INITIALIZED</a>(StartedTimerInitialization, 
01349                             CompletedTimerInitialization,
01350                             Cleanup ) ;
01351 
01352     <span class="keywordflow">if</span> ( Cleanup ) {
01353 
01354         <a class="code" href="../../d3/d1/threads_8h.html#a21">ACQUIRE_GLOBAL_TIMER_LOCK</a>() ;
01355         
01356         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a96">NumTimerQueues</a> != 0 ) {
01357         
01358             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>( FALSE,
01359                 <span class="stringliteral">"Trying to deinitialize ThreadPool when timers exist\n"</span> ) ;
01360             <a class="code" href="../../d3/d1/threads_8h.html#a22">RELEASE_GLOBAL_TIMER_LOCK</a>() ;
01361 
01362             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL ;
01363         }
01364         
01365         <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
01366                 TimerThreadHandle,
01367                 (PPS_APC_ROUTINE)RtlpThreadCleanup,
01368                 NULL,
01369                 NULL,
01370                 NULL
01371                 );
01372 
01373         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( TimerThreadHandle ) ;
01374         <a class="code" href="../../d3/d1/threads_8h.html#a72">TimerThreadHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
01375 
01376         <a class="code" href="../../d3/d1/threads_8h.html#a22">RELEASE_GLOBAL_TIMER_LOCK</a>() ;
01377 
01378     }
01379 
01380 
01381     <span class="comment">//</span>
01382     <span class="comment">// cleanup wait threads</span>
01383     <span class="comment">//</span>
01384 
01385     <a class="code" href="../../d3/d1/threads_8h.html#a23">IS_COMPONENT_INITIALIZED</a>(StartedWaitInitialization, 
01386                             CompletedWaitInitialization,
01387                             Cleanup ) ;
01388 
01389     <span class="keywordflow">if</span> ( Cleanup ) {
01390 
01391         <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">PRTLP_WAIT_THREAD_CONTROL_BLOCK</a> ThreadCB ;
01392 
01393         <a class="code" href="../../d3/d1/threads_8h.html#a19">ACQUIRE_GLOBAL_WAIT_LOCK</a>() ;
01394 
01395         <span class="comment">// Queue an APC to all Wait Threads</span>
01396         
01397         <span class="keywordflow">for</span> (Node = <a class="code" href="../../d3/d1/threads_8h.html#a92">WaitThreads</a>.Flink ; Node != &amp;<a class="code" href="../../d3/d1/threads_8h.html#a92">WaitThreads</a> ; 
01398                 Node = Node-&gt;Flink) 
01399         {
01400 
01401             ThreadCB = CONTAINING_RECORD(Node, 
01402                                 <a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html">RTLP_WAIT_THREAD_CONTROL_BLOCK</a>,
01403                                 WaitThreadsList) ;
01404 
01405             <span class="keywordflow">if</span> ( ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o3">NumWaits</a> != 0 ) {
01406 
01407                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>( FALSE,
01408                     <span class="stringliteral">"Cannot cleanup ThreadPool. Registered Wait events exist."</span> ) ;
01409                 <a class="code" href="../../d3/d1/threads_8h.html#a20">RELEASE_GLOBAL_WAIT_LOCK</a>( ) ;
01410                 
01411                 <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL ;
01412             }
01413 
01414             RemoveEntryList( &amp;ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o0">WaitThreadsList</a> ) ;
01415             TmpHandle = ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o1">ThreadHandle</a> ;
01416             
01417             <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
01418                     ThreadCB-&gt;<a class="code" href="../../d3/d7/struct__RTLP__WAIT__THREAD__CONTROL__BLOCK.html#o1">ThreadHandle</a>,
01419                     (PPS_APC_ROUTINE)RtlpThreadCleanup,
01420                     NULL,
01421                     NULL,
01422                     NULL
01423                     );
01424 
01425             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( TmpHandle ) ;
01426         }
01427 
01428         <a class="code" href="../../d3/d1/threads_8h.html#a20">RELEASE_GLOBAL_WAIT_LOCK</a>( ) ;
01429 
01430     }
01431 
01432 
01433     <span class="comment">// cleanup worker threads</span>
01434 
01435     <a class="code" href="../../d3/d1/threads_8h.html#a23">IS_COMPONENT_INITIALIZED</a>( StartedWorkerInitialization, 
01436                             CompletedWorkerInitialization,
01437                             Cleanup ) ;
01438                                 
01439     <span class="keywordflow">if</span> ( Cleanup ) {
01440 
01441         RtlEnterCriticalSection (&amp;WorkerCriticalSection) ;
01442 
01443         <span class="keywordflow">if</span> ( (<a class="code" href="../../d3/d1/threads_8h.html#a79">NumWorkRequests</a> != 0) || (<a class="code" href="../../d3/d1/threads_8h.html#a77">NumIOWorkRequests</a> != 0) ) {
01444 
01445             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>( FALSE,
01446                 <span class="stringliteral">"Cannot cleanup ThreadPool. Work requests pending."</span> ) ;
01447 
01448             RtlLeaveCriticalSection (&amp;WorkerCriticalSection) ;
01449             
01450             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL ;
01451         }
01452         
01453         <span class="comment">// queue a cleanup for each worker thread</span>
01454         
01455         <span class="keywordflow">for</span> (i = 0 ;  i &lt; <a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> ; i ++ ) {
01456 
01457             <a class="code" href="../../d5/d4/complete_8c.html#a4">NtSetIoCompletion</a> (
01458                     WorkerCompletionPort,
01459                     RtlpThreadCleanup,
01460                     NULL,
01461                     STATUS_SUCCESS,
01462                     0
01463                     );
01464         }
01465 
01466         <span class="comment">// queue an apc to cleanup all IO worker threads</span>
01467 
01468         <span class="keywordflow">for</span> (Node = <a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a>.Flink ; Node != &amp;<a class="code" href="../../d3/d1/threads_8h.html#a89">IOWorkerThreads</a> ;
01469                 Node = Node-&gt;Flink )
01470         {
01471             <a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html">PRTLP_IOWORKER_TCB</a> ThreadCB ;
01472             
01473             ThreadCB = CONTAINING_RECORD (Node, <a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html">RTLP_IOWORKER_TCB</a>, List) ;
01474             RemoveEntryList( &amp;ThreadCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o0">List</a>) ;
01475             TmpHandle = ThreadCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o1">ThreadHandle</a> ;
01476 
01477             <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a>(
01478                    ThreadCB-&gt;<a class="code" href="../../d6/d6/struct__RTLP__IOWORKER__TCB.html#o1">ThreadHandle</a>,
01479                    (PPS_APC_ROUTINE)RtlpThreadCleanup,
01480                    NULL,
01481                    NULL,
01482                    NULL
01483                    );
01484 
01485             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( TmpHandle ) ;
01486         }
01487 
01488         <a class="code" href="../../d3/d1/threads_8h.html#a75">NumWorkerThreads</a> = <a class="code" href="../../d3/d1/threads_8h.html#a74">NumIOWorkerThreads</a> = 0 ;
01489 
01490         RtlLeaveCriticalSection (&amp;WorkerCriticalSection) ;
01491 
01492     }
01493 
01494     <span class="keywordflow">return</span> STATUS_SUCCESS ;
01495 
01496 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="threads.c::RtlUpdateTimer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlUpdateTimer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerQueueHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Timer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DueTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Period</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l01058">1058</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00398">CHECK_DEL_SIGNATURE</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00407">DPRN1</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00056">NtQueueApcThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00045">PRTLP_TIMER</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00044">RTLP_TIMER</a>, <a class="el" href="../../d4/d0/threads_8h-source.html#l00305">RtlpAllocateTPHeap</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l04044">RtlpUpdateTimer()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d0/threads_8h-source.html#l00221">TimerThreadHandle</a>.
<p>
<pre class="fragment"><div>01066                    :
01067 
01068     This routine updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer
01069 
01070 Arguments:
01071 
01072     TimerQueueHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> identifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue in which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer to be updated exists
01073 
01074     Timer - Specifies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer which needs to be updated
01075 
01076     DueTime - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time in milliseconds after which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer fires.
01077 
01078     Period - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> period of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer in milliseconds. This should be 
01079             0 <span class="keywordflow">for</span> one shot requests.
01080 
01081 Return Value:
01082 
01083     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call.  The following are returned
01084 
01085         STATUS_SUCCESS - Timer updated successfully.
01086 
01087 --*/
01088 {
01089     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01090     <a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a> TmpTimer ;
01091 
01092     <span class="keywordflow">if</span> (!TimerQueueHandle || !Timer) {
01093         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FALSE ) ;
01094         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER ;
01095     }
01096 
01097     <a class="code" href="../../d3/d1/threads_8h.html#a31">CHECK_DEL_SIGNATURE</a>( (PRTLP_TIMER)Timer ) ;
01098 
01099     
01100     TmpTimer = (<a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a>) <a class="code" href="../../d3/d1/threads_8h.html#a18">RtlpAllocateTPHeap</a> (
01101                                         <span class="keyword">sizeof</span> (RTLP_TIMER),
01102                                         0
01103                                         ) ;
01104 
01105     <span class="keywordflow">if</span> (TmpTimer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01106 
01107         <span class="keywordflow">return</span> STATUS_NO_MEMORY ;
01108     }
01109 
01110     TmpTimer-&gt;DeltaFiringTime = DueTime;
01111     <span class="comment">//todo:remove below</span>
01112     <span class="keywordflow">if</span> (Period==-1) Period = 0;
01113     TmpTimer-&gt;Period = Period ;
01114 
01115 <span class="preprocessor">    #if DBG1</span>
01116 <span class="preprocessor"></span>    ((<a class="code" href="../../d3/d1/threads_8h.html#a2">PRTLP_TIMER</a>)Timer)-&gt;ThreadId2 = 
01117                     HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread) ;
01118 <span class="preprocessor">    #endif</span>
01119 <span class="preprocessor"></span><span class="preprocessor">    #if DBG1</span>
01120 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/threads_8h.html#a35">DPRN1</a>)
01121     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"&lt;%d:%d:%d&gt; Timer: updated by Thread:&lt;%x:%x&gt;\n\n"</span>, 
01122                 ((PRTLP_TIMER)Timer)-&gt;Queue-&gt;DbgId, 
01123                 ((PRTLP_TIMER)Timer)-&gt;DbgId, ((PRTLP_TIMER)Timer)-&gt;RefCount,
01124                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueThread),
01125                 HandleToUlong(NtCurrentTeb()-&gt;ClientId.UniqueProcess)) ;
01126 <span class="preprocessor">    #endif</span>
01127 <span class="preprocessor"></span>
01128 
01129     <span class="comment">// queue APC to update timer</span>
01130     
01131     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a1">NtQueueApcThread</a> (
01132                     TimerThreadHandle,
01133                     (PPS_APC_ROUTINE)RtlpUpdateTimer,
01134                     (PVOID)Timer, <span class="comment">//Actual timer</span>
01135                     (PVOID)TmpTimer,
01136                     NULL
01137                     );
01138 
01139 
01140     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01141 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a4" doxytag="threads.c::DPRN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d1/threads_8c.html#a4">DPRN</a> = 0x0000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/threads_8c-source.html#l00072">72</a> of file <a class="el" href="../../d3/d0/threads_8c-source.html">threads.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:45 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
