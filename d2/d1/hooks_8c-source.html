<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hooks.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hooks.c</h1><a href="../../d1/d2/hooks_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: hooks.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains the user hook APIs and support routines.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 01-28-91 DavidPe      Created.</span>
00010 <span class="comment">* 08 Feb 1992 IanJa     Unicode/ANSI aware &amp; neutral</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 <span class="comment">/*</span>
00017 <span class="comment"> * This table is used to determine whether a particular hook</span>
00018 <span class="comment"> * can be set for the system or a task, and other hook-ID specific things.</span>
00019 <span class="comment"> */</span>
<a name="l00020"></a><a class="code" href="../../d1/d2/hooks_8c.html#a0">00020</a> <span class="preprocessor">#define HKF_SYSTEM          0x01</span>
<a name="l00021"></a><a class="code" href="../../d1/d2/hooks_8c.html#a1">00021</a> <span class="preprocessor"></span><span class="preprocessor">#define HKF_TASK            0x02</span>
<a name="l00022"></a><a class="code" href="../../d1/d2/hooks_8c.html#a2">00022</a> <span class="preprocessor"></span><span class="preprocessor">#define HKF_JOURNAL         0x04    // JOURNAL the mouse on set</span>
<a name="l00023"></a><a class="code" href="../../d1/d2/hooks_8c.html#a3">00023</a> <span class="preprocessor"></span><span class="preprocessor">#define HKF_NZRET           0x08    // Always return NZ hook for &lt;=3.0 compatibility</span>
<a name="l00024"></a><a class="code" href="../../d1/d2/hooks_8c.html#a4">00024</a> <span class="preprocessor"></span><span class="preprocessor">#define HKF_INTERSENDABLE   0x10    // OK to call hookproc in context of hooking thread</span>
<a name="l00025"></a><a class="code" href="../../d1/d2/hooks_8c.html#a5">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define HKF_LOWLEVEL        0x20    // Low level hook</span>
00026 <span class="preprocessor"></span>
<a name="l00027"></a><a class="code" href="../../d1/d2/hooks_8c.html#a8">00027</a> CONST <span class="keywordtype">int</span> <a class="code" href="../../d1/d2/hooks_8c.html#a8">ampiHookError</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a530">CWINHOOKS</a>] = {
00028     0,                                   <span class="comment">// WH_MSGFILTER (-1)</span>
00029     0,                                   <span class="comment">// WH_JOURNALRECORD 0</span>
00030     -1,                                  <span class="comment">// WH_JOURNALPLAYBACK 1</span>
00031     0,                                   <span class="comment">// WH_KEYBOARD 2</span>
00032     0,                                   <span class="comment">// WH_GETMESSAGE 3</span>
00033     0,                                   <span class="comment">// WH_CALLWNDPROC 4</span>
00034     0,                                   <span class="comment">// WH_CBT 5</span>
00035     0,                                   <span class="comment">// WH_SYSMSGFILTER 6</span>
00036     0,                                   <span class="comment">// WH_MOUSE 7</span>
00037     0,                                   <span class="comment">// WH_HARDWARE 8</span>
00038     0,                                   <span class="comment">// WH_DEBUG 9</span>
00039     0,                                   <span class="comment">// WH_SHELL 10</span>
00040     0,                                   <span class="comment">// WH_FOREGROUNDIDLE 11</span>
00041     0,                                   <span class="comment">// WH_CALLWNDPROCRET 12</span>
00042     0,                                   <span class="comment">// WH_KEYBOARD_LL 13</span>
00043     0                                    <span class="comment">// WH_MOUSE_LL 14</span>
00044 <span class="preprocessor">#ifdef REDIRECTION</span>
00045 <span class="preprocessor"></span>   ,0                                    <span class="comment">// WH_HITTEST</span>
00046 <span class="preprocessor">#endif // REDIRECTION</span>
00047 <span class="preprocessor"></span>};
00048 
<a name="l00049"></a><a class="code" href="../../d1/d2/hooks_8c.html#a9">00049</a> CONST <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a530">CWINHOOKS</a>] = {
00050     <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a3">HKF_NZRET</a>                       , <span class="comment">// WH_MSGFILTER (-1)</span>
00051     <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a>          | <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>   , <span class="comment">// WH_JOURNALRECORD 0</span>
00052     <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a>          | <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>   , <span class="comment">// WH_JOURNALPLAYBACK 1</span>
00053     <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a3">HKF_NZRET</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>   , <span class="comment">// WH_KEYBOARD 2</span>
00054     <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>                                   , <span class="comment">// WH_GETMESSAGE 3</span>
00055     <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>                                   , <span class="comment">// WH_CALLWNDPROC 4</span>
00056     <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>                                   , <span class="comment">// WH_CBT 5</span>
00057     <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a>                                              , <span class="comment">// WH_SYSMSGFILTER 6</span>
00058     <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>             | <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>   , <span class="comment">// WH_MOUSE 7</span>
00059     <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>                                   , <span class="comment">// WH_HARDWARE 8</span>
00060     <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>                                   , <span class="comment">// WH_DEBUG 9</span>
00061     <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>                                   , <span class="comment">// WH_SHELL 10</span>
00062     <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>                                   , <span class="comment">// WH_FOREGROUNDIDLE 11</span>
00063     <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>                                   , <span class="comment">// WH_CALLWNDPROCRET 12</span>
00064     <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a5">HKF_LOWLEVEL</a>         | <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>   , <span class="comment">// WH_KEYBOARD_LL 13</span>
00065     <a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a5">HKF_LOWLEVEL</a>         | <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>     <span class="comment">// WH_MOUSE_LL 14</span>
00066 
00067 <span class="preprocessor">#ifdef REDIRECTION</span>
00068 <span class="preprocessor"></span>   ,<a class="code" href="../../d1/d2/hooks_8c.html#a0">HKF_SYSTEM</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a5">HKF_LOWLEVEL</a>         | <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>     <span class="comment">// WH_HITTEST 15</span>
00069 <span class="preprocessor">#endif // REDIRECTION</span>
00070 <span class="preprocessor"></span>};
00071 
00072 
00073 <span class="comment">/*</span>
00074 <span class="comment"> * HACK (hiroyama) see xxxCallJournalPlaybackHook()</span>
00075 <span class="comment"> * Optimization: faster determination whether the message is one of</span>
00076 <span class="comment"> * WM_[SYS][DEAD]CHAR.</span>
00077 <span class="comment"> * Argument (msg) requires to be one of keyboard messages. Range check</span>
00078 <span class="comment"> * should be done before calling IS_CHAR_MSG() macro.</span>
00079 <span class="comment"> *</span>
00080 <span class="comment"> * (i.e. WM_KEYFIRST &lt;= msg &lt; WM_KEYLAST)</span>
00081 <span class="comment"> *</span>
00082 <span class="comment"> * We expect bit 0x02 of all WM_*CHAR messages to be set.</span>
00083 <span class="comment"> * and bit 0x02 of all WM_*KEY* messages to be clear</span>
00084 <span class="comment"> *</span>
00085 <span class="comment"> * WM_KEYDOWN       0x100   000</span>
00086 <span class="comment"> * WM_KEYUP         0x101   001</span>
00087 <span class="comment"> * WM_CHAR          0x102   010</span>
00088 <span class="comment"> * WM_DEADCHAR      0x103   011</span>
00089 <span class="comment"> *</span>
00090 <span class="comment"> * WM_SYSKEYDOWN    0x104   100</span>
00091 <span class="comment"> * WM_SYSKEYUP      0x105   101</span>
00092 <span class="comment"> * WM_SYSCHAR       0x106   110</span>
00093 <span class="comment"> * WM_SYSDEADCHAR   0x107   111</span>
00094 <span class="comment"> *</span>
00095 <span class="comment"> */</span>
00096 
00097   <span class="comment">/*</span>
00098 <span class="comment">   */</span>
00099 <span class="preprocessor">#if (WM_KEYFIRST != 0x100) ||    \</span>
00100 <span class="preprocessor">    (WM_KEYLAST != 0x108) ||     \</span>
00101 <span class="preprocessor">    (WM_KEYDOWN &amp; 0x2) ||        \</span>
00102 <span class="preprocessor">    (WM_KEYUP &amp; 0x2) ||          \</span>
00103 <span class="preprocessor">    (WM_SYSKEYDOWN &amp; 0x2) ||     \</span>
00104 <span class="preprocessor">    (WM_SYSKEYUP &amp; 0x2) ||       \</span>
00105 <span class="preprocessor">    !(WM_CHAR &amp; 0x02) ||         \</span>
00106 <span class="preprocessor">    !(WM_DEADCHAR &amp; 0x02) ||     \</span>
00107 <span class="preprocessor">    !(WM_SYSCHAR &amp; 0x02) ||      \</span>
00108 <span class="preprocessor">    !(WM_SYSDEADCHAR &amp; 0x02)</span>
00109 <span class="preprocessor"></span><span class="preprocessor">#error "unexpected value in keyboard messages."</span>
00110 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00111 <span class="preprocessor"></span>
00112 
00113 <span class="preprocessor">#if DBG</span>
00114 <span class="preprocessor"></span>
00115 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> IsCharMsg(UINT msg)
00116 {
00117     UserAssert(msg &gt;= WM_KEYFIRST &amp;&amp; msg &lt; WM_KEYLAST);
00118 
00119     <span class="keywordflow">return</span> <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> &amp; 0x02;
00120 }
00121 
00122 <span class="preprocessor">#define IS_CHAR_MSG(msg)    IsCharMsg(msg)</span>
00123 <span class="preprocessor"></span>
00124 <span class="preprocessor">#else</span>
00125 <span class="preprocessor"></span>
<a name="l00126"></a><a class="code" href="../../d1/d2/hooks_8c.html#a6">00126</a> <span class="preprocessor">#define IS_CHAR_MSG(msg)    ((msg) &amp; 0x02)</span>
00127 <span class="preprocessor"></span>
00128 <span class="preprocessor">#endif</span>
00129 <span class="preprocessor"></span>
00130 
00131 
00132 
00133 <span class="keywordtype">void</span> <a class="code" href="../../d1/d2/hooks_8c.html#a10">UnlinkHook</a>(<a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phkFree);
00134 <span class="comment">/***************************************************************************\</span>
00135 <span class="comment">* DbgValidateThisHook</span>
00136 <span class="comment">*</span>
00137 <span class="comment">* Validates a hook structure and returns the start of its chain.</span>
00138 <span class="comment">*</span>
00139 <span class="comment">* History:</span>
00140 <span class="comment">* 03-25-97  GerardoB    Created</span>
00141 <span class="comment">\***************************************************************************/</span>
00142 <span class="preprocessor">#if DBG</span>
00143 <span class="preprocessor"></span><a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> * DbgValidateThisHook (<a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk, <span class="keywordtype">int</span> iType, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiHooked)
00144 {
00145     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00146     <span class="comment">/*</span>
00147 <span class="comment">     * No bogus flags</span>
00148 <span class="comment">     */</span>
00149     UserAssert(!(phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; ~HF_DBGUSED));
00150     <span class="comment">/*</span>
00151 <span class="comment">     * Type</span>
00152 <span class="comment">     */</span>
00153     UserAssert(phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> == iType);
00154     <span class="comment">/*</span>
00155 <span class="comment">     * HF_GLOBAL &amp; ptiHooked. return the start of its hook chain.</span>
00156 <span class="comment">     */</span>
00157     <span class="keywordflow">if</span> (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>) {
00158         UserAssert(phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a> == NULL);
00159         <span class="keywordflow">if</span> (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o7">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00160             UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phk) == gptiRit);
00161             <span class="keywordflow">return</span> &amp;phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o7">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o4">aphkStart</a>[iType + 1];
00162         } <span class="keywordflow">else</span> {
00163             <span class="keywordflow">return</span> &amp;<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phk)-&gt;pDeskInfo-&gt;aphkStart[iType + 1];
00164         }
00165     } <span class="keywordflow">else</span> {
00166         UserAssert((phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a> == ptiHooked)
00167                     || (abHookFlags[iType + 1] &amp; HKF_INTERSENDABLE));
00168 
00169         <span class="keywordflow">return</span> &amp;(phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o51">aphkStart</a>[iType + 1]);
00170     }
00171 }
00172 <span class="comment">/***************************************************************************\</span>
00173 <span class="comment">* DbgValidatefsHook</span>
00174 <span class="comment">*</span>
00175 <span class="comment">* Make sure that the fsHook bit masks are in sync. If the bits</span>
00176 <span class="comment">*  are out of sync, some hook must have the HF_INCHECKWHF flag</span>
00177 <span class="comment">*  (this means the bits are being adjusted right now)</span>
00178 <span class="comment">*</span>
00179 <span class="comment">* History:</span>
00180 <span class="comment">* 05-20-97  GerardoB    Extracted from PhkFirst*Valid</span>
00181 <span class="comment">\***************************************************************************/</span>
00182 <span class="keywordtype">void</span> <a class="code" href="../../d1/d2/hooks_8c.html#a7">DbgValidatefsHook</a>(<a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk, <span class="keywordtype">int</span> nFilterType, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, BOOL fGlobal)
00183 {
00184     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00185     <span class="comment">/*</span>
00186 <span class="comment">     * If no pti is provided, figure out what it should be.</span>
00187 <span class="comment">     *  phk is expected to be NULL.</span>
00188 <span class="comment">     */</span>
00189     <span class="keywordflow">if</span> (pti == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00190         fGlobal = (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>);
00191         <span class="keywordflow">if</span> (fGlobal) {
00192             pti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phk);
00193         } <span class="keywordflow">else</span> {
00194             pti = phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a>;
00195             UserAssert(pti != NULL);
00196         }
00197     }
00198 
00199     <span class="keywordflow">if</span> (fGlobal) {
00200         <span class="keywordflow">if</span> ((phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ^ <a class="code" href="../../d4/d1/userk_8h.html#a442">IsGlobalHooked</a>(pti, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a510">WHF_FROM_WH</a>(nFilterType))) {
00201             <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phkTemp = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o4">aphkStart</a>[nFilterType + 1];
00202             <span class="keywordflow">while</span> ((phkTemp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !(phkTemp-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; HF_INCHECKWHF)) {
00203                 phkTemp = phkTemp-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a>;
00204             }
00205             UserAssert(phkTemp != NULL);
00206         }
00207     } <span class="keywordflow">else</span> {
00208         <span class="keywordflow">if</span> ((phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ^ <a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(pti, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a510">WHF_FROM_WH</a>(nFilterType))) {
00209             <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phkTemp = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o51">aphkStart</a>[nFilterType + 1];
00210             <span class="keywordflow">while</span> ((phkTemp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !(phkTemp-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; HF_INCHECKWHF)) {
00211                 phkTemp = phkTemp-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a>;
00212             }
00213             <span class="keywordflow">if</span> (phkTemp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00214                 phkTemp = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o4">aphkStart</a>[nFilterType + 1];
00215                 <span class="keywordflow">while</span> ((phkTemp != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !(phkTemp-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; HF_INCHECKWHF)) {
00216                     phkTemp = phkTemp-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a>;
00217                 }
00218             }
00219             UserAssert(phkTemp != NULL);
00220         }
00221     }
00222 }
00223 <span class="comment">/***************************************************************************\</span>
00224 <span class="comment">* DbgValidateHooks</span>
00225 <span class="comment">*</span>
00226 <span class="comment">* This functions expects valid (not destroyed) and properly linked.</span>
00227 <span class="comment">* History:</span>
00228 <span class="comment">* 03-25-97  GerardoB    Created</span>
00229 <span class="comment">\***************************************************************************/</span>
00230 <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a601">DbgValidateHooks</a> (<a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk, <span class="keywordtype">int</span> iType)
00231 {
00232     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> *pphkStart, *pphkNext;
00233     <span class="keywordflow">if</span> (phk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00234         <span class="keywordflow">return</span>;
00235     }
00236     <span class="comment">/*</span>
00237 <span class="comment">     * It shouldn't be destroyed</span>
00238 <span class="comment">     */</span>
00239     UserAssert(!(phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; (HF_DESTROYED | HF_FREED)));
00240     <span class="comment">/*</span>
00241 <span class="comment">     * Validate fsHooks</span>
00242 <span class="comment">     */</span>
00243     <a class="code" href="../../d1/d2/hooks_8c.html#a7">DbgValidatefsHook</a>(phk, iType, NULL, FALSE);
00244     <span class="comment">/*</span>
00245 <span class="comment">     * Validate this hook and get the beginning of the hook chain</span>
00246 <span class="comment">     */</span>
00247     pphkStart = DbgValidateThisHook(phk, iType, phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a>);
00248     <span class="comment">/*</span>
00249 <span class="comment">     * There must be at least one hook in the chain</span>
00250 <span class="comment">     */</span>
00251     UserAssert(*pphkStart != NULL);
00252     <span class="comment">/*</span>
00253 <span class="comment">     * Validate the link.</span>
00254 <span class="comment">     * And while your're at it, validate all hooks!</span>
00255 <span class="comment">     */</span>
00256     pphkNext = pphkStart;
00257     <span class="keywordflow">while</span> ((*pphkNext != phk) &amp;&amp; (*pphkNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00258        UserAssert(pphkStart == DbgValidateThisHook(*pphkNext, iType, phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a>));
00259        pphkNext = &amp;(*pphkNext)-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a>;
00260     }
00261     <span class="comment">/*</span>
00262 <span class="comment">     * Verify that we found it.</span>
00263 <span class="comment">     */</span>
00264     UserAssert(*pphkNext == phk);
00265     <span class="comment">/*</span>
00266 <span class="comment">     * Walk until the end of the chain</span>
00267 <span class="comment">     */</span>
00268     <span class="keywordflow">while</span> (*pphkNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00269        UserAssert(pphkStart == DbgValidateThisHook(*pphkNext, iType, phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a>));
00270        pphkNext = &amp;(*pphkNext)-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a>;
00271     }
00272 }
00273 <span class="preprocessor">#else</span>
<a name="l00274"></a><a class="code" href="../../d1/d2/hooks_8c.html#a7">00274</a> <span class="preprocessor"></span><span class="preprocessor">#define DbgValidatefsHook(phk, nFilterType, pti, fGlobal)</span>
00275 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* DBG */</span>
00276 <span class="comment">/***************************************************************************\</span>
00277 <span class="comment">* zzzJournalAttach</span>
00278 <span class="comment">*</span>
00279 <span class="comment">* This attaches/detaches threads to one input queue so input is synchronized.</span>
00280 <span class="comment">* Journalling requires this.</span>
00281 <span class="comment">*</span>
00282 <span class="comment">* 12-10-92 ScottLu      Created.</span>
00283 <span class="comment">\***************************************************************************/</span>
00284 
<a name="l00285"></a><a class="code" href="../../d1/d2/hooks_8c.html#a11">00285</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d2/hooks_8c.html#a11">zzzJournalAttach</a>(
00286     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
00287     BOOL fAttach)
00288 {
00289     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
00290     <a class="code" href="../../d7/d4/structtagQ.html">PQ</a> pq;
00291     PLIST_ENTRY pHead, pEntry;
00292 
00293     <span class="comment">/*</span>
00294 <span class="comment">     * If we're attaching, calculate the pqAttach for all threads journalling.</span>
00295 <span class="comment">     * If we're unattaching, just call zzzReattachThreads() and it will calculate</span>
00296 <span class="comment">     * the non-journalling queues to attach to.</span>
00297 <span class="comment">     */</span>
00298     <span class="keywordflow">if</span> (fAttach) {
00299         <span class="keywordflow">if</span> ((pq = <a class="code" href="../../d4/d1/userk_8h.html#a1204">AllocQueue</a>(pti, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00300             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00301 
00302         pHead = &amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>;
00303         <span class="keywordflow">for</span> (pEntry = pHead-&gt;Flink; pEntry != pHead; pEntry = pEntry-&gt;Flink) {
00304             ptiT = CONTAINING_RECORD(pEntry, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>, PtiLink);
00305 
00306             <span class="comment">/*</span>
00307 <span class="comment">             * This is the Q to attach to for all threads that will do</span>
00308 <span class="comment">             * journalling.</span>
00309 <span class="comment">             */</span>
00310             <span class="keywordflow">if</span> (!(ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a802">TIF_DONTJOURNALATTACH</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>))) {
00311                 ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a> = pq;
00312                 ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o28">pqAttach</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o22">cThreads</a>++;
00313             }
00314         }
00315     }
00316 
00317     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1203">zzzReattachThreads</a>(fAttach);
00318 }
00319 <span class="comment">/***************************************************************************\</span>
00320 <span class="comment">* InterQueueMsgCleanup</span>
00321 <span class="comment">*</span>
00322 <span class="comment">* Walk gpsmsList looking for inter queue messages with a hung receiver;</span>
00323 <span class="comment">*  if one is found and it's a message that would have been an async event or</span>
00324 <span class="comment">*  intra queue if not journalling, then it cleans it up.</span>
00325 <span class="comment">*</span>
00326 <span class="comment">* While Journalling most threads are attached to the same queue. This causes</span>
00327 <span class="comment">*  activation and input stuff to be synchronous; if a thread hangs or dies,</span>
00328 <span class="comment">*  any other thread sending a message to the hung/dead thread will be</span>
00329 <span class="comment">*  blocked for good.</span>
00330 <span class="comment">* This is critical when the blocked thread is cssr; this can happen with</span>
00331 <span class="comment">*  console windows or when some one requests a hard error box, specially</span>
00332 <span class="comment">*  during window activation.</span>
00333 <span class="comment">*</span>
00334 <span class="comment">* This function must be called when all queues have been detached (unless previously attached),</span>
00335 <span class="comment">*  so we can take care of hung/dead receivers with pending SMSs.</span>
00336 <span class="comment">*</span>
00337 <span class="comment">* 03-28-96 GerardoB     Created</span>
00338 <span class="comment">\***************************************************************************/</span>
<a name="l00339"></a><a class="code" href="../../d1/d2/hooks_8c.html#a12">00339</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2/hooks_8c.html#a12">InterQueueMsgCleanup</a> (DWORD dwTimeFromLastRead)
00340 {
00341     <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> *ppsms;
00342     <a class="code" href="../../d4/d1/userk_8h.html#a871">PSMS</a> psmsNext;
00343 
00344     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00345 
00346     <span class="comment">/*</span>
00347 <span class="comment">     * Walk  gpsmsList</span>
00348 <span class="comment">     */</span>
00349     <span class="keywordflow">for</span> (ppsms = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a238">gpsmsList</a>; *ppsms; ) {
00350         psmsNext = (*ppsms)-&gt;psmsNext;
00351         <span class="comment">/*</span>
00352 <span class="comment">         * If this is an inter queue message</span>
00353 <span class="comment">         */</span>
00354         <span class="keywordflow">if</span> (((*ppsms)-&gt;ptiSender != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00355                 &amp;&amp; ((*ppsms)-&gt;ptiReceiver != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00356                 &amp;&amp; ((*ppsms)-&gt;ptiSender-&gt;pq != (*ppsms)-&gt;ptiReceiver-&gt;pq)) {
00357             <span class="comment">/*</span>
00358 <span class="comment">             * If the receiver has been hung for a while</span>
00359 <span class="comment">             */</span>
00360             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a> ((*ppsms)-&gt;ptiReceiver, dwTimeFromLastRead)) {
00361 
00362                 <span class="keywordflow">switch</span> ((*ppsms)-&gt;message) {
00363                     <span class="comment">/*</span>
00364 <span class="comment">                     * Activation messages</span>
00365 <span class="comment">                     */</span>
00366                     <span class="keywordflow">case</span> WM_NCACTIVATE:
00367                     <span class="keywordflow">case</span> WM_ACTIVATEAPP:
00368                     <span class="keywordflow">case</span> WM_ACTIVATE:
00369                     <span class="keywordflow">case</span> WM_SETFOCUS:
00370                     <span class="keywordflow">case</span> WM_KILLFOCUS:
00371                     <span class="keywordflow">case</span> WM_QUERYNEWPALETTE:
00372                     <span class="comment">/*</span>
00373 <span class="comment">                     * Sent to spwndFocus, which now can be in a different queue</span>
00374 <span class="comment">                     */</span>
00375                     <span class="keywordflow">case</span> WM_INPUTLANGCHANGE:
00376                         RIPMSG3 (RIP_WARNING, <span class="stringliteral">"InterQueueMsgCleanup: ptiSender:%#p ptiReceiver:%#p message:%#lx"</span>,
00377                                     (*ppsms)-&gt;ptiSender, (*ppsms)-&gt;ptiReceiver, (*ppsms)-&gt;message);
00378                         <a class="code" href="../../d4/d1/userk_8h.html#a1149">ReceiverDied</a>(*ppsms, ppsms);
00379                         <span class="keywordflow">break</span>;
00380 
00381                 } <span class="comment">/* switch */</span>
00382 
00383             } <span class="comment">/* If hung receiver */</span>
00384 
00385         } <span class="comment">/* If inter queue message */</span>
00386 
00387          <span class="comment">/*</span>
00388 <span class="comment">          * If the message was not unlinked, go to the next one.</span>
00389 <span class="comment">          */</span>
00390         <span class="keywordflow">if</span> (*ppsms != psmsNext)
00391             ppsms = &amp;(*ppsms)-&gt;psmsNext;
00392 
00393     } <span class="comment">/* for */</span>
00394 }
00395 <span class="comment">/***************************************************************************\</span>
00396 <span class="comment">* zzzCancelJournalling</span>
00397 <span class="comment">*</span>
00398 <span class="comment">* Journalling is cancelled with control-escape is pressed, or when the desktop</span>
00399 <span class="comment">* is switched.</span>
00400 <span class="comment">*</span>
00401 <span class="comment">* 01-27-93 ScottLu      Created.</span>
00402 <span class="comment">\***************************************************************************/</span>
00403 
<a name="l00404"></a><a class="code" href="../../d4/d1/userk_8h.html#a1819">00404</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2/hooks_8c.html#a13">zzzCancelJournalling</a>(<span class="keywordtype">void</span>)
00405 {
00406     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCancelJournal;
00407     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phook;
00408     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phookNext;
00409 
00410     <span class="comment">/*</span>
00411 <span class="comment">     * Mouse buttons sometimes get stuck down due to hardware glitches,</span>
00412 <span class="comment">     * usually due to input concentrator switchboxes or faulty serial</span>
00413 <span class="comment">     * mouse COM ports, so clear the global button state here just in case,</span>
00414 <span class="comment">     * otherwise we may not be able to change focus with the mouse.</span>
00415 <span class="comment">     * Also do this in Alt-Tab processing.</span>
00416 <span class="comment">     */</span>
00417 <span class="preprocessor">#if DBG</span>
00418 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a>)
00419         RIPMSG1(RIP_WARNING,
00420                 <span class="stringliteral">"gwMouseOwnerButton=%x, being cleared forcibly\n"</span>,
00421                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a>);
00422 <span class="preprocessor">#endif</span>
00423 <span class="preprocessor"></span>    <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a92">gwMouseOwnerButton</a> = 0;
00424 
00425     <span class="comment">/*</span>
00426 <span class="comment">     * Remove journal hooks. This'll cause threads to associate with</span>
00427 <span class="comment">     * different queues.</span>
00428 <span class="comment">     * DeferWinEventNotify() so we can traverse the phook list safely</span>
00429 <span class="comment">     */</span>
00430     <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
00431     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>);
00432     phook = <a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>, WH_JOURNALPLAYBACK);
00433     <span class="keywordflow">while</span> (phook != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00434         ptiCancelJournal = phook-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o0">head</a>.pti;
00435 
00436         <span class="keywordflow">if</span> (ptiCancelJournal != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00437             <span class="comment">/*</span>
00438 <span class="comment">             * Let the thread that set the journal hook know this is happening.</span>
00439 <span class="comment">             */</span>
00440             <a class="code" href="../../d4/d1/userk_8h.html#a1645">_PostThreadMessage</a>(ptiCancelJournal, WM_CANCELJOURNAL, 0, 0);
00441 
00442             <span class="comment">/*</span>
00443 <span class="comment">             * If there was an app waiting for a response back from the journal</span>
00444 <span class="comment">             * application, cancel that request so the app can continue running</span>
00445 <span class="comment">             * (for example, we don't want winlogon or console to wait for an</span>
00446 <span class="comment">             * app that may be hung!)</span>
00447 <span class="comment">             */</span>
00448             <a class="code" href="../../d4/d1/userk_8h.html#a1148">SendMsgCleanup</a>(ptiCancelJournal);
00449         }
00450 
00451         phookNext = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(phook);
00452         <a class="code" href="../../d4/d1/userk_8h.html#a1815">zzzUnhookWindowsHookEx</a>(phook);        <span class="comment">// May free phook memory</span>
00453         phook = phookNext;
00454     }
00455     <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
00456 
00457     <span class="comment">/*</span>
00458 <span class="comment">     * DeferWinEventNotify() so we can traverse the phook list safely</span>
00459 <span class="comment">     */</span>
00460     <a class="code" href="../../d4/d1/userk_8h.html#a614">DeferWinEventNotify</a>();
00461     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>);
00462     phook = <a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>, WH_JOURNALRECORD);
00463     <span class="keywordflow">while</span> (phook != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00464         ptiCancelJournal = phook-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o0">head</a>.pti;
00465 
00466         <span class="keywordflow">if</span> (ptiCancelJournal != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00467             <span class="comment">/*</span>
00468 <span class="comment">             * Let the thread that set the journal hook know this is happening.</span>
00469 <span class="comment">             */</span>
00470             <a class="code" href="../../d4/d1/userk_8h.html#a1645">_PostThreadMessage</a>(ptiCancelJournal, WM_CANCELJOURNAL, 0, 0);
00471 
00472             <span class="comment">/*</span>
00473 <span class="comment">             * If there was an app waiting for a response back from the journal</span>
00474 <span class="comment">             * application, cancel that request so the app can continue running</span>
00475 <span class="comment">             * (for example, we don't want winlogon or console to wait for an</span>
00476 <span class="comment">             * app that may be hung!)</span>
00477 <span class="comment">             */</span>
00478             <a class="code" href="../../d4/d1/userk_8h.html#a1148">SendMsgCleanup</a>(ptiCancelJournal);
00479         }
00480 
00481         phookNext = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(phook);
00482         <a class="code" href="../../d4/d1/userk_8h.html#a1815">zzzUnhookWindowsHookEx</a>(phook);        <span class="comment">// May free phook memory</span>
00483         phook = phookNext;
00484     }
00485     <a class="code" href="../../d4/d1/userk_8h.html#a617">zzzEndDeferWinEventNotify</a>();
00486 
00487 
00488     <span class="comment">/*</span>
00489 <span class="comment">     * Make sure journalling ssync mode didn't hose any one</span>
00490 <span class="comment">     */</span>
00491     <a class="code" href="../../d1/d2/hooks_8c.html#a12">InterQueueMsgCleanup</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a914">CMSWAITTOKILLTIMEOUT</a>);
00492 
00493     <span class="comment">/*</span>
00494 <span class="comment">     * Unlock SetForegroundWindow (if locked)</span>
00495 <span class="comment">     */</span>
00496     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a81">gppiLockSFW</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00497 
00498     <span class="comment">/*</span>
00499 <span class="comment">     * NT5's last minute hack for evil applications, who disables the desktop window</span>
00500 <span class="comment">     * (perhaps by accidents though) leaving the system pretty unusable.</span>
00501 <span class="comment">     * See Raid #423704.</span>
00502 <span class="comment">     */</span>
00503     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> &amp;&amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>) {
00504         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndDesktop = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;
00505 
00506         <span class="keywordflow">if</span> (pwndDesktop &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndDesktop, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>)) {
00507             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwndDesktop, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a651">WFDISABLED</a>);
00508         }
00509     }
00510 }
00511 
00512 <span class="comment">/***************************************************************************\</span>
00513 <span class="comment">* zzzSetWindowsHookAW (API)</span>
00514 <span class="comment">*</span>
00515 <span class="comment">* This is the Win32 version of the SetWindowsHook() call.  It has the</span>
00516 <span class="comment">* same characteristics as far as return values, but only sets 'local'</span>
00517 <span class="comment">* hooks.  This is because we weren't provided a DLL we can load into</span>
00518 <span class="comment">* other processes.  Because of this WH_SYSMSGFILTER is no longer a</span>
00519 <span class="comment">* valid hook.  Apps will either need to call with WH_MSGFILTER or call</span>
00520 <span class="comment">* the new API SetWindowsHookEx().  Essentially this API is obsolete and</span>
00521 <span class="comment">* everyone should call SetWindowsHookEx().</span>
00522 <span class="comment">*</span>
00523 <span class="comment">* History:</span>
00524 <span class="comment">* 10-Feb-1991 DavidPe       Created.</span>
00525 <span class="comment">* 30-Jan-1992 IanJa         Added bAnsi parameter</span>
00526 <span class="comment">\***************************************************************************/</span>
00527 
<a name="l00528"></a><a class="code" href="../../d4/d1/userk_8h.html#a1814">00528</a> PROC <a class="code" href="../../d4/d1/userk_8h.html#a1814">zzzSetWindowsHookAW</a>(
00529     <span class="keywordtype">int</span> nFilterType,
00530     PROC pfnFilterProc,
00531     DWORD dwFlags)
00532 {
00533     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk;
00534 
00535     phk = <a class="code" href="../../d4/d1/userk_8h.html#a1906">zzzSetWindowsHookEx</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(),
00536             nFilterType, pfnFilterProc, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00537 
00538     <span class="comment">/*</span>
00539 <span class="comment">     * If we get an error from zzzSetWindowsHookEx() then we return</span>
00540 <span class="comment">     * -1 to be compatible with older version of Windows.</span>
00541 <span class="comment">     */</span>
00542     <span class="keywordflow">if</span> (phk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00543         <span class="keywordflow">return</span> (PROC)-1;
00544     }
00545 
00546     <span class="comment">/*</span>
00547 <span class="comment">     * Handle the backwards compatibility return value cases for</span>
00548 <span class="comment">     * SetWindowsHook.  If this was the first hook in the chain,</span>
00549 <span class="comment">     * then return NULL, else return something non-zero.  HKF_NZRET</span>
00550 <span class="comment">     * is a special case where SetWindowsHook would always return</span>
00551 <span class="comment">     * something because there was a default hook installed.  Some</span>
00552 <span class="comment">     * apps relied on a non-zero return value in those cases.</span>
00553 <span class="comment">     */</span>
00554     <span class="keywordflow">if</span> ((phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[nFilterType + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a3">HKF_NZRET</a>)) {
00555         <span class="keywordflow">return</span> (PROC)phk;
00556     }
00557 
00558     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00559 }
00560 
00561 
00562 <span class="comment">/***************************************************************************\</span>
00563 <span class="comment">* zzzSetWindowsHookEx</span>
00564 <span class="comment">*</span>
00565 <span class="comment">* SetWindowsHookEx() is the updated version of SetWindowsHook().  It allows</span>
00566 <span class="comment">* applications to set hooks on specific threads or throughout the entire</span>
00567 <span class="comment">* system.  The function returns a hook handle to the application if</span>
00568 <span class="comment">* successful and NULL if a failure occured.</span>
00569 <span class="comment">*</span>
00570 <span class="comment">* History:</span>
00571 <span class="comment">* 28-Jan-1991 DavidPe      Created.</span>
00572 <span class="comment">* 15-May-1991 ScottLu      Changed to work client/server.</span>
00573 <span class="comment">* 30-Jan-1992 IanJa        Added bAnsi parameter</span>
00574 <span class="comment">\***************************************************************************/</span>
00575 
<a name="l00576"></a><a class="code" href="../../d4/d1/userk_8h.html#a1906">00576</a> <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> <a class="code" href="../../d4/d1/userk_8h.html#a1906">zzzSetWindowsHookEx</a>(
00577     HANDLE hmod,
00578     PUNICODE_STRING pstrLib,
00579     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiThread,
00580     <span class="keywordtype">int</span> nFilterType,
00581     PROC pfnFilterProc,
00582     DWORD dwFlags)
00583 {
00584     ACCESS_MASK amDesired;
00585     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>       phkNew;
00586     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlphkNew;
00587     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>       *pphkStart;
00588     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00589 
00590     <span class="comment">/*</span>
00591 <span class="comment">     * Check to see if filter type is valid.</span>
00592 <span class="comment">     */</span>
00593     <span class="keywordflow">if</span> ((nFilterType &lt; WH_MIN) || (nFilterType &gt; WH_MAX)) {
00594         RIPERR0(ERROR_INVALID_HOOK_FILTER, RIP_VERBOSE, <span class="stringliteral">""</span>);
00595         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00596     }
00597 
00598     <span class="comment">/*</span>
00599 <span class="comment">     * Check to see if filter proc is valid.</span>
00600 <span class="comment">     */</span>
00601     <span class="keywordflow">if</span> (pfnFilterProc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00602         RIPERR0(ERROR_INVALID_FILTER_PROC, RIP_VERBOSE, <span class="stringliteral">""</span>);
00603         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00604     }
00605 
00606     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00607 
00608     <span class="keywordflow">if</span> (ptiThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00609         <span class="comment">/*</span>
00610 <span class="comment">         * Is the app trying to set a global hook without a library?</span>
00611 <span class="comment">         * If so return an error.</span>
00612 <span class="comment">         */</span>
00613          <span class="keywordflow">if</span> (hmod == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00614              RIPERR0(ERROR_HOOK_NEEDS_HMOD, RIP_VERBOSE, <span class="stringliteral">""</span>);
00615              <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00616          }
00617     } <span class="keywordflow">else</span> {
00618         <span class="comment">/*</span>
00619 <span class="comment">         * Is the app trying to set a local hook that is global-only?</span>
00620 <span class="comment">         * If so return an error.</span>
00621 <span class="comment">         */</span>
00622         <span class="keywordflow">if</span> (!(<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[nFilterType + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a1">HKF_TASK</a>)) {
00623             RIPERR0(ERROR_GLOBAL_ONLY_HOOK, RIP_VERBOSE, <span class="stringliteral">""</span>);
00624             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00625         }
00626 
00627         <span class="comment">/*</span>
00628 <span class="comment">         * Can't hook outside our own desktop.</span>
00629 <span class="comment">         */</span>
00630         <span class="keywordflow">if</span> (ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>) {
00631             RIPERR0(ERROR_ACCESS_DENIED,
00632                    RIP_WARNING,
00633                    <span class="stringliteral">"Access denied to desktop in zzzSetWindowsHookEx - can't hook other desktops"</span>);
00634 
00635             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00636         }
00637 
00638         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>) {
00639             <span class="comment">/*</span>
00640 <span class="comment">             * Is the app trying to set hook in another process without a library?</span>
00641 <span class="comment">             * If so return an error.</span>
00642 <span class="comment">             */</span>
00643             <span class="keywordflow">if</span> (hmod == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00644                 RIPERR0(ERROR_HOOK_NEEDS_HMOD, RIP_VERBOSE, <span class="stringliteral">""</span>);
00645                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00646             }
00647 
00648             <span class="comment">/*</span>
00649 <span class="comment">             * Is the app hooking another user without access?</span>
00650 <span class="comment">             * If so return an error. Note that this check is done</span>
00651 <span class="comment">             * for global hooks every time the hook is called.</span>
00652 <span class="comment">             */</span>
00653             <span class="keywordflow">if</span> ((!<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o27">luidSession</a>,
00654                                &amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o27">luidSession</a>)) &amp;&amp;
00655                         !(ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a815">TIF_ALLOWOTHERACCOUNTHOOK</a>)) {
00656 
00657                 RIPERR0(ERROR_ACCESS_DENIED,
00658                         RIP_WARNING,
00659                         <span class="stringliteral">"Access denied to other user in zzzSetWindowsHookEx"</span>);
00660 
00661                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00662             }
00663 
00664             <span class="keywordflow">if</span> ((ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>)) &amp;&amp;
00665                     !(<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[nFilterType + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>)) {
00666 
00667                 <span class="comment">/*</span>
00668 <span class="comment">                 * Can't hook console or GUI system thread if inter-thread</span>
00669 <span class="comment">                 * calling isn't implemented for this hook type.</span>
00670 <span class="comment">                 */</span>
00671                  RIPERR1(ERROR_HOOK_TYPE_NOT_ALLOWED,
00672                          RIP_WARNING,
00673                          <span class="stringliteral">"nFilterType (%ld) not allowed in zzzSetWindowsHookEx"</span>,
00674                          nFilterType);
00675 
00676                  <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00677             }
00678         }
00679     }
00680 
00681     <span class="comment">/*</span>
00682 <span class="comment">     * Check if this thread has access to hook its desktop.</span>
00683 <span class="comment">     */</span>
00684     <span class="keywordflow">switch</span>( nFilterType ) {
00685     <span class="keywordflow">case</span> WH_JOURNALRECORD:
00686         amDesired = DESKTOP_JOURNALRECORD;
00687         <span class="keywordflow">break</span>;
00688 
00689     <span class="keywordflow">case</span> WH_JOURNALPLAYBACK:
00690         amDesired = DESKTOP_JOURNALPLAYBACK;
00691         <span class="keywordflow">break</span>;
00692 
00693     <span class="keywordflow">default</span>:
00694         amDesired = DESKTOP_HOOKCONTROL;
00695         <span class="keywordflow">break</span>;
00696     }
00697 
00698     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a68">RtlAreAllAccessesGranted</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o48">amdesk</a>, amDesired)) {
00699          RIPERR0(ERROR_ACCESS_DENIED,
00700                 RIP_WARNING,
00701                 <span class="stringliteral">"Access denied to desktop in zzzSetWindowsHookEx"</span>);
00702 
00703          <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00704     }
00705 
00706     <span class="keywordflow">if</span> (amDesired != DESKTOP_HOOKCONTROL &amp;&amp;
00707         (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o3">dwWSF_Flags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a316">WSF_NOIO</a>)) {
00708         RIPERR0(ERROR_REQUIRES_INTERACTIVE_WINDOWSTATION,
00709                 RIP_WARNING,
00710                 <span class="stringliteral">"Journal hooks invalid on a desktop belonging to a non-interactive WindowStation."</span>);
00711 
00712         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00713     }
00714 
00715 <span class="preprocessor">#if 0</span>
00716 <span class="preprocessor"></span>    <span class="comment">/*</span>
00717 <span class="comment">     * Is this a journal hook?</span>
00718 <span class="comment">     */</span>
00719     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[nFilterType + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a>) {
00720         <span class="comment">/*</span>
00721 <span class="comment">         * Is a journal hook of this type already installed?</span>
00722 <span class="comment">         * If so it's an error.</span>
00723 <span class="comment">         * If this code is enabled, use PhkFirstGlobalValid instead</span>
00724 <span class="comment">         *  of checking phkStart directly</span>
00725 <span class="comment">         */</span>
00726         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;asphkStart[nFilterType + 1] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00727             RIPERR0(ERROR_JOURNAL_HOOK_SET, RIP_VERBOSE, <span class="stringliteral">""</span>);
00728             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00729         }
00730     }
00731 <span class="preprocessor">#endif</span>
00732 <span class="preprocessor"></span>
00733     <span class="comment">/*</span>
00734 <span class="comment">     * Allocate the new HOOK structure.</span>
00735 <span class="comment">     */</span>
00736     phkNew = (<a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>)<a class="code" href="../../d4/d1/userk_8h.html#a969">HMAllocObject</a>(ptiCurrent, ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>,
00737             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a241">TYPE_HOOK</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d6/structtagHOOK.html">HOOK</a>));
00738     <span class="keywordflow">if</span> (phkNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00739         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00740     }
00741 
00742     <span class="comment">/*</span>
00743 <span class="comment">     * If a DLL is required for this hook, register the library with</span>
00744 <span class="comment">     * the library management routines so we can assure it's loaded</span>
00745 <span class="comment">     * into all the processes necessary.</span>
00746 <span class="comment">     */</span>
00747     phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a> = -1;
00748     <span class="keywordflow">if</span> (hmod != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00749 
00750 <span class="preprocessor">#if defined(WX86)</span>
00751 <span class="preprocessor"></span>
00752         phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> |= (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a508">HF_WX86KNOWNDLL</a>);
00753 
00754 <span class="preprocessor">#endif</span>
00755 <span class="preprocessor"></span>
00756         phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1541">GetHmodTableIndex</a>(pstrLib);
00757 
00758         <span class="keywordflow">if</span> (phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a> == -1) {
00759             RIPERR0(ERROR_MOD_NOT_FOUND, RIP_VERBOSE, <span class="stringliteral">""</span>);
00760             <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>((PVOID)phkNew);
00761             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00762         }
00763 
00764         <span class="comment">/*</span>
00765 <span class="comment">         * Add a dependency on this module - meaning, increment a count</span>
00766 <span class="comment">         * that simply counts the number of hooks set into this module.</span>
00767 <span class="comment">         */</span>
00768         <span class="keywordflow">if</span> (phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a> &gt;= 0) {
00769             <a class="code" href="../../d4/d1/userk_8h.html#a1542">AddHmodDependency</a>(phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a>);
00770         }
00771     }
00772 
00773     <span class="comment">/*</span>
00774 <span class="comment">     * Depending on whether we're setting a global or local hook,</span>
00775 <span class="comment">     * get the start of the appropriate linked-list of HOOKs.  Also</span>
00776 <span class="comment">     * set the HF_GLOBAL flag if it's a global hook.</span>
00777 <span class="comment">     */</span>
00778     <span class="keywordflow">if</span> (ptiThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00779         pphkStart = &amp;ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o51">aphkStart</a>[nFilterType + 1];
00780 
00781         <span class="comment">/*</span>
00782 <span class="comment">         * Set the WHF_* in the THREADINFO so we know it's hooked.</span>
00783 <span class="comment">         */</span>
00784         ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o31">fsHooks</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a510">WHF_FROM_WH</a>(nFilterType);
00785 
00786         <span class="comment">/*</span>
00787 <span class="comment">         * Set the flags in the thread's TEB</span>
00788 <span class="comment">         */</span>
00789         <span class="keywordflow">if</span> (ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>) {
00790             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAttached;
00791 
00792             <span class="comment">/*</span>
00793 <span class="comment">             * If the thread being hooked is in another process, attach</span>
00794 <span class="comment">             * to that process so that we can access its ClientInfo.</span>
00795 <span class="comment">             */</span>
00796             <span class="keywordflow">if</span> (ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>) {
00797                 <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;Process-&gt;Pcb);
00798                 fAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00799             } <span class="keywordflow">else</span>
00800                 fAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00801 
00802             ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o8">fsHooks</a> = ptiThread-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o31">fsHooks</a>;
00803 
00804             <span class="keywordflow">if</span> (fAttached)
00805                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00806         }
00807 
00808         <span class="comment">/*</span>
00809 <span class="comment">         * Remember which thread we're hooking.</span>
00810 <span class="comment">         */</span>
00811         phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a> = ptiThread;
00812 
00813     } <span class="keywordflow">else</span> {
00814         pphkStart = &amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o4">aphkStart</a>[nFilterType + 1];
00815         phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>;
00816 
00817         <span class="comment">/*</span>
00818 <span class="comment">         * Set the WHF_* in the SERVERINFO so we know it's hooked.</span>
00819 <span class="comment">         */</span>
00820         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o3">fsHooks</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a510">WHF_FROM_WH</a>(nFilterType);
00821 
00822         phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00823     }
00824 
00825     <span class="comment">/*</span>
00826 <span class="comment">     * Does the hook function expect ANSI or Unicode text?</span>
00827 <span class="comment">     */</span>
00828     phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> |= (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a503">HF_ANSI</a>);
00829 
00830     <span class="comment">/*</span>
00831 <span class="comment">     * Initialize the HOOK structure.  Unreferenced parameters are assumed</span>
00832 <span class="comment">     * to be initialized to zero by LocalAlloc().</span>
00833 <span class="comment">     */</span>
00834     phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> = nFilterType;
00835 
00836     <span class="comment">/*</span>
00837 <span class="comment">     * Libraries are loaded at different linear addresses in different</span>
00838 <span class="comment">     * process contexts.  For this reason, we need to convert the filter</span>
00839 <span class="comment">     * proc address into an offset while setting the hook, and then convert</span>
00840 <span class="comment">     * it back to a real per-process function pointer when calling a</span>
00841 <span class="comment">     * hook.  Do this by subtracting the 'hmod' (which is a pointer to the</span>
00842 <span class="comment">     * linear and contiguous .exe header) from the function index.</span>
00843 <span class="comment">     */</span>
00844     phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o3">offPfn</a> = ((ULONG_PTR)pfnFilterProc) - ((ULONG_PTR)hmod);
00845 
00846 <span class="preprocessor">#ifdef HOOKBATCH</span>
00847 <span class="preprocessor"></span>    phkNew-&gt;cEventMessages = 0;
00848     phkNew-&gt;iCurrentEvent  = 0;
00849     phkNew-&gt;CacheTimeOut = 0;
00850     phkNew-&gt;aEventCache = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00851 <span class="preprocessor">#endif //HOOKBATCH</span>
00852 <span class="preprocessor"></span>
00853     <span class="comment">/*</span>
00854 <span class="comment">     * Link this hook into the front of the hook-list.</span>
00855 <span class="comment">     */</span>
00856     phkNew-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a> = *pphkStart;
00857     *pphkStart = phkNew;
00858 
00859     <span class="comment">/*</span>
00860 <span class="comment">     * If this is a journal hook, setup synchronized input processing</span>
00861 <span class="comment">     * AFTER we set the hook - so this synchronization can be cancelled</span>
00862 <span class="comment">     * with control-esc.</span>
00863 <span class="comment">     */</span>
00864     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[nFilterType + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a>) {
00865         <span class="comment">/*</span>
00866 <span class="comment">         * Attach everyone to us so journal-hook processing</span>
00867 <span class="comment">         * will be synchronized.</span>
00868 <span class="comment">         * No need to DeferWinEventNotify() here, since we lock phkNew.</span>
00869 <span class="comment">         */</span>
00870         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, phkNew, &amp;tlphkNew);
00871         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d2/hooks_8c.html#a11">zzzJournalAttach</a>(ptiCurrent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00872             RIPMSG1(RIP_WARNING, <span class="stringliteral">"zzzJournalAttach failed, so abort hook %#p"</span>, phkNew);
00873             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkNew) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00874                 <a class="code" href="../../d4/d1/userk_8h.html#a1815">zzzUnhookWindowsHookEx</a>(phkNew);
00875             }
00876             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00877         }
00878         <span class="keywordflow">if</span> ((phkNew = <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkNew)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00879             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00880         }
00881     }
00882 
00883     UserAssert(phkNew != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00884 
00885     <span class="comment">/*</span>
00886 <span class="comment">     * Later 5.0 GerardoB: The old code just to check this but</span>
00887 <span class="comment">     *  I think it's some left over stuff from server side days.</span>
00888 <span class="comment">    .* Let's assert on it for a while</span>
00889 <span class="comment">     * Also, I added the assertions in the else's below because I reorganized</span>
00890 <span class="comment">     *  the code and want to make sure we don't change behavior</span>
00891 <span class="comment">     */</span>
00892     UserAssert(ptiCurrent-&gt;pEThread &amp;&amp; <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(ptiCurrent-&gt;pEThread));
00893 
00894     <span class="comment">/*</span>
00895 <span class="comment">     * Can't allow a process that has set a global hook that works</span>
00896 <span class="comment">     * on server-side winprocs to run at background priority! Bump</span>
00897 <span class="comment">     * up it's dynamic priority and mark it so it doesn't get reset.</span>
00898 <span class="comment">     */</span>
00899     <span class="keywordflow">if</span> ((phkNew-&gt;flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>) &amp;&amp;
00900             (<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[nFilterType + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>)) {
00901 
00902         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a812">TIF_GLOBALHOOKER</a>;
00903         <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a>(&amp;ptiCurrent-&gt;pEThread-&gt;Tcb, LOW_REALTIME_PRIORITY-2);
00904 
00905         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[nFilterType + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a>) {
00906             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, phkNew, &amp;tlphkNew);
00907             <span class="comment">/*</span>
00908 <span class="comment">             * If we're changing the journal hooks, jiggle the mouse.</span>
00909 <span class="comment">             * This way the first event will always be a mouse move, which</span>
00910 <span class="comment">             * will ensure that the cursor is set properly.</span>
00911 <span class="comment">             */</span>
00912             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a32">zzzSetFMouseMoved</a>();
00913             phkNew = <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkNew);
00914             <span class="comment">/*</span>
00915 <span class="comment">             * If setting a journal playback hook, this process is the input</span>
00916 <span class="comment">             *  provider. This gives it the right to call SetForegroundWindow</span>
00917 <span class="comment">             */</span>
00918             <span class="keywordflow">if</span> (nFilterType == WH_JOURNALPLAYBACK) {
00919                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a80">gppiInputProvider</a> = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
00920             }
00921         } <span class="keywordflow">else</span> {
00922             UserAssert(nFilterType != WH_JOURNALPLAYBACK);
00923         }
00924     } <span class="keywordflow">else</span> {
00925         UserAssert(!(<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[nFilterType + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a>));
00926         UserAssert(nFilterType != WH_JOURNALPLAYBACK);
00927     }
00928 
00929 
00930 
00931 
00932     <span class="comment">/*</span>
00933 <span class="comment">     * Return pointer to our internal hook structure so we know</span>
00934 <span class="comment">     * which hook to call next in CallNextHookEx().</span>
00935 <span class="comment">     */</span>
00936     <a class="code" href="../../d4/d1/userk_8h.html#a601">DbgValidateHooks</a>(phkNew, phkNew-&gt;iHook);
00937     <span class="keywordflow">return</span> phkNew;
00938 }
00939 
00940 
00941 <span class="comment">/***************************************************************************\</span>
00942 <span class="comment">* xxxCallNextHookEx</span>
00943 <span class="comment">*</span>
00944 <span class="comment">* In the new world DefHookProc() is a bit deceptive since SetWindowsHook()</span>
00945 <span class="comment">* isn't returning the actual address of the next hook to call, but instead</span>
00946 <span class="comment">* a hook handle.  CallNextHookEx() is a slightly clearer picture of what's</span>
00947 <span class="comment">* going on so apps don't get tempted to try and call the value we return.</span>
00948 <span class="comment">*</span>
00949 <span class="comment">* As a side note we don't actually use the hook handle passed in.  We keep</span>
00950 <span class="comment">* track of which hooks is currently being called on a thread in the Q</span>
00951 <span class="comment">* structure and use that.  This is because SetWindowsHook() will sometimes</span>
00952 <span class="comment">* return NULL to be compatible with the way it used to work, but even though</span>
00953 <span class="comment">* we may be dealing with the last 'local' hook, there may be further 'global'</span>
00954 <span class="comment">* hooks we need to call.  PhkNext() is smart enough to jump over to the</span>
00955 <span class="comment">* 'global' hook chain if it reaches the end of the 'local' hook chain.</span>
00956 <span class="comment">*</span>
00957 <span class="comment">* History:</span>
00958 <span class="comment">* 01-30-91  DavidPe         Created.</span>
00959 <span class="comment">\***************************************************************************/</span>
00960 
<a name="l00961"></a><a class="code" href="../../d4/d1/userk_8h.html#a1817">00961</a> LRESULT <a class="code" href="../../d4/d1/userk_8h.html#a1817">xxxCallNextHookEx</a>(
00962     <span class="keywordtype">int</span> nCode,
00963     WPARAM wParam,
00964     LPARAM lParam)
00965 {
00966     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bAnsiHook;
00967 
00968     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;sphkCurrent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00969         <span class="keywordflow">return</span> 0;
00970     }
00971 
00972     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1522">xxxCallHook2</a>(<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;sphkCurrent), nCode, wParam, lParam, &amp;bAnsiHook);
00973 }
00974 
00975 
00976 <span class="comment">/***************************************************************************\</span>
00977 <span class="comment">* CheckWHFBits</span>
00978 <span class="comment">*</span>
00979 <span class="comment">* This routine checks to see if any hooks for nFilterType exist, and clear</span>
00980 <span class="comment">* the appropriate WHF_ in the THREADINFO and SERVERINFO.</span>
00981 <span class="comment">*</span>
00982 <span class="comment">* History:</span>
00983 <span class="comment">* 08-17-92  DavidPe         Created.</span>
00984 <span class="comment">\***************************************************************************/</span>
00985 
<a name="l00986"></a><a class="code" href="../../d1/d2/hooks_8c.html#a17">00986</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d1/d2/hooks_8c.html#a17">CheckWHFBits</a>(
00987     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
00988     <span class="keywordtype">int</span> nFilterType)
00989 {
00990     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fClearThreadBits;
00991     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fClearDesktopBits;
00992     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phook;
00993 
00994 
00995     <span class="comment">/*</span>
00996 <span class="comment">     * Assume we're are going to clear local(thread) and</span>
00997 <span class="comment">     *   global(desktop) bits.</span>
00998 <span class="comment">     */</span>
00999     fClearThreadBits = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01000     fClearDesktopBits = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01001     <span class="comment">/*</span>
01002 <span class="comment">     * Get the first valid hook for this thread</span>
01003 <span class="comment">     */</span>
01004     phook = <a class="code" href="../../d4/d1/userk_8h.html#a1518">PhkFirstValid</a>(pti, nFilterType);
01005     <span class="keywordflow">if</span> (phook != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01006         <span class="comment">/*</span>
01007 <span class="comment">         * If it found a global hook, don't clear the desktop bits</span>
01008 <span class="comment">         * (that would mean that there are no local(thread) hooks</span>
01009 <span class="comment">         *  so we fall through to clear the thread bits)</span>
01010 <span class="comment">         */</span>
01011         <span class="keywordflow">if</span> (phook-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>) {
01012             fClearDesktopBits = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01013         } <span class="keywordflow">else</span> {
01014             <span class="comment">/*</span>
01015 <span class="comment">             * It found a thread hook so don't clear the thread bits</span>
01016 <span class="comment">             */</span>
01017             fClearThreadBits = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01018             <span class="comment">/*</span>
01019 <span class="comment">             * Check for global hooks now. If there is one, don't</span>
01020 <span class="comment">             *  clear the desktop bits</span>
01021 <span class="comment">             */</span>
01022             phook = <a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(pti, nFilterType);
01023             fClearDesktopBits = (phook == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01024         }
01025     } <span class="comment">/* if (phook != NULL) */</span>
01026 
01027     <span class="keywordflow">if</span> (fClearThreadBits) {
01028         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o31">fsHooks</a> &amp;= ~(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a510">WHF_FROM_WH</a>(nFilterType));
01029         <span class="comment">/*</span>
01030 <span class="comment">         * Set the flags in the thread's TEB</span>
01031 <span class="comment">         */</span>
01032         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>) {
01033             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAttached;
01034             <span class="comment">/*</span>
01035 <span class="comment">             * If the hooked thread is in another process, attach</span>
01036 <span class="comment">             * to that process to access its address space.</span>
01037 <span class="comment">             */</span>
01038             <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()) {
01039                 <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;Process-&gt;Pcb);
01040                 fAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01041             } <span class="keywordflow">else</span>
01042                 fAttached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01043 
01044             pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o8">fsHooks</a> = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o31">fsHooks</a>;
01045 
01046             <span class="keywordflow">if</span> (fAttached)
01047                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01048         }
01049     }
01050 
01051     <span class="keywordflow">if</span> (fClearDesktopBits) {
01052         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o3">fsHooks</a> &amp;= ~(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a510">WHF_FROM_WH</a>(nFilterType));
01053     }
01054 }
01055 
01056 
01057 <span class="comment">/***************************************************************************\</span>
01058 <span class="comment">* zzzUnhookWindowsHook (API)</span>
01059 <span class="comment">*</span>
01060 <span class="comment">* This is the old version of the Unhook API.  It does the same thing as</span>
01061 <span class="comment">* zzzUnhookWindowsHookEx(), but takes a filter-type and filter-proc to</span>
01062 <span class="comment">* identify which hook to unhook.</span>
01063 <span class="comment">*</span>
01064 <span class="comment">* History:</span>
01065 <span class="comment">* 01-28-91  DavidPe         Created.</span>
01066 <span class="comment">\***************************************************************************/</span>
01067 
<a name="l01068"></a><a class="code" href="../../d4/d1/userk_8h.html#a1816">01068</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1816">zzzUnhookWindowsHook</a>(
01069     <span class="keywordtype">int</span> nFilterType,
01070     PROC pfnFilterProc)
01071 {
01072     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk;
01073     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
01074 
01075     <span class="keywordflow">if</span> ((nFilterType &lt; WH_MIN) || (nFilterType &gt; WH_MAX)) {
01076         RIPERR0(ERROR_INVALID_HOOK_FILTER, RIP_VERBOSE, <span class="stringliteral">""</span>);
01077         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01078     }
01079 
01080     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01081 
01082     <span class="keywordflow">for</span> (phk = <a class="code" href="../../d4/d1/userk_8h.html#a1518">PhkFirstValid</a>(ptiCurrent, nFilterType); phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; phk = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(phk)) {
01083         <span class="comment">/*</span>
01084 <span class="comment">         * Is this the hook we're looking for?</span>
01085 <span class="comment">         */</span>
01086         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a423">PFNHOOK</a>(phk) == pfnFilterProc) {
01087 
01088             <span class="comment">/*</span>
01089 <span class="comment">             * Are we on the thread that set the hook?</span>
01090 <span class="comment">             * If not return an error.</span>
01091 <span class="comment">             */</span>
01092             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phk) != ptiCurrent) {
01093                 RIPERR0(ERROR_ACCESS_DENIED,
01094                         RIP_WARNING,
01095                         <span class="stringliteral">"Access denied in zzzUnhookWindowsHook: "</span>
01096                         <span class="stringliteral">"this thread is not the same as that which set the hook"</span>);
01097 
01098                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01099             }
01100 
01101             <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1815">zzzUnhookWindowsHookEx</a>( phk );
01102         }
01103     }
01104 
01105     <span class="comment">/*</span>
01106 <span class="comment">     * Didn't find the hook we were looking for so return FALSE.</span>
01107 <span class="comment">     */</span>
01108     RIPERR0(ERROR_HOOK_NOT_INSTALLED, RIP_VERBOSE, <span class="stringliteral">""</span>);
01109     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01110 }
01111 
01112 
01113 <span class="comment">/***************************************************************************\</span>
01114 <span class="comment">* zzzUnhookWindowsHookEx (API)</span>
01115 <span class="comment">*</span>
01116 <span class="comment">* Applications call this API to 'unhook' a hook.  First we check if someone</span>
01117 <span class="comment">* is currently calling this hook.  If no one is we go ahead and free the</span>
01118 <span class="comment">* HOOK structure now.  If someone is then we simply clear the filter-proc</span>
01119 <span class="comment">* in the HOOK structure.  In xxxCallHook2() we check for this and if by</span>
01120 <span class="comment">* that time no one is calling the hook in question we free it there.</span>
01121 <span class="comment">*</span>
01122 <span class="comment">* History:</span>
01123 <span class="comment">* 01-28-91  DavidPe         Created.</span>
01124 <span class="comment">\***************************************************************************/</span>
01125 
<a name="l01126"></a><a class="code" href="../../d4/d1/userk_8h.html#a1815">01126</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1815">zzzUnhookWindowsHookEx</a>(
01127     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phkFree)
01128 {
01129     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
01130 
01131     pti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkFree);
01132 
01133     <span class="comment">/*</span>
01134 <span class="comment">     * If this hook is already destroyed, bail</span>
01135 <span class="comment">     */</span>
01136     <span class="keywordflow">if</span> (phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a509">HF_DESTROYED</a>) {
01137         RIPMSG1(RIP_WARNING, <span class="stringliteral">"_UnhookWindowsHookEx(%#p) already destroyed"</span>, phkFree);
01138         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01139     }
01140 
01141     <span class="comment">/*</span>
01142 <span class="comment">     * Clear the journaling flags in all the queues.</span>
01143 <span class="comment">     */</span>
01144     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a>) {
01145         <a class="code" href="../../d1/d2/hooks_8c.html#a11">zzzJournalAttach</a>(pti, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01146         <span class="comment">/*</span>
01147 <span class="comment">         * If someone got stuck because of the hook, let him go</span>
01148 <span class="comment">         *</span>
01149 <span class="comment">         * I want to get some performance numbers before checking this in.</span>
01150 <span class="comment">         * MSTest hooks and unhooks all the time when running a script.</span>
01151 <span class="comment">         * This code has never been in. 5/22/96. GerardoB</span>
01152 <span class="comment">         */</span>
01153         <span class="comment">// InterQueueMsgCleanup(3 * CMSWAITTOKILLTIMEOUT);</span>
01154     }
01155 
01156     <span class="comment">/*</span>
01157 <span class="comment">     * If no one is currently calling this hook,</span>
01158 <span class="comment">     * go ahead and free it now.</span>
01159 <span class="comment">     */</span>
01160     <a class="code" href="../../d4/d1/userk_8h.html#a1520">FreeHook</a>(phkFree);
01161 
01162     <span class="comment">/*</span>
01163 <span class="comment">     * If this thread has no more global hooks that are able to hook</span>
01164 <span class="comment">     * server-side window procs, we must clear it's TIF_GLOBALHOOKER bit.</span>
01165 <span class="comment">     */</span>
01166     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a812">TIF_GLOBALHOOKER</a>) {
01167         <span class="keywordtype">int</span> iHook;
01168         <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk;
01169         <span class="keywordflow">for</span> (iHook = WH_MIN ; iHook &lt;= WH_MAX ; ++iHook) {
01170             <span class="comment">/*</span>
01171 <span class="comment">             * Ignore those that can't hook server-side winprocs</span>
01172 <span class="comment">             */</span>
01173             <span class="keywordflow">if</span> (!(<a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[iHook + 1] &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>)) {
01174                 <span class="keywordflow">continue</span>;
01175             }
01176 
01177             <span class="comment">/*</span>
01178 <span class="comment">             * Scan the global hooks</span>
01179 <span class="comment">             */</span>
01180             <span class="keywordflow">for</span> (phk = <a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(pti, iHook);
01181                     phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; phk = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(phk)) {
01182 
01183                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phk) == pti) {
01184                     <span class="keywordflow">goto</span> StillHasGlobalHooks;
01185                 }
01186             }
01187         }
01188         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a812">TIF_GLOBALHOOKER</a>;
01189     }
01190 
01191 StillHasGlobalHooks:
01192     <span class="comment">/*</span>
01193 <span class="comment">     * Success, return TRUE.</span>
01194 <span class="comment">     */</span>
01195     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01196 }
01197 
01198 
01199 <span class="comment">/***************************************************************************\</span>
01200 <span class="comment">* _CallMsgFilter (API)</span>
01201 <span class="comment">*</span>
01202 <span class="comment">* CallMsgFilter() allows applications to call the WH_*MSGFILTER hooks.</span>
01203 <span class="comment">* If there's a sysmodal window we return FALSE right away.  WH_MSGFILTER</span>
01204 <span class="comment">* isn't called if WH_SYSMSGFILTER returned non-zero.</span>
01205 <span class="comment">*</span>
01206 <span class="comment">* History:</span>
01207 <span class="comment">* 01-29-91  DavidPe         Created.</span>
01208 <span class="comment">\***************************************************************************/</span>
01209 
<a name="l01210"></a><a class="code" href="../../d4/d1/userk_8h.html#a1818">01210</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1818">_CallMsgFilter</a>(
01211     LPMSG pmsg,
01212     <span class="keywordtype">int</span> nCode)
01213 {
01214     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
01215 
01216     pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01217 
01218     <span class="comment">/*</span>
01219 <span class="comment">     * First call WH_SYSMSGFILTER.  If it returns non-zero, don't</span>
01220 <span class="comment">     * bother calling WH_MSGFILTER, just return TRUE.  Otherwise</span>
01221 <span class="comment">     * return what WH_MSGFILTER gives us.</span>
01222 <span class="comment">     */</span>
01223     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(pti, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a519">WHF_SYSMSGFILTER</a>) &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(nCode, 0, (LPARAM)pmsg,
01224             WH_SYSMSGFILTER)) {
01225         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01226     }
01227 
01228     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(pti, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a511">WHF_MSGFILTER</a>)) {
01229         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(nCode, 0, (LPARAM)pmsg, WH_MSGFILTER);
01230     }
01231 
01232     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01233 }
01234 
01235 
01236 <span class="comment">/***************************************************************************\</span>
01237 <span class="comment">* xxxCallHook</span>
01238 <span class="comment">*</span>
01239 <span class="comment">* User code calls this function to call the first hook of a specific</span>
01240 <span class="comment">* type.</span>
01241 <span class="comment">*</span>
01242 <span class="comment">* History:</span>
01243 <span class="comment">* 01-29-91  DavidPe         Created.</span>
01244 <span class="comment">\***************************************************************************/</span>
01245 
<a name="l01246"></a><a class="code" href="../../d4/d1/userk_8h.html#a1521">01246</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(
01247     <span class="keywordtype">int</span> nCode,
01248     WPARAM wParam,
01249     LPARAM lParam,
01250     <span class="keywordtype">int</span> iHook)
01251 {
01252     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bAnsiHook;
01253 
01254     <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)<a class="code" href="../../d4/d1/userk_8h.html#a1522">xxxCallHook2</a>(<a class="code" href="../../d4/d1/userk_8h.html#a1518">PhkFirstValid</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), iHook), nCode, wParam, lParam, &amp;bAnsiHook);
01255 }
01256 
01257 
01258 <span class="comment">/***************************************************************************\</span>
01259 <span class="comment">* xxxCallHook2</span>
01260 <span class="comment">*</span>
01261 <span class="comment">* When you have an actual HOOK structure to call, you'd use this function.</span>
01262 <span class="comment">* It will check to see if the hook hasn't already been unhooked, and if</span>
01263 <span class="comment">* is it will free it and keep looking until it finds a hook it can call</span>
01264 <span class="comment">* or hits the end of the list.  We also make sure any needed DLLs are loaded</span>
01265 <span class="comment">* here.  We also check to see if the HOOK was unhooked inside the call</span>
01266 <span class="comment">* after we return.</span>
01267 <span class="comment">*</span>
01268 <span class="comment">* Note: Hooking server-side window procedures (such as the desktop and console</span>
01269 <span class="comment">* windows) can only be done by sending the hook message to the hooking app.</span>
01270 <span class="comment">* (This is because we must not load the hookproc DLL into the server process).</span>
01271 <span class="comment">* The hook types this can be done with are currently WH_JOURNALRECORD,</span>
01272 <span class="comment">* WH_JOURNALPLAYBACK, WH_KEYBOARD and WH_MOUSE : these are all marked as</span>
01273 <span class="comment">* HKF_INTERSENDABLE.  In order to prevent a global hooker from locking up the whole</span>
01274 <span class="comment">* system, the hook message is sent with a timeout.  To ensure minimal</span>
01275 <span class="comment">* performance degradation, the hooker process is set to foreground priority,</span>
01276 <span class="comment">* and prevented from being set back to background priority with the</span>
01277 <span class="comment">* TIF_GLOBALHOOKER bit in hooking thread's pti-&gt;flags.</span>
01278 <span class="comment">* Hooking emulated DOS apps is prevented with the TIF_DOSEMULATOR bit in the</span>
01279 <span class="comment">* console thread: this is because these apps typically hog the CPU so much that</span>
01280 <span class="comment">* the hooking app does not respond rapidly enough to the hook messsages sent</span>
01281 <span class="comment">* to it.  IanJa Nov 1994.</span>
01282 <span class="comment">*</span>
01283 <span class="comment">* History:</span>
01284 <span class="comment">* 02-07-91     DavidPe     Created.</span>
01285 <span class="comment">* 1994 Nov 02  IanJa       Hooking desktop and console windows.</span>
01286 <span class="comment">\***************************************************************************/</span>
01287 
<a name="l01288"></a><a class="code" href="../../d4/d1/userk_8h.html#a1522">01288</a> LRESULT <a class="code" href="../../d4/d1/userk_8h.html#a1522">xxxCallHook2</a>(
01289     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phkCall,
01290     <span class="keywordtype">int</span> nCode,
01291     WPARAM wParam,
01292     LPARAM lParam,
01293     LPBOOL lpbAnsiHook)
01294 {
01295     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        iHook;
01296     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>       phkSave;
01297     LONG_PTR     nRet;
01298     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
01299     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fLoadSuccess;
01300     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlphkCall;
01301     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlphkSave;
01302     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>        bHookFlags;
01303     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fMustIntersend;
01304 
01305     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01306 
01307     <span class="keywordflow">if</span> (phkCall == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01308         <span class="keywordflow">return</span> 0;
01309     }
01310 
01311     iHook = phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>;
01312 
01313     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01314     <span class="comment">/*</span>
01315 <span class="comment">     * Only low level hooks are allowed in the RIT context</span>
01316 <span class="comment">     * (This check used to be done in PhkFirstValid).</span>
01317 <span class="comment">     */</span>
01318     <span class="keywordflow">if</span> (ptiCurrent == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>) {
01319         <span class="keywordflow">switch</span> (iHook) {
01320         <span class="keywordflow">case</span> WH_MOUSE_LL:
01321         <span class="keywordflow">case</span> WH_KEYBOARD_LL:
01322 
01323 <span class="preprocessor">#ifdef REDIRECTION</span>
01324 <span class="preprocessor"></span>        <span class="keywordflow">case</span> WH_HITTEST:
01325 <span class="preprocessor">#endif // REDIRECTION</span>
01326 <span class="preprocessor"></span>
01327             <span class="keywordflow">break</span>;
01328 
01329         <span class="keywordflow">default</span>:
01330             <span class="keywordflow">return</span> 0;
01331         }
01332     }
01333 
01334     <span class="comment">/*</span>
01335 <span class="comment">     * If this queue is in cleanup, exit: it has no business calling back</span>
01336 <span class="comment">     * a hook proc. Also check if hooks are disabled for the thread.</span>
01337 <span class="comment">     */</span>
01338     <span class="keywordflow">if</span> (    ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a>) ||
01339             ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> != WH_MOUSE_LL))) {
01340         <span class="keywordflow">return</span> <a class="code" href="../../d1/d2/hooks_8c.html#a8">ampiHookError</a>[iHook + 1];
01341     }
01342 
01343     <span class="comment">/*</span>
01344 <span class="comment">     * Try to call each hook in the list until one is successful or</span>
01345 <span class="comment">     * we reach the end of the list.</span>
01346 <span class="comment">     */</span>
01347     <span class="keywordflow">do</span> {
01348         *lpbAnsiHook = phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a503">HF_ANSI</a>;
01349         bHookFlags = <a class="code" href="../../d1/d2/hooks_8c.html#a9">abHookFlags</a>[phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> + 1];
01350 
01351         <span class="comment">/*</span>
01352 <span class="comment">         * Some WH_SHELL hook types can be called from console</span>
01353 <span class="comment">         * HSHELL_APPCOMMAND added for bug 346575 DefWindowProc invokes a shell hook</span>
01354 <span class="comment">         * for console windows if they don't handle the wm_appcommand message - we need the hook</span>
01355 <span class="comment">         * to go through for csrss.</span>
01356 <span class="comment">         */</span>
01357         <span class="keywordflow">if</span> ((phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> == WH_SHELL) &amp;&amp; (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a>)) {
01358             <span class="keywordflow">if</span> ((nCode == HSHELL_LANGUAGE) || (nCode == HSHELL_WINDOWACTIVATED) ||
01359                 (nCode == HSHELL_APPCOMMAND)) {
01360                 bHookFlags |= <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>;
01361             }
01362         }
01363 
01364         <span class="keywordflow">if</span> ((phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> == WH_SHELL) &amp;&amp; (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>)) {
01365             <span class="keywordflow">if</span> ((nCode == HSHELL_ACCESSIBILITYSTATE) ) {
01366                 bHookFlags |= <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>;
01367             }
01368         }
01369 
01370         fMustIntersend =
01371             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall) != ptiCurrent) &amp;&amp;
01372             (
01373                 <span class="comment">/*</span>
01374 <span class="comment">                 * We always want to intersend journal hooks.</span>
01375 <span class="comment">                 * CONSIDER (adams): Why? There's a performance hit by</span>
01376 <span class="comment">                 * doing so, so if we haven't a reason, we shouldn't</span>
01377 <span class="comment">                 * do it.</span>
01378 <span class="comment">                 *</span>
01379 <span class="comment">                 * we also need to intersend low level hooks. They can be called</span>
01380 <span class="comment">                 * from the desktop thread, the raw input thread AND also from</span>
01381 <span class="comment">                 * any thread that calls CallNextHookEx.</span>
01382 <span class="comment">                 */</span>
01383                 (bHookFlags &amp; (<a class="code" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a> | <a class="code" href="../../d1/d2/hooks_8c.html#a5">HKF_LOWLEVEL</a>))
01384 
01385                 <span class="comment">/*</span>
01386 <span class="comment">                 * We must intersend if a 16bit app hooks a 32bit app</span>
01387 <span class="comment">                 * because we can't load a 16bit dll into a 32bit process.</span>
01388 <span class="comment">                 * We must also intersend if a 16bit app hooks another 16bit app</span>
01389 <span class="comment">                 * in a different VDM, because we can't load a 16bit dll from</span>
01390 <span class="comment">                 * one VDM into a 16bit app in another VDM (because that</span>
01391 <span class="comment">                 * VDM is actually a 32bit process).</span>
01392 <span class="comment">                 */</span>
01393                 ||
01394                 (   <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall)-&gt;TIF_flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a> &amp;&amp;
01395                     (   !(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) ||
01396                         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall)-&gt;ppi))
01397 
01398 <span class="preprocessor">#if defined(_WIN64)</span>
01399 <span class="preprocessor"></span>
01400                 <span class="comment">/*</span>
01401 <span class="comment">                 * Intersend if a 64bit app hooks a 32bit app or</span>
01402 <span class="comment">                 * a 32bit app hooks a 64bit app.</span>
01403 <span class="comment">                 * This is necessary since a hook DLL can not be loaded</span>
01404 <span class="comment">                 * cross bit type.</span>
01405 <span class="comment">                 */</span>
01406                 ||
01407                 (   (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall)-&gt;TIF_flags &amp; <a class="code" href="../../d1/d0/inc_2user_8h.html#a796">TIF_WOW64</a>) !=
01408                     (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d1/d0/inc_2user_8h.html#a796">TIF_WOW64</a>)
01409                 )
01410 
01411 <span class="preprocessor">#endif </span><span class="comment">/* defined(_WIN64) */</span>
01412 
01413                 <span class="comment">/*</span>
01414 <span class="comment">                 * We must intersend if a console or system thread is calling a hook</span>
01415 <span class="comment">                 * that is not in the same console or the system process.</span>
01416 <span class="comment">                 */</span>
01417                 ||
01418                 (   ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>) &amp;&amp;
01419                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall)-&gt;ppi != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>)
01420 
01421                 <span class="comment">/*</span>
01422 <span class="comment">                 * If this is a global and non-journal hook, do a security</span>
01423 <span class="comment">                 * check on the current desktop to see if we can call here.</span>
01424 <span class="comment">                 * Note that we allow processes with the SYSTEM_LUID to hook</span>
01425 <span class="comment">                 * other processes even if the other process says that it</span>
01426 <span class="comment">                 * doesn't allow other accounts to hook them.  We did this</span>
01427 <span class="comment">                 * because there was a bug in NT 3.x that allowed it and some</span>
01428 <span class="comment">                 * services were written to use it.</span>
01429 <span class="comment">                 */</span>
01430                 ||
01431                 (   phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a> &amp;&amp;
01432                     !<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall)-&gt;ppi-&gt;luidSession, &amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o27">luidSession</a>) &amp;&amp;
01433                     !(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a815">TIF_ALLOWOTHERACCOUNTHOOK</a>) &amp;&amp;
01434                     !<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall)-&gt;ppi-&gt;luidSession, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a244">luidSystem</a>))
01435 
01436                 <span class="comment">/*</span>
01437 <span class="comment">                 * We must intersend if the hooking thread is running in</span>
01438 <span class="comment">                 * another process and is restricted.</span>
01439 <span class="comment">                 */</span>
01440                 ||
01441                 (   <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall)-&gt;ppi != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> &amp;&amp;
01442                     <a class="code" href="../../d6/d9/restrfil_8c.html#a29">IsRestricted</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall)-&gt;pEThread))
01443              );
01444 
01445         <span class="comment">/*</span>
01446 <span class="comment">         * We're calling back... make sure the hook doesn't go away while</span>
01447 <span class="comment">         * we're calling back. We've thread locked here: we must unlock before</span>
01448 <span class="comment">         * returning or enumerating the next hook in the chain.</span>
01449 <span class="comment">         */</span>
01450         <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, phkCall, &amp;tlphkCall);
01451 
01452         <span class="keywordflow">if</span> (!fMustIntersend) {
01453             <span class="comment">/*</span>
01454 <span class="comment">             * Make sure the DLL for this hook, if any, has been loaded</span>
01455 <span class="comment">             * for the current process.</span>
01456 <span class="comment">             */</span>
01457             <span class="keywordflow">if</span> ((phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a> != -1) &amp;&amp;
01458                     (<a class="code" href="../../d4/d1/userk_8h.html#a420">TESTHMODLOADED</a>(ptiCurrent, phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a>) == 0)) {
01459 
01460                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bWx86KnownDll;
01461 
01462                 <span class="comment">/*</span>
01463 <span class="comment">                 * Try loading the library, since it isn't loaded in this processes</span>
01464 <span class="comment">                 * context.  First lock this hook so it doesn't go away while we're</span>
01465 <span class="comment">                 * loading this library.</span>
01466 <span class="comment">                 */</span>
01467                 bWx86KnownDll = (phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a508">HF_WX86KNOWNDLL</a>) != 0;
01468                 fLoadSuccess = (<a class="code" href="../../d4/d1/userk_8h.html#a1544">xxxLoadHmodIndex</a>(phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o5">ihmod</a>, bWx86KnownDll) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01469 
01470                 <span class="comment">/*</span>
01471 <span class="comment">                 * If the LoadLibrary() failed, skip to the next hook and try</span>
01472 <span class="comment">                 * again.</span>
01473 <span class="comment">                 */</span>
01474                 <span class="keywordflow">if</span> (!fLoadSuccess) {
01475                     <span class="keywordflow">goto</span> LoopAgain;
01476                 }
01477             }
01478 
01479             <span class="comment">/*</span>
01480 <span class="comment">             * Is WH_DEBUG installed?  If we're not already calling it, do so.</span>
01481 <span class="comment">             */</span>
01482             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a522">WHF_DEBUG</a>) &amp;&amp; (phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> != WH_DEBUG)) {
01483                 DEBUGHOOKINFO debug;
01484 
01485                 debug.idThread = <a class="code" href="../../d4/d1/userk_8h.html#a107">TIDq</a>(ptiCurrent);
01486                 debug.idThreadInstaller = 0;
01487                 debug.code = nCode;
01488                 debug.wParam = wParam;
01489                 debug.lParam = lParam;
01490 
01491                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HC_ACTION, phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>, (LPARAM)&amp;debug, WH_DEBUG)) {
01492                     <span class="comment">/*</span>
01493 <span class="comment">                     * If WH_DEBUG returned non-zero, skip this hook and</span>
01494 <span class="comment">                     * try the next one.</span>
01495 <span class="comment">                     */</span>
01496                     <span class="keywordflow">goto</span> LoopAgain;
01497                 }
01498             }
01499 
01500             <span class="comment">/*</span>
01501 <span class="comment">             * Make sure the hook is still around before we</span>
01502 <span class="comment">             * try and call it.</span>
01503 <span class="comment">             */</span>
01504             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(phkCall)) {
01505                 <span class="keywordflow">goto</span> LoopAgain;
01506             }
01507 
01508             <span class="comment">/*</span>
01509 <span class="comment">             * Time to call the hook! Lock it first so that it doesn't go away</span>
01510 <span class="comment">             * while we're using it. Thread lock right away in case the lock frees</span>
01511 <span class="comment">             * the previous contents.</span>
01512 <span class="comment">             */</span>
01513 
01514 <span class="preprocessor">#if DBG</span>
01515 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>) {
01516                 UserAssert(phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01517             } <span class="keywordflow">else</span> {
01518                 UserAssert(phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a> == ptiCurrent);
01519             }
01520 <span class="preprocessor">#endif</span>
01521 <span class="preprocessor"></span>            phkSave = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o32">sphkCurrent</a>;
01522             <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, phkSave, &amp;tlphkSave);
01523 
01524             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o32">sphkCurrent</a>, phkCall);
01525             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>)
01526                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o7">phkCurrent</a> = phkCall;
01527 
01528             nRet = <a class="code" href="../../d4/d1/userk_8h.html#a1905">xxxHkCallHook</a>(phkCall, nCode, wParam, lParam);
01529 
01530             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o32">sphkCurrent</a>, phkSave);
01531             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>)
01532                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o7">phkCurrent</a> = phkSave;
01533 
01534             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkSave);
01535 
01536             <span class="comment">/*</span>
01537 <span class="comment">             * This hook proc faulted, so unhook it and try the next one.</span>
01538 <span class="comment">             */</span>
01539             <span class="keywordflow">if</span> (phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a506">HF_HOOKFAULTED</a>) {
01540                 <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a>   phkFault;
01541 
01542                 phkCall = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(phkCall);
01543                 phkFault = <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01544                 <span class="keywordflow">if</span> (phkFault != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01545                     <a class="code" href="../../d4/d1/userk_8h.html#a1520">FreeHook</a>(phkFault);
01546                 }
01547 
01548                 <span class="keywordflow">continue</span>;
01549             }
01550 
01551             <span class="comment">/*</span>
01552 <span class="comment">             * Lastly, we're done with this hook so it is ok to unlock it (it may</span>
01553 <span class="comment">             * get freed here!</span>
01554 <span class="comment">             */</span>
01555             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01556 
01557             <span class="keywordflow">return</span> nRet;
01558 
01559         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bHookFlags &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a4">HKF_INTERSENDABLE</a>) {
01560 
01561             <span class="comment">/*</span>
01562 <span class="comment">             * Receiving thread can access this structure since the</span>
01563 <span class="comment">             * sender thread's stack is locked down during xxxInterSendMsgEx</span>
01564 <span class="comment">             */</span>
01565             <a class="code" href="../../d6/d6/structtagHOOKMSGSTRUCT.html">HOOKMSGSTRUCT</a> hkmp;
01566             <span class="keywordtype">int</span>           timeout = 200; <span class="comment">// 1/5 second !!!</span>
01567 
01568             hkmp.<a class="code" href="../../d6/d6/structtagHOOKMSGSTRUCT.html#o2">lParam</a> = lParam;
01569             hkmp.<a class="code" href="../../d6/d6/structtagHOOKMSGSTRUCT.html#o0">phk</a> = phkCall;
01570             hkmp.<a class="code" href="../../d6/d6/structtagHOOKMSGSTRUCT.html#o1">nCode</a> = nCode;
01571 
01572             <span class="comment">/*</span>
01573 <span class="comment">             * Thread lock right away in case the lock frees the previous contents</span>
01574 <span class="comment">             */</span>
01575             phkSave = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o32">sphkCurrent</a>;
01576 
01577             <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, phkSave, &amp;tlphkSave);
01578 
01579             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o32">sphkCurrent</a>, phkCall);
01580             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>)
01581                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o7">phkCurrent</a> = phkCall;
01582 
01583             <span class="comment">/*</span>
01584 <span class="comment">             * Make sure we don't get hung!</span>
01585 <span class="comment">             */</span>
01586             <span class="keywordflow">if</span> (bHookFlags &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a5">HKF_LOWLEVEL</a>)
01587                 timeout = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a259">gnllHooksTimeout</a>;
01588 
01589             <span class="comment">/*</span>
01590 <span class="comment">             * CONSIDER(adams): Why should a journaling hook be allowed to</span>
01591 <span class="comment">             * hang the console or a system thread? Will that interfere with</span>
01592 <span class="comment">             * the user's ability to cancel journaling through Ctrl+Esc?</span>
01593 <span class="comment">             */</span>
01594             <span class="keywordflow">if</span> (((bHookFlags &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a5">HKF_LOWLEVEL</a>) == 0) &amp;&amp;
01595                 (   (bHookFlags &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a2">HKF_JOURNAL</a>) ||
01596                     !(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a>)))) {
01597 
01598                 nRet = <a class="code" href="../../d4/d1/userk_8h.html#a1150">xxxInterSendMsgEx</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, WM_HOOKMSG, wParam,
01599                     (LPARAM)&amp;hkmp, ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01600             } <span class="keywordflow">else</span> {
01601                 <span class="comment">/*</span>
01602 <span class="comment">                 * We are a server thread (console/desktop) and we aren't</span>
01603 <span class="comment">                 * journalling, so we can't allow the hookproc to hang us -</span>
01604 <span class="comment">                 * we must use a timeout.</span>
01605 <span class="comment">                 */</span>
01606                 <a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html">INTRSENDMSGEX</a> ism;
01607 
01608                 ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o0">fuCall</a>     = <a class="code" href="../../d4/d1/userk_8h.html#a437">ISM_TIMEOUT</a>;
01609                 ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o4">fuSend</a>     = SMTO_ABORTIFHUNG | SMTO_NORMAL;
01610                 ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o5">uTimeout</a>   = timeout;
01611                 ism.<a class="code" href="../../d9/d8/structtagINTERSENDMSGEX.html#o6">lpdwResult</a> = &amp;nRet;
01612 
01613                 <span class="comment">/*</span>
01614 <span class="comment">                 * Don't hook DOS apps connected to the emulator - they often</span>
01615 <span class="comment">                 * grab too much CPU for the callback to the hookproc to</span>
01616 <span class="comment">                 * complete in a timely fashion, causing poor response.</span>
01617 <span class="comment">                 */</span>
01618                 <span class="keywordflow">if</span> ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a811">TIF_DOSEMULATOR</a>) ||
01619                     <a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a912">CMSHUNGAPPTIMEOUT</a>) ||
01620                     !<a class="code" href="../../d4/d1/userk_8h.html#a1150">xxxInterSendMsgEx</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, WM_HOOKMSG, wParam,
01621                             (LPARAM)&amp;hkmp, ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall), &amp;ism)) {
01622                     nRet = <a class="code" href="../../d1/d2/hooks_8c.html#a8">ampiHookError</a>[iHook + 1];
01623                 }
01624 
01625                 <span class="comment">/*</span>
01626 <span class="comment">                 * If the low-level hook is eaten, the app may wake up from</span>
01627 <span class="comment">                 * MsgWaitForMultipleObjects, clear the wake mask, but not get</span>
01628 <span class="comment">                 * anything in GetMessage / PeekMessage and we will think it's</span>
01629 <span class="comment">                 * hung. This causes problems in DirectInput because then the</span>
01630 <span class="comment">                 * app may miss some hooks if FHungApp returns true, see bug</span>
01631 <span class="comment">                 * 430342 for more details on this.</span>
01632 <span class="comment">                 */</span>
01633                 <span class="keywordflow">if</span> ((bHookFlags &amp; <a class="code" href="../../d1/d2/hooks_8c.html#a5">HKF_LOWLEVEL</a>) &amp;&amp; nRet) {
01634                     <a class="code" href="../../d4/d1/userk_8h.html#a257">SET_TIME_LAST_READ</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkCall));
01635                 }
01636             }
01637 
01638             <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o32">sphkCurrent</a>, phkSave);
01639             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>)
01640                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o8">pClientInfo</a>-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o7">phkCurrent</a> = phkSave;
01641 
01642             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkSave);
01643             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01644             <span class="keywordflow">return</span> nRet;
01645         }
01646         <span class="comment">// fall-through</span>
01647 
01648 LoopAgain:
01649         phkCall = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(phkCall);
01650         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01651     } <span class="keywordflow">while</span> (phkCall != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01652 
01653     <span class="keywordflow">return</span> <a class="code" href="../../d1/d2/hooks_8c.html#a8">ampiHookError</a>[iHook + 1];
01654 }
01655 
01656 <span class="comment">/***************************************************************************\</span>
01657 <span class="comment">* xxxCallMouseHook</span>
01658 <span class="comment">*</span>
01659 <span class="comment">* This is a helper routine that packages up a MOUSEHOOKSTRUCTEX and calls</span>
01660 <span class="comment">* the WH_MOUSE hook.</span>
01661 <span class="comment">*</span>
01662 <span class="comment">* History:</span>
01663 <span class="comment">* 02-09-91  DavidPe         Created.</span>
01664 <span class="comment">\***************************************************************************/</span>
01665 
<a name="l01666"></a><a class="code" href="../../d4/d1/userk_8h.html#a1523">01666</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1523">xxxCallMouseHook</a>(
01667     UINT message,
01668     PMOUSEHOOKSTRUCTEX pmhs,
01669     BOOL fRemove)
01670 {
01671     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bAnsiHook;
01672 
01673     <span class="comment">/*</span>
01674 <span class="comment">     * Call the mouse hook.</span>
01675 <span class="comment">     */</span>
01676     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1522">xxxCallHook2</a>(<a class="code" href="../../d4/d1/userk_8h.html#a1518">PhkFirstValid</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), WH_MOUSE), fRemove ?
01677             HC_ACTION : HC_NOREMOVE, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)message, (LPARAM)pmhs, &amp;bAnsiHook)) {
01678         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01679     }
01680 
01681     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01682 }
01683 
01684 
01685 <span class="comment">/***************************************************************************\</span>
01686 <span class="comment">* xxxCallJournalRecordHook</span>
01687 <span class="comment">*</span>
01688 <span class="comment">* This is a helper routine that packages up an EVENTMSG and calls</span>
01689 <span class="comment">* the WH_JOURNALRECORD hook.</span>
01690 <span class="comment">*</span>
01691 <span class="comment">* History:</span>
01692 <span class="comment">* 02-28-91  DavidPe         Created.</span>
01693 <span class="comment">\***************************************************************************/</span>
01694 
<a name="l01695"></a><a class="code" href="../../d4/d1/userk_8h.html#a1524">01695</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1524">xxxCallJournalRecordHook</a>(
01696     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg)
01697 {
01698     EVENTMSG emsg;
01699     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bAnsiHook;
01700 
01701     <span class="comment">/*</span>
01702 <span class="comment">     * Setup the EVENTMSG structure.</span>
01703 <span class="comment">     */</span>
01704     emsg.message = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message;
01705     emsg.time = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.time;
01706 
01707     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd)) {
01708         emsg.hwnd = pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.hwnd;
01709     } <span class="keywordflow">else</span> {
01710         emsg.hwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01711     }
01712 
01713     <span class="keywordflow">if</span> ((emsg.message &gt;= WM_MOUSEFIRST) &amp;&amp; (emsg.message &lt;= WM_MOUSELAST)) {
01714         emsg.paramL = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt.x;
01715         emsg.paramH = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt.y;
01716 
01717     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((emsg.message &gt;= WM_KEYFIRST) &amp;&amp; (emsg.message &lt;= WM_KEYLAST)) {
01718         <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> bScanCode = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(HIWORD(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam));
01719         <span class="comment">/*</span>
01720 <span class="comment">         * Build up a Win 3.1 compatible journal record key</span>
01721 <span class="comment">         * Win 3.1  ParamL 00 00 SC VK  (SC=scan code VK=virtual key)</span>
01722 <span class="comment">         * Also set ParamH 00 00 00 SC  to be compatible with our Playback</span>
01723 <span class="comment">         *</span>
01724 <span class="comment">         * If WM_*CHAR messages ever come this way we would have a problem</span>
01725 <span class="comment">         * because we would lose the top byte of the Unicode character. We'd</span>
01726 <span class="comment">         * We'd get ParamL 00 00 SC CH  (SC=scan code, CH = low byte of WCHAR)</span>
01727 <span class="comment">         *</span>
01728 <span class="comment">         */</span>
01729         <span class="keywordflow">if</span> ((LOWORD(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam) == VK_PACKET) &amp;&amp; (bScanCode == 0)) {
01730             <span class="comment">/*</span>
01731 <span class="comment">             * If we have an injected Unicode char (from SendInput), the</span>
01732 <span class="comment">             * character value was cached, let's give that to them too.</span>
01733 <span class="comment">             */</span>
01734             emsg.paramL = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)MAKELONG(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam, <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;wchInjected);
01735         } <span class="keywordflow">else</span> {
01736             emsg.paramL = MAKELONG(MAKEWORD(pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam, bScanCode),0);
01737         }
01738         emsg.paramH = bScanCode;
01739 
01740         UserAssert((emsg.message != WM_CHAR) &amp;&amp;
01741                    (emsg.message != WM_DEADCHAR) &amp;&amp;
01742                    (emsg.message != WM_SYSCHAR) &amp;&amp;
01743                    (emsg.message != WM_SYSDEADCHAR));
01744         <span class="comment">/*</span>
01745 <span class="comment">         * Set extended-key bit.</span>
01746 <span class="comment">         */</span>
01747         <span class="keywordflow">if</span> (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam &amp; 0x01000000) {
01748             emsg.paramH |= 0x8000;
01749         }
01750 
01751     } <span class="keywordflow">else</span> {
01752         RIPMSG2(RIP_WARNING,
01753                 <span class="stringliteral">"Bad journal record message!\n"</span>
01754                 <span class="stringliteral">"   message  = 0x%08lx\n"</span>
01755                 <span class="stringliteral">"   dwQEvent = 0x%08lx"</span>,
01756                 pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message,
01757                 pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o4">dwQEvent</a>);
01758     }
01759 
01760     <span class="comment">/*</span>
01761 <span class="comment">     * Call the journal recording hook.</span>
01762 <span class="comment">     */</span>
01763     <a class="code" href="../../d4/d1/userk_8h.html#a1522">xxxCallHook2</a>(<a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), WH_JOURNALRECORD), HC_ACTION, 0,
01764             (LPARAM)&amp;emsg, &amp;bAnsiHook);
01765 
01766     <span class="comment">/*</span>
01767 <span class="comment">     * Write the MSG parameters back because the app may have modified it.</span>
01768 <span class="comment">     * AfterDark's screen saver password actually zero's out the keydown</span>
01769 <span class="comment">     * chars.</span>
01770 <span class="comment">     *</span>
01771 <span class="comment">     * If it was a mouse message patch up the mouse point.  If it was a</span>
01772 <span class="comment">     * WM_KEYxxx message convert the Win 3.1 compatible journal record key</span>
01773 <span class="comment">     * back into a half backed WM_KEYxxx format.  Only the VK and SC fields</span>
01774 <span class="comment">     * where initialized at this point.</span>
01775 <span class="comment">     *</span>
01776 <span class="comment">     *      wParam  00 00 00 VK   lParam 00 SC 00 00</span>
01777 <span class="comment">     */</span>
01778     <span class="keywordflow">if</span> ((pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &gt;= WM_MOUSEFIRST) &amp;&amp; (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &lt;= WM_MOUSELAST)) {
01779         pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt.x = emsg.paramL;
01780         pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.pt.y = emsg.paramH;
01781 
01782     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &gt;= WM_KEYFIRST) &amp;&amp; (pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message &lt;= WM_KEYLAST)) {
01783         (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.wParam = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)emsg.paramL;
01784         ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)&amp;pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.lParam)[2] = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(LOWORD(emsg.paramL));
01785     }
01786 }
01787 
01788 
01789 <span class="comment">/***************************************************************************\</span>
01790 <span class="comment">* xxxCallJournalPlaybackHook</span>
01791 <span class="comment">*</span>
01792 <span class="comment">*</span>
01793 <span class="comment">* History:</span>
01794 <span class="comment">* 03-01-91  DavidPe         Created.</span>
01795 <span class="comment">\***************************************************************************/</span>
01796 
<a name="l01797"></a><a class="code" href="../../d4/d1/userk_8h.html#a1525">01797</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/userk_8h.html#a1525">xxxCallJournalPlaybackHook</a>(
01798     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a> pqmsg)
01799 {
01800     EVENTMSG emsg;
01801     LONG <a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a>;
01802     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
01803     WPARAM wParam;
01804     LPARAM lParam;
01805     POINT pt;
01806     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
01807     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bAnsiHook;
01808     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phkCall;
01809     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlphkCall;
01810 
01811     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
01812 
01813 TryNextEvent:
01814 
01815     <span class="comment">/*</span>
01816 <span class="comment">     * Initialized to the current time for compatibility with</span>
01817 <span class="comment">     * &lt;= 3.0.</span>
01818 <span class="comment">     */</span>
01819     emsg.time = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
01820     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01821     pwnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01822 
01823     phkCall = <a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(ptiCurrent, WH_JOURNALPLAYBACK);
01824     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, phkCall, &amp;tlphkCall);
01825 
01826     <a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a> = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d4/d1/userk_8h.html#a1522">xxxCallHook2</a>(phkCall, HC_GETNEXT, 0, (LPARAM)&amp;emsg, &amp;bAnsiHook);
01827 
01828     <span class="comment">/*</span>
01829 <span class="comment">     * -1 means some error occured. Return -1 for error.</span>
01830 <span class="comment">     */</span>
01831     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a> == 0xFFFFFFFF) {
01832         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01833         <span class="keywordflow">return</span> <a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a>;
01834     }
01835 
01836     <span class="comment">/*</span>
01837 <span class="comment">     * Update the message id. Need this if we decide to sleep.</span>
01838 <span class="comment">     */</span>
01839     pqmsg-&gt;<a class="code" href="../../d8/d4/structtagQMSG.html#o2">msg</a>.message = emsg.message;
01840 
01841     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a> &gt; 0) {
01842         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a814">TIF_IGNOREPLAYBACKDELAY</a>) {
01843             <span class="comment">/*</span>
01844 <span class="comment">             * This flag tells us to ignore the requested delay (set in mnloop)</span>
01845 <span class="comment">             * We clear it to indicate that we did so.</span>
01846 <span class="comment">             */</span>
01847             RIPMSG1(RIP_WARNING, <span class="stringliteral">"Journal Playback delay ignored (%lx)"</span>, emsg.message);
01848             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a814">TIF_IGNOREPLAYBACKDELAY</a>;
01849             <a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a> = 0;
01850         } <span class="keywordflow">else</span> {
01851             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01852             <span class="keywordflow">return</span> <a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a>;
01853         }
01854     }
01855 
01856     <span class="comment">/*</span>
01857 <span class="comment">     * The app is ready to be asked for the next event</span>
01858 <span class="comment">     */</span>
01859 
01860     <span class="keywordflow">if</span> ((emsg.message &gt;= WM_MOUSEFIRST) &amp;&amp; (emsg.message &lt;= WM_MOUSELAST)) {
01861 
01862         pt.x = (<span class="keywordtype">int</span>)emsg.paramL;
01863         pt.y = (<span class="keywordtype">int</span>)emsg.paramH;
01864 
01865         lParam = MAKELONG(LOWORD(pt.x), LOWORD(pt.y));
01866         wParam = 0;
01867 
01868         <span class="comment">/*</span>
01869 <span class="comment">         * If the message has changed the mouse position,</span>
01870 <span class="comment">         * update the cursor.</span>
01871 <span class="comment">         */</span>
01872         <span class="keywordflow">if</span> (pt.x != <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.x || pt.y != <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor.y) {
01873             <a class="code" href="../../d4/d1/userk_8h.html#a1179">zzzInternalSetCursorPos</a>(pt.x, pt.y);
01874         }
01875 
01876     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((emsg.message &gt;= WM_KEYFIRST) &amp;&amp; (emsg.message &lt;= WM_KEYLAST)) {
01877         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wExtraStuff = 0;
01878 
01879         <span class="keywordflow">if</span> ((emsg.message == WM_KEYUP) || (emsg.message == WM_SYSKEYUP)) {
01880             wExtraStuff |= 0x8000;
01881         }
01882 
01883         <span class="keywordflow">if</span> ((emsg.message == WM_SYSKEYUP) || (emsg.message == WM_SYSKEYDOWN)) {
01884             wExtraStuff |= 0x2000;
01885         }
01886 
01887         <span class="keywordflow">if</span> (emsg.paramH &amp; 0x8000) {
01888             wExtraStuff |= 0x0100;
01889         }
01890 
01891         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a837">TestKeyStateDown</a>(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)emsg.paramL)) {
01892             wExtraStuff |= 0x4000;
01893         }
01894         lParam = MAKELONG(1, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)((emsg.paramH &amp; 0xFF) | wExtraStuff));
01895 
01896         <span class="keywordflow">if</span> ((LOWORD(emsg.paramL) == VK_PACKET) &amp;&amp; (<a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(emsg.paramH) == 0)) {
01897             <span class="comment">/*</span>
01898 <span class="comment">             * We are playing back an injected Unicode char (see SendInput)</span>
01899 <span class="comment">             * save the character for TranslateMessage to pick up.</span>
01900 <span class="comment">             */</span>
01901             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o45">wchInjected</a> = HIWORD(emsg.paramL);
01902         } <span class="keywordflow">else</span> {
01903             <span class="comment">/*</span>
01904 <span class="comment">             * Raid# 65331</span>
01905 <span class="comment">             * WM_KEY* and WM_SYSKEY* messages should only contain 8bit Virtual Keys.</span>
01906 <span class="comment">             * Some applications passes scan code in HIBYTE and could screw up</span>
01907 <span class="comment">             * the system. E.g. Tab Keydown, paramL: 0x0f09 where 0f is scan code</span>
01908 <span class="comment">             */</span>
01909             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwMask = 0xff;
01910 
01911             <span class="comment">/*</span>
01912 <span class="comment">             * There are old ANSI apps that only fill in the byte for when</span>
01913 <span class="comment">             * they generate journal playback so we used to strip everything</span>
01914 <span class="comment">             * else off.  That however breaks unicode journalling; 22645</span>
01915 <span class="comment">             * (Yes, some apps apparently do Playback WM_*CHAR msgs!)</span>
01916 <span class="comment">             *</span>
01917 <span class="comment">             */</span>
01918             <span class="keywordflow">if</span> (!bAnsiHook || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>()) {
01919                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/hooks_8c.html#a6">IS_CHAR_MSG</a>(emsg.message)) {
01920                     RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"Unusual char message(%x) passed through JournalPlayback."</span>, emsg.message);
01921                     <span class="comment">/*</span>
01922 <span class="comment">                     * Don't mask off HIBYTE(LOWORD(paramL)) for DBCS and UNICODE.</span>
01923 <span class="comment">                     */</span>
01924                     dwMask = 0xffff;
01925                 }
01926             }
01927 
01928             wParam = emsg.paramL &amp; dwMask;
01929         }
01930 
01931     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (emsg.message == WM_QUEUESYNC) {
01932         <span class="keywordflow">if</span> (emsg.paramL == 0) {
01933             pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
01934         } <span class="keywordflow">else</span> {
01935             <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>((HWND)IntToPtr( emsg.paramL ))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01936                 pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
01937         }
01938 
01939     } <span class="keywordflow">else</span> {
01940         <span class="comment">/*</span>
01941 <span class="comment">         * This event doesn't match up with what we're looking</span>
01942 <span class="comment">         * for. If the hook is still valid, then skip this message</span>
01943 <span class="comment">         * and try the next.</span>
01944 <span class="comment">         */</span>
01945         <span class="keywordflow">if</span> (phkCall == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || phkCall-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o3">offPfn</a> == 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) {
01946             <span class="comment">/* Hook is nolonger valid, return -1 */</span>
01947             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01948             <span class="keywordflow">return</span> 0xFFFFFFFF;
01949         }
01950 
01951         RIPMSG1(RIP_WARNING,
01952                 <span class="stringliteral">"Bad journal playback message=0x%08lx"</span>,
01953                 emsg.message);
01954 
01955         <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HC_SKIP, 0, 0, WH_JOURNALPLAYBACK);
01956         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01957         <span class="keywordflow">goto</span> TryNextEvent;
01958     }
01959 
01960     <a class="code" href="../../d4/d1/userk_8h.html#a1503">StoreQMessage</a>(pqmsg, pwnd, emsg.message, wParam, lParam, 0, 0, 0);
01961 
01962     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlphkCall);
01963     <span class="keywordflow">return</span> 0;
01964 }
01965 
01966 <span class="comment">/***************************************************************************\</span>
01967 <span class="comment">* FreeHook</span>
01968 <span class="comment">*</span>
01969 <span class="comment">* Free hook unlinks the HOOK structure from its hook-list and removes</span>
01970 <span class="comment">* any hmod dependencies on this hook.  It also frees the HOOK structure.</span>
01971 <span class="comment">*</span>
01972 <span class="comment">* History:</span>
01973 <span class="comment">* 01-31-91  DavidPe         Created.</span>
01974 <span class="comment">\***************************************************************************/</span>
01975 
<a name="l01976"></a><a class="code" href="../../d4/d1/userk_8h.html#a1520">01976</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1520">FreeHook</a>(
01977     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phkFree)
01978 {
01979     <span class="comment">/*</span>
01980 <span class="comment">     * Paranoia...</span>
01981 <span class="comment">     */</span>
01982     UserAssert(!(phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; HF_FREED));
01983     <span class="comment">/*</span>
01984 <span class="comment">     * BUGBUG</span>
01985 <span class="comment">     * Unless we come from zzzUnhookWindowsHook, if this was a journaling hook</span>
01986 <span class="comment">     * we don't unattach the threads.  We should reconsider this one day.</span>
01987 <span class="comment">     * MCostea Jan 21, 99</span>
01988 <span class="comment">     */</span>
01989 
01990     <span class="comment">/*</span>
01991 <span class="comment">     * Clear fsHooks bits the first time around (and mark it as destroyed).</span>
01992 <span class="comment">     */</span>
01993     <span class="keywordflow">if</span> (!(phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a509">HF_DESTROYED</a>)) {
01994         <a class="code" href="../../d4/d1/userk_8h.html#a601">DbgValidateHooks</a> (phkFree, phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a>);
01995         phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a509">HF_DESTROYED</a>;
01996         <span class="comment">/*</span>
01997 <span class="comment">         * This hook has been marked as destroyed so CheckWHSBits</span>
01998 <span class="comment">         * won't take it into account when updating the fsHooks bits.</span>
01999 <span class="comment">         * However, this means that right at this moment fsHooks is</span>
02000 <span class="comment">         * out of sync. So we need a flag to make the assertion freaks</span>
02001 <span class="comment">         * (i.e., me) happy.</span>
02002 <span class="comment">         */</span>
02003 <span class="preprocessor">#if DBG</span>
02004 <span class="preprocessor"></span>        phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> |= HF_INCHECKWHF;
02005 <span class="preprocessor">#endif</span>
02006 <span class="preprocessor"></span>        UserAssert((phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>));
02007         <a class="code" href="../../d1/d2/hooks_8c.html#a17">CheckWHFBits</a>(phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02008                         ? phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a>
02009                         : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkFree),
02010                      phkFree-&gt;iHook);
02011 <span class="preprocessor">#if DBG</span>
02012 <span class="preprocessor"></span>        phkFree-&gt;flags &amp;= ~HF_INCHECKWHF;
02013 <span class="preprocessor">#endif</span>
02014 <span class="preprocessor"></span>    }
02015     <span class="comment">/*</span>
02016 <span class="comment">     * Mark it for destruction.  If it the object is locked it can't</span>
02017 <span class="comment">     * be freed right now.</span>
02018 <span class="comment">     */</span>
02019     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>((PVOID)phkFree)) {
02020         <span class="keywordflow">return</span>;
02021     }
02022     <span class="comment">/*</span>
02023 <span class="comment">     * We're going to free this hook so get it off the list.</span>
02024 <span class="comment">     */</span>
02025     <a class="code" href="../../d1/d2/hooks_8c.html#a10">UnlinkHook</a>(phkFree);
02026     <span class="comment">/*</span>
02027 <span class="comment">     * Now remove the hmod dependency and free the</span>
02028 <span class="comment">     * HOOK structure.</span>
02029 <span class="comment">     */</span>
02030     <span class="keywordflow">if</span> (phkFree-&gt;ihmod &gt;= 0) {
02031         <a class="code" href="../../d4/d1/userk_8h.html#a1543">RemoveHmodDependency</a>(phkFree-&gt;ihmod);
02032     }
02033 
02034 <span class="preprocessor">#ifdef HOOKBATCH</span>
02035 <span class="preprocessor"></span>    <span class="comment">/*</span>
02036 <span class="comment">     * Free the cached Events</span>
02037 <span class="comment">     */</span>
02038     <span class="keywordflow">if</span> (phkFree-&gt;aEventCache) {
02039         UserFreePool(phkFree-&gt;aEventCache);
02040         phkFree-&gt;aEventCache = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02041     }
02042 <span class="preprocessor">#endif //HOOKBATCH</span>
02043 <span class="preprocessor"></span>
02044 <span class="preprocessor">#if DBG</span>
02045 <span class="preprocessor"></span>    phkFree-&gt;flags |= HF_FREED;
02046 <span class="preprocessor">#endif</span>
02047 <span class="preprocessor"></span>
02048     <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>((PVOID)phkFree);
02049     <span class="keywordflow">return</span>;
02050 }
02051 <span class="comment">/***************************************************************************\</span>
02052 <span class="comment">* UnlinkHook</span>
02053 <span class="comment">*</span>
02054 <span class="comment">* Gets a hook out of its chain. Note that FreeThreadsWindowHooks unlinks</span>
02055 <span class="comment">*  some hooks but don't free them. So this function doesn't assume that</span>
02056 <span class="comment">*  the hook is going away.</span>
02057 <span class="comment">*</span>
02058 <span class="comment">* History:</span>
02059 <span class="comment">* 04-25-97  GerardoB    Added Header</span>
02060 <span class="comment">\***************************************************************************/</span>
<a name="l02061"></a><a class="code" href="../../d1/d2/hooks_8c.html#a10">02061</a> <span class="keywordtype">void</span> <a class="code" href="../../d1/d2/hooks_8c.html#a10">UnlinkHook</a>(
02062     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phkFree)
02063 {
02064     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> *pphkNext;
02065     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
02066 
02067     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02068     <span class="comment">/*</span>
02069 <span class="comment">     * Since we have the HOOK structure, we can tell if this a global</span>
02070 <span class="comment">     * or local hook and start on the right list.</span>
02071 <span class="comment">     */</span>
02072     <span class="keywordflow">if</span> (phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>) {
02073         pphkNext = &amp;<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkFree)-&gt;pDeskInfo-&gt;aphkStart[phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> + 1];
02074     } <span class="keywordflow">else</span> {
02075         ptiT = phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a>;
02076         <span class="keywordflow">if</span> (ptiT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02077             <span class="comment">/*</span>
02078 <span class="comment">             * Already unlinked (by FreeThreadsWindowHooks)</span>
02079 <span class="comment">             */</span>
02080             <span class="keywordflow">return</span>;
02081         } <span class="keywordflow">else</span> {
02082             <span class="comment">/*</span>
02083 <span class="comment">             * Clear ptiHooked so we won't try to unlink it again.</span>
02084 <span class="comment">             */</span>
02085             phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02086         }
02087         pphkNext = &amp;(ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o51">aphkStart</a>[phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> + 1]);
02088         <span class="comment">/*</span>
02089 <span class="comment">         * There must be at least one hook in the chain</span>
02090 <span class="comment">         */</span>
02091         UserAssert(*pphkNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02092     }
02093     <span class="comment">/*</span>
02094 <span class="comment">     * Find the address of the phkNext pointing to phkFree</span>
02095 <span class="comment">     */</span>
02096     <span class="keywordflow">while</span> ((*pphkNext != phkFree) &amp;&amp; (*pphkNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02097        pphkNext = &amp;(*pphkNext)-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a>;
02098     }
02099     <span class="comment">/*</span>
02100 <span class="comment">     * If we haven't found it, it must be global hook whose owner is gone or</span>
02101 <span class="comment">     *  has switched desktops.</span>
02102 <span class="comment">     */</span>
02103     <span class="keywordflow">if</span> (*pphkNext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02104         UserAssert(phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>);
02105         <span class="comment">/*</span>
02106 <span class="comment">         * if we saved a pdesk, use it. Else use the one we allocated it from</span>
02107 <span class="comment">         */</span>
02108         <span class="keywordflow">if</span> (phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o7">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02109             UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkFree) == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>);
02110             UserAssert(phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o7">rpdesk</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02111             UserAssert(phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o7">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>);
02112 
02113             pphkNext = &amp;phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o7">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o4">aphkStart</a>[phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> + 1];
02114         } <span class="keywordflow">else</span> {
02115             UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkFree)-&gt;pDeskInfo != phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o0">head</a>.rpdesk-&gt;pDeskInfo);
02116             pphkNext = &amp;phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o0">head</a>.rpdesk-&gt;pDeskInfo-&gt;aphkStart[phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o2">iHook</a> + 1];
02117         }
02118 
02119         UserAssert(*pphkNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02120         <span class="keywordflow">while</span> ((*pphkNext != phkFree) &amp;&amp; (*pphkNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02121            pphkNext = &amp;(*pphkNext)-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a>;
02122         }
02123     }
02124     <span class="comment">/*</span>
02125 <span class="comment">     * We're supposed to find it</span>
02126 <span class="comment">     */</span>
02127     UserAssert(*pphkNext == phkFree);
02128     <span class="comment">/*</span>
02129 <span class="comment">     * Unlink it</span>
02130 <span class="comment">     */</span>
02131     *pphkNext = phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a>;
02132     phkFree-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02133     <span class="comment">/*</span>
02134 <span class="comment">     * If we had a desktop, unlock it</span>
02135 <span class="comment">     */</span>
02136     <span class="keywordflow">if</span> (phkFree-&gt;rpdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02137         UserAssert(phkFree-&gt;flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>);
02138         UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phkFree) == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>);
02139         <a class="code" href="../../d4/d1/userk_8h.html#a127">UnlockDesktop</a>(&amp;phkFree-&gt;rpdesk, LDU_HOOK_DESK, 0);
02140     }
02141 }
02142 
02143 <span class="comment">/***************************************************************************\</span>
02144 <span class="comment">* PhkFirstGlobalValid</span>
02145 <span class="comment">*</span>
02146 <span class="comment">* Returns the first not-destroyed hook on the given desktop info.</span>
02147 <span class="comment">*</span>
02148 <span class="comment">* History:</span>
02149 <span class="comment">* 03/24/97 GerardoB Created</span>
02150 <span class="comment">\***************************************************************************/</span>
<a name="l02151"></a><a class="code" href="../../d4/d1/userk_8h.html#a1519">02151</a> <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> <a class="code" href="../../d4/d1/userk_8h.html#a1519">PhkFirstGlobalValid</a>(<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, <span class="keywordtype">int</span> nFilterType)
02152 {
02153     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk;
02154 
02155     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02156     phk = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o4">aphkStart</a>[nFilterType + 1];
02157     <span class="comment">/*</span>
02158 <span class="comment">     * Return the first hook that it's not destroyed (i.e, the</span>
02159 <span class="comment">     *  first valid one).</span>
02160 <span class="comment">     */</span>
02161     <span class="keywordflow">if</span> ((phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a509">HF_DESTROYED</a>)) {
02162         phk = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(phk);
02163     }
02164     <span class="comment">/*</span>
02165 <span class="comment">     * Good place to check fsHooks. If the bits are out of sync,</span>
02166 <span class="comment">     *  someone must be adjusting them.</span>
02167 <span class="comment">     */</span>
02168     <a class="code" href="../../d1/d2/hooks_8c.html#a7">DbgValidatefsHook</a>(phk, nFilterType, pti, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02169     <a class="code" href="../../d4/d1/userk_8h.html#a601">DbgValidateHooks</a>(phk, nFilterType);
02170     <span class="keywordflow">return</span> phk;
02171 }
02172 
02173 <span class="comment">/***************************************************************************\</span>
02174 <span class="comment">* PhkFirstValid</span>
02175 <span class="comment">*</span>
02176 <span class="comment">* Given a filter-type PhkFirstValid() returns the first hook, if any, of the</span>
02177 <span class="comment">* specified type.</span>
02178 <span class="comment">*</span>
02179 <span class="comment">* History:</span>
02180 <span class="comment">* 02-10-91  DavidPe         Created.</span>
02181 <span class="comment">\***************************************************************************/</span>
02182 
<a name="l02183"></a><a class="code" href="../../d4/d1/userk_8h.html#a1518">02183</a> <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> <a class="code" href="../../d4/d1/userk_8h.html#a1518">PhkFirstValid</a>(
02184     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
02185     <span class="keywordtype">int</span> nFilterType)
02186 {
02187     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk;
02188     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02189     <span class="comment">/*</span>
02190 <span class="comment">     * Grab the first hook off the local hook-list</span>
02191 <span class="comment">     * for the current queue.</span>
02192 <span class="comment">     */</span>
02193     phk = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o51">aphkStart</a>[nFilterType + 1];
02194     <span class="comment">/*</span>
02195 <span class="comment">     * If there aren't any local hooks, try the global hooks.</span>
02196 <span class="comment">     */</span>
02197     <span class="keywordflow">if</span> (phk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02198         phk = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o4">aphkStart</a>[nFilterType + 1];
02199     }
02200     <span class="comment">/*</span>
02201 <span class="comment">     * Return the first hook that it's not destroyed (i.e, the</span>
02202 <span class="comment">     *  first valid one).</span>
02203 <span class="comment">     */</span>
02204     <span class="keywordflow">if</span> ((phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a509">HF_DESTROYED</a>)) {
02205         phk = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a22">PhkNextValid</a>(phk);
02206     }
02207     <span class="comment">/*</span>
02208 <span class="comment">     * Good place to check fsHooks. If the bits are out of sync,</span>
02209 <span class="comment">     *  someone must be adjusting them.</span>
02210 <span class="comment">     */</span>
02211 
02212     <a class="code" href="../../d1/d2/hooks_8c.html#a7">DbgValidatefsHook</a>(phk, nFilterType, pti, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02213     <a class="code" href="../../d4/d1/userk_8h.html#a601">DbgValidateHooks</a>(phk, nFilterType);
02214     <span class="keywordflow">return</span> phk;
02215 }
02216 
02217 <span class="comment">/***************************************************************************\</span>
02218 <span class="comment">* FreeThreadsWindowHooks</span>
02219 <span class="comment">*</span>
02220 <span class="comment">* During 'exit-list' processing this function is called to free any hooks</span>
02221 <span class="comment">* created on, or set for the current queue.</span>
02222 <span class="comment">*</span>
02223 <span class="comment">* History:</span>
02224 <span class="comment">* 02-10-91  DavidPe         Created.</span>
02225 <span class="comment">\***************************************************************************/</span>
02226 
<a name="l02227"></a><a class="code" href="../../d4/d1/userk_8h.html#a1527">02227</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1527">FreeThreadsWindowHooks</a>(VOID)
02228 {
02229     <span class="keywordtype">int</span> iHook;
02230     <a class="code" href="../../d5/d6/structtagHOOK.html">PHOOK</a> phk, phkNext;
02231     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02232 
02233     <span class="comment">/*</span>
02234 <span class="comment">     * If there is not thread info, there are not hooks to worry about</span>
02235 <span class="comment">     */</span>
02236     <span class="keywordflow">if</span> (ptiCurrent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02237         <span class="keywordflow">return</span>;
02238     }
02239     <span class="comment">/*</span>
02240 <span class="comment">     * In case we have a hook locked in as the current hook unlock it</span>
02241 <span class="comment">     * so it can be freed</span>
02242 <span class="comment">     */</span>
02243     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o32">sphkCurrent</a>);
02244 
02245     UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>);
02246     <span class="comment">// Why bother doing this? We won't be calling back to user mode again!</span>
02247     <span class="comment">// if (ptiCurrent-&gt;pClientInfo) {</span>
02248     <span class="comment">//    ptiCurrent-&gt;pClientInfo-&gt;phkCurrent = NULL;</span>
02249     <span class="comment">// }</span>
02250 
02251     <span class="comment">/*</span>
02252 <span class="comment">     * Loop through all the hook types.</span>
02253 <span class="comment">     */</span>
02254     <span class="keywordflow">for</span> (iHook = WH_MIN ; iHook &lt;= WH_MAX ; ++iHook) {
02255         <span class="comment">/*</span>
02256 <span class="comment">         * Loop through all the hooks of this type, including the</span>
02257 <span class="comment">         *  ones already marked as destroyed (so don't call</span>
02258 <span class="comment">         *  PhkFirstValid and PhkNextValid).</span>
02259 <span class="comment">         */</span>
02260         phk = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o51">aphkStart</a>[iHook + 1];
02261         <span class="keywordflow">if</span> (phk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02262             phk = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o4">aphkStart</a>[iHook + 1];
02263             UserAssert((phk == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>));
02264         }
02265 
02266         <span class="keywordflow">while</span> (phk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02267             <span class="comment">/*</span>
02268 <span class="comment">             * We might free phk below, so grab the next now</span>
02269 <span class="comment">             * If at end of local chain, jump to the global chain</span>
02270 <span class="comment">             */</span>
02271             phkNext = phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a>;
02272             <span class="keywordflow">if</span> ((phkNext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !(phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>)) {
02273                 phkNext = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o7">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o4">aphkStart</a>[iHook + 1];
02274                 UserAssert((phkNext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (phkNext-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>));
02275             }
02276             <span class="comment">/*</span>
02277 <span class="comment">             * If this is a local(thread) hook, unlink it and mark it as</span>
02278 <span class="comment">             *  destroyed so we won't call it anymore. We want to do</span>
02279 <span class="comment">             *  this even if not calling FreeHook; also note that</span>
02280 <span class="comment">             *  FreeHook won't unlink it if locked so we do it here anyway.</span>
02281 <span class="comment">             */</span>
02282             <span class="keywordflow">if</span> (!(phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a502">HF_GLOBAL</a>)) {
02283                 UserAssert(ptiCurrent == phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o6">ptiHooked</a>);
02284                 <a class="code" href="../../d1/d2/hooks_8c.html#a10">UnlinkHook</a>(phk);
02285                 phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o4">flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a509">HF_DESTROYED</a>;
02286                 phk-&gt;<a class="code" href="../../d5/d6/structtagHOOK.html#o1">phkNext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02287             }
02288             <span class="comment">/*</span>
02289 <span class="comment">             * If this hook was created by this thread, free it</span>
02290 <span class="comment">             */</span>
02291             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(phk) == ptiCurrent) {
02292                 <a class="code" href="../../d4/d1/userk_8h.html#a1520">FreeHook</a>(phk);
02293             }
02294 
02295             phk = phkNext;
02296         }
02297        <span class="comment">/*</span>
02298 <span class="comment">        * All local hooks should be unlinked</span>
02299 <span class="comment">        */</span>
02300        UserAssert(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o51">aphkStart</a>[iHook + 1] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02301     } <span class="comment">/* for (iHook = WH_MIN....*/</span>
02302 
02303     <span class="comment">/*</span>
02304 <span class="comment">     * Keep fsHooks in sync.</span>
02305 <span class="comment">     */</span>
02306     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o31">fsHooks</a> = 0;
02307 }
02308 
02309 <span class="comment">/***************************************************************************\</span>
02310 <span class="comment">* zzzRegisterSystemThread: Private API</span>
02311 <span class="comment">*</span>
02312 <span class="comment">*  Used to set various attributes pertaining to a thread.</span>
02313 <span class="comment">*</span>
02314 <span class="comment">* History:</span>
02315 <span class="comment">* 21-Jun-1994 from Chicago Created.</span>
02316 <span class="comment">\***************************************************************************/</span>
02317 
<a name="l02318"></a><a class="code" href="../../d4/d1/userk_8h.html#a1488">02318</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1488">zzzRegisterSystemThread</a> (DWORD dwFlags, DWORD dwReserved)
02319 {
02320     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
02321 
02322     UserAssert(dwReserved == 0);
02323 
02324     <span class="keywordflow">if</span> (dwReserved != 0)
02325         <span class="keywordflow">return</span>;
02326 
02327     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
02328 
02329     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; RST_DONTATTACHQUEUE)
02330         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a801">TIF_DONTATTACHQUEUE</a>;
02331 
02332     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; RST_DONTJOURNALATTACH) {
02333         ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a802">TIF_DONTJOURNALATTACH</a>;
02334 
02335         <span class="comment">/*</span>
02336 <span class="comment">         * If we are already journaling, then this queue was already</span>
02337 <span class="comment">         * journal attached.  We need to unattach and reattach journaling</span>
02338 <span class="comment">         * so that we are removed from the journal attached queues.</span>
02339 <span class="comment">         */</span>
02340         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a419">FJOURNALPLAYBACK</a>() || <a class="code" href="../../d4/d1/userk_8h.html#a418">FJOURNALRECORD</a>()) {
02341             <a class="code" href="../../d1/d2/hooks_8c.html#a11">zzzJournalAttach</a>(ptiCurrent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02342             <a class="code" href="../../d1/d2/hooks_8c.html#a11">zzzJournalAttach</a>(ptiCurrent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02343         }
02344     }
02345 }
02346 
02347 <span class="preprocessor">#ifdef REDIRECTION</span>
02348 <span class="preprocessor"></span>
02349 <span class="comment">/***************************************************************************\</span>
02350 <span class="comment">* xxxGetCursorPos</span>
02351 <span class="comment">*</span>
02352 <span class="comment">\***************************************************************************/</span>
02353 
02354 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
02355 xxxGetCursorPos(
02356     LPPOINT lpPt)
02357 {
02358     POINT pt;
02359 
02360     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02361 
02362     <span class="comment">/*</span>
02363 <span class="comment">     * If there is no CBT hook installed bail out.</span>
02364 <span class="comment">     */</span>
02365     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a208">IsHooked</a>(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>(), WHF_CBT))
02366         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02367 
02368     <span class="keywordflow">try</span> {
02369         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(lpPt, <span class="keyword">sizeof</span>(RECT), DATAALIGN);
02370         RtlCopyMemory(&amp;pt, lpPt, <span class="keyword">sizeof</span>(RECT));
02371     } except (W32ExceptionHandler(FALSE, RIP_WARNING)) {
02372         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02373     }
02374 
02375     <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HCBT_GETCURSORPOS, 0, (LPARAM)&amp;pt, WH_CBT);
02376 
02377     <span class="keywordflow">try</span> {
02378         RtlCopyMemory(lpPt, &amp;pt, <span class="keyword">sizeof</span>(RECT));
02379     } except (W32ExceptionHandler(FALSE, RIP_WARNING)) {
02380         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02381     }
02382 
02383     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02384 }
02385 
02386 <span class="preprocessor">#endif // REDIRECTION</span>
02387 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:18 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
