<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: init386.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>init386.c</h1><a href="../../d1/d2/mm_2i386_2init386_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    init386.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the machine dependent initialization for the</span>
00012 <span class="comment">    memory management component.  It is specifically tailored to the</span>
00013 <span class="comment">    INTEL x86 and PAE machines.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Lou Perazzoli (loup) 6-Jan-1990</span>
00018 <span class="comment">    Landy Wang (landyw)  2-Jun-1997</span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00025 
00026 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00027 <a class="code" href="../../d8/d8/sysload_8c.html#a52">MiRemoveLowPages</a> (
00028     VOID
00029     );
00030 
00031 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiInitMachineDependent)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,MiRemoveLowPages)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00035 <span class="preprocessor"></span>
<a name="l00036"></a><a class="code" href="../../d1/d2/mm_2i386_2init386_8c.html#a0">00036</a> <span class="preprocessor">#define MM_BIOS_START (0xA0000 &gt;&gt; PAGE_SHIFT)</span>
<a name="l00037"></a><a class="code" href="../../d1/d2/mm_2i386_2init386_8c.html#a1">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_BIOS_END  (0xFFFFF &gt;&gt; PAGE_SHIFT)</span>
00038 <span class="preprocessor"></span>
<a name="l00039"></a><a class="code" href="../../d1/d2/mm_2i386_2init386_8c.html#a2">00039</a> <span class="preprocessor">#define MM_LARGE_PAGE_MINIMUM  ((127*1024*1024) &gt;&gt; PAGE_SHIFT)</span>
00040 <span class="preprocessor"></span>
<a name="l00041"></a><a class="code" href="../../d1/d2/mm_2i386_2init386_8c.html#a4">00041</a> SIZE_T <a class="code" href="../../d2/d1/inialpha_8c.html#a4">MmExpandedNonPagedPoolInBytes</a>;
00042 
<a name="l00043"></a><a class="code" href="../../d1/d2/mm_2i386_2init386_8c.html#a5">00043</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d5/d8/fssup_8c.html#a4">MmLargeSystemCache</a>;
<a name="l00044"></a><a class="code" href="../../d1/d2/mm_2i386_2init386_8c.html#a6">00044</a> <span class="keyword">extern</span> LOGICAL <a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a>;
<a name="l00045"></a><a class="code" href="../../d1/d2/mm_2i386_2init386_8c.html#a7">00045</a> <span class="keyword">extern</span> LOGICAL <a class="code" href="../../d1/d6/allocpag_8c.html#a10">MmPagedPoolMaximumDesired</a>;
00046 
00047 <span class="preprocessor">#if defined(_X86PAE_)</span>
00048 <span class="preprocessor"></span>LOGICAL MiUseGlobalBitInLargePdes;
00049 LOGICAL MiNeedLowVirtualPfn;
00050 LOGICAL <a class="code" href="../../d5/d6/iosup_8c.html#a15">MiNoLowMemory</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00051 PRTL_BITMAP MiLowMemoryBitMap;
00052 <span class="preprocessor">#endif</span>
00053 <span class="preprocessor"></span>
<a name="l00054"></a><a class="code" href="../../d1/d2/mm_2i386_2init386_8c.html#a3">00054</a> <span class="preprocessor">#define MI_LOWMEM_MAGIC_BIT (0x80000000)</span>
00055 <span class="preprocessor"></span>
00056 
00057 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00058"></a><a class="code" href="../../d1/d2/mm_2i386_2init386_8c.html#a9">00058</a> <a class="code" href="../../d2/d3/initppc_8c.html#a1">MiInitMachineDependent</a> (
00059     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00060     )
00061 
00062 <span class="comment">/*++</span>
00063 <span class="comment"></span>
00064 <span class="comment">Routine Description:</span>
00065 <span class="comment"></span>
00066 <span class="comment">    This routine performs the necessary operations to enable virtual</span>
00067 <span class="comment">    memory.  This includes building the page directory page, building</span>
00068 <span class="comment">    page table pages to map the code section, the data section, the</span>
00069 <span class="comment">    stack section and the trap handler.</span>
00070 <span class="comment"></span>
00071 <span class="comment">    It also initializes the PFN database and populates the free list.</span>
00072 <span class="comment"></span>
00073 <span class="comment">Arguments:</span>
00074 <span class="comment"></span>
00075 <span class="comment">    LoaderBlock  - Supplies a pointer to the firmware setup loader block.</span>
00076 <span class="comment"></span>
00077 <span class="comment">Return Value:</span>
00078 <span class="comment"></span>
00079 <span class="comment">    None.</span>
00080 <span class="comment"></span>
00081 <span class="comment">Environment:</span>
00082 <span class="comment"></span>
00083 <span class="comment">    Kernel mode.</span>
00084 <span class="comment"></span>
00085 <span class="comment">--*/</span>
00086 
00087 {
00088     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> BasePfn;
00089     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> BottomPfn;
00090     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> TopPfn;
00091     BOOLEAN PfnInKseg0;
00092     ULONG BasePage;
00093     ULONG HighPage;
00094     ULONG HighPageInKseg0;
00095     ULONG PagesLeft;
00096     ULONG Range;
00097     ULONG i, j;
00098     ULONG PdePageNumber;
00099     ULONG PdePage;
00100     ULONG PageFrameIndex;
00101     ULONG NextPhysicalPage;
00102     ULONG OldFreeDescriptorLowMemCount;
00103     ULONG OldFreeDescriptorLowMemBase;
00104     ULONG OldFreeDescriptorCount;
00105     ULONG OldFreeDescriptorBase;
00106     ULONG PfnAllocation;
00107     ULONG NumberOfPages;
00108     ULONG MaxPool;
00109     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00110     ULONG DirBase;
00111     ULONG MostFreePage;
00112     ULONG MostFreeLowMem;
00113     ULONG MostFreeLowMem512;
00114     PLIST_ENTRY NextMd;
00115     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> FreeDescriptor;
00116     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> FreeDescriptor512;
00117     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> FreeDescriptorLowMem;
00118     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> MemoryDescriptor;
00119     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> UsableDescriptor;
00120     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPde;
00121     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00122     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00123     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00124     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00125     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Pde;
00126     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPde;
00127     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPde;
00128     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00129     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00130     ULONG PdeCount;
00131     ULONG va;
00132     ULONG SavedSize;
00133     KIRQL OldIrql;
00134     ULONG MapLargePages;
00135     PVOID NonPagedPoolStartVirtual;
00136     ULONG LargestFreePfnCount;
00137     ULONG LargestFreePfnStart;
00138     ULONG ExtraPtes;
00139     ULONG FreePfnCount;
00140     SIZE_T UsableDescriptorRemoved;
00141     LOGICAL SwitchedDescriptors;
00142     LOGICAL NeedLowVirtualPfn;
00143     ULONG NextUsablePhysicalPage;
00144     LOGICAL UsingHighMemory;
00145     PVOID LowVirtualNonPagedPoolStart;
00146     ULONG LowVirtualNonPagedPoolSizeInBytes;
00147     LOGICAL ExtraSystemCacheViews;
00148 
00149     ExtraSystemCacheViews = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00150     SwitchedDescriptors = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00151     PfnInKseg0 = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00152     MostFreePage = 0;
00153     MostFreeLowMem = 0;
00154     MostFreeLowMem512 = 0;
00155     MapLargePages = 0;
00156     LargestFreePfnCount = 0;
00157     UsableDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00158     UsableDescriptorRemoved = 0;
00159 
00160     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/init_8h.html#a21">InitializationPhase</a> == 1) {
00161 
00162         <span class="comment">//</span>
00163         <span class="comment">// If the kernel image has not been biased to allow for 3gb of user</span>
00164         <span class="comment">// space, the host processor supports large pages, and the number of</span>
00165         <span class="comment">// physical pages is greater than 127mb, then map the kernel image,</span>
00166         <span class="comment">// HAL, and boot drivers into a large page.</span>
00167         <span class="comment">//</span>
00168 
00169         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> == 0) &amp;&amp;
00170 <span class="preprocessor">#if defined (_X86PAE_)</span>
00171 <span class="preprocessor"></span>            (MiNeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00172 <span class="preprocessor">#endif</span>
00173 <span class="preprocessor"></span>            (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a5">KF_LARGE_PAGE</a>) &amp;&amp;
00174             (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a31">MmLargePageMinimum</a>)) {
00175 
00176             <span class="comment">//</span>
00177             <span class="comment">// Map lower 512MB of physical memory as large pages starting</span>
00178             <span class="comment">// at address 0x80000000.</span>
00179             <span class="comment">//</span>
00180 
00181             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00182 
00183             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a3">MM_KSEG0_BASE</a>);
00184             LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d6/d8/mi386_8h.html#a11">MM_KSEG2_BASE</a>);
00185             TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a7">ValidKernelPde</a>;
00186             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = 0;
00187             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.LargePage = 1;
00188 <span class="preprocessor">#if defined(_X86PAE_)</span>
00189 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MiUseGlobalBitInLargePdes == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00190                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Global = 1;
00191             }
00192 <span class="preprocessor">#endif</span>
00193 <span class="preprocessor"></span>
00194             <span class="keywordflow">do</span> {
00195                 <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00196                     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPde);
00197                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00198                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
00199                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00200                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
00201                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00202                     <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
00203                     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde),
00204                                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00205                                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00206                                      (PHARDWARE_PTE)PointerPde,
00207                                      TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
00208                     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);  <span class="comment">//p6 errata...</span>
00209 
00210                 } <span class="keywordflow">else</span> {
00211                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPde, TempPte);
00212                 }
00213 
00214                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber += <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00215                 PointerPde += 1;
00216             } <span class="keywordflow">while</span> (PointerPde &lt; LastPte);
00217 
00218             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00219 
00220             <a class="code" href="../../d2/d2/data386_8c.html#a19">MmKseg2Frame</a> = (512*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00221         }
00222 
00223         <span class="keywordflow">return</span>;
00224     }
00225 
00226     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d1/init_8h.html#a21">InitializationPhase</a> == 0);
00227 
00228     <span class="comment">//</span>
00229     <span class="comment">// Enabling special IRQL automatically disables mapping the kernel with</span>
00230     <span class="comment">// large pages so we can catch kernel and HAL code.</span>
00231     <span class="comment">//</span>
00232 
00233     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a>) {
00234         <a class="code" href="../../d8/d0/cmdat3_8c.html#a31">MmLargePageMinimum</a> = (ULONG)-2;
00235     }
00236     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a31">MmLargePageMinimum</a> == 0) {
00237         <a class="code" href="../../d8/d0/cmdat3_8c.html#a31">MmLargePageMinimum</a> = <a class="code" href="../../d1/d2/mm_2i386_2init386_8c.html#a2">MM_LARGE_PAGE_MINIMUM</a>;
00238     }
00239 
00240     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00241         <a class="code" href="../../d8/d0/cmdat3_8c.html#a31">MmLargePageMinimum</a> = (ULONG)-2;
00242     }
00243 
00244     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a29">MmDynamicPfn</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00245         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> != 0) {
00246             <a class="code" href="../../d8/d0/cmdat3_8c.html#a29">MmDynamicPfn</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00247         }
00248         <a class="code" href="../../d8/d0/cmdat3_8c.html#a31">MmLargePageMinimum</a> = (ULONG)-2;
00249     }
00250 
00251     <span class="comment">//</span>
00252     <span class="comment">// If the host processor supports global bits, then set the global</span>
00253     <span class="comment">// bit in the template kernel PTE and PDE entries.</span>
00254     <span class="comment">//</span>
00255 
00256     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a4">KF_GLOBAL_PAGE</a>) {
00257         <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long |= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a76">MM_PTE_GLOBAL_MASK</a>;
00258 <span class="preprocessor">#if defined(_X86PAE_)</span>
00259 <span class="preprocessor"></span>        <span class="comment">//</span>
00260         <span class="comment">// Note that the PAE mode of the processor does not support the</span>
00261         <span class="comment">// global bit in PDEs which map 4K page table pages.</span>
00262         <span class="comment">//</span>
00263         MiUseGlobalBitInLargePdes = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00264 <span class="preprocessor">#else</span>
00265 <span class="preprocessor"></span>        <a class="code" href="../../d4/d2/datalpha_8c.html#a7">ValidKernelPde</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long |= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a76">MM_PTE_GLOBAL_MASK</a>;
00266 <span class="preprocessor">#endif</span>
00267 <span class="preprocessor"></span>        <a class="code" href="../../d2/d2/data386_8c.html#a2">MmPteGlobal</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a76">MM_PTE_GLOBAL_MASK</a>;
00268     }
00269 
00270     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
00271     TempPde = <a class="code" href="../../d4/d2/datalpha_8c.html#a7">ValidKernelPde</a>;
00272 
00273     <span class="comment">//</span>
00274     <span class="comment">// Set the directory base for the system process.</span>
00275     <span class="comment">//</span>
00276 
00277     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PDE_BASE);
00278     PdePageNumber = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPte);
00279 <span class="preprocessor">#if defined(_X86PAE_)</span>
00280 <span class="preprocessor"></span>
00281     <a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>;
00282 
00283     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;PaePageDirectoryPage = PdePageNumber;
00284     _asm {
00285         mov     eax, cr3
00286         mov     DirBase, eax
00287     }
00288 
00289     <span class="comment">//</span>
00290     <span class="comment">// Note cr3 must be 32-byte aligned.</span>
00291     <span class="comment">//</span>
00292 
00293     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((DirBase &amp; 0x1f) == 0);
00294 <span class="preprocessor">#else</span>
00295 <span class="preprocessor"></span>    DirBase = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPte) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00296 <span class="preprocessor">#endif</span>
00297 <span class="preprocessor"></span>    <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Pcb.DirectoryTableBase[0] = DirBase;
00298     <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a6">KeSweepDcache</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00299 
00300     <span class="comment">//</span>
00301     <span class="comment">// Unmap the low 2Gb of memory.</span>
00302     <span class="comment">//</span>
00303 
00304     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(0);
00305     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> - 0x10000 - 1);
00306     <span class="keywordflow">while</span> (PointerPde &lt;= LastPte) {
00307         *PointerPde = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
00308         PointerPde += 1;
00309     }
00310 
00311     <span class="comment">//</span>
00312     <span class="comment">// Get the lower bound of the free physical memory and the</span>
00313     <span class="comment">// number of physical pages by walking the memory descriptor lists.</span>
00314     <span class="comment">//</span>
00315 
00316     FreeDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00317     FreeDescriptor512 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00318     NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
00319     <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
00320         MemoryDescriptor = CONTAINING_RECORD(NextMd,
00321                                              <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
00322                                              ListEntry);
00323 
00324         <span class="keywordflow">if</span> ((MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> != <a class="code" href="../../d1/d9/arc_8h.html#a320a260">LoaderFirmwarePermanent</a>) &amp;&amp;
00325             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> != <a class="code" href="../../d1/d9/arc_8h.html#a320a277">LoaderBBTMemory</a>) &amp;&amp;
00326             (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> != <a class="code" href="../../d1/d9/arc_8h.html#a320a276">LoaderSpecialMemory</a>)) {
00327 
00328             <span class="comment">//</span>
00329             <span class="comment">// This check results in /BURNMEMORY chunks not being counted.</span>
00330             <span class="comment">//</span>
00331 
00332             <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> != <a class="code" href="../../d1/d9/arc_8h.html#a320a257">LoaderBad</a>) {
00333                 <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> += MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00334             }
00335 
00336             <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &lt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>) {
00337                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a> = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00338             }
00339 
00340             <span class="keywordflow">if</span> ((MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>) &gt;
00341                                                              <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
00342                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> =
00343                         MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> - 1;
00344             }
00345 
00346             <span class="comment">//</span>
00347             <span class="comment">// Locate the largest free block and the largest free</span>
00348             <span class="comment">// block below 16mb.</span>
00349             <span class="comment">//</span>
00350 
00351             <span class="keywordflow">if</span> ((MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a256">LoaderFree</a>) ||
00352                 (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a258">LoaderLoadedProgram</a>) ||
00353                 (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a259">LoaderFirmwareTemporary</a>) ||
00354                 (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a262">LoaderOsloaderStack</a>)) {
00355 
00356                 <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &gt; MostFreePage) {
00357                     MostFreePage = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00358                     FreeDescriptor = MemoryDescriptor;
00359                 }
00360 
00361                 <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &lt; 0x20000) {
00362 
00363                     <span class="comment">//</span>
00364                     <span class="comment">// This memory descriptor is below 512mb.</span>
00365                     <span class="comment">//</span>
00366 
00367                     <span class="keywordflow">if</span> ((MostFreeLowMem512 &lt; MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>) &amp;&amp;
00368                         (MostFreeLowMem512 &lt; ((ULONG)0x20000 - MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>))) {
00369 
00370                         MostFreeLowMem512 = (ULONG)0x20000 - MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00371                         <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &lt; MostFreeLowMem512) {
00372                             MostFreeLowMem512 = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00373                         }
00374 
00375                         FreeDescriptor512 = MemoryDescriptor;
00376                     }
00377                 }
00378 
00379                 <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &lt; 0x1000) {
00380 
00381                     <span class="comment">//</span>
00382                     <span class="comment">// This memory descriptor is below 16mb.</span>
00383                     <span class="comment">//</span>
00384 
00385                     <span class="keywordflow">if</span> ((MostFreeLowMem &lt; MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>) &amp;&amp;
00386                         (MostFreeLowMem &lt; ((ULONG)0x1000 - MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>))) {
00387 
00388                         MostFreeLowMem = (ULONG)0x1000 - MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00389                         <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &lt; MostFreeLowMem) {
00390                             MostFreeLowMem = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00391                         }
00392 
00393                         FreeDescriptorLowMem = MemoryDescriptor;
00394                     }
00395                 }
00396             }
00397         }
00398 
00399         NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
00400     }
00401 
00402     <span class="keywordflow">if</span> (FreeDescriptorLowMem == FreeDescriptor) {
00403         FreeDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00404     }
00405 
00406     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/fssup_8c.html#a4">MmLargeSystemCache</a> != 0) {
00407         ExtraSystemCacheViews = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00408     }
00409 
00410     NeedLowVirtualPfn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00411 
00412     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a29">MmDynamicPfn</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00413 <span class="preprocessor">#if defined(_X86PAE_)</span>
00414 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a325">ExVerifySuite</a>(DataCenter) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00415             <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> = 0x1000000 - 1;
00416         }
00417         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a52">MmProductType</a> != 0x00690057) &amp;&amp;
00418                  (<a class="code" href="../../d5/d8/ex_8h.html#a325">ExVerifySuite</a>(Enterprise) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00419             <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> = 0x200000 - 1;
00420         }
00421         <span class="keywordflow">else</span> {
00422             <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> = 0x100000 - 1;
00423         }
00424 <span class="preprocessor">#else</span>
00425 <span class="preprocessor"></span>        <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> = 0x100000 - 1;
00426 <span class="preprocessor">#endif</span>
00427 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> == 0) {
00428             NeedLowVirtualPfn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00429         }
00430     }
00431     <span class="keywordflow">else</span> {
00432         <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>;
00433     }
00434 
00435     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> &gt; 0x400000 - 1) {
00436 
00437         <span class="comment">//</span>
00438         <span class="comment">// The PFN database is more than 112mb.  Force it to come from the</span>
00439         <span class="comment">// 2GB-&gt;3GB virtual address range.  Note the administrator cannot be</span>
00440         <span class="comment">// booting /3GB as when he does, the loader throws away memory</span>
00441         <span class="comment">// above the physical 16GB line.</span>
00442         <span class="comment">//</span>
00443 
00444         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> == 0);
00445 
00446         <span class="comment">//</span>
00447         <span class="comment">// The virtual space between 0xA4000000 and 0xC0000000 is best used</span>
00448         <span class="comment">// for system PTEs when this much physical memory is present.</span>
00449         <span class="comment">//</span>
00450 
00451         ExtraSystemCacheViews = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00452     }
00453 
00454     <span class="comment">//</span>
00455     <span class="comment">// Two large descriptors have been saved.  If the one below 512mb</span>
00456     <span class="comment">// is sufficiently large, use that one as then large pages can be</span>
00457     <span class="comment">// applied to map it and the PFN database can be put in it.</span>
00458     <span class="comment">// Only do this if the PFN database size is small enough such that it</span>
00459     <span class="comment">// doesn't consume so much virtual space between 2gb and 2gb+512mb - ie:</span>
00460     <span class="comment">// there has to be enough virtual space to map initial nonpaged pool in</span>
00461     <span class="comment">// there.</span>
00462     <span class="comment">//</span>
00463 
00464     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> &gt; 0x100000) {
00465 
00466         <span class="comment">//</span>
00467         <span class="comment">// The 0x700000 (== 28GB) is chosen carefully so that the start of</span>
00468         <span class="comment">// expanded nonpaged pool is always above the nonpaged system start.</span>
00469         <span class="comment">//</span>
00470 
00471         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> &lt; 0x700000) {
00472 
00473             <span class="keywordflow">if</span> ((FreeDescriptor512 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00474                 (FreeDescriptor512 != FreeDescriptor) &amp;&amp;
00475                 (FreeDescriptor512 != FreeDescriptorLowMem)) {
00476         
00477                 <span class="keywordflow">if</span> (MostFreeLowMem512 &gt;= ((<a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> * <span class="keyword">sizeof</span> (<a class="code" href="../../d4/d3/struct__MMPFN.html">MMPFN</a>) + <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a30">MM_MAX_INITIAL_NONPAGED_POOL</a>) / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
00478     
00479                     FreeDescriptor = FreeDescriptor512;
00480                     MostFreePage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00481                 }
00482             }
00483     
00484             <span class="keywordflow">if</span> (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &gt;= 0x20000) {
00485                 NeedLowVirtualPfn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00486             }
00487         }
00488         <span class="keywordflow">else</span> {
00489             NeedLowVirtualPfn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00490         }
00491     }
00492     
00493 <span class="preprocessor">#if defined(_X86PAE_)</span>
00494 <span class="preprocessor"></span>
00495     <span class="comment">//</span>
00496     <span class="comment">// Only PAE machines with at least 5GB of physical memory get to use this</span>
00497     <span class="comment">// and then only if they are NOT booted /3GB.</span>
00498     <span class="comment">//</span>
00499 
00500     <span class="keywordflow">if</span> (strstr(LoaderBlock-&gt;LoadOptions, <span class="stringliteral">"NOLOWMEM"</span>)) {
00501         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> == 0) &amp;&amp;
00502             (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt;= 5 * 1024 * 1024 / 4)) {
00503                 <a class="code" href="../../d5/d6/iosup_8c.html#a15">MiNoLowMemory</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00504                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00505                 NeedLowVirtualPfn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00506         }
00507     }
00508 
00509     MiNeedLowVirtualPfn = NeedLowVirtualPfn;
00510 <span class="preprocessor">#endif</span>
00511 <span class="preprocessor"></span>
00512     NextPhysicalPage = FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00513 
00514     OldFreeDescriptorLowMemCount = FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00515     OldFreeDescriptorLowMemBase = FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00516 
00517     <span class="keywordflow">if</span> (FreeDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00518         OldFreeDescriptorCount = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00519         OldFreeDescriptorBase = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00520     }
00521 
00522     NumberOfPages = FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00523     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt; 1100) {
00524         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (INSTALL_MORE_MEMORY,
00525                       <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>,
00526                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>,
00527                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>,
00528                       0);
00529     }
00530 
00531     <span class="comment">//</span>
00532     <span class="comment">// Build non-paged pool using the physical pages following the</span>
00533     <span class="comment">// data page in which to build the pool from.  Non-paged pool grows</span>
00534     <span class="comment">// from the high range of the virtual address space and expands</span>
00535     <span class="comment">// downward.</span>
00536     <span class="comment">//</span>
00537     <span class="comment">// At this time non-paged pool is constructed so virtual addresses</span>
00538     <span class="comment">// are also physically contiguous.</span>
00539     <span class="comment">//</span>
00540 
00541     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) &gt;
00542                         (7 * (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt;&gt; 3))) {
00543 
00544         <span class="comment">//</span>
00545         <span class="comment">// More than 7/8 of memory is allocated to nonpagedpool, reset to 0.</span>
00546         <span class="comment">//</span>
00547 
00548         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = 0;
00549     }
00550 
00551     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a620">MmMinimumNonPagedPoolSize</a>) {
00552 
00553         <span class="comment">//</span>
00554         <span class="comment">// Calculate the size of nonpaged pool.</span>
00555         <span class="comment">// Use the minimum size, then for every MB above 4mb add extra</span>
00556         <span class="comment">// pages.</span>
00557         <span class="comment">//</span>
00558 
00559         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = <a class="code" href="../../d4/d8/mi_8h.html#a620">MmMinimumNonPagedPoolSize</a>;
00560 
00561         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> +=
00562                             ((<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> - 1024)/256) *
00563                             <a class="code" href="../../d4/d8/mi_8h.html#a622">MmMinAdditionNonPagedPoolPerMb</a>;
00564     }
00565 
00566     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a30">MM_MAX_INITIAL_NONPAGED_POOL</a>) {
00567         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a30">MM_MAX_INITIAL_NONPAGED_POOL</a>;
00568     }
00569 
00570     <span class="comment">//</span>
00571     <span class="comment">// Align to page size boundary.</span>
00572     <span class="comment">//</span>
00573 
00574     <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &amp;= ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
00575 
00576     <span class="comment">//</span>
00577     <span class="comment">// Calculate the maximum size of pool.</span>
00578     <span class="comment">//</span>
00579 
00580     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> == 0) {
00581 
00582         <span class="comment">//</span>
00583         <span class="comment">// Calculate the size of nonpaged pool.  If 4mb or less use</span>
00584         <span class="comment">// the minimum size, then for every MB above 4mb add extra</span>
00585         <span class="comment">// pages.</span>
00586         <span class="comment">//</span>
00587 
00588         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> = <a class="code" href="../../d4/d8/mi_8h.html#a621">MmDefaultMaximumNonPagedPool</a>;
00589 
00590         <span class="comment">//</span>
00591         <span class="comment">// Make sure enough expansion for the PFN database exists.</span>
00592         <span class="comment">//</span>
00593 
00594         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> += (ULONG)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (
00595                                       (<a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__MMPFN.html">MMPFN</a>));
00596 
00597         <span class="comment">//</span>
00598         <span class="comment">// Only use the new formula for autosizing nonpaged pool on machines</span>
00599         <span class="comment">// with at least 512MB.  The new formula allocates 1/2 as much nonpaged</span>
00600         <span class="comment">// pool per MB but scales much higher - machines with ~1.2GB or more</span>
00601         <span class="comment">// get 256MB of nonpaged pool.  Note that the old formula gave machines</span>
00602         <span class="comment">// with 512MB of RAM 128MB of nonpaged pool so this behavior is</span>
00603         <span class="comment">// preserved with the new formula as well.</span>
00604         <span class="comment">//</span>
00605 
00606         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt;= 0x1f000) {
00607             <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> +=
00608                             ((<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> - 1024)/256) *
00609                             (<a class="code" href="../../d4/d8/mi_8h.html#a623">MmMaxAdditionNonPagedPoolPerMb</a> / 2);
00610 
00611             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a31">MM_MAX_ADDITIONAL_NONPAGED_POOL</a>) {
00612                 <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a31">MM_MAX_ADDITIONAL_NONPAGED_POOL</a>;
00613             }
00614         }
00615         <span class="keywordflow">else</span> {
00616             <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> +=
00617                             ((<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> - 1024)/256) *
00618                             <a class="code" href="../../d4/d8/mi_8h.html#a623">MmMaxAdditionNonPagedPoolPerMb</a>;
00619         }
00620     }
00621 
00622     MaxPool = <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> * 16 +
00623                                    (ULONG)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (
00624                                         (<a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__MMPFN.html">MMPFN</a>));
00625 
00626     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &lt; MaxPool) {
00627         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> = MaxPool;
00628     }
00629 
00630     <span class="comment">//</span>
00631     <span class="comment">// Systems that are booted /3GB have a 128MB nonpaged pool maximum,</span>
00632     <span class="comment">//</span>
00633     <span class="comment">// Systems that have a full 2GB system virtual address space, support</span>
00634     <span class="comment">// large pages, and have sufficient physical memory are allowed up to 256MB</span>
00635     <span class="comment">// of nonpaged pool.</span>
00636     <span class="comment">//</span>
00637 
00638     <a class="code" href="../../d2/d1/inialpha_8c.html#a4">MmExpandedNonPagedPoolInBytes</a> = 0;
00639 
00640     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> == 0) &amp;&amp;
00641         (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a5">KF_LARGE_PAGE</a>) &amp;&amp;
00642         (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00643         (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a31">MmLargePageMinimum</a>)) {
00644 
00645         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a30">MM_MAX_INITIAL_NONPAGED_POOL</a> + <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a31">MM_MAX_ADDITIONAL_NONPAGED_POOL</a>) {
00646             <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a30">MM_MAX_INITIAL_NONPAGED_POOL</a> + <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a31">MM_MAX_ADDITIONAL_NONPAGED_POOL</a>;
00647         }
00648 
00649         <span class="comment">//</span>
00650         <span class="comment">// Initialize the expanded amount to the highest possible value as</span>
00651         <span class="comment">// there may not be enough contiguous pages in the FreeDescriptorLowMem</span>
00652         <span class="comment">// below 512MB to get the initial pool to its maximal size.</span>
00653         <span class="comment">//</span>
00654 
00655         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a31">MM_MAX_ADDITIONAL_NONPAGED_POOL</a>) {
00656 
00657             <a class="code" href="../../d2/d1/inialpha_8c.html#a4">MmExpandedNonPagedPoolInBytes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a31">MM_MAX_ADDITIONAL_NONPAGED_POOL</a>;
00658             <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> -
00659                                                 <a class="code" href="../../d2/d1/inialpha_8c.html#a4">MmExpandedNonPagedPoolInBytes</a>;
00660         }
00661     }
00662     <span class="keywordflow">else</span> {
00663         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a31">MM_MAX_ADDITIONAL_NONPAGED_POOL</a>) {
00664             <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a31">MM_MAX_ADDITIONAL_NONPAGED_POOL</a>;
00665         }
00666     }
00667 
00668     <span class="comment">//</span>
00669     <span class="comment">// Get secondary color value from:</span>
00670     <span class="comment">//</span>
00671     <span class="comment">// (a) from the registry (already filled in) or</span>
00672     <span class="comment">// (b) from the PCR or</span>
00673     <span class="comment">// (c) default value.</span>
00674     <span class="comment">//</span>
00675 
00676     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> == 0) {
00677         <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a1">KeGetPcr</a>()-&gt;SecondLevelCacheSize;
00678     }
00679 
00680     <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> = <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00681 
00682     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> == 0) {
00683         <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a60">MM_SECONDARY_COLORS_DEFAULT</a>;
00684 
00685     } <span class="keywordflow">else</span> {
00686 
00687         <span class="comment">//</span>
00688         <span class="comment">// Make sure the value is a power of two and within limits.</span>
00689         <span class="comment">//</span>
00690 
00691         <span class="keywordflow">if</span> (((<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> &amp; (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> -1)) != 0) ||
00692             (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a61">MM_SECONDARY_COLORS_MIN</a>) ||
00693             (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a62">MM_SECONDARY_COLORS_MAX</a>)) {
00694             <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a60">MM_SECONDARY_COLORS_DEFAULT</a>;
00695         }
00696     }
00697 
00698     <span class="comment">//</span>
00699     <span class="comment">// Add in the PFN database size (based on the number of pages required</span>
00700     <span class="comment">// from page zero to the highest page).</span>
00701     <span class="comment">//</span>
00702     <span class="comment">// Get the number of secondary colors and add the array for tracking</span>
00703     <span class="comment">// secondary colors to the end of the PFN database.</span>
00704     <span class="comment">//</span>
00705 
00706     PfnAllocation = 1 + ((((<a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a438">MMPFN</a>)) +
00707                         (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>)*2))
00708                             &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00709 
00710     <span class="keywordflow">if</span> (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00711         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> += PfnAllocation &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00712     }
00713 
00714     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/inialpha_8c.html#a4">MmExpandedNonPagedPoolInBytes</a>) {
00715         <span class="keywordflow">if</span> (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00716             <a class="code" href="../../d2/d1/inialpha_8c.html#a4">MmExpandedNonPagedPoolInBytes</a> += PfnAllocation &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00717         }
00718         <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> = (PVOID)((ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a24">MmNonPagedPoolEnd</a>
00719                                           - <a class="code" href="../../d2/d1/inialpha_8c.html#a4">MmExpandedNonPagedPoolInBytes</a>);
00720     }
00721     <span class="keywordflow">else</span> {
00722         <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> = (PVOID)((ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a24">MmNonPagedPoolEnd</a>
00723                                           - <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a>);
00724     }
00725 
00726     <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> = (PVOID)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>);
00727 
00728     <a class="code" href="../../d4/d8/mi_8h.html#a653">MmPageAlignedPoolBase</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] = <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>;
00729 
00730     <span class="comment">//</span>
00731     <span class="comment">// Allocate additional paged pool provided it can fit and either the</span>
00732     <span class="comment">// user asked for it or we decide 460MB of PTE space is sufficient.</span>
00733     <span class="comment">//</span>
00734 
00735     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> == 0) &amp;&amp;
00736         ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> == (SIZE_T)-1) ||
00737          ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> == 0) &amp;&amp;
00738          (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt;= (1 * 1024 * 1024 * 1024 / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) &amp;&amp;
00739          ((<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) || (<a class="code" href="../../d8/d0/cmdat3_8c.html#a54">ExpMultiUserTS</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) &amp;&amp;
00740          (<a class="code" href="../../d4/d8/mi_8h.html#a633">MiRequestedSystemPtes</a> != (ULONG)-1)))) {
00741 
00742         ExtraSystemCacheViews = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00743         <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = 3000;
00744         <a class="code" href="../../d1/d6/allocpag_8c.html#a10">MmPagedPoolMaximumDesired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00745 
00746         <span class="comment">//</span>
00747         <span class="comment">// Make sure we always allocate extra PTEs later as we have crimped</span>
00748         <span class="comment">// the initial allocation here.</span>
00749         <span class="comment">//</span>
00750 
00751         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) || (<a class="code" href="../../d8/d0/cmdat3_8c.html#a54">ExpMultiUserTS</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00752             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt;= 0x7F00) {
00753                 <a class="code" href="../../d4/d8/mi_8h.html#a633">MiRequestedSystemPtes</a> = (ULONG)-1;
00754             }
00755         }
00756     }
00757 
00758     <span class="comment">//</span>
00759     <span class="comment">// Calculate the starting PDE for the system PTE pool which is</span>
00760     <span class="comment">// right below the nonpaged pool.</span>
00761     <span class="comment">//</span>
00762 
00763     <a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a> = (PVOID)(((ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> -
00764                                 ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> + 1) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) &amp;
00765                                  (~<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a49">PAGE_DIRECTORY_MASK</a>));
00766 
00767     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a> &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a22">MM_LOWEST_NONPAGED_SYSTEM_START</a>) {
00768         <a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a22">MM_LOWEST_NONPAGED_SYSTEM_START</a>;
00769         <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = (((ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> -
00770                                  (ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)-1;
00771 
00772         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> &gt; 1000);
00773     }
00774 
00775     <span class="comment">//</span>
00776     <span class="comment">// Set up page table pages to map nonpaged pool and system PTEs.</span>
00777     <span class="comment">// If possible, use higher physical pages to preserve more low</span>
00778     <span class="comment">// memory for drivers.</span>
00779     <span class="comment">//</span>
00780 
00781     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>);
00782     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> ((PVOID)((PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a24">MmNonPagedPoolEnd</a> - 1));
00783 
00784     UsingHighMemory = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00785     <span class="keywordflow">if</span> (NextPhysicalPage &lt; (FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> +
00786                             FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>)) {
00787 
00788         ULONG PagesNeeded;
00789     
00790         <span class="comment">//</span>
00791         <span class="comment">// We haven't used the other descriptor yet, examine it now</span>
00792         <span class="comment">// to see if enough usable memory is available.</span>
00793         <span class="comment">//</span>
00794 
00795         PagesNeeded = (EndPde - StartPde + 1);
00796 
00797         <span class="keywordflow">if</span> ((FreeDescriptor) &amp;&amp; (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &gt;= PagesNeeded)) {
00798 
00799             UsableDescriptor = FreeDescriptor;
00800             NextUsablePhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00801 
00802             UsableDescriptorRemoved += PagesNeeded;
00803 
00804             <span class="comment">//</span>
00805             <span class="comment">// Note this must be undone if the PFN database is created in</span>
00806             <span class="comment">// virtual memory because the memory descriptors are scanned</span>
00807             <span class="comment">// and only pages in the descriptors get mapped.</span>
00808             <span class="comment">//</span>
00809 
00810             UsableDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> += PagesNeeded;
00811             UsableDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> -= PagesNeeded;
00812             UsingHighMemory = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00813         }
00814     }
00815 
00816     <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
00817 
00818         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00819 
00820         <span class="comment">//</span>
00821         <span class="comment">// Map in a page table page.</span>
00822         <span class="comment">//</span>
00823 
00824         <span class="keywordflow">if</span> (UsingHighMemory == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00825             TempPde.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextUsablePhysicalPage;
00826             NextUsablePhysicalPage += 1;
00827         }
00828         <span class="keywordflow">else</span> {
00829             TempPde.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
00830             NextPhysicalPage += 1;
00831             NumberOfPages -= 1;
00832 
00833             <span class="keywordflow">if</span> (NumberOfPages == 0) {
00834                 <span class="keywordflow">if</span> (FreeDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00835                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (INSTALL_MORE_MEMORY,
00836                                   <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>,
00837                                   <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>,
00838                                   <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>,
00839                                   1);
00840                 }
00841                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NextPhysicalPage != (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> +
00842                                              FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>));
00843                 NextPhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00844                 NumberOfPages = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00845                 SwitchedDescriptors = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00846             }
00847         }
00848 
00849         *StartPde = TempPde;
00850         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (StartPde);
00851         RtlZeroMemory (PointerPte, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00852         StartPde += 1;
00853     }
00854 
00855     ExtraPtes = 0;
00856 
00857     <a class="code" href="../../d2/d2/data386_8c.html#a28">MiMaximumSystemCacheSizeExtra</a> = 0;
00858 
00859     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> == 0) {
00860 
00861         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a633">MiRequestedSystemPtes</a> == (ULONG)-1) ||
00862             ((<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (<a class="code" href="../../d8/d0/cmdat3_8c.html#a54">ExpMultiUserTS</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) ||
00863             (<a class="code" href="../../d2/d1/mm_8h.html#a159">MmSpecialPoolTag</a> &amp;&amp; <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt; 0x7F00)) {
00864 
00865             ExtraPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(<a class="code" href="../../d6/d8/mi386_8h.html#a7">KSTACK_POOL_SIZE</a>) - 1;
00866         }
00867         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExtraSystemCacheViews == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00868 
00869             <span class="comment">//</span>
00870             <span class="comment">// If the system is configured to favor large system caching, use</span>
00871             <span class="comment">// the remaining virtual address space for the system cache.  This</span>
00872             <span class="comment">// is possible since the 3GB user space option has not been</span>
00873             <span class="comment">// enabled, Hydra has not been chosen and extended special pool</span>
00874             <span class="comment">// is not enabled.</span>
00875             <span class="comment">//</span>
00876 
00877             <a class="code" href="../../d2/d2/data386_8c.html#a28">MiMaximumSystemCacheSizeExtra</a> =
00878                 (<a class="code" href="../../d6/d8/mi386_8h.html#a34">MM_SYSTEM_CACHE_END_EXTRA</a> - <a class="code" href="../../d6/d8/mi386_8h.html#a33">MM_SYSTEM_CACHE_START_EXTRA</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00879         }
00880         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt; 0x7F00) {
00881             ExtraPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(<a class="code" href="../../d6/d8/mi386_8h.html#a7">KSTACK_POOL_SIZE</a>) - 1;
00882         }
00883 
00884         <span class="keywordflow">if</span> (ExtraPtes) {
00885             StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d6/d8/mi386_8h.html#a5">KSTACK_POOL_START</a>);
00886             EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> ((PVOID)((PCHAR)<a class="code" href="../../d6/d8/mi386_8h.html#a5">KSTACK_POOL_START</a> +
00887                             (ExtraPtes &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) - 1));
00888 
00889             <span class="comment">//</span>
00890             <span class="comment">// If possible, use higher physical pages to preserve more low</span>
00891             <span class="comment">// memory for drivers.</span>
00892             <span class="comment">//</span>
00893 
00894             UsingHighMemory = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00895             <span class="keywordflow">if</span> (NextPhysicalPage &lt; (FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> +
00896                                     FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>)) {
00897         
00898                 ULONG PagesNeeded;
00899             
00900                 <span class="comment">//</span>
00901                 <span class="comment">// We haven't used the other descriptor yet, examine it now</span>
00902                 <span class="comment">// to see if enough usable memory is available.</span>
00903                 <span class="comment">//</span>
00904         
00905                 PagesNeeded = (EndPde - StartPde + 1);
00906         
00907                 <span class="keywordflow">if</span> ((FreeDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &gt;= PagesNeeded)) {
00908         
00909                     UsableDescriptor = FreeDescriptor;
00910                     NextUsablePhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00911         
00912                     UsableDescriptorRemoved += PagesNeeded;
00913         
00914                     <span class="comment">//</span>
00915                     <span class="comment">// Note this must be undone if the PFN database is</span>
00916                     <span class="comment">// created in virtual memory because the memory</span>
00917                     <span class="comment">// descriptors are scanned and only pages in the</span>
00918                     <span class="comment">// descriptors get mapped.</span>
00919                     <span class="comment">//</span>
00920         
00921                     UsableDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> += PagesNeeded;
00922                     UsableDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> -= PagesNeeded;
00923                     UsingHighMemory = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00924                 }
00925             }
00926 
00927             <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
00928 
00929                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00930 
00931                 <span class="comment">//</span>
00932                 <span class="comment">// Map in a page directory page.</span>
00933                 <span class="comment">//</span>
00934 
00935                 <span class="keywordflow">if</span> (UsingHighMemory == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00936                     TempPde.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextUsablePhysicalPage;
00937                     NextUsablePhysicalPage += 1;
00938                 }
00939                 <span class="keywordflow">else</span> {
00940                     TempPde.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
00941                     NumberOfPages -= 1;
00942                     NextPhysicalPage += 1;
00943 
00944                     <span class="keywordflow">if</span> (NumberOfPages == 0) {
00945                         <span class="keywordflow">if</span> (FreeDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00946                             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (INSTALL_MORE_MEMORY,
00947                                           <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>,
00948                                           <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>,
00949                                           <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>,
00950                                               2);
00951                         }
00952                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NextPhysicalPage != (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> +
00953                                                      FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>));
00954                         NextPhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00955                         NumberOfPages = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00956                         SwitchedDescriptors = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00957                     }
00958                 }
00959 
00960                 *StartPde = TempPde;
00961                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (StartPde);
00962                 RtlZeroMemory (PointerPte, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00963                 StartPde += 1;
00964                 <a class="code" href="../../d2/d2/data386_8c.html#a27">MiNumberOfExtraSystemPdes</a> += 1;
00965             }
00966 
00967             ExtraPtes = <a class="code" href="../../d2/d2/data386_8c.html#a27">MiNumberOfExtraSystemPdes</a> * <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>;
00968         }
00969 
00970         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPages &gt; 0);
00971 
00972         <span class="comment">//</span>
00973         <span class="comment">// If the kernel image has not been biased to allow for 3gb of user</span>
00974         <span class="comment">// space, the host processor supports large pages, and the number of</span>
00975         <span class="comment">// physical pages is greater than 127mb, then map the kernel image and</span>
00976         <span class="comment">// HAL into a large page.</span>
00977         <span class="comment">//</span>
00978 
00979         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a5">KF_LARGE_PAGE</a>) &amp;&amp;
00980             (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00981             (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a31">MmLargePageMinimum</a>)) {
00982 
00983             <span class="comment">//</span>
00984             <span class="comment">// Map lower 512MB of physical memory as large pages starting</span>
00985             <span class="comment">// at address 0x80000000.</span>
00986             <span class="comment">//</span>
00987 
00988             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a3">MM_KSEG0_BASE</a>);
00989             LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d6/d8/mi386_8h.html#a11">MM_KSEG2_BASE</a>) - 1;
00990             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a8">MM_PAGES_IN_KSEG0</a>) {
00991                 LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a3">MM_KSEG0_BASE</a> +
00992                                     (<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
00993             }
00994 
00995             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a3">MM_KSEG0_BASE</a>);
00996             j = 0;
00997 
00998             <span class="keywordflow">do</span> {
00999                 <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PPte;
01000 
01001                 Range = 0;
01002                 <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01003                     TempPde.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
01004                     NextPhysicalPage += 1;
01005                     NumberOfPages -= 1;
01006                     <span class="keywordflow">if</span> (NumberOfPages == 0) {
01007                         <span class="keywordflow">if</span> (FreeDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01008                             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (INSTALL_MORE_MEMORY,
01009                                           <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>,
01010                                           <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>,
01011                                           <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>,
01012                                           3);
01013                         }
01014                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NextPhysicalPage != (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> +
01015                                                      FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>));
01016                         NextPhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01017                         NumberOfPages = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01018                         SwitchedDescriptors = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01019                     }
01020                     *PointerPde = TempPde;
01021                     Range = 1;
01022                 }
01023                 PPte = PointerPte;
01024                 <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>; i += 1) {
01025                     <span class="keywordflow">if</span> (Range || (PPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0)) {
01026                         *PPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
01027                         PPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = i + j;
01028                     }
01029                     PPte += 1;
01030                 }
01031                 PointerPde += 1;
01032                 PointerPte += <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>;
01033                 j += <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>;
01034             } <span class="keywordflow">while</span> (PointerPde &lt;= LastPte);
01035 
01036             MapLargePages = 1;
01037         }
01038         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01039 
01040             <span class="comment">//</span>
01041             <span class="comment">// The PFN database is so large that it cannot be virtually</span>
01042             <span class="comment">// mapped in system PTEs and large pages cannot be used.</span>
01043             <span class="comment">// Select a low virtual address for it now and map it in.</span>
01044             <span class="comment">// 16mb is a good choice - just after the boot images.</span>
01045             <span class="comment">//</span>
01046 
01047             <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> = (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a3">MM_KSEG0_BASE</a> | <a class="code" href="../../d6/d8/mi386_8h.html#a4">MM_BOOT_IMAGE_SIZE</a>);
01048 
01049             <span class="comment">//</span>
01050             <span class="comment">// Ensure the maximum PFN database fits into the available virtual</span>
01051             <span class="comment">// address space.</span>
01052             <span class="comment">//</span>
01053 
01054             <span class="keywordflow">if</span> ((ULONG)<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> + (PfnAllocation &lt;&lt; PAGE_SHIFT) &gt; <a class="code" href="../../d6/d8/mi386_8h.html#a11">MM_KSEG2_BASE</a>) {
01055                 <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> = (<a class="code" href="../../d6/d8/mi386_8h.html#a11">MM_KSEG2_BASE</a> - (ULONG)<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> - (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>)*2)) / <span class="keyword">sizeof</span> (<a class="code" href="../../d4/d8/mi_8h.html#a438">MMPFN</a>) - 1;
01056 
01057                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> &gt; <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a>) {
01058                     <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> = <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a>;
01059                 }
01060             }
01061 
01062             StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>);
01063             EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> ((PVOID)((PCHAR)<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> + (<a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a438">MMPFN</a>) + (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>)*2) - 1));
01064 
01065             UsingHighMemory = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01066 
01067             <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp;
01068                 (NextPhysicalPage &lt; (FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> +
01069                                     FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>))) {
01070         
01071                 ULONG PagesNeeded;
01072             
01073                 <span class="comment">//</span>
01074                 <span class="comment">// We haven't used the other descriptor yet, examine it now</span>
01075                 <span class="comment">// to see if enough usable memory is available.</span>
01076                 <span class="comment">//</span>
01077         
01078                 PagesNeeded = (EndPde - StartPde + 1);
01079         
01080                 <span class="keywordflow">if</span> ((FreeDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &gt;= PagesNeeded)) {
01081                     UsableDescriptor = FreeDescriptor;
01082                     NextUsablePhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01083                     UsingHighMemory = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01084                 }
01085             }
01086 
01087             <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
01088         
01089                 <span class="keywordflow">if</span> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01090         
01091                     <span class="comment">//</span>
01092                     <span class="comment">// Map in a page directory page.</span>
01093                     <span class="comment">//</span>
01094             
01095                     <span class="keywordflow">if</span> (UsingHighMemory == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01096 
01097                         <span class="comment">//</span>
01098                         <span class="comment">// Note is undone later as the PFN database is being</span>
01099                         <span class="comment">// created in virtual memory because the memory</span>
01100                         <span class="comment">// descriptors are scanned and only pages in the</span>
01101                         <span class="comment">// descriptors get mapped.</span>
01102                         <span class="comment">//</span>
01103         
01104                         TempPde.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextUsablePhysicalPage;
01105                         NextUsablePhysicalPage += 1;
01106                         UsableDescriptorRemoved += 1;
01107                         UsableDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> += 1;
01108                         UsableDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> -= 1;
01109                     }
01110                     <span class="keywordflow">else</span> {
01111                         TempPde.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
01112                         NumberOfPages -= 1;
01113                         NextPhysicalPage += 1;
01114 
01115                         <span class="keywordflow">if</span> (NumberOfPages == 0) {
01116                             <span class="keywordflow">if</span> (FreeDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01117                                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (INSTALL_MORE_MEMORY,
01118                                               <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>,
01119                                               <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>,
01120                                               <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>,
01121                                               4);
01122                             }
01123                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NextPhysicalPage != (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> +
01124                                                          FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>));
01125                             NextPhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01126                             NumberOfPages = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01127                             SwitchedDescriptors = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01128                         }
01129                     }
01130         
01131                     *StartPde = TempPde;
01132                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (StartPde);
01133                     RtlZeroMemory (PointerPte, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01134                 }
01135                 StartPde += 1;
01136             }
01137 
01138             <span class="comment">//</span>
01139             <span class="comment">// Leave some room for nonpaged pool expansion in order to share</span>
01140             <span class="comment">// common initialization code and to map physically contiguous</span>
01141             <span class="comment">// requests if needed.</span>
01142             <span class="comment">//</span>
01143 
01144             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt; <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> * 2 / 3) {
01145                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = (SIZE_T)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> * 2 / 3);
01146             }
01147         }
01148     }
01149     <span class="keywordflow">else</span> {
01150         <span class="keywordflow">if</span> ((PfnAllocation + 500) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> &gt; <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> - <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a>) {
01151 
01152             <span class="comment">//</span>
01153             <span class="comment">// Recarve portions of the initial and expansion nonpaged pools</span>
01154             <span class="comment">// so enough expansion PTEs will be available to map the PFN</span>
01155             <span class="comment">// database on large memory systems.</span>
01156             <span class="comment">//</span>
01157 
01158             <span class="keywordflow">if</span> ((PfnAllocation + 500) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> &lt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a>) {
01159                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> -= ((PfnAllocation + 500) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01160             }
01161         }
01162     }
01163 
01164     <span class="comment">//</span>
01165     <span class="comment">// If a low virtual PFN database and initial nonpaged pool is desired,</span>
01166     <span class="comment">// construct the PDEs for the initial nonpaged pool now.</span>
01167     <span class="comment">//</span>
01168 
01169     <span class="keywordflow">if</span> (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01170 
01171         ULONG PagesNeeded;
01172         
01173         LowVirtualNonPagedPoolStart = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01174         LowVirtualNonPagedPoolSizeInBytes = 0;
01175 
01176         PagesNeeded = 0;
01177         StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> ((PVOID)((PCHAR)<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> + (<a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a438">MMPFN</a>) + (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>)*2) - 1));
01178         StartPde += 1;
01179         EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d6/d8/mi386_8h.html#a11">MM_KSEG2_BASE</a>) - 1;
01180 
01181         <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
01182             <span class="keywordflow">if</span> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01183                 <span class="keywordflow">if</span> (LowVirtualNonPagedPoolStart == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01184                     LowVirtualNonPagedPoolStart = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a160">MiGetVirtualAddressMappedByPde</a> (StartPde);
01185                 }
01186                 PagesNeeded += 1;
01187             }
01188             <span class="keywordflow">else</span> {
01189                 <span class="keywordflow">if</span> (LowVirtualNonPagedPoolStart != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01190                     LowVirtualNonPagedPoolSizeInBytes = PagesNeeded * <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>;
01191                 }
01192             }
01193 
01194             StartPde += 1;
01195         }
01196 
01197         <span class="keywordflow">if</span> (LowVirtualNonPagedPoolStart == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01198             StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> ((PVOID)((PCHAR)<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> + (<a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a438">MMPFN</a>) + (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a202">MMCOLOR_TABLES</a>)*2) - 1));
01199             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
01200                           0x7000,
01201                           (ULONG_PTR)StartPde,
01202                           (ULONG_PTR)EndPde,
01203                           PagesNeeded);
01204         }
01205 
01206         <span class="keywordflow">if</span> (LowVirtualNonPagedPoolSizeInBytes == 0) {
01207             LowVirtualNonPagedPoolSizeInBytes = PagesNeeded * <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>;
01208         }
01209 
01210         <span class="keywordflow">if</span> (LowVirtualNonPagedPoolSizeInBytes &lt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a>) {
01211             <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = LowVirtualNonPagedPoolSizeInBytes;
01212         }
01213 
01214         UsingHighMemory = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01215         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp;
01216             (NextPhysicalPage &lt; (FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> +
01217                                 FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>)) &amp;&amp;
01218             (FreeDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01219     
01220             <span class="comment">//</span>
01221             <span class="comment">// We haven't used the other descriptor yet, examine it now</span>
01222             <span class="comment">// to see if enough usable memory is available.</span>
01223             <span class="comment">//</span>
01224     
01225             <span class="keywordflow">if</span> (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &gt;= PagesNeeded) {
01226     
01227                 UsableDescriptor = FreeDescriptor;
01228                 NextUsablePhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01229     
01230                 UsableDescriptorRemoved += PagesNeeded;
01231     
01232                 <span class="comment">//</span>
01233                 <span class="comment">// Note this must be undone if the PFN database is created in</span>
01234                 <span class="comment">// virtual memory because the memory descriptors are scanned</span>
01235                 <span class="comment">// and only pages in the descriptors get mapped.</span>
01236                 <span class="comment">//</span>
01237     
01238                 UsableDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> += PagesNeeded;
01239                 UsableDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> -= PagesNeeded;
01240                 UsingHighMemory = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01241             }
01242         }
01243     
01244         StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> ((PVOID)((PCHAR)<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> + (<a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a438">MMPFN</a>) + (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a202">MMCOLOR_TABLES</a>)*2) - 1));
01245         StartPde += 1;
01246 
01247         <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
01248             <span class="keywordflow">if</span> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01249                 StartPde += 1;
01250                 <span class="keywordflow">continue</span>;
01251             }
01252     
01253             <span class="keywordflow">if</span> (UsingHighMemory == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01254                 TempPde.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextUsablePhysicalPage;
01255                 NextUsablePhysicalPage += 1;
01256             }
01257             <span class="keywordflow">else</span> {
01258                 TempPde.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
01259                 NextPhysicalPage += 1;
01260                 NumberOfPages -= 1;
01261                 <span class="keywordflow">if</span> (NumberOfPages == 0) {
01262                     <span class="keywordflow">if</span> (FreeDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01263                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (INSTALL_MORE_MEMORY,
01264                                       <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>,
01265                                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>,
01266                                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>,
01267                                       7);
01268                     }
01269                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NextPhysicalPage != (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> +
01270                                                  FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>));
01271                     NextPhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01272                     NumberOfPages = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01273                     SwitchedDescriptors = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01274                 }
01275             }
01276             *StartPde = TempPde;
01277             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (StartPde);
01278             RtlZeroMemory (PointerPte, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01279             StartPde += 1;
01280         }
01281     }
01282 
01283     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>);
01284     NonPagedPoolStartVirtual = <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>;
01285 
01286     <span class="comment">//</span>
01287     <span class="comment">// Fill in the PTEs for the initial nonpaged pool using the</span>
01288     <span class="comment">// largest free chunk of memory below 16mb.</span>
01289     <span class="comment">//</span>
01290 
01291     SavedSize = <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a>;
01292 
01293     <span class="keywordflow">if</span> (((<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; (MapLargePages)) ||
01294         (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01295 
01296         ULONG NonPagedVirtualStartPfn;
01297 
01298         NonPagedVirtualStartPfn = 0;
01299 
01300         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/inialpha_8c.html#a4">MmExpandedNonPagedPoolInBytes</a> == 0) {
01301 
01302             UsingHighMemory = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01303             <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp;
01304                 (NextPhysicalPage &lt; (FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> +
01305                                     FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>)) &amp;&amp;
01306                 (FreeDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01307                 ((FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a8">MM_PAGES_IN_KSEG0</a>) ||
01308                  (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))) {
01309         
01310                 ULONG NumberOfUsablePages;
01311                 ULONG PagesNeeded;
01312             
01313                 PagesNeeded = <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01314                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = PagesNeeded &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01315         
01316                 <span class="comment">//</span>
01317                 <span class="comment">// We haven't used the other descriptor yet, examine it now</span>
01318                 <span class="comment">// to see if enough usable memory is available.</span>
01319                 <span class="comment">//</span>
01320         
01321                 NumberOfUsablePages = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01322 
01323                 <span class="keywordflow">if</span> (NumberOfUsablePages &gt; (<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01324                     NumberOfUsablePages = <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01325                 }
01326 
01327                 <span class="keywordflow">if</span> (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01328                     <span class="keywordflow">if</span> (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + NumberOfUsablePages &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a8">MM_PAGES_IN_KSEG0</a>) {
01329                         NumberOfUsablePages = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a8">MM_PAGES_IN_KSEG0</a> - FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01330                     }
01331                 }
01332 
01333                 <span class="keywordflow">if</span> (NumberOfUsablePages &gt;= PagesNeeded) {
01334         
01335                     UsableDescriptor = FreeDescriptor;
01336                     NextUsablePhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01337         
01338                     UsableDescriptorRemoved += PagesNeeded;
01339         
01340                     <span class="comment">//</span>
01341                     <span class="comment">// Note this must be undone if the PFN database is created</span>
01342                     <span class="comment">// in virtual memory because the memory descriptors are</span>
01343                     <span class="comment">// scanned and only pages in the descriptors get mapped.</span>
01344                     <span class="comment">//</span>
01345         
01346                     UsableDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> += PagesNeeded;
01347                     UsableDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> -= PagesNeeded;
01348                     UsingHighMemory = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01349                 }
01350             }
01351 
01352             <span class="keywordflow">if</span> (UsingHighMemory == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01353                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt; (NumberOfPages &lt;&lt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>))) {
01354                     <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = NumberOfPages &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01355                 }
01356             }
01357 
01358             NonPagedPoolStartVirtual = (PVOID)((PCHAR)NonPagedPoolStartVirtual +
01359                                         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a>);
01360 
01361             <span class="comment">//</span>
01362             <span class="comment">// No need to get page table pages for these as we can reference</span>
01363             <span class="comment">// them via large pages.  If we are not using large pages (ie:</span>
01364             <span class="comment">// for NeedLowVirtualPfn), the page tables are already allocated</span>
01365             <span class="comment">// and just the mappings need to be filled in.</span>
01366             <span class="comment">//</span>
01367 
01368             <span class="keywordflow">if</span> (UsingHighMemory == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01369                 <span class="keywordflow">if</span> (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01370                     <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> = LowVirtualNonPagedPoolStart;
01371                 }
01372                 <span class="keywordflow">else</span> {
01373                     <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> =
01374                         (PVOID)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a3">MM_KSEG0_BASE</a> | (NextUsablePhysicalPage &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
01375                 }
01376                 NonPagedVirtualStartPfn = NextUsablePhysicalPage;
01377             }
01378             <span class="keywordflow">else</span> {
01379                 <span class="keywordflow">if</span> (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01380                     <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> = LowVirtualNonPagedPoolStart;
01381                 }
01382                 <span class="keywordflow">else</span> {
01383                     <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> =
01384                         (PVOID)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a3">MM_KSEG0_BASE</a> | (NextPhysicalPage &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
01385                 }
01386     
01387                 NonPagedVirtualStartPfn = NextPhysicalPage;
01388                 NextPhysicalPage += <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01389                 NumberOfPages -= <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01390 
01391                 <span class="keywordflow">if</span> (NumberOfPages == 0) {
01392                     <span class="keywordflow">if</span> (FreeDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01393                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (INSTALL_MORE_MEMORY,
01394                                       <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>,
01395                                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>,
01396                                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>,
01397                                       5);
01398                     }
01399                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NextPhysicalPage != (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> +
01400                                                  FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>));
01401                     NextPhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01402                     NumberOfPages = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01403                     SwitchedDescriptors = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01404                 }
01405             }
01406 
01407             <a class="code" href="../../d8/d5/kddata_8c.html#a16">MmSubsectionBase</a> = (ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>;
01408             <a class="code" href="../../d4/d8/mi_8h.html#a580">MmSubsectionTopPage</a> = NonPagedVirtualStartPfn + (<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01409 
01410             <span class="comment">//</span>
01411             <span class="comment">// If the entire initial nonpaged pool is below 128mb, then</span>
01412             <span class="comment">// widen the subsection range so large pages can be used for any</span>
01413             <span class="comment">// nonpaged expansion pool single-page allocation below 128mb.</span>
01414             <span class="comment">//</span>
01415 
01416             <span class="keywordflow">if</span> (MmSubsectionTopPage &lt; (MM_SUBSECTION_MAP &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01417                 <a class="code" href="../../d8/d5/kddata_8c.html#a16">MmSubsectionBase</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a3">MM_KSEG0_BASE</a>;
01418                 <a class="code" href="../../d4/d8/mi_8h.html#a580">MmSubsectionTopPage</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a147">MM_SUBSECTION_MAP</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01419             }
01420         }
01421         <span class="keywordflow">else</span> {
01422 
01423             ULONG NumberOfUsablePages;
01424             <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> UseFreeDescriptor;
01425 
01426             NumberOfUsablePages = 0;
01427             UseFreeDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01428 
01429             <span class="keywordflow">if</span> (NextPhysicalPage &lt; (FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> +
01430                                     FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>)) {
01431 
01432                 <span class="comment">//</span>
01433                 <span class="comment">// We haven't used the other descriptor yet, examine it now</span>
01434                 <span class="comment">// to see if more usable (ie: below 512mb) memory is available</span>
01435                 <span class="comment">// in it than the lowmem descriptor for building the initial</span>
01436                 <span class="comment">// nonpaged pool.  The 512mb restriction is because we will be</span>
01437                 <span class="comment">// using large pages to map it.</span>
01438                 <span class="comment">//</span>
01439 
01440                 <span class="keywordflow">if</span> (FreeDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01441                     <span class="keywordflow">if</span> (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01442                         NumberOfUsablePages = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01443     
01444                         <span class="keywordflow">if</span> (NumberOfUsablePages &gt; (<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01445                             NumberOfUsablePages = <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01446                         }
01447     
01448                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfUsablePages &lt;= (MM_MAX_INITIAL_NONPAGED_POOL &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
01449     
01450                     }
01451                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a8">MM_PAGES_IN_KSEG0</a>) {
01452 
01453                         NumberOfUsablePages = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01454     
01455                         <span class="keywordflow">if</span> (NumberOfUsablePages &gt; (<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01456                             NumberOfUsablePages = <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01457                         }
01458     
01459                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfUsablePages &lt;= (MM_MAX_INITIAL_NONPAGED_POOL &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
01460     
01461                         <span class="keywordflow">if</span> (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + NumberOfUsablePages &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a8">MM_PAGES_IN_KSEG0</a>) {
01462                             NumberOfUsablePages = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a8">MM_PAGES_IN_KSEG0</a> - FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01463                         }
01464                     }
01465                 }
01466 
01467                 <span class="comment">//</span>
01468                 <span class="comment">// If the free descriptor memory meets our needs, switch to it</span>
01469                 <span class="comment">// just for the nonpaged pool creation.  Otherwise, just use</span>
01470                 <span class="comment">// the low descriptor memory.</span>
01471                 <span class="comment">//</span>
01472 
01473                 <span class="keywordflow">if</span> (NumberOfUsablePages &gt; NumberOfPages) {
01474                     UseFreeDescriptor = FreeDescriptor;
01475                     NextUsablePhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01476                 }
01477             }
01478 
01479             <span class="keywordflow">if</span> (UseFreeDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01480                 NumberOfUsablePages = NumberOfPages;
01481                 NextUsablePhysicalPage = NextPhysicalPage;
01482             }
01483             <span class="keywordflow">else</span> {
01484                 <span class="keywordflow">if</span> (UsableDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01485                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (UsableDescriptor == UseFreeDescriptor);
01486                 }
01487                 UsableDescriptor = UseFreeDescriptor;
01488             }
01489 
01490             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt; (NumberOfUsablePages &lt;&lt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>))) {
01491                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = NumberOfUsablePages &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01492             }
01493 
01494             <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> = <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> +
01495                                                 <a class="code" href="../../d2/d1/inialpha_8c.html#a4">MmExpandedNonPagedPoolInBytes</a>;
01496 
01497             <span class="comment">//</span>
01498             <span class="comment">// No need to get page table pages for these as we can reference</span>
01499             <span class="comment">// them via large pages.</span>
01500             <span class="comment">//</span>
01501 
01502             <span class="keywordflow">if</span> (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01503                 <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> = LowVirtualNonPagedPoolStart;
01504             }
01505             <span class="keywordflow">else</span> {
01506                 <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> =
01507                     (PVOID)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a3">MM_KSEG0_BASE</a> | (NextUsablePhysicalPage &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
01508             }
01509 
01510             NonPagedVirtualStartPfn = NextUsablePhysicalPage;
01511 
01512             <span class="keywordflow">if</span> (UseFreeDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01513 
01514                 UsableDescriptorRemoved += <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01515 
01516                 <span class="comment">//</span>
01517                 <span class="comment">// Note this must be undone if the PFN database is created in</span>
01518                 <span class="comment">// virtual memory because the memory descriptors are scanned</span>
01519                 <span class="comment">// and only pages in the descriptors get mapped.</span>
01520                 <span class="comment">//</span>
01521 
01522                 UsableDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> += (<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01523                 UsableDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> -= (<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01524 
01525                 <span class="keywordflow">if</span> (UsableDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &lt;= (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a147">MM_SUBSECTION_MAP</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01526                     <a class="code" href="../../d8/d5/kddata_8c.html#a16">MmSubsectionBase</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a3">MM_KSEG0_BASE</a>;
01527                     <a class="code" href="../../d4/d8/mi_8h.html#a580">MmSubsectionTopPage</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a147">MM_SUBSECTION_MAP</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01528                 }
01529                 <span class="keywordflow">else</span> {
01530                     <a class="code" href="../../d8/d5/kddata_8c.html#a16">MmSubsectionBase</a> = (ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>;
01531                     <a class="code" href="../../d4/d8/mi_8h.html#a580">MmSubsectionTopPage</a> = UsableDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01532                 }
01533             }
01534             <span class="keywordflow">else</span> {
01535                 NextPhysicalPage += <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01536                 NumberOfPages -= <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01537 
01538                 <a class="code" href="../../d8/d5/kddata_8c.html#a16">MmSubsectionBase</a> = (ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>;
01539                 <a class="code" href="../../d4/d8/mi_8h.html#a580">MmSubsectionTopPage</a> = NextPhysicalPage;
01540 
01541                 <span class="keywordflow">if</span> (NextPhysicalPage &lt; (MM_SUBSECTION_MAP &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01542                     <a class="code" href="../../d8/d5/kddata_8c.html#a16">MmSubsectionBase</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a3">MM_KSEG0_BASE</a>;
01543                     <a class="code" href="../../d4/d8/mi_8h.html#a580">MmSubsectionTopPage</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a147">MM_SUBSECTION_MAP</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01544                 }
01545 
01546                 <span class="keywordflow">if</span> (NumberOfPages == 0) {
01547                     <span class="keywordflow">if</span> (FreeDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01548                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (INSTALL_MORE_MEMORY,
01549                                       <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>,
01550                                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>,
01551                                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>,
01552                                       6);
01553                     }
01554                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NextPhysicalPage != (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> +
01555                                                  FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>));
01556                     NextPhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01557                     NumberOfPages = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01558                     SwitchedDescriptors = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01559                 }
01560             }
01561         }
01562 
01563         <span class="keywordflow">if</span> (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01564 
01565             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NonPagedVirtualStartPfn != 0);
01566             PageFrameIndex = NonPagedVirtualStartPfn;
01567 
01568             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>);
01569             LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>((ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> +
01570                                                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> - 1);
01571             <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
01572                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
01573                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
01574                 *PointerPte = TempPte;
01575                 PointerPte += 1;
01576                 PageFrameIndex += 1;
01577             }
01578         }
01579 
01580         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/inialpha_8c.html#a4">MmExpandedNonPagedPoolInBytes</a> == 0) {
01581             <a class="code" href="../../d1/d6/allocpag_8c.html#a7">MmNonPagedPoolExpansionStart</a> = (PVOID)((PCHAR)NonPagedPoolStartVirtual +
01582                         (SavedSize - <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a>));
01583         }
01584         <span class="keywordflow">else</span> {
01585             <a class="code" href="../../d1/d6/allocpag_8c.html#a7">MmNonPagedPoolExpansionStart</a> = NonPagedPoolStartVirtual;
01586         }
01587 
01588 <span class="preprocessor">#if defined(_X86PAE_)</span>
01589 <span class="preprocessor"></span>
01590         <span class="comment">//</span>
01591         <span class="comment">// Always widen the subsection range for PAE so large pages can be used</span>
01592         <span class="comment">// for all nonpaged single-page expansion allocations below 512mb as</span>
01593         <span class="comment">// the widened PTE can always encode it properly.</span>
01594         <span class="comment">//</span>
01595 
01596         <a class="code" href="../../d8/d5/kddata_8c.html#a16">MmSubsectionBase</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a3">MM_KSEG0_BASE</a>;
01597         <a class="code" href="../../d4/d8/mi_8h.html#a580">MmSubsectionTopPage</a> = (512*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01598 <span class="preprocessor">#endif</span>
01599 <span class="preprocessor"></span>
01600     }
01601     <span class="keywordflow">else</span> {
01602 
01603         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/inialpha_8c.html#a4">MmExpandedNonPagedPoolInBytes</a> == 0);
01604         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>((ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> +
01605                                             <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> - 1);
01606 
01607         UsingHighMemory = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01608         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp;
01609             (NextPhysicalPage &lt; (FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> +
01610                                 FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>)) &amp;&amp;
01611             (FreeDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01612     
01613             ULONG PagesNeeded;
01614         
01615             <span class="comment">//</span>
01616             <span class="comment">// We haven't used the other descriptor yet, examine it now</span>
01617             <span class="comment">// to see if enough usable memory is available.</span>
01618             <span class="comment">//</span>
01619     
01620             PagesNeeded = (LastPte - PointerPte + 1);
01621     
01622             <span class="keywordflow">if</span> (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &gt;= PagesNeeded) {
01623     
01624                 UsableDescriptor = FreeDescriptor;
01625                 NextUsablePhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01626     
01627                 UsableDescriptorRemoved += PagesNeeded;
01628     
01629                 <span class="comment">//</span>
01630                 <span class="comment">// Note this must be undone if the PFN database is created in</span>
01631                 <span class="comment">// virtual memory because the memory descriptors are scanned</span>
01632                 <span class="comment">// and only pages in the descriptors get mapped.</span>
01633                 <span class="comment">//</span>
01634     
01635                 UsableDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> += PagesNeeded;
01636                 UsableDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> -= PagesNeeded;
01637                 UsingHighMemory = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01638             }
01639         }
01640 
01641         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
01642 
01643             <span class="keywordflow">if</span> (UsingHighMemory == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01644                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextUsablePhysicalPage;
01645                 NextUsablePhysicalPage += 1;
01646             }
01647             <span class="keywordflow">else</span> {
01648                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
01649                 NextPhysicalPage += 1;
01650                 NumberOfPages -= 1;
01651                 <span class="keywordflow">if</span> (NumberOfPages == 0) {
01652                     <span class="keywordflow">if</span> (FreeDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01653                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (INSTALL_MORE_MEMORY,
01654                                       <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>,
01655                                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>,
01656                                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>,
01657                                       9);
01658                     }
01659                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NextPhysicalPage != (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> +
01660                                                  FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>));
01661                     NextPhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01662                     NumberOfPages = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01663                     SwitchedDescriptors = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01664                     <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = (PointerPte - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>)) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01665                     <span class="keywordflow">break</span>;
01666                 }
01667             }
01668             *PointerPte = TempPte;
01669             PointerPte += 1;
01670         }
01671 
01672         SavedSize = <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a>;
01673 
01674         <a class="code" href="../../d1/d6/allocpag_8c.html#a7">MmNonPagedPoolExpansionStart</a> = (PVOID)((PCHAR)NonPagedPoolStartVirtual +
01675                     <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a>);
01676     }
01677 
01678     <span class="comment">//</span>
01679     <span class="comment">// There must be at least one page of system PTEs before the expanded</span>
01680     <span class="comment">// nonpaged pool.</span>
01681     <span class="comment">//</span>
01682 
01683     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>) &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d1/d6/allocpag_8c.html#a7">MmNonPagedPoolExpansionStart</a>));
01684 
01685     <span class="comment">//</span>
01686     <span class="comment">// Non-paged pages now exist, build the pool structures.</span>
01687     <span class="comment">//</span>
01688 
01689     <a class="code" href="../../d4/d8/mi_8h.html#a653">MmPageAlignedPoolBase</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] = <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>;
01690 
01691     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/inialpha_8c.html#a4">MmExpandedNonPagedPoolInBytes</a> == 0) {
01692         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> -= (SavedSize - <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a>);
01693         <a class="code" href="../../d4/d8/mi_8h.html#a778">MiInitializeNonPagedPool</a> ();
01694         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> += (SavedSize - <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a>);
01695     }
01696     <span class="keywordflow">else</span> {
01697         <a class="code" href="../../d4/d8/mi_8h.html#a778">MiInitializeNonPagedPool</a> ();
01698     }
01699 
01700     <span class="comment">//</span>
01701     <span class="comment">// Before Non-paged pool can be used, the PFN database must</span>
01702     <span class="comment">// be built.  This is due to the fact that the start and end of</span>
01703     <span class="comment">// allocation bits for nonpaged pool are maintained in the</span>
01704     <span class="comment">// PFN elements for the corresponding pages.</span>
01705     <span class="comment">//</span>
01706 
01707     <a class="code" href="../../d4/d2/datalpha_8c.html#a22">MmSecondaryColorMask</a> = <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> - 1;
01708 
01709     <span class="comment">//</span>
01710     <span class="comment">// The SwitchedDescriptors must be checked because if it is set, the</span>
01711     <span class="comment">// FreeDescriptor has already been allocated from without updating the</span>
01712     <span class="comment">// BasePage &amp; PageCount (these were not changed because they are scanned</span>
01713     <span class="comment">// if the PFN database is virtually mapped to insert PTEs).</span>
01714     <span class="comment">//</span>
01715 
01716     <span class="keywordflow">if</span> ((SwitchedDescriptors == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; (FreeDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01717         BasePage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01718         HighPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01719     }
01720     <span class="keywordflow">else</span> {
01721         BasePage = NextPhysicalPage;
01722         HighPage = NextPhysicalPage + NumberOfPages;
01723     }
01724 
01725     HighPageInKseg0 = HighPage;
01726     <span class="keywordflow">if</span> (HighPageInKseg0 &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a8">MM_PAGES_IN_KSEG0</a>) {
01727         HighPageInKseg0 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a8">MM_PAGES_IN_KSEG0</a>;
01728     }
01729 
01730     PagesLeft = HighPage - BasePage;
01731 
01732 <span class="preprocessor">#if DBG</span>
01733 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (FreeDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01734         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MapLargePages == 0);
01735     }
01736 <span class="preprocessor">#endif</span>
01737 <span class="preprocessor"></span>
01738 <span class="preprocessor">#ifndef PFN_CONSISTENCY</span>
01739 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((MapLargePages) &amp;&amp; (BasePage + PfnAllocation &lt;= HighPageInKseg0)) {
01740 
01741         <span class="comment">//</span>
01742         <span class="comment">// Allocate the PFN database in kseg0.</span>
01743         <span class="comment">//</span>
01744         <span class="comment">// Compute the address of the PFN by allocating the appropriate</span>
01745         <span class="comment">// number of pages from the end of the free descriptor.</span>
01746         <span class="comment">//</span>
01747 
01748         PfnInKseg0 = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01749         <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> = (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a3">MM_KSEG0_BASE</a> | (BasePage &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
01750 
01751         <span class="comment">//</span>
01752         <span class="comment">// Later we will walk the memory descriptors and add pages to the free</span>
01753         <span class="comment">// list in the PFN database.</span>
01754         <span class="comment">//</span>
01755         <span class="comment">// To do this correctly:</span>
01756         <span class="comment">//</span>
01757         <span class="comment">// The FreeDescriptor fields must be updated if we haven't already</span>
01758         <span class="comment">// switched descriptors so the PFN database consumption isn't</span>
01759         <span class="comment">// added to the freelist.</span>
01760         <span class="comment">//</span>
01761         <span class="comment">// If we have switched, then we must update NextPhysicalPage and the</span>
01762         <span class="comment">// FreeDescriptor need not be updated.</span>
01763         <span class="comment">//</span>
01764 
01765         <span class="keywordflow">if</span> (SwitchedDescriptors == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01766             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPages &gt; PfnAllocation);
01767             NextPhysicalPage += PfnAllocation;
01768             NumberOfPages -= PfnAllocation;
01769         }
01770         <span class="keywordflow">else</span> {
01771             FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> += PfnAllocation;
01772             FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> -= PfnAllocation;
01773         }
01774 
01775         RtlZeroMemory(<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>, PfnAllocation * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01776 
01777         <span class="comment">//</span>
01778         <span class="comment">// The PFN database was allocated in kseg0.  Since space was left for</span>
01779         <span class="comment">// it virtually (in the nonpaged pool expansion PTEs), remove this</span>
01780         <span class="comment">// now unused space if it can cause PTE encoding to exceed the 27 bits.</span>
01781         <span class="comment">//</span>
01782 
01783         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a770">NonPagedPoolExpansion</a>] &gt;
01784                         (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a31">MM_MAX_ADDITIONAL_NONPAGED_POOL</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01785             <span class="comment">//</span>
01786             <span class="comment">// Reserve the expanded pool PTEs so they cannot be used.</span>
01787             <span class="comment">//</span>
01788 
01789             ULONG PfnDatabaseSpace;
01790 
01791             PfnDatabaseSpace = <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a770">NonPagedPoolExpansion</a>] -
01792                         (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a31">MM_MAX_ADDITIONAL_NONPAGED_POOL</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01793 
01794             <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (
01795                     PfnDatabaseSpace,
01796                     <a class="code" href="../../d4/d8/mi_8h.html#a1003a770">NonPagedPoolExpansion</a>,
01797                     0,
01798                     0,
01799                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01800 
01801             <span class="comment">//</span>
01802             <span class="comment">// Adjust the end of nonpaged pool to reflect this reservation.</span>
01803             <span class="comment">// This is so the entire nonpaged pool expansion space is available</span>
01804             <span class="comment">// not just for general purpose consumption, but also for subsection</span>
01805             <span class="comment">// encoding into protoptes when subsections are allocated from the</span>
01806             <span class="comment">// very end of the expansion range.</span>
01807             <span class="comment">//</span>
01808 
01809             (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a24">MmNonPagedPoolEnd</a> -= PfnDatabaseSpace * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01810         }
01811         <span class="keywordflow">else</span> {
01812 
01813             <span class="comment">//</span>
01814             <span class="comment">// Allocate one more PTE just below the PFN database.  This provides</span>
01815             <span class="comment">// protection against the caller of the first real nonpaged</span>
01816             <span class="comment">// expansion allocation in case he accidentally overruns his pool</span>
01817             <span class="comment">// block.  (We'll trap instead of corrupting the PFN database).</span>
01818             <span class="comment">// This also allows us to freely increment in MiFreePoolPages</span>
01819             <span class="comment">// without having to worry about a valid PTE just after the end of</span>
01820             <span class="comment">// the highest nonpaged pool allocation.</span>
01821             <span class="comment">//</span>
01822 
01823             <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (
01824                     1,
01825                     <a class="code" href="../../d4/d8/mi_8h.html#a1003a770">NonPagedPoolExpansion</a>,
01826                     0,
01827                     0,
01828                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01829         }
01830 
01831     } <span class="keywordflow">else</span> {
01832 
01833         ULONG FreeNextPhysicalPage;
01834         ULONG FreeNumberOfPages;
01835 
01836         <span class="comment">//</span>
01837         <span class="comment">// The PFN database will be built from the FreeDescriptor.  This is</span>
01838         <span class="comment">// done to avoid using pages below 16mb to contain the PFN database</span>
01839         <span class="comment">// as these pages may be needed by drivers.  The FreeDescriptor will</span>
01840         <span class="comment">// always have enough pages to build the PFN database from.</span>
01841         <span class="comment">//</span>
01842 
01843         FreeNextPhysicalPage = BasePage;
01844         FreeNumberOfPages = PagesLeft;
01845 
01846 <span class="preprocessor">#endif  // PFN_CONSISTENCY</span>
01847 <span class="preprocessor"></span>
01848         <span class="comment">//</span>
01849         <span class="comment">// Calculate the start of the PFN database (it starts at physical</span>
01850         <span class="comment">// page zero, even if the lowest physical page is not zero).</span>
01851         <span class="comment">//</span>
01852 
01853         <span class="keywordflow">if</span> (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01854             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01855             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>);
01856         }
01857         <span class="keywordflow">else</span> {
01858             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PagesLeft &gt;= PfnAllocation);
01859 
01860             PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (PfnAllocation,
01861                                               <a class="code" href="../../d4/d8/mi_8h.html#a1003a770">NonPagedPoolExpansion</a>,
01862                                               0,
01863                                               0,
01864                                               <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01865 
01866             <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> = (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte));
01867 
01868             <span class="comment">//</span>
01869             <span class="comment">// Adjust the end of nonpaged pool to reflect the PFN database</span>
01870             <span class="comment">// allocation.  This is so the entire nonpaged pool expansion space</span>
01871             <span class="comment">// is available not just for general purpose consumption, but also</span>
01872             <span class="comment">// for subsection encoding into protoptes when subsections are</span>
01873             <span class="comment">// allocated from the very beginning of the initial nonpaged pool</span>
01874             <span class="comment">// range.</span>
01875             <span class="comment">//</span>
01876 
01877             <a class="code" href="../../d8/d5/kddata_8c.html#a24">MmNonPagedPoolEnd</a> = (PVOID)<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>;
01878 
01879             <span class="comment">//</span>
01880             <span class="comment">// Allocate one more PTE just below the PFN database.  This provides</span>
01881             <span class="comment">// protection against the caller of the first real nonpaged</span>
01882             <span class="comment">// expansion allocation in case he accidentally overruns his pool</span>
01883             <span class="comment">// block.  (We'll trap instead of corrupting the PFN database).</span>
01884             <span class="comment">// This also allows us to freely increment in MiFreePoolPages</span>
01885             <span class="comment">// without having to worry about a valid PTE just after the end of</span>
01886             <span class="comment">// the highest nonpaged pool allocation.</span>
01887             <span class="comment">//</span>
01888     
01889             <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (1,
01890                                  <a class="code" href="../../d4/d8/mi_8h.html#a1003a770">NonPagedPoolExpansion</a>,
01891                                  0,
01892                                  0,
01893                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01894         }
01895 
01896 <span class="preprocessor">#if PFN_CONSISTENCY</span>
01897 <span class="preprocessor"></span>        MiPfnStartPte = PointerPte;
01898         MiPfnPtes = PfnAllocation;
01899 <span class="preprocessor">#endif</span>
01900 <span class="preprocessor"></span>
01901         <span class="comment">//</span>
01902         <span class="comment">// Go through the memory descriptors and for each physical page make</span>
01903         <span class="comment">// sure the PFN database has a valid PTE to map it. This allows machines</span>
01904         <span class="comment">// with sparse physical memory to have a minimal PFN database.</span>
01905         <span class="comment">//</span>
01906 
01907         NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
01908         <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
01909             MemoryDescriptor = CONTAINING_RECORD(NextMd,
01910                                                  <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
01911                                                  ListEntry);
01912 
01913             <span class="keywordflow">if</span> ((MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a260">LoaderFirmwarePermanent</a>) ||
01914                 (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a277">LoaderBBTMemory</a>) ||
01915                 (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a276">LoaderSpecialMemory</a>)) {
01916 
01917                 <span class="comment">//</span>
01918                 <span class="comment">// If the descriptor lies within the highest PFN database entry</span>
01919                 <span class="comment">// then create PFN pages for this range.  Note the PFN entries</span>
01920                 <span class="comment">// must be created to support \Device\PhysicalMemory.</span>
01921                 <span class="comment">//</span>
01922 
01923                 <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &lt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
01924                     <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> + 1) {
01925                         MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> - MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + 1;
01926                     }
01927                 }
01928                 <span class="keywordflow">else</span> {
01929                     NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
01930                     <span class="keywordflow">continue</span>;
01931                 }
01932 
01933             }
01934 
01935             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(
01936                                             MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>));
01937 
01938             LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (((PCHAR)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(
01939                                             MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> +
01940                                             MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>))) - 1);
01941 
01942             <span class="keywordflow">if</span> (MemoryDescriptor == UsableDescriptor) {
01943 
01944                 <span class="comment">//</span>
01945                 <span class="comment">// Temporarily add back in the memory used to create the initial</span>
01946                 <span class="comment">// nonpaged pool so the PFN entries for it will be mapped.</span>
01947                 <span class="comment">//</span>
01948                 <span class="comment">// This must be done carefully as memory from the descriptor</span>
01949                 <span class="comment">// itself could get used to map the PFNs for the descriptor !</span>
01950                 <span class="comment">//</span>
01951 
01952                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(
01953                     MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> - UsableDescriptorRemoved));
01954             }
01955 
01956             <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
01957                 <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 0) {
01958                     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = FreeNextPhysicalPage;
01959                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FreeNumberOfPages != 0);
01960                     FreeNextPhysicalPage += 1;
01961                     FreeNumberOfPages -= 1;
01962                     *PointerPte = TempPte;
01963                     RtlZeroMemory (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte),
01964                                    <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01965                 }
01966                 PointerPte += 1;
01967             }
01968 
01969             NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
01970         }
01971 
01972         <span class="comment">//</span>
01973         <span class="comment">// Handle the BIOS range here as some machines have big gaps in</span>
01974         <span class="comment">// their physical memory maps.  Big meaning &gt; 3.5mb from page 0x37</span>
01975         <span class="comment">// up to page 0x350.</span>
01976         <span class="comment">//</span>
01977 
01978         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(<a class="code" href="../../d1/d2/mm_2i386_2init386_8c.html#a0">MM_BIOS_START</a>));
01979         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PCHAR)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(<a class="code" href="../../d1/d2/mm_2i386_2init386_8c.html#a1">MM_BIOS_END</a>)));
01980 
01981         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
01982             <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 0) {
01983                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = FreeNextPhysicalPage;
01984                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FreeNumberOfPages != 0);
01985                 FreeNextPhysicalPage += 1;
01986                 FreeNumberOfPages -= 1;
01987                 *PointerPte = TempPte;
01988                 RtlZeroMemory (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte),
01989                                <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01990             }
01991             PointerPte += 1;
01992         }
01993 
01994         <span class="comment">//</span>
01995         <span class="comment">// Update the global counts - this would have been tricky to do while</span>
01996         <span class="comment">// removing pages from them as we looped above.</span>
01997         <span class="comment">//</span>
01998 
01999         <span class="comment">//</span>
02000         <span class="comment">// Later we will walk the memory descriptors and add pages to the free</span>
02001         <span class="comment">// list in the PFN database.</span>
02002         <span class="comment">//</span>
02003         <span class="comment">// To do this correctly:</span>
02004         <span class="comment">//</span>
02005         <span class="comment">// The FreeDescriptor fields must be updated if we haven't already</span>
02006         <span class="comment">// switched descriptors so the PFN database consumption isn't</span>
02007         <span class="comment">// added to the freelist.</span>
02008         <span class="comment">//</span>
02009         <span class="comment">// If we have switched, then we must update NextPhysicalPage and the</span>
02010         <span class="comment">// FreeDescriptor need not be updated.</span>
02011         <span class="comment">//</span>
02012 
02013         <span class="keywordflow">if</span> (SwitchedDescriptors == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02014             NextPhysicalPage = FreeNextPhysicalPage;
02015             NumberOfPages = FreeNumberOfPages;
02016         }
02017         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FreeDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02018             FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> = FreeNextPhysicalPage;
02019             FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> = FreeNumberOfPages;
02020         }
02021         <span class="keywordflow">else</span> {
02022             FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> = FreeNextPhysicalPage;
02023             FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> = FreeNumberOfPages;
02024             NextPhysicalPage = FreeNextPhysicalPage;
02025             NumberOfPages = FreeNumberOfPages;
02026         }
02027 
02028 <span class="preprocessor">#ifndef PFN_CONSISTENCY</span>
02029 <span class="preprocessor"></span>    }
02030 <span class="preprocessor">#endif // PFN_CONSISTENCY</span>
02031 <span class="preprocessor"></span>
02032     <span class="keywordflow">if</span> (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02033         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a52">MmAllocatedNonPagedPool</a> += PfnAllocation;
02034     }
02035 
02036     <span class="comment">//</span>
02037     <span class="comment">// Initialize support for colored pages.</span>
02038     <span class="comment">//</span>
02039 
02040     <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0] = (<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">PMMCOLOR_TABLES</a>)
02041                                 &amp;<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>[<a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> + 1];
02042 
02043     <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[1] = &amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0][<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>];
02044 
02045     <span class="comment">//</span>
02046     <span class="comment">// Make sure the PTEs are mapped.</span>
02047     <span class="comment">//</span>
02048 
02049     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0] &gt; (<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">PMMCOLOR_TABLES</a>)<a class="code" href="../../d6/d8/mi386_8h.html#a11">MM_KSEG2_BASE</a>) ||
02050         (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
02051 
02052         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (&amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0][0]);
02053 
02054         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (
02055                   (PVOID)((PCHAR)&amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[1][<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>] - 1));
02056 
02057         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
02058             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
02059                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
02060                 NextPhysicalPage += 1;
02061                 NumberOfPages -= 1;
02062                 <span class="keywordflow">if</span> (NumberOfPages == 0) {
02063                     <span class="keywordflow">if</span> (FreeDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02064                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (INSTALL_MORE_MEMORY,
02065                                       <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>,
02066                                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>,
02067                                       <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>,
02068                                       8);
02069                     }
02070                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NextPhysicalPage != (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> +
02071                                                  FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>));
02072                     NextPhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
02073                     NumberOfPages = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
02074                     SwitchedDescriptors = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02075                 }
02076 
02077                 *PointerPte = TempPte;
02078                 RtlZeroMemory (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte),
02079                                <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02080             }
02081 
02082             PointerPte += 1;
02083         }
02084     }
02085 
02086     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>; i += 1) {
02087         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][i].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
02088         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][i].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
02089     }
02090 
02091     <span class="comment">//</span>
02092     <span class="comment">// Add nonpaged pool to PFN database if mapped via KSEG0.</span>
02093     <span class="comment">//</span>
02094 
02095     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PTE_BASE);
02096 
02097     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> &lt; (PVOID)<a class="code" href="../../d6/d8/mi386_8h.html#a11">MM_KSEG2_BASE</a>) &amp;&amp; (MapLargePages != 0)) {
02098         j = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>);
02099         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (j);
02100         i = <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
02101 
02102         <a class="code" href="../../d2/d1/mm_8h.html#a64">PERFINFO_INIT_POOLRANGE</a>(Pfn1 - <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>, i);
02103 
02104         <span class="keywordflow">do</span> {
02105             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a3">MM_KSEG0_BASE</a> + (j &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
02106             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPde);
02107             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(j &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02108             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
02109             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
02110             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
02111             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
02112             j += 1;
02113             Pfn1 += 1;
02114             i -= 1;
02115         } <span class="keywordflow">while</span> ( i );
02116     }
02117 
02118     <span class="comment">//</span>
02119     <span class="comment">// Go through the page table entries and for any page which is valid,</span>
02120     <span class="comment">// update the corresponding PFN database element.</span>
02121     <span class="comment">//</span>
02122 
02123     Pde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02124     va = 0;
02125     PdeCount = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a>;
02126 <span class="preprocessor">#if defined(_X86PAE_)</span>
02127 <span class="preprocessor"></span>    PdeCount *= PD_PER_SYSTEM;
02128 <span class="preprocessor">#endif</span>
02129 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (i = 0; i &lt; PdeCount; i += 1) {
02130 
02131         <span class="comment">//</span>
02132         <span class="comment">// If the kernel image has been biased to allow for 3gb of user</span>
02133         <span class="comment">// address space, then the first 16mb of memory is double mapped</span>
02134         <span class="comment">// to KSEG0_BASE and to ALTERNATE_BASE. Therefore, the KSEG0_BASE</span>
02135         <span class="comment">// entries must be skipped.</span>
02136         <span class="comment">//</span>
02137 
02138         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> != 0) {
02139             <span class="keywordflow">if</span> ((Pde &gt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a>)) &amp;&amp;
02140                 (Pde &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> + 16 * 1024 * 1024))) {
02141                 Pde += 1;
02142                 va += (ULONG)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a> * (ULONG)<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02143                 <span class="keywordflow">continue</span>;
02144             }
02145         }
02146 
02147         <span class="keywordflow">if</span> ((Pde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) &amp;&amp; (Pde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.LargePage == 0)) {
02148 
02149             PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(Pde);
02150             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PdePage);
02151             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPde);
02152             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = Pde;
02153             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
02154             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
02155             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
02156             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
02157 
02158             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (va);
02159 
02160             <span class="comment">//</span>
02161             <span class="comment">// Set global bit.</span>
02162             <span class="comment">//</span>
02163 
02164             Pde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long |= <a class="code" href="../../d2/d8/setmodfy_8c.html#a1">MiDetermineUserGlobalPteMask</a> (PointerPte) &amp;
02165                                                            ~<a class="code" href="../../d6/d8/mi386_8h.html#a77">MM_PTE_ACCESS_MASK</a>;
02166             <span class="keywordflow">for</span> (j = 0 ; j &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>; j += 1) {
02167                 <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
02168 
02169                     PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long |= <a class="code" href="../../d2/d8/setmodfy_8c.html#a1">MiDetermineUserGlobalPteMask</a> (PointerPte) &amp;
02170                                                             ~<a class="code" href="../../d6/d8/mi386_8h.html#a77">MM_PTE_ACCESS_MASK</a>;
02171 
02172                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
02173 
02174                     <span class="keywordflow">if</span> ((PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber &lt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) &amp;&amp;
02175                         ((va &gt;= <a class="code" href="../../d6/d8/mi386_8h.html#a11">MM_KSEG2_BASE</a>) &amp;&amp;
02176                          ((va &lt; (<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> + <a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a>)) ||
02177                           (va &gt;= (<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> + <a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> + 16 * 1024 * 1024)))) ||
02178                         ((NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp;
02179                          (va &gt;= (ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>) &amp;&amp;
02180                          (va &lt; (ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> + <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a>))) {
02181 
02182                         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02183 
02184                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(Pfn2) &amp;&amp;
02185                              <a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>((PUCHAR)(Pfn2+1)-1)) {
02186 
02187                             Pfn2-&gt;PteFrame = PdePage;
02188                             Pfn2-&gt;PteAddress = PointerPte;
02189                             Pfn2-&gt;u2.ShareCount += 1;
02190                             Pfn2-&gt;u3.e2.ReferenceCount = 1;
02191                             Pfn2-&gt;u3.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
02192                             Pfn2-&gt;u3.e1.PageColor = 0;
02193                         }
02194                     }
02195                 }
02196 
02197                 va += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02198                 PointerPte += 1;
02199             }
02200 
02201         } <span class="keywordflow">else</span> {
02202             va += (ULONG)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a> * (ULONG)<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02203         }
02204 
02205         Pde += 1;
02206     }
02207 
02208     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>, &amp;OldIrql);
02209     <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a> ();
02210     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
02211 
02212     <span class="comment">//</span>
02213     <span class="comment">// If the lowest physical page is zero and the page is still unused, mark</span>
02214     <span class="comment">// it as in use. This is temporary as we want to find bugs where a physical</span>
02215     <span class="comment">// page is specified as zero.</span>
02216     <span class="comment">//</span>
02217 
02218     Pfn1 = &amp;<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>[<a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>];
02219 
02220     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a> == 0) &amp;&amp; (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0)) {
02221 
02222         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
02223 
02224         <span class="comment">//</span>
02225         <span class="comment">// Make the reference count non-zero and point it into a</span>
02226         <span class="comment">// page directory.</span>
02227         <span class="comment">//</span>
02228 
02229         Pde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (0xffffffff);
02230         PdePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(Pde);
02231         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PdePageNumber;
02232         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = Pde;
02233         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
02234         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 0xfff0;
02235         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
02236         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
02237     }
02238 
02239     <span class="comment">// end of temporary set to physical page zero.</span>
02240 
02241     <span class="comment">//</span>
02242     <span class="comment">// Walk through the memory descriptors and add pages to the</span>
02243     <span class="comment">// free list in the PFN database.</span>
02244     <span class="comment">//</span>
02245 
02246     <span class="keywordflow">if</span> (NextPhysicalPage &lt; (FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> +
02247                             FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>)) {
02248 
02249         <span class="comment">//</span>
02250         <span class="comment">// We haven't used the other descriptor.</span>
02251         <span class="comment">//</span>
02252 
02253         FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> -= NextPhysicalPage -
02254             OldFreeDescriptorLowMemBase;
02255         FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> = NextPhysicalPage;
02256 
02257     } <span class="keywordflow">else</span> {
02258 
02259         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FreeDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02260         FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> = 0;
02261 
02262         FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> = OldFreeDescriptorBase + OldFreeDescriptorCount - NextPhysicalPage;
02263 
02264         FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> = NextPhysicalPage;
02265 
02266     }
02267 
02268     <span class="comment">//</span>
02269     <span class="comment">// Since the LoaderBlock memory descriptors are generally ordered</span>
02270     <span class="comment">// from low physical memory address to high, walk it backwards so the</span>
02271     <span class="comment">// high physical pages go to the front of the freelists.  The thinking</span>
02272     <span class="comment">// is that pages initially allocated by the system less likely to be</span>
02273     <span class="comment">// freed so don't waste memory below 16mb (or 4gb) that may be needed</span>
02274     <span class="comment">// by drivers later.</span>
02275     <span class="comment">//</span>
02276 
02277     NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Blink;
02278 
02279     <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
02280 
02281         MemoryDescriptor = CONTAINING_RECORD(NextMd,
02282                                              <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
02283                                              ListEntry);
02284 
02285         i = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
02286         NextPhysicalPage = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
02287 
02288         <span class="keywordflow">switch</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a>) {
02289             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a257">LoaderBad</a>:
02290                 <span class="keywordflow">while</span> (i != 0) {
02291                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>],
02292                                         NextPhysicalPage);
02293                     i -= 1;
02294                     NextPhysicalPage += 1;
02295                 }
02296                 <span class="keywordflow">break</span>;
02297 
02298             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a256">LoaderFree</a>:
02299             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a258">LoaderLoadedProgram</a>:
02300             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a259">LoaderFirmwareTemporary</a>:
02301             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a262">LoaderOsloaderStack</a>:
02302 
02303                 FreePfnCount = 0;
02304                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (NextPhysicalPage);
02305                 <span class="keywordflow">while</span> (i != 0) {
02306                     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
02307 
02308                         <span class="comment">//</span>
02309                         <span class="comment">// Set the PTE address to the physical page for</span>
02310                         <span class="comment">// virtual address alignment checking.</span>
02311                         <span class="comment">//</span>
02312 
02313                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> =
02314                                         (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(NextPhysicalPage &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
02315                         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
02316                                             NextPhysicalPage);
02317                         FreePfnCount += 1;
02318                     }
02319                     <span class="keywordflow">else</span> {
02320                         <span class="keywordflow">if</span> (FreePfnCount &gt; LargestFreePfnCount) {
02321                             LargestFreePfnCount = FreePfnCount;
02322                             LargestFreePfnStart = NextPhysicalPage - FreePfnCount;
02323                             FreePfnCount = 0;
02324                         }
02325                     }
02326 
02327                     Pfn1 += 1;
02328                     i -= 1;
02329                     NextPhysicalPage += 1;
02330                 }
02331 
02332                 <span class="keywordflow">if</span> (FreePfnCount &gt; LargestFreePfnCount) {
02333                     LargestFreePfnCount = FreePfnCount;
02334                     LargestFreePfnStart = NextPhysicalPage - FreePfnCount;
02335                 }
02336 
02337                 <span class="keywordflow">break</span>;
02338 
02339             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a260">LoaderFirmwarePermanent</a>:
02340             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a276">LoaderSpecialMemory</a>:
02341             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a277">LoaderBBTMemory</a>:
02342 
02343                 <span class="comment">//</span>
02344                 <span class="comment">// If the descriptor lies within the highest PFN database entry</span>
02345                 <span class="comment">// then create PFN pages for this range.  Note the PFN entries</span>
02346                 <span class="comment">// must be created to support \Device\PhysicalMemory.</span>
02347                 <span class="comment">//</span>
02348 
02349                 <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &lt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
02350 
02351                     <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> + 1) {
02352                         MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> - MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + 1;
02353                         i = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
02354                     }
02355                 }
02356                 <span class="keywordflow">else</span> {
02357                     <span class="keywordflow">break</span>;
02358                 }
02359 
02360                 <span class="comment">//</span>
02361                 <span class="comment">// Fall through as these pages must be marked in use as they</span>
02362                 <span class="comment">// lie within the PFN limits and may be accessed through</span>
02363                 <span class="comment">// \Device\PhysicalMemory.</span>
02364                 <span class="comment">//</span>
02365 
02366             <span class="keywordflow">default</span>:
02367 
02368                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> + <a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> +
02369                                             (NextPhysicalPage &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
02370 
02371                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (NextPhysicalPage);
02372                 <span class="keywordflow">while</span> (i != 0) {
02373 
02374                     <span class="comment">//</span>
02375                     <span class="comment">// Set page as in use.</span>
02376                     <span class="comment">//</span>
02377 
02378                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> + <a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> +
02379                                              (NextPhysicalPage &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
02380 
02381                     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
02382                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPde);
02383                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPte;
02384                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
02385                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
02386                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
02387                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
02388                     }
02389                     Pfn1 += 1;
02390                     i -= 1;
02391                     NextPhysicalPage += 1;
02392                     PointerPte += 1;
02393                 }
02394                 <span class="keywordflow">break</span>;
02395         }
02396 
02397         NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Blink;
02398     }
02399 
02400     <span class="keywordflow">if</span> (PfnInKseg0 == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02401 
02402         <span class="comment">//</span>
02403         <span class="comment">// Indicate that the PFN database is allocated in NonPaged pool.</span>
02404         <span class="comment">//</span>
02405 
02406         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (&amp;<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>[<a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>]);
02407         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02408         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
02409 
02410         <span class="keywordflow">if</span> (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02411             LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (&amp;<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>[<a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a>]);
02412             <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
02413                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02414                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 1;
02415                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
02416                 PointerPte += 1;
02417             }
02418         }
02419 
02420         <span class="comment">//</span>
02421         <span class="comment">// Set the end of the allocation.</span>
02422         <span class="comment">//</span>
02423 
02424         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (&amp;<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>[<a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a>]);
02425         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02426         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
02427 
02428     }
02429     <span class="keywordflow">else</span> {
02430 
02431         <span class="comment">//</span>
02432         <span class="comment">// The PFN database is allocated in KSEG0.</span>
02433         <span class="comment">//</span>
02434         <span class="comment">// Mark all PFN entries for the PFN pages in use.</span>
02435         <span class="comment">//</span>
02436 
02437         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>);
02438         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
02439         <span class="keywordflow">do</span> {
02440             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(PageFrameIndex &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
02441             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
02442             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
02443             PageFrameIndex += 1;
02444             Pfn1 += 1;
02445             PfnAllocation -= 1;
02446         } <span class="keywordflow">while</span> (PfnAllocation != 0);
02447 
02448         <span class="comment">//</span>
02449         <span class="comment">// Scan the PFN database backward for pages that are completely zero.</span>
02450         <span class="comment">// These pages are unused and can be added to the free list.</span>
02451         <span class="comment">//</span>
02452 
02453         BottomPfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>);
02454         <span class="keywordflow">do</span> {
02455 
02456             <span class="comment">//</span>
02457             <span class="comment">// Compute the address of the start of the page that is next</span>
02458             <span class="comment">// lower in memory and scan backwards until that page address</span>
02459             <span class="comment">// is reached or just crossed.</span>
02460             <span class="comment">//</span>
02461 
02462             <span class="keywordflow">if</span> (((ULONG)BottomPfn &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) != 0) {
02463                 BasePfn = (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)((ULONG)BottomPfn &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
02464                 TopPfn = BottomPfn + 1;
02465 
02466             } <span class="keywordflow">else</span> {
02467                 BasePfn = (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)((ULONG)BottomPfn - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02468                 TopPfn = BottomPfn;
02469             }
02470 
02471             <span class="keywordflow">while</span> (BottomPfn &gt; BasePfn) {
02472                 BottomPfn -= 1;
02473             }
02474 
02475             <span class="comment">//</span>
02476             <span class="comment">// If the entire range over which the PFN entries span is</span>
02477             <span class="comment">// completely zero and the PFN entry that maps the page is</span>
02478             <span class="comment">// not in the range, then add the page to the appropriate</span>
02479             <span class="comment">// free list.</span>
02480             <span class="comment">//</span>
02481 
02482             Range = (ULONG)TopPfn - (ULONG)BottomPfn;
02483             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a17">RtlCompareMemoryUlong</a>((PVOID)BottomPfn, Range, 0) == Range) {
02484 
02485                 <span class="comment">//</span>
02486                 <span class="comment">// Set the PTE address to the physical page for virtual</span>
02487                 <span class="comment">// address alignment checking.</span>
02488                 <span class="comment">//</span>
02489 
02490                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (BasePfn);
02491                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
02492 
02493                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1);
02494                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> == (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(PageFrameIndex &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>));
02495                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 0;
02496                 PfnAllocation += 1;
02497                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(PageFrameIndex &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
02498                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
02499                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a>(<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
02500                                    PageFrameIndex);
02501             }
02502         } <span class="keywordflow">while</span> (BottomPfn &gt; <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>);
02503     }
02504 
02505     <span class="comment">//</span>
02506     <span class="comment">// Indicate that nonpaged pool must succeed is allocated in</span>
02507     <span class="comment">// nonpaged pool.</span>
02508     <span class="comment">//</span>
02509 
02510     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d4/d8/mi_8h.html#a649">MmNonPagedMustSucceed</a>);
02511     i = <a class="code" href="../../d4/d8/mi_8h.html#a627">MmSizeOfNonPagedMustSucceed</a>;
02512     <span class="keywordflow">while</span> ((LONG)i &gt; 0) {
02513         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02514         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
02515         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
02516         i -= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02517         PointerPte += 1;
02518     }
02519 
02520     <span class="comment">//</span>
02521     <span class="comment">// Adjust the memory descriptors to indicate that free pool has</span>
02522     <span class="comment">// been used for nonpaged pool creation.</span>
02523     <span class="comment">//</span>
02524 
02525     FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> = OldFreeDescriptorLowMemCount;
02526     FreeDescriptorLowMem-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> = OldFreeDescriptorLowMemBase;
02527 
02528     <span class="keywordflow">if</span> (FreeDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02529         FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> = OldFreeDescriptorCount;
02530         FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> = OldFreeDescriptorBase;
02531     }
02532 
02533     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;<a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a15">MmSystemSpaceLock</a>);
02534 
02535     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;<a class="code" href="../../d7/d2/alpha_2initkr_8c.html#a2">MmPfnLock</a>);
02536 
02537     <span class="comment">//</span>
02538     <span class="comment">// Initialize the nonpaged available PTEs for mapping I/O space</span>
02539     <span class="comment">// and kernel stacks.</span>
02540     <span class="comment">//</span>
02541 
02542     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>);
02543     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG)PointerPte &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) == 0);
02544 
02545     <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(NonPagedPoolStartVirtual) - PointerPte - 1;
02546 
02547     <a class="code" href="../../d0/d9/sysptes_8c.html#a27">MiInitializeSystemPtes</a> (PointerPte, <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a>, <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>);
02548 
02549     <span class="keywordflow">if</span> (ExtraPtes != 0) {
02550 
02551         <span class="comment">//</span>
02552         <span class="comment">// Add extra system PTEs to the pool.</span>
02553         <span class="comment">//</span>
02554 
02555         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d6/d8/mi386_8h.html#a5">KSTACK_POOL_START</a>);
02556         <a class="code" href="../../d0/d9/sysptes_8c.html#a28">MiAddSystemPtes</a> (PointerPte, ExtraPtes, <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>);
02557     }
02558 
02559     <span class="comment">//</span>
02560     <span class="comment">// Add pages to nonpaged pool if we could not allocate enough physically</span>
02561     <span class="comment">// contiguous.</span>
02562     <span class="comment">//</span>
02563 
02564     j = (SavedSize - <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
02565 
02566     <span class="keywordflow">if</span> ((j != 0) &amp;&amp; (<a class="code" href="../../d2/d1/inialpha_8c.html#a4">MmExpandedNonPagedPoolInBytes</a> == 0)) {
02567 
02568         ULONG CountContiguous;
02569 
02570         CountContiguous = LargestFreePfnCount;
02571         PageFrameIndex = LargestFreePfnStart - 1;
02572 
02573         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (NonPagedPoolStartVirtual);
02574 
02575         <span class="keywordflow">while</span> (j) {
02576             <span class="keywordflow">if</span> (CountContiguous) {
02577                 PageFrameIndex += 1;
02578                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a12">MiUnlinkFreeOrZeroedPage</a> (PageFrameIndex);
02579                 CountContiguous -= 1;
02580             } <span class="keywordflow">else</span> {
02581                 PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (
02582                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (PointerPte));
02583             }
02584             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02585 
02586             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
02587             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 1;
02588             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPte;
02589             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
02590             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte));
02591             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
02592 
02593             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
02594             *PointerPte = TempPte;
02595             PointerPte += 1;
02596 
02597             j -= 1;
02598         }
02599         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
02600         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(NonPagedPoolStartVirtual)-&gt;u.Hard.PageFrameNumber);
02601         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
02602 
02603         Range = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a52">MmAllocatedNonPagedPool</a>;
02604         <a class="code" href="../../d1/d6/allocpag_8c.html#a55">MiFreePoolPages</a> (NonPagedPoolStartVirtual);
02605         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a52">MmAllocatedNonPagedPool</a> = Range;
02606     }
02607 
02608     <span class="comment">//</span>
02609     <span class="comment">// Initialize the nonpaged pool.</span>
02610     <span class="comment">//</span>
02611 
02612     <a class="code" href="../../d5/d8/ex_8h.html#a215">InitializePool</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, 0);
02613 
02614     <span class="comment">//</span>
02615     <span class="comment">// Initialize memory management structures for this process.</span>
02616     <span class="comment">//</span>
02617 
02618     <span class="comment">//</span>
02619     <span class="comment">// Build working set list.  This requires the creation of a PDE</span>
02620     <span class="comment">// to map HYPER space and the page table page pointed to</span>
02621     <span class="comment">// by the PDE must be initialized.</span>
02622     <span class="comment">//</span>
02623     <span class="comment">// Note, we can't remove a zeroed page as hyper space does not</span>
02624     <span class="comment">// exist and we map non-zeroed pages into hyper space to zero.</span>
02625     <span class="comment">//</span>
02626 
02627     TempPde = <a class="code" href="../../d4/d2/datalpha_8c.html#a8">ValidKernelPdeLocal</a>;
02628 
02629     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>);
02630 
02631     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02632 
02633     PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (0);
02634     TempPde.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
02635     *PointerPde = TempPde;
02636 
02637 <span class="preprocessor">#if defined (_X86PAE_)</span>
02638 <span class="preprocessor"></span>    PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>((PVOID)((PCHAR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a> + <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>));
02639 
02640     PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (0);
02641     TempPde.u.Hard.PageFrameNumber = PageFrameIndex;
02642     *PointerPde = TempPde;
02643 
02644     <span class="comment">//</span>
02645     <span class="comment">// Point to the page table page we just created and zero it.</span>
02646     <span class="comment">//</span>
02647 
02648     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
02649     RtlZeroMemory (PointerPte, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02650 <span class="preprocessor">#endif</span>
02651 <span class="preprocessor"></span>
02652     <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a>();
02653 
02654     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02655 
02656     <span class="comment">//</span>
02657     <span class="comment">// Point to the page table page we just created and zero it.</span>
02658     <span class="comment">//</span>
02659 
02660     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>);
02661     RtlZeroMemory ((PVOID)PointerPte, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02662 
02663     <span class="comment">//</span>
02664     <span class="comment">// Hyper space now exists, set the necessary variables.</span>
02665     <span class="comment">//</span>
02666 
02667     <a class="code" href="../../d4/d8/mi_8h.html#a615">MmFirstReservedMappingPte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a64">FIRST_MAPPING_PTE</a>);
02668     <a class="code" href="../../d4/d8/mi_8h.html#a616">MmLastReservedMappingPte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a66">LAST_MAPPING_PTE</a>);
02669 
02670     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a69">WORKING_SET_LIST</a>;
02671     <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a> = (<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>)((PUCHAR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a69">WORKING_SET_LIST</a> + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/struct__MMWSL.html">MMWSL</a>));
02672 
02673     <span class="comment">//</span>
02674     <span class="comment">// Initialize this process's memory management structures including</span>
02675     <span class="comment">// the working set list.</span>
02676     <span class="comment">//</span>
02677 
02678     <span class="comment">//</span>
02679     <span class="comment">// The PFN element for the page directory has already been initialized,</span>
02680     <span class="comment">// zero the reference count and the share count so they won't be</span>
02681     <span class="comment">// wrong.</span>
02682     <span class="comment">//</span>
02683 
02684     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PdePageNumber);
02685 
02686     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02687 
02688     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
02689     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 0;
02690 
02691 <span class="preprocessor">#if defined (_X86PAE_)</span>
02692 <span class="preprocessor"></span>    PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PDE_BASE);
02693     <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM; i += 1) {
02694 
02695         PdePageNumber = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPte);
02696 
02697         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PdePageNumber);
02698         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
02699         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 0;
02700 
02701         PointerPte += 1;
02702     }
02703 <span class="preprocessor">#endif</span>
02704 <span class="preprocessor"></span>
02705     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
02706 
02707     <span class="comment">//</span>
02708     <span class="comment">// Get a page for the working set list and zero it.</span>
02709     <span class="comment">//</span>
02710 
02711     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a3">ValidKernelPteLocal</a>;
02712     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>);
02713     PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (0);
02714 
02715     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
02716     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>);
02717     *PointerPte = TempPte;
02718     RtlZeroMemory ((PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02719     *PointerPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
02720 
02721     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o23">WorkingSetPage</a> = PageFrameIndex;
02722 
02723 <span class="preprocessor">#if defined (_X86PAE_)</span>
02724 <span class="preprocessor"></span>    MiPaeInitialize ();
02725 <span class="preprocessor">#endif</span>
02726 <span class="preprocessor"></span>
02727     <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a>();
02728 
02729     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02730 
02731     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> = <a class="code" href="../../d4/d8/mi_8h.html#a740">MmSystemProcessWorkingSetMax</a>;
02732     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a> = <a class="code" href="../../d4/d8/mi_8h.html#a739">MmSystemProcessWorkingSetMin</a>;
02733 
02734     <a class="code" href="../../d4/d5/procsup_8c.html#a30">MmInitializeProcessAddressSpace</a> (CurrentProcess,
02735                                      (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02736                                      (PVOID)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02737                                      (PVOID)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02738 
02739     <span class="comment">//</span>
02740     <span class="comment">// Check to see if moving the secondary page structures to the end</span>
02741     <span class="comment">// of the PFN database is a waste of memory.</span>
02742     <span class="comment">//</span>
02743     <span class="comment">// If the PFN database ends on a page aligned boundary and the</span>
02744     <span class="comment">// size of the two arrays is less than a page, free the page</span>
02745     <span class="comment">// and reallocate it from nonpagedpool.</span>
02746     <span class="comment">//</span>
02747 
02748     <span class="keywordflow">if</span> (NeedLowVirtualPfn == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02749 
02750         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0] &lt; (<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">PMMCOLOR_TABLES</a>)<a class="code" href="../../d6/d8/mi386_8h.html#a11">MM_KSEG2_BASE</a>);
02751 
02752         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0]);
02753         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
02754 
02755         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0]);
02756         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid == 1);
02757 
02758         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPte);
02759         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02760 
02761         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02762 
02763         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
02764             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPde);
02765             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPte;
02766             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
02767             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
02768             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
02769             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
02770         }
02771         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02772     }
02773     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((((ULONG)<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0] &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) == 0) &amp;&amp;
02774         ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * 2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>)) &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
02775 
02776         <a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">PMMCOLOR_TABLES</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
02777 
02778         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0];
02779 
02780         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0] = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
02781                                <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * 2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>),
02782                                '  mM');
02783 
02784         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[1] = &amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0][<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>];
02785 
02786         RtlMoveMemory (<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0],
02787                        <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>,
02788                        <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * 2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a202">MMCOLOR_TABLES</a>));
02789 
02790         <span class="comment">//</span>
02791         <span class="comment">// Free the page.</span>
02792         <span class="comment">//</span>
02793 
02794         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &gt; (<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">PMMCOLOR_TABLES</a>)<a class="code" href="../../d6/d8/mi386_8h.html#a11">MM_KSEG2_BASE</a>) {
02795             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>);
02796             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPte);
02797             *PointerPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
02798         } <span class="keywordflow">else</span> {
02799             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>);
02800         }
02801 
02802         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02803 
02804         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02805         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &lt;= 1) &amp;&amp; (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &lt;= 1));
02806         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
02807         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
02808         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
02809 <span class="preprocessor">#if DBG</span>
02810 <span class="preprocessor"></span>        Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
02811 <span class="preprocessor">#endif //DBG</span>
02812 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
02813 
02814         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02815     }
02816 
02817     <span class="comment">//</span>
02818     <span class="comment">// Handle physical pages in BIOS memory range (640k to 1mb) by</span>
02819     <span class="comment">// explicitly initializing them in the PFN database so that they</span>
02820     <span class="comment">// can be handled properly when I/O is done to these pages (or virtual</span>
02821     <span class="comment">// reads across processes).</span>
02822     <span class="comment">//</span>
02823 
02824 
02825     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (<a class="code" href="../../d1/d2/mm_2i386_2init386_8c.html#a0">MM_BIOS_START</a>);
02826     Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (<a class="code" href="../../d1/d2/mm_2i386_2init386_8c.html#a1">MM_BIOS_END</a>);
02827 
02828     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02829 
02830     <span class="keywordflow">do</span> {
02831         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0) &amp;&amp;
02832             (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) &amp;&amp;
02833             (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> == 0)) {
02834 
02835             <span class="comment">//</span>
02836             <span class="comment">// Set this as in use.</span>
02837             <span class="comment">//</span>
02838 
02839             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
02840             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)0x7FFFFFFF;
02841             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
02842             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
02843         }
02844         Pfn1 += 1;
02845     } <span class="keywordflow">while</span> (Pfn1 &lt;= Pfn2);
02846 
02847     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02848 
02849 <span class="preprocessor">#if defined (_X86PAE_)</span>
02850 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a15">MiNoLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02851 
02852         <a class="code" href="../../d4/d8/mi_8h.html#a233">MiCreateBitMap</a> (&amp;MiLowMemoryBitMap, 1024 * 1024, <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
02853 
02854         <span class="keywordflow">if</span> (MiLowMemoryBitMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02855             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a27">RtlClearAllBits</a> (MiLowMemoryBitMap);
02856             <a class="code" href="../../d8/d8/sysload_8c.html#a52">MiRemoveLowPages</a> ();
02857             <a class="code" href="../../d8/d0/cmdat3_8c.html#a34">MmMakeLowMemory</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02858         }
02859     }
02860 <span class="preprocessor">#endif</span>
02861 <span class="preprocessor"></span>
02862     <span class="keywordflow">return</span>;
02863 }
02864 
02865 <span class="preprocessor">#if defined (_X86PAE_)</span>
02866 <span class="preprocessor"></span>
02867 <span class="preprocessor">#define MI_MAGIC_4GB_RECLAIM   0xffffedf0</span>
02868 <span class="preprocessor"></span>
02869 ULONG MiRemoveCount;
02870 
02871 <span class="comment">//</span>
02872 <span class="comment">// Normally there are approximately 15 runs.</span>
02873 <span class="comment">//</span>
02874 
02875 <span class="preprocessor">#define MI_MAXPAERUNS   30</span>
02876 <span class="preprocessor"></span>
02877 <span class="keyword">typedef</span> <span class="keyword">struct </span>_PAERUN {
02878     PFN_NUMBER StartFrame;
02879     PFN_NUMBER EndFrame;
02880 } PAERUN, *PPAERUN;
02881 
02882 PAERUN MiUnclaimed[MI_MAXPAERUNS];
02883 
02884 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02885 <a class="code" href="../../d8/d8/sysload_8c.html#a52">MiRemoveLowPages</a> (
02886     VOID
02887     )
02888 
02889 <span class="comment">/*++</span>
02890 <span class="comment"></span>
02891 <span class="comment">Routine Description:</span>
02892 <span class="comment"></span>
02893 <span class="comment">    This routine removes all pages below 4GB on a PAE system.  This lets</span>
02894 <span class="comment">    us find problems with device drivers by putting all accesses high.</span>
02895 <span class="comment"></span>
02896 <span class="comment">Arguments:</span>
02897 <span class="comment"></span>
02898 <span class="comment">    None.</span>
02899 <span class="comment"></span>
02900 <span class="comment">Return Value:</span>
02901 <span class="comment"></span>
02902 <span class="comment">    None.</span>
02903 <span class="comment"></span>
02904 <span class="comment">Environment:</span>
02905 <span class="comment"></span>
02906 <span class="comment">    Kernel mode.</span>
02907 <span class="comment"></span>
02908 <span class="comment">--*/</span>
02909 
02910 {
02911     ULONG i;
02912     KIRQL OldIrql;
02913     KIRQL OldIrqlHyper;
02914     PFN_COUNT PageCount;
02915     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnNextColored;
02916     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnNextFlink;
02917     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnLastColored;
02918     PFN_NUMBER PageNextColored;
02919     PFN_NUMBER PageNextFlink;
02920     PFN_NUMBER PageLastColored;
02921     PFN_NUMBER Page;
02922     PFN_NUMBER HighPage;
02923     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02924     <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead;
02925     ULONG Color;
02926     <a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">PMMCOLOR_TABLES</a> ColorHead;
02927     PFN_NUMBER MovedPage;
02928     PVOID TempVa;
02929 
02930     <span class="keywordflow">if</span> (MiLowMemoryBitMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02931         <span class="keywordflow">return</span>;
02932     }
02933 
02934     ListHead = <a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>];
02935     PageCount = 0;
02936 
02937     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02938 
02939     <span class="keywordflow">for</span> (Color = 0; Color &lt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>; Color += 1) {
02940         ColorHead = &amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][Color];
02941 
02942         MovedPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
02943 
02944         <span class="keywordflow">while</span> (ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
02945 
02946             Page = ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a>;
02947 
02948             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
02949 
02950             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == FreePageList);
02951 
02952             <span class="comment">// </span>
02953             <span class="comment">// The Flink and Blink must be nonzero here for the page</span>
02954             <span class="comment">// to be on the listhead.  Only code that scans the</span>
02955             <span class="comment">// MmPhysicalMemoryBlock has to check for the zero case.</span>
02956             <span class="comment">//</span>
02957 
02958             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != 0);
02959             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink != 0);
02960 
02961             <span class="comment">//</span>
02962             <span class="comment">// See if the page is below 4GB.</span>
02963             <span class="comment">//</span>
02964 
02965             <span class="keywordflow">if</span> (Page &gt;= 0x100000) {
02966 
02967                 <span class="comment">//</span>
02968                 <span class="comment">// Put page on end of list and if first time, save pfn.</span>
02969                 <span class="comment">//</span>
02970 
02971                 <span class="keywordflow">if</span> (MovedPage == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
02972                     MovedPage = Page;
02973                 }
02974                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Page == MovedPage) {
02975 
02976                     <span class="comment">//</span>
02977                     <span class="comment">// No more pages available in this colored chain.</span>
02978                     <span class="comment">//</span>
02979 
02980                     <span class="keywordflow">break</span>;
02981                 }
02982 
02983                 <span class="comment">//</span>
02984                 <span class="comment">// If the colored chain has more than one entry then</span>
02985                 <span class="comment">// put this page on the end.</span>
02986                 <span class="comment">//</span>
02987 
02988                 PageNextColored = (PFN_NUMBER)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
02989 
02990                 <span class="keywordflow">if</span> (PageNextColored == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
02991 
02992                     <span class="comment">//</span>
02993                     <span class="comment">// No more pages available in this colored chain.</span>
02994                     <span class="comment">//</span>
02995 
02996                     <span class="keywordflow">break</span>;
02997                 }
02998 
02999                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != 0);
03000                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != MM_EMPTY_LIST);
03001                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_4GB_RECLAIM);
03002 
03003                 PfnNextColored = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageNextColored);
03004                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)PfnNextColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == FreePageList);
03005                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnNextColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_4GB_RECLAIM);
03006 
03007                 <span class="comment">//</span>
03008                 <span class="comment">// Adjust the free page list so Page</span>
03009                 <span class="comment">// follows PageNextFlink.</span>
03010                 <span class="comment">//</span>
03011 
03012                 PageNextFlink = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink;
03013                 PfnNextFlink = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageNextFlink);
03014 
03015                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)PfnNextFlink-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == FreePageList);
03016                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnNextFlink-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_4GB_RECLAIM);
03017 
03018                 PfnLastColored = ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o1">Blink</a>;
03019                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored != (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)MM_EMPTY_LIST);
03020                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == MM_EMPTY_LIST);
03021                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_4GB_RECLAIM);
03022                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink != MM_EMPTY_LIST);
03023 
03024                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == FreePageList);
03025                 PageLastColored = PfnLastColored - <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>;
03026 
03027                 <span class="keywordflow">if</span> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> == Page) {
03028 
03029                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink == MM_EMPTY_LIST);
03030                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> != Page);
03031 
03032                     ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = PageNextFlink;
03033 
03034                     PfnNextFlink-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
03035                 }
03036                 <span class="keywordflow">else</span> {
03037 
03038                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink != MM_EMPTY_LIST);
03039                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink)-&gt;u1.Flink)))-&gt;PteFrame != MI_MAGIC_4GB_RECLAIM);
03040                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink)-&gt;u1.Flink)))-&gt;u3.e1.PageLocation == FreePageList);
03041 
03042                     <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink)-&gt;u1.Flink = PageNextFlink;
03043                     PfnNextFlink-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink;
03044                 }
03045 
03046 <span class="preprocessor">#if DBG</span>
03047 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
03048                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> == PageLastColored);
03049                 }
03050 <span class="preprocessor">#endif</span>
03051 <span class="preprocessor"></span>
03052                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink;
03053                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = PageLastColored;
03054 
03055                 <span class="keywordflow">if</span> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> == PageLastColored) {
03056                     ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = Page;
03057                 }
03058 
03059                 <span class="comment">//</span>
03060                 <span class="comment">// Adjust the colored chains.</span>
03061                 <span class="comment">//</span>
03062 
03063                 <span class="keywordflow">if</span> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
03064                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink)-&gt;PteFrame != MI_MAGIC_4GB_RECLAIM);
03065                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink)-&gt;u3.e1.PageLocation) == FreePageList);
03066                     <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink)-&gt;u2.Blink = Page;
03067                 }
03068 
03069                 PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = Page;
03070 
03071                 ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> = PageNextColored;
03072                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
03073 
03074                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == MM_EMPTY_LIST);
03075                 PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = Page;
03076                 ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o1">Blink</a> = Pfn1;
03077 
03078                 <span class="keywordflow">continue</span>;
03079             }
03080 
03081             <span class="comment">//</span>
03082             <span class="comment">// Page is below 4GB so reclaim it.</span>
03083             <span class="comment">//</span>
03084 
03085             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress == 0);
03086             <a class="code" href="../../d7/d5/pfnlist_8c.html#a12">MiUnlinkFreeOrZeroedPage</a> (Page);
03087             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
03088 
03089             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
03090             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 1;
03091             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a>(Pfn1);
03092             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
03093             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = MI_MAGIC_4GB_RECLAIM;
03094             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
03095 
03096             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
03097             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
03098             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation = 0;
03099             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation = 0;
03100 
03101             <span class="comment">//</span>
03102             <span class="comment">// Fill the actual page with a recognizable data pattern.  No one</span>
03103             <span class="comment">// else should write to these pages unless they are allocated for</span>
03104             <span class="comment">// a contiguous memory request.</span>
03105             <span class="comment">//</span>
03106 
03107             TempVa = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (Page, &amp;OldIrqlHyper);
03108 
03109             RtlFillMemoryUlong (TempVa,
03110                                 PAGE_SIZE,
03111                                 Page | MI_LOWMEM_MAGIC_BIT);
03112 
03113             <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrqlHyper);
03114 
03115             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Page &lt; MiLowMemoryBitMap-&gt;SizeOfBitMap);
03116             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (RtlCheckBit (MiLowMemoryBitMap, Page) == 0);
03117             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a34">RtlSetBits</a> (MiLowMemoryBitMap, Page, 1L);
03118             PageCount += 1;
03119         }
03120     }
03121 
03122     <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> -= PageCount;
03123 
03124     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03125 
03126 <span class="preprocessor">#if DBG</span>
03127 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Removed 0x%x pages from low memory for PAE testing\n"</span>, PageCount);
03128 <span class="preprocessor">#endif</span>
03129 <span class="preprocessor"></span>
03130     MiRemoveCount += 1;
03131 
03132     <span class="keywordflow">if</span> (MiRemoveCount == 2) {
03133         ULONG run;
03134         ULONG total;
03135         ULONG RunIndex;
03136 
03137         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(0);
03138         run = 0;
03139         total = 0;
03140         RunIndex = 0;
03141 
03142 <span class="preprocessor">#if DBG</span>
03143 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Unclaimable Pages below 4GB are:\n\n"</span>);
03144         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"StartPage EndPage  Length\n"</span>);
03145 <span class="preprocessor">#endif</span>
03146 <span class="preprocessor"></span>
03147         <span class="keywordflow">for</span> (i = 0; i &lt; 0x100001; i += 1) {
03148             <span class="keywordflow">if</span> ((!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>)) ||
03149                 (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> == MI_MAGIC_4GB_RECLAIM) ||
03150                 (i == 0x100000)) {
03151 
03152                 <span class="keywordflow">if</span> (run != 0) {
03153 <span class="preprocessor">#if DBG</span>
03154 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"%08lx  %08lx %08lx\n"</span>,
03155                                 Pfn1 - run - MmPfnDatabase,
03156                                 Pfn1 - MmPfnDatabase - 1,
03157                                 run);
03158 <span class="preprocessor">#endif</span>
03159 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (RunIndex &lt; MI_MAXPAERUNS) {
03160                         MiUnclaimed[RunIndex].StartFrame = Pfn1 - run - <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>;
03161                         MiUnclaimed[RunIndex].EndFrame =  Pfn1 - <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> - 1;
03162                         RunIndex += 1;
03163                     }
03164                     run = 0;
03165                 }
03166             }
03167             <span class="keywordflow">else</span> {
03168                 total += 1;
03169                 run += 1;
03170             }
03171             Pfn1 += 1;
03172         }
03173 <span class="preprocessor">#if DBG</span>
03174 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Total 0x%x Unclaimable Pages below 4GB\n\n"</span>, total);
03175 <span class="preprocessor">#endif</span>
03176 <span class="preprocessor"></span>
03177         <span class="comment">//</span>
03178         <span class="comment">// For every page below 4GB that could not be reclaimed, don't use the</span>
03179         <span class="comment">// high modulo-4GB equivalent page.  The motivation is to prevent</span>
03180         <span class="comment">// code bugs that drop the high bits from destroying critical</span>
03181         <span class="comment">// system data in the unclaimed pages (like the GDT, IDT, kernel code</span>
03182         <span class="comment">// and data, etc).</span>
03183         <span class="comment">//</span>
03184 
03185         total = 0;
03186 
03187         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03188 
03189         <span class="keywordflow">for</span> (i = 0; i &lt; RunIndex; i += 1) {
03190             Page = MiUnclaimed[i].StartFrame;
03191             PageCount = MiUnclaimed[i].EndFrame -
03192                             MiUnclaimed[i].StartFrame + 1;
03193 
03194             <span class="keywordflow">while</span> (PageCount != 0) {
03195                 HighPage = Page + 0x100000;
03196     
03197                 <span class="keywordflow">while</span> (HighPage &lt;= <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
03198 
03199                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (HighPage);
03200             
03201                     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(Pfn1)) &amp;&amp;
03202                         (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>((PCHAR)Pfn1 + <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__MMPFN.html">MMPFN</a>) - 1)) &amp;&amp;
03203                         ((ULONG)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation &lt;= (ULONG)<a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) &amp;&amp;
03204                         (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != 0) &amp;&amp;
03205                         (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink != 0) &amp;&amp;
03206                         (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0)) {
03207         
03208                             <span class="comment">//</span>
03209                             <span class="comment">// This page can be taken.</span>
03210                             <span class="comment">//</span>
03211     
03212                             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) {
03213                                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
03214                                 <a class="code" href="../../d0/d2/mmsup_8c.html#a15">MiRestoreTransitionPte</a> (HighPage);
03215                             } <span class="keywordflow">else</span> {
03216                                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a12">MiUnlinkFreeOrZeroedPage</a> (HighPage);
03217                             }
03218     
03219                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ShortFlags = 0;
03220                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
03221                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
03222                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 1;
03223                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)-2;
03224                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
03225                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = MI_MAGIC_4GB_RECLAIM;
03226                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
03227                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation = 0;
03228                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation = 0;
03229                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
03230                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
03231 
03232                             <span class="comment">//</span>
03233                             <span class="comment">// Fill the actual page with a recognizable data</span>
03234                             <span class="comment">// pattern.  No one else should write to these</span>
03235                             <span class="comment">// pages unless they are allocated for</span>
03236                             <span class="comment">// a contiguous memory request.</span>
03237                             <span class="comment">//</span>
03238                 
03239                             TempVa = (PULONG)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (HighPage,
03240                                                                     &amp;OldIrqlHyper);
03241                             RtlFillMemoryUlong (TempVa,
03242                                                 PAGE_SIZE,
03243                                                 HighPage | MI_LOWMEM_MAGIC_BIT);
03244 
03245                             <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrqlHyper);
03246                 
03247                             total += 1;
03248                     }
03249                     HighPage += 0x100000;
03250                 }
03251                 Page += 1;
03252                 PageCount -= 1;
03253             }
03254         }
03255 
03256         <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> -= total;
03257 
03258         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03259 
03260 <span class="preprocessor">#if DBG</span>
03261 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (total != 0) {
03262             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Total 0x%x Above-4GB Alias Pages also reclaimed\n\n"</span>, total);
03263         }
03264 <span class="preprocessor">#endif</span>
03265 <span class="preprocessor"></span>    }
03266 }
03267 
03268 <span class="keyword">extern</span> <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">POOL_DESCRIPTOR</a> <a class="code" href="../../d2/d2/ex_2pool_8c.html#a52">NonPagedPoolDescriptor</a>;
03269 
03270 PVOID
03271 <a class="code" href="../../d4/d5/procsup_8c.html#a27">MiAllocateLowMemory</a> (
03272     IN SIZE_T NumberOfBytes,
03273     IN PFN_NUMBER LowestAcceptablePfn,
03274     IN PFN_NUMBER HighestAcceptablePfn,
03275     IN PFN_NUMBER BoundaryPfn,
03276     IN PVOID CallingAddress,
03277     IN ULONG Tag
03278     )
03279 
03280 <span class="comment">/*++</span>
03281 <span class="comment"></span>
03282 <span class="comment">Routine Description:</span>
03283 <span class="comment"></span>
03284 <span class="comment">    This is a special routine for allocating contiguous physical memory below</span>
03285 <span class="comment">    4GB on a PAE system that has been booted in test mode where all this memory</span>
03286 <span class="comment">    has been made generally unavailable to all components.  This lets us find</span>
03287 <span class="comment">    problems with device drivers.</span>
03288 <span class="comment"></span>
03289 <span class="comment">Arguments:</span>
03290 <span class="comment"></span>
03291 <span class="comment">    NumberOfBytes - Supplies the number of bytes to allocate.</span>
03292 <span class="comment"></span>
03293 <span class="comment">    LowestAcceptablePfn - Supplies the lowest page frame number</span>
03294 <span class="comment">                          which is valid for the allocation.</span>
03295 <span class="comment"></span>
03296 <span class="comment">    HighestAcceptablePfn - Supplies the highest page frame number</span>
03297 <span class="comment">                           which is valid for the allocation.</span>
03298 <span class="comment"></span>
03299 <span class="comment">    BoundaryPfn - Supplies the page frame number multiple the allocation must</span>
03300 <span class="comment">                  not cross.  0 indicates it can cross any boundary.</span>
03301 <span class="comment"></span>
03302 <span class="comment">    CallingAddress - Supplies the calling address of the allocator.</span>
03303 <span class="comment"></span>
03304 <span class="comment">    Tag - Supplies the tag to tie to this allocation.</span>
03305 <span class="comment"></span>
03306 <span class="comment">Return Value:</span>
03307 <span class="comment"></span>
03308 <span class="comment">    NULL - a contiguous range could not be found to satisfy the request.</span>
03309 <span class="comment"></span>
03310 <span class="comment">    NON-NULL - Returns a pointer (virtual address in the nonpaged portion</span>
03311 <span class="comment">               of the system) to the allocated physically contiguous</span>
03312 <span class="comment">               memory.</span>
03313 <span class="comment"></span>
03314 <span class="comment">Environment:</span>
03315 <span class="comment"></span>
03316 <span class="comment">    Kernel mode, IRQL of APC_LEVEL or below.</span>
03317 <span class="comment"></span>
03318 <span class="comment">--*/</span>
03319 
03320 {
03321     PFN_NUMBER Page;
03322     PFN_NUMBER BoundaryMask;
03323     PVOID BaseAddress;
03324     KIRQL OldIrql;
03325     KIRQL OldIrql2;
03326     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03327     ULONG BitMapHint;
03328     PFN_NUMBER SizeInPages;
03329     PFN_NUMBER SizeInPages2;
03330     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03331     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPte;
03332     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03333     ULONG PageColor;
03334 
03335     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03336 
03337     BitMapHint = LowestAcceptablePfn;
03338     SizeInPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (NumberOfBytes);
03339     SizeInPages2 = SizeInPages;
03340     BoundaryMask = ~(BoundaryPfn - 1);
03341 
03342     OldIrql = <a class="code" href="../../d5/d8/ex_8h.html#a226">ExLockPool</a> (NonPagedPool);
03343 
03344     <span class="comment">//</span>
03345     <span class="comment">// Try to find system PTES to expand the pool into.</span>
03346     <span class="comment">//</span>
03347 
03348     PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> ((ULONG)SizeInPages,
03349                                       SystemPteSpace,
03350                                       0,
03351                                       0,
03352                                       FALSE);
03353 
03354     <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03355         <span class="keywordflow">goto</span> Fail1;
03356     }
03357 
03358     StartPte = PointerPte;
03359 
03360     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql2);
03361 
03362     <span class="keywordflow">do</span> {
03363         Page = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a30">RtlFindSetBits</a> (MiLowMemoryBitMap, SizeInPages, BitMapHint);
03364 
03365         <span class="keywordflow">if</span> (Page == (ULONG)-1) {
03366             <span class="keywordflow">goto</span> Fail2;
03367         }
03368 
03369         <span class="keywordflow">if</span> (BoundaryPfn == 0) {
03370             <span class="keywordflow">break</span>;
03371         }
03372 
03373         <span class="keywordflow">if</span> (((Page ^ (Page + SizeInPages - 1)) &amp; BoundaryMask) == 0) {
03374 
03375             <span class="comment">//</span>
03376             <span class="comment">// This portion of the range meets the alignment requirements.</span>
03377             <span class="comment">//</span>
03378 
03379             <span class="keywordflow">break</span>;
03380         }
03381 
03382         BitMapHint = (Page &amp; BoundaryMask) + BoundaryPfn;
03383 
03384         <span class="keywordflow">if</span> ((BitMapHint &gt;= MiLowMemoryBitMap-&gt;SizeOfBitMap) ||
03385             (BitMapHint + SizeInPages &gt; HighestAcceptablePfn)) {
03386             <span class="keywordflow">goto</span> Fail2;
03387         }
03388 
03389     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03390 
03391     <span class="keywordflow">if</span> (Page + SizeInPages &gt; HighestAcceptablePfn) {
03392         <span class="keywordflow">goto</span> Fail2;
03393     }
03394 
03395     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (MiLowMemoryBitMap, Page, SizeInPages);
03396 
03397     <span class="comment">//</span>
03398     <span class="comment">// No need to update ResidentAvailable or commit as these pages were</span>
03399     <span class="comment">// never added to either.</span>
03400     <span class="comment">//</span>
03401 
03402     BaseAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
03403     PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a125">MI_GET_PAGE_COLOR_FROM_VA</a>(BaseAddress);
03404     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
03405     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a52">MmAllocatedNonPagedPool</a> += SizeInPages;
03406     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a52">NonPagedPoolDescriptor</a>.<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o8">TotalBigPages</a> += (ULONG)SizeInPages;
03407     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Page);
03408 
03409     <span class="keywordflow">do</span> {
03410         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == ActiveAndValid);
03411         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1);
03412         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
03413         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == MM_DEMAND_ZERO_WRITE_PTE);
03414         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation == 0);
03415         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation == 0);
03416 
03417         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a122">MI_CHECK_PAGE_ALIGNMENT</a>(Page, PageColor &amp; MM_COLOR_MASK);
03418         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = PageColor &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>;
03419         PageColor += 1;
03420         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = Page;
03421         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
03422 
03423         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPte;
03424         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte));
03425         <span class="keywordflow">if</span> (StartPte == PointerPte) {
03426             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
03427         }
03428         <span class="keywordflow">else</span> {
03429             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 0;
03430         }
03431         Pfn1 += 1;
03432         PointerPte += 1;
03433         Page += 1;
03434         SizeInPages2 -= 1;
03435     } <span class="keywordflow">while</span> (SizeInPages2 != 0);
03436 
03437     Pfn1 -= 1;
03438     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
03439     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql2);
03440     <a class="code" href="../../d5/d8/ex_8h.html#a227">ExUnlockPool</a> (NonPagedPool, OldIrql);
03441 
03442     BaseAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (StartPte);
03443 
03444 <span class="preprocessor">#if 0</span>
03445 <span class="preprocessor"></span>    <a class="code" href="../../d1/d6/allocpag_8c.html#a3">MiInsertContiguousTag</a> (BaseAddress,
03446                            SizeInPages &lt;&lt; PAGE_SHIFT,
03447                            CallingAddress);
03448 <span class="preprocessor">#endif</span>
03449 <span class="preprocessor"></span>
03450     <a class="code" href="../../d5/d8/ex_8h.html#a216">ExInsertPoolTag</a> (Tag,
03451                      BaseAddress,
03452                      SizeInPages &lt;&lt; PAGE_SHIFT,
03453                      NonPagedPool);
03454 
03455     <span class="keywordflow">return</span> BaseAddress;
03456 
03457 Fail2:
03458     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql2);
03459     <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte, (ULONG)SizeInPages, SystemPteSpace);
03460 
03461 Fail1:
03462     <a class="code" href="../../d5/d8/ex_8h.html#a227">ExUnlockPool</a> (NonPagedPool, OldIrql);
03463 
03464     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03465 }
03466 
03467 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03468 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a80">ExRemovePoolTag</a> (
03469     ULONG Tag,
03470     PVOID Va,
03471     SIZE_T NumberOfBytes
03472     );
03473 
03474 LOGICAL
03475 <a class="code" href="../../d4/d5/procsup_8c.html#a28">MiFreeLowMemory</a> (
03476     IN PVOID BaseAddress,
03477     IN ULONG Tag
03478     )
03479 
03480 <span class="comment">/*++</span>
03481 <span class="comment"></span>
03482 <span class="comment">Routine Description:</span>
03483 <span class="comment"></span>
03484 <span class="comment">    This is a special routine which returns allocated contiguous physical</span>
03485 <span class="comment">    memory below 4GB on a PAE system that has been booted in test mode where</span>
03486 <span class="comment">    all this memory has been made generally unavailable to all components.</span>
03487 <span class="comment">    This lets us find problems with device drivers.</span>
03488 <span class="comment"></span>
03489 <span class="comment">Arguments:</span>
03490 <span class="comment"></span>
03491 <span class="comment">    BaseAddress - Supplies the base virtual address where the physical</span>
03492 <span class="comment">                  address was previously mapped.</span>
03493 <span class="comment"></span>
03494 <span class="comment">    Tag - Supplies the tag for this address.</span>
03495 <span class="comment"></span>
03496 <span class="comment">Return Value:</span>
03497 <span class="comment"></span>
03498 <span class="comment">    TRUE if the allocation was freed by this routine, FALSE if not.</span>
03499 <span class="comment"></span>
03500 <span class="comment">Environment:</span>
03501 <span class="comment"></span>
03502 <span class="comment">    Kernel mode, IRQL of APC_LEVEL or below.</span>
03503 <span class="comment"></span>
03504 <span class="comment">--*/</span>
03505 
03506 {
03507     ULONG i;
03508     PFN_NUMBER Page;
03509     PFN_NUMBER StartPage;
03510     KIRQL OldIrql;
03511     KIRQL OldIrql2;
03512     KIRQL OldIrqlHyper;
03513     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03514     PFN_NUMBER SizeInPages;
03515     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03516     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPte;
03517     PULONG TempVa;
03518 
03519     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03520 
03521     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
03522     StartPte = PointerPte;
03523 
03524     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid == 1);
03525 
03526     Page = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
03527 
03528     <span class="comment">//</span>
03529     <span class="comment">// Only free allocations here that really were obtained from the low pool.</span>
03530     <span class="comment">//</span>
03531 
03532     <span class="keywordflow">if</span> (Page &gt;= 0x100000) {
03533         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03534     }
03535 
03536     StartPage = Page;
03537     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Page);
03538 
03539     SizeInPages = 0;
03540 
03541     OldIrql = <a class="code" href="../../d5/d8/ex_8h.html#a226">ExLockPool</a> (NonPagedPool);
03542 
03543     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql2);
03544 
03545     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation == 1);
03546     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 0;
03547 
03548     <span class="keywordflow">do</span> {
03549         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == ActiveAndValid);
03550         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
03551         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == MM_DEMAND_ZERO_WRITE_PTE);
03552         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation == 0);
03553         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation == 0);
03554 
03555         <span class="keywordflow">while</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 1) {
03556 
03557             <span class="comment">//</span>
03558             <span class="comment">// A driver is still transferring data even though the caller</span>
03559             <span class="comment">// is freeing the memory.   Wait a bit before restarting at</span>
03560             <span class="comment">// the beginning.</span>
03561             <span class="comment">//</span>
03562 
03563             <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql2);
03564             <a class="code" href="../../d5/d8/ex_8h.html#a227">ExUnlockPool</a> (NonPagedPool, OldIrql);
03565 
03566             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;MmShortTime);
03567 
03568             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (StartPage);
03569 
03570 <span class="preprocessor">#if DBG</span>
03571 <span class="preprocessor"></span>            PointerPte = StartPte;
03572 <span class="preprocessor">#endif</span>
03573 <span class="preprocessor"></span>            Page = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
03574             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Page &lt; 0x100000);
03575 
03576             SizeInPages = 0;
03577             OldIrql = <a class="code" href="../../d5/d8/ex_8h.html#a226">ExLockPool</a> (NonPagedPool);
03578             <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql2);
03579         
03580             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation == 0);
03581             <span class="keywordflow">continue</span>;
03582         }
03583 
03584         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = MI_MAGIC_4GB_RECLAIM;
03585 
03586         <span class="comment">//</span>
03587         <span class="comment">// Fill the actual page with a recognizable data</span>
03588         <span class="comment">// pattern.  No one else should write to these</span>
03589         <span class="comment">// pages unless they are allocated for</span>
03590         <span class="comment">// a contiguous memory request.</span>
03591         <span class="comment">//</span>
03592 
03593         TempVa = (PULONG)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (Page,
03594                                                 &amp;OldIrqlHyper);
03595 
03596         RtlFillMemoryUlong (TempVa,
03597                             PAGE_SIZE,
03598                             Page | MI_LOWMEM_MAGIC_BIT);
03599 
03600         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrqlHyper);
03601 
03602         SizeInPages += 1;
03603 
03604         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation == 1) {
03605             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 0;
03606             <span class="keywordflow">break</span>;
03607         }
03608 
03609 <span class="preprocessor">#if DBG</span>
03610 <span class="preprocessor"></span>        PointerPte += 1;
03611         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid == 1);
03612         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPte) == Page + 1);
03613 <span class="preprocessor">#endif</span>
03614 <span class="preprocessor"></span>        Page += 1;
03615         Pfn1 += 1;
03616 
03617     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03618 
03619     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (RtlAreBitsClear (MiLowMemoryBitMap, StartPage, SizeInPages) == TRUE);
03620     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a34">RtlSetBits</a> (MiLowMemoryBitMap, StartPage, SizeInPages);
03621 
03622     <span class="comment">//</span>
03623     <span class="comment">// No need to update ResidentAvailable or commit as these pages were</span>
03624     <span class="comment">// never added to either.</span>
03625     <span class="comment">//</span>
03626 
03627     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a52">MmAllocatedNonPagedPool</a> -= SizeInPages;
03628     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a52">NonPagedPoolDescriptor</a>.<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o8">TotalBigPages</a> -= (ULONG)SizeInPages;
03629 
03630     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql2);
03631 
03632     <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (StartPte, (ULONG)SizeInPages, SystemPteSpace);
03633 
03634     <a class="code" href="../../d5/d8/ex_8h.html#a227">ExUnlockPool</a> (NonPagedPool, OldIrql);
03635 
03636     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a80">ExRemovePoolTag</a> (Tag,
03637                      BaseAddress,
03638                      SizeInPages &lt;&lt; PAGE_SHIFT);
03639 
03640     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03641 }
03642 
03643 LOGICAL
03644 MiCheckPhysicalPagePattern (
03645     IN PFN_NUMBER PageFrameIndex,
03646     IN OUT PULONG CorruptionOffset OPTIONAL
03647     )
03648 
03649 <span class="comment">/*++</span>
03650 <span class="comment"></span>
03651 <span class="comment">Routine Description:</span>
03652 <span class="comment"></span>
03653 <span class="comment">    This is a special function called only from the kernel debugger</span>
03654 <span class="comment">    to check that the physical memory below 4Gb removed with /NOLOWMEM</span>
03655 <span class="comment">    contains the expected fill patterns.  If not, there is a high</span>
03656 <span class="comment">    probability that a driver which cannot handle physical addresses greater</span>
03657 <span class="comment">    than 32 bits corrupted the memory.</span>
03658 <span class="comment"></span>
03659 <span class="comment">Arguments:</span>
03660 <span class="comment"></span>
03661 <span class="comment">    PageFrameIndex - Supplies the physical page number to check.</span>
03662 <span class="comment">    </span>
03663 <span class="comment">    CorruptionOffset - If non-NULL and corruption is found, the byte offset</span>
03664 <span class="comment">                       of the corruption start is returned here.</span>
03665 <span class="comment"></span>
03666 <span class="comment">Return Value:</span>
03667 <span class="comment"></span>
03668 <span class="comment">    TRUE if the page was removed and the fill pattern is correct, or</span>
03669 <span class="comment">    if the page was never removed.  FALSE if corruption was detected</span>
03670 <span class="comment">    in the page.</span>
03671 <span class="comment"></span>
03672 <span class="comment">Environment:</span>
03673 <span class="comment"></span>
03674 <span class="comment">    This routine is for use of the kernel debugger ONLY, specifically</span>
03675 <span class="comment">    the !chklowmem command.</span>
03676 <span class="comment"></span>
03677 <span class="comment">    The debugger's PTE will be repointed.</span>
03678 <span class="comment">    </span>
03679 <span class="comment">--*/</span>
03680 
03681 {
03682     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn;
03683     PULONG Va;
03684     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
03685     PHYSICAL_ADDRESS Pa;
03686 
03687     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiNoLowMemory);
03688 
03689     <span class="keywordflow">if</span> (MiLowMemoryBitMap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03690         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03691     }
03692 
03693     <span class="comment">//</span>
03694     <span class="comment">// Verify that the page to be verified is one of the reclaimed</span>
03695     <span class="comment">// pages.</span>
03696     <span class="comment">//</span>
03697 
03698     <span class="keywordflow">if</span> ((PageFrameIndex &gt;= MiLowMemoryBitMap-&gt;SizeOfBitMap) ||
03699         (RtlCheckBit (MiLowMemoryBitMap, PageFrameIndex) == 0)) {
03700 
03701         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03702     }
03703 
03704     <span class="comment">//</span>
03705     <span class="comment">// At this point we have a low page that is not in active use.</span>
03706     <span class="comment">// The fill pattern must match.</span>
03707     <span class="comment">//</span>
03708 
03709 <span class="preprocessor">#if DBG</span>
03710 <span class="preprocessor"></span>    Pfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03711     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> == MI_MAGIC_4GB_RECLAIM);
03712     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == ActiveAndValid);
03713 <span class="preprocessor">#endif</span>
03714 <span class="preprocessor"></span>
03715     <span class="comment">//</span>
03716     <span class="comment">// Map the physical page using the debug PTE so the</span>
03717     <span class="comment">// fill pattern can be validated.</span>
03718     <span class="comment">//</span>
03719     <span class="comment">// The debugger cannot be using this virtual address on entry or exit.</span>
03720     <span class="comment">// This mapping really should have been done in the kernel debugger source</span>
03721     <span class="comment">// NOT in the memory management sources.</span>
03722     <span class="comment">//</span>
03723 
03724     Pa.QuadPart = ((ULONGLONG)PageFrameIndex) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03725 
03726     Va = (PULONG) <a class="code" href="../../d2/d6/ia64_2debugsup_8c.html#a3">MmDbgTranslatePhysicalAddress64</a> (Pa);
03727 
03728     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span>(ULONG); <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
03729 
03730         <span class="keywordflow">if</span> (*Va != (PageFrameIndex | <a class="code" href="../../d1/d2/mm_2i386_2init386_8c.html#a3">MI_LOWMEM_MAGIC_BIT</a>)) {
03731 
03732             <span class="keywordflow">if</span> (CorruptionOffset != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03733                 *CorruptionOffset = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> * <span class="keyword">sizeof</span>(ULONG);
03734             }
03735         
03736             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03737         }
03738 
03739         Va += 1;
03740     }
03741 
03742     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03743 }
03744 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:22 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
