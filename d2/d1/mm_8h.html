<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mm.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mm.h File Reference</h1>
<p>
<a href="../../d3/d0/mm_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">_PHYSICAL_MEMORY_RUN</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">_PHYSICAL_MEMORY_DESCRIPTOR</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d2/struct__MMINFO__COUNTERS.html">_MMINFO_COUNTERS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/struct__MMPFNLIST.html">_MMPFNLIST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">_PHYSICAL_MEMORY_RANGE</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a0">MAX_PHYSICAL_MEMORY_FRAGMENTS</a>&nbsp;&nbsp;&nbsp;20</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a1">MM_ALLOCATION_GRANULARITY</a>&nbsp;&nbsp;&nbsp;((ULONG)0x10000)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a2">MM_MAXIMUM_READ_CLUSTER_SIZE</a>&nbsp;&nbsp;&nbsp;(15)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a3">MM_MAXIMUM_DISK_IO_SIZE</a>&nbsp;&nbsp;&nbsp;(0x10000)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)&nbsp;&nbsp;&nbsp;(((ULONG_PTR)(<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>) + PAGE_SIZE - 1) &amp; ~(PAGE_SIZE - 1))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(Va)&nbsp;&nbsp;&nbsp;((ULONG)((LONG_PTR)(Va) &amp; (PAGE_SIZE - 1)))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(Va)&nbsp;&nbsp;&nbsp;((PVOID)((ULONG_PTR)(Va) &amp; ~(PAGE_SIZE - 1)))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>(Va, <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a>(Va, <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)&nbsp;&nbsp;&nbsp;((ULONG)((((ULONG_PTR)(Va) &amp; (PAGE_SIZE -1)) + (<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>) + (PAGE_SIZE - 1)) &gt;&gt; PAGE_SHIFT))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a10">IS_SYSTEM_ADDRESS</a>(VA)&nbsp;&nbsp;&nbsp;((VA) &gt;= MM_SYSTEM_RANGE_START)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a11">MmGetMdlPfnArray</a>(Mdl)&nbsp;&nbsp;&nbsp;((PPFN_NUMBER)(Mdl + 1))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a12">MmGetMdlVirtualAddress</a>(Mdl)&nbsp;&nbsp;&nbsp;((PVOID) ((PCHAR) ((Mdl)-&gt;StartVa) + (Mdl)-&gt;ByteOffset))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a13">MmGetMdlByteCount</a>(Mdl)&nbsp;&nbsp;&nbsp;((Mdl)-&gt;ByteCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a14">MmGetMdlByteOffset</a>(Mdl)&nbsp;&nbsp;&nbsp;((Mdl)-&gt;ByteOffset)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a15">MmGetMdlBaseVa</a>(Mdl)&nbsp;&nbsp;&nbsp;((Mdl)-&gt;StartVa)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a16">MmIsRecursiveIoFault</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a17">MmDisablePageFaultClustering</a>(SavedState)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a18">MmEnablePageFaultClustering</a>(SavedState)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a19">MmSavePageFaultReadAhead</a>(Thread, SavedState)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a20">MmSetPageFaultReadAhead</a>(Thread, ReadAhead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a21">MmResetPageFaultReadAhead</a>(Thread, SavedState)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a22">NUMBER_OF_PAGE_LISTS</a>&nbsp;&nbsp;&nbsp;8</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a23">MmEnoughMemoryForWrite</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a>(MemoryDescriptorList, BaseVa, Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a25">MmGetSystemAddressForMdlSafe</a>(<a class="el" href="../../d6/d7/struct__MDL.html">MDL</a>, PRIORITY)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a26">MmGetSystemAddressForMdl</a>(<a class="el" href="../../d6/d7/struct__MDL.html">MDL</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a27">MmPrepareMdlForReuse</a>(<a class="el" href="../../d6/d7/struct__MDL.html">MDL</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a28">MMNONPAGED_QUOTA_INCREASE</a>&nbsp;&nbsp;&nbsp;(64*1024)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a29">MMPAGED_QUOTA_INCREASE</a>&nbsp;&nbsp;&nbsp;(512*1024)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a30">MMNONPAGED_QUOTA_CHECK</a>&nbsp;&nbsp;&nbsp;(256*1024)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a31">MMPAGED_QUOTA_CHECK</a>&nbsp;&nbsp;&nbsp;(4*1024*1024)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a32">PERFINFO_ADDPOOLPAGE</a>(CheckType, PoolIndex, Addr, PoolDesc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a33">PERFINFO_ADDTOWS</a>(PageFrame, Address, Pid)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a34">PERFINFO_BIGPOOLALLOC</a>(Type, PTag, NumBytes, Addr)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a35">PERFINFO_CM_CHECKCELLTYPE</a>(Map)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a36">PERFINFO_CM_CHECKCELLTYPE</a>(Map)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a37">PERFINFO_CM_HIVECELL_REFERENCE_FLAT</a>(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, pcell, <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a38">PERFINFO_CM_HIVECELL_REFERENCE_PAGED</a>(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, pcell, <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, Type, Map)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a39">PERFINFO_CONVERT_TO_GUI_THREAD</a>(EThread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a40">PERFINFO_DECREFCNT</a>(PageFrame, Flag, Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a41">PERFINFO_DELETE_STACK</a>(PointerPte, NumberOfPtes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a42">PERFINFO_DISPATCHFAULT_DECL</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a43">PERFINFO_DRIVER_COMPLETIONROUTINE_CALL</a>(irp, irpsp)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a44">PERFINFO_DRIVER_COMPLETIONROUTINE_RETURN</a>(irp, irpsp)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a45">PERFINFO_DRIVER_INIT</a>(pdo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a46">PERFINFO_DRIVER_INIT_COMPLETE</a>(pdo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a47">PERFINFO_DRIVER_MAJORFUNCTION_CALL</a>(irp, irpsp, pdo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a48">PERFINFO_DRIVER_MAJORFUNCTION_RETURN</a>(irp, irpsp, pdo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a49">PERFINFO_EXALLOCATEPOOLWITHTAG_DECL</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a50">PERFINFO_EXFREEPOOLWITHTAG_DECL</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a51">PERFINFO_FREEPOOL</a>(Addr)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a52">PERFINFO_FREEPOOLPAGE</a>(CheckType, PoolIndex, Addr, PoolDesc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a53">PERFINFO_GET_PAGE_INFO</a>(PointerPte)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a54">PERFINFO_GET_PAGE_INFO_REPLACEMENT</a>(PointerPte)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a55">PERFINFO_GET_PAGE_INFO_WITH_DECL</a>(PointerPte)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a56">PERFINFO_GROW_STACK</a>(EThread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a57">PERFINFO_HARDFAULT</a>(Address, InpageSupport)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a58">PERFINFO_HARDFAULT_INFO</a>(ProtoPte)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a59">PERFINFO_HARDFAULT_IOTIME</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a60">PERFINFO_HIVECELL_REFERENCE_FLAT</a>(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, pcell, <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a61">PERFINFO_HIVECELL_REFERENCE_PAGED</a>(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, pcell, <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>, Type, Map)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a62">PERFINFO_IMAGE_LOAD</a>(LdrDataTableEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a63">PERFINFO_IMAGE_UNLOAD</a>(Address)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a64">PERFINFO_INIT_POOLRANGE</a>(PoolStart, PoolPages)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a65">PERFINFO_INIT_PERFMEMTABLE</a>(LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a66">PERFINFO_INIT_TRACEFLAGS</a>(OptionString, SpecificOption)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a67">PERFINFO_INSERTINLIST</a>(Page, ListHead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a68">PERFINFO_INSERT_FRONT_STANDBY</a>(Page)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a69">PERFINFO_LOG_MARK</a>(PMARK)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a70">PERFINFO_LOG_MARK_SPRINTF</a>(PMARK, VARIABLE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a71">PERFINFO_LOG_WMI_TRACE_EVENT</a>(PData, xLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a72">PERFINFO_LOG_WMI_TRACE_KERNEL_EVENT</a>(GroupType, PData, xLength, Thread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a73">PERFINFO_LOG_WMI_TRACE_LONG_EVENT</a>(GroupType, PData, xCount, Thread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a74">PERFINFO_LOG_WS_REMOVAL</a>(Type, WsInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a75">PERFINFO_LOG_WS_REPLACEMENT</a>(WsInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a76">PERFINFO_MIH_DECL</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a77">PERFINFO_MMINIT_DECL</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a78">PERFINFO_MMINIT_START</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a79">PERFINFO_MOD_PAGE_WRITER3</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a80">PERFINFO_PAGE_INFO_DECL</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a81">PERFINFO_PAGE_INFO_REPLACEMENT_DECL</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a82">PERFINFO_POOLALLOC</a>(Type, PTag, NumBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a83">PERFINFO_POOLALLOC_ADDR</a>(Addr)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a84">PERFINFO_POOL_ALLOC_COMMON</a>(Type, PTag, NumBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a85">PERFINFO_PRIVATE_COPY_ON_WRITE</a>(CopyFrom, PAGE_SIZE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a86">PERFINFO_PRIVATE_PAGE_DEMAND_ZERO</a>(VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a87">PERFINFO_PROCESS_CREATE</a>(EProcess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a88">PERFINFO_PROCESS_DELETE</a>(EProcess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a89">PERFINFO_DELETE_PAGE</a>(ppfn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a90">PERFINFO_REMOVEPAGE</a>(PageIndex, LogType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a91">PERFINFO_SECTION_CREATE</a>(ControlArea)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a92">PERFINFO_SEGMENT_DELETE</a>(<a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a93">PERFINFO_SOFTFAULT</a>(PageFrame, Address, Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a94">PERFINFO_THREAD_CREATE</a>(EThread, ITeb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a95">PERFINFO_THREAD_DELETE</a>(EThread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a96">PERFINFO_UNLINKFREEPAGE</a>(<a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, Location)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a97">PERFINFO_UNLINKPAGE</a>(<a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>, Location)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a98">PERFINFO_WSMANAGE_ACTUALTRIM</a>(Trim)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a99">PERFINFO_WSMANAGE_DECL</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a100">PERFINFO_WSMANAGE_DUMPENTRIES</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a101">PERFINFO_WSMANAGE_DUMPENTRIES_CLAIMS</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a102">PERFINFO_WSMANAGE_DUMPENTRIES_FAULTS</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a103">PERFINFO_WSMANAGE_DUMPWS</a>(VmSupport, SampledAgeCounts)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a104">PERFINFO_WSMANAGE_FINALACTION</a>(TrimAction)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a105">PERFINFO_WSMANAGE_GLOBAL_DECL</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a106">PERFINFO_WSMANAGE_LOGINFO_CLAIMS</a>(TrimAction)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a107">PERFINFO_WSMANAGE_LOGINFO_FAULTS</a>(TrimAction)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a108">PERFINFO_WSMANAGE_PROCESS_RESET</a>(VmSupport)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a109">PERFINFO_WSMANAGE_PROCESS_RESET</a>(VmSupport)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a110">PERFINFO_WSMANAGE_STARTLOG</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a111">PERFINFO_WSMANAGE_STARTLOG_CLAIMS</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a112">PERFINFO_WSMANAGE_STARTLOG_FAULTS</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a113">PERFINFO_WSMANAGE_TOTRIM</a>(Trim)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a114">PERFINFO_WSMANAGE_TRIMACTION</a>(TrimAction)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a115">PERFINFO_WSMANAGE_TRIMEND_CLAIMS</a>(Criteria)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a116">PERFINFO_WSMANAGE_TRIMEND_FAULTS</a>(Criteria)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a117">PERFINFO_WSMANAGE_TRIMWS</a>(Process, SessionSpace, VmSupport)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a118">PERFINFO_WSMANAGE_TRIMWS_CLAIMINFO</a>(VmSupport)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a119">PERFINFO_WSMANAGE_TRIMWS_CLAIMINFO</a>(VmSupport)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a120">PERFINFO_WSMANAGE_WAITFORWRITER_CLAIMS</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a121">PERFINFO_WSMANAGE_WAITFORWRITER_FAULTS</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a122">PERFINFO_WSMANAGE_WILLTRIM</a>(ReductionGoal, FreeGoal)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a123">PERFINFO_WSMANAGE_WILLTRIM_CLAIMS</a>(Criteria)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a124">PERFINFO_WSMANAGE_WILLTRIM_FAULTS</a>(Criteria)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a125">PERFINFO_DO_PAGEFAULT_CLUSTERING</a>()&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">_PHYSICAL_MEMORY_RUN</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a127">PHYSICAL_MEMORY_RUN</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">_PHYSICAL_MEMORY_RUN</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a128">PPHYSICAL_MEMORY_RUN</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">_PHYSICAL_MEMORY_DESCRIPTOR</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a129">PHYSICAL_MEMORY_DESCRIPTOR</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">_PHYSICAL_MEMORY_DESCRIPTOR</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a130">PPHYSICAL_MEMORY_DESCRIPTOR</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d2/d1/mm_8h.html#a343">_MM_SYSTEM_SIZE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d2/d1/mm_8h.html#a344">_LOCK_OPERATION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d2/struct__MMINFO__COUNTERS.html">_MMINFO_COUNTERS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a143">MMINFO_COUNTERS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d3/d2/struct__MMINFO__COUNTERS.html">MMINFO_COUNTERS</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a144">PMMINFO_COUNTERS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef NTSTATUS(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a146">PKWIN32_CALLOUT</a> )(IN PVOID Arg)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d2/d1/mm_8h.html#a345">_MMLISTS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a147">MMLISTS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d4/struct__MMPFNLIST.html">_MMPFNLIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a148">MMPFNLIST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d4/struct__MMPFNLIST.html">MMPFNLIST</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a149">PMMPFNLIST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d2/d1/mm_8h.html#a346">_MMFLUSH_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a153">MMFLUSH_TYPE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d2/d1/mm_8h.html#a347">_MM_PAGE_PRIORITY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a154">MM_PAGE_PRIORITY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">_PHYSICAL_MEMORY_RANGE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a155">PHYSICAL_MEMORY_RANGE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">_PHYSICAL_MEMORY_RANGE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a156">PPHYSICAL_MEMORY_RANGE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef NTSTATUS(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a157">PMM_DLL_INITIALIZE</a> )(IN PUNICODE_STRING RegistryPath)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef NTSTATUS(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a158">PMM_DLL_UNLOAD</a> )(VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef VOID(*&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a162">PBANKED_SECTION_ROUTINE</a> )(IN ULONG ReadBank, IN ULONG WriteBank, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef VOID(FASTCALL *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a163">PPAGE_FAULT_NOTIFY_ROUTINE</a> )(IN NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>, IN PVOID VirtualAddress, IN PVOID TrapInformation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef VOID(FASTCALL *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a164">PHARD_FAULT_NOTIFY_ROUTINE</a> )(IN HANDLE FileObject, IN PVOID VirtualAddress)</td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a343">_MM_SYSTEM_SIZE</a> { <a class="el" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>, 
<a class="el" href="../../d2/d1/mm_8h.html#a343a166">MmMediumSystem</a>, 
<a class="el" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a>
 }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a344">_LOCK_OPERATION</a> { <a class="el" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>, 
<a class="el" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a>, 
<a class="el" href="../../d2/d1/mm_8h.html#a344a170">IoModifyAccess</a>
 }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a345">_MMLISTS</a> { <br>
&nbsp;&nbsp;<a class="el" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>, 
<a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, 
<a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, 
<a class="el" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="../../d2/d1/mm_8h.html#a345a175">ModifiedNoWritePageList</a>, 
<a class="el" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>, 
<a class="el" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>, 
<a class="el" href="../../d2/d1/mm_8h.html#a345a178">TransitionPage</a>
<br>
 }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a346">_MMFLUSH_TYPE</a> { <a class="el" href="../../d2/d1/mm_8h.html#a346a179">MmFlushForDelete</a>, 
<a class="el" href="../../d2/d1/mm_8h.html#a346a180">MmFlushForWrite</a>
 }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a347">_MM_PAGE_PRIORITY</a> { <a class="el" href="../../d2/d1/mm_8h.html#a347a181">LowPagePriority</a>, 
<a class="el" href="../../d2/d1/mm_8h.html#a347a182">NormalPagePriority</a> =  16, 
<a class="el" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a> =  32
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI <a class="el" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a184">MmQuerySystemSize</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a185">MmIsThisAnNtAsSystem</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a186">MmInitSystem</a> (IN ULONG Phase, IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock, IN <a class="el" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> PhysicalMemoryBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a187">MmInitializeMemoryLimits</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock, IN PBOOLEAN IncludedType, OUT <a class="el" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> Memory)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a188">MmFreeLoaderBlock</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a189">MmEnablePAT</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a190">MmAllocateIndependentPages</a> (IN SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a191">MmSetPageProtection</a> (IN PVOID VirtualAddress, IN SIZE_T NumberOfBytes, IN ULONG NewProtect)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a192">MmShutdownSystem</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a193">MmAssignProcessToJob</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a194">MmEnforceWorkingSetLimit</a> (IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo, IN LOGICAL Enable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a195">MmSessionCreate</a> (OUT PULONG SessionId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a196">MmSessionDelete</a> (IN ULONG SessionId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a> (IN <a class="el" href="../../d2/d1/mm_8h.html#a146">PKWIN32_CALLOUT</a> Function, IN <a class="el" href="../../d2/d1/mm_8h.html#a146">PKWIN32_CALLOUT</a> WorkerCallback OPTIONAL, IN PVOID Arg, IN PULONG SessionId OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a198">MmSessionLeader</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a199">MmSessionSetUnloadAddress</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> pWin32KDevice)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a200">MmResourcesAvailable</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN SIZE_T NumberOfBytes, IN <a class="el" href="../../d5/d8/ex_8h.html#a97">EX_POOL_PRIORITY</a> Priority)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a201">MiAllocatePoolPages</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN SIZE_T SizeInBytes, IN ULONG IsLargeSessionAllocation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a202">MiFreePoolPages</a> (IN PVOID StartingAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a203">MiSessionPoolVector</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a204">MiSessionPoolAllocated</a> (IN PVOID VirtualAddress, IN SIZE_T NumberOfBytes, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a205">MiSessionPoolFreed</a> (IN PVOID VirtualAddress, IN SIZE_T NumberOfBytes, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a206">MmDeterminePoolType</a> (IN PVOID VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a207">MmIsSystemAddressLocked</a> (IN PVOID VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a208">MmAccessFault</a> (IN BOOLEAN StoreInstruction, IN PVOID VirtualAddress, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, IN PVOID TrapInformation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a209">MmCreateProcessAddressSpace</a> (IN ULONG MinimumWorkingSetSize, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> NewProcess, OUT PULONG_PTR DirectoryTableBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a210">MmInitializeProcessAddressSpace</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToInitialize, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToClone OPTIONAL, IN PVOID SectionToMap OPTIONAL, OUT PUNICODE_STRING *AuditName OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a211">MmDeleteProcessAddressSpace</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a212">MmCleanProcessAddressSpace</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a213">MmCleanUserProcessAddressSpace</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a214">MmCleanVirtualAddressDescriptor</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a215">MmCreateKernelStack</a> (BOOLEAN LargeStack)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a216">MmDeleteKernelStack</a> (IN PVOID PointerKernelStack, IN BOOLEAN LargeStack)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a217">MmGrowKernelStack</a> (IN PVOID CurrentStack)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a218">MmOutPageKernelStack</a> (IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a219">MmInPageKernelStack</a> (IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a220">MmOutSwapProcess</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a221">MmInSwapProcess</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PTEB&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a222">MmCreateTeb</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess, IN PINITIAL_TEB <a class="el" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>, IN PCLIENT_ID ClientId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PPEB&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a223">MmCreatePeb</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess, IN <a class="el" href="../../d2/d2/struct__INITIAL__PEB.html">PINITIAL_PEB</a> InitialPeb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a224">MmDeleteTeb</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess, IN PVOID TebBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a225">MmAllowWorkingSetExpansion</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a226">MmAdjustWorkingSetSize</a> (IN SIZE_T WorkingSetMinimum, IN SIZE_T WorkingSetMaximum, IN ULONG SystemCache)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a227">MmAdjustPageFileQuota</a> (IN ULONG NewPageFileQuota)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a228">MmWorkingSetManager</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a229">MmSetMemoryPriorityProcess</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN UCHAR MemoryPriority)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a230">MmLoadSystemImage</a> (IN PUNICODE_STRING ImageFileName, IN PUNICODE_STRING NamePrefix OPTIONAL, IN PUNICODE_STRING LoadedBaseName OPTIONAL, IN BOOLEAN LoadInSessionSpace, OUT PVOID *Section, OUT PVOID *ImageBaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a231">MmLoadAndLockSystemImage</a> (IN PUNICODE_STRING ImageFileName, IN PUNICODE_STRING NamePrefix OPTIONAL, IN PUNICODE_STRING LoadedBaseName OPTIONAL, OUT PVOID *Section, OUT PVOID *ImageBaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a232">MmFreeDriverInitialization</a> (IN PVOID Section)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a233">MmUnloadSystemImage</a> (IN PVOID Section)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a234">MmMakeKernelResourceSectionWritable</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a235">VerifierFreeTrackedPool</a> (IN PVOID VirtualAddress, IN SIZE_T ChargedBytes, IN LOGICAL CheckType, IN LOGICAL SpecialPool)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a236">MmSizeOfTriageInformation</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a237">MmSizeOfUnloadedDriverInformation</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a238">MmWriteTriageInformation</a> (IN PVOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a239">MmWriteUnloadedDriverInformation</a> (IN PVOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a240">MmCreateSection</a> (OUT PVOID *SectionObject, IN ACCESS_MASK DesiredAccess, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a> OPTIONAL, IN PLARGE_INTEGER MaximumSize, IN ULONG SectionPageProtection, IN ULONG AllocationAttributes, IN HANDLE FileHandle OPTIONAL, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> <a class="el" href="../../d1/d9/icmui_8def.html#a0">File</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a241">MmMapViewOfSection</a> (IN PVOID SectionToMap, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN OUT PVOID *CapturedBase, IN ULONG_PTR ZeroBits, IN SIZE_T CommitSize, IN OUT PLARGE_INTEGER SectionOffset, IN OUT PSIZE_T CapturedViewSize, IN SECTION_INHERIT InheritDisposition, IN ULONG AllocationType, IN ULONG Protect)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a242">MmUnmapViewOfSection</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID BaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a243">MmForceSectionClosed</a> (IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a> SectionObjectPointer, IN BOOLEAN DelayClose)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a244">MmGetFileNameForSection</a> (IN HANDLE Section, OUT PSTRING <a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a245">MmAddVerifierThunks</a> (IN PVOID ThunkBuffer, IN ULONG ThunkBufferSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a246">MmSetVerifierInformation</a> (IN OUT PVOID SystemInformation, IN ULONG SystemInformationLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a247">MmGetVerifierInformation</a> (OUT PVOID SystemInformation, IN ULONG SystemInformationLength, OUT PULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a248">MmGetPageFileInformation</a> (OUT PVOID SystemInformation, IN ULONG SystemInformationLength, OUT PULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a249">MmExtendSection</a> (IN PVOID SectionToExtend, IN OUT PLARGE_INTEGER NewSectionSize, IN ULONG IgnoreFileSizeChecking)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a250">MmFlushVirtualMemory</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN OUT PVOID *BaseAddress, IN OUT PSIZE_T RegionSize, OUT PIO_STATUS_BLOCK IoStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a251">MmMapViewInSystemCache</a> (IN PVOID SectionToMap, OUT PVOID *CapturedBase, IN OUT PLARGE_INTEGER SectionOffset, IN OUT PULONG CapturedViewSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a252">MmUnmapViewInSystemCache</a> (IN PVOID BaseAddress, IN PVOID SectionToUnmap, IN ULONG AddToFront)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a253">MmPurgeSection</a> (IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a> SectionObjectPointer, IN PLARGE_INTEGER <a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> OPTIONAL, IN SIZE_T RegionSize, IN ULONG IgnoreCacheViews)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a254">MmFlushSection</a> (IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a> SectionObjectPointer, IN PLARGE_INTEGER <a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> OPTIONAL, IN SIZE_T RegionSize, OUT PIO_STATUS_BLOCK IoStatus, IN ULONG AcquireFile)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a255">MmGetCrashDumpInformation</a> (IN PSYSTEM_CRASH_DUMP_INFORMATION CrashInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a256">MmGetCrashDumpStateInformation</a> (IN PSYSTEM_CRASH_STATE_INFORMATION CrashInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a257">MmFlushImageSection</a> (IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a> SectionObjectPointer, IN <a class="el" href="../../d2/d1/mm_8h.html#a153">MMFLUSH_TYPE</a> FlushType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a258">MmCanFileBeTruncated</a> (IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a> SectionPointer, IN PLARGE_INTEGER NewFileSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a259">MmDisableModifiedWriteOfSection</a> (IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a> SectionObjectPointer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a260">MmPurgeWorkingSet</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID BaseAddress, IN SIZE_T RegionSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a261">MmSetAddressRangeModified</a> (IN PVOID Address, IN SIZE_T Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a262">MmCheckCachedPageState</a> (IN PVOID Address, IN BOOLEAN SetToZero)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a263">MmCopyToCachedPage</a> (IN PVOID Address, IN PVOID UserBuffer, IN ULONG <a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, IN SIZE_T CountInBytes, IN BOOLEAN DontZero)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a264">MmUnlockCachedPage</a> (IN PVOID AddressInCache)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a265">MmDbgReadCheck</a> (IN PVOID VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a266">MmDbgWriteCheck</a> (IN PVOID VirtualAddress, IN PHARDWARE_PTE Opaque)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a267">MmDbgReleaseAddress</a> (IN PVOID VirtualAddress, IN PHARDWARE_PTE Opaque)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID64&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a268">MmDbgReadCheck64</a> (IN PVOID64 VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID64&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a269">MmDbgWriteCheck64</a> (IN PVOID64 VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID64&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a270">MmDbgTranslatePhysicalAddress64</a> (IN PHYSICAL_ADDRESS PhysicalAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a271">MmHibernateInformation</a> (IN PVOID MemoryMap, OUT PULONG_PTR HiberVa, OUT PPHYSICAL_ADDRESS HiberPte)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a272">MmProbeAndLockProcessPages</a> (IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN <a class="el" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a> Operation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a273">MmProbeAndLockPages</a> (IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN <a class="el" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a> Operation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a274">MmUnlockPages</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a275">MmBuildMdlForNonPagedPool</a> (IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a276">MmMapLockedPages</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a277">MmGetSystemRoutineAddress</a> (IN PUNICODE_STRING SystemRoutineName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a278">MmMapUserAddressesToPage</a> (IN PVOID BaseAddress, IN SIZE_T NumberOfBytes, IN PVOID PageAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a279">MmMapLockedPagesSpecifyCache</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a> CacheType, IN PVOID BaseAddress, IN ULONG BugCheckOnFailure, IN <a class="el" href="../../d2/d1/mm_8h.html#a154">MM_PAGE_PRIORITY</a> Priority)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a280">MmUnmapLockedPages</a> (IN PVOID BaseAddress, IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a281">MmAddPhysicalMemory</a> (IN PPHYSICAL_ADDRESS StartAddress, IN OUT PLARGE_INTEGER NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a282">MmRemovePhysicalMemory</a> (IN PPHYSICAL_ADDRESS StartAddress, IN OUT PLARGE_INTEGER NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI <a class="el" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">PPHYSICAL_MEMORY_RANGE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a283">MmGetPhysicalMemoryRanges</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a284">MmAllocatePagesForMdl</a> (IN PHYSICAL_ADDRESS LowAddress, IN PHYSICAL_ADDRESS HighAddress, IN PHYSICAL_ADDRESS SkipBytes, IN SIZE_T TotalBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a285">MmFreePagesFromMdl</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a286">MmMapIoSpace</a> (IN PHYSICAL_ADDRESS PhysicalAddress, IN SIZE_T NumberOfBytes, IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a> CacheType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a287">MmUnmapIoSpace</a> (IN PVOID BaseAddress, IN SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a288">MmProbeAndLockSelectedPages</a> (IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList, IN PFILE_SEGMENT_ELEMENT SegmentArray, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN <a class="el" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a> Operation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a289">MmMapVideoDisplay</a> (IN PHYSICAL_ADDRESS PhysicalAddress, IN SIZE_T NumberOfBytes, IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a> CacheType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a290">MmUnmapVideoDisplay</a> (IN PVOID BaseAddress, IN SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI PHYSICAL_ADDRESS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a291">MmGetPhysicalAddress</a> (IN PVOID BaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a292">MmGetVirtualForPhysical</a> (IN PHYSICAL_ADDRESS PhysicalAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a293">MmAllocateContiguousMemory</a> (IN SIZE_T NumberOfBytes, IN PHYSICAL_ADDRESS HighestAcceptableAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a294">MmAllocateContiguousMemorySpecifyCache</a> (IN SIZE_T NumberOfBytes, IN PHYSICAL_ADDRESS LowestAcceptableAddress, IN PHYSICAL_ADDRESS HighestAcceptableAddress, IN PHYSICAL_ADDRESS BoundaryAddressMultiple OPTIONAL, IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a> CacheType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a295">MmFreeContiguousMemory</a> (IN PVOID BaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a296">MmFreeContiguousMemorySpecifyCache</a> (IN PVOID BaseAddress, IN SIZE_T NumberOfBytes, IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a> CacheType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a297">MmGatherMemoryForHibernate</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl, IN BOOLEAN Wait)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a298">MmReturnMemoryForHibernate</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a299">MmReleaseDumpAddresses</a> (IN PFN_NUMBER Pages)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a300">MmAllocateNonCachedMemory</a> (IN SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a301">MmFreeNonCachedMemory</a> (IN PVOID BaseAddress, IN SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a302">MmIsAddressValid</a> (IN PVOID VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a303">MmIsNonPagedSystemAddressValid</a> (IN PVOID VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a304">MmSizeOfMdl</a> (IN PVOID Base, IN SIZE_T Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a305">MmCreateMdl</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList OPTIONAL, IN PVOID Base, IN SIZE_T Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a306">MmLockPagableDataSection</a> (IN PVOID AddressWithinSection)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a307">MmLockPagableSectionByHandle</a> (IN PVOID ImageSectionHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a308">MmLockPagedPool</a> (IN PVOID Address, IN SIZE_T <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a309">MmUnlockPagedPool</a> (IN PVOID Address, IN SIZE_T <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a310">MmResetDriverPaging</a> (IN PVOID AddressWithinSection)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a311">MmPageEntireDriver</a> (IN PVOID AddressWithinSection)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a312">MmUnlockPagableImageSection</a> (IN PVOID ImageSectionHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a313">MmSecureVirtualMemory</a> (IN PVOID Address, IN SIZE_T <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>, IN ULONG ProbeMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a314">MmUnsecureVirtualMemory</a> (IN HANDLE SecureHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a315">MmMapViewInSystemSpace</a> (IN PVOID Section, OUT PVOID *MappedBase, IN PSIZE_T ViewSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a316">MmUnmapViewInSystemSpace</a> (IN PVOID MappedBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a317">MmMapViewInSessionSpace</a> (IN PVOID Section, OUT PVOID *MappedBase, IN OUT PSIZE_T ViewSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a318">MmUnmapViewInSessionSpace</a> (IN PVOID MappedBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a319">MmAllocateSpecialPool</a> (IN SIZE_T NumberOfBytes, IN ULONG Tag, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> Type, IN ULONG SpecialPoolType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a320">MmFreeSpecialPool</a> (IN PVOID P)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a321">MmSetSpecialPool</a> (IN LOGICAL Enable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a322">MmProtectSpecialPool</a> (IN PVOID VirtualAddress, IN ULONG NewProtect)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a323">MmIsSpecialPoolAddressFree</a> (IN PVOID VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a324">MmQuerySpecialPoolBlockSize</a> (IN PVOID P)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a325">MmIsHydraAddress</a> (IN PVOID VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PUNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a326">MmLocateUnloadedDriver</a> (IN PVOID VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a327">MmIsDriverVerifying</a> (IN struct <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">_DRIVER_OBJECT</a> *DriverObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a328">MmTrimAllSystemPagableMemory</a> (IN LOGICAL PurgeTransition)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a329">MmRaisePoolQuota</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN SIZE_T OldQuotaLimit, OUT PSIZE_T NewQuotaLimit)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a330">MmReturnPoolQuota</a> (IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN SIZE_T ReturnedQuota)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a331">MmZeroPageThread</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a332">MmCopyVirtualMemory</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> FromProcess, IN PVOID FromAddress, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ToProcess, OUT PVOID ToAddress, IN ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, OUT PULONG NumberOfBytesCopied)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a333">MmGetSectionRange</a> (IN PVOID AddressWithinSection, OUT PVOID *StartingSectionAddress, OUT PULONG SizeofSection)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a334">MmMapMemoryDumpMdl</a> (IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDumpMdl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a335">MmSetBankedSection</a> (IN HANDLE ProcessHandle, IN PVOID VirtualAddress, IN ULONG BankLength, IN BOOLEAN ReadWriteBank, IN <a class="el" href="../../d2/d1/mm_8h.html#a162">PBANKED_SECTION_ROUTINE</a> BankRoutine, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a336">MmIsSystemAddressAccessable</a> (IN PVOID VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a337">MmVerifyImageIsOkForMpUse</a> (IN PVOID BaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a338">MmMemoryUsage</a> (IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>, IN ULONG Type, OUT PULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a339">MmSetPageFaultNotifyRoutine</a> (IN <a class="el" href="../../d2/d1/mm_8h.html#a163">PPAGE_FAULT_NOTIFY_ROUTINE</a> NotifyRoutine)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a340">MmSetHardFaultNotifyRoutine</a> (IN <a class="el" href="../../d2/d1/mm_8h.html#a164">PHARD_FAULT_NOTIFY_ROUTINE</a> NotifyRoutine)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a341">MmCallDllInitialize</a> (IN PLDR_DATA_TABLE_ENTRY DataTableEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a342">MmSetKernelDumpRange</a> (IN PVOID DumpContext)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG_PTR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a132">Mm64BitPhysicalAddress</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a133">MmSectionObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a134">MmReadClusterSize</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a135">MmNumberOfColors</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_COUNT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_COUNT&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a137">MmSizeOfSystemCacheInPages</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__MMSUPPORT.html">MMSUPPORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a138">MmSystemCacheWs</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a139">MmWorkingSetManagerEvent</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a142">MmProductType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d2/struct__MMINFO__COUNTERS.html">MMINFO_COUNTERS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d4/struct__MMPFNLIST.html">MMPFNLIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_NUMBER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a151">MmThrottleTop</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_NUMBER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a152">MmThrottleBottom</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a159">MmSpecialPoolTag</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a160">MmSpecialPoolStart</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/mm_8h.html#a161">MmSpecialPoolEnd</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a8" doxytag="mm.h::ADDRESS_AND_SIZE_TO_SPAN_PAGES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ADDRESS_AND_SIZE_TO_SPAN_PAGES          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Va,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(((((<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) + \
   (((((ULONG)(<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>-1)&amp;(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>-1)) + (PtrToUlong(Va) &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> -1)))) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00217">217</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/largepag_8c-source.html#l00515">Ki386BuildIdentityBuffer()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l02188">MiCreatePageTablesForPhysicalRange()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l02361">MiDeletePageTablesForPhysicalRange()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05051">MmFreePagesFromMdl()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l08083">MmSetKernelDumpRange()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05815">MmSizeOfMdl()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l01347">MmUnlockPages()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="mm.h::BYTE_OFFSET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BYTE_OFFSET          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Va&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((ULONG)((LONG_PTR)(Va) &amp; (PAGE_SIZE - 1)))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">166</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03892">ExFreePoolSanityChecks()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01804">IoBuildPartialMdl()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03638">IopWriteToDisk()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02534">KdpReadPhysicalMemory()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02680">KdpWritePhysicalMemory()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l01424">MiCreateImageFileMap()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">MiGatherMappedPages()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l02335">MiWaitForInPageComplete()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00043">MmAddPhysicalMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03744">MmAllocateContiguousMemorySpecifyCache()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>, <a class="el" href="../../d4/d5/mips_2debugsup_8c-source.html#l00245">MmDbgTranslatePhysicalAddress()</a>, <a class="el" href="../../d2/d5/i386_2debugsup_8c-source.html#l00298">MmDbgTranslatePhysicalAddress64()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00668">MmFlushSection()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03742">MmFreeSpecialPool()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05490">MmGetPhysicalAddress()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05542">MmGetVirtualForPhysical()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03415">MmMapIoSpace()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07516">MmMapVideoDisplay()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01548">MmPurgeSection()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l01614">ViPostPoolAllocation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="mm.h::BYTES_TO_PAGES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BYTES_TO_PAGES          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>((ULONG)((ULONG_PTR)(<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) + \
                               (((ULONG)(<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) != 0))
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">141</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01893">ExInsertPoolTag()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04379">IopReadDumpRegistry()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04107">MiAllocateContiguousMemory()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00807">MiAllocatePoolPages()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02184">MiBuildPagedPool()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00519">MiCalculatePageCommitment()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l01424">MiCreateImageFileMap()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04018">MiCreatePagingFileMap()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04202">MiCreatePebOrTeb()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">MiGatherMappedPages()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00890">MiGetWorkingSetInfo()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02476">MiInitializeNonPagedPool()</a>, <a class="el" href="../../d2/d1/mm_2i386_2init386_8c-source.html#l00058">MiInitMachineDependent()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03268">MiMapViewInSystemSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l02256">MiMapViewOfDataSection()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00256">MiRemoveVad()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01881">MiSessionInitializeWorkingSetList()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00119">MiShareSessionImage()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l05633">MiWriteProtectSystemImage()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03942">MmAllocateIndependentPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05581">MmAllocateNonCachedMemory()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02450">MmCreateKernelStack()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02723">MmDeleteKernelStack()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05721">MmFreeNonCachedMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07197">MmMapMemoryDumpMdl()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01152">MmProbeAndLockSelectedPages()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00589">MmResourcesAvailable()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04027">MmSetPageProtection()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, and <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="mm.h::COMPUTE_PAGES_SPANNED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define COMPUTE_PAGES_SPANNED          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Va,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((ULONG)((((ULONG_PTR)(Va) &amp; (PAGE_SIZE -1)) + (<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>) + (PAGE_SIZE - 1)) &gt;&gt; PAGE_SHIFT))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">221</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/copysup_8c-source.html#l00031">CcCopyRead()</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l00588">CcFastCopyRead()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l05749">CcMapAndRead()</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00052">CcMapData()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00030">CcMdlRead()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l01633">CcPerformReadAhead()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l00054">FsRtlCopyRead()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00805">IoAllocateMdl()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01804">IoBuildPartialMdl()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00287">IopIsAddressRangeValid()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02081">IopMapPhysicalMemory()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03759">IopMapVirtualToPhysicalMdl()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00814">MiInitializeSystemCache()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02785">MiMapLockedPagesInUserSpace()</a>, <a class="el" href="../../d7/d1/mm_2ia64_2initia64_8c-source.html#l02042">MiSweepCacheMachineDependent()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03253">MiUnmapLockedPagesInUserSpace()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03415">MmMapIoSpace()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02058">MmMapLockedPagesSpecifyCache()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07516">MmMapVideoDisplay()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l08083">MmSetKernelDumpRange()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03678">MmUnmapIoSpace()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">MmUnmapLockedPages()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l07751">MmUnmapVideoDisplay()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="mm.h::IS_SYSTEM_ADDRESS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IS_SYSTEM_ADDRESS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VA&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((VA) &gt;= MM_SYSTEM_RANGE_START)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00248">248</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, and <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01296">xxxInterSendMsgEx()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="mm.h::MAX_PHYSICAL_MEMORY_FRAGMENTS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_PHYSICAL_MEMORY_FRAGMENTS&nbsp;&nbsp;&nbsp;20          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00031">31</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/report_8c-source.html#l00066">IopInitializeResourceMap()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l01899">MiMergeMemoryLimit()</a>, and <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="mm.h::MM_ALLOCATION_GRANULARITY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_ALLOCATION_GRANULARITY&nbsp;&nbsp;&nbsp;((ULONG)0x10000)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00054">54</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="mm.h::MM_MAXIMUM_DISK_IO_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_MAXIMUM_DISK_IO_SIZE&nbsp;&nbsp;&nbsp;(0x10000)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00091">91</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01014">MiFlushSectionInternal()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="mm.h::MM_MAXIMUM_READ_CLUSTER_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_MAXIMUM_READ_CLUSTER_SIZE&nbsp;&nbsp;&nbsp;(15)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00060">60</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01989">MiResolveMappedFileFault()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="mm.h::MmDisablePageFaultClustering" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MmDisablePageFaultClustering          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">SavedState&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                          \
                *(SavedState) = 2 + (ULONG)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;DisablePageFaultClustering;\
                <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;DisablePageFaultClustering = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; }
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00924">924</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00466">CcPrepareMdlWrite()</a>, and <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="mm.h::MmEnablePageFaultClustering" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MmEnablePageFaultClustering          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">SavedState&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                               \
                <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;DisablePageFaultClustering = (BOOLEAN)(SavedState - 2); }
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00953">953</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00466">CcPrepareMdlWrite()</a>, and <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="mm.h::MmEnoughMemoryForWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MmEnoughMemoryForWrite          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; <a class="code" href="../../d2/d1/mm_8h.html#a151">MmThrottleTop</a>)          \
                        ||                               \
             (((<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> &lt; 1000)) &amp;&amp; \
               (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; <a class="code" href="../../d2/d1/mm_8h.html#a152">MmThrottleBottom</a>)))
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01123">1123</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/copysup_8c-source.html#l01790">CcCanIWrite()</a>, and <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">MiGatherMappedPages()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="mm.h::MmGetMdlBaseVa" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MmGetMdlBaseVa          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Mdl&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((Mdl)-&gt;StartVa)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00373">373</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01804">IoBuildPartialMdl()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="mm.h::MmGetMdlByteCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MmGetMdlByteCount          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Mdl&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((Mdl)-&gt;ByteCount)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00324">324</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01804">IoBuildPartialMdl()</a>, <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02636">SmbTraceCopyMdlContiguous()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02603">SmbTraceMdlLength()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="mm.h::MmGetMdlByteOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MmGetMdlByteOffset          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Mdl&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((Mdl)-&gt;ByteOffset)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00348">348</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01804">IoBuildPartialMdl()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="mm.h::MmGetMdlPfnArray" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MmGetMdlPfnArray          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Mdl&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((PPFN_NUMBER)(Mdl + 1))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00275">275</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01804">IoBuildPartialMdl()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02081">IopMapPhysicalMemory()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03759">IopMapVirtualToPhysicalMdl()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03183">IopWritePageToDisk()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="mm.h::MmGetMdlVirtualAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MmGetMdlVirtualAddress          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Mdl&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((PVOID) ((PCHAR) ((Mdl)-&gt;StartVa) + (Mdl)-&gt;ByteOffset))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00299">299</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="mm.h::MmGetSystemAddressForMdl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MmGetSystemAddressForMdl          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d7/struct__MDL.html">MDL</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(((<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)-&gt;MdlFlags &amp; (<a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a> |                    \
                        <a class="code" href="../../d0/d9/ntosdef_8h.html#a14">MDL_SOURCE_IS_NONPAGED_POOL</a>)) ?                \
                             ((<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)-&gt;MappedSystemVa) :                 \
                             (<a class="code" href="../../d2/d1/mm_8h.html#a276">MmMapLockedPages</a>((<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>),KernelMode)))
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01874">1874</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02995">ExLockUserBuffer()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02555">FsRtlCancelNotify()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l02000">FsRtlNotifyCompleteIrp()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00973">FsRtlNotifyFullReportChange()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l02636">SmbTraceCopyMdlContiguous()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="mm.h::MmGetSystemAddressForMdlSafe" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MmGetSystemAddressForMdlSafe          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d7/struct__MDL.html">MDL</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PRIORITY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(((<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)-&gt;MdlFlags &amp; (<a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a> |                    \
                        <a class="code" href="../../d0/d9/ntosdef_8h.html#a14">MDL_SOURCE_IS_NONPAGED_POOL</a>)) ?                \
                             ((<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)-&gt;MappedSystemVa) :                 \
                             (<a class="code" href="../../d2/d1/mm_8h.html#a279">MmMapLockedPagesSpecifyCache</a>((<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>),      \
                                                           KernelMode, \
                                                           MmCached,   \
                                                           NULL,       \
                                                           FALSE,      \
                                                           (PRIORITY))))
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01833">1833</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01095">MiCheckForCrashDump()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00890">MiGetWorkingSetInfo()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01064">UdfIsVolumeDirty()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="mm.h::MmInitializeMdl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MmInitializeMdl          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">MemoryDescriptorList,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BaseVa,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Length&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{ \
    (MemoryDescriptorList)-&gt;Next = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; \
    (MemoryDescriptorList)-&gt;Size = (CSHORT)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>) +  \
            (<span class="keyword">sizeof</span>(PFN_NUMBER) * <a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>((BaseVa), (Length)))); \
    (MemoryDescriptorList)-&gt;MdlFlags = 0; \
    (MemoryDescriptorList)-&gt;StartVa = (PVOID) <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>((BaseVa)); \
    (MemoryDescriptorList)-&gt;ByteOffset = <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>((BaseVa)); \
    (MemoryDescriptorList)-&gt;ByteCount = (ULONG)(Length); \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01789">1789</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02995">ExLockUserBuffer()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00805">IoAllocateMdl()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03183">IopWritePageToDisk()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l02313">MiCleanPhysicalProcessPages()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00529">MiDoMappedCopy()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">MiGatherMappedPages()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03701">MiGatherPagefilePages()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00890">MiGetWorkingSetInfo()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05287">MiMakeOutswappedPageResident()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01989">MiResolveMappedFileFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01272">MiResolvePageFileFault()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05852">MmCreateMdl()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01152">MmProbeAndLockSelectedPages()</a>, <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l01624">NtFreeUserPhysicalPages()</a>, and <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="mm.h::MmIsRecursiveIoFault" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MmIsRecursiveIoFault          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>((<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;DisablePageFaultClustering) | \
                  (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;ForwardClusterOnly))
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00893">893</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08509">IoPageRead()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="mm.h::MMNONPAGED_QUOTA_CHECK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MMNONPAGED_QUOTA_CHECK&nbsp;&nbsp;&nbsp;(256*1024)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02014">2014</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="mm.h::MMNONPAGED_QUOTA_INCREASE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MMNONPAGED_QUOTA_INCREASE&nbsp;&nbsp;&nbsp;(64*1024)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02010">2010</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01118">MmRaisePoolQuota()</a>, and <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="mm.h::MMPAGED_QUOTA_CHECK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MMPAGED_QUOTA_CHECK&nbsp;&nbsp;&nbsp;(4*1024*1024)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02016">2016</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01118">MmRaisePoolQuota()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="mm.h::MMPAGED_QUOTA_INCREASE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MMPAGED_QUOTA_INCREASE&nbsp;&nbsp;&nbsp;(512*1024)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02012">2012</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01118">MmRaisePoolQuota()</a>, and <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="mm.h::MmPrepareMdlForReuse" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MmPrepareMdlForReuse          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d7/struct__MDL.html">MDL</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> (((<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a17">MDL_PARTIAL_HAS_BEEN_MAPPED</a>) != 0) {         \
        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)-&gt;MdlFlags &amp; MDL_PARTIAL) != 0);                   \
        <a class="code" href="../../d2/d1/mm_8h.html#a280">MmUnmapLockedPages</a>( (<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)-&gt;MappedSystemVa, (<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>) );             \
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a16">MDL_PARTIAL</a>) == 0) {                  \
        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)-&gt;MdlFlags &amp; MDL_MAPPED_TO_SYSTEM_VA) == 0);       \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01902">1902</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06744">IoFreeMdl()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="mm.h::MmResetPageFaultReadAhead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MmResetPageFaultReadAhead          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Thread,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SavedState&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                     \
                (Thread)-&gt;ForwardClusterOnly = (BOOLEAN)((SavedState) &amp; 1); \
                (Thread)-&gt;ReadClusterSize = (SavedState) / 2; }
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01053">1053</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/copysup_8c-source.html#l00031">CcCopyRead()</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l00588">CcFastCopyRead()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l06024">CcMapAndCopy()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l05749">CcMapAndRead()</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00052">CcMapData()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00030">CcMdlRead()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l01633">CcPerformReadAhead()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01274">MmCopyToCachedPage()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="mm.h::MmSavePageFaultReadAhead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MmSavePageFaultReadAhead          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Thread,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SavedState&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{               \
                *(SavedState) = (Thread)-&gt;ReadClusterSize * 2 +     \
                                (Thread)-&gt;ForwardClusterOnly; }
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00983">983</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/copysup_8c-source.html#l00031">CcCopyRead()</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l00588">CcFastCopyRead()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l06024">CcMapAndCopy()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l05749">CcMapAndRead()</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00052">CcMapData()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00030">CcMdlRead()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l01633">CcPerformReadAhead()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01274">MmCopyToCachedPage()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="mm.h::MmSetPageFaultReadAhead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MmSetPageFaultReadAhead          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Thread,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ReadAhead&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                          \
                (Thread)-&gt;ForwardClusterOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                         \
                <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a210a167">ReadAhead</a>) &gt; <a class="code" href="../../d2/d1/mm_8h.html#a2">MM_MAXIMUM_READ_CLUSTER_SIZE</a>) {            \
                    (Thread)-&gt;ReadClusterSize = <a class="code" href="../../d2/d1/mm_8h.html#a2">MM_MAXIMUM_READ_CLUSTER_SIZE</a>;\
                } <span class="keywordflow">else</span> {                                                     \
                    (Thread)-&gt;ReadClusterSize = (<a class="code" href="../../d5/d5/cc_8h.html#a210a167">ReadAhead</a>);                 \
                } }
</div></pre>
<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01018">1018</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/copysup_8c-source.html#l00031">CcCopyRead()</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l00588">CcFastCopyRead()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l06024">CcMapAndCopy()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l05749">CcMapAndRead()</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00052">CcMapData()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00030">CcMdlRead()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l01633">CcPerformReadAhead()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01274">MmCopyToCachedPage()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="mm.h::NUMBER_OF_PAGE_LISTS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NUMBER_OF_PAGE_LISTS&nbsp;&nbsp;&nbsp;8          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01065">1065</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="mm.h::PAGE_ALIGN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PAGE_ALIGN          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Va&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((PVOID)((ULONG_PTR)(Va) &amp; ~(PAGE_SIZE - 1)))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">190</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01804">IoBuildPartialMdl()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00287">IopIsAddressRangeValid()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02081">IopMapPhysicalMemory()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03759">IopMapVirtualToPhysicalMdl()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03183">IopWritePageToDisk()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02534">KdpReadPhysicalMemory()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02680">KdpWritePhysicalMemory()</a>, <a class="el" href="../../d6/d2/acceschk_8c-source.html#l00194">MiCheckForUserStackOverflow()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l02880">MiCheckVirtualAddress()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>, <a class="el" href="../../d7/d1/mm_2ia64_2initia64_8c-source.html#l01995">MiConvertBackToStandardPages()</a>, <a class="el" href="../../d7/d1/mm_2ia64_2initia64_8c-source.html#l01921">MiConvertToSuperPages()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l01424">MiCreateImageFileMap()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l01161">MiDecommitPages()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05006">MiDeleteAddressesInWorkingSet()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">MiDeletePte()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">MiDeleteSystemPagableVm()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02474">MiFindInitializationCode()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">MiGatherMappedPages()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03300">MiGrowWsleHash()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00814">MiInitializeSystemCache()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01481">MiInitializeWorkingSetList()</a>, <a class="el" href="../../d3/d0/inialpha_8c-source.html#l00041">MiInitMachineDependent()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00051">MiInsertWsle()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00248">MiLocateWsle()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l00344">MiProtectVirtualMemory()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00899">MiRemovePageFromWorkingSet()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l04228">MiRemoveWorkingSetPages()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00464">MiRemoveWsle()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01272">MiResolvePageFileFault()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01881">MiSessionInitializeWorkingSetList()</a>, <a class="el" href="../../d7/d1/mm_2ia64_2initia64_8c-source.html#l02042">MiSweepCacheMachineDependent()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01078">MiUpdateWsle()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">MmFlushVirtualMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05721">MmFreeNonCachedMemory()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03742">MmFreeSpecialPool()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02927">MmQuerySpecialPoolBlockSize()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00055">NtFlushVirtualMemory()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>, <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00033">NtLockVirtualMemory()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l00085">NtMapUserPhysicalPages()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00061">NtQueryVirtualMemory()</a>, <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00605">NtUnlockVirtualMemory()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l01976">VerifierFreeTrackedPool()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l01614">ViPostPoolAllocation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="mm.h::PERFINFO_ADDPOOLPAGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_ADDPOOLPAGE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">CheckType,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PoolIndex,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Addr,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PoolDesc&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02153">2153</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="mm.h::PERFINFO_ADDTOWS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_ADDTOWS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PageFrame,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Address,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Pid&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02154">2154</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/pagfault_8c-source.html#l04056">MiAddValidPageToWorkingSet()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="mm.h::PERFINFO_BIGPOOLALLOC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_BIGPOOLALLOC          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Type,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PTag,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>NumBytes,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Addr&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02155">2155</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="mm.h::PERFINFO_CM_CHECKCELLTYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_CM_CHECKCELLTYPE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Map&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02157">2157</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="mm.h::PERFINFO_CM_CHECKCELLTYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_CM_CHECKCELLTYPE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Map&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02157">2157</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="mm.h::PERFINFO_CM_HIVECELL_REFERENCE_FLAT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_CM_HIVECELL_REFERENCE_FLAT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>pcell,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02158">2158</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="mm.h::PERFINFO_CM_HIVECELL_REFERENCE_PAGED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_CM_HIVECELL_REFERENCE_PAGED          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>pcell,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Type,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Map&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02159">2159</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="mm.h::PERFINFO_CONVERT_TO_GUI_THREAD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_CONVERT_TO_GUI_THREAD          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">EThread&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02160">2160</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l03964">PsConvertToGuiThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="mm.h::PERFINFO_DECREFCNT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_DECREFCNT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PageFrame,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Flag,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Type&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02161">2161</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a89" doxytag="mm.h::PERFINFO_DELETE_PAGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_DELETE_PAGE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ppfn&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02210">2210</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="mm.h::PERFINFO_DELETE_STACK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_DELETE_STACK          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PointerPte,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>NumberOfPtes&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02162">2162</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l02723">MmDeleteKernelStack()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="mm.h::PERFINFO_DISPATCHFAULT_DECL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_DISPATCHFAULT_DECL          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02163">2163</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00068">MiDispatchFault()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a125" doxytag="mm.h::PERFINFO_DO_PAGEFAULT_CLUSTERING" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_DO_PAGEFAULT_CLUSTERING          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;1</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02247">2247</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01989">MiResolveMappedFileFault()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="mm.h::PERFINFO_DRIVER_COMPLETIONROUTINE_CALL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_DRIVER_COMPLETIONROUTINE_CALL          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">irp,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>irpsp&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02164">2164</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="mm.h::PERFINFO_DRIVER_COMPLETIONROUTINE_RETURN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_DRIVER_COMPLETIONROUTINE_RETURN          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">irp,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>irpsp&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02165">2165</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="mm.h::PERFINFO_DRIVER_INIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_DRIVER_INIT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">pdo&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02166">2166</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="mm.h::PERFINFO_DRIVER_INIT_COMPLETE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_DRIVER_INIT_COMPLETE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">pdo&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02167">2167</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="mm.h::PERFINFO_DRIVER_MAJORFUNCTION_CALL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_DRIVER_MAJORFUNCTION_CALL          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">irp,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>irpsp,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>pdo&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02168">2168</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02063">IopfCallDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05617">IopRaiseHardError()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01159">IovSpecialIrpCallDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="mm.h::PERFINFO_DRIVER_MAJORFUNCTION_RETURN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_DRIVER_MAJORFUNCTION_RETURN          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">irp,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>irpsp,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>pdo&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02169">2169</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l02063">IopfCallDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05617">IopRaiseHardError()</a>, and <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l01159">IovSpecialIrpCallDriver()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="mm.h::PERFINFO_EXALLOCATEPOOLWITHTAG_DECL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_EXALLOCATEPOOLWITHTAG_DECL          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02170">2170</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="mm.h::PERFINFO_EXFREEPOOLWITHTAG_DECL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_EXFREEPOOLWITHTAG_DECL          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02171">2171</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="mm.h::PERFINFO_FREEPOOL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_FREEPOOL          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Addr&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02172">2172</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="mm.h::PERFINFO_FREEPOOLPAGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_FREEPOOLPAGE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">CheckType,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PoolIndex,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Addr,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PoolDesc&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02173">2173</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="mm.h::PERFINFO_GET_PAGE_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_GET_PAGE_INFO          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PointerPte&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02174">2174</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l04726">MiEmptyWorkingSet()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00051">MiInsertWsle()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>, and <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00605">NtUnlockVirtualMemory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="mm.h::PERFINFO_GET_PAGE_INFO_REPLACEMENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_GET_PAGE_INFO_REPLACEMENT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PointerPte&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02175">2175</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l00790">MiReplaceWorkingSetEntryUsingFaultInfo()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="mm.h::PERFINFO_GET_PAGE_INFO_WITH_DECL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_GET_PAGE_INFO_WITH_DECL          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PointerPte&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02176">2176</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l03612">MiTrimWorkingSet()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="mm.h::PERFINFO_GROW_STACK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_GROW_STACK          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">EThread&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02177">2177</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/procsup_8c-source.html#l02921">MmGrowKernelStack()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="mm.h::PERFINFO_HARDFAULT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_HARDFAULT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Address,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>InpageSupport&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02178">2178</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00068">MiDispatchFault()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="mm.h::PERFINFO_HARDFAULT_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_HARDFAULT_INFO          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ProtoPte&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02179">2179</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00068">MiDispatchFault()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="mm.h::PERFINFO_HARDFAULT_IOTIME" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_HARDFAULT_IOTIME          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02180">2180</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00068">MiDispatchFault()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="mm.h::PERFINFO_HIVECELL_REFERENCE_FLAT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_HIVECELL_REFERENCE_FLAT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>pcell,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02181">2181</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="mm.h::PERFINFO_HIVECELL_REFERENCE_PAGED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_HIVECELL_REFERENCE_PAGED          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>pcell,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Type,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Map&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02182">2182</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="mm.h::PERFINFO_IMAGE_LOAD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_IMAGE_LOAD          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LdrDataTableEntry&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02183">2183</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="mm.h::PERFINFO_IMAGE_UNLOAD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_IMAGE_UNLOAD          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Address&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02184">2184</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="mm.h::PERFINFO_INIT_PERFMEMTABLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_INIT_PERFMEMTABLE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LoaderBlock&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02186">2186</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="mm.h::PERFINFO_INIT_POOLRANGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_INIT_POOLRANGE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PoolStart,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PoolPages&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02185">2185</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/mm_2i386_2init386_8c-source.html#l00058">MiInitMachineDependent()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="mm.h::PERFINFO_INIT_TRACEFLAGS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_INIT_TRACEFLAGS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OptionString,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SpecificOption&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02187">2187</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="mm.h::PERFINFO_INSERT_FRONT_STANDBY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_INSERT_FRONT_STANDBY          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Page&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02189">2189</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00388">MiInsertStandbyListAtFront()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a67" doxytag="mm.h::PERFINFO_INSERTINLIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_INSERTINLIST          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Page,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ListHead&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02188">2188</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a69" doxytag="mm.h::PERFINFO_LOG_MARK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_LOG_MARK          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PMARK&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02190">2190</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a70" doxytag="mm.h::PERFINFO_LOG_MARK_SPRINTF" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_LOG_MARK_SPRINTF          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PMARK,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>VARIABLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02191">2191</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a71" doxytag="mm.h::PERFINFO_LOG_WMI_TRACE_EVENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_LOG_WMI_TRACE_EVENT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PData,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>xLength&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02192">2192</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a72" doxytag="mm.h::PERFINFO_LOG_WMI_TRACE_KERNEL_EVENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_LOG_WMI_TRACE_KERNEL_EVENT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">GroupType,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PData,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>xLength,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Thread&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02193">2193</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a73" doxytag="mm.h::PERFINFO_LOG_WMI_TRACE_LONG_EVENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_LOG_WMI_TRACE_LONG_EVENT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">GroupType,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PData,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>xCount,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Thread&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02194">2194</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a74" doxytag="mm.h::PERFINFO_LOG_WS_REMOVAL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_LOG_WS_REMOVAL          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Type,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WsInfo&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02195">2195</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l04726">MiEmptyWorkingSet()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00051">MiInsertWsle()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03612">MiTrimWorkingSet()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>, and <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00605">NtUnlockVirtualMemory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a75" doxytag="mm.h::PERFINFO_LOG_WS_REPLACEMENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_LOG_WS_REPLACEMENT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">WsInfo&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02196">2196</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l00790">MiReplaceWorkingSetEntryUsingFaultInfo()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a76" doxytag="mm.h::PERFINFO_MIH_DECL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_MIH_DECL          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02197">2197</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a77" doxytag="mm.h::PERFINFO_MMINIT_DECL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define <a class="el" href="../../d5/d1/mminit_8c.html#a23">PERFINFO_MMINIT_DECL</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02198">2198</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a78" doxytag="mm.h::PERFINFO_MMINIT_START" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_MMINIT_START          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02199">2199</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l01440">MiMapBBTMemory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a79" doxytag="mm.h::PERFINFO_MOD_PAGE_WRITER3" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_MOD_PAGE_WRITER3          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02200">2200</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a80" doxytag="mm.h::PERFINFO_PAGE_INFO_DECL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_PAGE_INFO_DECL          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02201">2201</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l04726">MiEmptyWorkingSet()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00051">MiInsertWsle()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>, and <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00605">NtUnlockVirtualMemory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a81" doxytag="mm.h::PERFINFO_PAGE_INFO_REPLACEMENT_DECL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_PAGE_INFO_REPLACEMENT_DECL          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02202">2202</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l00790">MiReplaceWorkingSetEntryUsingFaultInfo()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a84" doxytag="mm.h::PERFINFO_POOL_ALLOC_COMMON" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_POOL_ALLOC_COMMON          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Type,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PTag,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>NumBytes&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02205">2205</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a82" doxytag="mm.h::PERFINFO_POOLALLOC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_POOLALLOC          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Type,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PTag,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>NumBytes&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02203">2203</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a83" doxytag="mm.h::PERFINFO_POOLALLOC_ADDR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_POOLALLOC_ADDR          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Addr&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02204">2204</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a85" doxytag="mm.h::PERFINFO_PRIVATE_COPY_ON_WRITE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_PRIVATE_COPY_ON_WRITE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">CopyFrom,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PAGE_SIZE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02206">2206</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/wrtfault_8c-source.html#l00025">MiCopyOnWrite()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a86" doxytag="mm.h::PERFINFO_PRIVATE_PAGE_DEMAND_ZERO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_PRIVATE_PAGE_DEMAND_ZERO          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VirtualAddress&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02207">2207</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00674">MiResolveDemandZeroFault()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a87" doxytag="mm.h::PERFINFO_PROCESS_CREATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_PROCESS_CREATE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">EProcess&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02208">2208</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a88" doxytag="mm.h::PERFINFO_PROCESS_DELETE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_PROCESS_DELETE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">EProcess&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02209">2209</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01363">PspProcessDelete()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a90" doxytag="mm.h::PERFINFO_REMOVEPAGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_REMOVEPAGE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PageIndex,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LogType&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02211">2211</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01567">MiRemovePageByColor()</a>, and <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00521">MiRemovePageFromList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a91" doxytag="mm.h::PERFINFO_SECTION_CREATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_SECTION_CREATE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ControlArea&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02212">2212</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/creasect_8c-source.html#l00390">MmCreateSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a92" doxytag="mm.h::PERFINFO_SEGMENT_DELETE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_SEGMENT_DELETE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02213">2213</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00191">MiSegmentDelete()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a93" doxytag="mm.h::PERFINFO_SOFTFAULT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_SOFTFAULT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PageFrame,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Address,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Type&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02214">2214</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01762">MiCompleteProtoPteFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00674">MiResolveDemandZeroFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01446">MiResolveProtoPteFault()</a>, and <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00868">MiResolveTransitionFault()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a94" doxytag="mm.h::PERFINFO_THREAD_CREATE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_THREAD_CREATE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">EThread,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ITeb&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02215">2215</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a95" doxytag="mm.h::PERFINFO_THREAD_DELETE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_THREAD_DELETE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">EThread&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02216">2216</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01438">PspThreadDelete()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a96" doxytag="mm.h::PERFINFO_UNLINKFREEPAGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_UNLINKFREEPAGE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Location&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02217">2217</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00821">MiUnlinkFreeOrZeroedPage()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a97" doxytag="mm.h::PERFINFO_UNLINKPAGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_UNLINKPAGE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d0/cmdat2_8c.html#a27">Index</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Location&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02218">2218</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a98" doxytag="mm.h::PERFINFO_WSMANAGE_ACTUALTRIM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_ACTUALTRIM          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Trim&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02219">2219</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a99" doxytag="mm.h::PERFINFO_WSMANAGE_DECL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_DECL          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02220">2220</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01218">MiCheckSystemTrimEndCriteria()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a100" doxytag="mm.h::PERFINFO_WSMANAGE_DUMPENTRIES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_DUMPENTRIES          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02221">2221</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a101" doxytag="mm.h::PERFINFO_WSMANAGE_DUMPENTRIES_CLAIMS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_DUMPENTRIES_CLAIMS          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02222">2222</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a102" doxytag="mm.h::PERFINFO_WSMANAGE_DUMPENTRIES_FAULTS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_DUMPENTRIES_FAULTS          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02223">2223</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a103" doxytag="mm.h::PERFINFO_WSMANAGE_DUMPWS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_DUMPWS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VmSupport,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SampledAgeCounts&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02224">2224</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a104" doxytag="mm.h::PERFINFO_WSMANAGE_FINALACTION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_FINALACTION          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">TrimAction&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02225">2225</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a105" doxytag="mm.h::PERFINFO_WSMANAGE_GLOBAL_DECL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define <a class="el" href="../../d5/d0/wsmanage_8c.html#a27">PERFINFO_WSMANAGE_GLOBAL_DECL</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02226">2226</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a106" doxytag="mm.h::PERFINFO_WSMANAGE_LOGINFO_CLAIMS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_LOGINFO_CLAIMS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">TrimAction&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02227">2227</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a107" doxytag="mm.h::PERFINFO_WSMANAGE_LOGINFO_FAULTS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_LOGINFO_FAULTS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">TrimAction&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02228">2228</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a109" doxytag="mm.h::PERFINFO_WSMANAGE_PROCESS_RESET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_PROCESS_RESET          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VmSupport&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02230">2230</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a108" doxytag="mm.h::PERFINFO_WSMANAGE_PROCESS_RESET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_PROCESS_RESET          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VmSupport&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02230">2230</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01372">MiCheckProcessTrimCriteria()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a110" doxytag="mm.h::PERFINFO_WSMANAGE_STARTLOG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_STARTLOG          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02231">2231</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a111" doxytag="mm.h::PERFINFO_WSMANAGE_STARTLOG_CLAIMS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_STARTLOG_CLAIMS          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02232">2232</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a112" doxytag="mm.h::PERFINFO_WSMANAGE_STARTLOG_FAULTS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_STARTLOG_FAULTS          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02233">2233</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a113" doxytag="mm.h::PERFINFO_WSMANAGE_TOTRIM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_TOTRIM          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Trim&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02234">2234</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a114" doxytag="mm.h::PERFINFO_WSMANAGE_TRIMACTION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_TRIMACTION          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">TrimAction&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02235">2235</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01218">MiCheckSystemTrimEndCriteria()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a115" doxytag="mm.h::PERFINFO_WSMANAGE_TRIMEND_CLAIMS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_TRIMEND_CLAIMS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Criteria&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02236">2236</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a116" doxytag="mm.h::PERFINFO_WSMANAGE_TRIMEND_FAULTS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_TRIMEND_FAULTS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Criteria&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02237">2237</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a117" doxytag="mm.h::PERFINFO_WSMANAGE_TRIMWS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_TRIMWS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Process,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SessionSpace,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>VmSupport&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02238">2238</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a119" doxytag="mm.h::PERFINFO_WSMANAGE_TRIMWS_CLAIMINFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_TRIMWS_CLAIMINFO          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VmSupport&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02240">2240</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a118" doxytag="mm.h::PERFINFO_WSMANAGE_TRIMWS_CLAIMINFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_TRIMWS_CLAIMINFO          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VmSupport&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02240">2240</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a120" doxytag="mm.h::PERFINFO_WSMANAGE_WAITFORWRITER_CLAIMS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_WAITFORWRITER_CLAIMS          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02241">2241</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01218">MiCheckSystemTrimEndCriteria()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a121" doxytag="mm.h::PERFINFO_WSMANAGE_WAITFORWRITER_FAULTS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_WAITFORWRITER_FAULTS          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02242">2242</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01218">MiCheckSystemTrimEndCriteria()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a122" doxytag="mm.h::PERFINFO_WSMANAGE_WILLTRIM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_WILLTRIM          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ReductionGoal,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FreeGoal&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02243">2243</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a123" doxytag="mm.h::PERFINFO_WSMANAGE_WILLTRIM_CLAIMS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_WILLTRIM_CLAIMS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Criteria&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02244">2244</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a124" doxytag="mm.h::PERFINFO_WSMANAGE_WILLTRIM_FAULTS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PERFINFO_WSMANAGE_WILLTRIM_FAULTS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Criteria&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02245">2245</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="mm.h::ROUND_TO_PAGES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ROUND_TO_PAGES          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(((ULONG_PTR)(<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>) + PAGE_SIZE - 1) &amp; ~(PAGE_SIZE - 1))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">117</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/copysup_8c-source.html#l00031">CcCopyRead()</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l00588">CcFastCopyRead()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00116">CcPinFileData()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l01253">CcScheduleReadAhead()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02324">ExpAddTagForBigPages()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02000">ExpInsertPoolTracker()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02492">IopCalculateRequiredDumpSpace()</a>, <a class="el" href="../../d7/d1/mm_2ia64_2initia64_8c-source.html#l02091">MiBuildPageTableForDrivers()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l03553">MiCreateDataFileMap()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04018">MiCreatePagingFileMap()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04202">MiCreatePebOrTeb()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02208">MiEnablePagingOfDriver()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02735">MiEnablePagingTheExecutive()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02474">MiFindInitializationCode()</a>, <a class="el" href="../../d6/d4/flushbuf_8c-source.html#l00060">MiFlushRangeFilter()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l06395">MiLocateKernelSections()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l05956">MiReloadBootLoadedDrivers()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04843">MmDeleteTeb()</a>, <a class="el" href="../../d9/d9/extsect_8c-source.html#l00201">MmExtendSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02106">MmFreeDriverInitialization()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00297">NtCreatePagingFile()</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00931">UdfRawBufferSize()</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00951">UdfRawBufferSizeN()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a141" doxytag="mm.h::LOCK_OPERATION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d2/d1/mm_8h.html#a344">_LOCK_OPERATION</a>  <a class="el" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01360">IoBuildAsynchronousFsdRequest()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, and <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a154" doxytag="mm.h::MM_PAGE_PRIORITY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d2/d1/mm_8h.html#a347">_MM_PAGE_PRIORITY</a>  <a class="el" href="../../d2/d1/mm_8h.html#a154">MM_PAGE_PRIORITY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a140" doxytag="mm.h::MM_SYSTEMSIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d2/d1/mm_8h.html#a343">_MM_SYSTEM_SIZE</a>  <a class="el" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, and <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a153" doxytag="mm.h::MMFLUSH_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d2/d1/mm_8h.html#a346">_MMFLUSH_TYPE</a>  <a class="el" href="../../d2/d1/mm_8h.html#a153">MMFLUSH_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d4/flushsec_8c-source.html#l02094">MmFlushImageSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a143" doxytag="mm.h::MMINFO_COUNTERS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d3/d2/struct__MMINFO__COUNTERS.html">_MMINFO_COUNTERS</a>  <a class="el" href="../../d3/d2/struct__MMINFO__COUNTERS.html">MMINFO_COUNTERS</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a147" doxytag="mm.h::MMLISTS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d2/d1/mm_8h.html#a345">_MMLISTS</a>  <a class="el" href="../../d2/d1/mm_8h.html#a147">MMLISTS</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d3/dynmem_8c-source.html#l01109">MiRemovePhysicalPages()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a148" doxytag="mm.h::MMPFNLIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d4/struct__MMPFNLIST.html">_MMPFNLIST</a>  <a class="el" href="../../d0/d4/struct__MMPFNLIST.html">MMPFNLIST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a162" doxytag="mm.h::PBANKED_SECTION_ROUTINE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef VOID(* <a class="el" href="../../d2/d1/mm_8h.html#a162">PBANKED_SECTION_ROUTINE</a>)(IN ULONG ReadBank, IN ULONG WriteBank, IN PVOID Context)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02072">2072</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l07311">MmSetBankedSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a164" doxytag="mm.h::PHARD_FAULT_NOTIFY_ROUTINE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef VOID(FASTCALL * <a class="el" href="../../d2/d1/mm_8h.html#a164">PHARD_FAULT_NOTIFY_ROUTINE</a>)(IN HANDLE FileObject, IN PVOID VirtualAddress)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02119">2119</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00068">MiDispatchFault()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a129" doxytag="mm.h::PHYSICAL_MEMORY_DESCRIPTOR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">_PHYSICAL_MEMORY_DESCRIPTOR</a>  <a class="el" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PHYSICAL_MEMORY_DESCRIPTOR</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a155" doxytag="mm.h::PHYSICAL_MEMORY_RANGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">_PHYSICAL_MEMORY_RANGE</a>  <a class="el" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">PHYSICAL_MEMORY_RANGE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d3/dynmem_8c-source.html#l01032">MmGetPhysicalMemoryRanges()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a127" doxytag="mm.h::PHYSICAL_MEMORY_RUN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">_PHYSICAL_MEMORY_RUN</a>  <a class="el" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a146" doxytag="mm.h::PKWIN32_CALLOUT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef NTSTATUS(* <a class="el" href="../../d2/d1/mm_8h.html#a146">PKWIN32_CALLOUT</a>)(IN PVOID Arg)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00559">559</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07330">IopNotifyDeviceClassChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06858">IopNotifyHwProfileChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08162">IopNotifySetupDeviceArrival()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07055">IopNotifyTargetDeviceChange()</a>, and <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a157" doxytag="mm.h::PMM_DLL_INITIALIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef NTSTATUS(* <a class="el" href="../../d2/d1/mm_8h.html#a157">PMM_DLL_INITIALIZE</a>)(IN PUNICODE_STRING RegistryPath)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01910">1910</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l03953">MiResolveImageReferences()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l06717">MmCallDllInitialize()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a158" doxytag="mm.h::PMM_DLL_UNLOAD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef NTSTATUS(* <a class="el" href="../../d2/d1/mm_8h.html#a158">PMM_DLL_UNLOAD</a>)(VOID)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01914">1914</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l03645">MiCallDllUnloadAndUnloadDll()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a144" doxytag="mm.h::PMMINFO_COUNTERS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d3/d2/struct__MMINFO__COUNTERS.html">MMINFO_COUNTERS</a>* <a class="el" href="../../d3/d2/struct__MMINFO__COUNTERS.html">PMMINFO_COUNTERS</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00473">473</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a149" doxytag="mm.h::PMMPFNLIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef <a class="el" href="../../d0/d4/struct__MMPFNLIST.html">MMPFNLIST</a>* <a class="el" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01085">1085</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a163" doxytag="mm.h::PPAGE_FAULT_NOTIFY_ROUTINE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef VOID(FASTCALL * <a class="el" href="../../d2/d1/mm_8h.html#a163">PPAGE_FAULT_NOTIFY_ROUTINE</a>)(IN NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>, IN PVOID VirtualAddress, IN PVOID TrapInformation)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l02111">2111</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a130" doxytag="mm.h::PPHYSICAL_MEMORY_DESCRIPTOR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">_PHYSICAL_MEMORY_DESCRIPTOR</a> * <a class="el" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a156" doxytag="mm.h::PPHYSICAL_MEMORY_RANGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">_PHYSICAL_MEMORY_RANGE</a> * <a class="el" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">PPHYSICAL_MEMORY_RANGE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a128" doxytag="mm.h::PPHYSICAL_MEMORY_RUN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">_PHYSICAL_MEMORY_RUN</a> * <a class="el" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PPHYSICAL_MEMORY_RUN</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a344" doxytag="mm.h::_LOCK_OPERATION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d2/d1/mm_8h.html#a344">_LOCK_OPERATION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a344a168" doxytag="IoReadAccess" ></a>IoReadAccess</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a344a169" doxytag="IoWriteAccess" ></a>IoWriteAccess</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a344a170" doxytag="IoModifyAccess" ></a>IoModifyAccess</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00443">443</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
<pre class="fragment"><div>00443                              {
00444     <a class="code" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>,
00445     <a class="code" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a>,
00446     <a class="code" href="../../d2/d1/mm_8h.html#a344a170">IoModifyAccess</a>
00447 } <a class="code" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a>;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a347" doxytag="mm.h::_MM_PAGE_PRIORITY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d2/d1/mm_8h.html#a347">_MM_PAGE_PRIORITY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a347a181" doxytag="LowPagePriority" ></a>LowPagePriority</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a347a182" doxytag="NormalPagePriority" ></a>NormalPagePriority</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a347a183" doxytag="HighPagePriority" ></a>HighPagePriority</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01446">1446</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
<pre class="fragment"><div>01446                                {
01447     <a class="code" href="../../d2/d1/mm_8h.html#a347a181">LowPagePriority</a>,
01448     <a class="code" href="../../d2/d1/mm_8h.html#a347a182">NormalPagePriority</a> = 16,
01449     <a class="code" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a> = 32
01450 } <a class="code" href="../../d2/d1/mm_8h.html#a154">MM_PAGE_PRIORITY</a>;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a343" doxytag="mm.h::_MM_SYSTEM_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d2/d1/mm_8h.html#a343">_MM_SYSTEM_SIZE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a343a165" doxytag="MmSmallSystem" ></a>MmSmallSystem</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a343a166" doxytag="MmMediumSystem" ></a>MmMediumSystem</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a343a167" doxytag="MmLargeSystem" ></a>MmLargeSystem</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00421">421</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
<pre class="fragment"><div>00421                              {
00422     <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>,
00423     <a class="code" href="../../d2/d1/mm_8h.html#a343a166">MmMediumSystem</a>,
00424     <a class="code" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a>
00425 } <a class="code" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a>;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a346" doxytag="mm.h::_MMFLUSH_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d2/d1/mm_8h.html#a346">_MMFLUSH_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a346a179" doxytag="MmFlushForDelete" ></a>MmFlushForDelete</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a346a180" doxytag="MmFlushForWrite" ></a>MmFlushForWrite</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01267">1267</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
<pre class="fragment"><div>01267                            {
01268     <a class="code" href="../../d2/d1/mm_8h.html#a346a179">MmFlushForDelete</a>,
01269     <a class="code" href="../../d2/d1/mm_8h.html#a346a180">MmFlushForWrite</a>
01270 } <a class="code" href="../../d2/d1/mm_8h.html#a153">MMFLUSH_TYPE</a>;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a345" doxytag="mm.h::_MMLISTS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d2/d1/mm_8h.html#a345">_MMLISTS</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a345a171" doxytag="ZeroedPageList" ></a>ZeroedPageList</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a345a172" doxytag="FreePageList" ></a>FreePageList</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a345a173" doxytag="StandbyPageList" ></a>StandbyPageList</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a345a174" doxytag="ModifiedPageList" ></a>ModifiedPageList</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a345a175" doxytag="ModifiedNoWritePageList" ></a>ModifiedNoWritePageList</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a345a176" doxytag="BadPageList" ></a>BadPageList</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a345a177" doxytag="ActiveAndValid" ></a>ActiveAndValid</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a345a178" doxytag="TransitionPage" ></a>TransitionPage</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01067">1067</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
<pre class="fragment"><div>01067                       {
01068     <a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>,
01069     <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>,
01070     <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>,  <span class="comment">//this list and before make up available pages.</span>
01071     <a class="code" href="../../d2/d1/mm_8h.html#a345a174">ModifiedPageList</a>,
01072     <a class="code" href="../../d2/d1/mm_8h.html#a345a175">ModifiedNoWritePageList</a>,
01073     <a class="code" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>,
01074     <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>,
01075     <a class="code" href="../../d2/d1/mm_8h.html#a345a178">TransitionPage</a>
01076 } <a class="code" href="../../d2/d1/mm_8h.html#a147">MMLISTS</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a201" doxytag="mm.h::MiAllocatePoolPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiAllocatePoolPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>SizeInBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IsLargeSessionAllocation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00807">807</a> of file <a class="el" href="../../d2/d5/allocpag_8c-source.html">allocpag.c</a>.
<p>
References <a class="el" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04726">_MM_PAGED_POOL_INFO::AllocatedPagedPool</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00050">BASE_POOL_TYPE_MASK</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05471">_MM_SESSION_SPACE::CommittedPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00878">CONSISTENCY_LOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00879">CONSISTENCY_UNLOCK_PFN2</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04719">_MM_PAGED_POOL_INFO::EndOfPagedPoolBitmap</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04721">_MM_PAGED_POOL_INFO::FirstPteForPagedPool</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00591">KSEG0_BASE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00593">KSEG2_BASE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04722">_MM_PAGED_POOL_INFO::LastPteForPagedPool</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02590">_MMFREE_POOL_ENTRY::List</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02287">MI_CONVERT_PHYSICAL_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04688">MI_MAX_FREE_LIST_HEADS</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00143">MI_MEMORY_MAKER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04995">MI_UNUSED_SEGMENTS_SURPLUS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l04056">MiAddValidPageToWorkingSet()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00329">MiChargeCommitmentCantExpand()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02543">MiFillMemoryPte</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00708">MiFreeNonPagedPool()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03973">MiInitializePfnForOtherProcess()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l05023">MiIssuePageExtendRequestNoWait()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00248">MiLocateWsle()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00282">MiProtectedPoolInsertList()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00365">MiProtectedPoolRemoveEntryList()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00150">MiProtectFreeNonPagedPool()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00505">MiSessionPoolAllocated()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00576">MiSwapWslEntries()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00209">MiUnProtectFreeNonPagedPool()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05361">MM_BUMP_SESS_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04246">MM_DBG_COMMIT_NONPAGED_POOL_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04248">MM_DBG_COMMIT_PAGED_POOL_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04247">MM_DBG_COMMIT_PAGED_POOL_PAGETABLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05323">MM_DBG_SESSION_COMMIT_PAGEDPOOL_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05317">MM_DBG_SESSION_PAGEDPOOL_PAGETABLE_ALLOC1</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00418">MM_DEMAND_ZERO_WRITE_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00080">MM_FREE_POOL_SIGNATURE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00425">MM_KERNEL_DEMAND_ZERO_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00431">MM_KERNEL_NOACCESS_PTE</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00199">MM_KSEG2_BASE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00098">MmAllocatedNonPagedPool</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d4/d8/mi_8h.html#a513">MMFREE_POOL_ENTRY</a>, <a class="el" href="../../d3/d1/data386_8c-source.html#l00128">MmKseg2Frame</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04710">MmNonPagedMustSucceed</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00114">MmNonPagedPoolExpansionStart</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00116">MmNonPagedPoolFreeListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04658">MmNumberOfFreeNonPagedPool</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04732">MmPageAlignedPoolBase</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00077">MmPagedPoolCommit</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00069">MmPagedPoolInfo</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00092">MmProtectFreedNonPagedPool</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05211">MmSessionBase</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00055">MmSubsectionBase</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04436">MmSubsectionTopPage</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04673">MmSystemPageDirectory</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04670">MmSystemPagePtes</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04948">MmUnusedSegmentCleanup</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00141">MmUnusedSegmentForceFree</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04946">MmUnusedSegmentList</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00052">MUST_SUCCEED_POOL_TYPE_MASK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04723">_MM_PAGED_POOL_INFO::NextPdeForPagedPoolExpansion</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05463">_MM_SESSION_SPACE::NonPagablePages</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00440">NonPagedPoolDescriptor</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a770">NonPagedPoolExpansion</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04718">_MM_PAGED_POOL_INFO::PagedPoolAllocationMap</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04725">_MM_PAGED_POOL_INFO::PagedPoolCommit</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04724">_MM_PAGED_POOL_INFO::PagedPoolHint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05520">_MM_SESSION_SPACE::PagedPoolInfo</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04720">_MM_PAGED_POOL_INFO::PagedPoolLargeSessionAllocationMap</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05505">_MM_SESSION_SPACE::PagedPoolStart</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05491">_MM_SESSION_SPACE::PageTables</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00453">PDE_PER_PAGE</a>, <a class="el" href="../../d4/d8/mi_8h.html#a651">PMM_PAGED_POOL_INFO</a>, <a class="el" href="../../d4/d8/mi_8h.html#a514">PMMFREE_POOL_ENTRY</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00058">POOL_VERIFIER_MASK</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00455">PTE_PER_PAGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01508">RtlClearBits()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01382">RtlFindClearBitsAndSet()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01634">RtlSetBits()</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00056">SESSION_POOL_MASK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05427">_MM_SESSION_SPACE::SessionPageDirectoryIndex</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02592">_MMFREE_POOL_ENTRY::Signature</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02591">_MMFREE_POOL_ENTRY::Size</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00123">_POOL_DESCRIPTOR::TotalBigPages</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00122">_POOL_DESCRIPTOR::TotalPages</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00060">ValidKernelPde</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00065">ValidKernelPdeLocal</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00038">ValidKernelPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04734">VerifierLargePagedPoolMap</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05556">_MM_SESSION_SPACE::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00064">_MMSUPPORT::VmWorkingSetList</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l05557">_MM_SESSION_SPACE::Wsle</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00786">AllocatePoolInternal()</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00413">ExAllocatePool()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02324">ExpAddTagForBigPages()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02000">ExpInsertPoolTracker()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>, and <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01740">MiInitializeSystemPtes()</a>.
<p>
<pre class="fragment"><div>00815                    :
00816 
00817     This function allocates a set of pages from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
00818 -   and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting <span class="keyword">virtual</span> address to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
00819 
00820     For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a> <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller must first
00821     attempt to get <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a> and <span class="keywordflow">if</span> and ONLY <a class="code" href="../../d2/d0/aw_8h.html#a1">IF</a> that fails, then
00822     <a class="code" href="../../d2/d1/mm_8h.html#a201">MiAllocatePoolPages</a> should be called again with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PoolType of
00823     <a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>.
00824 
00825 Arguments:
00826 
00827     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> from which to obtain pages.
00828 
00829     SizeInBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request in bytes.  The actual
00830                   size returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded up to a page boundary.
00831 
00832     IsLargeSessionAllocation - Supplies nonzero <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a single
00833                                large session allocation.  <a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a> otherwise.
00834 
00835 Return Value:
00836 
00837     Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>, or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> no more <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00838     available.
00839 
00840 Environment:
00841 
00842     These <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> are used by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> general <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocation <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>
00843     and should not be called directly.
00844 
00845     Mutexes guarding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> databases must be held when calling
00846     these <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a>.
00847 
00848     Kernel mode, IRQL at <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>.
00849 
00850 --*/
00851 
00852 {
00853     PFN_NUMBER SizeInPages;
00854     ULONG StartPosition;
00855     ULONG EndPosition;
00856     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte;
00857     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00858     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00859     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00860     PFN_NUMBER PageFrameIndex;
00861     PVOID BaseVa;
00862     KIRQL OldIrql;
00863     KIRQL SessionIrql;
00864     PFN_NUMBER i;
00865     PLIST_ENTRY Entry;
00866     <a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html">PMMFREE_POOL_ENTRY</a> FreePageInfo;
00867     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionSpace;
00868     <a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html">PMM_PAGED_POOL_INFO</a> PagedPoolInfo;
00869     PVOID VirtualAddress;
00870     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00871     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> SessionPte;
00872     ULONG WsEntry;
00873     ULONG WsSwapEntry;
00874     ULONG PageTableCount;
00875     LOGICAL FreedPool;
00876     LOGICAL SignalDereferenceThread;
00877     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00878 
00879     SizeInPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (SizeInBytes);
00880 
00881 <span class="preprocessor">#if DBG</span>
00882 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmCheckRequestInPages != 0) {
00883         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SizeInPages &lt; MmCheckRequestInPages);
00884     }
00885 <span class="preprocessor">#endif</span>
00886 <span class="preprocessor"></span>
00887     <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>) {
00888 
00889         <span class="comment">//</span>
00890         <span class="comment">// Pool expansion failed, see if any Must Succeed</span>
00891         <span class="comment">// pool is still left.</span>
00892         <span class="comment">//</span>
00893 
00894         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a649">MmNonPagedMustSucceed</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00895 
00896             <span class="comment">//</span>
00897             <span class="comment">// No more pool exists.  Bug Check.</span>
00898             <span class="comment">//</span>
00899 
00900             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MUST_SUCCEED_POOL_EMPTY,
00901                           SizeInBytes,
00902                           <a class="code" href="../../d2/d2/ex_2pool_8c.html#a52">NonPagedPoolDescriptor</a>.<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o1">TotalPages</a>,
00903                           <a class="code" href="../../d2/d2/ex_2pool_8c.html#a52">NonPagedPoolDescriptor</a>.<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o8">TotalBigPages</a>,
00904                           MmAvailablePages);
00905         }
00906 
00907         <span class="comment">//</span>
00908         <span class="comment">// Remove a page from the must succeed pool.  More than one is illegal.</span>
00909         <span class="comment">//</span>
00910 
00911         <span class="keywordflow">if</span> (SizeInBytes &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
00912             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (BAD_POOL_CALLER,
00913                           0x98,
00914                           (ULONG_PTR)SizeInBytes,
00915                           (ULONG_PTR)SizeInPages,
00916                           PoolType);
00917         }
00918 
00919         BaseVa = <a class="code" href="../../d4/d8/mi_8h.html#a649">MmNonPagedMustSucceed</a>;
00920 
00921         <span class="keywordflow">if</span> (IsLargeSessionAllocation != 0) {
00922 
00923             <span class="comment">//</span>
00924             <span class="comment">// Mark this as a large session allocation in the PFN database.</span>
00925             <span class="comment">//</span>
00926 
00927             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(BaseVa)) {
00928                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (BaseVa);
00929             } <span class="keywordflow">else</span> {
00930                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(BaseVa);
00931                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
00932                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
00933             }
00934             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00935 
00936             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation == 0);
00937 
00938             <a class="code" href="../../d4/d8/mi_8h.html#a123">CONSISTENCY_LOCK_PFN2</a> (OldIrql);
00939 
00940             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation = 1;
00941 
00942             <a class="code" href="../../d4/d8/mi_8h.html#a124">CONSISTENCY_UNLOCK_PFN2</a> (OldIrql);
00943 
00944             <a class="code" href="../../d1/d6/allocpag_8c.html#a50">MiSessionPoolAllocated</a> (BaseVa, PAGE_SIZE, NonPagedPool);
00945         }
00946         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>) {
00947 
00948             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(BaseVa)) {
00949                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (BaseVa);
00950             } <span class="keywordflow">else</span> {
00951                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(BaseVa);
00952                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
00953                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
00954             }
00955 
00956             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00957 
00958             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation == 0);
00959             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation = 1;
00960         }
00961 
00962         <a class="code" href="../../d4/d8/mi_8h.html#a649">MmNonPagedMustSucceed</a> = (PVOID)(*(PULONG_PTR)BaseVa);
00963         <span class="keywordflow">return</span> BaseVa;
00964     }
00965 
00966     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {
00967 
00968         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (ULONG)(SizeInPages - 1);
00969 
00970         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a324">MI_MAX_FREE_LIST_HEADS</a>) {
00971             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d8/mi_8h.html#a324">MI_MAX_FREE_LIST_HEADS</a> - 1;
00972         }
00973 
00974         <span class="comment">//</span>
00975         <span class="comment">// NonPaged pool is linked together through the pages themselves.</span>
00976         <span class="comment">//</span>
00977 
00978         <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a324">MI_MAX_FREE_LIST_HEADS</a>) {
00979 
00980             Entry = <a class="code" href="../../d1/d6/allocpag_8c.html#a8">MmNonPagedPoolFreeListHead</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Flink;
00981 
00982             <span class="keywordflow">while</span> (Entry != &amp;<a class="code" href="../../d1/d6/allocpag_8c.html#a8">MmNonPagedPoolFreeListHead</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]) {
00983 
00984                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00985                     <a class="code" href="../../d5/d6/iosup_8c.html#a38">MiUnProtectFreeNonPagedPool</a> ((PVOID)Entry, 0);
00986                 }
00987     
00988                 <span class="comment">//</span>
00989                 <span class="comment">// The list is not empty, see if this one has enough space.</span>
00990                 <span class="comment">//</span>
00991     
00992                 FreePageInfo = CONTAINING_RECORD(Entry,
00993                                                  <a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html">MMFREE_POOL_ENTRY</a>,
00994                                                  List);
00995     
00996                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FreePageInfo-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o2">Signature</a> == MM_FREE_POOL_SIGNATURE);
00997                 <span class="keywordflow">if</span> (FreePageInfo-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">Size</a> &gt;= SizeInPages) {
00998     
00999                     <span class="comment">//</span>
01000                     <span class="comment">// This entry has sufficient space, remove</span>
01001                     <span class="comment">// the pages from the end of the allocation.</span>
01002                     <span class="comment">//</span>
01003     
01004                     FreePageInfo-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">Size</a> -= SizeInPages;
01005     
01006                     BaseVa = (PVOID)((PCHAR)FreePageInfo +
01007                                             (FreePageInfo-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">Size</a>  &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
01008     
01009                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01010                         RemoveEntryList (&amp;FreePageInfo-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o0">List</a>);
01011                     }
01012                     <span class="keywordflow">else</span> {
01013                         <a class="code" href="../../d1/d6/allocpag_8c.html#a47">MiProtectedPoolRemoveEntryList</a> (&amp;FreePageInfo-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o0">List</a>);
01014                     }
01015 
01016                     <span class="keywordflow">if</span> (FreePageInfo-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">Size</a> != 0) {
01017     
01018                         <span class="comment">//</span>
01019                         <span class="comment">// Insert any remainder into the correct list.</span>
01020                         <span class="comment">//</span>
01021     
01022                         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (ULONG)(FreePageInfo-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">Size</a> - 1);
01023                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a324">MI_MAX_FREE_LIST_HEADS</a>) {
01024                             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d8/mi_8h.html#a324">MI_MAX_FREE_LIST_HEADS</a> - 1;
01025                         }
01026 
01027                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01028                             InsertTailList (&amp;MmNonPagedPoolFreeListHead[Index],
01029                                             &amp;FreePageInfo-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o0">List</a>);
01030                         }
01031                         <span class="keywordflow">else</span> {
01032                             <a class="code" href="../../d1/d6/allocpag_8c.html#a46">MiProtectedPoolInsertList</a> (&amp;MmNonPagedPoolFreeListHead[Index],
01033                                                        &amp;FreePageInfo-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o0">List</a>,
01034                                                        FALSE);
01035 
01036                             <a class="code" href="../../d5/d6/iosup_8c.html#a37">MiProtectFreeNonPagedPool</a> ((PVOID)FreePageInfo,
01037                                                        (ULONG)FreePageInfo-&gt;Size);
01038                         }
01039                     }
01040     
01041                     <span class="comment">//</span>
01042                     <span class="comment">// Adjust the number of free pages remaining in the pool.</span>
01043                     <span class="comment">//</span>
01044     
01045                     <a class="code" href="../../d4/d8/mi_8h.html#a630">MmNumberOfFreeNonPagedPool</a> -= SizeInPages;
01046                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)MmNumberOfFreeNonPagedPool &gt;= 0);
01047     
01048                     <span class="comment">//</span>
01049                     <span class="comment">// Mark start and end of allocation in the PFN database.</span>
01050                     <span class="comment">//</span>
01051     
01052                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(BaseVa)) {
01053     
01054                         <span class="comment">//</span>
01055                         <span class="comment">// On certain architectures, virtual addresses</span>
01056                         <span class="comment">// may be physical and hence have no corresponding PTE.</span>
01057                         <span class="comment">//</span>
01058     
01059                         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (BaseVa);
01060                     } <span class="keywordflow">else</span> {
01061                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(BaseVa);
01062                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
01063                         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
01064                     }
01065                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01066     
01067                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation == 0);
01068                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation == 0);
01069     
01070                     <a class="code" href="../../d4/d8/mi_8h.html#a123">CONSISTENCY_LOCK_PFN2</a> (OldIrql);
01071     
01072                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
01073     
01074                     <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>) {
01075                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation = 1;
01076                     }
01077 
01078                     <a class="code" href="../../d4/d8/mi_8h.html#a124">CONSISTENCY_UNLOCK_PFN2</a> (OldIrql);
01079     
01080                     <span class="comment">//</span>
01081                     <span class="comment">// Mark this as a large session allocation in the PFN database.</span>
01082                     <span class="comment">//</span>
01083     
01084                     <span class="keywordflow">if</span> (IsLargeSessionAllocation != 0) {
01085                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation == 0);
01086     
01087                         <a class="code" href="../../d4/d8/mi_8h.html#a123">CONSISTENCY_LOCK_PFN2</a> (OldIrql);
01088     
01089                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation = 1;
01090     
01091                         <a class="code" href="../../d4/d8/mi_8h.html#a124">CONSISTENCY_UNLOCK_PFN2</a> (OldIrql);
01092     
01093                         <a class="code" href="../../d1/d6/allocpag_8c.html#a50">MiSessionPoolAllocated</a> (BaseVa,
01094                                                 SizeInPages &lt;&lt; PAGE_SHIFT,
01095                                                 NonPagedPool);
01096                     }
01097     
01098                     <span class="comment">//</span>
01099                     <span class="comment">// Calculate the ending PTE's address.</span>
01100                     <span class="comment">//</span>
01101     
01102                     <span class="keywordflow">if</span> (SizeInPages != 1) {
01103                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(BaseVa)) {
01104                             Pfn1 += SizeInPages - 1;
01105                         } <span class="keywordflow">else</span> {
01106                             PointerPte += SizeInPages - 1;
01107                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
01108                             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01109                         }
01110                     }
01111                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01112     
01113                        <span class="comment">//</span>
01114                        <span class="comment">// Map this with KSEG0 if possible.</span>
01115                        <span class="comment">//</span>
01116 <span class="preprocessor">#if defined (_X86_)</span>
01117 <span class="preprocessor"></span>                       <span class="keywordflow">if</span>  ((BaseVa &gt; (PVOID)<a class="code" href="../../d6/d8/mi386_8h.html#a11">MM_KSEG2_BASE</a>) &amp;&amp;
01118                             (PageFrameIndex &gt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a>(MmSubsectionBase)) &amp;&amp;
01119                             (PageFrameIndex &lt; <a class="code" href="../../d4/d8/mi_8h.html#a580">MmSubsectionTopPage</a>) &amp;&amp;
01120                             (<a class="code" href="../../d2/d2/data386_8c.html#a19">MmKseg2Frame</a> != 0))
01121 <span class="preprocessor">#elif defined (_ALPHA_)</span>
01122 <span class="preprocessor"></span>                       <span class="keywordflow">if</span>  ((BaseVa &gt; (PVOID)<a class="code" href="../../d6/d7/halmips_8h.html#a445">KSEG2_BASE</a>) &amp;&amp;
01123                             (PageFrameIndex &gt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a>(MmSubsectionBase)) &amp;&amp;
01124                             (PageFrameIndex &lt; <a class="code" href="../../d4/d8/mi_8h.html#a580">MmSubsectionTopPage</a>))
01125 <span class="preprocessor">#else</span>
01126 <span class="preprocessor"></span>                       <span class="keywordflow">if</span>  ((BaseVa &gt; (PVOID)<a class="code" href="../../d6/d7/halmips_8h.html#a445">KSEG2_BASE</a>) &amp;&amp;
01127                             (PageFrameIndex &lt; <a class="code" href="../../d4/d8/mi_8h.html#a580">MmSubsectionTopPage</a>))
01128 <span class="preprocessor">#endif</span>
01129 <span class="preprocessor"></span>                       {
01130                            BaseVa = (PVOID)(<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> + (PageFrameIndex &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
01131                        }
01132                     }
01133     
01134                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation == 0);
01135     
01136                     <a class="code" href="../../d4/d8/mi_8h.html#a123">CONSISTENCY_LOCK_PFN2</a> (OldIrql);
01137     
01138                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
01139     
01140                     <a class="code" href="../../d4/d8/mi_8h.html#a124">CONSISTENCY_UNLOCK_PFN2</a> (OldIrql);
01141     
01142                     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a52">MmAllocatedNonPagedPool</a> += SizeInPages;
01143                     <span class="keywordflow">return</span> BaseVa;
01144                 }
01145     
01146                 Entry = FreePageInfo-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o0">List</a>.Flink;
01147     
01148                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01149                     <a class="code" href="../../d5/d6/iosup_8c.html#a37">MiProtectFreeNonPagedPool</a> ((PVOID)FreePageInfo,
01150                                                (ULONG)FreePageInfo-&gt;Size);
01151                 }
01152             }
01153             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
01154         }
01155 
01156         <span class="comment">//</span>
01157         <span class="comment">// No more entries on the list, expand nonpaged pool if</span>
01158         <span class="comment">// possible to satisfy this request.</span>
01159         <span class="comment">//</span>
01160 
01161         <span class="comment">//</span>
01162         <span class="comment">// Check to see if there are too many unused segments laying</span>
01163         <span class="comment">// around.  If so, set an event so they get deleted.</span>
01164         <span class="comment">//</span>
01165 
01166         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a328">MI_UNUSED_SEGMENTS_SURPLUS</a>()) {
01167             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmUnusedSegmentCleanup, 0, FALSE);
01168         }
01169 
01170         <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
01171 
01172         <span class="comment">//</span>
01173         <span class="comment">// Make sure we have 1 more than the number of pages</span>
01174         <span class="comment">// requested available.</span>
01175         <span class="comment">//</span>
01176 
01177         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt;= SizeInPages) {
01178 
01179             <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
01180 
01181             <span class="comment">//</span>
01182             <span class="comment">// There are no free physical pages to expand</span>
01183             <span class="comment">// nonpaged pool.</span>
01184             <span class="comment">//</span>
01185 
01186             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01187         }
01188 
01189         <span class="comment">//</span>
01190         <span class="comment">// Try to find system PTEs to expand the pool into.</span>
01191         <span class="comment">//</span>
01192 
01193         StartingPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> ((ULONG)SizeInPages,
01194                                            NonPagedPoolExpansion,
01195                                            0,
01196                                            0,
01197                                            FALSE);
01198 
01199         <span class="keywordflow">if</span> (StartingPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01200 
01201             <span class="comment">//</span>
01202             <span class="comment">// There are no free physical PTEs to expand nonpaged pool.</span>
01203             <span class="comment">// If there are any cached expansion PTEs, free them now in</span>
01204             <span class="comment">// an attempt to get enough contiguous VA for our caller.</span>
01205             <span class="comment">//</span>
01206 
01207             <span class="keywordflow">if</span> ((SizeInPages &gt; 1) &amp;&amp; (<a class="code" href="../../d4/d8/mi_8h.html#a630">MmNumberOfFreeNonPagedPool</a> != 0)) {
01208 
01209                 FreedPool = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01210 
01211                 <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a324">MI_MAX_FREE_LIST_HEADS</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
01212         
01213                     Entry = <a class="code" href="../../d1/d6/allocpag_8c.html#a8">MmNonPagedPoolFreeListHead</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Flink;
01214         
01215                     <span class="keywordflow">while</span> (Entry != &amp;<a class="code" href="../../d1/d6/allocpag_8c.html#a8">MmNonPagedPoolFreeListHead</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]) {
01216         
01217                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01218                             <a class="code" href="../../d5/d6/iosup_8c.html#a38">MiUnProtectFreeNonPagedPool</a> ((PVOID)Entry, 0);
01219                         }
01220 
01221                         <span class="comment">//</span>
01222                         <span class="comment">// The list is not empty, see if this one is virtually</span>
01223                         <span class="comment">// mapped.</span>
01224                         <span class="comment">//</span>
01225             
01226                         FreePageInfo = CONTAINING_RECORD(Entry,
01227                                                          <a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html">MMFREE_POOL_ENTRY</a>,
01228                                                          List);
01229             
01230                         <span class="keywordflow">if</span> ((!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(FreePageInfo)) &amp;&amp;
01231                             ((PVOID)FreePageInfo &gt;= <a class="code" href="../../d1/d6/allocpag_8c.html#a7">MmNonPagedPoolExpansionStart</a>)) {
01232                             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01233                                 RemoveEntryList (&amp;FreePageInfo-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o0">List</a>);
01234                             }
01235                             <span class="keywordflow">else</span> {
01236                                 <a class="code" href="../../d1/d6/allocpag_8c.html#a47">MiProtectedPoolRemoveEntryList</a> (&amp;FreePageInfo-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o0">List</a>);
01237                             }
01238 
01239                             <a class="code" href="../../d4/d8/mi_8h.html#a630">MmNumberOfFreeNonPagedPool</a> -= FreePageInfo-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">Size</a>;
01240                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)MmNumberOfFreeNonPagedPool &gt;= 0);
01241     
01242                             <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
01243 
01244                             FreedPool = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01245 
01246                             <a class="code" href="../../d1/d6/allocpag_8c.html#a53">MiFreeNonPagedPool</a> ((PVOID)FreePageInfo,
01247                                                 FreePageInfo-&gt;Size);
01248 
01249                             <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
01250                             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
01251                             <span class="keywordflow">break</span>;
01252                         }
01253 
01254                         Entry = FreePageInfo-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o0">List</a>.Flink;
01255         
01256                         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01257                             <a class="code" href="../../d5/d6/iosup_8c.html#a37">MiProtectFreeNonPagedPool</a> ((PVOID)FreePageInfo,
01258                                                        (ULONG)FreePageInfo-&gt;Size);
01259                         }
01260                     }
01261                 }
01262 
01263                 <span class="keywordflow">if</span> (FreedPool == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01264                     StartingPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> ((ULONG)SizeInPages,
01265                                                        NonPagedPoolExpansion,
01266                                                        0,
01267                                                        0,
01268                                                        FALSE);
01269             
01270                     <span class="keywordflow">if</span> (StartingPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01271                         <span class="keywordflow">goto</span> gotpool;
01272                     }
01273                 }
01274             }
01275 
01276             <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
01277 
01278 nopool:
01279 
01280             <span class="comment">//</span>
01281             <span class="comment">// Running low on pool - if this request is not for session pool,</span>
01282             <span class="comment">// force unused segment trimming when appropriate.</span>
01283             <span class="comment">//</span>
01284         
01285             SignalDereferenceThread = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01286             <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
01287             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/allocpag_8c.html#a11">MmUnusedSegmentForceFree</a> == 0) {
01288                 <span class="keywordflow">if</span> (!IsListEmpty(&amp;MmUnusedSegmentList)) {
01289                     SignalDereferenceThread = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01290                     <a class="code" href="../../d1/d6/allocpag_8c.html#a11">MmUnusedSegmentForceFree</a> = 30;
01291                 }
01292             }
01293             <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
01294             <span class="keywordflow">if</span> (SignalDereferenceThread == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01295                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmUnusedSegmentCleanup, 0, FALSE);
01296             }
01297 
01298             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01299         }
01300 
01301 gotpool:
01302 
01303         <span class="comment">//</span>
01304         <span class="comment">// Update the count of available resident pages.</span>
01305         <span class="comment">//</span>
01306 
01307         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= SizeInPages;
01308         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(0, SizeInPages);
01309 
01310         <span class="comment">//</span>
01311         <span class="comment">// Charge commitment as non paged pool uses physical memory.</span>
01312         <span class="comment">//</span>
01313 
01314         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_NONPAGED_POOL_EXPANSION, SizeInPages);
01315 
01316         <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (SizeInPages, TRUE);
01317 
01318         <span class="comment">//</span>
01319         <span class="comment">//  Expand the pool.</span>
01320         <span class="comment">//</span>
01321 
01322         PointerPte = StartingPte;
01323         TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
01324         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a52">MmAllocatedNonPagedPool</a> += SizeInPages;
01325         i = SizeInPages;
01326 
01327         <span class="keywordflow">do</span> {
01328             PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (
01329                                 MI_GET_PAGE_COLOR_FROM_PTE (PointerPte));
01330 
01331             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01332 
01333             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
01334             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 1;
01335             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPte;
01336             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
01337             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte));
01338 
01339             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01340             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation = 0;
01341             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation = 0;
01342 
01343             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
01344             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
01345             PointerPte += 1;
01346             SizeInPages -= 1;
01347         } <span class="keywordflow">while</span> (SizeInPages &gt; 0);
01348 
01349         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
01350 
01351         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (StartingPte-&gt;u.Hard.PageFrameNumber);
01352         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
01353 
01354         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation == 0);
01355 
01356         <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>) {
01357             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation = 1;
01358         }
01359 
01360         <span class="comment">//</span>
01361         <span class="comment">// Mark this as a large session allocation in the PFN database.</span>
01362         <span class="comment">//</span>
01363 
01364         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation == 0);
01365 
01366         <span class="keywordflow">if</span> (IsLargeSessionAllocation != 0) {
01367             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation = 1;
01368 
01369             <a class="code" href="../../d1/d6/allocpag_8c.html#a50">MiSessionPoolAllocated</a>(MiGetVirtualAddressMappedByPte (StartingPte),
01370                                    i &lt;&lt; PAGE_SHIFT,
01371                                    NonPagedPool);
01372         }
01373 
01374         <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
01375 
01376         BaseVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (StartingPte);
01377 
01378         <span class="keywordflow">if</span> (i == 1) {
01379 
01380             <span class="comment">//</span>
01381             <span class="comment">// Map this with KSEG0 if possible.</span>
01382             <span class="comment">//</span>
01383 
01384 <span class="preprocessor">#if defined (_X86_)</span>
01385 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((PageFrameIndex &gt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a>(MmSubsectionBase)) &amp;&amp;
01386                 (PageFrameIndex &lt; <a class="code" href="../../d4/d8/mi_8h.html#a580">MmSubsectionTopPage</a>) &amp;&amp;
01387                 (<a class="code" href="../../d2/d2/data386_8c.html#a19">MmKseg2Frame</a> != 0))
01388 <span class="preprocessor">#elif defined (_ALPHA_)</span>
01389 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((PageFrameIndex &gt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a>(MmSubsectionBase)) &amp;&amp;
01390                 (PageFrameIndex &lt; <a class="code" href="../../d4/d8/mi_8h.html#a580">MmSubsectionTopPage</a>))
01391 <span class="preprocessor">#else</span>
01392 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (PageFrameIndex &lt; <a class="code" href="../../d4/d8/mi_8h.html#a580">MmSubsectionTopPage</a>)
01393 <span class="preprocessor">#endif</span>
01394 <span class="preprocessor"></span>            {
01395                  BaseVa = (PVOID)(<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> + (PageFrameIndex &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
01396             }
01397         }
01398 
01399         <span class="keywordflow">return</span> BaseVa;
01400     }
01401 
01402     <span class="comment">//</span>
01403     <span class="comment">// Paged Pool.</span>
01404     <span class="comment">//</span>
01405 
01406     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>) == 0) {
01407         SessionSpace = (<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a>)0;
01408         PagedPoolInfo = &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a27">MmPagedPoolInfo</a>;
01409     }
01410     <span class="keywordflow">else</span> {
01411         SessionSpace = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>;
01412         PagedPoolInfo = &amp;SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o21">PagedPoolInfo</a>;
01413     }
01414 
01415     StartPosition = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a31">RtlFindClearBitsAndSet</a> (
01416                                PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o0">PagedPoolAllocationMap</a>,
01417                                (ULONG)SizeInPages,
01418                                PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o6">PagedPoolHint</a>
01419                                );
01420 
01421     <span class="keywordflow">if</span> ((StartPosition == 0xFFFFFFFF) &amp;&amp; (PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o6">PagedPoolHint</a> != 0)) {
01422 
01423         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a328">MI_UNUSED_SEGMENTS_SURPLUS</a>()) {
01424             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmUnusedSegmentCleanup, 0, FALSE);
01425         }
01426 
01427         <span class="comment">//</span>
01428         <span class="comment">// No free bits were found, check from the start of</span>
01429         <span class="comment">// the bit map.</span>
01430 
01431         StartPosition = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a31">RtlFindClearBitsAndSet</a> (
01432                                    PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o0">PagedPoolAllocationMap</a>,
01433                                    (ULONG)SizeInPages,
01434                                    0
01435                                    );
01436     }
01437 
01438     <span class="comment">//</span>
01439     <span class="comment">// If start position = -1, no room in pool.  Attempt to expand PagedPool.</span>
01440     <span class="comment">//</span>
01441 
01442     <span class="keywordflow">if</span> (StartPosition == 0xFFFFFFFF) {
01443 
01444         <span class="comment">//</span>
01445         <span class="comment">// Attempt to expand the paged pool.</span>
01446         <span class="comment">//</span>
01447 
01448         StartPosition = (((ULONG)SizeInPages - 1) / <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>) + 1;
01449 
01450         <span class="comment">//</span>
01451         <span class="comment">// Make sure there is enough space to create the prototype PTEs.</span>
01452         <span class="comment">//</span>
01453 
01454         <span class="keywordflow">if</span> (((StartPosition - 1) + PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o5">NextPdeForPagedPoolExpansion</a>) &gt;
01455             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o4">LastPteForPagedPool</a>)) {
01456 
01457             <span class="comment">//</span>
01458             <span class="comment">// Can't expand pool any more.  If this request is not for session</span>
01459             <span class="comment">// pool, force unused segment trimming when appropriate.</span>
01460             <span class="comment">//</span>
01461 
01462             <span class="keywordflow">if</span> (SessionSpace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01463                 <span class="keywordflow">goto</span> nopool;
01464             }
01465 
01466             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01467         }
01468 
01469         <span class="keywordflow">if</span> (SessionSpace) {
01470             TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a8">ValidKernelPdeLocal</a>;
01471             PageTableCount = StartPosition;
01472         }
01473         <span class="keywordflow">else</span> {
01474             TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a7">ValidKernelPde</a>;
01475         }
01476 
01477         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01478 
01479         <span class="comment">//</span>
01480         <span class="comment">// Make sure we have 1 more than the number of pages</span>
01481         <span class="comment">// requested available.</span>
01482         <span class="comment">//</span>
01483 
01484         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt;= StartPosition) {
01485 
01486             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01487 
01488             <span class="comment">//</span>
01489             <span class="comment">// There are no free physical pages to expand</span>
01490             <span class="comment">// paged pool.</span>
01491             <span class="comment">//</span>
01492 
01493             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01494         }
01495 
01496         <span class="comment">//</span>
01497         <span class="comment">// Update the count of available resident pages.</span>
01498         <span class="comment">//</span>
01499 
01500         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= StartPosition;
01501         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(1, StartPosition);
01502 
01503         <span class="comment">//</span>
01504         <span class="comment">//  Expand the pool.</span>
01505         <span class="comment">//</span>
01506 
01507         EndPosition = (ULONG)((PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o5">NextPdeForPagedPoolExpansion</a> -
01508                           <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o3">FirstPteForPagedPool</a>)) *
01509                           <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>);
01510 
01511         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o0">PagedPoolAllocationMap</a>,
01512                       EndPosition,
01513                       (ULONG) StartPosition * PTE_PER_PAGE);
01514 
01515         PointerPte = PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o5">NextPdeForPagedPoolExpansion</a>;
01516         StartingPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte);
01517         PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o5">NextPdeForPagedPoolExpansion</a> += StartPosition;
01518 
01519         <span class="keywordflow">do</span> {
01520             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
01521 
01522             <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_PAGED_POOL_PAGETABLE, 1);
01523 
01524             <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (1, TRUE);
01525 
01526             PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (
01527                                 MI_GET_PAGE_COLOR_FROM_PTE (PointerPte));
01528 
01529             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
01530             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
01531 
01532             <span class="comment">//</span>
01533             <span class="comment">// Map valid PDE into system (or session) address space as well.</span>
01534             <span class="comment">//</span>
01535 
01536             VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
01537 
01538 <span class="preprocessor">#if defined (_WIN64)</span>
01539 <span class="preprocessor"></span>
01540             <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex,
01541                              PointerPte,
01542                              1);
01543 
01544 <span class="preprocessor">#else</span>
01545 <span class="preprocessor"></span>
01546             <span class="keywordflow">if</span> (SessionSpace) {
01547 
01548                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (ULONG)(PointerPte - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MmSessionBase));
01549                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>[Index].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0);
01550                 <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = TempPte;
01551 
01552                 <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (PageFrameIndex,
01553                                                 PointerPte,
01554                                                 <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o5">SessionPageDirectoryIndex</a>);
01555 
01556                 <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a>(MM_DBG_SESSION_PAGEDPOOL_PAGETABLE_ALLOC1, 1);
01557             }
01558             <span class="keywordflow">else</span> {
01559 <span class="preprocessor">#if !defined (_X86PAE_)</span>
01560 <span class="preprocessor"></span>                <a class="code" href="../../d4/d8/mi_8h.html#a636">MmSystemPagePtes</a> [((ULONG_PTR)PointerPte &amp;
01561                     ((<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>) * <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a>) - 1)) / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)] =
01562                                      TempPte;
01563                 <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (PageFrameIndex,
01564                                                 PointerPte,
01565                                                 MmSystemPageDirectory);
01566 <span class="preprocessor">#else</span>
01567 <span class="preprocessor"></span>                <a class="code" href="../../d4/d8/mi_8h.html#a636">MmSystemPagePtes</a> [((ULONG_PTR)PointerPte &amp;
01568                     (PD_PER_SYSTEM * (<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>) * <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a>) - 1)) / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)] =
01569                                      TempPte;
01570                 <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (PageFrameIndex,
01571                                                 PointerPte,
01572                                                 MmSystemPageDirectory[(PointerPte - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(0)) / PDE_PER_PAGE]);
01573 <span class="preprocessor">#endif</span>
01574 <span class="preprocessor"></span>            }
01575 <span class="preprocessor">#endif</span>
01576 <span class="preprocessor"></span>
01577             KeFillEntryTb ((PHARDWARE_PTE) PointerPte, VirtualAddress, FALSE);
01578 
01579             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (StartingPte,
01580                              PAGE_SIZE,
01581                              MM_KERNEL_NOACCESS_PTE);
01582 
01583             PointerPte += 1;
01584             StartingPte += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>);
01585             StartPosition -= 1;
01586         } <span class="keywordflow">while</span> (StartPosition &gt; 0);
01587 
01588         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01589 
01590         <span class="keywordflow">if</span> (SessionSpace) {
01591 
01592             PointerPte -= PageTableCount;
01593 
01594             <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (SessionIrql);
01595 
01596             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> += PageTableCount;
01597             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> += PageTableCount;
01598 
01599             <span class="keywordflow">do</span> {
01600                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01601     
01602                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event == 0);
01603                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID) <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
01604     
01605                 SessionPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
01606     
01607                 <a class="code" href="../../d8/d2/pagfault_8c.html#a28">MiAddValidPageToWorkingSet</a> (SessionPte,
01608                                             PointerPte,
01609                                             Pfn1,
01610                                             0);
01611     
01612                 WsEntry = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (SessionPte,
01613                                         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>,
01614                                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
01615     
01616                 <span class="keywordflow">if</span> (WsEntry &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
01617         
01618                     WsSwapEntry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
01619         
01620                     <span class="keywordflow">if</span> (WsEntry != <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
01621         
01622                         <span class="comment">//</span>
01623                         <span class="comment">// Swap this entry with the one at first dynamic.</span>
01624                         <span class="comment">//</span>
01625         
01626                         <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (WsEntry, WsSwapEntry, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>);
01627                     }
01628         
01629                     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> += 1;
01630                 }
01631                 <span class="keywordflow">else</span> {
01632                     WsSwapEntry = WsEntry;
01633                 }
01634         
01635                 <span class="comment">//</span>
01636                 <span class="comment">// Indicate that the page is locked.</span>
01637                 <span class="comment">//</span>
01638         
01639                 <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>[WsSwapEntry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01640     
01641                 PointerPte += 1;
01642                 PageTableCount -= 1;
01643             } <span class="keywordflow">while</span> (PageTableCount &gt; 0);
01644             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (SessionIrql);
01645         }
01646 
01647         StartPosition = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a31">RtlFindClearBitsAndSet</a> (
01648                                    PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o0">PagedPoolAllocationMap</a>,
01649                                    (ULONG)SizeInPages,
01650                                    EndPosition
01651                                    );
01652 
01653         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPosition != 0xffffffff);
01654     }
01655 
01656     <span class="comment">//</span>
01657     <span class="comment">// This is paged pool, the start and end can't be saved</span>
01658     <span class="comment">// in the PFN database as the page isn't always resident</span>
01659     <span class="comment">// in memory.  The ideal place to save the start and end</span>
01660     <span class="comment">// would be in the prototype PTE, but there are no free</span>
01661     <span class="comment">// bits.  To solve this problem, a bitmap which parallels</span>
01662     <span class="comment">// the allocation bitmap exists which contains set bits</span>
01663     <span class="comment">// in the positions where an allocation ends.  This</span>
01664     <span class="comment">// allows pages to be deallocated with only their starting</span>
01665     <span class="comment">// address.</span>
01666     <span class="comment">//</span>
01667     <span class="comment">// For sanity's sake, the starting address can be verified</span>
01668     <span class="comment">// from the 2 bitmaps as well.  If the page before the starting</span>
01669     <span class="comment">// address is not allocated (bit is zero in allocation bitmap)</span>
01670     <span class="comment">// then this page is obviously a start of an allocation block.</span>
01671     <span class="comment">// If the page before is allocated and the other bit map does</span>
01672     <span class="comment">// not indicate the previous page is the end of an allocation,</span>
01673     <span class="comment">// then the starting address is wrong and a bug check should</span>
01674     <span class="comment">// be issued.</span>
01675     <span class="comment">//</span>
01676 
01677     <span class="keywordflow">if</span> (SizeInPages == 1) {
01678         PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o6">PagedPoolHint</a> = StartPosition + (ULONG)SizeInPages;
01679     }
01680 
01681     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (SizeInPages, FALSE) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01682         Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
01683         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/allocpag_8c.html#a1">MI_MEMORY_MAKER</a>(Thread)) {
01684             <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (SizeInPages, TRUE);
01685         }
01686         <span class="keywordflow">else</span> {
01687             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o0">PagedPoolAllocationMap</a>,
01688                           StartPosition,
01689                           (ULONG)SizeInPages);
01690     
01691             <span class="comment">//</span>
01692             <span class="comment">// Could not commit the page(s), return NULL indicating</span>
01693             <span class="comment">// no pool was allocated.  Note that the lack of commit may be due</span>
01694             <span class="comment">// to unused segments and the MmSharedCommit, prototype PTEs, etc</span>
01695             <span class="comment">// associated with them.  So force a reduction now.</span>
01696             <span class="comment">//</span>
01697     
01698             <a class="code" href="../../d6/d3/modwrite_8c.html#a59">MiIssuePageExtendRequestNoWait</a> (SizeInPages);
01699 
01700             SignalDereferenceThread = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01701             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01702             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/allocpag_8c.html#a11">MmUnusedSegmentForceFree</a> == 0) {
01703                 <span class="keywordflow">if</span> (!IsListEmpty(&amp;MmUnusedSegmentList)) {
01704                     SignalDereferenceThread = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01705                     <a class="code" href="../../d1/d6/allocpag_8c.html#a11">MmUnusedSegmentForceFree</a> = 30;
01706                 }
01707             }
01708             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01709             <span class="keywordflow">if</span> (SignalDereferenceThread == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01710                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmUnusedSegmentCleanup, 0, FALSE);
01711             }
01712 
01713             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01714         }
01715     }
01716 
01717     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_PAGED_POOL_PAGES, SizeInPages);
01718 
01719     <span class="keywordflow">if</span> (SessionSpace) {
01720         <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
01721         SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> += SizeInPages;
01722         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a>(MM_DBG_SESSION_COMMIT_PAGEDPOOL_PAGES, SizeInPages);
01723         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
01724         BaseVa = (PVOID)((PCHAR)SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o18">PagedPoolStart</a> +
01725                                 (StartPosition &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
01726     }
01727     <span class="keywordflow">else</span> {
01728         <a class="code" href="../../d8/d5/kddata_8c.html#a34">MmPagedPoolCommit</a> += (ULONG)SizeInPages;
01729         BaseVa = (PVOID)((PUCHAR)<a class="code" href="../../d4/d8/mi_8h.html#a653">MmPageAlignedPoolBase</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>] +
01730                                 (StartPosition &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
01731     }
01732 
01733 <span class="preprocessor">#if DBG</span>
01734 <span class="preprocessor"></span>    PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseVa);
01735     <span class="keywordflow">for</span> (i = 0; i &lt; SizeInPages; i += 1) {
01736         <span class="keywordflow">if</span> (*(ULONG *)PointerPte != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a97">MM_KERNEL_NOACCESS_PTE</a>) {
01737             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiAllocatePoolPages: PP not zero PTE (%x %x %x)\n"</span>,
01738                 BaseVa, PointerPte, *PointerPte);
01739             DbgBreakPoint();
01740         }
01741         PointerPte += 1;
01742     }
01743 <span class="preprocessor">#endif</span>
01744 <span class="preprocessor"></span>    PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseVa);
01745     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (PointerPte,
01746                      SizeInPages * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>),
01747                      MM_KERNEL_DEMAND_ZERO_PTE);
01748 
01749     PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o7">PagedPoolCommit</a> += SizeInPages;
01750     EndPosition = StartPosition + (ULONG)SizeInPages - 1;
01751     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a34">RtlSetBits</a> (PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o1">EndOfPagedPoolBitmap</a>, EndPosition, 1L);
01752 
01753     <span class="comment">//</span>
01754     <span class="comment">// Mark this as a large session allocation in the PFN database.</span>
01755     <span class="comment">//</span>
01756 
01757     <span class="keywordflow">if</span> (IsLargeSessionAllocation != 0) {
01758         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a34">RtlSetBits</a> (PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o2">PagedPoolLargeSessionAllocationMap</a>,
01759                     StartPosition,
01760                     1L);
01761 
01762         <a class="code" href="../../d1/d6/allocpag_8c.html#a50">MiSessionPoolAllocated</a> (BaseVa,
01763                                 SizeInPages &lt;&lt; PAGE_SHIFT,
01764                                 PagedPool);
01765     }
01766     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>) {
01767         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a34">RtlSetBits</a> (VerifierLargePagedPoolMap,
01768                     StartPosition,
01769                     1L);
01770     }
01771 
01772     PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o8">AllocatedPagedPool</a> += SizeInPages;
01773 
01774     <span class="keywordflow">return</span> BaseVa;
01775 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a202" doxytag="mm.h::MiFreePoolPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiFreePoolPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>StartingAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/allocpag_8c-source.html#l01778">1778</a> of file <a class="el" href="../../d2/d5/allocpag_8c-source.html">allocpag.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l04726">_MM_PAGED_POOL_INFO::AllocatedPagedPool</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05471">_MM_SESSION_SPACE::CommittedPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00878">CONSISTENCY_LOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00879">CONSISTENCY_UNLOCK_PFN2</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04719">_MM_PAGED_POOL_INFO::EndOfPagedPoolBitmap</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04721">_MM_PAGED_POOL_INFO::FirstPteForPagedPool</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02590">_MMFREE_POOL_ENTRY::List</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02287">MI_CONVERT_PHYSICAL_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05290">MI_IS_SESSION_POOL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01219">MI_MAGIC_AWE_PTEFRAME</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04688">MI_MAX_FREE_LIST_HEADS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">MiDeleteSystemPagableVm()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00112">MiEndOfInitialPoolFrame</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00708">MiFreeNonPagedPool()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00282">MiProtectedPoolInsertList()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00365">MiProtectedPoolRemoveEntryList()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00150">MiProtectFreeNonPagedPool()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00547">MiSessionPoolFreed()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00209">MiUnProtectFreeNonPagedPool()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05361">MM_BUMP_SESS_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04277">MM_DBG_COMMIT_RETURN_PAGED_POOL_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05325">MM_DBG_SESSION_COMMIT_POOL_FREED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00080">MM_FREE_POOL_SIGNATURE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00431">MM_KERNEL_NOACCESS_PTE</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00122">MM_SMALL_ALLOCATIONS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00098">MmAllocatedNonPagedPool</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04656">MmExpandedPoolBitPosition</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04660">MmMustSucceedPoolBitPosition</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04710">MmNonPagedMustSucceed</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00065">MmNonPagedPoolEnd</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00114">MmNonPagedPoolExpansionStart</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00116">MmNonPagedPoolFreeListHead</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00064">MmNonPagedPoolStart</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04658">MmNumberOfFreeNonPagedPool</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04732">MmPageAlignedPoolBase</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00077">MmPagedPoolCommit</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00068">MmPagedPoolEnd</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00069">MmPagedPoolInfo</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00067">MmPagedPoolStart</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00075">MmPfnDatabase</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00092">MmProtectFreedNonPagedPool</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00075">MmSizeOfNonPagedPoolInBytes</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00074">MmSizeOfPagedPoolInBytes</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00081">NoAccessPte</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02593">_MMFREE_POOL_ENTRY::Owner</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04718">_MM_PAGED_POOL_INFO::PagedPoolAllocationMap</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04725">_MM_PAGED_POOL_INFO::PagedPoolCommit</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04724">_MM_PAGED_POOL_INFO::PagedPoolHint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05520">_MM_SESSION_SPACE::PagedPoolInfo</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04720">_MM_PAGED_POOL_INFO::PagedPoolLargeSessionAllocationMap</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05505">_MM_SESSION_SPACE::PagedPoolStart</a>, <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01508">RtlClearBits()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02592">_MMFREE_POOL_ENTRY::Signature</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02591">_MMFREE_POOL_ENTRY::Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a91">VerifierFreeTrackedPool()</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l04734">VerifierLargePagedPoolMap</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/poolhack_8c-source.html#l01177">DeallocatePoolInternal()</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00970">ExFreePool()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02324">ExpAddTagForBigPages()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02000">ExpInsertPoolTracker()</a>, and <a class="el" href="../../d2/d1/mm_2i386_2init386_8c-source.html#l00058">MiInitMachineDependent()</a>.
<p>
<pre class="fragment"><div>01784                    :
01785 
01786     This function returns a set of pages back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> from
01787     which they were obtained.  Once <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages have been deallocated
01788     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region provided by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation becomes available <span class="keywordflow">for</span>
01789     allocation to other callers, i.e. any data in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> now
01790     trashed and cannot be referenced.
01791 
01792 Arguments:
01793 
01794     StartingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting address which was returned
01795                       in a previous call to <a class="code" href="../../d2/d1/mm_8h.html#a201">MiAllocatePoolPages</a>.
01796 
01797 Return Value:
01798 
01799     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of pages deallocated.
01800 
01801 Environment:
01802 
01803     These <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> are used by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> general <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocation <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>
01804     and should not be called directly.
01805 
01806     Mutexes guarding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> databases must be held when calling
01807     these <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a>.
01808 
01809 --*/
01810 
01811 {
01812     ULONG StartPosition;
01813     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01814     PFN_NUMBER i;
01815     PFN_NUMBER NumberOfPages;
01816     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType;
01817     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01818     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01819     PFN_NUMBER PageFrameIndex;
01820     KIRQL OldIrql;
01821     ULONG IsLargeSessionAllocation;
01822     ULONG IsLargeVerifierAllocation;
01823     <a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html">PMMFREE_POOL_ENTRY</a> Entry;
01824     <a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html">PMMFREE_POOL_ENTRY</a> NextEntry;
01825     <a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html">PMM_PAGED_POOL_INFO</a> PagedPoolInfo;
01826     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionSpace;
01827     LOGICAL SessionAllocation;
01828     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a13">NoAccessPte</a>;
01829     PFN_NUMBER PagesFreed;
01830 
01831     NumberOfPages = 1;
01832 
01833     <span class="comment">//</span>
01834     <span class="comment">// Determine Pool type base on the virtual address of the block</span>
01835     <span class="comment">// to deallocate.</span>
01836     <span class="comment">//</span>
01837     <span class="comment">// This assumes NonPagedPool starts at a higher virtual address</span>
01838     <span class="comment">// then PagedPool.</span>
01839     <span class="comment">//</span>
01840 
01841     <span class="keywordflow">if</span> ((StartingAddress &gt;= <a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>) &amp;&amp;
01842         (StartingAddress &lt;= <a class="code" href="../../d8/d5/kddata_8c.html#a26">MmPagedPoolEnd</a>)) {
01843         PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
01844         SessionSpace = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01845         PagedPoolInfo = &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a27">MmPagedPoolInfo</a>;
01846         StartPosition = (ULONG)(((PCHAR)StartingAddress -
01847                           (PCHAR)<a class="code" href="../../d4/d8/mi_8h.html#a653">MmPageAlignedPoolBase</a>[PoolType]) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01848     }
01849     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a353">MI_IS_SESSION_POOL_ADDRESS</a> (StartingAddress) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01850         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
01851         PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
01852         SessionSpace = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>;
01853         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SessionSpace);
01854         PagedPoolInfo = &amp;SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o21">PagedPoolInfo</a>;
01855         StartPosition = (ULONG)(((PCHAR)StartingAddress -
01856                           (PCHAR)SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o18">PagedPoolStart</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01857     }
01858     <span class="keywordflow">else</span> {
01859 
01860         <span class="keywordflow">if</span> (StartingAddress &lt; MM_SYSTEM_RANGE_START) {
01861             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (BAD_POOL_CALLER,
01862                           0x40,
01863                           (ULONG_PTR)StartingAddress,
01864                           (ULONG_PTR)MM_SYSTEM_RANGE_START,
01865                           0);
01866         }
01867 
01868         PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
01869         SessionSpace = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01870         PagedPoolInfo = &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a27">MmPagedPoolInfo</a>;
01871         StartPosition = (ULONG)(((PCHAR)StartingAddress -
01872                           (PCHAR)<a class="code" href="../../d4/d8/mi_8h.html#a653">MmPageAlignedPoolBase</a>[PoolType]) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01873     }
01874 
01875     <span class="comment">//</span>
01876     <span class="comment">// Check to ensure this page is really the start of an allocation.</span>
01877     <span class="comment">//</span>
01878 
01879     <span class="keywordflow">if</span> (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {
01880 
01881         <span class="keywordflow">if</span> (StartPosition &lt; <a class="code" href="../../d4/d8/mi_8h.html#a631">MmMustSucceedPoolBitPosition</a>) {
01882 
01883             PULONG_PTR NextList;
01884 
01885             <span class="comment">//</span>
01886             <span class="comment">// This is must succeed pool, don't free it, just</span>
01887             <span class="comment">// add it to the front of the list.</span>
01888             <span class="comment">//</span>
01889             <span class="comment">// Note - only a single page can be released at a time.</span>
01890             <span class="comment">//</span>
01891 
01892             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(StartingAddress)) {
01893                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (StartingAddress);
01894             } <span class="keywordflow">else</span> {
01895                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(StartingAddress);
01896                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
01897                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
01898             }
01899             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01900     
01901             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation == 1) {
01902                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation = 0;
01903                 <a class="code" href="../../d9/d5/verifier_8c.html#a91">VerifierFreeTrackedPool</a> (StartingAddress,
01904                                          PAGE_SIZE,
01905                                          NonPagedPool,
01906                                          FALSE);
01907             }
01908 
01909             <span class="comment">//</span>
01910             <span class="comment">// Check for this being a large session allocation. If it is,</span>
01911             <span class="comment">// we need to return the pool charge accordingly.</span>
01912             <span class="comment">//</span>
01913 
01914             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation) {
01915                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation = 0;
01916                 <a class="code" href="../../d1/d6/allocpag_8c.html#a51">MiSessionPoolFreed</a> (StartingAddress,
01917                                     PAGE_SIZE,
01918                                     NonPagedPool);
01919             }
01920 
01921             NextList = (PULONG_PTR)StartingAddress;
01922             *NextList = (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a649">MmNonPagedMustSucceed</a>;
01923             <a class="code" href="../../d4/d8/mi_8h.html#a649">MmNonPagedMustSucceed</a> = StartingAddress;
01924             <span class="keywordflow">return</span> (ULONG)NumberOfPages;
01925         }
01926 
01927         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a> (StartingAddress)) {
01928 
01929             <span class="comment">//</span>
01930             <span class="comment">// On certain architectures, virtual addresses</span>
01931             <span class="comment">// may be physical and hence have no corresponding PTE.</span>
01932             <span class="comment">//</span>
01933 
01934             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MI_CONVERT_PHYSICAL_TO_PFN (StartingAddress));
01935             <span class="keywordflow">if</span> (StartPosition &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a629">MmExpandedPoolBitPosition</a>) {
01936                 PointerPte = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
01937                 StartingAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
01938             }
01939         } <span class="keywordflow">else</span> {
01940             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
01941             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01942         }
01943 
01944         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation == 0) {
01945             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (BAD_POOL_CALLER,
01946                           0x41,
01947                           (ULONG_PTR)StartingAddress,
01948                           (ULONG_PTR)(Pfn1 - MmPfnDatabase),
01949                           MmHighestPhysicalPage);
01950         }
01951 
01952         <a class="code" href="../../d4/d8/mi_8h.html#a123">CONSISTENCY_LOCK_PFN2</a> (OldIrql);
01953 
01954         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01955 
01956         IsLargeVerifierAllocation = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation;
01957         IsLargeSessionAllocation = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation;
01958 
01959         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 0;
01960         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation = 0;
01961         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation = 0;
01962 
01963         <a class="code" href="../../d4/d8/mi_8h.html#a124">CONSISTENCY_UNLOCK_PFN2</a> (OldIrql);
01964 
01965 <span class="preprocessor">#if DBG</span>
01966 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1) &amp;&amp;
01967             (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0)) {
01968             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: MiFreePoolPages - deleting pool locked for I/O %lx\n"</span>,
01969                  Pfn1);
01970             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1);
01971         }
01972 <span class="preprocessor">#endif //DBG</span>
01973 <span class="preprocessor"></span>
01974         <span class="comment">//</span>
01975         <span class="comment">// Find end of allocation and release the pages.</span>
01976         <span class="comment">//</span>
01977 
01978         <span class="keywordflow">while</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation == 0) {
01979             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(StartingAddress)) {
01980                 Pfn1 += 1;
01981             } <span class="keywordflow">else</span> {
01982                 PointerPte += 1;
01983                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01984             }
01985             NumberOfPages += 1;
01986 <span class="preprocessor">#if DBG</span>
01987 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1) &amp;&amp;
01988                 (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0)) {
01989                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM:MiFreePoolPages - deleting pool locked for I/O %lx\n"</span>,
01990                      Pfn1);
01991                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1);
01992             }
01993 <span class="preprocessor">#endif //DBG</span>
01994 <span class="preprocessor"></span>        }
01995 
01996         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a52">MmAllocatedNonPagedPool</a> -= NumberOfPages;
01997 
01998         <span class="keywordflow">if</span> (IsLargeVerifierAllocation != 0) {
01999             <a class="code" href="../../d9/d5/verifier_8c.html#a91">VerifierFreeTrackedPool</a> (StartingAddress,
02000                                      NumberOfPages &lt;&lt; PAGE_SHIFT,
02001                                      NonPagedPool,
02002                                      FALSE);
02003         }
02004 
02005         <span class="keywordflow">if</span> (IsLargeSessionAllocation != 0) {
02006             <a class="code" href="../../d1/d6/allocpag_8c.html#a51">MiSessionPoolFreed</a> (StartingAddress,
02007                                 NumberOfPages &lt;&lt; PAGE_SHIFT,
02008                                 NonPagedPool);
02009         }
02010 
02011         <a class="code" href="../../d4/d8/mi_8h.html#a123">CONSISTENCY_LOCK_PFN2</a> (OldIrql);
02012 
02013         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 0;
02014 
02015         <a class="code" href="../../d4/d8/mi_8h.html#a124">CONSISTENCY_UNLOCK_PFN2</a> (OldIrql);
02016 
02017 <span class="preprocessor">#if DBG</span>
02018 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MiFillFreedPool != 0) {
02019             RtlFillMemoryUlong (StartingAddress,
02020                                 PAGE_SIZE * NumberOfPages,
02021                                 MiFillFreedPool);
02022         }
02023 <span class="preprocessor">#endif //DBG</span>
02024 <span class="preprocessor"></span>
02025         <span class="keywordflow">if</span> (StartingAddress &gt; <a class="code" href="../../d1/d6/allocpag_8c.html#a7">MmNonPagedPoolExpansionStart</a>) {
02026 
02027             <span class="comment">//</span>
02028             <span class="comment">// This page was from the expanded pool, should</span>
02029             <span class="comment">// it be freed?</span>
02030             <span class="comment">//</span>
02031             <span class="comment">// NOTE: all pages in the expanded pool area have PTEs</span>
02032             <span class="comment">// so no physical address checks need to be performed.</span>
02033             <span class="comment">//</span>
02034 
02035             <span class="keywordflow">if</span> ((NumberOfPages &gt; 3) || (<a class="code" href="../../d4/d8/mi_8h.html#a630">MmNumberOfFreeNonPagedPool</a> &gt; 5)) {
02036 
02037                 <span class="comment">//</span>
02038                 <span class="comment">// Free these pages back to the free page list.</span>
02039                 <span class="comment">//</span>
02040 
02041                 <a class="code" href="../../d1/d6/allocpag_8c.html#a53">MiFreeNonPagedPool</a> (StartingAddress, NumberOfPages);
02042 
02043                 <span class="keywordflow">return</span> (ULONG)NumberOfPages;
02044             }
02045         }
02046 
02047         <span class="comment">//</span>
02048         <span class="comment">// Add the pages to the list of free pages.</span>
02049         <span class="comment">//</span>
02050 
02051         <a class="code" href="../../d4/d8/mi_8h.html#a630">MmNumberOfFreeNonPagedPool</a> += NumberOfPages;
02052 
02053         <span class="comment">//</span>
02054         <span class="comment">// Check to see if the next allocation is free.</span>
02055         <span class="comment">// We cannot walk off the end of nonpaged initial or expansion</span>
02056         <span class="comment">// pages as the highest initial allocation is never freed and</span>
02057         <span class="comment">// the highest expansion allocation is guard-paged.</span>
02058         <span class="comment">//</span>
02059 
02060         i = NumberOfPages;
02061 
02062         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiEndOfInitialPoolFrame != 0);
02063 
02064         <span class="keywordflow">if</span> ((PFN_NUMBER)(Pfn1 - <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>) == <a class="code" href="../../d1/d6/allocpag_8c.html#a6">MiEndOfInitialPoolFrame</a>) {
02065             PointerPte += 1;
02066             Pfn1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02067         }
02068         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(StartingAddress)) {
02069             Pfn1 += 1;
02070             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PCHAR)StartingAddress + NumberOfPages &lt; (PCHAR)MmNonPagedPoolStart + MmSizeOfNonPagedPoolInBytes);
02071         } <span class="keywordflow">else</span> {
02072             PointerPte += 1;
02073             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PCHAR)StartingAddress + NumberOfPages &lt;= (PCHAR)MmNonPagedPoolEnd);
02074 
02075             <span class="comment">//</span>
02076             <span class="comment">// Unprotect the previously freed pool so it can be merged.</span>
02077             <span class="comment">//</span>
02078 
02079             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02080                 <a class="code" href="../../d5/d6/iosup_8c.html#a38">MiUnProtectFreeNonPagedPool</a> (
02081                     (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte),
02082                     0);
02083             }
02084 
02085             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
02086                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02087             } <span class="keywordflow">else</span> {
02088                 Pfn1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02089             }
02090         }
02091 
02092         <span class="keywordflow">if</span> ((Pfn1 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation == 0)) {
02093 
02094             <span class="comment">//</span>
02095             <span class="comment">// This range of pages is free.  Remove this entry</span>
02096             <span class="comment">// from the list and add these pages to the current</span>
02097             <span class="comment">// range being freed.</span>
02098             <span class="comment">//</span>
02099 
02100             Entry = (<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html">PMMFREE_POOL_ENTRY</a>)((PCHAR)StartingAddress
02101                                         + (NumberOfPages &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
02102             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o2">Signature</a> == MM_FREE_POOL_SIGNATURE);
02103             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o3">Owner</a> == Entry);
02104 <span class="preprocessor">#if DBG</span>
02105 <span class="preprocessor"></span>            {
02106                 <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> DebugPte;
02107                 <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> DebugPfn;
02108 
02109                 DebugPfn = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02110 
02111                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(StartingAddress)) {
02112 
02113                     <span class="comment">//</span>
02114                     <span class="comment">// On certain architectures, virtual addresses</span>
02115                     <span class="comment">// may be physical and hence have no corresponding PTE.</span>
02116                     <span class="comment">//</span>
02117 
02118                     DebugPfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MI_CONVERT_PHYSICAL_TO_PFN (Entry));
02119                     DebugPfn += Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">Size</a>;
02120                     <span class="keywordflow">if</span> ((PFN_NUMBER)((DebugPfn - 1) - <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>) != <a class="code" href="../../d1/d6/allocpag_8c.html#a6">MiEndOfInitialPoolFrame</a>) {
02121                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DebugPfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation == 1);
02122                     }
02123                 } <span class="keywordflow">else</span> {
02124                     DebugPte = PointerPte + Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">Size</a>;
02125                     <span class="keywordflow">if</span> ((DebugPte-1)-&gt;u.Hard.Valid == 1) {
02126                         DebugPfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> ((DebugPte-1)-&gt;u.Hard.PageFrameNumber);
02127                         <span class="keywordflow">if</span> ((PFN_NUMBER)(DebugPfn - <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>) != <a class="code" href="../../d1/d6/allocpag_8c.html#a6">MiEndOfInitialPoolFrame</a>) {
02128                             <span class="keywordflow">if</span> (DebugPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
02129                                 DebugPfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (DebugPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02130                                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DebugPfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation == 1);
02131                             }
02132                         }
02133 
02134                     }
02135                 }
02136             }
02137 <span class="preprocessor">#endif //DBG</span>
02138 <span class="preprocessor"></span>
02139             i += Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">Size</a>;
02140             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02141                 RemoveEntryList (&amp;Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o0">List</a>);
02142             }
02143             <span class="keywordflow">else</span> {
02144                 <a class="code" href="../../d1/d6/allocpag_8c.html#a47">MiProtectedPoolRemoveEntryList</a> (&amp;Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o0">List</a>);
02145             }
02146         }
02147 
02148         <span class="comment">//</span>
02149         <span class="comment">// Check to see if the previous page is the end of an allocation.</span>
02150         <span class="comment">// If it is not the end of an allocation, it must be free and</span>
02151         <span class="comment">// therefore this allocation can be tagged onto the end of</span>
02152         <span class="comment">// that allocation.</span>
02153         <span class="comment">//</span>
02154         <span class="comment">// We cannot walk off the beginning of expansion pool because it is</span>
02155         <span class="comment">// guard-paged.  If the initial pool is superpaged instead, we are also</span>
02156         <span class="comment">// safe as the must succeed pages always have EndOfAllocation set.</span>
02157         <span class="comment">//</span>
02158 
02159         Entry = (<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html">PMMFREE_POOL_ENTRY</a>)StartingAddress;
02160 
02161         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(StartingAddress)) {
02162             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartingAddress != MmNonPagedPoolStart);
02163 
02164             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MI_CONVERT_PHYSICAL_TO_PFN (
02165                                     (PVOID)((PCHAR)Entry - PAGE_SIZE)));
02166 
02167         } <span class="keywordflow">else</span> {
02168             PointerPte -= NumberOfPages + 1;
02169 
02170             <span class="comment">//</span>
02171             <span class="comment">// Unprotect the previously freed pool so it can be merged.</span>
02172             <span class="comment">//</span>
02173 
02174             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02175                 <a class="code" href="../../d5/d6/iosup_8c.html#a38">MiUnProtectFreeNonPagedPool</a> (
02176                     (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte),
02177                     0);
02178             }
02179 
02180             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
02181                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02182             } <span class="keywordflow">else</span> {
02183                 Pfn1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02184             }
02185         }
02186         <span class="keywordflow">if</span> (Pfn1 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02187             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation == 0) {
02188 
02189                 <span class="comment">//</span>
02190                 <span class="comment">// This range of pages is free, add these pages to</span>
02191                 <span class="comment">// this entry.  The owner field points to the address</span>
02192                 <span class="comment">// of the list entry which is linked into the free pool</span>
02193                 <span class="comment">// pages list.</span>
02194                 <span class="comment">//</span>
02195 
02196                 Entry = (<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html">PMMFREE_POOL_ENTRY</a>)((PCHAR)StartingAddress - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02197                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o2">Signature</a> == MM_FREE_POOL_SIGNATURE);
02198                 Entry = Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o3">Owner</a>;
02199 
02200                 <span class="comment">//</span>
02201                 <span class="comment">// Unprotect the previously freed pool so we can merge it</span>
02202                 <span class="comment">//</span>
02203 
02204                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02205                     <a class="code" href="../../d5/d6/iosup_8c.html#a38">MiUnProtectFreeNonPagedPool</a> ((PVOID)Entry, 0);
02206                 }
02207 
02208                 <span class="comment">//</span>
02209                 <span class="comment">// If this entry became larger than MM_SMALL_ALLOCATIONS</span>
02210                 <span class="comment">// pages, move it to the tail of the list.  This keeps the</span>
02211                 <span class="comment">// small allocations at the front of the list.</span>
02212                 <span class="comment">//</span>
02213 
02214                 <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">Size</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a324">MI_MAX_FREE_LIST_HEADS</a> - 1) {
02215 
02216                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02217                         RemoveEntryList (&amp;Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o0">List</a>);
02218                     }
02219                     <span class="keywordflow">else</span> {
02220                         <a class="code" href="../../d1/d6/allocpag_8c.html#a47">MiProtectedPoolRemoveEntryList</a> (&amp;Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o0">List</a>);
02221                     }
02222 
02223                     <span class="comment">//</span>
02224                     <span class="comment">// Add these pages to the previous entry.</span>
02225                     <span class="comment">//</span>
02226     
02227                     Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">Size</a> += i;
02228 
02229                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (ULONG)(Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">Size</a> - 1);
02230             
02231                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a324">MI_MAX_FREE_LIST_HEADS</a>) {
02232                         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d8/mi_8h.html#a324">MI_MAX_FREE_LIST_HEADS</a> - 1;
02233                     }
02234 
02235                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02236                         InsertTailList (&amp;MmNonPagedPoolFreeListHead[Index],
02237                                         &amp;Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o0">List</a>);
02238                     }
02239                     <span class="keywordflow">else</span> {
02240                         <a class="code" href="../../d1/d6/allocpag_8c.html#a46">MiProtectedPoolInsertList</a> (&amp;MmNonPagedPoolFreeListHead[Index],
02241                                           &amp;Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o0">List</a>,
02242                                           Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">Size</a> &lt; MM_SMALL_ALLOCATIONS ?
02243                                               TRUE : FALSE);
02244                     }
02245                 }
02246                 <span class="keywordflow">else</span> {
02247 
02248                     <span class="comment">//</span>
02249                     <span class="comment">// Add these pages to the previous entry.</span>
02250                     <span class="comment">//</span>
02251     
02252                     Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">Size</a> += i;
02253                 }
02254             }
02255         }
02256 
02257         <span class="keywordflow">if</span> (Entry == (<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html">PMMFREE_POOL_ENTRY</a>)StartingAddress) {
02258 
02259             <span class="comment">//</span>
02260             <span class="comment">// This entry was not combined with the previous, insert it</span>
02261             <span class="comment">// into the list.</span>
02262             <span class="comment">//</span>
02263 
02264             Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">Size</a> = i;
02265 
02266             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (ULONG)(Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">Size</a> - 1);
02267     
02268             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a324">MI_MAX_FREE_LIST_HEADS</a>) {
02269                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d8/mi_8h.html#a324">MI_MAX_FREE_LIST_HEADS</a> - 1;
02270             }
02271 
02272             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02273                 InsertTailList (&amp;MmNonPagedPoolFreeListHead[Index],
02274                                 &amp;Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o0">List</a>);
02275             }
02276             <span class="keywordflow">else</span> {
02277                 <a class="code" href="../../d1/d6/allocpag_8c.html#a46">MiProtectedPoolInsertList</a> (&amp;MmNonPagedPoolFreeListHead[Index],
02278                                       &amp;Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o0">List</a>,
02279                                       Entry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">Size</a> &lt; MM_SMALL_ALLOCATIONS ?
02280                                           TRUE : FALSE);
02281             }
02282         }
02283 
02284         <span class="comment">//</span>
02285         <span class="comment">// Set the owner field in all these pages.</span>
02286         <span class="comment">//</span>
02287 
02288         NextEntry = (<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html">PMMFREE_POOL_ENTRY</a>)StartingAddress;
02289         <span class="keywordflow">while</span> (i &gt; 0) {
02290             NextEntry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o3">Owner</a> = Entry;
02291 <span class="preprocessor">#if DBG</span>
02292 <span class="preprocessor"></span>            NextEntry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o2">Signature</a> = <a class="code" href="../../d4/d8/mi_8h.html#a11">MM_FREE_POOL_SIGNATURE</a>;
02293 <span class="preprocessor">#endif</span>
02294 <span class="preprocessor"></span>
02295             NextEntry = (<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html">PMMFREE_POOL_ENTRY</a>)((PCHAR)NextEntry + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02296             i -= 1;
02297         }
02298 
02299 <span class="preprocessor">#if DBG</span>
02300 <span class="preprocessor"></span>        NextEntry = Entry;
02301         <span class="keywordflow">for</span> (i = 0; i &lt; Entry-&gt;Size; i += 1) {
02302             <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> DebugPte;
02303             <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> DebugPfn;
02304             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(StartingAddress)) {
02305 
02306                 <span class="comment">//</span>
02307                 <span class="comment">// On certain architectures, virtual addresses</span>
02308                 <span class="comment">// may be physical and hence have no corresponding PTE.</span>
02309                 <span class="comment">//</span>
02310 
02311                 DebugPfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (MI_CONVERT_PHYSICAL_TO_PFN (NextEntry));
02312             } <span class="keywordflow">else</span> {
02313 
02314                 DebugPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (NextEntry);
02315                 DebugPfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (DebugPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02316             }
02317             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DebugPfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation == 0);
02318             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DebugPfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation == 0);
02319             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NextEntry-&gt;<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o3">Owner</a> == Entry);
02320             NextEntry = (<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html">PMMFREE_POOL_ENTRY</a>)((PCHAR)NextEntry + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02321         }
02322 <span class="preprocessor">#endif</span>
02323 <span class="preprocessor"></span>
02324         <span class="comment">//</span>
02325         <span class="comment">// Prevent anyone from touching non paged pool after freeing it.</span>
02326         <span class="comment">//</span>
02327 
02328         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02329             <a class="code" href="../../d5/d6/iosup_8c.html#a37">MiProtectFreeNonPagedPool</a> ((PVOID)Entry, (ULONG)Entry-&gt;Size);
02330         }
02331 
02332         <span class="keywordflow">return</span> (ULONG)NumberOfPages;
02333 
02334     } <span class="keywordflow">else</span> {
02335 
02336         <span class="comment">//</span>
02337         <span class="comment">// Paged pool.  Need to verify start of allocation using</span>
02338         <span class="comment">// end of allocation bitmap.</span>
02339         <span class="comment">//</span>
02340 
02341         <span class="keywordflow">if</span> (!RtlCheckBit (PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o0">PagedPoolAllocationMap</a>, StartPosition)) {
02342             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (BAD_POOL_CALLER,
02343                           0x50,
02344                           (ULONG_PTR)StartingAddress,
02345                           (ULONG_PTR)StartPosition,
02346                           MmSizeOfPagedPoolInBytes);
02347         }
02348 
02349 <span class="preprocessor">#if DBG</span>
02350 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (StartPosition &gt; 0) {
02351             <span class="keywordflow">if</span> (RtlCheckBit (PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o0">PagedPoolAllocationMap</a>, StartPosition - 1)) {
02352                 <span class="keywordflow">if</span> (!RtlCheckBit (PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o1">EndOfPagedPoolBitmap</a>, StartPosition - 1)) {
02353 
02354                     <span class="comment">//</span>
02355                     <span class="comment">// In the middle of an allocation... bugcheck.</span>
02356                     <span class="comment">//</span>
02357 
02358                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"paged pool in middle of allocation\n"</span>);
02359                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
02360                                   0x41286,
02361                                   (ULONG_PTR)PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o0">PagedPoolAllocationMap</a>,
02362                                   (ULONG_PTR)PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o1">EndOfPagedPoolBitmap</a>,
02363                                   StartPosition);
02364                 }
02365             }
02366         }
02367 <span class="preprocessor">#endif</span>
02368 <span class="preprocessor"></span>
02369         i = StartPosition;
02370         PointerPte = PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o3">FirstPteForPagedPool</a> + i;
02371 
02372         <span class="comment">//</span>
02373         <span class="comment">// Find the last allocated page and check to see if any</span>
02374         <span class="comment">// of the pages being deallocated are in the paging file.</span>
02375         <span class="comment">//</span>
02376 
02377         <span class="keywordflow">while</span> (!RtlCheckBit (PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o1">EndOfPagedPoolBitmap</a>, i)) {
02378             NumberOfPages += 1;
02379             i += 1;
02380         }
02381 
02382         <a class="code" href="../../d4/d2/datalpha_8c.html#a13">NoAccessPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a97">MM_KERNEL_NOACCESS_PTE</a>;
02383 
02384         <span class="keywordflow">if</span> (SessionSpace) {
02385 
02386             <span class="comment">//</span>
02387             <span class="comment">// This is needed purely to verify no one leaks pool.  This</span>
02388             <span class="comment">// could be removed if we believe everyone was good.</span>
02389             <span class="comment">//</span>
02390 
02391             <span class="keywordflow">if</span> (RtlCheckBit (PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o2">PagedPoolLargeSessionAllocationMap</a>,
02392                              StartPosition)) {
02393 
02394                 <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o2">PagedPoolLargeSessionAllocationMap</a>,
02395                               StartPosition,
02396                               1L);
02397 
02398                 <a class="code" href="../../d1/d6/allocpag_8c.html#a51">MiSessionPoolFreed</a> (MiGetVirtualAddressMappedByPte (PointerPte),
02399                                     NumberOfPages &lt;&lt; PAGE_SHIFT,
02400                                     PagedPool);
02401             }
02402 
02403             SessionAllocation = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02404         }
02405         <span class="keywordflow">else</span> {
02406             SessionAllocation = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02407 
02408             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a654">VerifierLargePagedPoolMap</a>) {
02409 
02410                 <span class="keywordflow">if</span> (RtlCheckBit (VerifierLargePagedPoolMap, StartPosition)) {
02411     
02412                     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (VerifierLargePagedPoolMap,
02413                                   StartPosition,
02414                                   1L);
02415     
02416                     <a class="code" href="../../d9/d5/verifier_8c.html#a91">VerifierFreeTrackedPool</a> (MiGetVirtualAddressMappedByPte (PointerPte),
02417                                              NumberOfPages &lt;&lt; PAGE_SHIFT,
02418                                              PagedPool,
02419                                              FALSE);
02420                 }
02421             }
02422         }
02423 
02424         PagesFreed = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (PointerPte,
02425                                               NumberOfPages,
02426                                               NoAccessPte,
02427                                               SessionAllocation,
02428                                               NULL);
02429 
02430         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PagesFreed == NumberOfPages);
02431 
02432         <span class="keywordflow">if</span> (SessionSpace) {
02433             <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
02434             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= NumberOfPages;
02435     
02436             <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a>(MM_DBG_SESSION_COMMIT_POOL_FREED,
02437                  NumberOfPages);
02438 
02439             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
02440         }
02441         <span class="keywordflow">else</span> {
02442             <a class="code" href="../../d8/d5/kddata_8c.html#a34">MmPagedPoolCommit</a> -= (ULONG)NumberOfPages;
02443         }
02444     
02445         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (NumberOfPages);
02446 
02447         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_PAGED_POOL_PAGES, NumberOfPages);
02448 
02449         <span class="comment">//</span>
02450         <span class="comment">// Clear the end of allocation bit in the bit map.</span>
02451         <span class="comment">//</span>
02452 
02453         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o1">EndOfPagedPoolBitmap</a>, (ULONG)i, 1L);
02454 
02455         PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o7">PagedPoolCommit</a> -= NumberOfPages;
02456         PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o8">AllocatedPagedPool</a> -= NumberOfPages;
02457 
02458         <span class="comment">//</span>
02459         <span class="comment">// Clear the allocation bits in the bit map.</span>
02460         <span class="comment">//</span>
02461 
02462         <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a33">RtlClearBits</a> (PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o0">PagedPoolAllocationMap</a>,
02463                       StartPosition,
02464                       (ULONG)NumberOfPages
02465                       );
02466 
02467         <span class="keywordflow">if</span> (StartPosition &lt; PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o6">PagedPoolHint</a>) {
02468             PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o6">PagedPoolHint</a> = StartPosition;
02469         }
02470 
02471         <span class="keywordflow">return</span> (ULONG)NumberOfPages;
02472     }
02473 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a204" doxytag="mm.h::MiSessionPoolAllocated" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSessionPoolAllocated           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00505">505</a> of file <a class="el" href="../../d2/d5/allocpag_8c-source.html">allocpag.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00050">BASE_POOL_TYPE_MASK</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05290">MI_IS_SESSION_POOL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05452">_MM_SESSION_SPACE::NonPagedPoolAllocations</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05450">_MM_SESSION_SPACE::NonPagedPoolBytes</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05453">_MM_SESSION_SPACE::PagedPoolAllocations</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05451">_MM_SESSION_SPACE::PagedPoolBytes</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, and <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00807">MiAllocatePoolPages()</a>.
<p>
<pre class="fragment"><div>00513                    :
00514 
00515     This function charges <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocation <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current session.
00516     On session <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>, <span class="keyword">this</span> charge must be zero.
00517 
00518 Arguments:
00519 
00520     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> address.
00521 
00522     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes allocated.
00523 
00524     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> above <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocation.
00525 
00526 Return Value:
00527 
00528     None.
00529 
00530 --*/
00531 
00532 {
00533     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {
00534         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a353">MI_IS_SESSION_POOL_ADDRESS</a>(VirtualAddress) == FALSE);
00535         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o9">NonPagedPoolBytes</a> += NumberOfBytes;
00536         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o11">NonPagedPoolAllocations</a> += 1;
00537     }
00538     <span class="keywordflow">else</span> {
00539         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a353">MI_IS_SESSION_POOL_ADDRESS</a>(VirtualAddress) == TRUE);
00540         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o10">PagedPoolBytes</a> += NumberOfBytes;
00541         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o12">PagedPoolAllocations</a> += 1;
00542     }
00543 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a205" doxytag="mm.h::MiSessionPoolFreed" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiSessionPoolFreed           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00547">547</a> of file <a class="el" href="../../d2/d5/allocpag_8c-source.html">allocpag.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00050">BASE_POOL_TYPE_MASK</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05290">MI_IS_SESSION_POOL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05452">_MM_SESSION_SPACE::NonPagedPoolAllocations</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05450">_MM_SESSION_SPACE::NonPagedPoolBytes</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05453">_MM_SESSION_SPACE::PagedPoolAllocations</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05451">_MM_SESSION_SPACE::PagedPoolBytes</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>, and <a class="el" href="../../d2/d5/allocpag_8c-source.html#l01778">MiFreePoolPages()</a>.
<p>
<pre class="fragment"><div>00555                    :
00556 
00557     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocation <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current session.
00558     On session <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>, <span class="keyword">this</span> charge must be zero.
00559 
00560 Arguments:
00561 
00562     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> address being freed.
00563 
00564     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes being freed.
00565 
00566     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> above <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocation.
00567 
00568 Return Value:
00569 
00570     None.
00571 
00572 --*/
00573 
00574 {
00575     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {
00576         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a353">MI_IS_SESSION_POOL_ADDRESS</a>(VirtualAddress) == FALSE);
00577         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o9">NonPagedPoolBytes</a> -= NumberOfBytes;
00578         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o11">NonPagedPoolAllocations</a> -= 1;
00579     }
00580     <span class="keywordflow">else</span> {
00581         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a353">MI_IS_SESSION_POOL_ADDRESS</a>(VirtualAddress) == TRUE);
00582         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o10">PagedPoolBytes</a> -= NumberOfBytes;
00583         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o12">PagedPoolAllocations</a> -= 1;
00584     }
00585 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a203" doxytag="mm.h::MiSessionPoolVector" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiSessionPoolVector           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00479">479</a> of file <a class="el" href="../../d2/d5/allocpag_8c-source.html">allocpag.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l05592">_MM_SESSION_SPACE::PagedPool</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00609">ExpInitializePoolDescriptor()</a>.
<p>
<pre class="fragment"><div>00485                    :
00486 
00487     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> descriptor <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current session.
00488 
00489 Arguments:
00490 
00491     None.
00492 
00493 Return Value:
00494 
00495     Pool descriptor.
00496 
00497 --*/
00498 
00499 {
00500     <span class="keywordflow">return</span> (PVOID)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o37">PagedPool</a>;
00501 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a208" doxytag="mm.h::MmAccessFault" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmAccessFault           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>StoreInstruction</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapInformation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">41</a> of file <a class="el" href="../../d5/d0/mmfault_8c-source.html">mmfault.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00066">_MMSUPPORT::AllowWorkingSetAdjustment</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00768">_KPROCESS::BasePriority</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00875">CONSISTENCY_LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00876">CONSISTENCY_UNLOCK_PFN</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00462">_MMINFO_COUNTERS::DemandZeroCount</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00069">DemandZeroPde</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00219">_EPROCESS::ForkInProgress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05179">HYDRA_PROCESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00349">HYPER_SPACE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12782">IoRetryIrpCompletions()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00982">LOCK_EXPANSION_IF_ALPHA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01039">LOCK_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01417">MI_ADD_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02799">MI_BARRIER_STAMP_ZEROED_PAGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02767">MI_BARRIER_SYNCHRONIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02412">MI_GET_PROTECTION_FROM_SOFT_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01355">MI_GET_USED_PTES_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01359">MI_INCREMENT_USED_PTES_BY_HANDLE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02642">MI_IS_HYPER_SPACE_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02568">MI_IS_PAGE_TABLE_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05293">MI_IS_SESSION_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05287">MI_IS_SESSION_IMAGE_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02192">MI_NO_FAULT_FOUND</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01116">MI_PAGE_COLOR_VA_PROCESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02336">MI_PTE_LOOKUP_NEEDED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01470">MI_REMOVE_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02157">MI_SET_PAGE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00641">MI_SET_PTE_IN_WORKING_SET</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02513">MI_WRITE_VALID_PTE_NEW_PROTECTION</a>, <a class="el" href="../../d6/d2/acceschk_8c-source.html#l00042">MiAccessCheck()</a>, <a class="el" href="../../d6/d2/acceschk_8c-source.html#l00194">MiCheckForUserStackOverflow()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03125">MiCheckPdeForPagedPool()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03224">MiCheckPdeForSessionSpace()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l02880">MiCheckVirtualAddress()</a>, <a class="el" href="../../d4/d9/wrtfault_8c-source.html#l00025">MiCopyOnWrite()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04555">MiDelayPageFaults</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00068">MiDispatchFault()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d4/d8/mi_8h.html#a968">MiFormatPte()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03300">MiGrowWsleHash()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00117">MiLocateAndReserveWsle()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00996">MiMakeSystemAddressValidPfn()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00062">_MMSUPPORT::MinimumWorkingSetSize</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01495">MiProtoAddressForPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01466">MiPteToProto</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02814">MiRemoveZeroPageIfAny</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00674">MiResolveDemandZeroFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l04446">MiSessionCopyOnWrite()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01078">MiUpdateWsle()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l01980">MiWaitForForkToComplete()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01184">MiZeroPhysicalPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00217">Mm30Milliseconds</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00165">MM_DBG_PTE_UPDATE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00190">MM_DBG_SHOW_FAULTS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00187">MM_DBG_STOP_ON_ACCVIO</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00418">MM_DEMAND_ZERO_WRITE_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00140">MM_EXECUTE_WRITECOPY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00119">MM_GROW_WSLE_HASH</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00143">MM_GUARD_PAGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00151">MM_KSTACK_OUTSWAPPED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00147">MM_LARGE_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00145">MM_NOACCESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00374">MM_PTE_WRITE_MASK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00134">MM_READONLY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05685">MM_SESSION_SPACE_WS_LOCK_ASSERT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00168">MM_SYSTEM_SPACE_END</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00146">MM_UNKNOWN_PROTECTION</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00412">MM_ZERO_KERNEL_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00406">MM_ZERO_PTE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00216">MmHalfSecond</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00475">MmInfoCounters</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01087">MmModifiedPageListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05122">MmModifiedPageMaximum</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04486">MmMoreThanEnoughFreePages</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00065">MmNonPagedPoolEnd</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00114">MmNonPagedPoolExpansionStart</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00064">MmNonPagedPoolStart</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05170">MmPageFaultNotifyRoutine</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00092">MmProtectFreedNonPagedPool</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00215">MmShortTime</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00996">MmSystemLockOwner</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00033">MmSystemRangeStart</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00226">_EPROCESS::ModifiedPageCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00232">_EPROCESS::NextPageColor</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00230">_EPROCESS::NumberOfPrivatePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00059">_MMSUPPORT::PageFaultCount</a>, <a class="el" href="../../d2/d2/ppcdef_8h-source.html#l00079">PASSIVE_LEVEL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02111">PPAGE_FAULT_NOTIFY_ROUTINE</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00025">PROCESS_FOREGROUND_PRIORITY</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00075">PrototypePte</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00991">UNLOCK_EXPANSION_IF_ALPHA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01081">UNLOCK_WS</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05556">_MM_SESSION_SPACE::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05586">_MM_SESSION_SPACE::WorkingSetLockOwner</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00056">KiMemoryFault()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00764">MiMakeSystemAddressValid()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00996">MiMakeSystemAddressValidPfn()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00916">MiMakeSystemAddressValidPfnSystemWs()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00837">MiMakeSystemAddressValidPfnWs()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01016">MmCheckCachedPageState()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, and <a class="el" href="../../d1/d4/probewrt_8c-source.html#l00036">MmProbeForWrite()</a>.
<p>
<pre class="fragment"><div>00050                    :
00051 
00052     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel on data or instruction
00053     access faults.  The access fault was detected due to either
00054     an access violation, a PTE with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> present bit clear, or a
00055     valid PTE with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dirty bit clear and a write operation.
00056 
00057     Also note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access violation and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page fault could
00058     occur because of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Page <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> Entry contents as well.
00059 
00060     This routine determines what <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of fault <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> and calls
00061     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate routine to handle <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page fault or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> write
00062     fault.
00063 
00064 Arguments:
00065 
00066     StoreInstruction - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> (1) if the operation causes a write into
00067                        memory.  Note this value must be 1 or 0.
00068 
00069     VirtualAddress - Supplies the virtual address which caused the fault.
00070 
00071     PreviousMode - Supplies the mode (kernel or user) in which the fault
00072                    occurred.
00073 
00074     TrapInformation - Opaque information about the trap, interpreted by the
00075                       kernel, not Mm.  Needed to allow fast interlocked access
00076                       to operate correctly.
00077 
00078 Return Value:
00079 
00080     Returns the status of the fault handling operation.  Can be one of:
00081         - Success.
00082         - Access Violation.
00083         - Guard Page Violation.
00084         - In-page Error.
00085 
00086 Environment:
00087 
00088     Kernel mode, APCs disabled.
00089 
00090 --*/
00091 
00092 {
00093     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00094     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00095     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00096     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte;
00097     ULONG ProtectionCode;
00098     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00099     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00100     KIRQL PreviousIrql;
00101     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00102     ULONG ProtectCode;
00103     PFN_NUMBER PageFrameIndex;
00104     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
00105     KIRQL OldIrql;
00106     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00107     <a class="code" href="../../d2/d1/mm_8h.html#a163">PPAGE_FAULT_NOTIFY_ROUTINE</a> NotifyRoutine;
00108     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> SessionStatus;
00109     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> FaultProcess;
00110     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> Ws;
00111     BOOLEAN SessionAddress;
00112     PVOID UsedPageTableHandle;
00113     ULONG BarrierStamp;
00114     LOGICAL ApcNeeded;
00115 
00116 <span class="preprocessor">#if defined(_IA64_)</span>
00117 <span class="preprocessor"></span>    LOGICAL ExecutionFault = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00118 
00119     <span class="comment">//</span>
00120     <span class="comment">// If StoreInstruction indicates it was an execution fault, set</span>
00121     <span class="comment">// ExecutionFault TRUE and StoreInstruction FALSE.</span>
00122     <span class="comment">//</span>
00123 
00124     <span class="keywordflow">if</span> (StoreInstruction == 2) {
00125         ExecutionFault = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00126         StoreInstruction = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00127     }
00128 <span class="preprocessor">#endif</span>
00129 <span class="preprocessor"></span>
00130     PointerProtoPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00131 
00132 <span class="preprocessor">#if defined (_WIN64)</span>
00133 <span class="preprocessor"></span>
00134     <span class="comment">//</span>
00135     <span class="comment">// Perform address sanity checks.</span>
00136     <span class="comment">//</span>
00137 
00138     <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00139 
00140         <span class="keywordflow">if</span> (VirtualAddress &gt;= MM_HIGHEST_USER_ADDRESS) {
00141             <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00142         }
00143 
00144     } <span class="keywordflow">else</span> {
00145 
00146         <span class="keywordflow">if</span> (!((VirtualAddress &lt;= (PVOID)((ULONG_PTR)MM_HIGHEST_USER_ADDRESS + 1)) ||
00147 
00148 <span class="preprocessor">#if defined (_IA64_)</span>
00149 <span class="preprocessor"></span>
00150             <span class="comment">//</span>
00151             <span class="comment">// Page table pages are in the user region space for IA64.</span>
00152             <span class="comment">//</span>
00153 
00154             (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a190">MI_IS_PAGE_TABLE_ADDRESS</a>(VirtualAddress)) ||
00155             (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a193">MI_IS_HYPER_SPACE_ADDRESS</a>(VirtualAddress)) ||
00156             (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a>(VirtualAddress)) ||
00157 <span class="preprocessor">#endif</span>
00158 <span class="preprocessor"></span>
00159             ((VirtualAddress &gt;= MM_SYSTEM_RANGE_START) &amp;&amp;
00160             (VirtualAddress &lt; (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a25">MM_SYSTEM_SPACE_END</a>)))) {
00161 
00162             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapInformation) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00163                 <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00164             }
00165 
00166             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
00167                           (ULONG_PTR) VirtualAddress,
00168                           StoreInstruction,
00169                           PreviousMode,
00170                           0xdead);
00171         }
00172     }
00173 
00174 <span class="preprocessor">#endif</span>
00175 <span class="preprocessor"></span>
00176     <span class="comment">//</span>
00177     <span class="comment">// Block APCs and acquire the working set mutex.  This prevents any</span>
00178     <span class="comment">// changes to the address space and it prevents valid PTEs from becoming</span>
00179     <span class="comment">// invalid.</span>
00180     <span class="comment">//</span>
00181 
00182     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
00183 
00184 <span class="preprocessor">#if DBG</span>
00185 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a82">MM_DBG_SHOW_FAULTS</a>) {
00186 
00187         <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurThread;
00188 
00189         CurThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00190         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:**access fault - va %p process %p thread %p\n"</span>,
00191                  VirtualAddress, CurrentProcess, CurThread);
00192     }
00193 <span class="preprocessor">#endif //DBG</span>
00194 <span class="preprocessor"></span>
00195     PreviousIrql = KeGetCurrentIrql ();
00196 
00197     <span class="comment">//</span>
00198     <span class="comment">// Get the pointer to the PDE and the PTE for this page.</span>
00199     <span class="comment">//</span>
00200 
00201     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
00202     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (VirtualAddress);
00203     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (VirtualAddress);
00204 
00205 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00206 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PointerPte &gt;= MiPfnStartPte &amp;&amp; PointerPte &lt; MiPfnStartPte + MiPfnPtes) {
00207         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM: Unsynchronized access to the PFN database - va %p process %p\n"</span>,
00208                  VirtualAddress, CurrentProcess);
00209 
00210         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (DISPATCH_LEVEL, &amp;OldIrql);
00211         MiMapInPfnDatabase();
00212         MiPfnProtectionEnabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00213         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
00214 
00215         DbgBreakPoint();
00216     }
00217 <span class="preprocessor">#endif</span>
00218 <span class="preprocessor"></span>
00219 <span class="preprocessor">#if DBG</span>
00220 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PointerPte == MmPteHit) {
00221         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:pte hit at %p\n"</span>, MmPteHit);
00222         DbgBreakPoint();
00223     }
00224 <span class="preprocessor">#endif</span>
00225 <span class="preprocessor"></span>
00226     ApcNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00227 
00228     <span class="keywordflow">if</span> (PreviousIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
00229 
00230         <span class="comment">//</span>
00231         <span class="comment">// The PFN database lock is an executive spin-lock.  The pager could</span>
00232         <span class="comment">// get dirty faults or lock faults while servicing and it already owns</span>
00233         <span class="comment">// the PFN database lock.</span>
00234         <span class="comment">//</span>
00235 
00236 <span class="preprocessor">#if !defined (_WIN64)</span>
00237 <span class="preprocessor"></span>        <a class="code" href="../../d8/d2/pagfault_8c.html#a20">MiCheckPdeForPagedPool</a> (VirtualAddress);
00238 <span class="preprocessor">#endif</span>
00239 <span class="preprocessor"></span>
00240 <span class="preprocessor">#ifdef _X86_</span>
00241 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00242             <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.LargePage == 1) {
00243 <span class="preprocessor">#if DBG</span>
00244 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmLargePageFaultError &lt; 10) {
00245                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM - fault on Large page %p\n"</span>, VirtualAddress);
00246                 }
00247                 MmLargePageFaultError += 1;
00248 <span class="preprocessor">#endif //DBG</span>
00249 <span class="preprocessor"></span>                <span class="keywordflow">return</span> STATUS_SUCCESS;
00250             }
00251         }
00252 <span class="preprocessor">#endif //X86</span>
00253 <span class="preprocessor"></span>
00254         <span class="keywordflow">if</span> (
00255 <span class="preprocessor">#if defined (_WIN64)</span>
00256 <span class="preprocessor"></span>            (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
00257 <span class="preprocessor">#endif</span>
00258 <span class="preprocessor"></span>            (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
00259             (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0)) {
00260 
00261             KdPrint((<span class="stringliteral">"MM:***PAGE FAULT AT IRQL &gt; 1  Va %p, IRQL %lx\n"</span>,
00262                      VirtualAddress,
00263                      PreviousIrql));
00264 
00265             <span class="comment">//</span>
00266             <span class="comment">// use reserved bit to signal fatal error to trap handlers</span>
00267             <span class="comment">//</span>
00268 
00269             <span class="keywordflow">return</span> STATUS_IN_PAGE_ERROR | 0x10000000;
00270 
00271         }
00272 
00273         <span class="keywordflow">if</span> (StoreInstruction &amp;&amp; (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite != 0)) {
00274             KdPrint((<span class="stringliteral">"MM:***PAGE FAULT AT IRQL &gt; 1  Va %p, IRQL %lx\n"</span>,
00275                      VirtualAddress,
00276                      PreviousIrql));
00277 
00278             <span class="comment">//</span>
00279             <span class="comment">// use reserved bit to signal fatal error to trap handlers</span>
00280             <span class="comment">//</span>
00281 
00282             <span class="keywordflow">return</span> STATUS_IN_PAGE_ERROR | 0x10000000;
00283         }
00284 
00285         <span class="comment">//</span>
00286         <span class="comment">// The PTE is valid and accessible, another thread must</span>
00287         <span class="comment">// have faulted the PTE in already, or the access bit</span>
00288         <span class="comment">// is clear and this is a access fault; Blindly set the</span>
00289         <span class="comment">// access bit and dismiss the fault.</span>
00290         <span class="comment">//</span>
00291 <span class="preprocessor">#if DBG</span>
00292 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a82">MM_DBG_SHOW_FAULTS</a>) {
00293             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:no fault found - pte is %p\n"</span>, PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00294         }
00295 <span class="preprocessor">#endif //DBG</span>
00296 <span class="preprocessor"></span>
00297         <span class="keywordflow">if</span> (StoreInstruction) {
00298 
00299             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00300 
00301             <span class="keywordflow">if</span> (((PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a77">MM_PTE_WRITE_MASK</a>) == 0) &amp;&amp;
00302                 ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>) == 0)) {
00303                 
00304                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (ATTEMPTED_WRITE_TO_READONLY_MEMORY,
00305                               (ULONG_PTR)VirtualAddress,
00306                               (ULONG_PTR)PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
00307                               (ULONG_PTR)TrapInformation,
00308                               10);
00309             }
00310         }
00311 
00312         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a176">MI_NO_FAULT_FOUND</a> (TempPte, PointerPte, VirtualAddress, FALSE);
00313         <span class="keywordflow">return</span> STATUS_SUCCESS;
00314     }
00315 
00316     <span class="keywordflow">if</span> (VirtualAddress &gt;= <a class="code" href="../../d0/d9/miglobal_8c.html#a1">MmSystemRangeStart</a>) {
00317 
00318         <span class="comment">//</span>
00319         <span class="comment">// This is a fault in the system address space.  User</span>
00320         <span class="comment">// mode access is not allowed.</span>
00321         <span class="comment">//</span>
00322 
00323         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00324             <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00325         }
00326 
00327 <span class="preprocessor">#if defined (_WIN64)</span>
00328 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00329 
00330             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapInformation) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00331                 <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00332             }
00333 
00334             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PAGE_FAULT_IN_NONPAGED_AREA,
00335                           (ULONG_PTR)VirtualAddress,
00336                           StoreInstruction,
00337                           (ULONG_PTR)TrapInformation,
00338                           5);
00339         }
00340 <span class="preprocessor">#endif</span>
00341 <span class="preprocessor"></span>
00342 RecheckPde:
00343 
00344         <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00345 <span class="preprocessor">#ifdef _X86_</span>
00346 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.LargePage == 1) {
00347 <span class="preprocessor">#if DBG</span>
00348 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmLargePageFaultError &lt; 10) {
00349                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM - fault on Large page %p\n"</span>,VirtualAddress);
00350                 }
00351                 MmLargePageFaultError += 1;
00352 <span class="preprocessor">#endif //DBG</span>
00353 <span class="preprocessor"></span>                <span class="keywordflow">return</span> STATUS_SUCCESS;
00354             }
00355 <span class="preprocessor">#endif //X86</span>
00356 <span class="preprocessor"></span>
00357             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00358 
00359                 <span class="comment">//</span>
00360                 <span class="comment">// Session space faults cannot early exit here because</span>
00361                 <span class="comment">// it may be a copy on write which must be checked for</span>
00362                 <span class="comment">// and handled below.</span>
00363                 <span class="comment">//</span>
00364 
00365                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (VirtualAddress) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00366 
00367                     <span class="comment">//</span>
00368                     <span class="comment">// Acquire the PFN lock, check to see if the address is</span>
00369                     <span class="comment">// still valid if writable, update dirty bit.</span>
00370                     <span class="comment">//</span>
00371 
00372                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00373                     TempPte = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
00374                     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00375 
00376                         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00377     
00378                         <span class="keywordflow">if</span> ((StoreInstruction) &amp;&amp;
00379                             ((TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a77">MM_PTE_WRITE_MASK</a>) == 0) &amp;&amp;
00380                             ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>) == 0)) {
00381                 
00382                             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (ATTEMPTED_WRITE_TO_READONLY_MEMORY,
00383                                           (ULONG_PTR)VirtualAddress,
00384                                           (ULONG_PTR)TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
00385                                           (ULONG_PTR)TrapInformation,
00386                                           11);
00387                         }
00388                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a176">MI_NO_FAULT_FOUND</a> (TempPte, PointerPte, VirtualAddress, TRUE);
00389                     }
00390                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00391                     <span class="keywordflow">return</span> STATUS_SUCCESS;
00392                 }
00393             }
00394 <span class="preprocessor">#if !defined (_WIN64)</span>
00395 <span class="preprocessor"></span>            <span class="keywordflow">else</span> {
00396 
00397                 <span class="comment">//</span>
00398                 <span class="comment">// Handle trimmer references to paged pool PTEs where the PDE</span>
00399                 <span class="comment">// might not be present.  Only needed for</span>
00400                 <span class="comment">// MmTrimAllSystemPagable memory.</span>
00401                 <span class="comment">//</span>
00402 
00403                 <a class="code" href="../../d8/d2/pagfault_8c.html#a20">MiCheckPdeForPagedPool</a> (VirtualAddress);
00404                 TempPte = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
00405                 <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00406                     <span class="keywordflow">return</span> STATUS_SUCCESS;
00407                 }
00408             }
00409 <span class="preprocessor">#endif</span>
00410 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
00411 
00412             <span class="comment">//</span>
00413             <span class="comment">// Due to G-bits in kernel mode code, accesses to paged pool</span>
00414             <span class="comment">// PDEs may not fault even though the PDE is not valid.  Make</span>
00415             <span class="comment">// sure the PDE is valid so PteFrames in the PFN database are</span>
00416             <span class="comment">// tracked properly.</span>
00417             <span class="comment">//</span>
00418 
00419 <span class="preprocessor">#if defined (_WIN64)</span>
00420 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((VirtualAddress &gt;= (PVOID)PTE_BASE) &amp;&amp; (VirtualAddress &lt; (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (HYPER_SPACE))) {
00421                 <span class="comment">//</span>
00422                 <span class="comment">// This is a user mode PDE entry being faulted in by the Mm</span>
00423                 <span class="comment">// referencing the page table page.  This needs to be done</span>
00424                 <span class="comment">// with the working set lock so that the PPE validity can be</span>
00425                 <span class="comment">// relied on throughout the fault processing.</span>
00426                 <span class="comment">//</span>
00427                 <span class="comment">// The case when Mm faults in PPE entries by referencing the</span>
00428                 <span class="comment">// page directory page is correctly handled by falling through</span>
00429                 <span class="comment">// the below code.</span>
00430                 <span class="comment">//</span>
00431     
00432                 <span class="keywordflow">goto</span> UserFault;
00433             }
00434 <span class="preprocessor">#else</span>
00435 <span class="preprocessor"></span>            <a class="code" href="../../d8/d2/pagfault_8c.html#a20">MiCheckPdeForPagedPool</a> (VirtualAddress);
00436 <span class="preprocessor">#endif</span>
00437 <span class="preprocessor"></span>
00438             <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00439                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapInformation) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00440                     <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00441                 }
00442                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PAGE_FAULT_IN_NONPAGED_AREA,
00443                               (ULONG_PTR)VirtualAddress,
00444                               StoreInstruction,
00445                               (ULONG_PTR)TrapInformation,
00446                               2);
00447                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00448             }
00449 
00450             <span class="comment">//</span>
00451             <span class="comment">// Now that the PDE is valid, go look at the PTE again.</span>
00452             <span class="comment">//</span>
00453 
00454             <span class="keywordflow">goto</span> RecheckPde;
00455         }
00456 
00457         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00458 
00459 <span class="preprocessor">#if !defined (_WIN64)</span>
00460 <span class="preprocessor"></span>
00461             <span class="comment">//</span>
00462             <span class="comment">// First check to see if it's in the session space data</span>
00463             <span class="comment">// structures or page table pages.</span>
00464             <span class="comment">//</span>
00465 
00466             SessionStatus = <a class="code" href="../../d8/d2/pagfault_8c.html#a21">MiCheckPdeForSessionSpace</a> (VirtualAddress);
00467 
00468             <span class="keywordflow">if</span> (SessionStatus == STATUS_ACCESS_VIOLATION) {
00469 
00470                 <span class="comment">//</span>
00471                 <span class="comment">// This thread faulted on a session space access, but this</span>
00472                 <span class="comment">// process does not have one.  This could be the system</span>
00473                 <span class="comment">// process attempting to access a working buffer passed</span>
00474                 <span class="comment">// to it from WIN32K or a driver loaded in session space</span>
00475                 <span class="comment">// (video, printer, etc).</span>
00476                 <span class="comment">//</span>
00477                 <span class="comment">// The system process which contains the worker threads</span>
00478                 <span class="comment">// NEVER has a session space - if code accidentally queues a</span>
00479                 <span class="comment">// worker thread that points to a session space buffer, a</span>
00480                 <span class="comment">// fault will occur.  This must be bug checked since drivers</span>
00481                 <span class="comment">// are responsible for making sure this never occurs.</span>
00482                 <span class="comment">//</span>
00483                 <span class="comment">// The only exception to this is when the working set manager</span>
00484                 <span class="comment">// attaches to a session to age or trim it.  However, the</span>
00485                 <span class="comment">// working set manager will never fault and so the bugcheck</span>
00486                 <span class="comment">// below is always valid.  Note that a worker thread can get</span>
00487                 <span class="comment">// away with a bad access if it happens while the working set</span>
00488                 <span class="comment">// manager is attached, but there's really no way to prevent</span>
00489                 <span class="comment">// this case which is a driver bug anyway.</span>
00490                 <span class="comment">//</span>
00491 
00492                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapInformation) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00493                     <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00494                 }
00495 
00496                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PAGE_FAULT_IN_NONPAGED_AREA,
00497                               (ULONG_PTR)VirtualAddress,
00498                               StoreInstruction,
00499                               (ULONG_PTR)TrapInformation,
00500                               6);
00501             }
00502 
00503 <span class="preprocessor">#endif</span>
00504 <span class="preprocessor"></span>
00505             <span class="comment">//</span>
00506             <span class="comment">// Fall though to further fault handling.</span>
00507             <span class="comment">//</span>
00508 
00509             SessionAddress = <a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (VirtualAddress);
00510         }
00511         <span class="keywordflow">else</span> {
00512             SessionAddress = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00513         }
00514 
00515         <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ||
00516             ((!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a190">MI_IS_PAGE_TABLE_ADDRESS</a>(VirtualAddress)) &amp;&amp;
00517              (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a193">MI_IS_HYPER_SPACE_ADDRESS</a>(VirtualAddress)))) {
00518 
00519             <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00520 
00521                 <span class="comment">//</span>
00522                 <span class="comment">// Acquire system working set lock.  While this lock</span>
00523                 <span class="comment">// is held, no pages may go from valid to invalid.</span>
00524                 <span class="comment">//</span>
00525                 <span class="comment">// HOWEVER - transition pages may go to valid, but</span>
00526                 <span class="comment">// may not be added to the working set list.  This</span>
00527                 <span class="comment">// is done in the cache manager support routines to</span>
00528                 <span class="comment">// shortcut faults on transition prototype PTEs.</span>
00529                 <span class="comment">//</span>
00530 
00531                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>() == <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a>) {
00532 
00533                     <span class="comment">//</span>
00534                     <span class="comment">// Recursively trying to acquire the system working set</span>
00535                     <span class="comment">// fast mutex - cause an IRQL &gt; 1 bug check.</span>
00536                     <span class="comment">//</span>
00537 
00538                     <span class="keywordflow">return</span> STATUS_IN_PAGE_ERROR | 0x10000000;
00539                 }
00540 
00541                 <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (PreviousIrql);
00542             }
00543 
00544             <span class="comment">//</span>
00545             <span class="comment">// Note that for session space the below check is done without</span>
00546             <span class="comment">// acquiring the session WSL lock.  This is because this thread</span>
00547             <span class="comment">// may already own it - ie: it may be adding a page to the</span>
00548             <span class="comment">// session space working set and the session's working set list is</span>
00549             <span class="comment">// not mapped in and causes a fault.  The MiCheckPdeForSessionSpace</span>
00550             <span class="comment">// call above will fill in the PDE and then we must check the PTE</span>
00551             <span class="comment">// below - if that's not present then we couldn't possibly be</span>
00552             <span class="comment">// holding the session WSL lock, so we'll acquire it below.</span>
00553             <span class="comment">//</span>
00554 
00555 <span class="preprocessor">#if defined (_X86PAE_)</span>
00556 <span class="preprocessor"></span>            <span class="comment">//</span>
00557             <span class="comment">// PAE PTEs are subject to write tearing due to the cache manager</span>
00558             <span class="comment">// shortcut routines that insert PTEs without acquiring the working</span>
00559             <span class="comment">// set lock.  Synchronize here via the PFN lock.</span>
00560             <span class="comment">//</span>
00561             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00562 <span class="preprocessor">#endif</span>
00563 <span class="preprocessor"></span>            TempPte = *PointerPte;
00564 <span class="preprocessor">#if defined (_X86PAE_)</span>
00565 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00566 <span class="preprocessor">#endif</span>
00567 <span class="preprocessor"></span>
00568             <span class="comment">//</span>
00569             <span class="comment">// If the PTE is valid, make sure we do not have a copy on</span>
00570             <span class="comment">// write.</span>
00571             <span class="comment">//</span>
00572 
00573             <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid != 0) {
00574 
00575                 <span class="comment">//</span>
00576                 <span class="comment">// PTE is already valid, return.  Unless it's Hydra where</span>
00577                 <span class="comment">// kernel mode copy-on-write must be handled properly.</span>
00578                 <span class="comment">//</span>
00579 
00580                 BOOLEAN FaultHandled;
00581 
00582                 FaultHandled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00583 
00584                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00585                 TempPte = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
00586                 <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00587 
00588                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00589 
00590                     <span class="keywordflow">if</span> ((StoreInstruction) &amp;&amp;
00591                         (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite == 0) &amp;&amp;
00592                         ((TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a77">MM_PTE_WRITE_MASK</a>) == 0) &amp;&amp;
00593                         ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>) == 0)) {
00594                 
00595                             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (ATTEMPTED_WRITE_TO_READONLY_MEMORY,
00596                                           (ULONG_PTR)VirtualAddress,
00597                                           (ULONG_PTR)TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
00598                                           (ULONG_PTR)TrapInformation,
00599                                           12);
00600                     }
00601 
00602                     <span class="comment">//</span>
00603                     <span class="comment">// Set the dirty bit in the PTE and the page frame.</span>
00604                     <span class="comment">//</span>
00605 
00606 <span class="preprocessor">#if defined(_ALPHA_)</span>
00607 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> || (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 1 &amp;&amp; TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite == 0))
00608 <span class="preprocessor">#else</span>
00609 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> || TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 1)
00610 <span class="preprocessor">#endif</span>
00611 <span class="preprocessor"></span>                    {
00612                         FaultHandled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00613                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a176">MI_NO_FAULT_FOUND</a> (TempPte, PointerPte, VirtualAddress, TRUE);
00614                     }
00615                 }
00616                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00617                 <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00618                     <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (PreviousIrql);
00619                 }
00620                 <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> || FaultHandled == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00621                     <span class="keywordflow">return</span> STATUS_SUCCESS;
00622                 }
00623             }
00624 
00625             <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00626 
00627                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
00628 
00629                 <span class="comment">//</span>
00630                 <span class="comment">// Acquire the session space working set lock.  While this lock</span>
00631                 <span class="comment">// is held, no session pages may go from valid to invalid.</span>
00632                 <span class="comment">//</span>
00633 
00634                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>() == <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o36">WorkingSetLockOwner</a>) {
00635 
00636                     <span class="comment">//</span>
00637                     <span class="comment">// Recursively trying to acquire the session working set</span>
00638                     <span class="comment">// lock - cause an IRQL &gt; 1 bug check.</span>
00639                     <span class="comment">//</span>
00640 
00641                     <span class="keywordflow">return</span> STATUS_IN_PAGE_ERROR | 0x10000000;
00642                 }
00643 
00644                 <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (PreviousIrql);
00645 
00646                 TempPte = *PointerPte;
00647 
00648                 <span class="comment">//</span>
00649                 <span class="comment">// The PTE could have become valid while we waited</span>
00650                 <span class="comment">// for the session space working set lock.</span>
00651                 <span class="comment">//</span>
00652 
00653                 <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00654 
00655                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00656                     TempPte = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
00657 
00658                     <span class="comment">//</span>
00659                     <span class="comment">// Check for copy-on-write.</span>
00660                     <span class="comment">//</span>
00661 
00662                     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00663 
00664 <span class="preprocessor">#if defined(_ALPHA_)</span>
00665 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (StoreInstruction &amp;&amp; TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite == 1)
00666 <span class="preprocessor">#else</span>
00667 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (StoreInstruction &amp;&amp; TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 0)
00668 <span class="preprocessor">#endif</span>
00669 <span class="preprocessor"></span>                        {
00670 <span class="preprocessor">#if defined(_ALPHA_)</span>
00671 <span class="preprocessor"></span>                            TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write = 0;
00672                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a188">MI_WRITE_VALID_PTE_NEW_PROTECTION</a> (PointerPte, TempPte);
00673 <span class="preprocessor">#endif</span>
00674 <span class="preprocessor"></span>
00675                             <span class="comment">//</span>
00676                             <span class="comment">// Copy on write only for loaded drivers...</span>
00677                             <span class="comment">//</span>
00678 
00679                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_IS_SESSION_IMAGE_ADDRESS (VirtualAddress));
00680 
00681                             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00682 
00683                             <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite == 0) {
00684                     
00685                                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (ATTEMPTED_WRITE_TO_READONLY_MEMORY,
00686                                               (ULONG_PTR)VirtualAddress,
00687                                               (ULONG_PTR)TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
00688                                               (ULONG_PTR)TrapInformation,
00689                                               13);
00690                             }
00691 
00692                             <a class="code" href="../../d8/d2/pagfault_8c.html#a32">MiSessionCopyOnWrite</a> (MmSessionSpace,
00693                                                   VirtualAddress,
00694                                                   PointerPte);
00695 
00696                             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (PreviousIrql);
00697 
00698                             <span class="keywordflow">return</span> STATUS_SUCCESS;
00699                         }
00700 
00701 <span class="preprocessor">#if DBG</span>
00702 <span class="preprocessor"></span>                        <span class="comment">//</span>
00703                         <span class="comment">// If we are allowing a store, it better be writable.</span>
00704                         <span class="comment">//</span>
00705 
00706                         <span class="keywordflow">if</span> (StoreInstruction) {
00707                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 1);
00708                         }
00709 <span class="preprocessor">#endif</span>
00710 <span class="preprocessor"></span>                        <span class="comment">//</span>
00711                         <span class="comment">// PTE is already valid, return.</span>
00712                         <span class="comment">//</span>
00713 
00714                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a176">MI_NO_FAULT_FOUND</a> (TempPte, PointerPte, VirtualAddress, TRUE);
00715                     }
00716 
00717                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00718                     <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (PreviousIrql);
00719                     <span class="keywordflow">return</span> STATUS_SUCCESS;
00720                 }
00721             }
00722 
00723             <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype != 0) {
00724 
00725                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00726 
00727                     PVOID StartVa;
00728     
00729                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(MmNonPagedPoolStart)) {
00730                         StartVa = <a class="code" href="../../d1/d6/allocpag_8c.html#a7">MmNonPagedPoolExpansionStart</a>;
00731                     }
00732                     <span class="keywordflow">else</span> {
00733                         StartVa = <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>;
00734                     }
00735     
00736                     <span class="keywordflow">if</span> (VirtualAddress &gt;= StartVa &amp;&amp; VirtualAddress &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a24">MmNonPagedPoolEnd</a>) {
00737                         <span class="comment">//</span>
00738                         <span class="comment">// This is an access to previously freed</span>
00739                         <span class="comment">// non paged pool - bugcheck!</span>
00740                         <span class="comment">//</span>
00741     
00742                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapInformation) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00743                             <span class="keywordflow">goto</span> AccessViolation;
00744                         }
00745     
00746                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_CAUGHT_MODIFYING_FREED_POOL,
00747                                       (ULONG_PTR)VirtualAddress,
00748                                       StoreInstruction,
00749                                       PreviousMode,
00750                                       4);
00751                     }
00752                 }
00753 
00754                 <span class="comment">//</span>
00755                 <span class="comment">// This is a PTE in prototype format, locate the corresponding</span>
00756                 <span class="comment">// prototype PTE.</span>
00757                 <span class="comment">//</span>
00758 
00759                 PointerProtoPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (&amp;TempPte);
00760 
00761                 <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00762 
00763                     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>) {
00764                         PointerProtoPte = <a class="code" href="../../d8/d2/pagfault_8c.html#a19">MiCheckVirtualAddress</a> (VirtualAddress,
00765                                                                  &amp;ProtectionCode);
00766                         <span class="keywordflow">if</span> (PointerProtoPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00767                             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (PreviousIrql);
00768                             <span class="keywordflow">return</span> STATUS_IN_PAGE_ERROR | 0x10000000;
00769                         }
00770                     }
00771                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Proto.ReadOnly == 1) {
00772         
00773                         <span class="comment">//</span>
00774                         <span class="comment">// Writes are not allowed to this page.</span>
00775                         <span class="comment">//</span>
00776 
00777                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (VirtualAddress)) {
00778 
00779                         <span class="comment">//</span>
00780                         <span class="comment">// Copy on write this page.</span>
00781                         <span class="comment">//</span>
00782     
00783                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, PrototypePte);
00784                         PointerPte-&gt;u.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a42">MM_EXECUTE_WRITECOPY</a>;
00785                     }
00786                 }
00787             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 0) &amp;&amp;
00788                         (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection == 0)) {
00789 
00790                 <span class="comment">//</span>
00791                 <span class="comment">// Page file format.  If the protection is ZERO, this</span>
00792                 <span class="comment">// is a page of free system PTEs - bugcheck!</span>
00793                 <span class="comment">//</span>
00794 
00795                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapInformation) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00796                     <span class="keywordflow">goto</span> AccessViolation;
00797                 }
00798 
00799                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PAGE_FAULT_IN_NONPAGED_AREA,
00800                               (ULONG_PTR)VirtualAddress,
00801                               StoreInstruction,
00802                               (ULONG_PTR)TrapInformation,
00803                               0);
00804                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00805             }
00806             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
00807 
00808                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapInformation) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00809                     <span class="keywordflow">goto</span> AccessViolation;
00810                 }
00811 
00812                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PAGE_FAULT_IN_NONPAGED_AREA,
00813                               (ULONG_PTR)VirtualAddress,
00814                               StoreInstruction,
00815                               (ULONG_PTR)TrapInformation,
00816                               1);
00817                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00818             }
00819 
00820 <span class="preprocessor">#ifdef PROTECT_KSTACKS</span>
00821 <span class="preprocessor"></span>            <span class="keywordflow">else</span> {
00822                  <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection == <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>) {
00823 
00824                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapInformation) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00825                         <span class="keywordflow">goto</span> AccessViolation;
00826                     }
00827 
00828                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PAGE_FAULT_IN_NONPAGED_AREA,
00829                                   (ULONG_PTR)VirtualAddress,
00830                                   StoreInstruction,
00831                                   (ULONG_PTR)TrapInformation,
00832                                   3);
00833                  }
00834             }
00835 <span class="preprocessor">#endif</span>
00836 <span class="preprocessor"></span>
00837             <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00838 
00839                 <a class="code" href="../../d4/d8/mi_8h.html#a406">MM_SESSION_SPACE_WS_LOCK_ASSERT</a> ();
00840 
00841                 <span class="comment">//</span>
00842                 <span class="comment">// If it's a write to a session space page that is ultimately</span>
00843                 <span class="comment">// mapped by a prototype PTE, it's a copy-on-write piece of</span>
00844                 <span class="comment">// a session driver.  Since the page isn't even present yet,</span>
00845                 <span class="comment">// turn the write access into a read access to fault it in.</span>
00846                 <span class="comment">// We'll get a write fault on the present page when we retry</span>
00847                 <span class="comment">// the operation at which point we'll sever the copy on write.</span>
00848                 <span class="comment">//</span>
00849 
00850                 <span class="keywordflow">if</span> (PointerProtoPte &amp;&amp;
00851                     StoreInstruction &amp;&amp;
00852                     <a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (VirtualAddress)) {
00853                         StoreInstruction = 0;
00854                 }
00855 
00856                 FaultProcess = <a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a>;
00857             }
00858             <span class="keywordflow">else</span> {
00859                 FaultProcess = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00860 
00861                 <span class="keywordflow">if</span> (StoreInstruction) {
00862 
00863                     <span class="keywordflow">if</span> ((TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) &amp;&amp; (PointerProtoPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00864                         <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
00865             
00866                             <span class="keywordflow">if</span> ((TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>) == 0) {
00867                                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (ATTEMPTED_WRITE_TO_READONLY_MEMORY,
00868                                               (ULONG_PTR)VirtualAddress,
00869                                               (ULONG_PTR)TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
00870                                               (ULONG_PTR)TrapInformation,
00871                                               14);
00872                             }
00873                         }
00874                         <span class="keywordflow">else</span> {
00875                             <span class="keywordflow">if</span> ((TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>) == 0) {
00876                     
00877                                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (ATTEMPTED_WRITE_TO_READONLY_MEMORY,
00878                                               (ULONG_PTR)VirtualAddress,
00879                                               (ULONG_PTR)TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
00880                                               (ULONG_PTR)TrapInformation,
00881                                               15);
00882                             }
00883                         }
00884                     }
00885                 }
00886             }
00887 
00888             status = <a class="code" href="../../d8/d2/pagfault_8c.html#a11">MiDispatchFault</a> (StoreInstruction,
00889                                       VirtualAddress,
00890                                       PointerPte,
00891                                       PointerProtoPte,
00892                                       FaultProcess,
00893                                       &amp;ApcNeeded);
00894 
00895             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ApcNeeded == FALSE);
00896             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == APC_LEVEL);
00897 
00898             <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00899                 Ws = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>;
00900                 PageFrameIndex = Ws-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
00901                 <a class="code" href="../../d4/d8/mi_8h.html#a406">MM_SESSION_SPACE_WS_LOCK_ASSERT</a>();
00902             }
00903             <span class="keywordflow">else</span> {
00904                 Ws = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
00905                 PageFrameIndex = <a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
00906             }
00907 
00908             <span class="keywordflow">if</span> (Ws-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> == <a class="code" href="../../d4/d8/mi_8h.html#a32">MM_GROW_WSLE_HASH</a>) {
00909                 <a class="code" href="../../d4/d0/wslist_8c.html#a33">MiGrowWsleHash</a> (Ws);
00910                 <a class="code" href="../../d4/d8/mi_8h.html#a142">LOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
00911                 Ws-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00912                 <a class="code" href="../../d4/d8/mi_8h.html#a143">UNLOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
00913             }
00914 
00915             <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00916                 <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (PreviousIrql);
00917             }
00918             <span class="keywordflow">else</span> {
00919                 <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (PreviousIrql);
00920             }
00921 
00922             <span class="keywordflow">if</span> ((PageFrameIndex &amp; 0x3FFFF) == 0x30000) {
00923 
00924                 <span class="comment">//</span>
00925                 <span class="comment">// The system cache or this session is taking too many faults,</span>
00926                 <span class="comment">// delay execution so the modified page writer gets a quick</span>
00927                 <span class="comment">// shot and increase the working set size.</span>
00928                 <span class="comment">//</span>
00929 
00930                 <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;MmShortTime);
00931             }
00932             NotifyRoutine = <a class="code" href="../../d4/d8/mi_8h.html#a746">MmPageFaultNotifyRoutine</a>;
00933             <span class="keywordflow">if</span> (NotifyRoutine) {
00934                 <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00935                     (*NotifyRoutine) (
00936                         status,
00937                         VirtualAddress,
00938                         TrapInformation
00939                         );
00940                 }
00941             }
00942             <span class="keywordflow">return</span> status;
00943         } <span class="keywordflow">else</span> {
00944 <span class="preprocessor">#if !defined (_WIN64)</span>
00945 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a20">MiCheckPdeForPagedPool</a> (VirtualAddress) == STATUS_WAIT_1) {
00946                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00947             }
00948 <span class="preprocessor">#endif</span>
00949 <span class="preprocessor"></span>        }
00950     }
00951 
00952 <span class="preprocessor">#if defined (_WIN64)</span>
00953 <span class="preprocessor"></span>UserFault:
00954 <span class="preprocessor">#endif</span>
00955 <span class="preprocessor"></span>
00956     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a598">MiDelayPageFaults</a> ||
00957         ((<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> &gt;= (<a class="code" href="../../d4/d8/mi_8h.html#a728">MmModifiedPageMaximum</a> + 100)) &amp;&amp;
00958         (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; (1024*1024 / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) &amp;&amp;
00959             (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o37">ModifiedPageCount</a> &gt; ((64*1024)/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)))) {
00960 
00961         <span class="comment">//</span>
00962         <span class="comment">// This process has placed more than 64k worth of pages on the modified</span>
00963         <span class="comment">// list.  Delay for a short period and set the count to zero.</span>
00964         <span class="comment">//</span>
00965 
00966         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode,
00967                                 FALSE,
00968              (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o12">BasePriority</a> &lt; PROCESS_FOREGROUND_PRIORITY) ?
00969                                     &amp;MmHalfSecond : &amp;Mm30Milliseconds);
00970         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o37">ModifiedPageCount</a> = 0;
00971     }
00972 
00973     <span class="comment">//</span>
00974     <span class="comment">// FAULT IN USER SPACE OR PAGE DIRECTORY/PAGE TABLE PAGES.</span>
00975     <span class="comment">//</span>
00976 
00977     <span class="comment">//</span>
00978     <span class="comment">// Block APCs and acquire the working set lock.</span>
00979     <span class="comment">//</span>
00980 
00981     <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (CurrentProcess);
00982 
00983 <span class="preprocessor">#if defined (_WIN64)</span>
00984 <span class="preprocessor"></span>
00985     <span class="comment">//</span>
00986     <span class="comment">// Locate the Page Directory Parent Entry which maps this virtual</span>
00987     <span class="comment">// address and check for accessibility and validity.  The page directory</span>
00988     <span class="comment">// page must be made valid before any other checks are made.</span>
00989     <span class="comment">//</span>
00990 
00991     <span class="keywordflow">if</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00992 
00993         <span class="comment">//</span>
00994         <span class="comment">// If the PPE is zero, check to see if there is a virtual address</span>
00995         <span class="comment">// mapped at this location, and if so create the necessary</span>
00996         <span class="comment">// structures to map it.</span>
00997         <span class="comment">//</span>
00998 
00999         <span class="keywordflow">if</span> ((PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a93">MM_ZERO_PTE</a>) ||
01000             (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a94">MM_ZERO_KERNEL_PTE</a>)) {
01001             PointerProtoPte = <a class="code" href="../../d8/d2/pagfault_8c.html#a19">MiCheckVirtualAddress</a> (VirtualAddress,
01002                                                      &amp;ProtectCode);
01003 
01004 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01005 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (ProtectCode == <a class="code" href="../../d4/d8/mi_8h.html#a48">MM_LARGE_PAGES</a>) {
01006                 status = STATUS_SUCCESS;
01007                 <span class="keywordflow">goto</span> ReturnStatus2;
01008             }
01009 <span class="preprocessor">#endif //LARGE_PAGES</span>
01010 <span class="preprocessor"></span>
01011             <span class="keywordflow">if</span> (ProtectCode == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
01012                 status = STATUS_ACCESS_VIOLATION;
01013 <span class="comment">//                MiCheckPpeForPagedPool (VirtualAddress);</span>
01014                 <span class="keywordflow">if</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01015                     status = STATUS_SUCCESS;
01016                 }
01017 
01018 <span class="preprocessor">#if DBG</span>
01019 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a79">MM_DBG_STOP_ON_ACCVIO</a>) &amp;&amp;
01020                     (status == STATUS_ACCESS_VIOLATION)) {
01021                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:access violation - %p\n"</span>,VirtualAddress);
01022                     <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPpe);
01023                     DbgBreakPoint();
01024                 }
01025 <span class="preprocessor">#endif //DEBUG</span>
01026 <span class="preprocessor"></span>
01027                 <span class="keywordflow">goto</span> ReturnStatus2;
01028 
01029             } <span class="keywordflow">else</span> {
01030 
01031                 <span class="comment">//</span>
01032                 <span class="comment">// Build a demand zero PPE and operate on it.</span>
01033                 <span class="comment">//</span>
01034 
01035                 *PointerPpe = <a class="code" href="../../d4/d2/datalpha_8c.html#a9">DemandZeroPde</a>;
01036             }
01037         }
01038 
01039         <span class="comment">//</span>
01040         <span class="comment">// The PPE is not valid, call the page fault routine passing</span>
01041         <span class="comment">// in the address of the PPE.  If the PPE is valid, determine</span>
01042         <span class="comment">// the status of the corresponding PDE.</span>
01043         <span class="comment">//</span>
01044         <span class="comment">// Note this call may result in ApcNeeded getting set to TRUE.</span>
01045         <span class="comment">// This is deliberate as there may be another call to MiDispatchFault</span>
01046         <span class="comment">// issued later in this routine and we don't want to lose the APC</span>
01047         <span class="comment">// status.</span>
01048         <span class="comment">//</span>
01049 
01050         status = <a class="code" href="../../d8/d2/pagfault_8c.html#a11">MiDispatchFault</a> (TRUE,  <span class="comment">//page table page always written</span>
01051                                   PointerPde,   <span class="comment">//Virtual address</span>
01052                                   PointerPpe,   <span class="comment">// PTE (PPE in this case)</span>
01053                                   NULL,
01054                                   CurrentProcess,
01055                                   &amp;ApcNeeded);
01056 
01057 <span class="preprocessor">#if DBG</span>
01058 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ApcNeeded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01059             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;NestedFaultCount == 0);
01060             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;ApcNeeded == 0);
01061         }
01062 <span class="preprocessor">#endif</span>
01063 <span class="preprocessor"></span>
01064         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == APC_LEVEL);
01065         <span class="keywordflow">if</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01066 
01067             <span class="comment">//</span>
01068             <span class="comment">// The PPE is not valid, return the status.</span>
01069             <span class="comment">//</span>
01070             <span class="keywordflow">goto</span> ReturnStatus1;
01071         }
01072 
01073 <span class="preprocessor">#if PFN_CONSISTENCY</span>
01074 <span class="preprocessor"></span>        {
01075             <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01076 
01077             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01078             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01079             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageTablePage = 1;
01080             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01081         }
01082 <span class="preprocessor">#endif</span>
01083 <span class="preprocessor"></span>        <span class="comment">//KeFillEntryTb ((PHARDWARE_PTE)PointerPpe, (PVOID)PointerPde, TRUE);</span>
01084 
01085         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a175">MI_SET_PAGE_DIRTY</a> (PointerPpe, PointerPde, FALSE);
01086 
01087         <span class="comment">//</span>
01088         <span class="comment">// Now that the PPE is accessible, get the PDE - let this fall</span>
01089         <span class="comment">// through.</span>
01090         <span class="comment">//</span>
01091     }
01092 <span class="preprocessor">#endif</span>
01093 <span class="preprocessor"></span>
01094     <span class="comment">//</span>
01095     <span class="comment">// Locate the Page Directory Entry which maps this virtual</span>
01096     <span class="comment">// address and check for accessibility and validity.</span>
01097     <span class="comment">//</span>
01098 
01099     <span class="comment">//</span>
01100     <span class="comment">// Check to see if the page table page (PDE entry) is valid.</span>
01101     <span class="comment">// If not, the page table page must be made valid first.</span>
01102     <span class="comment">//</span>
01103 
01104     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01105 
01106         <span class="comment">//</span>
01107         <span class="comment">// If the PDE is zero, check to see if there is a virtual address</span>
01108         <span class="comment">// mapped at this location, and if so create the necessary</span>
01109         <span class="comment">// structures to map it.</span>
01110         <span class="comment">//</span>
01111 
01112         <span class="keywordflow">if</span> ((PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a93">MM_ZERO_PTE</a>) ||
01113             (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a94">MM_ZERO_KERNEL_PTE</a>)) {
01114             PointerProtoPte = <a class="code" href="../../d8/d2/pagfault_8c.html#a19">MiCheckVirtualAddress</a> (VirtualAddress,
01115                                                      &amp;ProtectCode);
01116 
01117 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01118 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (ProtectCode == <a class="code" href="../../d4/d8/mi_8h.html#a48">MM_LARGE_PAGES</a>) {
01119                 status = STATUS_SUCCESS;
01120                 <span class="keywordflow">goto</span> ReturnStatus2;
01121             }
01122 <span class="preprocessor">#endif //LARGE_PAGES</span>
01123 <span class="preprocessor"></span>
01124             <span class="keywordflow">if</span> (ProtectCode == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
01125                 status = STATUS_ACCESS_VIOLATION;
01126 <span class="preprocessor">#if !defined (_WIN64)</span>
01127 <span class="preprocessor"></span>                <a class="code" href="../../d8/d2/pagfault_8c.html#a20">MiCheckPdeForPagedPool</a> (VirtualAddress);
01128 <span class="preprocessor">#endif</span>
01129 <span class="preprocessor"></span>
01130                 <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01131                     status = STATUS_SUCCESS;
01132                 }
01133 
01134 <span class="preprocessor">#if DBG</span>
01135 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a79">MM_DBG_STOP_ON_ACCVIO</a>) &amp;&amp;
01136                     (status == STATUS_ACCESS_VIOLATION)) {
01137                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:access violation - %p\n"</span>,VirtualAddress);
01138                     <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPde);
01139                     DbgBreakPoint();
01140                 }
01141 <span class="preprocessor">#endif //DEBUG</span>
01142 <span class="preprocessor"></span>
01143                 <span class="keywordflow">goto</span> ReturnStatus2;
01144 
01145             }
01146 
01147             <span class="comment">//</span>
01148             <span class="comment">// Build a demand zero PDE and operate on it.</span>
01149             <span class="comment">//</span>
01150 
01151             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPde, DemandZeroPde);
01152 
01153 <span class="preprocessor">#if defined (_WIN64)</span>
01154 <span class="preprocessor"></span>
01155             <span class="comment">//</span>
01156             <span class="comment">// Increment the count of non-zero page directory entries for this</span>
01157             <span class="comment">// page directory.</span>
01158             <span class="comment">//</span>
01159 
01160             <span class="keywordflow">if</span> (VirtualAddress &lt;= MM_HIGHEST_USER_ADDRESS) {
01161                 UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
01162                 <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
01163             }
01164 <span class="preprocessor">#endif</span>
01165 <span class="preprocessor"></span>
01166         }
01167 
01168         <span class="comment">//</span>
01169         <span class="comment">// The PDE is not valid, call the page fault routine passing</span>
01170         <span class="comment">// in the address of the PDE.  If the PDE is valid, determine</span>
01171         <span class="comment">// the status of the corresponding PTE.</span>
01172         <span class="comment">//</span>
01173 
01174         status = <a class="code" href="../../d8/d2/pagfault_8c.html#a11">MiDispatchFault</a> (TRUE,  <span class="comment">//page table page always written</span>
01175                                   PointerPte,   <span class="comment">//Virtual address</span>
01176                                   PointerPde,   <span class="comment">// PTE (PDE in this case)</span>
01177                                   NULL,
01178                                   CurrentProcess,
01179                                   &amp;ApcNeeded);
01180 
01181 <span class="preprocessor">#if DBG</span>
01182 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ApcNeeded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01183             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;NestedFaultCount == 0);
01184             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;ApcNeeded == 0);
01185         }
01186 <span class="preprocessor">#endif</span>
01187 <span class="preprocessor"></span>
01188         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == APC_LEVEL);
01189         <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01190 
01191             <span class="comment">//</span>
01192             <span class="comment">// The PDE is not valid, return the status.</span>
01193             <span class="comment">//</span>
01194             <span class="keywordflow">goto</span> ReturnStatus1;
01195         }
01196 
01197 <span class="preprocessor">#if PFN_CONSISTENCY</span>
01198 <span class="preprocessor"></span>        {
01199             <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01200 
01201             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01202             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01203             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageTablePage = 1;
01204             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01205         }
01206 <span class="preprocessor">#endif</span>
01207 <span class="preprocessor"></span>        <span class="comment">//KeFillEntryTb ((PHARDWARE_PTE)PointerPde, (PVOID)PointerPte, TRUE);</span>
01208 
01209         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a175">MI_SET_PAGE_DIRTY</a> (PointerPde, PointerPte, FALSE);
01210 
01211         <span class="comment">//</span>
01212         <span class="comment">// Now that the PDE is accessible, get the PTE - let this fall</span>
01213         <span class="comment">// through.</span>
01214         <span class="comment">//</span>
01215     }
01216 
01217     <span class="comment">//</span>
01218     <span class="comment">// The PDE is valid and accessible, get the PTE contents.</span>
01219     <span class="comment">//</span>
01220 
01221     TempPte = *PointerPte;
01222     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid != 0) {
01223 
01224         <span class="comment">//</span>
01225         <span class="comment">// The PTE is valid and accessible, is this a write fault</span>
01226         <span class="comment">// copy on write or setting of some dirty bit?</span>
01227         <span class="comment">//</span>
01228 
01229 <span class="preprocessor">#if DBG</span>
01230 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a57">MM_DBG_PTE_UPDATE</a>) {
01231             <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
01232         }
01233 <span class="preprocessor">#endif //DBG</span>
01234 <span class="preprocessor"></span>
01235         status = STATUS_SUCCESS;
01236 
01237         <span class="keywordflow">if</span> (StoreInstruction) {
01238 
01239             <span class="comment">//</span>
01240             <span class="comment">// This was a write operation.  If the copy on write</span>
01241             <span class="comment">// bit is set in the PTE perform the copy on write,</span>
01242             <span class="comment">// else check to ensure write access to the PTE.</span>
01243             <span class="comment">//</span>
01244 
01245             <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite != 0) {
01246                 <a class="code" href="../../d3/d0/wrtfault_8c.html#a0">MiCopyOnWrite</a> (VirtualAddress, PointerPte);
01247                 status = STATUS_PAGE_FAULT_COPY_ON_WRITE;
01248                 <span class="keywordflow">goto</span> ReturnStatus2;
01249 
01250             } <span class="keywordflow">else</span> {
01251                 <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 0) {
01252                     status = STATUS_ACCESS_VIOLATION;
01253                 }
01254             }
01255 <span class="preprocessor">#if defined(_IA64_)</span>
01256 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExecutionFault) {
01257 
01258             <span class="comment">//</span>
01259             <span class="comment">// It also checks to ensure execute access to the PTE.</span>
01260             <span class="comment">//</span>
01261 
01262             <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Execute == 0) {
01263                 status = STATUS_ACCESS_VIOLATION;
01264             }
01265 <span class="preprocessor">#endif</span>
01266 <span class="preprocessor"></span><span class="preprocessor">#if DBG</span>
01267 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
01268 
01269             <span class="comment">//</span>
01270             <span class="comment">// The PTE is valid and accessible, another thread must</span>
01271             <span class="comment">// have faulted the PTE in already, or the access bit</span>
01272             <span class="comment">// is clear and this is a access fault; Blindly set the</span>
01273             <span class="comment">// access bit and dismiss the fault.</span>
01274             <span class="comment">//</span>
01275 
01276             <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a82">MM_DBG_SHOW_FAULTS</a>) {
01277                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:no fault found - pte is %p\n"</span>, PointerPte-&gt;u.Long);
01278             }
01279 <span class="preprocessor">#endif //DBG</span>
01280 <span class="preprocessor"></span>        }
01281 
01282         <span class="keywordflow">if</span> (status == STATUS_SUCCESS) {
01283             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01284             <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid != 0) {
01285                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a176">MI_NO_FAULT_FOUND</a> (TempPte, PointerPte, VirtualAddress, TRUE);
01286             }
01287             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01288         }
01289 
01290         <span class="keywordflow">goto</span> ReturnStatus2;
01291     }
01292 
01293     <span class="comment">//</span>
01294     <span class="comment">// If the PTE is zero, check to see if there is a virtual address</span>
01295     <span class="comment">// mapped at this location, and if so create the necessary</span>
01296     <span class="comment">// structures to map it.</span>
01297     <span class="comment">//</span>
01298 
01299     <span class="comment">//</span>
01300     <span class="comment">// Check explicitly for demand zero pages.</span>
01301     <span class="comment">//</span>
01302 
01303     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>) {
01304         <a class="code" href="../../d8/d2/pagfault_8c.html#a12">MiResolveDemandZeroFault</a> (VirtualAddress,
01305                                   PointerPte,
01306                                   CurrentProcess,
01307                                   0);
01308 
01309         status = STATUS_PAGE_FAULT_DEMAND_ZERO;
01310         <span class="keywordflow">goto</span> ReturnStatus1;
01311     }
01312 
01313     <span class="keywordflow">if</span> ((TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a93">MM_ZERO_PTE</a>) ||
01314         (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a94">MM_ZERO_KERNEL_PTE</a>)) {
01315 
01316         <span class="comment">//</span>
01317         <span class="comment">// PTE is needs to be evaluated with respect to its virtual</span>
01318         <span class="comment">// address descriptor (VAD).  At this point there are 3</span>
01319         <span class="comment">// possibilities, bogus address, demand zero, or refers to</span>
01320         <span class="comment">// a prototype PTE.</span>
01321         <span class="comment">//</span>
01322 
01323         PointerProtoPte = <a class="code" href="../../d8/d2/pagfault_8c.html#a19">MiCheckVirtualAddress</a> (VirtualAddress,
01324                                                  &amp;ProtectionCode);
01325         <span class="keywordflow">if</span> (ProtectionCode == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
01326             status = STATUS_ACCESS_VIOLATION;
01327 
01328             <span class="comment">//</span>
01329             <span class="comment">// Check to make sure this is not a page table page for</span>
01330             <span class="comment">// paged pool which needs extending.</span>
01331             <span class="comment">//</span>
01332 
01333 <span class="preprocessor">#if !defined (_WIN64)</span>
01334 <span class="preprocessor"></span>            <a class="code" href="../../d8/d2/pagfault_8c.html#a20">MiCheckPdeForPagedPool</a> (VirtualAddress);
01335 <span class="preprocessor">#endif</span>
01336 <span class="preprocessor"></span>
01337             <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 1) {
01338                 status = STATUS_SUCCESS;
01339             }
01340 
01341 <span class="preprocessor">#if DBG</span>
01342 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a79">MM_DBG_STOP_ON_ACCVIO</a>) &amp;&amp;
01343                 (status == STATUS_ACCESS_VIOLATION)) {
01344                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:access vio - %p\n"</span>,VirtualAddress);
01345                 <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
01346                 DbgBreakPoint();
01347             }
01348 <span class="preprocessor">#endif //DEBUG</span>
01349 <span class="preprocessor"></span>            <span class="keywordflow">goto</span> ReturnStatus2;
01350         }
01351 
01352         <span class="comment">//</span>
01353         <span class="comment">// Increment the count of non-zero page table entries for this</span>
01354         <span class="comment">// page table.</span>
01355         <span class="comment">//</span>
01356 
01357         <span class="keywordflow">if</span> (VirtualAddress &lt;= MM_HIGHEST_USER_ADDRESS) {
01358             UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (VirtualAddress);
01359             <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
01360         }
01361 
01362         <span class="comment">//</span>
01363         <span class="comment">// Is this page a guard page?</span>
01364         <span class="comment">//</span>
01365 
01366         <span class="keywordflow">if</span> (ProtectionCode &amp; <a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>) {
01367 
01368             <span class="comment">//</span>
01369             <span class="comment">// This is a guard page exception.</span>
01370             <span class="comment">//</span>
01371 
01372             PointerPte-&gt;u.Soft.Protection = ProtectionCode &amp; ~<a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>;
01373 
01374             <span class="keywordflow">if</span> (PointerProtoPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01375 
01376                 <span class="comment">//</span>
01377                 <span class="comment">// This is a prototype PTE, build the PTE to not</span>
01378                 <span class="comment">// be a guard page.</span>
01379                 <span class="comment">//</span>
01380 
01381                 PointerPte-&gt;u.Soft.PageFileHigh = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>;
01382                 PointerPte-&gt;u.Soft.Prototype = 1;
01383             }
01384 
01385             <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
01386             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == PreviousIrql);
01387 
01388             <span class="keywordflow">if</span> (ApcNeeded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01389                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;NestedFaultCount == 0);
01390                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;ApcNeeded == 0);
01391                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == PASSIVE_LEVEL);
01392                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (APC_LEVEL, &amp;PreviousIrql);
01393                 <a class="code" href="../../d4/d6/iosubs_8c.html#a136">IoRetryIrpCompletions</a> ();
01394                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (PreviousIrql);
01395             }
01396 
01397             <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a834">MiCheckForUserStackOverflow</a> (VirtualAddress);
01398         }
01399 
01400         <span class="keywordflow">if</span> (PointerProtoPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01401 
01402             <span class="comment">//ASSERT (KeReadStateMutant (&amp;CurrentProcess-&gt;WorkingSetLock) == 0);</span>
01403 
01404             <span class="comment">//</span>
01405             <span class="comment">// Assert that this is not for a PDE.</span>
01406             <span class="comment">//</span>
01407 
01408             <span class="keywordflow">if</span> (PointerPde == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PTE_BASE)) {
01409 
01410                 <span class="comment">//</span>
01411                 <span class="comment">// This PTE is really a PDE, set contents as such.</span>
01412                 <span class="comment">//</span>
01413 
01414                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, DemandZeroPde);
01415             } <span class="keywordflow">else</span> {
01416                 PointerPte-&gt;u.Soft.Protection = ProtectionCode;
01417             }
01418 
01419             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01420 
01421             <span class="comment">//</span>
01422             <span class="comment">// If a fork operation is in progress and the faulting thread</span>
01423             <span class="comment">// is not the thread performing the fork operation, block until</span>
01424             <span class="comment">// the fork is completed.</span>
01425             <span class="comment">//</span>
01426 
01427             <span class="keywordflow">if</span> ((CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o30">ForkInProgress</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01428                 (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o30">ForkInProgress</a> != <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())) {
01429                 <a class="code" href="../../d4/d8/mi_8h.html#a855">MiWaitForForkToComplete</a> (CurrentProcess);
01430                 status = STATUS_SUCCESS;
01431                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01432                 <span class="keywordflow">goto</span> ReturnStatus1;
01433             }
01434 
01435             <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (CurrentProcess,
01436                                               VirtualAddress)) {
01437 
01438                 ULONG Color;
01439                 Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a128">MI_PAGE_COLOR_VA_PROCESS</a> (VirtualAddress,
01440                                                 &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o43">NextPageColor</a>);
01441                 PageFrameIndex = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
01442                 <span class="keywordflow">if</span> (PageFrameIndex == 0) {
01443                     PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
01444                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01445                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01446                     <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageFrameIndex, Color);
01447 
01448                     <span class="comment">//</span>
01449                     <span class="comment">// Note the stamping must occur after the page is zeroed.</span>
01450                     <span class="comment">//</span>
01451 
01452                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a198">MI_BARRIER_STAMP_ZEROED_PAGE</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01453 
01454                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01455                 }
01456 
01457                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01458 
01459                 CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> += 1;
01460                 <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o4">DemandZeroCount</a> += 1;
01461 
01462                 <span class="comment">//</span>
01463                 <span class="comment">// This barrier check is needed after zeroing the page and</span>
01464                 <span class="comment">// before setting the PTE valid.</span>
01465                 <span class="comment">// Capture it now, check it at the last possible moment.</span>
01466                 <span class="comment">//</span>
01467 
01468                 BarrierStamp = (ULONG)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>;
01469 
01470                 <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 1);
01471 
01472                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01473 
01474                 <span class="comment">//</span>
01475                 <span class="comment">// As this page is demand zero, set the modified bit in the</span>
01476                 <span class="comment">// PFN database element and set the dirty bit in the PTE.</span>
01477                 <span class="comment">//</span>
01478 
01479 <span class="preprocessor">#if PFN_CONSISTENCY</span>
01480 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (PointerPde == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PTE_BASE)) {
01481                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01482                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageTablePage = 1;
01483                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01484                 }
01485 <span class="preprocessor">#endif</span>
01486 <span class="preprocessor"></span>
01487                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
01488                                    PageFrameIndex,
01489                                    PointerPte-&gt;u.Soft.Protection,
01490                                    PointerPte);
01491 
01492                 <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write != 0) {
01493                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
01494                 }
01495 
01496                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a197">MI_BARRIER_SYNCHRONIZE</a> (BarrierStamp);
01497 
01498                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
01499 
01500                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event == 0);
01501 
01502                 <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01503 
01504                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01505 
01506                 <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01507 
01508                 WorkingSetIndex = <a class="code" href="../../d4/d0/wslist_8c.html#a21">MiLocateAndReserveWsle</a> (&amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>);
01509                 <a class="code" href="../../d4/d0/wslist_8c.html#a25">MiUpdateWsle</a> (&amp;WorkingSetIndex,
01510                               VirtualAddress,
01511                               MmWorkingSetList,
01512                               Pfn1);
01513 
01514                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPte, WorkingSetIndex);
01515 
01516                 KeFillEntryTb ((PHARDWARE_PTE)PointerPte,
01517                                 VirtualAddress,
01518                                 FALSE);
01519             } <span class="keywordflow">else</span> {
01520                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01521             }
01522 
01523             status = STATUS_PAGE_FAULT_DEMAND_ZERO;
01524             <span class="keywordflow">goto</span> ReturnStatus1;
01525 
01526         } <span class="keywordflow">else</span> {
01527 
01528             <span class="comment">//</span>
01529             <span class="comment">// This is a prototype PTE.</span>
01530             <span class="comment">//</span>
01531 
01532             <span class="keywordflow">if</span> (ProtectionCode == <a class="code" href="../../d4/d8/mi_8h.html#a47">MM_UNKNOWN_PROTECTION</a>) {
01533 
01534                 <span class="comment">//</span>
01535                 <span class="comment">// The protection field is stored in the prototype PTE.</span>
01536                 <span class="comment">//</span>
01537 
01538                 PointerPte-&gt;u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (PointerProtoPte);
01539 
01540             } <span class="keywordflow">else</span> {
01541 
01542                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, PrototypePte);
01543                 PointerPte-&gt;u.Soft.Protection = ProtectionCode;
01544             }
01545             TempPte = *PointerPte;
01546         }
01547 
01548     } <span class="keywordflow">else</span> {
01549 
01550         <span class="comment">//</span>
01551         <span class="comment">// The PTE is non-zero and not valid, see if it is a prototype PTE.</span>
01552         <span class="comment">//</span>
01553 
01554         ProtectionCode = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a184">MI_GET_PROTECTION_FROM_SOFT_PTE</a>(&amp;TempPte);
01555 
01556         <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype != 0) {
01557             <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>) {
01558 <span class="preprocessor">#if DBG</span>
01559 <span class="preprocessor"></span>                MmProtoPteVadLookups += 1;
01560 <span class="preprocessor">#endif //DBG</span>
01561 <span class="preprocessor"></span>                PointerProtoPte = <a class="code" href="../../d8/d2/pagfault_8c.html#a19">MiCheckVirtualAddress</a> (VirtualAddress,
01562                                                          &amp;ProtectCode);
01563                 <span class="keywordflow">if</span> (PointerProtoPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01564                     status = STATUS_ACCESS_VIOLATION;
01565                     <span class="keywordflow">goto</span> ReturnStatus1;
01566                 }
01567 
01568             } <span class="keywordflow">else</span> {
01569 <span class="preprocessor">#if DBG</span>
01570 <span class="preprocessor"></span>                MmProtoPteDirect += 1;
01571 <span class="preprocessor">#endif //DBG</span>
01572 <span class="preprocessor"></span>
01573                 <span class="comment">//</span>
01574                 <span class="comment">// Protection is in the prototype PTE, indicate an</span>
01575                 <span class="comment">// access check should not be performed on the current PTE.</span>
01576                 <span class="comment">//</span>
01577 
01578                 PointerProtoPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (&amp;TempPte);
01579                 ProtectionCode = <a class="code" href="../../d4/d8/mi_8h.html#a47">MM_UNKNOWN_PROTECTION</a>;
01580 
01581                 <span class="comment">//</span>
01582                 <span class="comment">// Check to see if the proto protection has been overridden.</span>
01583                 <span class="comment">//</span>
01584 
01585                 <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Proto.ReadOnly != 0) {
01586                     ProtectionCode = <a class="code" href="../../d4/d8/mi_8h.html#a36">MM_READONLY</a>;
01587                 }
01588             }
01589         }
01590     }
01591 
01592     <span class="keywordflow">if</span> (ProtectionCode != <a class="code" href="../../d4/d8/mi_8h.html#a47">MM_UNKNOWN_PROTECTION</a>) {
01593         status = <a class="code" href="../../d4/d8/mi_8h.html#a833">MiAccessCheck</a> (PointerPte,
01594                                 StoreInstruction,
01595                                 PreviousMode,
01596                                 ProtectionCode,
01597                                 FALSE );
01598 
01599         <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
01600 <span class="preprocessor">#if DBG</span>
01601 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a79">MM_DBG_STOP_ON_ACCVIO</a>) &amp;&amp; (status == STATUS_ACCESS_VIOLATION)) {
01602                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:access violate - %p\n"</span>,VirtualAddress);
01603                 <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
01604                 DbgBreakPoint();
01605             }
01606 <span class="preprocessor">#endif //DEBUG</span>
01607 <span class="preprocessor"></span>
01608             <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
01609             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == PreviousIrql);
01610 
01611             <span class="keywordflow">if</span> (ApcNeeded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01612                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;NestedFaultCount == 0);
01613                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;ApcNeeded == 0);
01614                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == PASSIVE_LEVEL);
01615                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (APC_LEVEL, &amp;PreviousIrql);
01616                 <a class="code" href="../../d4/d6/iosubs_8c.html#a136">IoRetryIrpCompletions</a> ();
01617                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (PreviousIrql);
01618             }
01619 
01620             <span class="comment">//</span>
01621             <span class="comment">// Check to see if this is a guard page violation</span>
01622             <span class="comment">// and if so, should the user's stack be extended.</span>
01623             <span class="comment">//</span>
01624 
01625             <span class="keywordflow">if</span> (status == STATUS_GUARD_PAGE_VIOLATION) {
01626                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a834">MiCheckForUserStackOverflow</a> (VirtualAddress);
01627             }
01628 
01629             <span class="keywordflow">return</span> status;
01630         }
01631     }
01632 
01633     <span class="comment">//</span>
01634     <span class="comment">// This is a page fault, invoke the page fault handler.</span>
01635     <span class="comment">//</span>
01636 
01637     <span class="keywordflow">if</span> (PointerProtoPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01638 
01639         <span class="comment">//</span>
01640         <span class="comment">// Lock page containing prototype PTEs in memory by</span>
01641         <span class="comment">// incrementing the reference count for the page.</span>
01642         <span class="comment">//</span>
01643 
01644 
01645         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(PointerProtoPte)) {
01646             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerProtoPte);
01647             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01648             <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01649                 <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerProtoPte);
01650             }
01651             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01652             <a class="code" href="../../d4/d8/mi_8h.html#a186">MI_ADD_LOCKED_PAGE_CHARGE</a>(Pfn1, 2);
01653             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
01654             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
01655             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01656         }
01657     }
01658     status = <a class="code" href="../../d8/d2/pagfault_8c.html#a11">MiDispatchFault</a> (StoreInstruction,
01659                               VirtualAddress,
01660                               PointerPte,
01661                               PointerProtoPte,
01662                               CurrentProcess,
01663                               &amp;ApcNeeded);
01664 
01665 <span class="preprocessor">#if DBG</span>
01666 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ApcNeeded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01667         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;NestedFaultCount == 0);
01668         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;ApcNeeded == 0);
01669     }
01670 <span class="preprocessor">#endif</span>
01671 <span class="preprocessor"></span>
01672     <span class="keywordflow">if</span> (PointerProtoPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01673 
01674         <span class="comment">//</span>
01675         <span class="comment">// Unlock page containing prototype PTEs.</span>
01676         <span class="comment">//</span>
01677 
01678         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(PointerProtoPte)) {
01679             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01680             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
01681             <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a>(Pfn1, 3);
01682             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount -= 1;
01683             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01684         }
01685     }
01686 
01687 ReturnStatus1:
01688 
01689     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt;= APC_LEVEL);
01690     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> == <a class="code" href="../../d4/d8/mi_8h.html#a32">MM_GROW_WSLE_HASH</a>) {
01691         <a class="code" href="../../d4/d0/wslist_8c.html#a33">MiGrowWsleHash</a> (&amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>);
01692         <a class="code" href="../../d4/d8/mi_8h.html#a142">LOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
01693         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01694         <a class="code" href="../../d4/d8/mi_8h.html#a143">UNLOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
01695     }
01696 
01697 ReturnStatus2:
01698 
01699     PageFrameIndex = CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> - CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
01700 
01701     <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
01702     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == PreviousIrql);
01703 
01704     <span class="keywordflow">if</span> (ApcNeeded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01705         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;NestedFaultCount == 0);
01706         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;ApcNeeded == 0);
01707         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == PASSIVE_LEVEL);
01708         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (APC_LEVEL, &amp;PreviousIrql);
01709         <a class="code" href="../../d4/d6/iosubs_8c.html#a136">IoRetryIrpCompletions</a> ();
01710         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (PreviousIrql);
01711     }
01712 
01713     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a>) {
01714 
01715         <span class="keywordflow">if</span> (((SPFN_NUMBER)PageFrameIndex &gt; 100) &amp;&amp;
01716             (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Tcb.Priority &gt;= LOW_REALTIME_PRIORITY)) {
01717 
01718             <span class="comment">//</span>
01719             <span class="comment">// This thread is realtime and is well over the process'</span>
01720             <span class="comment">// working set minimum.  Delay execution so the trimmer &amp; the</span>
01721             <span class="comment">// modified page writer get a quick shot at making pages.</span>
01722             <span class="comment">//</span>
01723 
01724             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;MmShortTime);
01725         }
01726     }
01727 
01728     NotifyRoutine = <a class="code" href="../../d4/d8/mi_8h.html#a746">MmPageFaultNotifyRoutine</a>;
01729     <span class="keywordflow">if</span> (NotifyRoutine) {
01730         <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
01731             (*NotifyRoutine) (
01732                 status,
01733                 VirtualAddress,
01734                 TrapInformation
01735                 );
01736         }
01737     }
01738 
01739     <span class="keywordflow">return</span> status;
01740 
01741 AccessViolation:
01742     <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01743         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (PreviousIrql);
01744     }
01745     <span class="keywordflow">else</span> {
01746         <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (PreviousIrql);
01747     }
01748     <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01749 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a281" doxytag="mm.h::MmAddPhysicalMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS MmAddPhysicalMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PPHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>StartAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00043">43</a> of file <a class="el" href="../../d0/d3/dynmem_8c-source.html">dynmem.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00059">ASSERT64</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00034">_PHYSICAL_MEMORY_RUN::BasePage</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01177">MiRemoveZeroPage()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04899">MmChargeCommitmentLock</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00024">MmDynamicMemoryMutex</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00085">MmDynamicPfn</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00076">MmHighestPossiblePhysicalPage</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00399">MmNumberOfPhysicalPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00075">MmPfnDatabase</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">MmPhysicalMemoryBlock</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00041">MmTotalCommitLimit</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00100">MmTotalCommitLimitMaximum</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00040">MmTotalCommittedPages</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00040">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfPages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00039">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfRuns</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00035">_PHYSICAL_MEMORY_RUN::PageCount</a>, <a class="el" href="../../d2/d2/ppcdef_8h-source.html#l00079">PASSIVE_LEVEL</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00033">PFN_REMOVED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02433">PMMPTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00282">PTE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00041">_PHYSICAL_MEMORY_DESCRIPTOR::Run</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00038">ValidKernelPte</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
<pre class="fragment"><div>00050                    :
00051 
00052     This routine adds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical address range to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
00053     This includes initializing PFN database entries and adding <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00054     freelists.
00055 
00056 Arguments:
00057 
00058     StartAddress  - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting physical address.
00059 
00060     NumberOfBytes  - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes being added.
00061                      If any bytes were added (ie: STATUS_SUCCESS is being
00062                      returned), <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual amount <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned here.
00063 
00064 Return Value:
00065 
00066     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>.
00067 
00068 Environment:
00069 
00070     Kernel mode.  PASSIVE level.  No locks held.
00071 
00072 --*/
00073 
00074 {
00075     ULONG i;
00076     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00077     KIRQL OldIrql;
00078     LOGICAL Inserted;
00079     LOGICAL Updated;
00080     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00081     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00082     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00083     PFN_NUMBER NumberOfPages;
00084     PFN_NUMBER start;
00085     PFN_NUMBER count;
00086     PFN_NUMBER StartPage;
00087     PFN_NUMBER EndPage;
00088     PFN_NUMBER PageFrameIndex;
00089     PFN_NUMBER Page;
00090     PFN_NUMBER LastPage;
00091     PFN_COUNT PagesNeeded;
00092     <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> OldPhysicalMemoryBlock;
00093     <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> NewPhysicalMemoryBlock;
00094     <a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PPHYSICAL_MEMORY_RUN</a> NewRun;
00095     LOGICAL PfnDatabaseIsPhysical;
00096 
00097     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == PASSIVE_LEVEL);
00098 
00099     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(NumberOfBytes-&gt;LowPart) == 0);
00100     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(StartAddress-&gt;LowPart) == 0);
00101 
00102     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(MmPfnDatabase)) {
00103 
00104         <span class="comment">//</span>
00105         <span class="comment">// The system must be configured for dynamic memory addition.  This is</span>
00106         <span class="comment">// critical as only then is the database guaranteed to be non-sparse.</span>
00107         <span class="comment">//</span>
00108     
00109         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a29">MmDynamicPfn</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00110             <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00111         }
00112 
00113         PfnDatabaseIsPhysical = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00114     }
00115     <span class="keywordflow">else</span> {
00116         PfnDatabaseIsPhysical = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00117     }
00118 
00119     StartPage = (PFN_NUMBER)(StartAddress-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00120     NumberOfPages = (PFN_NUMBER)(NumberOfBytes-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00121 
00122     EndPage = StartPage + NumberOfPages;
00123 
00124     <span class="keywordflow">if</span> (EndPage - 1 &gt; <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a>) {
00125 
00126         <span class="comment">//</span>
00127         <span class="comment">// Truncate the request into something that can be mapped by the PFN</span>
00128         <span class="comment">// database.</span>
00129         <span class="comment">//</span>
00130 
00131         EndPage = <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> + 1;
00132         NumberOfPages = EndPage - StartPage;
00133     }
00134 
00135     <span class="comment">//</span>
00136     <span class="comment">// The range cannot wrap.</span>
00137     <span class="comment">//</span>
00138 
00139     <span class="keywordflow">if</span> (StartPage &gt;= EndPage) {
00140         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_1;
00141     }
00142 
00143     ExAcquireFastMutex (&amp;MmDynamicMemoryMutex);
00144 
00145     i = (<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PHYSICAL_MEMORY_DESCRIPTOR</a>) +
00146          (<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a>) * (<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> + 1)));
00147 
00148     NewPhysicalMemoryBlock = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
00149                                                     i,
00150                                                     '  mM');
00151 
00152     <span class="keywordflow">if</span> (NewPhysicalMemoryBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00153         ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
00154         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00155     }
00156 
00157     <span class="comment">//</span>
00158     <span class="comment">// The range cannot overlap any ranges that are already present.</span>
00159     <span class="comment">//</span>
00160 
00161     start = 0;
00162 
00163     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00164 
00165     <span class="keywordflow">do</span> {
00166 
00167         count = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
00168         Page = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
00169 
00170         <span class="keywordflow">if</span> (count != 0) {
00171 
00172             LastPage = Page + count;
00173 
00174             <span class="keywordflow">if</span> ((StartPage &lt; Page) &amp;&amp; (EndPage &gt; Page)) {
00175                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00176                 ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
00177                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewPhysicalMemoryBlock);
00178                 <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
00179             }
00180 
00181             <span class="keywordflow">if</span> ((StartPage &gt;= Page) &amp;&amp; (StartPage &lt; LastPage)) {
00182                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00183                 ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
00184                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewPhysicalMemoryBlock);
00185                 <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
00186             }
00187         }
00188 
00189         start += 1;
00190 
00191     } <span class="keywordflow">while</span> (start != <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>);
00192 
00193     <span class="comment">//</span>
00194     <span class="comment">// Fill any gaps in the (sparse) PFN database needed for these pages,</span>
00195     <span class="comment">// unless the PFN database was physically allocated and completely</span>
00196     <span class="comment">// committed up front.</span>
00197     <span class="comment">//</span>
00198 
00199     PagesNeeded = 0;
00200 
00201     <span class="keywordflow">if</span> (PfnDatabaseIsPhysical == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00202         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(StartPage));
00203         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PCHAR)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(EndPage)) - 1);
00204     
00205         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00206             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00207                 PagesNeeded += 1;
00208             }
00209             PointerPte += 1;
00210         }
00211     
00212         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; PagesNeeded) {
00213             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00214             ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
00215             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewPhysicalMemoryBlock);
00216             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00217         }
00218     
00219         TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
00220     
00221         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(StartPage));
00222     
00223         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00224             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00225     
00226                 PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a>(MI_GET_PAGE_COLOR_FROM_PTE (PointerPte));
00227     
00228                 <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 0);
00229     
00230                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
00231                 *PointerPte = TempPte;
00232             }
00233             PointerPte += 1;
00234         }
00235         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= PagesNeeded;
00236     }
00237 
00238     <span class="comment">//</span>
00239     <span class="comment">// If the new range is adjacent to an existing range, just merge it into</span>
00240     <span class="comment">// the old block.  Otherwise use the new block as a new entry will have to</span>
00241     <span class="comment">// be used.</span>
00242     <span class="comment">//</span>
00243 
00244     NewPhysicalMemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> + 1;
00245     NewPhysicalMemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> + NumberOfPages;
00246 
00247     NewRun = &amp;NewPhysicalMemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[0];
00248     start = 0;
00249     Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00250     Updated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00251 
00252     <span class="keywordflow">do</span> {
00253 
00254         Page = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
00255         count = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
00256 
00257         <span class="keywordflow">if</span> (Inserted == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00258 
00259             <span class="comment">//</span>
00260             <span class="comment">// Note overlaps into adjacent ranges were already checked above.</span>
00261             <span class="comment">//</span>
00262 
00263             <span class="keywordflow">if</span> (StartPage == Page + count) {
00264                 <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> += NumberOfPages;
00265                 OldPhysicalMemoryBlock = NewPhysicalMemoryBlock;
00266                 <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> += NumberOfPages;
00267 
00268                 <span class="comment">//</span>
00269                 <span class="comment">// Coalesce below and above to avoid leaving zero length gaps</span>
00270                 <span class="comment">// as these gaps would prevent callers from removing ranges</span>
00271                 <span class="comment">// the span them.</span>
00272                 <span class="comment">//</span>
00273 
00274                 <span class="keywordflow">if</span> (start + 1 &lt; <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>) {
00275 
00276                     start += 1;
00277                     Page = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
00278                     count = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
00279 
00280                     <span class="keywordflow">if</span> (StartPage + NumberOfPages == Page) {
00281                         <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start - 1].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> +=
00282                             count;
00283                         <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> -= 1;
00284 
00285                         <span class="comment">//</span>
00286                         <span class="comment">// Copy any remaining entries.</span>
00287                         <span class="comment">//</span>
00288     
00289                         <span class="keywordflow">if</span> (start != <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>) {
00290                             RtlMoveMemory (&amp;<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start],
00291                                            &amp;<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start + 1],
00292                                            (<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> - start) * sizeof (<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a>));
00293                         }
00294                     }
00295                 }
00296                 Updated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00297                 <span class="keywordflow">break</span>;
00298             }
00299 
00300             <span class="keywordflow">if</span> (StartPage + NumberOfPages == Page) {
00301                 <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> = StartPage;
00302                 <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> += NumberOfPages;
00303                 OldPhysicalMemoryBlock = NewPhysicalMemoryBlock;
00304                 <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> += NumberOfPages;
00305                 Updated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00306                 <span class="keywordflow">break</span>;
00307             }
00308 
00309             <span class="keywordflow">if</span> (StartPage + NumberOfPages &lt;= Page) {
00310 
00311                 <span class="keywordflow">if</span> (start + 1 &lt; <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>) {
00312 
00313                     <span class="keywordflow">if</span> (StartPage + NumberOfPages &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start + 1].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>) {
00314                         <span class="comment">//</span>
00315                         <span class="comment">// Don't insert here - the new entry really belongs</span>
00316                         <span class="comment">// (at least) one entry further down.</span>
00317                         <span class="comment">//</span>
00318 
00319                         <span class="keywordflow">continue</span>;
00320                     }
00321                 }
00322 
00323                 NewRun-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> = StartPage;
00324                 NewRun-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> = NumberOfPages;
00325                 NewRun += 1;
00326                 Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00327                 Updated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00328             }
00329         }
00330 
00331         *NewRun = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start];
00332         NewRun += 1;
00333 
00334         start += 1;
00335 
00336     } <span class="keywordflow">while</span> (start != <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>);
00337 
00338     <span class="comment">//</span>
00339     <span class="comment">// If the memory block has not been updated, then the new entry must</span>
00340     <span class="comment">// be added at the very end.</span>
00341     <span class="comment">//</span>
00342 
00343     <span class="keywordflow">if</span> (Updated == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00344         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Inserted == FALSE);
00345         NewRun-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> = StartPage;
00346         NewRun-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> = NumberOfPages;
00347         Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00348     }
00349 
00350     <span class="comment">//</span>
00351     <span class="comment">// Repoint the MmPhysicalMemoryBlock at the new chunk, free the old after</span>
00352     <span class="comment">// releasing the PFN lock.</span>
00353     <span class="comment">//</span>
00354 
00355     <span class="keywordflow">if</span> (Inserted == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00356         OldPhysicalMemoryBlock = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>;
00357         <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a> = NewPhysicalMemoryBlock;
00358     }
00359 
00360     <span class="comment">//</span>
00361     <span class="comment">// Note that the page directory (page parent entries on Win64) must be</span>
00362     <span class="comment">// filled in at system boot so that already-created processes do not fault</span>
00363     <span class="comment">// when referencing the new PFNs.</span>
00364     <span class="comment">//</span>
00365 
00366     <span class="comment">//</span>
00367     <span class="comment">// Walk through the memory descriptors and add pages to the</span>
00368     <span class="comment">// free list in the PFN database.</span>
00369     <span class="comment">//</span>
00370 
00371     PageFrameIndex = StartPage;
00372     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00373 
00374     <span class="keywordflow">if</span> (EndPage - 1 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
00375         <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> = EndPage - 1;
00376     }
00377 
00378     <span class="keywordflow">while</span> (PageFrameIndex &lt; EndPage) {
00379 
00380         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
00381         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ShortFlags == 0);
00382         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
00383         <a class="code" href="../../d4/d8/mi_8h.html#a1">ASSERT64</a> (Pfn1-&gt;UsedPageTableEntries == 0);
00384         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00385         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> == 0);
00386         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> == PFN_REMOVED) ||
00387                 (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> == (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(UINT_PTR)0));
00388 
00389         <span class="comment">//</span>
00390         <span class="comment">// Set the PTE address to the physical page for</span>
00391         <span class="comment">// virtual address alignment checking.</span>
00392         <span class="comment">//</span>
00393 
00394         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(PageFrameIndex &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
00395 
00396         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
00397                             PageFrameIndex);
00398 
00399         PageFrameIndex += 1;
00400         
00401         Pfn1 += 1;
00402     }
00403 
00404     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += NumberOfPages;
00405     <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> += (PFN_COUNT)NumberOfPages;
00406 
00407     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00408 
00409     <span class="comment">//</span>
00410     <span class="comment">// Increase all commit limits to reflect the additional memory.</span>
00411     <span class="comment">//</span>
00412 
00413     ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
00414 
00415     <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> += NumberOfPages;
00416     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> += NumberOfPages;
00417 
00418     <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> += PagesNeeded;
00419 
00420     ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
00421 
00422     ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
00423 
00424     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (OldPhysicalMemoryBlock);
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// Indicate number of bytes actually added to our caller.</span>
00428     <span class="comment">//</span>
00429 
00430     NumberOfBytes-&gt;QuadPart = (ULONGLONG)NumberOfPages * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00431 
00432     <span class="keywordflow">return</span> STATUS_SUCCESS;
00433 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a245" doxytag="mm.h::MmAddVerifierThunks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmAddVerifierThunks           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ThunkBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ThunkBufferSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/verifier_8c-source.html#l03846">3846</a> of file <a class="el" href="../../d0/d5/verifier_8c-source.html">verifier.c</a>.
<p>
References <a class="el" href="../../d0/d5/verifier_8c-source.html#l00512">_DRIVER_SPECIFIED_VERIFIER_THUNKS::DataTableEntry</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00178">KeReleaseMutant()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00591">KSEG0_BASE</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l00511">_DRIVER_SPECIFIED_VERIFIER_THUNKS::ListEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04192">MiActiveVerifierThunks</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06991">MiLookupDataTableEntry()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l00400">MiVerifierDriverAddedThunkListHead</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00164">MM_BOOT_IMAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00928">MmSystemLoadLock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l00513">_DRIVER_SPECIFIED_VERIFIER_THUNKS::NumberOfThunks</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a40">PDRIVER_SPECIFIED_VERIFIER_THUNKS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>.
<p>
<pre class="fragment"><div>03853                    :
03854 
03855     This routine adds another set of thunks to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> verifier list.
03856 
03857 Arguments:
03858 
03859     ThunkBuffer - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thunk pairs.
03860 
03861     ThunkBufferSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thunk buffer.
03862 
03863 Return Value:
03864 
03865     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
03866 
03867 Environment:
03868 
03869     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> and below.
03870 
03871 --*/
03872 
03873 {
03874     ULONG i;
03875     ULONG NumberOfThunkPairs;
03876     PDRIVER_VERIFIER_THUNK_PAIRS ThunkPairs;
03877     PDRIVER_VERIFIER_THUNK_PAIRS ThunkTable;
03878     <a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html">PDRIVER_SPECIFIED_VERIFIER_THUNKS</a> ThunkTableBase;
03879     PLDR_DATA_TABLE_ENTRY DataTableEntry;
03880     PVOID DriverStartAddress;
03881     PVOID DriverEndAddress;
03882 
03883     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03884 
03885     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a33">MiVerifierDriverAddedThunkListHead</a>.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03886         <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
03887     }
03888 
03889     ThunkPairs = (PDRIVER_VERIFIER_THUNK_PAIRS)ThunkBuffer;
03890     NumberOfThunkPairs = ThunkBufferSize / <span class="keyword">sizeof</span>(DRIVER_VERIFIER_THUNK_PAIRS);
03891 
03892     <span class="keywordflow">if</span> (NumberOfThunkPairs == 0) {
03893         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_1;
03894     }
03895 
03896     ThunkTableBase = (<a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html">PDRIVER_SPECIFIED_VERIFIER_THUNKS</a>) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
03897                             PagedPool,
03898                             <span class="keyword">sizeof</span> (<a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html">DRIVER_SPECIFIED_VERIFIER_THUNKS</a>) + NumberOfThunkPairs * <span class="keyword">sizeof</span> (DRIVER_VERIFIER_THUNK_PAIRS),
03899                             'tVmM');
03900 
03901     <span class="keywordflow">if</span> (ThunkTableBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03902         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03903     }
03904 
03905     ThunkTable = (PDRIVER_VERIFIER_THUNK_PAIRS)(ThunkTableBase + 1);
03906 
03907     RtlCopyMemory (ThunkTable,
03908                    ThunkPairs,
03909                    NumberOfThunkPairs * <span class="keyword">sizeof</span>(DRIVER_VERIFIER_THUNK_PAIRS));
03910 
03911     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
03912 
03913     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;MmSystemLoadLock,
03914                            WrVirtualMemory,
03915                            KernelMode,
03916                            FALSE,
03917                            (PLARGE_INTEGER)NULL);
03918 
03919     <span class="comment">//</span>
03920     <span class="comment">// Find and validate the image that contains the routines to be thunked.</span>
03921     <span class="comment">//</span>
03922 
03923     DataTableEntry = <a class="code" href="../../d4/d8/mi_8h.html#a874">MiLookupDataTableEntry</a> (ThunkTable-&gt;PristineRoutine,
03924                                              TRUE);
03925 
03926     <span class="keywordflow">if</span> (DataTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03927         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;MmSystemLoadLock, 1, FALSE, FALSE);
03928         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03929         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ThunkTableBase);
03930         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
03931     }
03932 
03933     DriverStartAddress = (PVOID)(DataTableEntry-&gt;DllBase);
03934     DriverEndAddress = (PVOID)((PCHAR)DataTableEntry-&gt;DllBase + DataTableEntry-&gt;SizeOfImage);
03935 
03936     <span class="comment">//</span>
03937     <span class="comment">// Don't let drivers hook calls to kernel or HAL routines.</span>
03938     <span class="comment">//</span>
03939 
03940     <span class="keywordflow">if</span> (DriverStartAddress &lt; (PVOID)(<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> + <a class="code" href="../../d6/d8/mi386_8h.html#a4">MM_BOOT_IMAGE_SIZE</a>)) {
03941         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;MmSystemLoadLock, 1, FALSE, FALSE);
03942         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03943         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ThunkTableBase);
03944         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
03945     }
03946 
03947     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfThunkPairs; i += 1) {
03948 
03949         <span class="comment">//</span>
03950         <span class="comment">// Ensure all the routines being thunked are in the same driver.</span>
03951         <span class="comment">//</span>
03952 
03953         <span class="keywordflow">if</span> (((ULONG_PTR)ThunkTable-&gt;PristineRoutine &lt; (ULONG_PTR)DriverStartAddress) ||
03954             ((ULONG_PTR)ThunkTable-&gt;PristineRoutine &gt;= (ULONG_PTR)DriverEndAddress)) {
03955 
03956             <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;MmSystemLoadLock, 1, FALSE, FALSE);
03957             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03958             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ThunkTableBase);
03959             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
03960         }
03961         ThunkTable += 1;
03962     }
03963 
03964     <span class="comment">//</span>
03965     <span class="comment">// Add the validated thunk table to the verifier's global list.</span>
03966     <span class="comment">//</span>
03967 
03968     ThunkTableBase-&gt;<a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html#o1">DataTableEntry</a> = DataTableEntry;
03969     ThunkTableBase-&gt;<a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html#o2">NumberOfThunks</a> = NumberOfThunkPairs;
03970     <a class="code" href="../../d4/d8/mi_8h.html#a554">MiActiveVerifierThunks</a> += 1;
03971 
03972     InsertTailList (&amp;MiVerifierDriverAddedThunkListHead,
03973                     &amp;ThunkTableBase-&gt;<a class="code" href="../../d5/d9/struct__DRIVER__SPECIFIED__VERIFIER__THUNKS.html#o0">ListEntry</a>);
03974 
03975     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;MmSystemLoadLock, 1, FALSE, FALSE);
03976     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03977 
03978     <span class="keywordflow">return</span> STATUS_SUCCESS;
03979 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a227" doxytag="mm.h::MmAdjustPageFileQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmAdjustPageFileQuota           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NewPageFileQuota</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a226" doxytag="mm.h::MmAdjustWorkingSetSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS MmAdjustWorkingSetSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkingSetMinimum</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkingSetMaximum</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemCache</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">2450</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00216">_EPROCESS::AddressSpaceDeleted</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00066">_MMSUPPORT::AllowWorkingSetAdjustment</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01599">_MMWSL::FirstFree</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01607">_MMWSL::HashTable</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01601">_MMWSL::LastEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01605">_MMWSL::LastInitializedWsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01039">LOCK_WS</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00063">_MMSUPPORT::MaximumWorkingSetSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04360">MI_NONPAGABLE_MEMORY_AVAILABLE</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02824">MiAddWorkingSetPage()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l04726">MiEmptyWorkingSet()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01326">MiFreeWsle()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03300">MiGrowWsleHash()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00062">_MMSUPPORT::MinimumWorkingSetSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00088">MM_FLUID_WORKING_SET</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00045">MM_RETRY_COUNT</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04948">MmAllowWorkingSetExpansion()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00687">MmMaximumWorkingSetSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05152">MmMinimumWorkingSetSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04506">MmPagesAboveWsMinimum</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02174">PERFINFO_GET_PAGE_INFO</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02195">PERFINFO_LOG_WS_REMOVAL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02201">PERFINFO_PAGE_INFO_DECL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01598">_MMWSL::Quota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01081">UNLOCK_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01583">_MMWSLE::VirtualAddress</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00064">_MMSUPPORT::VmWorkingSetList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01603">_MMWSL::Wsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00078">WSLE_NULL_INDEX</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00439">PspAddProcessToJob()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01211">PspSetQuotaLimits()</a>, and <a class="el" href="../../d5/d8/minmax_8c-source.html#l01329">xxxMinMaximize()</a>.
<p>
<pre class="fragment"><div>02458                    :
02459 
02460     This routine adjusts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current size of a process's working set
02461     list.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> above <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current maximum, pages
02462     are removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set list.
02463 
02464     An exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> raised <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> limit cannot be granted.  This
02465     could occur <span class="keywordflow">if</span> too many pages were locked in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process's
02466     working set.
02467 
02468     Note: <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> and maximum are both (SIZE_T)-1, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set
02469           <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> purged, but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">default</span> sizes are not changed.
02470 
02471 Arguments:
02472 
02473     WorkingSetMinimumInBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> working set size in
02474                                bytes.
02475 
02476     WorkingSetMaximumInBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> maximum working set size in
02477                                bytes.
02478 
02479     SystemCache - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cache working set <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
02480                   adjusted, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">for</span> all other working sets.
02481 
02482 Return Value:
02483 
02484     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>.
02485 
02486 Environment:
02487 
02488     Kernel mode, IRQL <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
02489 
02490 --*/
02491 
02492 
02493 {
02494     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
02495     ULONG Entry;
02496     ULONG LastFreed;
02497     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
02498     KIRQL OldIrql;
02499     KIRQL OldIrql2;
02500     SPFN_NUMBER i;
02501     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02502     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ReturnStatus;
02503     LONG PagesAbove;
02504     LONG NewPagesAbove;
02505     ULONG FreeTryCount;
02506     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo;
02507     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
02508     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetMinimum;
02509     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetMaximum;
02510 
02511     <a class="code" href="../../d2/d1/mm_8h.html#a80">PERFINFO_PAGE_INFO_DECL</a>();
02512 
02513     FreeTryCount = 0;
02514 
02515     <span class="keywordflow">if</span> (SystemCache) {
02516         WsInfo = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
02517     } <span class="keywordflow">else</span> {
02518         CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
02519         WsInfo = &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>;
02520     }
02521 
02522     <span class="keywordflow">if</span> ((WorkingSetMinimumInBytes == (SIZE_T)-1) &amp;&amp;
02523         (WorkingSetMaximumInBytes == (SIZE_T)-1)) {
02524         <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/wslist_8c.html#a35">MiEmptyWorkingSet</a> (WsInfo, TRUE);
02525     }
02526 
02527     <span class="keywordflow">if</span> (WorkingSetMinimumInBytes == 0) {
02528         WorkingSetMinimum = WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
02529     }
02530     <span class="keywordflow">else</span> {
02531         WorkingSetMinimum = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WorkingSetMinimumInBytes &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02532     }
02533 
02534     <span class="keywordflow">if</span> (WorkingSetMaximumInBytes == 0) {
02535         WorkingSetMaximum = WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a>;
02536     }
02537     <span class="keywordflow">else</span> {
02538         WorkingSetMaximum = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WorkingSetMaximumInBytes &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02539     }
02540 
02541     <span class="keywordflow">if</span> (WorkingSetMinimum &gt; WorkingSetMaximum) {
02542         <span class="keywordflow">return</span> STATUS_BAD_WORKING_SET_LIMIT;
02543     }
02544 
02545     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
02546 
02547     ReturnStatus = STATUS_SUCCESS;
02548 
02549     <span class="comment">//</span>
02550     <span class="comment">// Get the working set lock and disable APCs.</span>
02551     <span class="comment">//</span>
02552 
02553     <span class="keywordflow">if</span> (SystemCache) {
02554         <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrql2);
02555     } <span class="keywordflow">else</span> {
02556         <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (CurrentProcess);
02557 
02558         <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) {
02559             ReturnStatus = STATUS_PROCESS_IS_TERMINATING;
02560             <span class="keywordflow">goto</span> Returns;
02561         }
02562     }
02563 
02564     <span class="keywordflow">if</span> (WorkingSetMaximum &gt; <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a>) {
02565         WorkingSetMaximum = <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a>;
02566         ReturnStatus = STATUS_WORKING_SET_LIMIT_RANGE;
02567     }
02568 
02569     <span class="keywordflow">if</span> (WorkingSetMinimum &gt; <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a>) {
02570         WorkingSetMinimum = <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a>;
02571         ReturnStatus = STATUS_WORKING_SET_LIMIT_RANGE;
02572     }
02573 
02574     <span class="keywordflow">if</span> (WorkingSetMinimum &lt; <a class="code" href="../../d4/d8/mi_8h.html#a741">MmMinimumWorkingSetSize</a>) {
02575         WorkingSetMinimum = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a741">MmMinimumWorkingSetSize</a>;
02576         ReturnStatus = STATUS_WORKING_SET_LIMIT_RANGE;
02577     }
02578 
02579     <span class="comment">//</span>
02580     <span class="comment">// Make sure that the number of locked pages will not</span>
02581     <span class="comment">// make the working set not fluid.</span>
02582     <span class="comment">//</span>
02583 
02584     <span class="keywordflow">if</span> ((WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> + <a class="code" href="../../d4/d8/mi_8h.html#a15">MM_FLUID_WORKING_SET</a>) &gt;=
02585          WorkingSetMaximum) {
02586         ReturnStatus = STATUS_BAD_WORKING_SET_LIMIT;
02587         <span class="keywordflow">goto</span> Returns;
02588     }
02589 
02590     WorkingSetList = WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>;
02591     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
02592 
02593     <span class="comment">//</span>
02594     <span class="comment">// Check to make sure ample resident physical pages exist for</span>
02595     <span class="comment">// this operation.</span>
02596     <span class="comment">//</span>
02597 
02598     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02599 
02600     i = WorkingSetMinimum - WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
02601 
02602     <span class="keywordflow">if</span> (i &gt; 0) {
02603 
02604         <span class="comment">//</span>
02605         <span class="comment">// New minimum working set is greater than the old one.  Ensure that</span>
02606         <span class="comment">// we don't allow this process' working set minimum to increase to</span>
02607         <span class="comment">// a point where subsequent nonpaged pool allocations could cause</span>
02608         <span class="comment">// us to run out of pages.  Additionally, leave 100 extra pages around</span>
02609         <span class="comment">// so the user can later bring up tlist and kill processes if necessary.</span>
02610         <span class="comment">//</span>
02611 
02612         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; (20 + (i / (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span> (<a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a>))))) {
02613             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02614             ReturnStatus = STATUS_INSUFFICIENT_RESOURCES;
02615             <span class="keywordflow">goto</span> Returns;
02616         }
02617 
02618         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() - 100 &lt; i) {
02619             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02620             ReturnStatus = STATUS_INSUFFICIENT_RESOURCES;
02621             <span class="keywordflow">goto</span> Returns;
02622         }
02623     }
02624 
02625     <span class="comment">//</span>
02626     <span class="comment">// Adjust the number of resident pages up or down dependent on</span>
02627     <span class="comment">// the size of the new minimum working set size versus the previous</span>
02628     <span class="comment">// minimum size.</span>
02629     <span class="comment">//</span>
02630 
02631     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= i;
02632     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(27, i);
02633 
02634     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02635 
02636     <span class="keywordflow">if</span> (WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02637         <a class="code" href="../../d4/d5/procsup_8c.html#a43">MmAllowWorkingSetExpansion</a> ();
02638     }
02639 
02640     <span class="keywordflow">if</span> (WorkingSetMaximum &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) {
02641 
02642          <span class="keywordflow">do</span> {
02643 
02644             <span class="comment">//</span>
02645             <span class="comment">// The maximum size of the working set is being increased, check</span>
02646             <span class="comment">// to ensure the proper number of pages are mapped to cover</span>
02647             <span class="comment">// the complete working set list.</span>
02648             <span class="comment">//</span>
02649 
02650             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d0/wslist_8c.html#a16">MiAddWorkingSetPage</a> (WsInfo)) {
02651                 WorkingSetMaximum = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a> - 1;
02652                 <span class="keywordflow">break</span>;
02653             }
02654         } <span class="keywordflow">while</span> (WorkingSetMaximum &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>);
02655 
02656     } <span class="keywordflow">else</span> {
02657 
02658         <span class="comment">//</span>
02659         <span class="comment">// The new working set maximum is less than the current working set</span>
02660         <span class="comment">// maximum.</span>
02661         <span class="comment">//</span>
02662 
02663         <span class="keywordflow">if</span> (WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt; WorkingSetMaximum) {
02664 
02665             <span class="comment">//</span>
02666             <span class="comment">// Remove some pages from the working set.</span>
02667             <span class="comment">//</span>
02668 
02669             <span class="comment">//</span>
02670             <span class="comment">// Make sure that the number of locked pages will not</span>
02671             <span class="comment">// make the working set not fluid.</span>
02672             <span class="comment">//</span>
02673 
02674             <span class="keywordflow">if</span> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> + <a class="code" href="../../d4/d8/mi_8h.html#a15">MM_FLUID_WORKING_SET</a>) &gt;=
02675                  WorkingSetMaximum) {
02676 
02677                 ReturnStatus = STATUS_BAD_WORKING_SET_LIMIT;
02678 
02679                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02680 
02681                 <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += i;
02682                 <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(54, i);
02683 
02684                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02685 
02686                 <span class="keywordflow">goto</span> Returns;
02687             }
02688 
02689             <span class="comment">//</span>
02690             <span class="comment">// Attempt to remove the pages from the Maximum downward.</span>
02691             <span class="comment">//</span>
02692 
02693             LastFreed = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>;
02694             <span class="keywordflow">if</span> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> &gt; WorkingSetMaximum) {
02695 
02696                 <span class="keywordflow">while</span> (LastFreed &gt;= WorkingSetMaximum) {
02697 
02698                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(
02699                                         Wsle[LastFreed].u1.VirtualAddress);
02700 
02701                     <a class="code" href="../../d2/d1/mm_8h.html#a53">PERFINFO_GET_PAGE_INFO</a>(PointerPte);
02702 
02703                     <span class="keywordflow">if</span> ((Wsle[LastFreed].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid != 0) &amp;&amp;
02704                         (!<a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a> (LastFreed,
02705                                       WsInfo,
02706                                       PointerPte))) {
02707 
02708                         <span class="comment">//</span>
02709                         <span class="comment">// This LastFreed could not be removed.</span>
02710                         <span class="comment">//</span>
02711 
02712                         <span class="keywordflow">break</span>;
02713                     }
02714                     <a class="code" href="../../d2/d1/mm_8h.html#a74">PERFINFO_LOG_WS_REMOVAL</a>(PERFINFO_LOG_TYPE_OUTWS_ADJUSTWS, WsInfo);
02715                     LastFreed -= 1;
02716                 }
02717                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> = LastFreed;
02718             }
02719 
02720             <span class="comment">//</span>
02721             <span class="comment">// Remove pages.</span>
02722             <span class="comment">//</span>
02723 
02724             Entry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
02725 
02726             <span class="keywordflow">while</span> (WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt; WorkingSetMaximum) {
02727                 <span class="keywordflow">if</span> (Wsle[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid != 0) {
02728                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (
02729                                             Wsle[Entry].u1.VirtualAddress);
02730                     <a class="code" href="../../d2/d1/mm_8h.html#a53">PERFINFO_GET_PAGE_INFO</a>(PointerPte);
02731 
02732                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a>(Entry, WsInfo, PointerPte)) {
02733                         <a class="code" href="../../d2/d1/mm_8h.html#a74">PERFINFO_LOG_WS_REMOVAL</a>(PERFINFO_LOG_TYPE_OUTWS_ADJUSTWS,
02734                                               WsInfo);
02735                     }
02736                 }
02737                 Entry += 1;
02738                 <span class="keywordflow">if</span> (Entry &gt; LastFreed) {
02739                     FreeTryCount += 1;
02740                     <span class="keywordflow">if</span> (FreeTryCount &gt; <a class="code" href="../../d4/d0/wslist_8c.html#a1">MM_RETRY_COUNT</a>) {
02741 
02742                         <span class="comment">//</span>
02743                         <span class="comment">// Page table pages are not becoming free, give up</span>
02744                         <span class="comment">// and return an error.</span>
02745                         <span class="comment">//</span>
02746 
02747                         ReturnStatus = STATUS_BAD_WORKING_SET_LIMIT;
02748 
02749                         <span class="keywordflow">break</span>;
02750                     }
02751                     Entry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
02752                 }
02753             }
02754 
02755             <span class="keywordflow">if</span> (FreeTryCount &lt;= <a class="code" href="../../d4/d0/wslist_8c.html#a1">MM_RETRY_COUNT</a>) {
02756                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WorkingSetMaximum;
02757             }
02758         }
02759     }
02760 
02761     <span class="comment">//</span>
02762     <span class="comment">// Adjust the number of pages above the working set minimum.</span>
02763     <span class="comment">//</span>
02764 
02765     PagesAbove = (LONG)WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> -
02766                                (LONG)WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
02767     NewPagesAbove = (LONG)WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> -
02768                                (LONG)WorkingSetMinimum;
02769 
02770     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02771     <span class="keywordflow">if</span> (PagesAbove &gt; 0) {
02772         <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> -= (ULONG)PagesAbove;
02773     }
02774     <span class="keywordflow">if</span> (NewPagesAbove &gt; 0) {
02775         <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> += (ULONG)NewPagesAbove;
02776     }
02777     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02778 
02779     <span class="keywordflow">if</span> (FreeTryCount &lt;= <a class="code" href="../../d4/d0/wslist_8c.html#a1">MM_RETRY_COUNT</a>) {
02780         WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> = WorkingSetMaximum;
02781         WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a> = WorkingSetMinimum;
02782 
02783         <span class="keywordflow">if</span> (WorkingSetMinimum &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a>) {
02784             WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WorkingSetMinimum;
02785         }
02786     }
02787     <span class="keywordflow">else</span> {
02788         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02789 
02790         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += i;
02791         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(55, i);
02792 
02793         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02794     }
02795 
02796 
02797     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
02798             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == WSLE_NULL_INDEX));
02799 
02800     <span class="keywordflow">if</span> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02801         (WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> &gt; ((1536*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>))) {
02802 
02803         <span class="comment">//</span>
02804         <span class="comment">// The working set list consists of more than a single page.</span>
02805         <span class="comment">//</span>
02806 
02807         <a class="code" href="../../d4/d0/wslist_8c.html#a33">MiGrowWsleHash</a> (WsInfo);
02808     }
02809 
02810 Returns:
02811 
02812     <span class="keywordflow">if</span> (SystemCache) {
02813         <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql2);
02814     } <span class="keywordflow">else</span> {
02815         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
02816     }
02817 
02818     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
02819 
02820     <span class="keywordflow">return</span> ReturnStatus;
02821 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a293" doxytag="mm.h::MmAllocateContiguousMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI PVOID MmAllocateContiguousMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>HighestAcceptableAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l03881">3881</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d6/d5/iosup_8c-source.html#l04107">MiAllocateContiguousMemory()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, and <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>, and <a class="el" href="../../d3/d0/largepag_8c-source.html#l00227">Ki386AllocateContiguousMemory()</a>.
<p>
<pre class="fragment"><div>03888                    :
03889 
03890     This function allocates a range of physically contiguous non-paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
03891 
03892     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> designed to be used by a driver's initialization
03893     routine to allocate a contiguous block of physical memory <span class="keywordflow">for</span>
03894     issuing DMA requests from.
03895 
03896 Arguments:
03897 
03898     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to allocate.
03899 
03900     HighestAcceptableAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> highest physical address
03901                                which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation.  For
03902                                example, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> reference
03903                                physical memory in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lower 16MB <span class="keyword">this</span>
03904                                value would be set to 0xFFFFFF (16Mb - 1).
03905 
03906 Return Value:
03907 
03908     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - a contiguous range could not be found to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.
03909 
03910     NON-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - Returns a pointer (<span class="keyword">virtual</span> address in the nonpaged portion
03911                of the system) to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated physically contiguous
03912                memory.
03913 
03914 Environment:
03915 
03916     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below.
03917 
03918 --*/
03919 
03920 {
03921     PFN_NUMBER HighestPfn;
03922     PVOID CallingAddress;
03923 
03924 <span class="preprocessor">#if defined (_X86_)</span>
03925 <span class="preprocessor"></span>    PVOID CallersCaller;
03926 
03927     <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
03928 <span class="preprocessor">#else</span>
03929 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
03930 <span class="preprocessor">#endif</span>
03931 <span class="preprocessor"></span>
03932     HighestPfn = (PFN_NUMBER)(HighestAcceptableAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03933 
03934     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/iosup_8c.html#a28">MiAllocateContiguousMemory</a>(NumberOfBytes,
03935                                       0,
03936                                       HighestPfn,
03937                                       0,
03938                                       CallingAddress);
03939 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a294" doxytag="mm.h::MmAllocateContiguousMemorySpecifyCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI PVOID MmAllocateContiguousMemorySpecifyCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>LowestAcceptableAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>HighestAcceptableAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHYSICAL_ADDRESS BoundaryAddressMultiple&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CacheType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l03744">3744</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d4/d4/ppc_2flush_8c-source.html#l00220">KeSweepDcache()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04107">MiAllocateContiguousMemory()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05372">MmFreeContiguousMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05490">MmGetPhysicalAddress()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03415">MmMapIoSpace()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
<pre class="fragment"><div>03754                    :
03755 
03756     This function allocates a range of physically contiguous non-cached,
03757     non-paged memory.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> accomplished by <span class="keyword">using</span> <a class="code" href="../../d2/d1/mm_8h.html#a293">MmAllocateContiguousMemory</a>
03758     which uses nonpaged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <span class="keyword">virtual</span> addresses to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> found memory chunk.
03759 
03760     Then <span class="keyword">this</span> function establishes another map to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same physical addresses,
03761     but <span class="keyword">this</span> alternate map <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initialized as non-cached.  All references by
03762     our caller will be done through <span class="keyword">this</span> alternate map.
03763 
03764     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> designed to be used by a driver's initialization
03765     routine to allocate a contiguous block of noncached physical memory <span class="keywordflow">for</span>
03766     things like <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AGP GART.
03767 
03768 Arguments:
03769 
03770     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to allocate.
03771 
03772     LowestAcceptableAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest physical address
03773                               which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation.  For
03774                               example, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> reference
03775                               physical memory in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 8M to 16MB range, <span class="keyword">this</span>
03776                               value would be set to 0x800000 (8Mb).
03777 
03778     HighestAcceptableAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> highest physical address
03779                                which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation.  For
03780                                example, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> reference
03781                                physical memory below 16MB, <span class="keyword">this</span>
03782                                value would be set to 0xFFFFFF (16Mb - 1).
03783 
03784     BoundaryAddressMultiple - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical address multiple <span class="keyword">this</span>
03785                               allocation must not cross.
03786 
03787 Return Value:
03788 
03789     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - a contiguous range could not be found to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.
03790 
03791     NON-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - Returns a pointer (<span class="keyword">virtual</span> address in the nonpaged portion
03792                of the system) to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated physically contiguous
03793                memory.
03794 
03795 Environment:
03796 
03797     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below.
03798 
03799 --*/
03800 
03801 {
03802     PVOID BaseAddress;
03803     PVOID NewVa;
03804     PFN_NUMBER LowestPfn;
03805     PFN_NUMBER HighestPfn;
03806     PFN_NUMBER BoundaryPfn;
03807     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03808     PHYSICAL_ADDRESS PhysicalAddress;
03809     PVOID CallingAddress;
03810 
03811 <span class="preprocessor">#if defined (_X86_)</span>
03812 <span class="preprocessor"></span>    PVOID CallersCaller;
03813 
03814     <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
03815 <span class="preprocessor">#else</span>
03816 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
03817 <span class="preprocessor">#endif</span>
03818 <span class="preprocessor"></span>
03819     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes != 0);
03820 
03821     LowestPfn = (PFN_NUMBER)(LowestAcceptableAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03822     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(LowestAcceptableAddress.LowPart)) {
03823         LowestPfn += 1;
03824     }
03825 
03826     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(BoundaryAddressMultiple.LowPart)) {
03827         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03828     }
03829 
03830     BoundaryPfn = (PFN_NUMBER)(BoundaryAddressMultiple.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03831 
03832     HighestPfn = (PFN_NUMBER)(HighestAcceptableAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03833 
03834     BaseAddress = <a class="code" href="../../d5/d6/iosup_8c.html#a28">MiAllocateContiguousMemory</a>(NumberOfBytes,
03835                                              LowestPfn,
03836                                              HighestPfn,
03837                                              BoundaryPfn,
03838                                              CallingAddress);
03839 
03840     <span class="keywordflow">if</span> (BaseAddress) {
03841 
03842         <span class="keywordflow">if</span> (CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) {
03843 
03844             <span class="comment">//</span>
03845             <span class="comment">// We have an address range but it's cached.  Create an uncached</span>
03846             <span class="comment">// alternate mapping now.  Stash the original virtual address at the</span>
03847             <span class="comment">// end of the mapped range so we can unmap the nonpaged pool VAs and</span>
03848             <span class="comment">// the actual pages when the caller frees the memory.</span>
03849             <span class="comment">//</span>
03850 
03851             PhysicalAddress = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a> (BaseAddress);
03852 
03853             NewVa = <a class="code" href="../../d5/d6/iosup_8c.html#a57">MmMapIoSpace</a> (PhysicalAddress,
03854                                   NumberOfBytes + (2 * PAGE_SIZE),
03855                                   CacheType);
03856 
03857             <span class="keywordflow">if</span> (NewVa) {
03858 
03859                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(NewVa);
03860 
03861                 PointerPte += ((NumberOfBytes + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03862                 PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = (ULONG_PTR)BaseAddress;
03863 
03864                 PointerPte += 1;
03865                 PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = NumberOfBytes;
03866 
03867                 <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a6">KeSweepDcache</a> (TRUE);
03868                 BaseAddress = NewVa;
03869             }
03870             <span class="keywordflow">else</span> {
03871                 <a class="code" href="../../d5/d6/iosup_8c.html#a66">MmFreeContiguousMemory</a> (BaseAddress);
03872                 BaseAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03873             }
03874         }
03875     }
03876 
03877     <span class="keywordflow">return</span> BaseAddress;
03878 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a190" doxytag="mm.h::MmAllocateIndependentPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmAllocateIndependentPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NumberOfBytes</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l03942">3942</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04360">MI_NONPAGABLE_MEMORY_AVAILABLE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00329">MiChargeCommitmentCantExpand()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04254">MM_DBG_COMMIT_INDEPENDENT_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02460">KiI386PentiumLockErrataFixup()</a>.
<p>
<pre class="fragment"><div>03948                    :
03949 
03950     This function allocates a range of virtually contiguous nonpaged pages that
03951     can have independent page protections applied to each page.
03952 
03953 Arguments:
03954 
03955     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to allocate.
03956 
03957 Return Value:
03958 
03959     The <span class="keyword">virtual</span> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> none could be allocated.
03960 
03961 Environment:
03962 
03963     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
03964 
03965 --*/
03966 
03967 {
03968     PFN_NUMBER NumberOfPages;
03969     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03970     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03971     PFN_NUMBER PageFrameIndex;
03972     PVOID BaseAddress;
03973     KIRQL OldIrql;
03974 
03975     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (NumberOfBytes);
03976 
03977     PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> ((ULONG)NumberOfPages,
03978                                       SystemPteSpace,
03979                                       0,
03980                                       0,
03981                                       FALSE);
03982     <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03983         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03984     }
03985 
03986     BaseAddress = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
03987 
03988     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03989 
03990     <span class="keywordflow">if</span> ((SPFN_NUMBER)NumberOfPages &gt; <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>()) {
03991         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03992         <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte, (ULONG)NumberOfPages, SystemPteSpace);
03993         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03994     }
03995 
03996     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= NumberOfPages;
03997     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(28, NumberOfPages);
03998 
03999     <span class="keywordflow">do</span> {
04000         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
04001         <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
04002         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (MI_GET_PAGE_COLOR_FROM_PTE (PointerPte));
04003 
04004         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
04005                            PageFrameIndex,
04006                            MM_READWRITE,
04007                            PointerPte);
04008 
04009         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
04010         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
04011         <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 1);
04012 
04013         PointerPte += 1;
04014         NumberOfPages -= 1;
04015     } <span class="keywordflow">while</span> (NumberOfPages != 0);
04016 
04017     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04018 
04019     <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (NumberOfPages, TRUE);
04020 
04021     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_INDEPENDENT_PAGES, NumberOfPages);
04022 
04023     <span class="keywordflow">return</span> BaseAddress;
04024 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a300" doxytag="mm.h::MmAllocateNonCachedMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI PVOID MmAllocateNonCachedMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NumberOfBytes</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05581">5581</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d4/d4/ppc_2flush_8c-source.html#l00220">KeSweepDcache()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00861">MI_DISABLE_CACHING</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04360">MI_NONPAGABLE_MEMORY_AVAILABLE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00329">MiChargeCommitmentCantExpand()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d7/d1/mm_2ia64_2initia64_8c-source.html#l02042">MiSweepCacheMachineDependent()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04257">MM_DBG_COMMIT_NONCACHED_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>.
<p>
<pre class="fragment"><div>05587                    :
05588 
05589     This function allocates a range of noncached memory in
05590     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-paged portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system address space.
05591 
05592     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> designed to be used by a driver's initialization
05593     routine to allocate a noncached block of <span class="keyword">virtual</span> memory <span class="keywordflow">for</span>
05594     various device specific buffers.
05595 
05596 Arguments:
05597 
05598     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to allocate.
05599 
05600 Return Value:
05601 
05602     NON-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - Returns a pointer (<span class="keyword">virtual</span> address in the nonpaged portion
05603                of the system) to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated physically contiguous
05604                memory.
05605 
05606     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - The specified request could not be satisfied.
05607 
05608 Environment:
05609 
05610     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
05611 
05612 --*/
05613 
05614 {
05615     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05616     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
05617     PFN_NUMBER NumberOfPages;
05618     PFN_NUMBER PageFrameIndex;
05619     PVOID BaseAddress;
05620     KIRQL OldIrql;
05621 
05622     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes != 0);
05623 
05624     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(NumberOfBytes);
05625 
05626     <span class="comment">//</span>
05627     <span class="comment">// Obtain enough virtual space to map the pages.</span>
05628     <span class="comment">//</span>
05629 
05630     PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> ((ULONG)NumberOfPages,
05631                                       SystemPteSpace,
05632                                       0,
05633                                       0,
05634                                       FALSE);
05635 
05636     <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05637         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05638     }
05639 
05640     <span class="comment">//</span>
05641     <span class="comment">// Obtain backing commitment for the pages.</span>
05642     <span class="comment">//</span>
05643 
05644     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (NumberOfPages, FALSE) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
05645         <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte, (ULONG)NumberOfPages, SystemPteSpace);
05646         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05647     }
05648 
05649     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_NONCACHED_PAGES, NumberOfPages);
05650 
05651     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (ExPageLockHandle);
05652 
05653     <span class="comment">//</span>
05654     <span class="comment">// Acquire the PFN mutex to synchronize access to the PFN database.</span>
05655     <span class="comment">//</span>
05656 
05657     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05658 
05659     <span class="comment">//</span>
05660     <span class="comment">// Obtain enough pages to contain the allocation.</span>
05661     <span class="comment">// Check to make sure the physical pages are available.</span>
05662     <span class="comment">//</span>
05663 
05664     <span class="keywordflow">if</span> ((SPFN_NUMBER)NumberOfPages &gt; <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>()) {
05665         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05666         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
05667         <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte, (ULONG)NumberOfPages, SystemPteSpace);
05668         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (NumberOfPages);
05669         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05670     }
05671 
05672 <span class="preprocessor">#if defined(_IA64_)</span>
05673 <span class="preprocessor"></span>    <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a>(FALSE, TRUE);
05674 <span class="preprocessor">#endif</span>
05675 <span class="preprocessor"></span>
05676     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= NumberOfPages;
05677     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(4, NumberOfPages);
05678 
05679     BaseAddress = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
05680 
05681     <span class="keywordflow">do</span> {
05682         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
05683         <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
05684         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (MI_GET_PAGE_COLOR_FROM_PTE (PointerPte));
05685 
05686         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
05687                            PageFrameIndex,
05688                            MM_READWRITE,
05689                            PointerPte);
05690 
05691         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
05692         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a118">MI_DISABLE_CACHING</a> (TempPte);
05693         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
05694         <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 1);
05695 
05696         PointerPte += 1;
05697         NumberOfPages -= 1;
05698     } <span class="keywordflow">while</span> (NumberOfPages != 0);
05699 
05700     <span class="comment">//</span>
05701     <span class="comment">// Flush any data for this page out of the dcaches.</span>
05702     <span class="comment">//</span>
05703 
05704 <span class="preprocessor">#if !defined(_IA64_)</span>
05705 <span class="preprocessor"></span>    <span class="comment">//</span>
05706     <span class="comment">// Flush any data for this page out of the dcaches.</span>
05707     <span class="comment">//</span>
05708 
05709     <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a6">KeSweepDcache</a> (TRUE);
05710 <span class="preprocessor">#else</span>
05711 <span class="preprocessor"></span>    <a class="code" href="../../d2/d9/miia64_8h.html#a318">MiSweepCacheMachineDependent</a>(BaseAddress, NumberOfBytes, MmNonCached);
05712 <span class="preprocessor">#endif</span>
05713 <span class="preprocessor"></span>
05714     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05715     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
05716 
05717     <span class="keywordflow">return</span> BaseAddress;
05718 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a284" doxytag="mm.h::MmAllocatePagesForMdl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MmAllocatePagesForMdl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>LowAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>HighAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>SkipBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>TotalBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">4270</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00217">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00034">_PHYSICAL_MEMORY_RUN::BasePage</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l01893">_MMCOLOR_TABLES::Blink</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01082">_MMPFNLIST::Blink</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00420">_MDL::ByteCount</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l01892">_MMCOLOR_TABLES::Flink</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01081">_MMPFNLIST::Flink</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01219">MI_MAGIC_AWE_PTEFRAME</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04360">MI_NONPAGABLE_MEMORY_AVAILABLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00329">MiChargeCommitmentCantExpand()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04266">MiLastCallColor</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04265">MiLastCallHighPage</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04264">MiLastCallLowPage</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01245">MiRestoreTransitionPte()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00821">MiUnlinkFreeOrZeroedPage()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01184">MiZeroPhysicalPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04256">MM_DBG_COMMIT_MDL_PAGES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00418">MM_DEMAND_ZERO_WRITE_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05852">MmCreateMdl()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00024">MmDynamicMemoryMutex</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00112">MmFreePagesByColor</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d2/d1/mm_8h.html#a147">MMLISTS</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00204">MmMdlPagesAllocated</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00075">MmPfnDatabase</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">MmPhysicalMemoryBlock</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00081">MmSecondaryColors</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00039">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfRuns</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00035">_PHYSICAL_MEMORY_RUN::PageCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00041">_PHYSICAL_MEMORY_DESCRIPTOR::Run</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/physical_8c-source.html#l00970">NtAllocateUserPhysicalPages()</a>.
<p>
<pre class="fragment"><div>04279                    :
04280 
04281     This routine searches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database <span class="keywordflow">for</span> free, zeroed or standby pages
04282     to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.  This does not map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> just allocates
04283     them and puts them into an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected that our caller will
04284     map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> as needed.
04285 
04286     NOTE: <span class="keyword">this</span> routine may <span class="keywordflow">return</span> an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> mapping a smaller number of bytes
04287     than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> amount requested.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's responsibility to check <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04288     <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> upon <span class="keywordflow">return</span> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size actually allocated.
04289 
04290     These pages comprise physical non-paged memory and are zero-filled.
04291 
04292     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> designed to be used by an AGP driver to obtain physical
04293     memory in a specified range since hardware may provide substantial
04294     performance wins depending on where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> backing memory <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated.
04295 
04296 Arguments:
04297 
04298     LowAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> physical address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first range that
04299                  <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated pages can come from.
04300 
04301     HighAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d3/fetypes_8h.html#a457a417">high</a> physical address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first range that
04302                   <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated pages can come from.
04303 
04304     SkipBytes - Number of bytes to skip (from the Low Address) to get to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04305                 next physical address range that allocated pages can come from.
04306 
04307     TotalBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to allocate.
04308 
04309 Return Value:
04310 
04311     <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> - An <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> mapping a range of pages in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified range.
04312           This may map less memory than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller requested <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full amount
04313           <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not currently available.
04314 
04315     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - No pages in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified range OR not enough virtually contiguous
04316            nonpaged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available at <span class="keyword">this</span> time.
04317 
04318 Environment:
04319 
04320     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
04321 
04322 --*/
04323 
04324 {
04325     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList;
04326     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList2;
04327     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
04328     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnNextColored;
04329     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnNextFlink;
04330     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnLastColored;
04331     KIRQL OldIrql;
04332     PFN_NUMBER start;
04333     PFN_NUMBER count;
04334     PFN_NUMBER Page;
04335     PFN_NUMBER LastPage;
04336     PFN_NUMBER found;
04337     PFN_NUMBER BasePage;
04338     PFN_NUMBER LowPage;
04339     PFN_NUMBER HighPage;
04340     PFN_NUMBER SizeInPages;
04341     PFN_NUMBER MdlPageSpan;
04342     PFN_NUMBER SkipPages;
04343     PFN_NUMBER MaxPages;
04344     PPFN_NUMBER MdlPage;
04345     PPFN_NUMBER LastMdlPage;
04346     ULONG Color;
04347     <a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">PMMCOLOR_TABLES</a> ColorHead;
04348     <a class="code" href="../../d2/d1/mm_8h.html#a147">MMLISTS</a> MemoryList;
04349     PPFN_NUMBER FirstMdlPageToZero;
04350     PFN_NUMBER LowPage1;
04351     PFN_NUMBER HighPage1;
04352     LOGICAL PagePlacementOk;
04353     PFN_NUMBER PageNextColored;
04354     PFN_NUMBER PageNextFlink;
04355     PFN_NUMBER PageLastColored;
04356     <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead;
04357     PPFN_NUMBER ColorAnchorsHead;
04358     PPFN_NUMBER ColorAnchor;
04359     ULONG FullAnchorCount;
04360 <span class="preprocessor">#if DBG</span>
04361 <span class="preprocessor"></span>    ULONG FinishedCount;
04362 <span class="preprocessor">#endif</span>
04363 <span class="preprocessor"></span>
04364     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt;= APC_LEVEL);
04365 
04366     <span class="comment">//</span>
04367     <span class="comment">// The skip increment must be a page-size multiple.</span>
04368     <span class="comment">//</span>
04369 
04370     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(SkipBytes.LowPart)) {
04371         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0;
04372     }
04373 
04374     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (ExPageLockHandle);
04375 
04376     LowPage = (PFN_NUMBER)(LowAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
04377     HighPage = (PFN_NUMBER)(HighAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
04378 
04379     <span class="comment">//</span>
04380     <span class="comment">// Maximum allocation size is constrained by the MDL ByteCount field.</span>
04381     <span class="comment">//</span>
04382 
04383     <span class="keywordflow">if</span> (TotalBytes &gt; (SIZE_T)((ULONG)(MAXULONG - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>))) {
04384         TotalBytes = (SIZE_T)((ULONG)(MAXULONG - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>));
04385     }
04386 
04387     SizeInPages = (PFN_NUMBER)<a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>(0, TotalBytes);
04388 
04389     SkipPages = (PFN_NUMBER)(SkipBytes.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
04390 
04391     BasePage = LowPage;
04392 
04393     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04394 
04395     MaxPages = <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() - 1024;
04396 
04397     <span class="keywordflow">if</span> ((SPFN_NUMBER)MaxPages &lt;= 0) {
04398         SizeInPages = 0;
04399     }
04400     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SizeInPages &gt; MaxPages) {
04401         SizeInPages = MaxPages;
04402     }
04403 
04404     <span class="keywordflow">if</span> (SizeInPages == 0) {
04405         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04406         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
04407         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0;
04408     }
04409 
04410     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04411 
04412 <span class="preprocessor">#if DBG</span>
04413 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (SizeInPages &lt; (PFN_NUMBER)<a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>(0, TotalBytes)) {
04414         <span class="keywordflow">if</span> (MiPrintAwe != 0) {
04415             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MmAllocatePagesForMdl1: unable to get %p pages, trying for %p instead\n"</span>,
04416                 <a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>(0, TotalBytes),
04417                 SizeInPages);
04418         }
04419     }
04420 <span class="preprocessor">#endif</span>
04421 <span class="preprocessor"></span>
04422     <span class="comment">//</span>
04423     <span class="comment">// Allocate an MDL to return the pages in.</span>
04424     <span class="comment">//</span>
04425 
04426     <span class="keywordflow">do</span> {
04427         MemoryDescriptorList = <a class="code" href="../../d5/d6/iosup_8c.html#a73">MmCreateMdl</a> ((<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0,
04428                                             (PVOID)0,
04429                                             SizeInPages &lt;&lt; PAGE_SHIFT);
04430     
04431         <span class="keywordflow">if</span> (MemoryDescriptorList != (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0) {
04432             <span class="keywordflow">break</span>;
04433         }
04434         SizeInPages -= (SizeInPages &gt;&gt; 4);
04435     } <span class="keywordflow">while</span> (SizeInPages != 0);
04436 
04437     <span class="keywordflow">if</span> (MemoryDescriptorList == (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0) {
04438         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
04439         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0;
04440     }
04441 
04442     <span class="comment">//</span>
04443     <span class="comment">// Allocate a list of colored anchors.</span>
04444     <span class="comment">//</span>
04445 
04446     ColorAnchorsHead = (PPFN_NUMBER) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
04447                                                             MmSecondaryColors * <span class="keyword">sizeof</span> (PFN_NUMBER),
04448                                                             'ldmM');
04449 
04450     <span class="keywordflow">if</span> (ColorAnchorsHead == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04451         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
04452         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (MemoryDescriptorList);
04453         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0;
04454     }
04455 
04456     MdlPageSpan = SizeInPages;
04457 
04458     <span class="comment">//</span>
04459     <span class="comment">// Recalculate as the PFN lock was dropped.</span>
04460     <span class="comment">//</span>
04461 
04462     start = 0;
04463     found = 0;
04464 
04465     MdlPage = (PPFN_NUMBER)(MemoryDescriptorList + 1);
04466 
04467     ExAcquireFastMutex (&amp;MmDynamicMemoryMutex);
04468 
04469     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04470 
04471     MaxPages = <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() - 1024;
04472 
04473     <span class="keywordflow">if</span> ((SPFN_NUMBER)MaxPages &lt;= 0) {
04474         SizeInPages = 0;
04475     }
04476     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SizeInPages &gt; MaxPages) {
04477         SizeInPages = MaxPages;
04478     }
04479 
04480     <span class="keywordflow">if</span> (SizeInPages == 0) {
04481         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04482         ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
04483         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
04484         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (MemoryDescriptorList);
04485         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ColorAnchorsHead);
04486         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0;
04487     }
04488 
04489     <span class="comment">//</span>
04490     <span class="comment">// Ensure there is enough commit prior to allocating the pages as this</span>
04491     <span class="comment">// is not a nonpaged pool allocation but rather a dynamic MDL allocation.</span>
04492     <span class="comment">//</span>
04493 
04494     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (SizeInPages, FALSE) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04495         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04496         ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
04497         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
04498         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (MemoryDescriptorList);
04499         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ColorAnchorsHead);
04500         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0;
04501     }
04502 
04503     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_MDL_PAGES, SizeInPages);
04504 
04505     <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/iosup_8c.html#a24">MiLastCallLowPage</a> != LowPage) || (<a class="code" href="../../d5/d6/iosup_8c.html#a25">MiLastCallHighPage</a> != HighPage)) {
04506         <a class="code" href="../../d5/d6/iosup_8c.html#a26">MiLastCallColor</a> = 0;
04507     }
04508 
04509     <a class="code" href="../../d5/d6/iosup_8c.html#a24">MiLastCallLowPage</a> = LowPage;
04510     <a class="code" href="../../d5/d6/iosup_8c.html#a25">MiLastCallHighPage</a> = HighPage;
04511 
04512     FirstMdlPageToZero = MdlPage;
04513 
04514     <span class="keywordflow">do</span> {
04515         <span class="comment">//</span>
04516         <span class="comment">// Grab all zeroed (and then free) pages first directly from the</span>
04517         <span class="comment">// colored lists to avoid multiple walks down these singly linked lists.</span>
04518         <span class="comment">// Then snatch transition pages as needed.  In addition to optimizing</span>
04519         <span class="comment">// the speed of the removals this also avoids cannibalizing the page</span>
04520         <span class="comment">// cache unless it's absolutely needed.</span>
04521         <span class="comment">//</span>
04522 
04523         <span class="keywordflow">for</span> (MemoryList = <a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>; MemoryList &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>; MemoryList += 1) {
04524 
04525             ListHead = <a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[MemoryList];
04526 
04527             FullAnchorCount = 0;
04528 
04529             <span class="keywordflow">for</span> (Color = 0; Color &lt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>; Color += 1) {
04530                 ColorAnchorsHead[Color] = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
04531             }
04532 
04533             Color = <a class="code" href="../../d5/d6/iosup_8c.html#a26">MiLastCallColor</a>;
04534             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Color &lt; MmSecondaryColors);
04535 
04536             <span class="keywordflow">do</span> {
04537 
04538                 ColorHead = &amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[MemoryList][Color];
04539                 ColorAnchor = &amp;ColorAnchorsHead[Color];
04540     
04541                 Color += 1;
04542                 <span class="keywordflow">if</span> (Color &gt;= <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>) {
04543                     Color = 0;
04544                 }
04545 
04546                 <span class="keywordflow">if</span> (*ColorAnchor == (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a> - 1)) {
04547 
04548                     <span class="comment">//</span>
04549                     <span class="comment">// This colored list has already been completely searched.</span>
04550                     <span class="comment">//</span>
04551 
04552                     <span class="keywordflow">continue</span>;
04553                 }
04554 
04555                 <span class="keywordflow">if</span> (ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
04556 
04557                     <span class="comment">//</span>
04558                     <span class="comment">// This colored list is empty.</span>
04559                     <span class="comment">//</span>
04560 
04561                     FullAnchorCount += 1;
04562                     *ColorAnchor = (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a> - 1);
04563                     <span class="keywordflow">continue</span>;
04564                 }
04565 
04566                 <span class="keywordflow">while</span> (ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
04567     
04568                     Page = ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a>;
04569         
04570                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
04571 
04572                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == MemoryList);
04573     
04574                     <span class="comment">//</span>
04575                     <span class="comment">// See if the page is within the caller's page constraints.</span>
04576                     <span class="comment">//</span>
04577 
04578                     PagePlacementOk = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04579 
04580                     LowPage1 = LowPage;
04581                     HighPage1 = HighPage;
04582 
04583                     <span class="keywordflow">do</span> {
04584                         <span class="keywordflow">if</span> ((Page &gt;= LowPage1) &amp;&amp; (Page &lt;= HighPage1)) {
04585                             PagePlacementOk = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04586                             <span class="keywordflow">break</span>;
04587                         }
04588 
04589                         <span class="keywordflow">if</span> (SkipPages == 0) {
04590                             <span class="keywordflow">break</span>;
04591                         }
04592 
04593                         LowPage1 += SkipPages;
04594                         HighPage1 += SkipPages;
04595 
04596                         <span class="keywordflow">if</span> (LowPage1 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
04597                             <span class="keywordflow">break</span>;
04598                         }
04599                         <span class="keywordflow">if</span> (HighPage1 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
04600                             HighPage1 = <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>;
04601                         }
04602                     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04603                 
04604                     <span class="comment">// </span>
04605                     <span class="comment">// The Flink and Blink must be nonzero here for the page</span>
04606                     <span class="comment">// to be on the listhead.  Only code that scans the</span>
04607                     <span class="comment">// MmPhysicalMemoryBlock has to check for the zero case.</span>
04608                     <span class="comment">//</span>
04609 
04610                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != 0);
04611                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink != 0);
04612 
04613                     <span class="keywordflow">if</span> (PagePlacementOk == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04614 
04615                         <span class="comment">//</span>
04616                         <span class="comment">// Put page on end of list and if first time, save pfn.</span>
04617                         <span class="comment">//</span>
04618     
04619                         <span class="keywordflow">if</span> (*ColorAnchor == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
04620                             *ColorAnchor = Page;
04621                         }
04622                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Page == *ColorAnchor) {
04623 
04624                             <span class="comment">//</span>
04625                             <span class="comment">// No more pages available in this colored chain.</span>
04626                             <span class="comment">//</span>
04627 
04628                             FullAnchorCount += 1;
04629                             *ColorAnchor = (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a> - 1);
04630                             <span class="keywordflow">break</span>;
04631                         }
04632 
04633                         <span class="comment">//</span>
04634                         <span class="comment">// If the colored chain has more than one entry then</span>
04635                         <span class="comment">// put this page on the end.</span>
04636                         <span class="comment">//</span>
04637 
04638                         PageNextColored = (PFN_NUMBER)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
04639 
04640                         <span class="keywordflow">if</span> (PageNextColored == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
04641 
04642                             <span class="comment">//</span>
04643                             <span class="comment">// No more pages available in this colored chain.</span>
04644                             <span class="comment">//</span>
04645 
04646                             FullAnchorCount += 1;
04647                             *ColorAnchor = (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a> - 1);
04648                             <span class="keywordflow">break</span>;
04649                         }
04650 
04651                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != 0);
04652                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != MM_EMPTY_LIST);
04653                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
04654 
04655                         PfnNextColored = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageNextColored);
04656                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)PfnNextColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == MemoryList);
04657                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnNextColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
04658 
04659                         <span class="comment">//</span>
04660                         <span class="comment">// Adjust the free page list so Page</span>
04661                         <span class="comment">// follows PageNextFlink.</span>
04662                         <span class="comment">//</span>
04663 
04664                         PageNextFlink = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink;
04665                         PfnNextFlink = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageNextFlink);
04666 
04667                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)PfnNextFlink-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == MemoryList);
04668                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnNextFlink-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
04669 
04670                         PfnLastColored = ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o1">Blink</a>;
04671                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored != (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)MM_EMPTY_LIST);
04672                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == MM_EMPTY_LIST);
04673                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
04674                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink != MM_EMPTY_LIST);
04675 
04676                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == MemoryList);
04677                         PageLastColored = PfnLastColored - <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>;
04678 
04679                         <span class="keywordflow">if</span> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> == Page) {
04680 
04681                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink == MM_EMPTY_LIST);
04682                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> != Page);
04683 
04684                             ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = PageNextFlink;
04685 
04686                             PfnNextFlink-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
04687                         }
04688                         <span class="keywordflow">else</span> {
04689 
04690                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink != MM_EMPTY_LIST);
04691                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink)-&gt;u1.Flink)))-&gt;PteFrame != MI_MAGIC_AWE_PTEFRAME);
04692                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink)-&gt;u1.Flink)))-&gt;u3.e1.PageLocation == MemoryList);
04693 
04694                             <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink)-&gt;u1.Flink = PageNextFlink;
04695                             PfnNextFlink-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink;
04696                         }
04697 
04698 <span class="preprocessor">#if DBG</span>
04699 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
04700                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> == PageLastColored);
04701                         }
04702 <span class="preprocessor">#endif</span>
04703 <span class="preprocessor"></span>
04704                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink;
04705                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = PageLastColored;
04706 
04707                         <span class="keywordflow">if</span> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> == PageLastColored) {
04708                             ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = Page;
04709                         }
04710 
04711                         <span class="comment">//</span>
04712                         <span class="comment">// Adjust the colored chains.</span>
04713                         <span class="comment">//</span>
04714 
04715                         <span class="keywordflow">if</span> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
04716                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink)-&gt;PteFrame != MI_MAGIC_AWE_PTEFRAME);
04717                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink)-&gt;u3.e1.PageLocation) == MemoryList);
04718                             <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink)-&gt;u2.Blink = Page;
04719                         }
04720 
04721                         PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = Page;
04722 
04723                         ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> = PageNextColored;
04724                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
04725 
04726                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == MM_EMPTY_LIST);
04727                         PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = Page;
04728                         ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o1">Blink</a> = Pfn1;
04729 
04730                         <span class="keywordflow">continue</span>;
04731                     }
04732     
04733                     found += 1;
04734                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress == 0);
04735                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a12">MiUnlinkFreeOrZeroedPage</a> (Page);
04736                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
04737     
04738                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
04739                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 1;
04740                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a>(Pfn1);
04741                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
04742 <span class="preprocessor">#if DBG</span>
04743 <span class="preprocessor"></span>                    Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>;
04744 <span class="preprocessor">#endif</span>
04745 <span class="preprocessor"></span>                    Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
04746     
04747                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
04748                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
04749                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation = 0;
04750                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation = 0;
04751     
04752                     *MdlPage = Page;
04753                     MdlPage += 1;
04754     
04755                     <span class="keywordflow">if</span> (found == SizeInPages) {
04756     
04757                         <span class="comment">//</span>
04758                         <span class="comment">// All the pages requested are available.</span>
04759                         <span class="comment">//</span>
04760 
04761                         <span class="keywordflow">if</span> (MemoryList == <a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>) {
04762                             FirstMdlPageToZero = MdlPage;
04763                             <a class="code" href="../../d5/d6/iosup_8c.html#a26">MiLastCallColor</a> = Color;
04764                         }
04765     
04766 <span class="preprocessor">#if DBG</span>
04767 <span class="preprocessor"></span>                        FinishedCount = 0;
04768                         <span class="keywordflow">for</span> (Color = 0; Color &lt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>; Color += 1) {
04769                             <span class="keywordflow">if</span> (ColorAnchorsHead[Color] == (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a> - 1)) {
04770                                 FinishedCount += 1;
04771                             }
04772                         }
04773                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FinishedCount == FullAnchorCount);
04774 <span class="preprocessor">#endif</span>
04775 <span class="preprocessor"></span>
04776                         <span class="keywordflow">goto</span> pass2_done;
04777                     }
04778     
04779                     <span class="comment">//</span>
04780                     <span class="comment">// March on to the next colored chain so the overall</span>
04781                     <span class="comment">// allocation round-robins the page colors.</span>
04782                     <span class="comment">//</span>
04783 
04784                     <span class="keywordflow">break</span>;
04785                 }
04786 
04787             } <span class="keywordflow">while</span> (FullAnchorCount != <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>);
04788 
04789 <span class="preprocessor">#if DBG</span>
04790 <span class="preprocessor"></span>            FinishedCount = 0;
04791             <span class="keywordflow">for</span> (Color = 0; Color &lt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>; Color += 1) {
04792                 <span class="keywordflow">if</span> (ColorAnchorsHead[Color] == (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a> - 1)) {
04793                     FinishedCount += 1;
04794                 }
04795             }
04796             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FinishedCount == FullAnchorCount);
04797 <span class="preprocessor">#endif</span>
04798 <span class="preprocessor"></span>
04799             <span class="keywordflow">if</span> (MemoryList == <a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>) {
04800                 FirstMdlPageToZero = MdlPage;
04801             }
04802 
04803             <a class="code" href="../../d5/d6/iosup_8c.html#a26">MiLastCallColor</a> = 0;
04804         }
04805 
04806         start = 0;
04807 
04808         <span class="keywordflow">do</span> {
04809 
04810             count = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
04811             Page = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
04812 
04813             <span class="keywordflow">if</span> (count != 0) {
04814 
04815                 <span class="comment">//</span>
04816                 <span class="comment">// Close the gaps, then examine the range for a fit.</span>
04817                 <span class="comment">//</span>
04818 
04819                 LastPage = Page + count;
04820 
04821                 <span class="keywordflow">if</span> (LastPage - 1 &gt; HighPage) {
04822                     LastPage = HighPage + 1;
04823                 }
04824             
04825                 <span class="keywordflow">if</span> (Page &lt; LowPage) {
04826                     Page = LowPage;
04827                 }
04828 
04829                 <span class="keywordflow">if</span> ((Page &lt; LastPage) &amp;&amp;
04830                     (Page &gt;= <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>) &amp;&amp;
04831                     (LastPage &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> +
04832                         <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>)) {
04833 
04834                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Page);
04835                     <span class="keywordflow">do</span> {
04836     
04837                         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) {
04838     
04839                             <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != 0) &amp;&amp;
04840                                 (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink != 0) &amp;&amp;
04841                                 (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0)) {
04842     
04843                                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress == 0);
04844 
04845                                 found += 1;
04846     
04847                                 <span class="comment">//</span>
04848                                 <span class="comment">// This page is in the desired range - grab it.</span>
04849                                 <span class="comment">//</span>
04850     
04851                                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
04852                                 <a class="code" href="../../d0/d2/mmsup_8c.html#a15">MiRestoreTransitionPte</a> (Page);
04853     
04854                                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
04855     
04856                                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
04857                                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 1;
04858                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a>(Pfn1);
04859                                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
04860 <span class="preprocessor">#if DBG</span>
04861 <span class="preprocessor"></span>                                Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>;
04862 <span class="preprocessor">#endif</span>
04863 <span class="preprocessor"></span>                                Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
04864     
04865                                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
04866                                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
04867                                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation = 0;
04868                                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation = 0;
04869     
04870                                 *MdlPage = Page;
04871                                 MdlPage += 1;
04872     
04873                                 <span class="keywordflow">if</span> (found == SizeInPages) {
04874 
04875                                     <span class="comment">//</span>
04876                                     <span class="comment">// All the pages requested are available.</span>
04877                                     <span class="comment">//</span>
04878     
04879                                     <span class="keywordflow">goto</span> pass2_done;
04880                                 }
04881                             }
04882                         }
04883                         Page += 1;
04884                         Pfn1 += 1;
04885     
04886                     } <span class="keywordflow">while</span> (Page &lt; LastPage);
04887                 }
04888             }
04889             start += 1;
04890         } <span class="keywordflow">while</span> (start != <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>);
04891 
04892         <span class="keywordflow">if</span> (SkipPages == 0) {
04893             <span class="keywordflow">break</span>;
04894         }
04895         LowPage += SkipPages;
04896         HighPage += SkipPages;
04897         <span class="keywordflow">if</span> (LowPage &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
04898             <span class="keywordflow">break</span>;
04899         }
04900         <span class="keywordflow">if</span> (HighPage &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
04901             HighPage = <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>;
04902         }
04903     } <span class="keywordflow">while</span> (1);
04904 
04905 pass2_done:
04906 
04907     <a class="code" href="../../d5/d6/iosup_8c.html#a17">MmMdlPagesAllocated</a> += found;
04908 
04909     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= found;
04910     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(34, found);
04911 
04912     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04913 
04914     ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
04915     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
04916 
04917     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ColorAnchorsHead);
04918 
04919     <span class="keywordflow">if</span> (found != SizeInPages) {
04920         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (found &lt; SizeInPages);
04921         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (SizeInPages - found);
04922         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_MDL_PAGES, 0 - (SizeInPages - found));
04923     }
04924 
04925     <span class="keywordflow">if</span> (found == 0) {
04926         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (MemoryDescriptorList);
04927         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0;
04928     }
04929 
04930     MemoryDescriptorList-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> = (ULONG)(found &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
04931 
04932     <span class="keywordflow">if</span> (found != SizeInPages) {
04933         *MdlPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
04934     }
04935 
04936     <span class="comment">//</span>
04937     <span class="comment">// If the number of pages allocated was substantially less than the</span>
04938     <span class="comment">// initial request amount, attempt to allocate a smaller MDL to save</span>
04939     <span class="comment">// pool.</span>
04940     <span class="comment">//</span>
04941 
04942     <span class="keywordflow">if</span> ((MdlPageSpan - found) &gt; ((4 * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) / <span class="keyword">sizeof</span> (PFN_NUMBER))) {
04943         MemoryDescriptorList2 = <a class="code" href="../../d5/d6/iosup_8c.html#a73">MmCreateMdl</a> ((<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0,
04944                                              (PVOID)0,
04945                                              found &lt;&lt; PAGE_SHIFT);
04946     
04947         <span class="keywordflow">if</span> (MemoryDescriptorList2 != (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0) {
04948             RtlMoveMemory ((PVOID)(MemoryDescriptorList2 + 1),
04949                            (PVOID)(MemoryDescriptorList + 1),
04950                            found * <span class="keyword">sizeof</span> (PFN_NUMBER));
04951             FirstMdlPageToZero = (PPFN_NUMBER)(MemoryDescriptorList2 + 1) +
04952                                  (FirstMdlPageToZero -
04953                                     (PPFN_NUMBER)(MemoryDescriptorList + 1));
04954             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (MemoryDescriptorList);
04955             MemoryDescriptorList = MemoryDescriptorList2;
04956         }
04957     }
04958 
04959     MdlPage = (PPFN_NUMBER)(MemoryDescriptorList + 1);
04960     LastMdlPage = MdlPage + found;
04961 
04962 <span class="preprocessor">#if DBG</span>
04963 <span class="preprocessor"></span>    <span class="comment">//</span>
04964     <span class="comment">// Ensure all pages are within the caller's page constraints.</span>
04965     <span class="comment">//</span>
04966 
04967     LowPage = (PFN_NUMBER)(LowAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
04968     HighPage = (PFN_NUMBER)(HighAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
04969 
04970     <span class="keywordflow">while</span> (MdlPage &lt; FirstMdlPageToZero) {
04971         Page = *MdlPage;
04972         PagePlacementOk = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04973         LowPage1 = LowPage;
04974         HighPage1 = HighPage;
04975 
04976         <span class="keywordflow">do</span> {
04977             <span class="keywordflow">if</span> ((Page &gt;= LowPage1) &amp;&amp; (Page &lt;= HighPage1)) {
04978                 PagePlacementOk = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04979                 <span class="keywordflow">break</span>;
04980             }
04981 
04982             <span class="keywordflow">if</span> (SkipPages == 0) {
04983                 <span class="keywordflow">break</span>;
04984             }
04985 
04986             LowPage1 += SkipPages;
04987             HighPage1 += SkipPages;
04988 
04989             <span class="keywordflow">if</span> (LowPage1 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
04990                 <span class="keywordflow">break</span>;
04991             }
04992             <span class="keywordflow">if</span> (HighPage1 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
04993                 HighPage1 = <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>;
04994             }
04995         } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04996 
04997         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PagePlacementOk == TRUE);
04998         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(*MdlPage);
04999         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> == MI_MAGIC_AWE_PTEFRAME);
05000         MdlPage += 1;
05001     }
05002 <span class="preprocessor">#endif</span>
05003 <span class="preprocessor"></span>
05004     <span class="keywordflow">while</span> (FirstMdlPageToZero &lt; LastMdlPage) {
05005 
05006 <span class="preprocessor">#if DBG</span>
05007 <span class="preprocessor"></span>        <span class="comment">//</span>
05008         <span class="comment">// Ensure all pages are within the caller's page constraints.</span>
05009         <span class="comment">//</span>
05010 
05011         Page = *FirstMdlPageToZero;
05012 
05013         PagePlacementOk = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05014         LowPage1 = LowPage;
05015         HighPage1 = HighPage;
05016 
05017         <span class="keywordflow">do</span> {
05018             <span class="keywordflow">if</span> ((Page &gt;= LowPage1) &amp;&amp; (Page &lt;= HighPage1)) {
05019                 PagePlacementOk = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05020                 <span class="keywordflow">break</span>;
05021             }
05022 
05023             <span class="keywordflow">if</span> (SkipPages == 0) {
05024                 <span class="keywordflow">break</span>;
05025             }
05026 
05027             LowPage1 += SkipPages;
05028             HighPage1 += SkipPages;
05029 
05030             <span class="keywordflow">if</span> (LowPage1 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
05031                 <span class="keywordflow">break</span>;
05032             }
05033             <span class="keywordflow">if</span> (HighPage1 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
05034                 HighPage1 = <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>;
05035             }
05036         } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05037 
05038         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PagePlacementOk == TRUE);
05039         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(*FirstMdlPageToZero);
05040         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> == MI_MAGIC_AWE_PTEFRAME);
05041 <span class="preprocessor">#endif</span>
05042 <span class="preprocessor"></span>        <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (*FirstMdlPageToZero, 0);
05043         FirstMdlPageToZero += 1;
05044     }
05045 
05046     <span class="keywordflow">return</span> MemoryDescriptorList;
05047 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a319" doxytag="mm.h::MmAllocateSpecialPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmAllocateSpecialPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Tag</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SpecialPoolType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03408">3408</a> of file <a class="el" href="../../d2/d5/allocpag_8c-source.html">allocpag.c</a>.
<p>
References <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03472">MiAllocateSpecialPool()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02922">MiSpecialPoolPtes</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00993">ExAllocatePoolWithTagPriority()</a>, and <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03325">MmSqueezeBadTags()</a>.
<p>
<pre class="fragment"><div>03417                    :
03418 
03419     This routine allocates <span class="keyword">virtual</span> memory from special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.  This allocation
03420     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of a physical page with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next PTE set to no access
03421     so that any reads or writes will cause an immediate fatal system crash.
03422     
03423     This lets us <span class="keywordflow">catch</span> components that corrupt <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
03424 
03425 Arguments:
03426 
03427     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to commit.
03428 
03429     Tag - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested allocation.
03430 
03431     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested allocation.
03432 
03433     SpecialPoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03434                       requested allocation.
03435 
03436                       - 0 indicates overruns.
03437                       - 1 indicates underruns.
03438                       - 2 indicates use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> systemwide <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> policy.
03439 
03440 Return Value:
03441 
03442     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> non-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> pointer <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested allocation was fulfilled from special
03443     <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation was not <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>.
03444 
03445 Environment:
03446 
03447     Kernel mode, no <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> locks held.
03448 
03449     Note <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a nonpagable wrapper so that machines without special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
03450     can still support drivers allocating nonpaged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> at <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>
03451     requesting special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
03452 
03453 --*/
03454 
03455 {
03456     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/allocpag_8c.html#a26">MiSpecialPoolPtes</a> == 0) {
03457 
03458         <span class="comment">//</span>
03459         <span class="comment">// The special pool allocation code was never initialized.</span>
03460         <span class="comment">//</span>
03461 
03462         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03463     }
03464 
03465     <span class="keywordflow">return</span> <a class="code" href="../../d1/d6/allocpag_8c.html#a40">MiAllocateSpecialPool</a> (NumberOfBytes,
03466                                   Tag,
03467                                   PoolType,
03468                                   SpecialPoolType);
03469 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a225" doxytag="mm.h::MmAllowWorkingSetExpansion" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmAllowWorkingSetExpansion           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l04948">4948</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00066">_MMSUPPORT::AllowWorkingSetAdjustment</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02222">_MMWORKING_SET_EXPANSION_HEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05071">MmWorkingSetExpansionHead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00065">_MMSUPPORT::WorkingSetExpansionLinks</a>.
<p>
Referenced by <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01920">PspSystemThreadStartup()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01800">PspUserThreadStartup()</a>.
<p>
<pre class="fragment"><div>04954                    :
04955 
04956     This routine updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set list head FLINK field to
04957     indicate that working set adjustment <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed.
04958 
04959     NOTE: This routine may be called more than once per process.
04960 
04961 Arguments:
04962 
04963     None.
04964 
04965 Return Value:
04966 
04967     None.
04968 
04969 Environment:
04970 
04971     Kernel mode.
04972 
04973 --*/
04974 
04975 {
04976 
04977     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
04978     KIRQL OldIrql;
04979 
04980     <span class="comment">//</span>
04981     <span class="comment">// Check the current state of the working set adjustment flag</span>
04982     <span class="comment">// in the process header.</span>
04983     <span class="comment">//</span>
04984 
04985     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
04986 
04987     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
04988 
04989     <span class="keywordflow">if</span> (!CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a>) {
04990         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04991 
04992         InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
04993                         &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
04994     }
04995 
04996     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
04997     <span class="keywordflow">return</span>;
04998 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a193" doxytag="mm.h::MmAssignProcessToJob" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MmAssignProcessToJob           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l02386">2386</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01093">LOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00318">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02823">PsChangeJobMemoryUsage()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l00439">PspAddProcessToJob()</a>.
<p>
<pre class="fragment"><div>02392                    :
02393 
02394     This routine acquires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set lock so a consistent snapshot of
02395     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> argument process' commit charges and working set size can be used
02396     when adding <span class="keyword">this</span> process to a job.
02397 
02398 Arguments:
02399 
02400     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process to operate upon.
02401 
02402 Return Value:
02403 
02404     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed to join <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> job, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
02405 
02406     Note that <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> cannot be returned without changing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> code in ps.
02407 
02408 Environment:
02409 
02410     Kernel mode, IRQL <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.  The caller provides protection
02411     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process going away.
02412 
02413 --*/
02414 
02415 {
02416     LOGICAL Attached;
02417     LOGICAL <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02418 
02419     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02420 
02421     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02422 
02423     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != Process) {
02424         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
02425         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02426     }
02427 
02428     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
02429 
02430     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a> (Process-&gt;CommitCharge);
02431 
02432     <span class="comment">//</span>
02433     <span class="comment">// Join the job unconditionally.  If the process is over any limits, it</span>
02434     <span class="comment">// will be caught on its next request.</span>
02435     <span class="comment">//</span>
02436 
02437     Process-&gt;JobStatus |= <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>;
02438 
02439     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
02440 
02441     <span class="keywordflow">if</span> (Attached) {
02442         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
02443     }
02444 
02445     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02446 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a275" doxytag="mm.h::MmBuildMdlForNonPagedPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmBuildMdlForNonPagedPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>MemoryDescriptorList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l01500">1500</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00428">MDL_PARTIAL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00426">MDL_SOURCE_IS_NONPAGED_POOL</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02287">MI_CONVERT_PHYSICAL_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01460">MmIsNonPagedSystemAddressValid()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l01424">MiCreateImageFileMap()</a>, and <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00883">UdfPrepareBuffers()</a>.
<p>
<pre class="fragment"><div>01506                    :
01507 
01508     This routine fills in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"pages"</span> portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN
01509     numbers corresponding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffers which resides in non-paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01510 
01511     Unlike <a class="code" href="../../d2/d1/mm_8h.html#a273">MmProbeAndLockPages</a>, there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no corresponding unlock as no
01512     reference counts are incremented as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffers being in nonpaged
01513     <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> are always resident.
01514 
01515 Arguments:
01516 
01517     MemoryDescriptorList - Supplies a pointer to a Memory Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>
01518                             (<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>). The supplied <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> must supply a <span class="keyword">virtual</span>
01519                             address, byte offset and length field.  The
01520                             physical page portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> updated when
01521                             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are locked in memory.  The <span class="keyword">virtual</span>
01522                             address must be within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-paged portion
01523                             of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system space.
01524 
01525 Return Value:
01526 
01527     None.
01528 
01529 Environment:
01530 
01531     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below.
01532 
01533 --*/
01534 
01535 {
01536     PPFN_NUMBER Page;
01537     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01538     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
01539     PVOID EndVa;
01540     PFN_NUMBER PageFrameIndex;
01541 
01542     Page = (PPFN_NUMBER)(MemoryDescriptorList + 1);
01543 
01544     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MemoryDescriptorList-&gt;ByteCount != 0);
01545     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; (
01546                     MDL_PAGES_LOCKED |
01547                     MDL_MAPPED_TO_SYSTEM_VA |
01548                     MDL_SOURCE_IS_NONPAGED_POOL |
01549                     MDL_PARTIAL)) == 0);
01550 
01551     MemoryDescriptorList-&gt;Process = (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01552 
01553     <span class="comment">//</span>
01554     <span class="comment">// Endva is last byte of the buffer.</span>
01555     <span class="comment">//</span>
01556 
01557     MemoryDescriptorList-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a14">MDL_SOURCE_IS_NONPAGED_POOL</a>;
01558 
01559     MemoryDescriptorList-&gt;MappedSystemVa =
01560             (PVOID)((PCHAR)MemoryDescriptorList-&gt;StartVa +
01561                                            MemoryDescriptorList-&gt;ByteOffset);
01562 
01563     EndVa = (PVOID)(((PCHAR)MemoryDescriptorList-&gt;MappedSystemVa +
01564                             MemoryDescriptorList-&gt;ByteCount - 1));
01565 
01566     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndVa);
01567 
01568     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmIsNonPagedSystemAddressValid (MemoryDescriptorList-&gt;StartVa));
01569 
01570     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MemoryDescriptorList-&gt;StartVa);
01571 
01572     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(EndVa)) {
01573         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (
01574                                 MemoryDescriptorList-&gt;StartVa);
01575 
01576         <span class="keywordflow">do</span> {
01577             *Page = PageFrameIndex;
01578             Page += 1;
01579             PageFrameIndex += 1;
01580             PointerPte += 1;
01581         } <span class="keywordflow">while</span> (PointerPte &lt;= LastPte);
01582     } <span class="keywordflow">else</span> {
01583         <span class="keywordflow">do</span> {
01584             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
01585             *Page = PageFrameIndex;
01586             Page += 1;
01587             PointerPte += 1;
01588         } <span class="keywordflow">while</span> (PointerPte &lt;= LastPte);
01589     }
01590 
01591     <span class="keywordflow">return</span>;
01592 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a341" doxytag="mm.h::MmCallDllInitialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmCallDllInitialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLDR_DATA_TABLE_ENTRY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DataTableEntry</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l06717">6717</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00178">CmRegistryMachineSystemCurrentControlSetServices</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03712">MiLocateExportName()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01910">PMM_DLL_INITIALIZE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.
<p>
<pre class="fragment"><div>06723                    :
06724 
06725     This function calls <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL's initialize routine.
06726 
06727 Arguments:
06728 
06729     DataTableEntry - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel's data table entry.
06730 
06731 Return Value:
06732 
06733     Various <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> error codes.
06734 
06735 Environment:
06736 
06737     Kernel mode.
06738 
06739 --*/
06740 
06741 {
06742     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
06743     PWCHAR Dot;
06744     <a class="code" href="../../d2/d1/mm_8h.html#a157">PMM_DLL_INITIALIZE</a> Func;
06745     UNICODE_STRING RegistryPath;
06746     UNICODE_STRING ImportName;
06747 
06748     Func = <a class="code" href="../../d8/d8/sysload_8c.html#a44">MiLocateExportName</a> (DataTableEntry-&gt;DllBase, <span class="stringliteral">"DllInitialize"</span>);
06749 
06750     <span class="keywordflow">if</span> (!Func) {
06751         <span class="keywordflow">return</span> STATUS_SUCCESS;
06752     }
06753 
06754     ImportName.MaximumLength = DataTableEntry-&gt;BaseDllName.Length;
06755     ImportName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
06756                                                ImportName.MaximumLength,
06757                                                'TDmM');
06758 
06759     <span class="keywordflow">if</span> (ImportName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06760         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
06761     }
06762 
06763     ImportName.Length = DataTableEntry-&gt;BaseDllName.Length;
06764     RtlMoveMemory (ImportName.Buffer,
06765                    DataTableEntry-&gt;BaseDllName.Buffer,
06766                    ImportName.Length);
06767 
06768     RegistryPath.MaximumLength = <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Length +
06769                                     ImportName.Length +
06770                                     (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(2*<span class="keyword">sizeof</span>(WCHAR));
06771 
06772     RegistryPath.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
06773                                                  RegistryPath.MaximumLength,
06774                                                  'TDmM');
06775 
06776     <span class="keywordflow">if</span> (RegistryPath.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06777         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportName.Buffer);
06778         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
06779     }
06780 
06781     RegistryPath.Length = <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Length;
06782     RtlMoveMemory (RegistryPath.Buffer,
06783                    <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Buffer,
06784                    <a class="code" href="../../d6/d0/cmdat_8c.html#a25">CmRegistryMachineSystemCurrentControlSetServices</a>.Length);
06785 
06786     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a> (&amp;RegistryPath, L<span class="stringliteral">"\\"</span>);
06787     Dot = wcschr (ImportName.Buffer, L<span class="charliteral">'.'</span>);
06788     <span class="keywordflow">if</span> (Dot) {
06789         ImportName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((Dot - ImportName.Buffer) * <span class="keyword">sizeof</span>(WCHAR));
06790     }
06791 
06792     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a> (&amp;RegistryPath, &amp;ImportName);
06793     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ImportName.Buffer);
06794 
06795     <span class="comment">//</span>
06796     <span class="comment">// Invoke the DLL's initialization routine.</span>
06797     <span class="comment">//</span>
06798 
06799     st = Func (&amp;RegistryPath);
06800 
06801     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (RegistryPath.Buffer);
06802 
06803     <span class="keywordflow">return</span> st;
06804 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a258" doxytag="mm.h::MmCanFileBeTruncated" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmCanFileBeTruncated           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionPointer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>NewFileSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02552">2552</a> of file <a class="el" href="../../d6/d4/sectsup_8c-source.html">sectsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02614">MiCanFileBeTruncatedInternal()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l02331">CcPurgeCacheSection()</a>.
<p>
<pre class="fragment"><div>02559                    :
02560 
02561     This routine does <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
02562 
02563         1.  Checks to see <span class="keywordflow">if</span> a image section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in use <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>,
02564             <span class="keywordflow">if</span> so <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
02565 
02566         2.  Checks to see <span class="keywordflow">if</span> a user section exists <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, <span class="keywordflow">if</span>
02567             <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> checks to make sure <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> greater
02568             than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, <span class="keywordflow">if</span> not <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
02569 
02570         3.  If no image section exists, and no user created data section
02571             exists or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>'s size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> greater, then <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02572 
02573 Arguments:
02574 
02575     SectionPointer - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object pointers
02576                      from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
02577 
02578     NewFileSize - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> getting set to.
02579 
02580 Return Value:
02581 
02582     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> can be truncated, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> cannot be.
02583 
02584 Environment:
02585 
02586     Kernel mode.
02587 
02588 --*/
02589 
02590 {
02591     LARGE_INTEGER LocalOffset;
02592     KIRQL OldIrql;
02593 
02594     <span class="comment">//</span>
02595     <span class="comment">//  Capture caller's file size, since we may modify it.</span>
02596     <span class="comment">//</span>
02597 
02598     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NewFileSize)) {
02599 
02600         LocalOffset = *NewFileSize;
02601         NewFileSize = &amp;LocalOffset;
02602     }
02603 
02604     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/sectsup_8c.html#a31">MiCanFileBeTruncatedInternal</a>( SectionPointer, NewFileSize, FALSE, &amp;OldIrql )) {
02605 
02606         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02607         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02608     }
02609 
02610     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02611 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a262" doxytag="mm.h::MmCheckCachedPageState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmCheckCachedPageState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SetToZero</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01016">1016</a> of file <a class="el" href="../../d2/d4/mapcache_8c-source.html">mapcache.c</a>.
<p>
References <a class="el" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02767">MI_BARRIER_SYNCHRONIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01289">MI_DETERMINE_OWNER</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02411">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00808">MI_SET_GLOBAL_STATE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00641">MI_SET_PTE_IN_WORKING_SET</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01559">MiGetSubsectionAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00117">MiLocateAndReserveWsle()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00996">MiMakeSystemAddressValidPfn()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01466">MiPteToProto</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01177">MiRemoveZeroPage()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01078">MiUpdateWsle()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00376">MM_PTE_OWNER_MASK</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04752">MmSystemCacheWorkingSetList</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04754">MmSystemCacheWsle</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/copysup_8c-source.html#l00031">CcCopyRead()</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l00588">CcFastCopyRead()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l05749">CcMapAndRead()</a>, and <a class="el" href="../../d7/d1/cachesub_8c-source.html#l01633">CcPerformReadAhead()</a>.
<p>
<pre class="fragment"><div>01023                    :
01024 
01025     This routine checks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified page that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mapped in
01026     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cache.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span> address can be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> valid
01027     (i.e., <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already in memory), <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> valid and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value
01028     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01029 
01030     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not in memory, and SetToZero <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01031     value <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.  However, <span class="keywordflow">if</span> SetToZero <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, a page of
01032     zeroes <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> materialized <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span> address and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address
01033     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> valid and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01034 
01035     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> usage by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache manager.
01036 
01037 Arguments:
01038 
01039     Address - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a page mapped in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cache.
01040 
01041     SetToZero - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> a page of zeroes should be created in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01042                 <span class="keywordflow">case</span> where no page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already mapped.
01043 
01044 Return Value:
01045 
01046     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> there <span class="keywordflow">if</span> touching <span class="keyword">this</span> page would cause a page fault resulting
01047           in a page read.
01048 
01049     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a physical page in memory <span class="keywordflow">for</span> <span class="keyword">this</span> address.
01050 
01051 Environment:
01052 
01053     Kernel mode.
01054 
01055 --*/
01056 
01057 {
01058     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01059     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
01060     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPte;
01061     PFN_NUMBER PageFrameIndex;
01062     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
01063     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
01064     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> ProtoPteContents;
01065     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01066     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
01067     KIRQL OldIrql;
01068     LOGICAL BarrierNeeded;
01069     ULONG BarrierStamp;
01070 
01071     BarrierNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01072 
01073     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Address);
01074 
01075     <span class="comment">//</span>
01076     <span class="comment">// Make the PTE valid if possible.</span>
01077     <span class="comment">//</span>
01078 
01079     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01080         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01081     }
01082 
01083     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01084 
01085     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01086         <span class="keywordflow">goto</span> UnlockAndReturnTrue;
01087     }
01088 
01089     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1);
01090 
01091     ProtoPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (PointerPte);
01092 
01093     <span class="comment">//</span>
01094     <span class="comment">// Pte is not valid, check the state of the prototype PTE.</span>
01095     <span class="comment">//</span>
01096 
01097     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (ProtoPte)) {
01098 
01099         <span class="comment">//</span>
01100         <span class="comment">// If page fault occurred, recheck state of original PTE.</span>
01101         <span class="comment">//</span>
01102 
01103         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01104             <span class="keywordflow">goto</span> UnlockAndReturnTrue;
01105         }
01106     }
01107 
01108     ProtoPteContents = *ProtoPte;
01109 
01110     <span class="keywordflow">if</span> (ProtoPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01111 
01112         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;ProtoPteContents);
01113         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01114 
01115         <span class="comment">//</span>
01116         <span class="comment">// The prototype PTE is valid, make the cache PTE</span>
01117         <span class="comment">// valid and add it to the working set.</span>
01118         <span class="comment">//</span>
01119 
01120         TempPte = ProtoPteContents;
01121 
01122     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ProtoPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) &amp;&amp;
01123                (ProtoPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0)) {
01124 
01125         <span class="comment">//</span>
01126         <span class="comment">// Prototype PTE is in the transition state.  Remove the page</span>
01127         <span class="comment">// from the page list and make it valid.</span>
01128         <span class="comment">//</span>
01129 
01130         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;ProtoPteContents);
01131         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01132         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress) ||
01133             (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.InPageError)) {
01134 
01135             <span class="comment">//</span>
01136             <span class="comment">// Collided page fault, return.</span>
01137             <span class="comment">//</span>
01138 
01139             <span class="keywordflow">goto</span> UnlockAndReturnTrue;
01140         }
01141 
01142         <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
01143 
01144         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
01145         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01146 
01147         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
01148                            PageFrameIndex,
01149                            Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection,
01150                            NULL );
01151 
01152         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (ProtoPte, TempPte);
01153 
01154         <span class="comment">//</span>
01155         <span class="comment">// Increment the valid PTE count for the page containing</span>
01156         <span class="comment">// the prototype PTE.</span>
01157         <span class="comment">//</span>
01158 
01159         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01160 
01161     } <span class="keywordflow">else</span> {
01162 
01163         <span class="comment">//</span>
01164         <span class="comment">// Page is not in memory, if a page of zeroes is requested,</span>
01165         <span class="comment">// get a page of zeroes and make it valid.</span>
01166         <span class="comment">//</span>
01167 
01168         <span class="keywordflow">if</span> ((SetToZero == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) || (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 8)) {
01169             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01170 
01171             <span class="comment">//</span>
01172             <span class="comment">// Fault the page into memory.</span>
01173             <span class="comment">//</span>
01174 
01175             <a class="code" href="../../d4/d1/mmfault_8c.html#a2">MmAccessFault</a> (FALSE, Address, KernelMode, (PVOID)0);
01176             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01177         }
01178 
01179         <span class="comment">//</span>
01180         <span class="comment">// Increment the count of Pfn references for the control area</span>
01181         <span class="comment">// corresponding to this file.</span>
01182         <span class="comment">//</span>
01183 
01184         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (
01185                     ProtoPte)-&gt;ControlArea-&gt;NumberOfPfnReferences += 1;
01186 
01187         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a>(MI_GET_PAGE_COLOR_FROM_PTE (ProtoPte));
01188 
01189         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01190 
01191         <span class="comment">//</span>
01192         <span class="comment">// This barrier check is needed after zeroing the page and</span>
01193         <span class="comment">// before setting the PTE (not the prototype PTE) valid.</span>
01194         <span class="comment">// Capture it now, check it at the last possible moment.</span>
01195         <span class="comment">//</span>
01196 
01197         BarrierNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01198         BarrierStamp = (ULONG)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>;
01199 
01200         <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, ProtoPte, 1);
01201         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
01202         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte = 1;
01203 
01204         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
01205                            PageFrameIndex,
01206                            Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection,
01207                            NULL );
01208 
01209         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (ProtoPte, TempPte);
01210     }
01211 
01212     <span class="comment">//</span>
01213     <span class="comment">// Increment the share count since the page is being put into a working</span>
01214     <span class="comment">// set.</span>
01215     <span class="comment">//</span>
01216 
01217     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01218 
01219     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01220         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01221     }
01222 
01223     <span class="comment">//</span>
01224     <span class="comment">// Increment the reference count of the page table</span>
01225     <span class="comment">// page for this PTE.</span>
01226     <span class="comment">//</span>
01227 
01228     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
01229     Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01230 
01231     Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01232 
01233     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, 1);
01234 
01235 <span class="preprocessor">#if defined (_WIN64)</span>
01236 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a136">MI_DETERMINE_OWNER</a> (PointerPte) == 0) {
01237         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long &amp;= ~<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a79">MM_PTE_OWNER_MASK</a>;
01238     }
01239 <span class="preprocessor">#else</span>
01240 <span class="preprocessor"></span>    TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Owner = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a136">MI_DETERMINE_OWNER</a> (PointerPte);
01241 <span class="preprocessor">#endif</span>
01242 <span class="preprocessor"></span>
01243     <span class="keywordflow">if</span> (BarrierNeeded) {
01244         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a197">MI_BARRIER_SYNCHRONIZE</a> (BarrierStamp);
01245     }
01246 
01247     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
01248 
01249     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01250 
01251     <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrql);
01252 
01253     WorkingSetIndex = <a class="code" href="../../d4/d0/wslist_8c.html#a21">MiLocateAndReserveWsle</a> (&amp;MmSystemCacheWs);
01254 
01255     <a class="code" href="../../d4/d0/wslist_8c.html#a25">MiUpdateWsle</a> (&amp;WorkingSetIndex,
01256                   MiGetVirtualAddressMappedByPte (PointerPte),
01257                   MmSystemCacheWorkingSetList,
01258                   Pfn1);
01259 
01260     <a class="code" href="../../d4/d8/mi_8h.html#a658">MmSystemCacheWsle</a>[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.SameProtectAsProto = 1;
01261 
01262     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPte, WorkingSetIndex);
01263 
01264     <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql);
01265 
01266     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01267 
01268 UnlockAndReturnTrue:
01269     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01270     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01271 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a212" doxytag="mm.h::MmCleanProcessAddressSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmCleanProcessAddressSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a213" doxytag="mm.h::MmCleanUserProcessAddressSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmCleanUserProcessAddressSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a214" doxytag="mm.h::MmCleanVirtualAddressDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmCleanVirtualAddressDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a263" doxytag="mm.h::MmCopyToCachedPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmCopyToCachedPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>UserBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Offset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>CountInBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DontZero</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01274">1274</a> of file <a class="el" href="../../d2/d4/mapcache_8c-source.html">mapcache.c</a>.
<p>
References <a class="el" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00365">_ETHREAD::ApcNeeded</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12782">IoRetryIrpCompletions()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01417">MI_ADD_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01430">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01289">MI_DETERMINE_OWNER</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02411">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01219">MI_MAGIC_AWE_PTEFRAME</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01470">MI_REMOVE_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00808">MI_SET_GLOBAL_STATE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00641">MI_SET_PTE_IN_WORKING_SET</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l04252">MiFreeInPageSupportBlock()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l04152">MiGetInPageSupportBlock()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01559">MiGetSubsectionAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03650">MiInitializeTransitionPfn()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00117">MiLocateAndReserveWsle()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00996">MiMakeSystemAddressValidPfn()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01779">MiMapCacheExceptionFilter()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01466">MiPteToProto</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01078">MiUpdateWsle()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00376">MM_PTE_OWNER_MASK</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01053">MmResetPageFaultReadAhead</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00983">MmSavePageFaultReadAhead</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01018">MmSetPageFaultReadAhead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00215">MmShortTime</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04752">MmSystemCacheWorkingSetList</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04754">MmSystemCacheWsle</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00364">_ETHREAD::NestedFaultCount</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02061">_CONTROL_AREA::NumberOfPfnReferences</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02065">_CONTROL_AREA::NumberOfUserReferences</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cachesub_8c-source.html#l06024">CcMapAndCopy()</a>.
<p>
<pre class="fragment"><div>01284                    :
01285 
01286     This routine checks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified page that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mapped in
01287     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cache.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span> address can be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> valid
01288     (i.e., <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already in memory), <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> valid and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value
01289     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01290 
01291     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not in memory, and SetToZero <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01292     value <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.  However, <span class="keywordflow">if</span> SetToZero <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, a page of
01293     zeroes <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> materialized <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span> address and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address
01294     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> valid and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01295 
01296     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> usage by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache manager.
01297 
01298 Arguments:
01299 
01300     Address - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a page mapped in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cache.
01301               This MUST be a page aligned address!
01302 
01303     UserBuffer - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a user buffer to copy into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01304                  system cache at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address + offset.
01305 
01306     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UserBuffer to copy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data.
01307 
01308     CountInBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> byte count to copy from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user buffer.
01309 
01310     DontZero - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer should not be zeroed (the
01311                caller will track zeroing).  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> should be zeroed.
01312 
01313 Return Value:
01314 
01315     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> copy.
01316 
01317 Environment:
01318 
01319     Kernel mode, &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>.
01320 
01321 --*/
01322 
01323 {
01324     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01325     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
01326     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPte;
01327     PFN_NUMBER PageFrameIndex;
01328     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
01329     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
01330     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> ProtoPteContents;
01331     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01332     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
01333     KIRQL OldIrql;
01334     ULONG TransitionState;
01335     ULONG AddToWorkingSet;
01336     LOGICAL ShareCountUpped;
01337     SIZE_T EndFill;
01338     PVOID <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01339     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01340     <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
01341     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
01342     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
01343     ULONG SavedState;
01344     LOGICAL ApcsExplicitlyBlocked;
01345     LOGICAL ApcNeeded;
01346 
01347     TransitionState = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01348     AddToWorkingSet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01349     ApcsExplicitlyBlocked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01350     ApcNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01351 
01352     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG_PTR)Address &amp; (PAGE_SIZE - 1)) == 0);
01353     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((CountInBytes + Offset) &lt;= PAGE_SIZE);
01354     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt; DISPATCH_LEVEL);
01355 
01356     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Address);
01357 
01358     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01359         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a>;
01360     }
01361 
01362     <span class="comment">//</span>
01363     <span class="comment">// Touch the user's buffer to make it resident.  This is required in</span>
01364     <span class="comment">// order to safely detect the case where both the system and user</span>
01365     <span class="comment">// address are pointing at the same physical page.  This case causes</span>
01366     <span class="comment">// a deadlock during the RtlCopyBytes if the inpage support block needed</span>
01367     <span class="comment">// to be allocated and the PTE for the user page is not valid.  This</span>
01368     <span class="comment">// potential deadlock is resolved because if the user page causes a</span>
01369     <span class="comment">// collided fault, the initiator thread is checked for.  If they are</span>
01370     <span class="comment">// the same, then an exception is thrown by the pager.</span>
01371     <span class="comment">//</span>
01372 
01373     <span class="keywordflow">try</span> {
01374 
01375         *(<span class="keyword">volatile</span> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> *)UserBuffer;
01376 
01377     } except (EXCEPTION_EXECUTE_HANDLER) {
01378         <span class="keywordflow">return</span> GetExceptionCode();
01379     }
01380 
01381     <span class="comment">//</span>
01382     <span class="comment">// Make the PTE valid if possible.</span>
01383     <span class="comment">//</span>
01384 
01385     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01386 
01387 Recheck:
01388 
01389     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01390         <span class="keywordflow">goto</span> UnlockAndCopy;
01391     }
01392 
01393     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1);
01394 
01395     ProtoPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (PointerPte);
01396 
01397     <span class="comment">//</span>
01398     <span class="comment">// Pte is not valid, check the state of the prototype PTE.</span>
01399     <span class="comment">//</span>
01400 
01401     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (ProtoPte)) {
01402 
01403         <span class="comment">//</span>
01404         <span class="comment">// If page fault occurred, recheck state of original PTE.</span>
01405         <span class="comment">//</span>
01406 
01407         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01408             <span class="keywordflow">goto</span> UnlockAndCopy;
01409         }
01410     }
01411 
01412     ShareCountUpped = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01413     ProtoPteContents = *ProtoPte;
01414 
01415     <span class="keywordflow">if</span> (ProtoPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01416 
01417         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;ProtoPteContents);
01418         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01419 
01420         <span class="comment">//</span>
01421         <span class="comment">// Increment the share count so the prototype PTE will remain</span>
01422         <span class="comment">// valid until this can be added into the system's working set.</span>
01423         <span class="comment">//</span>
01424 
01425         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01426         ShareCountUpped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01427 
01428         <span class="comment">//</span>
01429         <span class="comment">// The prototype PTE is valid, make the cache PTE</span>
01430         <span class="comment">// valid and add it to the working set.</span>
01431         <span class="comment">//</span>
01432 
01433         TempPte = ProtoPteContents;
01434 
01435     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ProtoPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) &amp;&amp;
01436                (ProtoPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0)) {
01437 
01438         <span class="comment">//</span>
01439         <span class="comment">// Prototype PTE is in the transition state.  Remove the page</span>
01440         <span class="comment">// from the page list and make it valid.</span>
01441         <span class="comment">//</span>
01442 
01443         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;ProtoPteContents);
01444         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01445         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress) ||
01446             (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.InPageError)) {
01447 
01448             <span class="comment">//</span>
01449             <span class="comment">// Collided page fault or in page error, try the copy</span>
01450             <span class="comment">// operation incurring a page fault.</span>
01451             <span class="comment">//</span>
01452 
01453             <span class="keywordflow">goto</span> UnlockAndCopy;
01454         }
01455 
01456         <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
01457 
01458         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
01459         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01460         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
01461         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01462         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01463         ShareCountUpped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01464 
01465         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
01466                            PageFrameIndex,
01467                            Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection,
01468                            NULL );
01469         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
01470 
01471         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (ProtoPte, TempPte);
01472 
01473         <span class="comment">//</span>
01474         <span class="comment">// Increment the valid pte count for the page containing</span>
01475         <span class="comment">// the prototype PTE.</span>
01476         <span class="comment">//</span>
01477 
01478     } <span class="keywordflow">else</span> {
01479 
01480         <span class="comment">//</span>
01481         <span class="comment">// Page is not in memory, if a page of zeroes is requested,</span>
01482         <span class="comment">// get a page of zeroes and make it valid.</span>
01483         <span class="comment">//</span>
01484 
01485         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL)) {
01486 
01487             <span class="comment">//</span>
01488             <span class="comment">// A wait operation occurred which could have changed the</span>
01489             <span class="comment">// state of the PTE.  Recheck the PTE state.</span>
01490             <span class="comment">//</span>
01491 
01492             <span class="keywordflow">goto</span> Recheck;
01493         }
01494 
01495         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = <a class="code" href="../../d8/d2/pagfault_8c.html#a29">MiGetInPageSupportBlock</a> ();
01496         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01497             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01498             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, (PLARGE_INTEGER)&amp;MmShortTime);
01499             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01500             <span class="keywordflow">goto</span> Recheck;
01501         }
01502 
01503         <span class="comment">//</span>
01504         <span class="comment">// Increment the count of Pfn references for the control area</span>
01505         <span class="comment">// corresponding to this file.</span>
01506         <span class="comment">//</span>
01507 
01508         ControlArea = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (ProtoPte)-&gt;ControlArea;
01509         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> += 1;
01510         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> &gt; 0) {
01511 
01512             <span class="comment">//</span>
01513             <span class="comment">// There is a user reference to this file, always zero ahead.</span>
01514             <span class="comment">//</span>
01515 
01516             DontZero = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01517         }
01518 
01519         <span class="comment">//</span>
01520         <span class="comment">// Remove any page from the list and turn it into a transition</span>
01521         <span class="comment">// page in the cache with read in progress set.  This causes</span>
01522         <span class="comment">// any other references to this page to block on the specified</span>
01523         <span class="comment">// event while the copy operation to the cache is on-going.</span>
01524         <span class="comment">//</span>
01525 
01526         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a>(MI_GET_PAGE_COLOR_FROM_PTE (ProtoPte));
01527 
01528         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01529 
01530         <span class="comment">//</span>
01531         <span class="comment">// Increment the valid PTE count for the page containing</span>
01532         <span class="comment">// the prototype PTE.</span>
01533         <span class="comment">//</span>
01534 
01535         <a class="code" href="../../d8/d2/pagfault_8c.html#a24">MiInitializeTransitionPfn</a> (PageFrameIndex, ProtoPte, 0xFFFFFFFF);
01536 
01537         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
01538 
01539         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 0;     <span class="comment">// for the add_locked_page macro</span>
01540         <a class="code" href="../../d4/d8/mi_8h.html#a187">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a> (Pfn1, 24);
01541 
01542         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
01543         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte = 1;
01544         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
01545         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress = 1;
01546         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Event;
01547         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Pfn = Pfn1;
01548 
01549         <span class="comment">//</span>
01550         <span class="comment">// This is needed in case a special kernel APC fires that ends up</span>
01551         <span class="comment">// referencing the same page (this may even be through a different</span>
01552         <span class="comment">// virtual address from the user/system one here).</span>
01553         <span class="comment">//</span>
01554 
01555         Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
01556         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> &lt;= 1);
01557         Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> += 1;
01558 
01559         TransitionState = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01560 
01561         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
01562                            PageFrameIndex,
01563                            Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection,
01564                            NULL);
01565         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
01566 
01567         <span class="comment">//</span>
01568         <span class="comment">// APCs must be explicitly disabled to prevent suspend APCs from</span>
01569         <span class="comment">// interrupting this thread before the RtlCopyBytes completes.</span>
01570         <span class="comment">// Otherwise this page can remain in transition indefinitely (until</span>
01571         <span class="comment">// the suspend APC is released) which blocks any other threads that</span>
01572         <span class="comment">// may reference it.</span>
01573         <span class="comment">//</span>
01574 
01575         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01576         ApcsExplicitlyBlocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01577     }
01578 
01579     <span class="comment">//</span>
01580     <span class="comment">// Increment the share count of the page table page for this PTE.</span>
01581     <span class="comment">//</span>
01582 
01583     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
01584     Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01585 
01586     Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01587 
01588     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, 1);
01589 <span class="preprocessor">#if defined (_WIN64)</span>
01590 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a136">MI_DETERMINE_OWNER</a> (PointerPte) == 0) {
01591         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long &amp;= ~<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a79">MM_PTE_OWNER_MASK</a>;
01592     }
01593 <span class="preprocessor">#else</span>
01594 <span class="preprocessor"></span>    TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Owner = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a136">MI_DETERMINE_OWNER</a> (PointerPte);
01595 <span class="preprocessor">#endif</span>
01596 <span class="preprocessor"></span>    <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
01597 
01598     AddToWorkingSet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01599 
01600 UnlockAndCopy:
01601 
01602     <span class="comment">//</span>
01603     <span class="comment">// Unlock the PFN database and perform the copy.</span>
01604     <span class="comment">//</span>
01605 
01606     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01607 
01608 <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a>:
01609 
01610     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
01611     <a class="code" href="../../d2/d1/mm_8h.html#a19">MmSavePageFaultReadAhead</a>( Thread, &amp;SavedState );
01612     <a class="code" href="../../d2/d1/mm_8h.html#a20">MmSetPageFaultReadAhead</a>( Thread, 0 );
01613     status = STATUS_SUCCESS;
01614 
01615     <span class="comment">//</span>
01616     <span class="comment">// Copy the user buffer into the cache under an exception handler.</span>
01617     <span class="comment">//</span>
01618 
01619     <span class="keywordflow">try</span> {
01620 
01621         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (PVOID)((PCHAR)Address + <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>);
01622         RtlCopyBytes (Buffer, UserBuffer, CountInBytes);
01623 
01624         <span class="keywordflow">if</span> (TransitionState) {
01625 
01626             <span class="comment">//</span>
01627             <span class="comment">// Only zero the memory outside the range if a page was taken</span>
01628             <span class="comment">// from the free list.</span>
01629             <span class="comment">//</span>
01630 
01631             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> != 0) {
01632                 RtlZeroMemory (Address, Offset);
01633             }
01634 
01635             <span class="keywordflow">if</span> (DontZero == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01636                 EndFill = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> + CountInBytes);
01637 
01638                 <span class="keywordflow">if</span> (EndFill != 0) {
01639                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (PVOID)((PCHAR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + CountInBytes);
01640                     RtlZeroMemory (Buffer, EndFill);
01641                 }
01642             }
01643         }
01644     } except (MiMapCacheExceptionFilter (&amp;status, GetExceptionInformation())) {
01645 
01646         <span class="keywordflow">if</span> (status == STATUS_MULTIPLE_FAULT_VIOLATION) {
01647             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TransitionState == TRUE);
01648         }
01649 
01650         <span class="comment">//</span>
01651         <span class="comment">// Zero out the page if it came from the free list.</span>
01652         <span class="comment">//</span>
01653 
01654         <span class="keywordflow">if</span> (TransitionState) {
01655             RtlZeroMemory (Address, PAGE_SIZE);
01656         }
01657     }
01658 
01659     <a class="code" href="../../d2/d1/mm_8h.html#a21">MmResetPageFaultReadAhead</a>(Thread, SavedState);
01660 
01661     <span class="keywordflow">if</span> (AddToWorkingSet) {
01662 
01663         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01664 
01665         <span class="keywordflow">if</span> (ApcsExplicitlyBlocked == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01666             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01667         }
01668 
01669         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0);
01670         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> == ProtoPte);
01671 
01672         <span class="keywordflow">if</span> (TransitionState) {
01673 
01674             <span class="comment">//</span>
01675             <span class="comment">// This is a newly allocated page.</span>
01676             <span class="comment">//</span>
01677 
01678             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ShareCountUpped == FALSE);
01679             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &lt;= 1);
01680             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event == &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Event);
01681 
01682             <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (ProtoPte);
01683             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, 0);
01684             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (ProtoPte, TempPte);
01685             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01686             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0);
01687             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
01688 
01689             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Completed == FALSE);
01690             <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Completed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01691 
01692             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01693             <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a>(Pfn1, 41);
01694             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01695 
01696             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress == 1);
01697             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress = 0;
01698 
01699             <span class="comment">//</span>
01700             <span class="comment">// Increment the share count since the page is</span>
01701             <span class="comment">// being put into a working set.</span>
01702             <span class="comment">//</span>
01703 
01704             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01705 
01706             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;WaitCount != 1) {
01707                 <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;IoStatus.Status = STATUS_SUCCESS;
01708                 <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;IoStatus.Information = 0;
01709                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>-&gt;Event, 0, FALSE);
01710             }
01711 
01712             <a class="code" href="../../d8/d2/pagfault_8c.html#a30">MiFreeInPageSupportBlock</a> (Event);
01713             <span class="keywordflow">if</span> (DontZero != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01714                 <a class="code" href="../../d4/d8/mi_8h.html#a186">MI_ADD_LOCKED_PAGE_CHARGE</a>(Pfn1, 40);
01715                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
01716                 status = STATUS_CACHE_PAGE_LOCKED;
01717             }
01718 
01719             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> &lt;= 3);
01720             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> != 0);
01721     
01722             Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> -= 1;
01723 
01724             <span class="keywordflow">if</span> ((Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o3">ApcNeeded</a> == 1) &amp;&amp; (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> == 0)) {
01725                 ApcNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01726                 Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o3">ApcNeeded</a> = 0;
01727             }
01728 
01729         } <span class="keywordflow">else</span> {
01730 
01731             <span class="comment">//</span>
01732             <span class="comment">// This is either a frame that was originally on the transition list</span>
01733             <span class="comment">// or was already valid when this routine began execution.  Either</span>
01734             <span class="comment">// way, the share count (and therefore the systemwide locked pages</span>
01735             <span class="comment">// count) has been dealt with.</span>
01736             <span class="comment">//</span>
01737 
01738             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ShareCountUpped == TRUE);
01739 
01740             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01741                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01742             }
01743         }
01744 
01745         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01746 
01747         <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrql);
01748 
01749         WorkingSetIndex = <a class="code" href="../../d4/d0/wslist_8c.html#a21">MiLocateAndReserveWsle</a> (&amp;MmSystemCacheWs);
01750 
01751         <a class="code" href="../../d4/d0/wslist_8c.html#a25">MiUpdateWsle</a> (&amp;WorkingSetIndex,
01752                       MiGetVirtualAddressMappedByPte (PointerPte),
01753                       MmSystemCacheWorkingSetList,
01754                       Pfn1);
01755 
01756         <a class="code" href="../../d4/d8/mi_8h.html#a658">MmSystemCacheWsle</a>[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.SameProtectAsProto = 1;
01757 
01758         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPte, WorkingSetIndex);
01759     
01760         <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql);
01761 
01762         <span class="keywordflow">if</span> (ApcNeeded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01763             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (OldIrql &lt; APC_LEVEL);
01764             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> == 0);
01765             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o3">ApcNeeded</a> == 0);
01766             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (APC_LEVEL, &amp;OldIrql);
01767             <a class="code" href="../../d4/d6/iosubs_8c.html#a136">IoRetryIrpCompletions</a> ();
01768             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
01769         }
01770     }
01771     <span class="keywordflow">else</span> {
01772         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ApcsExplicitlyBlocked == FALSE);
01773     }
01774 
01775     <span class="keywordflow">return</span> status;
01776 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a332" doxytag="mm.h::MmCopyVirtualMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmCopyVirtualMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FromProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FromAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ToProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ToAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytesCopied</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00362">362</a> of file <a class="el" href="../../d0/d5/readwrt_8c-source.html">readwrt.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00216">_EPROCESS::AddressSpaceDeleted</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00529">MiDoMappedCopy()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00758">MiDoPoolCopy()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00822">MiLockSystemSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00825">MiUnlockSystemSpace</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00048">POOL_MOVE_THRESHOLD</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00220">_EPROCESS::VmOperation</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00223">_EPROCESS::VmOperationEvent</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/lpcreply_8c-source.html#l00915">LpcpCopyRequestData()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00102">NtReadVirtualMemory()</a>, and <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00231">NtWriteVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00371 {
00372     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00373     KIRQL OldIrql;
00374     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToLock;
00375 
00376     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> == 0) {
00377         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE);         <span class="comment">// No one should call with a zero size.</span>
00378         <span class="keywordflow">return</span> STATUS_SUCCESS;
00379     }
00380 
00381     ProcessToLock = FromProcess;
00382     <span class="keywordflow">if</span> (FromProcess == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()) {
00383         ProcessToLock = ToProcess;
00384     }
00385 
00386     <span class="comment">//</span>
00387     <span class="comment">// Make sure the process still has an address space.</span>
00388     <span class="comment">//</span>
00389 
00390     <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
00391     <span class="keywordflow">if</span> (ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) {
00392         <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
00393         <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
00394     }
00395     ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o31">VmOperation</a> += 1;
00396     <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
00397 
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">// If the buffer size is greater than the pool move threshold,</span>
00401     <span class="comment">// then attempt to write the memory via direct mapping.</span>
00402     <span class="comment">//</span>
00403 
00404     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &gt; <a class="code" href="../../d9/d5/readwrt_8c.html#a3">POOL_MOVE_THRESHOLD</a>) {
00405         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a7">MiDoMappedCopy</a>(FromProcess,
00406                                 FromAddress,
00407                                 ToProcess,
00408                                 ToAddress,
00409                                 BufferSize,
00410                                 PreviousMode,
00411                                 NumberOfBytesCopied);
00412 
00413         <span class="comment">//</span>
00414         <span class="comment">// If the completion status is not a working quota problem,</span>
00415         <span class="comment">// then finish the service. Otherwise, attempt to write the</span>
00416         <span class="comment">// memory through nonpaged pool.</span>
00417         <span class="comment">//</span>
00418 
00419         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_WORKING_SET_QUOTA) {
00420             <span class="keywordflow">goto</span> CompleteService;
00421         }
00422 
00423         *NumberOfBytesCopied = 0;
00424     }
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// There was not enough working set quota to write the memory via</span>
00428     <span class="comment">// direct mapping or the size of the write was below the pool move</span>
00429     <span class="comment">// threshold. Attempt to write the specified memory through nonpaged</span>
00430     <span class="comment">// pool.</span>
00431     <span class="comment">//</span>
00432 
00433     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a8">MiDoPoolCopy</a>(FromProcess,
00434                           FromAddress,
00435                           ToProcess,
00436                           ToAddress,
00437                           BufferSize,
00438                           PreviousMode,
00439                           NumberOfBytesCopied);
00440 
00441     <span class="comment">//</span>
00442     <span class="comment">// Dereference the target process.</span>
00443     <span class="comment">//</span>
00444 
00445 CompleteService:
00446 
00447     <span class="comment">//</span>
00448     <span class="comment">// Indicate that the vm operation is complete.</span>
00449     <span class="comment">//</span>
00450 
00451     <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
00452     ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o31">VmOperation</a> -= 1;
00453     <span class="keywordflow">if</span> ((ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o31">VmOperation</a> == 0) &amp;&amp;
00454         (ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o34">VmOperationEvent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00455        <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (ProcessToLock-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o34">VmOperationEvent</a>, 0, FALSE);
00456     }
00457     <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
00458 
00459     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00460 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a215" doxytag="mm.h::MmCreateKernelStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmCreateKernelStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">BOOLEAN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LargeStack</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a305" doxytag="mm.h::MmCreateMdl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MmCreateMdl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Base</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05852">5852</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01789">MmInitializeMdl</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05815">MmSizeOfMdl()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, and <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00117">POOL_BUDDY_MAX</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01095">MiCheckForCrashDump()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l01424">MiCreateImageFileMap()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>, and <a class="el" href="../../d9/d4/physical_8c-source.html#l01624">NtFreeUserPhysicalPages()</a>.
<p>
<pre class="fragment"><div>05860                    :
05861 
05862     This function optionally allocates and initializes an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
05863 
05864 Arguments:
05865 
05866     MemoryDescriptorList - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>
05867                            to initialize.  If <span class="keyword">this</span> address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied as <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
05868                            an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated from non-paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> and
05869                            initialized.
05870 
05871     Base - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <span class="keyword">virtual</span> address <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
05872 
05873     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer in bytes.
05874 
05875 Return Value:
05876 
05877     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initialized <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
05878 
05879 Environment:
05880 
05881     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below.
05882 
05883 --*/
05884 
05885 {
05886     SIZE_T MdlSize;
05887 
05888     MdlSize = <a class="code" href="../../d5/d6/iosup_8c.html#a72">MmSizeOfMdl</a>( Base, Length );
05889 
05890     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( MemoryDescriptorList )) {
05891 
05892         <span class="comment">//</span>
05893         <span class="comment">// The pool manager doesn't like being called with large requests</span>
05894         <span class="comment">// marked MustSucceed, so try the normal nonpaged if the</span>
05895         <span class="comment">// request is large.</span>
05896         <span class="comment">//</span>
05897 
05898         <span class="keywordflow">if</span> (MdlSize &gt; <a class="code" href="../../d5/d2/poolhack_8c.html#a7">POOL_BUDDY_MAX</a>) {
05899             MemoryDescriptorList = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
05900                                                      NonPagedPool,
05901                                                      MdlSize,
05902                                                      'ldmM');
05903             <span class="keywordflow">if</span> (MemoryDescriptorList == (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0) {
05904                 <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0;
05905             }
05906         }
05907         <span class="keywordflow">else</span> {
05908             MemoryDescriptorList = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
05909                                                      NonPagedPoolMustSucceed,
05910                                                      MdlSize,
05911                                                      'ldmM');
05912         }
05913     }
05914 
05915     <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a> (MemoryDescriptorList, Base, Length);
05916     <span class="keywordflow">return</span> MemoryDescriptorList;
05917 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a223" doxytag="mm.h::MmCreatePeb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PPEB MmCreatePeb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d2/struct__INITIAL__PEB.html">PINITIAL_PEB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>InitialPeb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l04631">4631</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d9/d0/init_8h-source.html#l00032">CmNtCSDVersion</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00039">InitAnsiCodePageDataOffset</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00042">InitNlsSectionPointer</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00040">InitOemCodePageDataOffset</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00041">InitUnicodeCaseTableDataOffset</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02766">KeActiveProcessors</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04418">MI_INIT_PEB_FROM_IMAGE</a>, <a class="el" href="../../d4/d5/procsup_8c.html#a20">MiCreatePebOrTeb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00218">MmCriticalSectionTimeout</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00105">MmHeapDeCommitFreeBlockThreshold</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00104">MmHeapDeCommitTotalFreeThreshold</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00103">MmHeapSegmentCommit</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00102">MmHeapSegmentReserve</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00103">MmRotatingUniprocessorNumber</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d4/triage_8c-source.html#l00042">NtBuildNumber</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00030">NtMajorVersion</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00031">NtMinorVersion</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>.
<p>
<pre class="fragment"><div>04638                    :
04639 
04640     This routine creates a PEB page within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process
04641     and copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial PEB values into <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
04642 
04643 Arguments:
04644 
04645     TargetProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process in which to create
04646                     and initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PEB.
04647 
04648     InitialPeb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial PEB to copy into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04649                  newly created PEB.
04650 
04651 Return Value:
04652 
04653     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created PEB.
04654 
04655     Can raise exceptions <span class="keywordflow">if</span> no address space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PEB or
04656     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user has exceeded quota (non-paged, pagefile, commit).
04657 
04658 Environment:
04659 
04660     Kernel mode.
04661 
04662 --*/
04663 
04664 {
04665     PPEB PebBase;
04666     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Magic;
04667     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Characteristics;
04668     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04669     PVOID ViewBase;
04670     LARGE_INTEGER SectionOffset;
04671     PIMAGE_NT_HEADERS NtHeaders;
04672     SIZE_T ViewSize;
04673     ULONG ReturnedSize;
04674     PIMAGE_LOAD_CONFIG_DIRECTORY ImageConfigData;
04675     ULONG ProcessAffinityMask;
04676 
04677     ViewBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04678     SectionOffset.LowPart = 0;
04679     SectionOffset.HighPart = 0;
04680     ViewSize = 0;
04681 
04682     <span class="comment">//</span>
04683     <span class="comment">// If the specified process is not the current process, attach</span>
04684     <span class="comment">// to the specified process.</span>
04685     <span class="comment">//</span>
04686 
04687     <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;TargetProcess-&gt;Pcb);
04688 
04689     <span class="comment">//</span>
04690     <span class="comment">// Map the NLS tables into the application's address space.</span>
04691     <span class="comment">//</span>
04692 
04693     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a>(
04694                 InitNlsSectionPointer,
04695                 TargetProcess,
04696                 &amp;ViewBase,
04697                 0L,
04698                 0L,
04699                 &amp;SectionOffset,
04700                 &amp;ViewSize,
04701                 ViewShare,
04702                 MEM_TOP_DOWN | SEC_NO_CHANGE,
04703                 PAGE_READONLY
04704                 );
04705 
04706     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
04707         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
04708         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(Status);
04709     }
04710 
04711     PebBase = (PPEB)<a class="code" href="../../d4/d5/procsup_8c.html#a20">MiCreatePebOrTeb</a> (TargetProcess,
04712                                       (ULONG)<span class="keyword">sizeof</span>( PEB ));
04713 
04714     <span class="comment">//</span>
04715     <span class="comment">// Initialize the Peb.</span>
04716     <span class="comment">//</span>
04717 
04718     PebBase-&gt;InheritedAddressSpace = InitialPeb-&gt;InheritedAddressSpace;
04719     PebBase-&gt;Mutant = InitialPeb-&gt;Mutant;
04720     PebBase-&gt;ImageBaseAddress = TargetProcess-&gt;SectionBaseAddress;
04721 
04722     PebBase-&gt;AnsiCodePageData = (PVOID)((PUCHAR)ViewBase+<a class="code" href="../../d8/d1/init_8h.html#a13">InitAnsiCodePageDataOffset</a>);
04723     PebBase-&gt;OemCodePageData = (PVOID)((PUCHAR)ViewBase+<a class="code" href="../../d8/d1/init_8h.html#a14">InitOemCodePageDataOffset</a>);
04724     PebBase-&gt;UnicodeCaseTableData = (PVOID)((PUCHAR)ViewBase+<a class="code" href="../../d8/d1/init_8h.html#a15">InitUnicodeCaseTableDataOffset</a>);
04725 
04726     PebBase-&gt;NumberOfProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>;
04727     PebBase-&gt;BeingDebugged = (BOOLEAN)(TargetProcess-&gt;DebugPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04728     PebBase-&gt;NtGlobalFlag = <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a>;
04729     PebBase-&gt;CriticalSectionTimeout = <a class="code" href="../../d4/d8/mi_8h.html#a423">MmCriticalSectionTimeout</a>;
04730     PebBase-&gt;HeapSegmentReserve = <a class="code" href="../../d8/d0/cmdat3_8c.html#a46">MmHeapSegmentReserve</a>;
04731     PebBase-&gt;HeapSegmentCommit = <a class="code" href="../../d8/d0/cmdat3_8c.html#a47">MmHeapSegmentCommit</a>;
04732     PebBase-&gt;HeapDeCommitTotalFreeThreshold = <a class="code" href="../../d8/d0/cmdat3_8c.html#a48">MmHeapDeCommitTotalFreeThreshold</a>;
04733     PebBase-&gt;HeapDeCommitFreeBlockThreshold = <a class="code" href="../../d8/d0/cmdat3_8c.html#a49">MmHeapDeCommitFreeBlockThreshold</a>;
04734     PebBase-&gt;NumberOfHeaps = 0;
04735     PebBase-&gt;MaximumNumberOfHeaps = (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <span class="keyword">sizeof</span>( PEB )) / <span class="keyword">sizeof</span>( PVOID );
04736     PebBase-&gt;ProcessHeaps = (PVOID *)(PebBase+1);
04737 
04738     PebBase-&gt;OSMajorVersion = <a class="code" href="../../d8/d1/init_8h.html#a5">NtMajorVersion</a>;
04739     PebBase-&gt;OSMinorVersion = <a class="code" href="../../d8/d1/init_8h.html#a6">NtMinorVersion</a>;
04740     PebBase-&gt;OSBuildNumber = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d5/d5/triage_8c.html#a0">NtBuildNumber</a> &amp; 0x3FFF);
04741     PebBase-&gt;OSPlatformId = 2;      <span class="comment">// VER_PLATFORM_WIN32_NT from winbase.h</span>
04742     PebBase-&gt;OSCSDVersion = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d8/d1/init_8h.html#a7">CmNtCSDVersion</a>;
04743 
04744     <span class="comment">//</span>
04745     <span class="comment">// Every reference to NtHeaders (including the call to RtlImageNtHeader)</span>
04746     <span class="comment">// must be wrapped in try-except in case the inpage fails.  The inpage</span>
04747     <span class="comment">// can fail for any reason including network failures, low resources, etc.</span>
04748     <span class="comment">//</span>
04749 
04750     <span class="keywordflow">try</span> {
04751         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( PebBase-&gt;ImageBaseAddress );
04752         Magic = NtHeaders-&gt;OptionalHeader.Magic;
04753         Characteristics = NtHeaders-&gt;FileHeader.Characteristics;
04754     } except (EXCEPTION_EXECUTE_HANDLER) {
04755         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
04756         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_INVALID_IMAGE_PROTECT);
04757     }
04758 
04759     <span class="keywordflow">if</span> (NtHeaders != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04760     
04761         ProcessAffinityMask = 0;
04762 <span class="preprocessor">#if defined(_WIN64)</span>
04763 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Magic == IMAGE_NT_OPTIONAL_HDR32_MAGIC) {
04764 
04765             <span class="comment">//</span>
04766             <span class="comment">// If this call fails, an exception will be thrown and the</span>
04767             <span class="comment">// detach performed so no need to handle errors here.</span>
04768             <span class="comment">//</span>
04769 
04770             MiInitializeWowPeb (NtHeaders, PebBase, TargetProcess);
04771 
04772         } <span class="keywordflow">else</span>      <span class="comment">// a PE32+ image</span>
04773 <span class="preprocessor">#endif</span>
04774 <span class="preprocessor"></span>        {
04775             <span class="keywordflow">try</span> {
04776                 ImageConfigData = <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a> (
04777                                         PebBase-&gt;ImageBaseAddress,
04778                                         TRUE,
04779                                         IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG,
04780                                         &amp;ReturnedSize);
04781     
04782                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a> ((PVOID)ImageConfigData,
04783                               <span class="keyword">sizeof</span> (*ImageConfigData),
04784                               <span class="keyword">sizeof</span> (ULONG));
04785 
04786                 <a class="code" href="../../d4/d5/procsup_8c.html#a4">MI_INIT_PEB_FROM_IMAGE</a>(NtHeaders, ImageConfigData);
04787 
04788                 <span class="keywordflow">if</span> (ImageConfigData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ImageConfigData-&gt;ProcessAffinityMask != 0) {
04789                     ProcessAffinityMask = ImageConfigData-&gt;ProcessAffinityMask;
04790                 }
04791 
04792             } except (EXCEPTION_EXECUTE_HANDLER) {
04793                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
04794                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_INVALID_IMAGE_PROTECT);
04795             }
04796 
04797         }
04798 
04799         <span class="comment">//</span>
04800         <span class="comment">// Note NT4 examined the NtHeaders-&gt;FileHeader.Characteristics</span>
04801         <span class="comment">// for the IMAGE_FILE_AGGRESIVE_WS_TRIM bit, but this is not needed</span>
04802         <span class="comment">// or used for NT5 and above.</span>
04803         <span class="comment">//</span>
04804 
04805         <span class="comment">//</span>
04806         <span class="comment">// See if image wants to override the default processor affinity mask.</span>
04807         <span class="comment">//</span>
04808 
04809         <span class="keywordflow">if</span> (Characteristics &amp; IMAGE_FILE_UP_SYSTEM_ONLY) {
04810 
04811             <span class="comment">//</span>
04812             <span class="comment">// Image is NOT MP safe.  Assign it a processor on a rotating</span>
04813             <span class="comment">// basis to spread these processes around on MP systems.</span>
04814             <span class="comment">//</span>
04815 
04816             <span class="keywordflow">do</span> {
04817                 PebBase-&gt;ImageProcessAffinityMask = (KAFFINITY)(0x1 &lt;&lt; <a class="code" href="../../d4/d5/procsup_8c.html#a15">MmRotatingUniprocessorNumber</a>);
04818                 <span class="keywordflow">if</span> (++<a class="code" href="../../d4/d5/procsup_8c.html#a15">MmRotatingUniprocessorNumber</a> &gt;= <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>) {
04819                     <a class="code" href="../../d4/d5/procsup_8c.html#a15">MmRotatingUniprocessorNumber</a> = 0;
04820                 }
04821             } <span class="keywordflow">while</span> ((PebBase-&gt;ImageProcessAffinityMask &amp; <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>) == 0);
04822         } <span class="keywordflow">else</span> {
04823 
04824             <span class="keywordflow">if</span> (ProcessAffinityMask != 0) {
04825 
04826                 <span class="comment">//</span>
04827                 <span class="comment">// Pass the affinity mask from the image header</span>
04828                 <span class="comment">// to LdrpInitializeProcess via the PEB.</span>
04829                 <span class="comment">//</span>
04830 
04831                 PebBase-&gt;ImageProcessAffinityMask = ProcessAffinityMask;
04832             }
04833         }
04834     }
04835 
04836     PebBase-&gt;SessionId = TargetProcess-&gt;SessionId;
04837 
04838     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
04839     <span class="keywordflow">return</span> PebBase;
04840 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a209" doxytag="mm.h::MmCreateProcessAddressSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmCreateProcessAddressSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MinimumWorkingSetSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectoryTableBase</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00190">190</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00207">CODE_END</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00205">CODE_START</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00875">CONSISTENCY_LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00876">CONSISTENCY_UNLOCK_PFN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00349">HYPER_SPACE</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l00442">INITIALIZE_DIRECTORY_TABLE_BASE</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00591">KSEG0_BASE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00593">KSEG2_BASE</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00170">KSTACK_POOL_START</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01039">LOCK_WS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00989">MI_INITIALIZE_HYPERSPACE_MAP</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01089">MI_PAGE_COLOR_PTE_PROCESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01116">MI_PAGE_COLOR_VA_PROCESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00808">MI_SET_GLOBAL_STATE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00191">MiChargeCommitment()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01722">MiGetPdeOffset</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01698">MiGetPpeOffset</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d3/d1/data386_8c-source.html#l00171">MiNumberOfExtraSystemPdes</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02814">MiRemoveZeroPageIfAny</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00178">MiSessionAddProcess()</a>, <a class="el" href="../../d3/d1/data386_8c-source.html#l00181">MiSystemCacheEndExtra</a>, <a class="el" href="../../d3/d1/data386_8c-source.html#l00179">MiSystemCacheStartExtra</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01184">MiZeroPhysicalPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04263">MM_DBG_COMMIT_PROCESS_CREATE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04301">MM_DBG_COMMIT_RETURN_PROCESS_CREATE_FAILURE1</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00116">MM_KSEG0_BASE</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00042">MM_PROCESS_COMMIT_CHARGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00141">MM_SESSION_SPACE_DEFAULT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00146">MM_SYSTEM_CACHE_WORKING_SET</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00168">MM_SYSTEM_SPACE_END</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00135">MM_SYSTEM_SPACE_START</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00278">MM_VA_MAPPED_BY_PDE</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00063">MmNonPagedSystemStart</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04921">MmProcessColorSeed</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00076">MmProcessCommit</a>, <a class="el" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00050">MmSystemCacheEnd</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00029">MmVirtualBias</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00232">_EPROCESS::NextPageColor</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00166">NON_PAGED_SYSTEM_END</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00455">PTE_PER_PAGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d7/d3/rtl_2random_8c-source.html#l00072">RtlRandom()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01081">UNLOCK_WS</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00056">ValidPdePde</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>.
<p>
<pre class="fragment"><div>00198                    :
00199 
00200     This routine creates an address space which maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system
00201     portion and contains a hyper space entry.
00202 
00203 Arguments:
00204 
00205     MinimumWorkingSetSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a> working set size <span class="keywordflow">for</span>
00206                             <span class="keyword">this</span> address space.  This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> used
00207                             to ensure that ample physical pages exist
00208                             to create <span class="keyword">this</span> process.
00209 
00210     NewProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process object being created.
00211 
00212     DirectoryTableBase - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created
00213                          address space's Page <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> (PD) page and
00214                          hyper space page.
00215 
00216 Return Value:
00217 
00218     Returns TRUE if an address space was successfully created, FALSE
00219     if ample physical pages do not exist.
00220 
00221 Environment:
00222 
00223     Kernel mode.  APCs Disabled.
00224 
00225 --*/
00226 
00227 {
00228     PFN_NUMBER HyperDirectoryIndex;
00229     PFN_NUMBER PageDirectoryIndex;
00230     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00231     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00232     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00233     PFN_NUMBER HyperSpaceIndex;
00234     PFN_NUMBER PageContainingWorkingSet;
00235     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00236     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00237     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFillPte;
00238     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> CurrentAddressSpacePde;
00239     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00240     KIRQL OldIrql;
00241     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00242     ULONG Color;
00243 <span class="preprocessor">#if defined (_X86PAE_)</span>
00244 <span class="preprocessor"></span>    ULONG TopQuad;
00245     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TopPte;
00246     PPAE_ENTRY PaeVa;
00247     PFN_NUMBER PageDirectoryIndex2;
00248     KIRQL OldIrql2;
00249     ULONG i;
00250     PFN_NUMBER HyperSpaceIndex2;
00251     PVOID PoolBlock;
00252 <span class="preprocessor">#endif</span>
00253 <span class="preprocessor"></span><span class="preprocessor">#if defined(_IA64_)</span>
00254 <span class="preprocessor"></span>    PFN_NUMBER SessionParentIndex;
00255 <span class="preprocessor">#endif</span>
00256 <span class="preprocessor"></span>
00257     <span class="comment">//</span>
00258     <span class="comment">// Get the PFN LOCK to prevent another thread in this</span>
00259     <span class="comment">// process from using hyper space and to get physical pages.</span>
00260     <span class="comment">//</span>
00261 
00262     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
00263 
00264     <span class="comment">//</span>
00265     <span class="comment">// Charge commitment for the page directory pages, working set page table</span>
00266     <span class="comment">// page, and working set list.</span>
00267     <span class="comment">//</span>
00268 
00269     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (MM_PROCESS_COMMIT_CHARGE, NULL) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00270         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00271     }
00272 
00273     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_PROCESS_CREATE, MM_PROCESS_COMMIT_CHARGE);
00274 
00275     NewProcess-&gt;NextPageColor = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d8/d6/ttri_8c.html#a4">RtlRandom</a>(&amp;MmProcessColorSeed));
00276     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;NewProcess-&gt;HyperSpaceLock);
00277 
00278 <span class="preprocessor">#if defined (_X86PAE_)</span>
00279 <span class="preprocessor"></span>    TopQuad = MiPaeAllocate (&amp;PaeVa);
00280     <span class="keywordflow">if</span> (TopQuad == 0) {
00281         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (MM_PROCESS_COMMIT_CHARGE);
00282         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00283     }
00284 
00285     <span class="comment">//</span>
00286     <span class="comment">// This page must be in the first 4GB of RAM.</span>
00287     <span class="comment">//</span>
00288 
00289     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((TopQuad &gt;&gt; PAGE_SHIFT) &lt;= MM_HIGHEST_PAE_PAGE);
00290 <span class="preprocessor">#endif</span>
00291 <span class="preprocessor"></span>
00292     <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (CurrentProcess);
00293 
00294     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00295 
00296     <span class="comment">//</span>
00297     <span class="comment">// Check to make sure the physical pages are available.</span>
00298     <span class="comment">//</span>
00299 
00300     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> &lt;= (SPFN_NUMBER)MinimumWorkingSetSize) {
00301 
00302 <span class="preprocessor">#if defined (_X86PAE_)</span>
00303 <span class="preprocessor"></span>        PoolBlock = MiPaeFree (PaeVa);
00304 <span class="preprocessor">#endif</span>
00305 <span class="preprocessor"></span>
00306         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00307         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
00308         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (MM_PROCESS_COMMIT_CHARGE);
00309         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_PROCESS_CREATE_FAILURE1, MM_PROCESS_COMMIT_CHARGE);
00310 
00311 <span class="preprocessor">#if defined (_X86PAE_)</span>
00312 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PoolBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00313             MiPaeFreeEntirePage (PoolBlock);
00314         }
00315 <span class="preprocessor">#endif</span>
00316 <span class="preprocessor"></span>        <span class="comment">//</span>
00317         <span class="comment">// Indicate no directory base was allocated.</span>
00318         <span class="comment">//</span>
00319 
00320         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00321     }
00322 
00323     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= MinimumWorkingSetSize;
00324     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(6, MinimumWorkingSetSize);
00325     <a class="code" href="../../d8/d5/kddata_8c.html#a33">MmProcessCommit</a> += <a class="code" href="../../d4/d5/procsup_8c.html#a0">MM_PROCESS_COMMIT_CHARGE</a>;
00326 
00327     NewProcess-&gt;AddressSpaceInitialized = 1;
00328     NewProcess-&gt;Vm.MinimumWorkingSetSize = MinimumWorkingSetSize;
00329 
00330     <span class="comment">//</span>
00331     <span class="comment">// Allocate a page directory (parent for 64-bit systems) page.</span>
00332     <span class="comment">//</span>
00333 
00334     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (CurrentProcess, NULL);
00335 
00336     Color =  <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a127">MI_PAGE_COLOR_PTE_PROCESS</a> (PDE_BASE,
00337                                         &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o43">NextPageColor</a>);
00338 
00339     PageDirectoryIndex = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
00340     <span class="keywordflow">if</span> (PageDirectoryIndex == 0) {
00341         PageDirectoryIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
00342         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00343         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageDirectoryIndex, Color);
00344         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00345     }
00346 
00347 <span class="preprocessor">#if defined (_X86PAE_)</span>
00348 <span class="preprocessor"></span>    TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a6">ValidPdePde</a>;
00349     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, 0);
00350 
00351     <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM - 1; i += 1) {
00352 
00353         <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (CurrentProcess, NULL);
00354     
00355         Color =  <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a127">MI_PAGE_COLOR_PTE_PROCESS</a> (PDE_BASE,
00356                                             &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o43">NextPageColor</a>);
00357     
00358         PageDirectoryIndex2 = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
00359         <span class="keywordflow">if</span> (PageDirectoryIndex2 == 0) {
00360             PageDirectoryIndex2 = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
00361             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00362             <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageDirectoryIndex2, Color);
00363             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00364         }
00365 
00366         <span class="comment">//</span>
00367         <span class="comment">// Recursively map each page directory page so it points to itself.</span>
00368         <span class="comment">//</span>
00369 
00370         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageDirectoryIndex2;
00371         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageDirectoryIndex,
00372                                                     &amp;OldIrql2);
00373         PointerPte[i] = TempPte;
00374         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
00375         TopPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = TempPte.u.Long &amp; ~MM_PAE_PDPTE_MASK;
00376         PaeVa-&gt;PteEntry[i].u.Long = TopPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00377     }
00378 
00379     <span class="comment">//</span>
00380     <span class="comment">// Recursively map the topmost page directory page so it points to itself.</span>
00381     <span class="comment">//</span>
00382 
00383     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageDirectoryIndex;
00384     PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageDirectoryIndex, &amp;OldIrql2);
00385     PointerPte[PD_PER_SYSTEM - 1] = TempPte;
00386     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
00387     TopPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = TempPte.u.Long &amp; ~MM_PAE_PDPTE_MASK;
00388     PaeVa-&gt;PteEntry[PD_PER_SYSTEM - 1].u.Long = TopPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00389     NewProcess-&gt;PaePageDirectoryPage = PageDirectoryIndex;
00390     NewProcess-&gt;PaeTop = (PVOID)PaeVa;
00391     DirectoryTableBase[0] = TopQuad;
00392 <span class="preprocessor">#else</span>
00393 <span class="preprocessor"></span>    <a class="code" href="../../d6/d9/mippc_8h.html#a84">INITIALIZE_DIRECTORY_TABLE_BASE</a>(&amp;DirectoryTableBase[0], PageDirectoryIndex);
00394 <span class="preprocessor">#endif</span>
00395 <span class="preprocessor"></span>
00396 <span class="preprocessor">#if defined (_WIN64)</span>
00397 <span class="preprocessor"></span>
00398     PointerPpe = KSEG_ADDRESS (PageDirectoryIndex);
00399     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a6">ValidPdePde</a>;
00400 
00401     <span class="comment">//</span>
00402     <span class="comment">// Map the top level page directory parent page recursively onto itself.</span>
00403     <span class="comment">//</span>
00404 
00405     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageDirectoryIndex;
00406 
00407 <span class="preprocessor">#if defined (_AXP64_)</span>
00408 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.u.Hard.Global == 0);
00409     PointerPpe[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(PDE_TBASE)] = TempPte;
00410 <span class="preprocessor">#endif</span>
00411 <span class="preprocessor"></span>
00412 <span class="preprocessor">#if defined(_IA64_)</span>
00413 <span class="preprocessor"></span>
00414     <span class="comment">//</span>
00415     <span class="comment">// For IA64, the self-mapped entry is forced to be the last entry of</span>
00416     <span class="comment">// PPE table.</span>
00417     <span class="comment">//</span>
00418 
00419     PointerPpe[(PDE_SELFMAP &amp;
00420                 ((<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)*<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>) - 1))/<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)] = TempPte;
00421 
00422 <span class="preprocessor">#endif</span>
00423 <span class="preprocessor"></span>
00424     <span class="comment">//</span>
00425     <span class="comment">// Allocate the page directory for hyper space and map this directory</span>
00426     <span class="comment">// page into the page directory parent page.</span>
00427     <span class="comment">//</span>
00428 
00429     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (CurrentProcess, NULL);
00430 
00431     Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a127">MI_PAGE_COLOR_PTE_PROCESS</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(HYPER_SPACE),
00432                                        &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o43">NextPageColor</a>);
00433 
00434     HyperDirectoryIndex = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
00435     <span class="keywordflow">if</span> (HyperDirectoryIndex == 0) {
00436         HyperDirectoryIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
00437         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00438         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (HyperDirectoryIndex, Color);
00439         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00440     }
00441 
00442     TempPte.u.Hard.PageFrameNumber = HyperDirectoryIndex;
00443     PointerPpe[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(HYPER_SPACE)] = TempPte;
00444 
00445 <span class="preprocessor">#if defined (_IA64_)</span>
00446 <span class="preprocessor"></span>
00447     <span class="comment">//</span>
00448     <span class="comment">// Allocate the page directory parent for the session space</span>
00449     <span class="comment">//</span>
00450 
00451     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (CurrentProcess, NULL);
00452 
00453     Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a127">MI_PAGE_COLOR_PTE_PROCESS</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(SESSION_SPACE_DEFAULT),
00454                                        &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o43">NextPageColor</a>);
00455 
00456     SessionParentIndex = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
00457     <span class="keywordflow">if</span> (SessionParentIndex == 0) {
00458         SessionParentIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
00459         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00460         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (SessionParentIndex, Color);
00461         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00462     }
00463 
00464     <a class="code" href="../../d6/d9/mippc_8h.html#a84">INITIALIZE_DIRECTORY_TABLE_BASE</a>(&amp;NewProcess-&gt;Pcb.SessionParentBase, SessionParentIndex);
00465 
00466     PointerPpe = KSEG_ADDRESS (SessionParentIndex);
00467 
00468     TempPte.u.Hard.PageFrameNumber = SessionParentIndex;
00469 
00470     PointerPpe[(PDE_SSELFMAP &amp;
00471                 ((<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)*<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>) - 1))/<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)] = TempPte;
00472 
00473 <span class="preprocessor">#endif // _IA64_</span>
00474 <span class="preprocessor"></span>
00475 <span class="preprocessor">#endif</span>
00476 <span class="preprocessor"></span>
00477     <span class="comment">//</span>
00478     <span class="comment">// Allocate the hyper space page table page.</span>
00479     <span class="comment">//</span>
00480 
00481     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (CurrentProcess, NULL);
00482 
00483     Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a127">MI_PAGE_COLOR_PTE_PROCESS</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(HYPER_SPACE),
00484                                        &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o43">NextPageColor</a>);
00485 
00486     HyperSpaceIndex = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
00487     <span class="keywordflow">if</span> (HyperSpaceIndex == 0) {
00488         HyperSpaceIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
00489         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00490         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (HyperSpaceIndex, Color);
00491         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00492     }
00493 
00494 <span class="preprocessor">#if defined (_WIN64)</span>
00495 <span class="preprocessor"></span>    PointerPde = KSEG_ADDRESS (HyperDirectoryIndex);
00496     TempPte.u.Hard.PageFrameNumber = HyperSpaceIndex;
00497     PointerPde[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(HYPER_SPACE)] = TempPte;
00498 <span class="preprocessor">#endif</span>
00499 <span class="preprocessor"></span>
00500 <span class="preprocessor">#if defined (_X86PAE_)</span>
00501 <span class="preprocessor"></span>
00502     <span class="comment">//</span>
00503     <span class="comment">// Allocate the second hyper space page table page.</span>
00504     <span class="comment">// Save it in the first PTE used by the first hyperspace PDE.</span>
00505     <span class="comment">//</span>
00506 
00507     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (CurrentProcess, NULL);
00508 
00509     Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a127">MI_PAGE_COLOR_PTE_PROCESS</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(HYPER_SPACE2),
00510                                        &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o43">NextPageColor</a>);
00511 
00512     HyperSpaceIndex2 = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
00513     <span class="keywordflow">if</span> (HyperSpaceIndex2 == 0) {
00514         HyperSpaceIndex2 = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
00515         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00516         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (HyperSpaceIndex2, Color);
00517         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00518     }
00519 
00520     <span class="comment">//</span>
00521     <span class="comment">// Unlike DirectoryTableBase[0], the HyperSpaceIndex is stored as an</span>
00522     <span class="comment">// absolute PFN and does not need to be below 4GB.</span>
00523     <span class="comment">//</span>
00524 
00525     DirectoryTableBase[1] = HyperSpaceIndex;
00526 <span class="preprocessor">#else</span>
00527 <span class="preprocessor"></span>    <a class="code" href="../../d6/d9/mippc_8h.html#a84">INITIALIZE_DIRECTORY_TABLE_BASE</a>(&amp;DirectoryTableBase[1], HyperSpaceIndex);
00528 <span class="preprocessor">#endif</span>
00529 <span class="preprocessor"></span>
00530     <span class="comment">//</span>
00531     <span class="comment">// Remove page for the working set list.</span>
00532     <span class="comment">//</span>
00533 
00534     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (CurrentProcess, NULL);
00535 
00536     Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a128">MI_PAGE_COLOR_VA_PROCESS</a> (MmWorkingSetList,
00537                                       &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o43">NextPageColor</a>);
00538 
00539     PageContainingWorkingSet = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
00540     <span class="keywordflow">if</span> (PageContainingWorkingSet == 0) {
00541         PageContainingWorkingSet = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
00542         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00543         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageContainingWorkingSet, Color);
00544         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00545     }
00546 
00547     <span class="comment">//</span>
00548     <span class="comment">// Release the PFN mutex as the needed pages have been allocated.</span>
00549     <span class="comment">//</span>
00550 
00551     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00552 
00553     NewProcess-&gt;WorkingSetPage = PageContainingWorkingSet;
00554 
00555     <span class="comment">//</span>
00556     <span class="comment">// Initialize the page reserved for hyper space.</span>
00557     <span class="comment">//</span>
00558 
00559     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a123">MI_INITIALIZE_HYPERSPACE_MAP</a> (HyperSpaceIndex);
00560 
00561     <span class="comment">//</span>
00562     <span class="comment">// Set the PTE address in the PFN for the top level page directory page.</span>
00563     <span class="comment">//</span>
00564 
00565 <span class="preprocessor">#if defined (_WIN64)</span>
00566 <span class="preprocessor"></span>
00567     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageDirectoryIndex);
00568 
00569     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == 0);
00570 
00571     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
00572 
00573     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PDE_TBASE);
00574 
00575     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
00576 
00577     <span class="comment">//</span>
00578     <span class="comment">// Set the PTE address in the PFN for the hyper space page directory page.</span>
00579     <span class="comment">//</span>
00580 
00581     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (HyperDirectoryIndex);
00582 
00583     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == 0);
00584 
00585     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
00586 
00587     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(HYPER_SPACE);
00588 
00589     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
00590 
00591 <span class="preprocessor">#if defined (_AXP64_)</span>
00592 <span class="preprocessor"></span>
00593     <span class="comment">//</span>
00594     <span class="comment">// All of the system mappings are global.</span>
00595     <span class="comment">//</span>
00596 
00597     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, 1);
00598 
00599     PointerFillPte = &amp;PointerPpe[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(MM_SYSTEM_SPACE_START)];
00600     CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(MM_SYSTEM_SPACE_START);
00601     RtlCopyMemory (PointerFillPte,
00602                    CurrentAddressSpacePde,
00603                    ((1 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(MM_SYSTEM_SPACE_END) -
00604                       <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(MM_SYSTEM_SPACE_START))) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)));
00605     <span class="comment">//</span>
00606     <span class="comment">// Session space and win32k.sys are local on Hydra configurations.</span>
00607     <span class="comment">// However, as an optimization, it can be made global on non-Hydra.</span>
00608     <span class="comment">//</span>
00609 
00610     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00611         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, 0);
00612     }
00613 
00614     PointerFillPte = &amp;PointerPpe[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(MM_SESSION_SPACE_DEFAULT)];
00615     CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(MM_SESSION_SPACE_DEFAULT);
00616     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerFillPte, *CurrentAddressSpacePde);
00617 
00618 <span class="preprocessor">#endif</span>
00619 <span class="preprocessor"></span>
00620 <span class="preprocessor">#if defined(_IA64_)</span>
00621 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession != 0)) {
00622         PointerPpe = KSEG_ADDRESS(SessionParentIndex);
00623         PointerFillPte = &amp;PointerPpe[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(MM_SESSION_SPACE_DEFAULT)];
00624         CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(MM_SESSION_SPACE_DEFAULT);
00625         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerFillPte, *CurrentAddressSpacePde);
00626     }
00627 <span class="preprocessor">#endif</span>
00628 <span class="preprocessor"></span>
00629 <span class="preprocessor">#else // the following is for !WIN64 only</span>
00630 <span class="preprocessor"></span>
00631 <span class="preprocessor">#if defined (_X86PAE_)</span>
00632 <span class="preprocessor"></span>
00633     <span class="comment">//</span>
00634     <span class="comment">// Stash the second hyperspace PDE in the first PTE for the initial</span>
00635     <span class="comment">// hyperspace entry.</span>
00636     <span class="comment">//</span>
00637 
00638     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a6">ValidPdePde</a>;
00639     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = HyperSpaceIndex2;
00640     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, 0);
00641 
00642     PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (HyperSpaceIndex, &amp;OldIrql2);
00643     PointerPte[0] = TempPte;
00644     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
00645 
00646 <span class="preprocessor">#endif</span>
00647 <span class="preprocessor"></span>
00648     <span class="comment">//</span>
00649     <span class="comment">// Set the PTE address in the PFN for the page directory page.</span>
00650     <span class="comment">//</span>
00651 
00652     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageDirectoryIndex);
00653 
00654     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor == 0);
00655 
00656     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
00657 
00658     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)PDE_BASE;
00659 
00660     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
00661 
00662     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a6">ValidPdePde</a>;
00663     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = HyperSpaceIndex;
00664     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, 0);
00665 
00666     <span class="comment">//</span>
00667     <span class="comment">// Map the page directory page in hyperspace.</span>
00668     <span class="comment">// Note for PAE, this is the high 1GB virtual only.</span>
00669     <span class="comment">//</span>
00670 
00671     PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageDirectoryIndex, &amp;OldIrql);
00672     PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(HYPER_SPACE)] = TempPte;
00673 
00674 <span class="preprocessor">#if defined (_X86PAE_)</span>
00675 <span class="preprocessor"></span>
00676     <span class="comment">//</span>
00677     <span class="comment">// Map in the second hyperspace page directory.</span>
00678     <span class="comment">// The page directory page is already recursively mapped.</span>
00679     <span class="comment">//</span>
00680 
00681     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = HyperSpaceIndex2;
00682     PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(HYPER_SPACE2)] = TempPte;
00683 
00684 <span class="preprocessor">#else</span>
00685 <span class="preprocessor"></span>
00686     <span class="comment">//</span>
00687     <span class="comment">// Recursively map the page directory page so it points to itself.</span>
00688     <span class="comment">//</span>
00689 
00690     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageDirectoryIndex;
00691     PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(PTE_BASE)] = TempPte;
00692 
00693 <span class="preprocessor">#endif</span>
00694 <span class="preprocessor"></span>
00695     <span class="comment">//</span>
00696     <span class="comment">// Map in the non paged portion of the system.</span>
00697     <span class="comment">//</span>
00698 
00699 <span class="preprocessor">#if defined(_ALPHA_)</span>
00700 <span class="preprocessor"></span>
00701     PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MM_SYSTEM_SPACE_START)];
00702     CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MM_SYSTEM_SPACE_START);
00703     RtlCopyMemory (PointerFillPte,
00704                    CurrentAddressSpacePde,
00705                    ((1 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MM_SYSTEM_SPACE_END) -
00706                       <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MM_SYSTEM_SPACE_START))) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)));
00707 
00708     <span class="comment">//</span>
00709     <span class="comment">// KSEG0 is identity-mapped on the Alpha.  Copy the PDEs for this region.</span>
00710     <span class="comment">//</span>
00711 
00712     PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MM_KSEG0_BASE)];
00713     CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MM_KSEG0_BASE);
00714     RtlCopyMemory (PointerFillPte,
00715                    CurrentAddressSpacePde,
00716                    <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(KSEG2_BASE-KSEG0_BASE) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00717 
00718 <span class="preprocessor">#else // the following is for x86 only</span>
00719 <span class="preprocessor"></span>
00720     <span class="comment">//</span>
00721     <span class="comment">// If the system has not been loaded at a biased address, then system PDEs</span>
00722     <span class="comment">// exist in the 2gb-&gt;3gb range which must be copied.</span>
00723     <span class="comment">//</span>
00724 
00725 <span class="preprocessor">#if defined (_X86PAE_)</span>
00726 <span class="preprocessor"></span>
00727     <span class="comment">//</span>
00728     <span class="comment">// For the PAE case, only the last page directory is currently mapped, so</span>
00729     <span class="comment">// only copy the system PDEs for the last 1GB - any that need copying in</span>
00730     <span class="comment">// the 2gb-&gt;3gb range will be done a little later.</span>
00731     <span class="comment">//</span>
00732 
00733     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> != 0) {
00734         PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(CODE_START + MmVirtualBias)];
00735         CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(CODE_START + MmVirtualBias);
00736     
00737         RtlCopyMemory (PointerFillPte,
00738                        CurrentAddressSpacePde,
00739                        (((1 + CODE_END) - CODE_START) / MM_VA_MAPPED_BY_PDE) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00740     }
00741 <span class="preprocessor">#else</span>
00742 <span class="preprocessor"></span>    PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(CODE_START + MmVirtualBias)];
00743     CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(CODE_START + MmVirtualBias);
00744 
00745     RtlCopyMemory (PointerFillPte,
00746                    CurrentAddressSpacePde,
00747                    (((1 + CODE_END) - CODE_START) / MM_VA_MAPPED_BY_PDE) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00748 <span class="preprocessor">#endif</span>
00749 <span class="preprocessor"></span>
00750     LastPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(NON_PAGED_SYSTEM_END)];
00751     PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmNonPagedSystemStart)];
00752     CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MmNonPagedSystemStart);
00753 
00754     RtlCopyMemory (PointerFillPte,
00755                    CurrentAddressSpacePde,
00756                    ((1 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(NON_PAGED_SYSTEM_END) -
00757                       CurrentAddressSpacePde))) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00758 
00759     <span class="comment">//</span>
00760     <span class="comment">// Map in the system cache page table pages.</span>
00761     <span class="comment">//</span>
00762 
00763     LastPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmSystemCacheEnd)];
00764     PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MM_SYSTEM_CACHE_WORKING_SET)];
00765     CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MM_SYSTEM_CACHE_WORKING_SET);
00766 
00767     RtlCopyMemory (PointerFillPte,
00768                    CurrentAddressSpacePde,
00769                    ((1 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MmSystemCacheEnd) -
00770                       CurrentAddressSpacePde))) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00771 
00772 <span class="preprocessor">#if !defined (_X86PAE_)</span>
00773 <span class="preprocessor"></span>    <span class="comment">//</span>
00774     <span class="comment">// Map in any additional system cache page table pages.</span>
00775     <span class="comment">//</span>
00776 
00777     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/data386_8c.html#a30">MiSystemCacheEndExtra</a> != <a class="code" href="../../d8/d5/kddata_8c.html#a12">MmSystemCacheEnd</a>) {
00778         LastPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MiSystemCacheEndExtra)];
00779         PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MiSystemCacheStartExtra)];
00780         CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MiSystemCacheStartExtra);
00781 
00782         RtlCopyMemory (PointerFillPte,
00783                        CurrentAddressSpacePde,
00784                        ((1 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MiSystemCacheEndExtra) -
00785                           CurrentAddressSpacePde))) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00786     }
00787 <span class="preprocessor">#endif</span>
00788 <span class="preprocessor"></span>
00789 <span class="preprocessor">#endif      // end of x86 specific else</span>
00790 <span class="preprocessor"></span>
00791 <span class="preprocessor">#if !defined (_X86PAE_)</span>
00792 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00793 
00794         <span class="comment">//</span>
00795         <span class="comment">// Copy the bootstrap entry for session space.</span>
00796         <span class="comment">// The rest is faulted in as needed.</span>
00797         <span class="comment">//</span>
00798 
00799         PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmSessionSpace)];
00800         CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MmSessionSpace);
00801         <span class="keywordflow">if</span> (CurrentAddressSpacePde-&gt;u.Hard.Valid == 1) {
00802             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerFillPte, *CurrentAddressSpacePde);
00803         }
00804         <span class="keywordflow">else</span> {
00805             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerFillPte, *CurrentAddressSpacePde);
00806         }
00807     }
00808 <span class="preprocessor">#endif</span>
00809 <span class="preprocessor"></span>
00810 <span class="preprocessor">#if defined(_X86_)</span>
00811 <span class="preprocessor"></span>
00812     <span class="comment">//</span>
00813     <span class="comment">// Map in the additional system PTE range if present.</span>
00814     <span class="comment">//</span>
00815 
00816 <span class="preprocessor">#if !defined (_X86PAE_)</span>
00817 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/data386_8c.html#a27">MiNumberOfExtraSystemPdes</a>) {
00818 
00819         PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(KSTACK_POOL_START)];
00820         CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(KSTACK_POOL_START);
00821 
00822         RtlCopyMemory (PointerFillPte,
00823                        CurrentAddressSpacePde,
00824                        MiNumberOfExtraSystemPdes * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00825     }
00826 <span class="preprocessor">#endif</span>
00827 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00828 <span class="preprocessor"></span>
00829     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
00830 
00831 <span class="preprocessor">#if defined (_X86PAE_)</span>
00832 <span class="preprocessor"></span>
00833     <span class="comment">//</span>
00834     <span class="comment">// Map all the virtual space in the 2GB-&gt;3GB range when it's not user space.</span>
00835     <span class="comment">//</span>
00836 
00837     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> == 0) {
00838 
00839         PageDirectoryIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PaeVa-&gt;PteEntry[PD_PER_SYSTEM - 2]);
00840     
00841         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageDirectoryIndex, &amp;OldIrql);
00842     
00843         PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(CODE_START)];
00844         CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(CODE_START);
00845     
00846         RtlCopyMemory (PointerFillPte,
00847                        CurrentAddressSpacePde,
00848                        (((1 + CODE_END) - CODE_START) / MM_VA_MAPPED_BY_PDE) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00849     
00850         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/data386_8c.html#a30">MiSystemCacheEndExtra</a> != <a class="code" href="../../d8/d5/kddata_8c.html#a12">MmSystemCacheEnd</a>) {
00851             LastPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MiSystemCacheEndExtra)];
00852             PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MiSystemCacheStartExtra)];
00853             CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MiSystemCacheStartExtra);
00854     
00855             RtlCopyMemory (PointerFillPte,
00856                            CurrentAddressSpacePde,
00857                            ((1 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MiSystemCacheEndExtra) -
00858                               CurrentAddressSpacePde))) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00859         }
00860     
00861         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00862     
00863             <span class="comment">//</span>
00864             <span class="comment">// Copy the bootstrap entry for session space.</span>
00865             <span class="comment">// The rest is faulted in as needed.</span>
00866             <span class="comment">//</span>
00867     
00868             PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmSessionSpace)];
00869             CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MmSessionSpace);
00870             <span class="keywordflow">if</span> (CurrentAddressSpacePde-&gt;u.Hard.Valid == 1) {
00871                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerFillPte, *CurrentAddressSpacePde);
00872             }
00873             <span class="keywordflow">else</span> {
00874                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerFillPte, *CurrentAddressSpacePde);
00875             }
00876         }
00877     
00878         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/data386_8c.html#a27">MiNumberOfExtraSystemPdes</a>) {
00879     
00880             PointerFillPte = &amp;PointerPte[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(KSTACK_POOL_START)];
00881             CurrentAddressSpacePde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(KSTACK_POOL_START);
00882     
00883             RtlCopyMemory (PointerFillPte,
00884                            CurrentAddressSpacePde,
00885                            MiNumberOfExtraSystemPdes * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00886         }
00887         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
00888     }
00889 <span class="preprocessor">#endif</span>
00890 <span class="preprocessor"></span>
00891 <span class="preprocessor">#endif  // end of !WIN64 specific else</span>
00892 <span class="preprocessor"></span>
00893     <span class="comment">//</span>
00894     <span class="comment">// Up the session space reference count.</span>
00895     <span class="comment">//</span>
00896 
00897     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00898         <a class="code" href="../../d3/d7/session_8c.html#a5">MiSessionAddProcess</a> (NewProcess);
00899     }
00900 
00901     <span class="comment">//</span>
00902     <span class="comment">// Release working set mutex and lower IRQL.</span>
00903     <span class="comment">//</span>
00904 
00905     <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
00906 
00907     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00908 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a240" doxytag="mm.h::MmCreateSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS MmCreateSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>MaximumSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionPageProtection</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocationAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE FileHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> <a class="el" href="../../d1/d9/icmui_8def.html#a0">File</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a222" doxytag="mm.h::MmCreateTeb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PTEB MmCreateTeb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PINITIAL_TEB&nbsp;</td>
          <td class="mdname" nowrap> <em>InitialTeb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCLIENT_ID&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l04314">4314</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d6/d0/mminit_8c-source.html#l00034">BBTBuffer</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00134">InitialTeb</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d4/d5/procsup_8c.html#a20">MiCreatePebOrTeb()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>.
<p>
<pre class="fragment"><div>04322                    :
04323 
04324     This routine creates a TEB page within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process
04325     and copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial TEB values into <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
04326 
04327 Arguments:
04328 
04329     TargetProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process in which to create
04330                     and initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TEB.
04331 
04332     <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial TEB to copy into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04333                  newly created TEB.
04334 
04335 Return Value:
04336 
04337     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created TEB.
04338 
04339     Can raise exceptions <span class="keywordflow">if</span> no address space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TEB or
04340     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user has exceeded quota (non-paged, pagefile, commit).
04341 
04342 Environment:
04343 
04344     Kernel mode.
04345 
04346 --*/
04347 
04348 {
04349     PTEB TebBase;
04350 
04351     <span class="comment">//</span>
04352     <span class="comment">// If the specified process is not the current process, attach</span>
04353     <span class="comment">// to the specified process.</span>
04354     <span class="comment">//</span>
04355 
04356     <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;TargetProcess-&gt;Pcb);
04357 
04358     TebBase = (PTEB)<a class="code" href="../../d4/d5/procsup_8c.html#a20">MiCreatePebOrTeb</a> (TargetProcess,
04359                                       (ULONG)<span class="keyword">sizeof</span>(TEB));
04360 
04361     <span class="comment">//</span>
04362     <span class="comment">// Initialize the TEB.</span>
04363     <span class="comment">//</span>
04364 
04365 <span class="preprocessor">#if defined(_WIN64)</span>
04366 <span class="preprocessor"></span>    TebBase-&gt;NtTib.ExceptionList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04367 <span class="preprocessor">#else</span>
04368 <span class="preprocessor"></span>    TebBase-&gt;NtTib.ExceptionList = EXCEPTION_CHAIN_END;
04369 <span class="preprocessor">#endif</span>
04370 <span class="preprocessor"></span>
04371     TebBase-&gt;NtTib.SubSystemTib = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04372     TebBase-&gt;NtTib.Version = OS2_VERSION;
04373     TebBase-&gt;NtTib.ArbitraryUserPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04374     TebBase-&gt;NtTib.Self = (PNT_TIB)TebBase;
04375     TebBase-&gt;EnvironmentPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04376     TebBase-&gt;ProcessEnvironmentBlock = TargetProcess-&gt;Peb;
04377     TebBase-&gt;ClientId = *ClientId;
04378     TebBase-&gt;RealClientId = *ClientId;
04379 
04380     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb.OldStackBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
04381         (<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb.OldStackLimit == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
04382 
04383         TebBase-&gt;NtTib.StackBase = <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackBase;
04384         TebBase-&gt;NtTib.StackLimit = <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackLimit;
04385         TebBase-&gt;DeallocationStack = <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackAllocationBase;
04386 
04387 <span class="preprocessor">#if defined(_IA64_)</span>
04388 <span class="preprocessor"></span>        TebBase-&gt;BStoreLimit = <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;BStoreLimit;
04389         TebBase-&gt;DeallocationBStore = (PCHAR)<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackBase
04390              + ((ULONG_PTR)<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackBase - (ULONG_PTR)<a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;StackAllocationBase);
04391 <span class="preprocessor">#endif</span>
04392 <span class="preprocessor"></span>
04393     }
04394     <span class="keywordflow">else</span> {
04395         TebBase-&gt;NtTib.StackBase = <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb.OldStackBase;
04396         TebBase-&gt;NtTib.StackLimit = <a class="code" href="../../d2/d1/cttoken_8c.html#a60">InitialTeb</a>-&gt;OldInitialTeb.OldStackLimit;
04397     }
04398 
04399     TebBase-&gt;StaticUnicodeString.Buffer = TebBase-&gt;StaticUnicodeBuffer;
04400     TebBase-&gt;StaticUnicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>( TebBase-&gt;StaticUnicodeBuffer );
04401     TebBase-&gt;StaticUnicodeString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)0;
04402 
04403     <span class="comment">//</span>
04404     <span class="comment">// Used for BBT of ntdll and kernel32.dll.</span>
04405     <span class="comment">//</span>
04406 
04407     TebBase-&gt;ReservedForPerf = <a class="code" href="../../d5/d1/mminit_8c.html#a12">BBTBuffer</a>;
04408 
04409     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
04410     <span class="keywordflow">return</span> TebBase;
04411 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a265" doxytag="mm.h::MmDbgReadCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmDbgReadCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VirtualAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/alpha_2debugsup_8c-source.html#l00027">27</a> of file <a class="el" href="../../d0/d5/alpha_2debugsup_8c-source.html">alpha/debugsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00591">KSEG0_BASE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00593">KSEG2_BASE</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02681">IopWriteDriverList()</a>, <a class="el" href="../../d9/d5/kdmove_8c-source.html#l00031">KdpMoveMemory()</a>, <a class="el" href="../../d4/d4/mips_2kdcpuapi_8c-source.html#l00360">KdpReadIoSpace()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l01126">KdpReadVirtualMemory()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l03328">KdpSearchMemory()</a>, <a class="el" href="../../d8/d9/mips_2dmpstate_8c-source.html#l00059">KeDumpMachineState()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00317">KiDumpParameterImages()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00220">KiPcToFileHeader()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l01207">KiScanBugCheckCallbackList()</a>, and <a class="el" href="../../d1/d5/axp64_2debugsup_8c-source.html#l00335">MmDbgReadCheck64()</a>.
<p>
<pre class="fragment"><div>00033                    :
00034 
00035 
00036     ALPHA implementation specific:
00037 
00038     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid (mapped)
00039     for read access.
00040 
00041 Arguments:
00042 
00043     VirtualAddress - Supplies the virtual address to check.
00044 
00045 Return Value:
00046 
00047     Returns NULL if the address is not valid or readable, otherwise
00048     returns the virtual address.
00049 
00050 Environment:
00051 
00052     Kernel mode IRQL at DISPATCH_LEVEL or greater.
00053 
00054 --*/
00055 
00056 {
00057     <span class="keywordflow">if</span> ((VirtualAddress &gt;= (PVOID)<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a>) &amp;&amp;
00058         (VirtualAddress &lt; (PVOID)<a class="code" href="../../d6/d7/halmips_8h.html#a445">KSEG2_BASE</a>)) {
00059         <span class="keywordflow">return</span> VirtualAddress;
00060     }
00061 
00062     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (VirtualAddress)) {
00063         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00064     }
00065 
00066     <span class="keywordflow">return</span> VirtualAddress;
00067 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a268" doxytag="mm.h::MmDbgReadCheck64" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID64 MmDbgReadCheck64           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID64&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VirtualAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/alpha_2debugsup_8c-source.html#l00246">246</a> of file <a class="el" href="../../d0/d5/alpha_2debugsup_8c-source.html">alpha/debugsup.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l01126">KdpReadVirtualMemory()</a>, and <a class="el" href="../../d9/d2/kdapi_8c-source.html#l01215">KdpReadVirtualMemory64()</a>.
<p>
<pre class="fragment"><div>00252                    :
00253 
00254 
00255     ALPHA implementation specific:
00256 
00257     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid (mapped)
00258     for read access.
00259 
00260     If the address is valid and readable then the called address is returned.
00261 
00262 Arguments:
00263 
00264     VirtualAddress - Supplies the virtual address to check.
00265 
00266 Return Value:
00267 
00268     Returns NULL if the address is not valid or readable, otherwise
00269     returns the virtual address.
00270 
00271 Environment:
00272 
00273     Kernel mode IRQL at DISPATCH_LEVEL or greater.
00274 
00275 --*/
00276 
00277 {
00278 <span class="preprocessor">#ifdef VLM_SUPPORT</span>
00279 <span class="preprocessor"></span>
00280     <span class="keywordflow">if</span> (!MmIsAddressValid64 (VirtualAddress)) {
00281         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00282     }
00283 
00284     <span class="keywordflow">return</span> VirtualAddress;
00285 <span class="preprocessor">#else</span>
00286 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00287 <span class="preprocessor">#endif</span>
00288 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a267" doxytag="mm.h::MmDbgReleaseAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmDbgReleaseAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHARDWARE_PTE&nbsp;</td>
          <td class="mdname" nowrap> <em>Opaque</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/alpha_2debugsup_8c-source.html#l00182">182</a> of file <a class="el" href="../../d0/d5/alpha_2debugsup_8c-source.html">alpha/debugsup.c</a>.
<p>
References <a class="el" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/kdbreak_8c-source.html#l00060">KdpAddBreakpoint()</a>, <a class="el" href="../../d9/d5/kdmove_8c-source.html#l00031">KdpMoveMemory()</a>, <a class="el" href="../../d8/d4/4_2ia64_2kdcpuapi_8c-source.html#l00484">KdpWriteIoSpace()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l01345">KdpWriteVirtualMemory()</a>, and <a class="el" href="../../d1/d3/kdbreak_8c-source.html#l00316">KdSetOwedBreakpoints()</a>.
<p>
<pre class="fragment"><div>00189                    :
00190 
00191     i386/486 implementation specific:
00192 
00193     This routine resets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span> address access permissions
00194     to its original state.
00195 
00196 Arguments:
00197 
00198     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address to check.
00199 
00200     Opaque - Supplies an opaque pointer.
00201 
00202 Return Value:
00203 
00204     None.
00205 
00206 Environment:
00207 
00208     Kernel mode IRQL at <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or greater.
00209 
00210 --*/
00211 
00212 {
00213     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00214     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00215     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> InputPte;
00216 
00217     InputPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)Opaque;
00218 
00219     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmIsAddressValid (VirtualAddress));
00220 
00221     <span class="keywordflow">if</span> (InputPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) {
00222 
00223         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
00224     
00225         TempPte = *InputPte;
00226         
00227         <span class="comment">// LWFIX: Need to make the write go out to memory but can't</span>
00228         <span class="comment">// make it dirty here ! TempPte.u.Hard.Dirty = MM_PTE_DIRTY;</span>
00229     
00230         *PointerPte = TempPte;
00231     
00232         <span class="comment">//</span>
00233         <span class="comment">// BUGBUG John Vert (jvert) 3/4/1999</span>
00234         <span class="comment">//   KeFillEntryTb is liable to IPI the other processors. This is</span>
00235         <span class="comment">//   definitely NOT what we want as the other processors are frozen</span>
00236         <span class="comment">//   in the debugger and we will deadlock if we try and IPI them.</span>
00237         <span class="comment">//   Just flush the current processor instead.</span>
00238         <span class="comment">//KeFillEntryTb ((PHARDWARE_PTE)PointerPte, VirtualAddress, TRUE);</span>
00239         <a class="code" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb</a>(TRUE, VirtualAddress);
00240     }
00241 
00242     <span class="keywordflow">return</span>;
00243 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a270" doxytag="mm.h::MmDbgTranslatePhysicalAddress64" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID64 MmDbgTranslatePhysicalAddress64           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PhysicalAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/alpha_2debugsup_8c-source.html#l00342">342</a> of file <a class="el" href="../../d0/d5/alpha_2debugsup_8c-source.html">alpha/debugsup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00099">MmDebugPte</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00043">MmLowestPhysicalPage</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00038">ValidKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l02643">KdpReadPhysicalMemory()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03787">KdpSearchPhysicalPage()</a>, and <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l02779">KdpWritePhysicalMemory()</a>.
<p>
<pre class="fragment"><div>00348                    :
00349 
00350     ALPHA implementation specific:
00351 
00352     The Alpha processor provides a direct-mapped address space called
00353     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> superpage.  The entire physical address space can be
00354     addressed via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> superpage.  This routine translates a physical
00355     address to its corresponding superpage address.  Unfortunately,
00356     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base superpage address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> processor-dependent.  Therefore, we
00357     have to compute <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor level.  As <span class="keyword">new</span> processors are
00358     released, <span class="keyword">this</span> routine will need to be updated.
00359 
00360     This routine does not use PTEs.
00361 
00362 Arguments:
00363 
00364     PhysicalAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical address to translate.
00365 
00366 Return Value:
00367 
00368     The <span class="keyword">virtual</span> (superpage) address which corresponds to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical address.
00369 
00370 Environment:
00371 
00372     Kernel mode IRQL at <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or greater.
00373 
00374 --*/
00375 
00376 {
00377     <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d9/ke_8h.html#a135">KeProcessorLevel</a>) {
00378 
00379     <span class="keywordflow">case</span> PROCESSOR_ALPHA_21064:
00380     <span class="keywordflow">case</span> PROCESSOR_ALPHA_21066:
00381     <span class="keywordflow">case</span> PROCESSOR_ALPHA_21068:
00382         PhysicalAddress.QuadPart &amp;= 0x00000003ffffffff;
00383         PhysicalAddress.QuadPart |= 0xfffffc0000000000;
00384         <span class="keywordflow">break</span>;
00385 
00386     <span class="keywordflow">case</span> PROCESSOR_ALPHA_21164:
00387     <span class="keywordflow">case</span> PROCESSOR_ALPHA_21164PC:
00388         PhysicalAddress.QuadPart &amp;= 0x000000ffffffffff;
00389         PhysicalAddress.QuadPart |= 0xfffffc0000000000;
00390         <span class="keywordflow">break</span>;
00391 
00392     <span class="keywordflow">case</span> PROCESSOR_ALPHA_21264:
00393         PhysicalAddress.QuadPart &amp;= 0x00000fffffffffff;
00394         PhysicalAddress.QuadPart |= 0xffff800000000000;
00395         <span class="keywordflow">break</span>;
00396 
00397     <span class="keywordflow">default</span>:
00398         <span class="keywordflow">return</span> NULL64;
00399 
00400     }
00401 
00402     <span class="keywordflow">return</span> (PVOID64)PhysicalAddress.QuadPart;
00403 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a266" doxytag="mm.h::MmDbgWriteCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmDbgWriteCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHARDWARE_PTE&nbsp;</td>
          <td class="mdname" nowrap> <em>Opaque</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/alpha_2debugsup_8c-source.html#l00070">70</a> of file <a class="el" href="../../d0/d5/alpha_2debugsup_8c-source.html">alpha/debugsup.c</a>.
<p>
<pre class="fragment"><div>00077                    :
00078 
00079     ALPHA implementation specific:
00080 
00081     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical address <span class="keywordflow">for</span> a <span class="keyword">virtual</span> address
00082     which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid (mapped) for write access.
00083 
00084     If the address is valid and writable and not within KSEG0
00085     the physical address within KSEG0 is returned.  If the address
00086     is within KSEG0 then the called address is returned.
00087 
00088     NOTE: The physical address must only be used while the interrupt
00089     level on ALL processors is above DISPATCH_LEVEL, otherwise the
00090     binding between the virtual address and the physical address can
00091     change due to paging.
00092 
00093 Arguments:
00094 
00095     VirtualAddress - Supplies the virtual address to check.
00096 
00097     Opaque - Supplies a pointer to fill with an opaque value.
00098 
00099 Return Value:
00100 
00101     Returns NULL if the address is not valid or readable, otherwise
00102     returns the physical address of the corresponding virtual address.
00103 
00104 Environment:
00105 
00106     Kernel mode IRQL at DISPATCH_LEVEL or greater.
00107 
00108 --*/
00109 
00110 {
00111     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00112     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00113     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> InputPte;
00114 
00115     InputPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)Opaque;
00116 
00117     InputPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
00118 
00119     <span class="keywordflow">if</span> ((VirtualAddress &gt;= (PVOID)<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a>) &amp;&amp;
00120         (VirtualAddress &lt; (PVOID)<a class="code" href="../../d6/d7/halmips_8h.html#a445">KSEG2_BASE</a>)) {
00121         <span class="keywordflow">return</span> VirtualAddress;
00122     }
00123 
00124     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (VirtualAddress)) {
00125         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00126     }
00127 
00128     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
00129     <span class="keywordflow">if</span> ((VirtualAddress &lt;= MM_HIGHEST_USER_ADDRESS) &amp;&amp;
00130          (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a8">MM_PAGES_IN_KSEG0</a>)) {
00131 
00132         <span class="comment">//</span>
00133         <span class="comment">// User mode - return the physical address.  This prevents</span>
00134         <span class="comment">// copy on write faults for breakpoints on user-mode pages.</span>
00135         <span class="comment">// IGNORE write protection.</span>
00136         <span class="comment">//</span>
00137         <span class="comment">// N.B. - The physical address must be less than 1GB to allow this</span>
00138         <span class="comment">//        short-cut mapping.</span>
00139         <span class="comment">//</span>
00140         <span class="comment">// N.B. - Any non-breakpoint modifications can get lost when the page</span>
00141         <span class="comment">//        is paged out because the PTE is not marked modified when</span>
00142         <span class="comment">//        the access is made through this alternate mapping.</span>
00143         <span class="comment">//</span>
00144 
00145         <span class="keywordflow">return</span> (PVOID)
00146            ((ULONG)<a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a>(VirtualAddress).LowPart + <a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a>);
00147     }
00148 
00149     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 0) {
00150 
00151         <span class="comment">//</span>
00152         <span class="comment">// PTE is not writable, make it so.</span>
00153         <span class="comment">//</span>
00154 
00155         PteContents = *PointerPte;
00156     
00157         *InputPte = PteContents;
00158     
00159         <span class="comment">//</span>
00160         <span class="comment">// Modify the PTE to ensure write permissions.</span>
00161         <span class="comment">//</span>
00162     
00163         PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write = 1;
00164 
00165         *PointerPte = PteContents;
00166     
00167         <span class="comment">//</span>
00168         <span class="comment">// BUGBUG John Vert (jvert) 3/4/1999</span>
00169         <span class="comment">//   KeFillEntryTb is liable to IPI the other processors. This is</span>
00170         <span class="comment">//   definitely NOT what we want as the other processors are frozen</span>
00171         <span class="comment">//   in the debugger and we will deadlock if we try and IPI them.</span>
00172         <span class="comment">//   Just flush the the current processor instead.</span>
00173         <span class="comment">//KeFillEntryTb ((PHARDWARE_PTE)PointerPte, VirtualAddress, TRUE);</span>
00174         <a class="code" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb</a>(TRUE, VirtualAddress);
00175 
00176     }
00177 
00178     <span class="keywordflow">return</span> VirtualAddress;
00179 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a269" doxytag="mm.h::MmDbgWriteCheck64" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID64 MmDbgWriteCheck64           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID64&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VirtualAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/alpha_2debugsup_8c-source.html#l00291">291</a> of file <a class="el" href="../../d0/d5/alpha_2debugsup_8c-source.html">alpha/debugsup.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l01345">KdpWriteVirtualMemory()</a>, and <a class="el" href="../../d9/d2/kdapi_8c-source.html#l01375">KdpWriteVirtualMemory64()</a>.
<p>
<pre class="fragment"><div>00297                    :
00298 
00299     ALPHA implementation specific:
00300 
00301     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical address <span class="keywordflow">for</span> a <span class="keyword">virtual</span> address
00302     which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid (mapped) for write access.
00303 
00304     If the address is valid and writable then the called address is returned.
00305 
00306 Arguments:
00307 
00308     VirtualAddress - Supplies the virtual address to check.
00309 
00310 Return Value:
00311 
00312     Returns NULL if the address is not valid or readable, otherwise
00313     returns the virtual address.
00314 
00315 Environment:
00316 
00317     Kernel mode IRQL at DISPATCH_LEVEL or greater.
00318 
00319 --*/
00320 
00321 {
00322 <span class="preprocessor">#ifdef VLM_SUPPORT</span>
00323 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00324 
00325     <span class="keywordflow">if</span> (!MmIsAddressValid64 (VirtualAddress)) {
00326         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00327     }
00328 
00329     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a154">MiGetPteAddress64</a> (VirtualAddress);
00330 
00331     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 0) {
00332         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00333     }
00334 
00335     <span class="keywordflow">return</span> VirtualAddress;
00336 <span class="preprocessor">#else</span>
00337 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00338 <span class="preprocessor">#endif</span>
00339 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a216" doxytag="mm.h::MmDeleteKernelStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmDeleteKernelStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerKernelStack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LargeStack</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l02723">2723</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02757">MiDecrementShareCountOnly</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04306">MM_DBG_COMMIT_RETURN_KERNEL_STACK_DELETE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00446">MM_STACK_ALIGNMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04798">MmFirstDeadKernelStack</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00096">MmKernelStackPages</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00097">MmKernelStackResident</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00098">MmLargeStacks</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04797">MmMaximumDeadKernelStacks</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04796">MmNumberDeadKernelStacks</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00076">MmProcessCommit</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00099">MmSmallStacks</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02162">PERFINFO_DELETE_STACK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/i386_2allproc_8c-source.html#l00075">KeStartAllProcessors()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03964">PsConvertToGuiThread()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00057">PspReaper()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01438">PspThreadDelete()</a>.
<p>
<pre class="fragment"><div>02730                    :
02731 
02732     This routine deletes a kernel stack and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> no-access page within
02733     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-pagable portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system address space.
02734 
02735 Arguments:
02736 
02737     PointerKernelStack - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel stack.
02738 
02739     LargeStack - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> a large stack <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being deleted.
02740                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> a small stack <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be deleted.
02741 
02742 Return Value:
02743 
02744     None.
02745 
02746 Environment:
02747 
02748     Kernel mode.  APCs Disabled.
02749 
02750 --*/
02751 
02752 {
02753     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02754     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02755     PFN_NUMBER NumberOfPages;
02756     ULONG NumberOfPtes;
02757     PFN_NUMBER PageFrameIndex;
02758     ULONG i;
02759     KIRQL OldIrql;
02760     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
02761 
02762     <span class="keywordflow">if</span> (LargeStack) {
02763 <span class="preprocessor">#if defined(_IA64_)</span>
02764 <span class="preprocessor"></span>        NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_LARGE_STACK_SIZE + KERNEL_LARGE_BSTORE_SIZE);
02765 <span class="preprocessor">#else</span>
02766 <span class="preprocessor"></span>        NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_LARGE_STACK_SIZE);
02767 <span class="preprocessor">#endif</span>
02768 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
02769 <span class="preprocessor">#if defined(_IA64_)</span>
02770 <span class="preprocessor"></span>        NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_STACK_SIZE + KERNEL_BSTORE_SIZE);
02771 <span class="preprocessor">#else</span>
02772 <span class="preprocessor"></span>        NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (KERNEL_STACK_SIZE);
02773 <span class="preprocessor">#endif</span>
02774 <span class="preprocessor"></span>    }
02775 
02776     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerKernelStack);
02777 
02778     <span class="comment">//</span>
02779     <span class="comment">// PointerPte points to the guard page, point to the previous</span>
02780     <span class="comment">// page before removing physical pages.</span>
02781     <span class="comment">//</span>
02782 
02783     PointerPte -= 1;
02784 
02785     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02786 
02787     <span class="comment">//</span>
02788     <span class="comment">// Check to see if the stack page should be placed on the dead</span>
02789     <span class="comment">// kernel stack page list.  The dead kernel stack list is a</span>
02790     <span class="comment">// singly linked list of kernel stacks from terminated threads.</span>
02791     <span class="comment">// The stacks are saved on a linked list up to a maximum number</span>
02792     <span class="comment">// to avoid the overhead of flushing the entire TB on all processors</span>
02793     <span class="comment">// everytime a thread terminates.  The TB on all processors must</span>
02794     <span class="comment">// be flushed as kernel stacks reside in the non paged system part</span>
02795     <span class="comment">// of the address space.</span>
02796     <span class="comment">//</span>
02797 
02798     <span class="keywordflow">if</span> ((!LargeStack) &amp;&amp;
02799         (<a class="code" href="../../d4/d8/mi_8h.html#a668">MmNumberDeadKernelStacks</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a669">MmMaximumDeadKernelStacks</a>)) {
02800 
02801         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02802 
02803 <span class="preprocessor">#if DBG</span>
02804 <span class="preprocessor"></span>        {
02805             ULONG i = <a class="code" href="../../d4/d8/mi_8h.html#a668">MmNumberDeadKernelStacks</a>;
02806             <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnList = <a class="code" href="../../d4/d8/mi_8h.html#a670">MmFirstDeadKernelStack</a>;
02807 
02808             <span class="keywordflow">while</span> (i &gt; 0) {
02809                 i--;
02810                 <span class="keywordflow">if</span> ((PfnList != MmKstacks[i].Pfn) ||
02811                    (PfnList-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> != MmKstacks[i].Pte))  {
02812                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MMPROCSUP: kstacks %p %ld. %p\n"</span>,
02813                        PfnList, i, MmKstacks[i].Pfn);
02814                    DbgBreakPoint();
02815                 }
02816                 PfnList = PfnList-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.NextStackPfn;
02817             }
02818             MmKstacks[<a class="code" href="../../d4/d8/mi_8h.html#a668">MmNumberDeadKernelStacks</a>].Pte = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
02819             MmKstacks[<a class="code" href="../../d4/d8/mi_8h.html#a668">MmNumberDeadKernelStacks</a>].Pfn = Pfn1;
02820         }
02821 <span class="preprocessor">#endif //DBG</span>
02822 <span class="preprocessor"></span>
02823         <a class="code" href="../../d4/d8/mi_8h.html#a668">MmNumberDeadKernelStacks</a> += 1;
02824         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.NextStackPfn = <a class="code" href="../../d4/d8/mi_8h.html#a670">MmFirstDeadKernelStack</a>;
02825         <a class="code" href="../../d4/d8/mi_8h.html#a670">MmFirstDeadKernelStack</a> = Pfn1;
02826 
02827         <a class="code" href="../../d2/d1/mm_8h.html#a41">PERFINFO_DELETE_STACK</a>(PointerPte, NumberOfPtes);
02828 
02829         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02830 
02831         <span class="keywordflow">return</span>;
02832     }
02833 
02834 <span class="preprocessor">#if defined(_IA64_)</span>
02835 <span class="preprocessor"></span>
02836     <span class="comment">//</span>
02837     <span class="comment">// Since PointerKernelStack points to the center of the stack space,</span>
02838     <span class="comment">// the size of kernel backing store needs to be added to get the</span>
02839     <span class="comment">// top of the stack space.</span>
02840     <span class="comment">//</span>
02841 
02842     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (LargeStack ?
02843                   (PCHAR)PointerKernelStack+KERNEL_LARGE_BSTORE_SIZE :
02844                   (PCHAR)PointerKernelStack+KERNEL_BSTORE_SIZE);
02845 
02846     <span class="comment">//</span>
02847     <span class="comment">// PointerPte points to the guard page, point to the previous</span>
02848     <span class="comment">// page before removing physical pages.</span>
02849     <span class="comment">//</span>
02850 
02851     PointerPte -= 1;
02852 
02853 <span class="preprocessor">#endif</span>
02854 <span class="preprocessor"></span>
02855     <span class="comment">//</span>
02856     <span class="comment">// We have exceeded the limit of dead kernel stacks or this is a large</span>
02857     <span class="comment">// stack, delete this kernel stack.</span>
02858     <span class="comment">//</span>
02859 
02860     NumberOfPages = 0;
02861     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfPtes; i += 1) {
02862 
02863         PteContents = *PointerPte;
02864 
02865         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
02866             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PteContents);
02867             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02868             <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
02869 
02870             <span class="comment">//</span>
02871             <span class="comment">// Set the pointer to PTE as empty so the page</span>
02872             <span class="comment">// is deleted when the reference count goes to zero.</span>
02873             <span class="comment">//</span>
02874 
02875             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
02876             <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (MI_GET_PAGE_FRAME_FROM_PTE (&amp;PteContents));
02877             NumberOfPages += 1;
02878         }
02879         PointerPte -= 1;
02880     }
02881 
02882 <span class="preprocessor">#if defined(_IA64_)</span>
02883 <span class="preprocessor"></span>    <a class="code" href="../../d4/d5/procsup_8c.html#a10">MmKernelStackPages</a>  -= NumberOfPtes + 2 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a100">MM_STACK_ALIGNMENT</a>?1:0);
02884 
02885     <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte,
02886                          NumberOfPtes + 2 + (MM_STACK_ALIGNMENT?1:0),
02887                          SystemPteSpace);
02888 <span class="preprocessor">#else</span>
02889 <span class="preprocessor"></span>    <a class="code" href="../../d4/d5/procsup_8c.html#a10">MmKernelStackPages</a>  -= NumberOfPtes + 1 + (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a100">MM_STACK_ALIGNMENT</a>?1:0);
02890 
02891     <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte,
02892                          NumberOfPtes + 1 + (MM_STACK_ALIGNMENT?1:0),
02893                          SystemPteSpace);
02894 <span class="preprocessor">#endif</span>
02895 <span class="preprocessor"></span>
02896     <span class="comment">//</span>
02897     <span class="comment">// Update the count of available resident pages.</span>
02898     <span class="comment">//</span>
02899 
02900     <a class="code" href="../../d4/d5/procsup_8c.html#a11">MmKernelStackResident</a> -= NumberOfPages;
02901     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += NumberOfPages;
02902     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(10, NumberOfPages);
02903     <a class="code" href="../../d8/d5/kddata_8c.html#a33">MmProcessCommit</a> -= NumberOfPtes;
02904 
02905     <a class="code" href="../../d4/d5/procsup_8c.html#a12">MmLargeStacks</a> -= LargeStack;
02906     <a class="code" href="../../d4/d5/procsup_8c.html#a13">MmSmallStacks</a> -= !LargeStack;
02907     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02908 
02909     <span class="comment">//</span>
02910     <span class="comment">// Return commitment.</span>
02911     <span class="comment">//</span>
02912 
02913     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (NumberOfPtes);
02914     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_KERNEL_STACK_DELETE, NumberOfPtes);
02915 
02916     <span class="keywordflow">return</span>;
02917 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a211" doxytag="mm.h::MmDeleteProcessAddressSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmDeleteProcessAddressSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l01398">1398</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00349">HYPER_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05898">MI_GET_DIRECTORY_FRAME_FROM_PROCESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01864">MiContractPagingFiles()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02757">MiDecrementShareCountOnly</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01698">MiGetPpeOffset</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04302">MM_DBG_COMMIT_RETURN_PROCESS_DELETE</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00042">MM_PROCESS_COMMIT_CHARGE</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00043">MM_PROCESS_CREATE_CHARGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00076">MmProcessCommit</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l01363">PspProcessDelete()</a>.
<p>
<pre class="fragment"><div>01404                    :
01405 
01406     This routine deletes a process's Page <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> and working set page.
01407 
01408 Arguments:
01409 
01410     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> deleted process.
01411 
01412 Return Value:
01413 
01414     None.
01415 
01416 Environment:
01417 
01418     Kernel mode.  APCs Disabled.
01419 
01420 --*/
01421 
01422 {
01423     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01424     KIRQL OldIrql;
01425     PFN_NUMBER PageFrameIndex;
01426     PFN_NUMBER PageFrameIndex2;
01427 <span class="preprocessor">#if defined (_WIN64)</span>
01428 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PageDirectoryParent;
01429     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Ppe;
01430 <span class="preprocessor">#endif</span>
01431 <span class="preprocessor"></span><span class="preprocessor">#if defined (_X86PAE_)</span>
01432 <span class="preprocessor"></span>    ULONG i;
01433     KIRQL OldIrql2;
01434     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01435     PVOID PoolBlock;
01436     PFN_NUMBER PageDirectories[PD_PER_SYSTEM];
01437 
01438     PoolBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01439 <span class="preprocessor">#endif</span>
01440 <span class="preprocessor"></span>
01441     <span class="comment">//</span>
01442     <span class="comment">// Return commitment.</span>
01443     <span class="comment">//</span>
01444 
01445     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (MM_PROCESS_COMMIT_CHARGE);
01446     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_PROCESS_DELETE, MM_PROCESS_COMMIT_CHARGE);
01447     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process-&gt;CommitCharge == 0);
01448 
01449     <span class="comment">//</span>
01450     <span class="comment">// Remove the working set list page from the deleted process.</span>
01451     <span class="comment">//</span>
01452 
01453     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Process-&gt;WorkingSetPage);
01454 
01455     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01456     <a class="code" href="../../d8/d5/kddata_8c.html#a33">MmProcessCommit</a> -= <a class="code" href="../../d4/d5/procsup_8c.html#a0">MM_PROCESS_COMMIT_CHARGE</a>;
01457 
01458     <span class="keywordflow">if</span> (Process-&gt;AddressSpaceInitialized == 2) {
01459 
01460         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01461 
01462         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01463         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (Process-&gt;WorkingSetPage);
01464 
01465         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) || (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress));
01466 
01467         <span class="comment">//</span>
01468         <span class="comment">// Remove the hyper space page table page from the deleted process.</span>
01469         <span class="comment">//</span>
01470 
01471 <span class="preprocessor">#if defined (_X86PAE_)</span>
01472 <span class="preprocessor"></span>
01473         PageFrameIndex = (PFN_NUMBER)Process-&gt;Pcb.DirectoryTableBase[1];
01474         <span class="comment">//</span>
01475         <span class="comment">// Remove the second hyper space page table page.</span>
01476         <span class="comment">//</span>
01477 
01478         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageFrameIndex, &amp;OldIrql2);
01479         PageFrameIndex2 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPte);
01480         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
01481 
01482         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex2);
01483 
01484         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01485 
01486         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01487         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex2);
01488 
01489         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) || (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress));
01490 <span class="preprocessor">#else</span>
01491 <span class="preprocessor"></span>        PageFrameIndex =
01492             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(&amp;(Process-&gt;Pcb.DirectoryTableBase[1])));
01493 <span class="preprocessor">#endif</span>
01494 <span class="preprocessor"></span>
01495         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01496 
01497         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01498 
01499         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01500         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
01501         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) || (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress));
01502 
01503         <span class="comment">//</span>
01504         <span class="comment">// Remove the page directory page.</span>
01505         <span class="comment">//</span>
01506 
01507         PageFrameIndex = <a class="code" href="../../d4/d8/mi_8h.html#a410">MI_GET_DIRECTORY_FRAME_FROM_PROCESS</a>(Process);
01508 
01509 <span class="preprocessor">#if defined (_X86PAE_)</span>
01510 <span class="preprocessor"></span>
01511         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageFrameIndex, &amp;OldIrql2);
01512         <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM - 1; i += 1) {
01513             PageDirectories[i] = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(&amp;PointerPte[i]);
01514         }
01515         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
01516 
01517         <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM - 1; i += 1) {
01518             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageDirectories[i]);
01519     
01520             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01521     
01522             <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (PageDirectories[i]);
01523             <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01524     
01525             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) || (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress));
01526         }
01527 <span class="preprocessor">#endif</span>
01528 <span class="preprocessor"></span>
01529 <span class="preprocessor">#if defined (_WIN64)</span>
01530 <span class="preprocessor"></span>
01531         <span class="comment">//</span>
01532         <span class="comment">// Get a pointer to the top-level page directory parent page via</span>
01533         <span class="comment">// its KSEG0 address.</span>
01534         <span class="comment">//</span>
01535 
01536         PageDirectoryParent = KSEG_ADDRESS (PageFrameIndex);
01537 
01538         <span class="comment">//</span>
01539         <span class="comment">// Remove the hyper space page directory page from the deleted process.</span>
01540         <span class="comment">//</span>
01541 
01542         Ppe = &amp;PageDirectoryParent[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(HYPER_SPACE)];
01543         PageFrameIndex2 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(Ppe);
01544         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex2);
01545 
01546         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01547         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01548         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex2);
01549         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) || (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress));
01550 <span class="preprocessor">#endif</span>
01551 <span class="preprocessor"></span>
01552         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01553 
01554         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01555 
01556         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (PageFrameIndex);
01557 
01558         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
01559 
01560         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) || (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress));
01561 
01562 <span class="preprocessor">#if defined (_X86PAE_)</span>
01563 <span class="preprocessor"></span>
01564         <span class="comment">//</span>
01565         <span class="comment">// Free the page directory page pointers.</span>
01566         <span class="comment">//</span>
01567 
01568         PoolBlock = MiPaeFree ((PPAE_ENTRY)Process-&gt;PaeTop);
01569 <span class="preprocessor">#endif</span>
01570 <span class="preprocessor"></span>
01571 <span class="preprocessor">#if defined(_IA64_)</span>
01572 <span class="preprocessor"></span>
01573         <span class="comment">//</span>
01574         <span class="comment">// Free the session space page directory parent page </span>
01575         <span class="comment">//</span>
01576 
01577         PageFrameIndex = 
01578             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(&amp;(Process-&gt;Pcb.SessionParentBase)));
01579 
01580         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01581         
01582         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01583 
01584         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01585 
01586         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
01587 
01588         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) || (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress));
01589 
01590 <span class="preprocessor">#endif</span>
01591 <span class="preprocessor"></span>
01592     } <span class="keywordflow">else</span> {
01593 
01594         <span class="comment">//</span>
01595         <span class="comment">// Process initialization never completed, just return the pages</span>
01596         <span class="comment">// to the free list.</span>
01597         <span class="comment">//</span>
01598 
01599         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
01600                             Process-&gt;WorkingSetPage);
01601 
01602 <span class="preprocessor">#if defined (_WIN64)</span>
01603 <span class="preprocessor"></span>
01604         <span class="comment">//</span>
01605         <span class="comment">// Get a pointer to the top-level page directory parent page via</span>
01606         <span class="comment">// its KSEG0 address.</span>
01607         <span class="comment">//</span>
01608 
01609         PageFrameIndex =
01610             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(&amp;(Process-&gt;Pcb.DirectoryTableBase[0])));
01611 
01612         PageDirectoryParent = KSEG_ADDRESS (PageFrameIndex);
01613 
01614         Ppe = &amp;PageDirectoryParent[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(HYPER_SPACE)];
01615         PageFrameIndex2 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(Ppe);
01616 
01617         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
01618                             PageFrameIndex2);
01619 <span class="preprocessor">#endif</span>
01620 <span class="preprocessor"></span>
01621 <span class="preprocessor">#if defined (_X86PAE_)</span>
01622 <span class="preprocessor"></span>        PageFrameIndex = <a class="code" href="../../d4/d8/mi_8h.html#a410">MI_GET_DIRECTORY_FRAME_FROM_PROCESS</a>(Process);
01623 
01624         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageFrameIndex, &amp;OldIrql2);
01625         <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM - 1; i += 1) {
01626             PageDirectories[i] = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(&amp;PointerPte[i]);
01627         }
01628         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
01629 
01630         <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM - 1; i += 1) {
01631             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
01632                                 PageDirectories[i]);
01633         }
01634 
01635         <span class="comment">//</span>
01636         <span class="comment">// Free the second hyper space page table page.</span>
01637         <span class="comment">//</span>
01638 
01639         PageFrameIndex = (PFN_NUMBER)Process-&gt;Pcb.DirectoryTableBase[1];
01640 
01641         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PageFrameIndex, &amp;OldIrql2);
01642         PageFrameIndex2 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>(PointerPte);
01643         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
01644         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList], PageFrameIndex2);
01645 
01646         <span class="comment">//</span>
01647         <span class="comment">// Free the first hyper space page table page.</span>
01648         <span class="comment">//</span>
01649 
01650         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
01651                             (PFN_NUMBER)Process-&gt;Pcb.DirectoryTableBase[1]);
01652 
01653         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
01654             <a class="code" href="../../d4/d8/mi_8h.html#a410">MI_GET_DIRECTORY_FRAME_FROM_PROCESS</a>(Process));
01655 
01656         <span class="comment">//</span>
01657         <span class="comment">// Free the page directory page pointers.</span>
01658         <span class="comment">//</span>
01659 
01660         PoolBlock = MiPaeFree ((PPAE_ENTRY)Process-&gt;PaeTop);
01661 <span class="preprocessor">#else</span>
01662 <span class="preprocessor"></span>
01663         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
01664             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(&amp;(Process-&gt;Pcb.DirectoryTableBase[1]))));
01665 
01666         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
01667             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(&amp;(Process-&gt;Pcb.DirectoryTableBase[0]))));
01668 <span class="preprocessor">#endif</span>
01669 <span class="preprocessor"></span><span class="preprocessor">#if defined(_IA64_)</span>
01670 <span class="preprocessor"></span>        <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList], Process-&gt;Pcb.SessionParentBase);
01671 <span class="preprocessor">#endif</span>
01672 <span class="preprocessor"></span>    }
01673 
01674     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += <a class="code" href="../../d4/d5/procsup_8c.html#a1">MM_PROCESS_CREATE_CHARGE</a>;
01675     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(7, MM_PROCESS_CREATE_CHARGE);
01676 
01677     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01678 
01679 <span class="preprocessor">#if defined (_X86PAE_)</span>
01680 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PoolBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01681         MiPaeFreeEntirePage (PoolBlock);
01682     }
01683 <span class="preprocessor">#endif</span>
01684 <span class="preprocessor"></span>
01685     <span class="comment">//</span>
01686     <span class="comment">// Check to see if the paging files should be contracted.</span>
01687     <span class="comment">//</span>
01688 
01689     <a class="code" href="../../d6/d3/modwrite_8c.html#a47">MiContractPagingFiles</a> ();
01690 
01691     <span class="keywordflow">return</span>;
01692 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a224" doxytag="mm.h::MmDeleteTeb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmDeleteTeb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>TebBase</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l04843">4843</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02380">_MMSECURE_ENTRY::List</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01093">LOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d4/d5/procsup_8c.html#a23">MiDeleteFreeVm()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00380">MiLocateAddress()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00256">MiRemoveVad()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o13">_MMVAD::u2</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o16">_MMVAD::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.
<p>
<pre class="fragment"><div>04850                    :
04851 
04852     This routine deletes a TEB page within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process.
04853 
04854 Arguments:
04855 
04856     TargetProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process in which to <span class="keyword">delete</span>
04857         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TEB.
04858 
04859     TebBase - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TEB to <span class="keyword">delete</span>.
04860 
04861 Return Value:
04862 
04863     None.
04864 
04865 Environment:
04866 
04867     Kernel mode.
04868 
04869 --*/
04870 
04871 {
04872     PVOID EndingAddress;
04873     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
04874     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04875     <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a> Secure;
04876 
04877     EndingAddress = ((PCHAR)TebBase +
04878                                 <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (<span class="keyword">sizeof</span>(TEB)) - 1);
04879 
04880     <span class="comment">//</span>
04881     <span class="comment">// Attach to the specified process.</span>
04882     <span class="comment">//</span>
04883 
04884     <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;TargetProcess-&gt;Pcb);
04885 
04886     <span class="comment">//</span>
04887     <span class="comment">// Get the address creation mutex to block multiple threads from</span>
04888     <span class="comment">// creating or deleting address space at the same time and</span>
04889     <span class="comment">// get the working set mutex so virtual address descriptors can</span>
04890     <span class="comment">// be inserted and walked.</span>
04891     <span class="comment">//</span>
04892 
04893     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (TargetProcess);
04894 
04895     Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (TebBase);
04896 
04897     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)NULL);
04898 
04899     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> == <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (TebBase)) &amp;&amp;
04900             (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> == <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress)));
04901 
04902     <span class="comment">//</span>
04903     <span class="comment">// If someone has secured the TEB (in addition to the standard securing</span>
04904     <span class="comment">// that was done by memory management on creation, then don't delete it</span>
04905     <span class="comment">// now - just leave it around until the entire process is deleted.</span>
04906     <span class="comment">//</span>
04907 
04908     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange == 1);
04909     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured) {
04910         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04911     }
04912     <span class="keywordflow">else</span> {
04913         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured);
04914         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (IsListEmpty (&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List) == 0);
04915 
04916         <span class="comment">//</span>
04917         <span class="comment">// If there's only one entry, then that's the one we defined when we</span>
04918         <span class="comment">// initially created the TEB.  So TEB deletion can take place right</span>
04919         <span class="comment">// now.  If there's more than one entry, let the TEB sit around until</span>
04920         <span class="comment">// the process goes away.</span>
04921         <span class="comment">//</span>
04922 
04923         Secure = CONTAINING_RECORD (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List.Flink,
04924                                     <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">MMSECURE_ENTRY</a>,
04925                                     List);
04926 
04927         <span class="keywordflow">if</span> (Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">List</a>.Flink == &amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List) {
04928             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04929         }
04930         <span class="keywordflow">else</span> {
04931             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_FOUND;
04932         }
04933     }
04934 
04935     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
04936 
04937         <a class="code" href="../../d6/d3/vadtree_8c.html#a1">MiRemoveVad</a> (Vad);
04938         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
04939 
04940         <a class="code" href="../../d4/d5/procsup_8c.html#a23">MiDeleteFreeVm</a> (TebBase, EndingAddress);
04941     }
04942 
04943     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (TargetProcess);
04944     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
04945 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a206" doxytag="mm.h::MmDeterminePoolType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> MmDeterminePoolType           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VirtualAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00437">437</a> of file <a class="el" href="../../d2/d5/allocpag_8c-source.html">allocpag.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l05290">MI_IS_SESSION_POOL_ADDRESS</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00068">MmPagedPoolEnd</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00067">MmPagedPoolStart</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a182">PagedPoolSession</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/poolhack_8c-source.html#l01400">CheckPool()</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00970">ExFreePool()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03892">ExFreePoolSanityChecks()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00172">ExInitializeResource()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00209">ExInitializeResourceLite()</a>, and <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00273">ExReinitializeResourceLite()</a>.
<p>
<pre class="fragment"><div>00443                    :
00444 
00445     This function determines which <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> a <span class="keyword">virtual</span> address resides within.
00446 
00447 Arguments:
00448 
00449     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address to determine which <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
00450                      <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> resides within.
00451 
00452 Return Value:
00453 
00454     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> (PagedPool, NonPagedPool, PagedPoolSession or
00455             NonPagedPoolSession), <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> never returns any information about
00456             MustSucceed <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> types.
00457 
00458 Environment:
00459 
00460     Kernel Mode Only.
00461 
00462 --*/
00463 
00464 {
00465     <span class="keywordflow">if</span> ((VirtualAddress &gt;= <a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>) &amp;&amp;
00466         (VirtualAddress &lt;= <a class="code" href="../../d8/d5/kddata_8c.html#a26">MmPagedPoolEnd</a>)) {
00467         <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
00468     }
00469 
00470     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a353">MI_IS_SESSION_POOL_ADDRESS</a> (VirtualAddress) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00471         <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a329a182">PagedPoolSession</a>;
00472     }
00473 
00474     <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
00475 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a259" doxytag="mm.h::MmDisableModifiedWriteOfSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmDisableModifiedWriteOfSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SectionObjectPointer</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04397">4397</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02062">_CONTROL_AREA::NumberOfMappedViews</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l00387">CcInitializeCacheMap()</a>.
<p>
<pre class="fragment"><div>04403                    :
04404 
04405     This function disables page writing by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified page writer <span class="keywordflow">for</span>
04406     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mapped by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object pointer.
04407 
04408     This should <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be used <span class="keywordflow">for</span> files which CANNOT be mapped by user
04409     programs, e.g., volume files, directory files, etc.
04410 
04411 Arguments:
04412 
04413     SectionObjectPointer - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section objects
04414 
04415 
04416 Return Value:
04417 
04418     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was a success, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> either
04419     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no section or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section already has a view.
04420 
04421 --*/
04422 
04423 {
04424     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
04425     KIRQL OldIrql;
04426     BOOLEAN state = 1;
04427 
04428     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04429 
04430     ControlArea = ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(SectionObjectPointer-&gt;DataSectionObject));
04431 
04432     <span class="keywordflow">if</span> (ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04433         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> == 0) {
04434 
04435             <span class="comment">//</span>
04436             <span class="comment">// There are no views to this section, indicate no modified</span>
04437             <span class="comment">// page writing is allowed.</span>
04438             <span class="comment">//</span>
04439 
04440             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoModifiedWriting = 1;
04441         } <span class="keywordflow">else</span> {
04442 
04443             <span class="comment">//</span>
04444             <span class="comment">// Return the current modified page writing state.</span>
04445             <span class="comment">//</span>
04446 
04447             state = (BOOLEAN)ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoModifiedWriting;
04448         }
04449     } <span class="keywordflow">else</span> {
04450 
04451         <span class="comment">//</span>
04452         <span class="comment">// This file no longer has an associated segment.</span>
04453         <span class="comment">//</span>
04454 
04455         state = 0;
04456     }
04457 
04458     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04459     <span class="keywordflow">return</span> state;
04460 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a197" doxytag="mm.h::MmDispatchWin32Callout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmDispatchWin32Callout           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d1/mm_8h.html#a146">PKWIN32_CALLOUT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Function</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/mm_8h.html#a146">PKWIN32_CALLOUT</a> WorkerCallback&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Arg</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG SessionId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07330">IopNotifyDeviceClassChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l06858">IopNotifyHwProfileChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08162">IopNotifySetupDeviceArrival()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07055">IopNotifyTargetDeviceChange()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l07495">IoRegisterPlugPlayNotification()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00266">NtAssignProcessToJobObject()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>, and <a class="el" href="../../d2/d0/psjob_8c-source.html#l00636">PspJobDelete()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a189" doxytag="mm.h::MmEnablePAT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmEnablePAT           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d3/pat_8c-source.html#l00119">KiInitializePAT()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a194" doxytag="mm.h::MmEnforceWorkingSetLimit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MmEnforceWorkingSetLimit           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WsInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LOGICAL&nbsp;</td>
          <td class="mdname" nowrap> <em>Enable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d9/wslist_8c-source.html#l00543">543</a> of file <a class="el" href="../../d5/d9/wslist_8c-source.html">wslist.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01039">LOCK_WS</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01081">UNLOCK_WS</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l00439">PspAddProcessToJob()</a>, and <a class="el" href="../../d2/d0/psjob_8c-source.html#l02262">PspApplyJobLimitsToProcess()</a>.
<p>
<pre class="fragment"><div>00550                    :
00551 
00552     This function enables hard enforcement of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set maximum <span class="keywordflow">for</span>
00553     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified WsInfo.
00554 
00555 Arguments:
00556 
00557     WsInfo - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set info pointer.
00558 
00559     Enable - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> enabling hard enforcement, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
00560 
00561 Return Value:
00562 
00563     The previous state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set enforcement.
00564 
00565 Environment:
00566 
00567     Kernel mode, APCs disabled.  The working set lock must NOT be held.
00568     The caller guarantees that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target WsInfo cannot go away.
00569 
00570 --*/
00571 
00572 {
00573     KIRQL OldIrql;
00574 
00575     LOGICAL PreviousWorkingSetEnforcement;
00576 
00577     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00578 
00579     PreviousWorkingSetEnforcement = WsInfo-&gt;u.Flags.WorkingSetHard;
00580 
00581     WsInfo-&gt;u.Flags.WorkingSetHard = Enable;
00582 
00583     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00584 
00585 <span class="preprocessor">#if 0</span>
00586 <span class="preprocessor"></span>
00587     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00588 
00589     <span class="comment">//</span>
00590     <span class="comment">// Get the working set lock and disable APCs.</span>
00591     <span class="comment">// The working set could be trimmed at this point if it is excessive.</span>
00592     <span class="comment">//</span>
00593     <span class="comment">// The working set lock cannot be acquired at this point without updating</span>
00594     <span class="comment">// ps in order to avoid deadlock.</span>
00595     <span class="comment">//</span>
00596 
00597     <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
00598         <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrql2);
00599         <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql2);
00600     }
00601     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WsInfo-&gt;u.Flags.SessionSpace == 0) {
00602         CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
00603         <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (CurrentProcess);
00604 
00605         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
00606     }
00607 <span class="preprocessor">#endif</span>
00608 <span class="preprocessor"></span>
00609     <span class="keywordflow">return</span> PreviousWorkingSetEnforcement;
00610 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a249" doxytag="mm.h::MmExtendSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmExtendSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionToExtend</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>NewSectionSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreFileSizeChecking</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/extsect_8c-source.html#l00201">201</a> of file <a class="el" href="../../d9/d9/extsect_8c-source.html">extsect.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01996">_MMEXTEND_INFO::CommittedSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02001">_SEGMENT::ControlArea</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02114">_SUBSECTION::ControlArea</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02059">_CONTROL_AREA::DereferenceList</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00263">EX_REAL_POOL_USAGE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02012">_SEGMENT::ExtendInfo</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02070">_CONTROL_AREA::FilePointer</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02691">FsRtlGetFileSize()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02864">FsRtlSetFileSize()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02161">Mi4KStartForSubsection</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02190">Mi4KStartFromSubsection</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02412">MI_GET_PROTECTION_FROM_SOFT_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02127">MI_MAXIMUM_SECTION_SIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01591">MiGetSubsectionAddressForPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00107">MM4K_MASK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00106">MM4K_SHIFT</a>, <a class="el" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04833">MmSectionBasedMutex</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04839">MmSectionExtendResource</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04840">MmSectionExtendSetResource</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02124">_SUBSECTION::NextSubsection</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02075">_CONTROL_AREA::NonPagedPoolUsage</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02120">_SUBSECTION::NumberOfFullSectors</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02074">_CONTROL_AREA::PagedPoolUsage</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02058">_CONTROL_AREA::Segment</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02010">_SEGMENT::SegmentPteTemplate</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02005">_SEGMENT::SizeOfSegment</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d8/mi_8h.html#a465">SUBSECTION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02003">_SEGMENT::TotalNumberOfPtes</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d1/d7/struct__SUBSECTION.html#o3">_SUBSECTION::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l02122">_SUBSECTION::UnusedPtes</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l00387">CcInitializeCacheMap()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l01821">CcSetFileSizes()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00390">MmCreateSection()</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, and <a class="el" href="../../d9/d9/extsect_8c-source.html#l00085">NtExtendSection()</a>.
<p>
<pre class="fragment"><div>00209                    :
00210 
00211     This function extends <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section.  If
00212     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> greater than or equal to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00213     specified section size, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not updated.
00214 
00215 Arguments:
00216 
00217     Section - Supplies a pointer to a referenced section object.
00218 
00219     NewSectionSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> size <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object.
00220 
00221     IgnoreFileSizeChecking -  Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> size
00222                               checking should be ignored (i.e., it
00223                               is being called from a file system which
00224                               has already done the checks).  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00225                               <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> checks still need to be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>.
00226 
00227 Return Value:
00228 
00229     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
00230 
00231     TBS
00232 
00233 
00234 --*/
00235 
00236 {
00237     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00238     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00239     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ExtendedPtes;
00240     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00241     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00242     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> Section;
00243     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> LastSubsection;
00244     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> ExtendedSubsection;
00245     ULONG RequiredPtes;
00246     ULONG NumberOfPtes;
00247     ULONG PtesUsed;
00248     ULONG AllocationSize;
00249     UINT64 EndOfFile;
00250     UINT64 NumberOfPtesForEntireFile;
00251     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00252     LARGE_INTEGER NumberOf4KsForEntireFile;
00253     LARGE_INTEGER Starting4K;
00254     LARGE_INTEGER Last4KChunk;
00255 
00256     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00257 
00258     Section = (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToExtend;
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">// Make sure the section is really extendable - physical and</span>
00262     <span class="comment">// image sections are not.</span>
00263     <span class="comment">//</span>
00264 
00265     ControlArea = Section-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
00266 
00267     <span class="keywordflow">if</span> ((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.PhysicalMemory || ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image) ||
00268          (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00269         <span class="keywordflow">return</span> STATUS_SECTION_NOT_EXTENDED;
00270     }
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">// Acquire the section extension mutex, this blocks other threads from</span>
00274     <span class="comment">// updating the size at the same time.</span>
00275     <span class="comment">//</span>
00276 
00277     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a> ();
00278     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;MmSectionExtendResource, TRUE);
00279 
00280     <span class="comment">//</span>
00281     <span class="comment">// Each subsection is limited to 16TB - 64K because the NumberOfFullSectors</span>
00282     <span class="comment">// and various other fields in the subsection are ULONGs.  For NT64, the</span>
00283     <span class="comment">// allocation could be split into multiple subsections as needed to</span>
00284     <span class="comment">// conform to this limit - this is not worth doing for NT32 unless</span>
00285     <span class="comment">// sparse prototype PTE allocations are supported.</span>
00286     <span class="comment">//</span>
00287 
00288     <span class="comment">// This must be a multiple of the size of prototype pte allocation so any</span>
00289     <span class="comment">// given prototype pte allocation will have the same subsection for all</span>
00290     <span class="comment">// PTEs.</span>
00291     <span class="comment">//</span>
00292     <span class="comment">// The total section size is limited to 16PB - 4K because of the</span>
00293     <span class="comment">// StartingSector4132 field in each subsection.</span>
00294     <span class="comment">//</span>
00295 
00296     NumberOfPtesForEntireFile = (NewSectionSize-&gt;QuadPart + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00297 
00298     NumberOfPtes = (ULONG)NumberOfPtesForEntireFile;
00299 
00300     <span class="keywordflow">if</span> (NewSectionSize-&gt;QuadPart &gt; <a class="code" href="../../d4/d8/mi_8h.html#a218">MI_MAXIMUM_SECTION_SIZE</a>) {
00301         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SECTION_TOO_BIG;
00302         <span class="keywordflow">goto</span> ReleaseAndReturn;
00303     }
00304 
00305     <span class="keywordflow">if</span> (NumberOfPtesForEntireFile &gt; (UINT64)((MAXULONG_PTR / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)) - <span class="keyword">sizeof</span> (<a class="code" href="../../d1/d1/struct__SEGMENT.html">SEGMENT</a>))) {
00306         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SECTION_TOO_BIG;
00307         <span class="keywordflow">goto</span> ReleaseAndReturn;
00308     }
00309 
00310     <span class="keywordflow">if</span> (NumberOfPtesForEntireFile &gt; (UINT64)NewSectionSize-&gt;QuadPart) {
00311         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SECTION_TOO_BIG;
00312         <span class="keywordflow">goto</span> ReleaseAndReturn;
00313     }
00314 
00315     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.WasPurged == 0) {
00316 
00317         <span class="keywordflow">if</span> ((UINT64)NewSectionSize-&gt;QuadPart &lt;= (UINT64)Section-&gt;SizeOfSection.QuadPart) {
00318             *NewSectionSize = Section-&gt;SizeOfSection;
00319             <span class="keywordflow">goto</span> ReleaseAndReturnSuccess;
00320         }
00321     }
00322 
00323     <span class="comment">//</span>
00324     <span class="comment">// If a file handle was specified, set the allocation size of the file.</span>
00325     <span class="comment">//</span>
00326 
00327     <span class="keywordflow">if</span> (IgnoreFileSizeChecking == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00328 
00329         <span class="comment">//</span>
00330         <span class="comment">// Release the resource so we don't deadlock with the file</span>
00331         <span class="comment">// system trying to extend this section at the same time.</span>
00332         <span class="comment">//</span>
00333 
00334         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;MmSectionExtendResource);
00335 
00336         <span class="comment">//</span>
00337         <span class="comment">// Get a different resource to single thread query/set operations.</span>
00338         <span class="comment">//</span>
00339 
00340         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;MmSectionExtendSetResource, TRUE);
00341 
00342         <span class="comment">//</span>
00343         <span class="comment">// Query the file size to see if this file really needs extending.</span>
00344         <span class="comment">//</span>
00345         <span class="comment">// If the specified size is less than the current size, return</span>
00346         <span class="comment">// the current size.</span>
00347         <span class="comment">//</span>
00348 
00349         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/fsrtl_8h.html#a109">FsRtlGetFileSize</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>,
00350                                    (PLARGE_INTEGER)&amp;EndOfFile);
00351 
00352         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
00353             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;MmSectionExtendSetResource);
00354             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a> ();
00355             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00356         }
00357 
00358         <span class="keywordflow">if</span> ((UINT64)NewSectionSize-&gt;QuadPart &gt; EndOfFile) {
00359 
00360             <span class="comment">//</span>
00361             <span class="comment">// Don't allow section extension unless the section was originally</span>
00362             <span class="comment">// created with write access.  The check couldn't be done at create</span>
00363             <span class="comment">// time without breaking existing binaries, so the caller gets the</span>
00364             <span class="comment">// error at this point instead.</span>
00365             <span class="comment">//</span>
00366 
00367             <span class="keywordflow">if</span> (((Section-&gt;InitialPageProtection &amp; PAGE_READWRITE) |
00368                 (Section-&gt;InitialPageProtection &amp; PAGE_EXECUTE_READWRITE)) == 0) {
00369 <span class="preprocessor">#if DBG</span>
00370 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Section extension failed %x\n"</span>, Section);
00371 <span class="preprocessor">#endif</span>
00372 <span class="preprocessor"></span>                    <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;MmSectionExtendSetResource);
00373                     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a> ();
00374                     <span class="keywordflow">return</span> STATUS_SECTION_NOT_EXTENDED;
00375             }
00376 
00377             <span class="comment">//</span>
00378             <span class="comment">// Current file is smaller, attempt to set a new end of file.</span>
00379             <span class="comment">//</span>
00380 
00381             EndOfFile = *(PUINT64)NewSectionSize;
00382 
00383             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/fsrtl_8h.html#a110">FsRtlSetFileSize</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>,
00384                                        (PLARGE_INTEGER)&amp;EndOfFile);
00385 
00386             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
00387                 <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;MmSectionExtendSetResource);
00388                 <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a> ();
00389                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00390             }
00391         }
00392 
00393         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o11">ExtendInfo</a>) {
00394             ExAcquireFastMutex (&amp;MmSectionBasedMutex);
00395             <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o11">ExtendInfo</a>) {
00396                 ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o11">ExtendInfo</a>-&gt;<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o0">CommittedSize</a> = EndOfFile;
00397             }
00398             ExReleaseFastMutex (&amp;MmSectionBasedMutex);
00399         }
00400 
00401         <span class="comment">//</span>
00402         <span class="comment">// Release the query/set resource and reacquire the extend section</span>
00403         <span class="comment">// resource.</span>
00404         <span class="comment">//</span>
00405 
00406         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;MmSectionExtendSetResource);
00407         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;MmSectionExtendResource, TRUE);
00408     }
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">// Find the last subsection.</span>
00412     <span class="comment">//</span>
00413 
00414     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0);
00415 
00416     LastSubsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
00417 
00418     <span class="keywordflow">while</span> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00419         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a> == 0);
00420         LastSubsection = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00421     }
00422 
00423 <span class="preprocessor">#if DBG</span>
00424 <span class="preprocessor"></span>    MiSubsectionConsistent(LastSubsection);
00425 <span class="preprocessor">#endif</span>
00426 <span class="preprocessor"></span>
00427     <span class="comment">//</span>
00428     <span class="comment">// Does the structure need extending?</span>
00429     <span class="comment">//</span>
00430 
00431     <span class="keywordflow">if</span> (NumberOfPtes &lt;= Section-&gt;Segment-&gt;TotalNumberOfPtes) {
00432 
00433         <span class="comment">//</span>
00434         <span class="comment">// The segment is already large enough, just update</span>
00435         <span class="comment">// the section size and return.</span>
00436         <span class="comment">//</span>
00437 
00438         Section-&gt;SizeOfSection = *NewSectionSize;
00439         <span class="keywordflow">if</span> (Section-&gt;Segment-&gt;SizeOfSegment &lt; (UINT64)NewSectionSize-&gt;QuadPart) {
00440             <span class="comment">//</span>
00441             <span class="comment">// Only update if it is really bigger.</span>
00442             <span class="comment">//</span>
00443 
00444             Section-&gt;Segment-&gt;SizeOfSegment = *(PUINT64)NewSectionSize;
00445 
00446             <a class="code" href="../../d4/d8/mi_8h.html#a220">Mi4KStartFromSubsection</a>(&amp;Starting4K, LastSubsection);
00447 
00448             Last4KChunk.QuadPart = (NewSectionSize-&gt;QuadPart &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a25">MM4K_SHIFT</a>) - Starting4K.QuadPart;
00449 
00450             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Last4KChunk.HighPart == 0);
00451 
00452             LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> = Last4KChunk.LowPart;
00453             LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.SectorEndOffset =
00454                                         NewSectionSize-&gt;LowPart &amp; <a class="code" href="../../d4/d8/mi_8h.html#a26">MM4K_MASK</a>;
00455 <span class="preprocessor">#if DBG</span>
00456 <span class="preprocessor"></span>            MiSubsectionConsistent(LastSubsection);
00457 <span class="preprocessor">#endif</span>
00458 <span class="preprocessor"></span>        }
00459         <span class="keywordflow">goto</span> ReleaseAndReturnSuccess;
00460     }
00461 
00462     <span class="comment">//</span>
00463     <span class="comment">// Add new structures to the section - locate the last subsection</span>
00464     <span class="comment">// and add there.</span>
00465     <span class="comment">//</span>
00466 
00467     RequiredPtes = NumberOfPtes - Section-&gt;Segment-&gt;TotalNumberOfPtes;
00468     PtesUsed = 0;
00469 
00470     <span class="keywordflow">if</span> (RequiredPtes &lt; LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a>) {
00471 
00472         <span class="comment">//</span>
00473         <span class="comment">// There are ample PTEs to extend the section already allocated.</span>
00474         <span class="comment">//</span>
00475 
00476         PtesUsed = RequiredPtes;
00477         RequiredPtes = 0;
00478 
00479     } <span class="keywordflow">else</span> {
00480         PtesUsed = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a>;
00481         RequiredPtes -= PtesUsed;
00482     }
00483 
00484     LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> += PtesUsed;
00485     LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a> -= PtesUsed;
00486     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o4">SizeOfSegment</a> += (ULONG_PTR)PtesUsed * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00487     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o2">TotalNumberOfPtes</a> += PtesUsed;
00488 
00489     <span class="keywordflow">if</span> (RequiredPtes == 0) {
00490 
00491         <span class="comment">//</span>
00492         <span class="comment">// There is no extension necessary, update the high VBN.</span>
00493         <span class="comment">//</span>
00494 
00495         <a class="code" href="../../d4/d8/mi_8h.html#a220">Mi4KStartFromSubsection</a>(&amp;Starting4K, LastSubsection);
00496 
00497         Last4KChunk.QuadPart = (NewSectionSize-&gt;QuadPart &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a25">MM4K_SHIFT</a>) - Starting4K.QuadPart;
00498 
00499         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Last4KChunk.HighPart == 0);
00500 
00501         LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> = Last4KChunk.LowPart;
00502 
00503         LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.SectorEndOffset =
00504                                     NewSectionSize-&gt;LowPart &amp; <a class="code" href="../../d4/d8/mi_8h.html#a26">MM4K_MASK</a>;
00505 <span class="preprocessor">#if DBG</span>
00506 <span class="preprocessor"></span>        MiSubsectionConsistent(LastSubsection);
00507 <span class="preprocessor">#endif</span>
00508 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00509 
00510         <span class="comment">//</span>
00511         <span class="comment">// An extension is required.  Allocate paged pool</span>
00512         <span class="comment">// and populate it with prototype PTEs.</span>
00513         <span class="comment">//</span>
00514 
00515         AllocationSize = (ULONG) <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a> (RequiredPtes * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00516 
00517         ExtendedPtes = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool,
00518                                                       AllocationSize,
00519                                                       'ppmM');
00520 
00521         <span class="keywordflow">if</span> (ExtendedPtes == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00522 
00523             <span class="comment">//</span>
00524             <span class="comment">// The required pool could not be allocated.  Reset</span>
00525             <span class="comment">// the subsection and control area fields to their</span>
00526             <span class="comment">// original values.</span>
00527             <span class="comment">//</span>
00528 
00529             LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> -= PtesUsed;
00530             LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a> += PtesUsed;
00531             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o2">TotalNumberOfPtes</a> -= PtesUsed;
00532             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o4">SizeOfSegment</a> -= ((ULONG_PTR)PtesUsed * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00533             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00534             <span class="keywordflow">goto</span> ReleaseAndReturn;
00535         }
00536 
00537         <span class="comment">//</span>
00538         <span class="comment">// Allocate an extended subsection descriptor.</span>
00539         <span class="comment">//</span>
00540 
00541         ExtendedSubsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
00542                                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>),
00543                                                      'bSmM'
00544                                                      );
00545         <span class="keywordflow">if</span> (ExtendedSubsection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00546 
00547             <span class="comment">//</span>
00548             <span class="comment">// The required pool could not be allocated.  Reset</span>
00549             <span class="comment">// the subsection and control area fields to their</span>
00550             <span class="comment">// original values.</span>
00551             <span class="comment">//</span>
00552 
00553             LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> -= PtesUsed;
00554             LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a> += PtesUsed;
00555             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o2">TotalNumberOfPtes</a> -= PtesUsed;
00556             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o4">SizeOfSegment</a> -= ((ULONG_PTR)PtesUsed * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00557             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ExtendedPtes);
00558             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00559             <span class="keywordflow">goto</span> ReleaseAndReturn;
00560         }
00561 
00562         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o16">NonPagedPoolUsage</a> += <a class="code" href="../../d4/d2/pool_8h.html#a23">EX_REAL_POOL_USAGE</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>));
00563         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o15">PagedPoolUsage</a> += AllocationSize;
00564     
00565         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>.Flink == NULL);
00566 
00567         NumberOf4KsForEntireFile.QuadPart =
00568             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o4">SizeOfSegment</a> &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a25">MM4K_SHIFT</a>;
00569 
00570         <a class="code" href="../../d4/d8/mi_8h.html#a220">Mi4KStartFromSubsection</a>(&amp;Starting4K, LastSubsection);
00571 
00572         Last4KChunk.QuadPart = NumberOf4KsForEntireFile.QuadPart -
00573                                    Starting4K.QuadPart;
00574 
00575         <span class="keywordflow">if</span> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.SectorEndOffset) {
00576             Last4KChunk.QuadPart += 1;
00577         }
00578 
00579         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Last4KChunk.HighPart == 0);
00580 
00581         LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> = Last4KChunk.LowPart;
00582         LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.SectorEndOffset = 0;
00583 
00584         <span class="comment">//</span>
00585         <span class="comment">// If the number of sectors doesn't completely fill the PTEs (this can</span>
00586         <span class="comment">// only happen when the page size is not MM4K), then fill it now.</span>
00587         <span class="comment">//</span>
00588 
00589         <span class="keywordflow">if</span> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> &amp; ((1 &lt;&lt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - <a class="code" href="../../d4/d8/mi_8h.html#a25">MM4K_SHIFT</a>)) - 1)) {
00590             LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> += 1;
00591         }
00592 
00593 <span class="preprocessor">#if DBG</span>
00594 <span class="preprocessor"></span>        MiSubsectionConsistent(LastSubsection);
00595 <span class="preprocessor">#endif</span>
00596 <span class="preprocessor"></span>
00597         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.LongFlags = 0;
00598         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00599         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a> = (AllocationSize / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)) -
00600                                                     RequiredPtes;
00601 
00602         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a> = ControlArea;
00603         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> = RequiredPtes;
00604 
00605         Starting4K.QuadPart += LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a>;
00606 
00607         <a class="code" href="../../d4/d8/mi_8h.html#a219">Mi4KStartForSubsection</a>(&amp;Starting4K, ExtendedSubsection);
00608 
00609         Last4KChunk.QuadPart =
00610             (NewSectionSize-&gt;QuadPart &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a25">MM4K_SHIFT</a>) - Starting4K.QuadPart;
00611 
00612         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Last4KChunk.HighPart == 0);
00613 
00614         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">NumberOfFullSectors</a> = Last4KChunk.LowPart;
00615         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.SectorEndOffset =
00616                                     NewSectionSize-&gt;LowPart &amp; <a class="code" href="../../d4/d8/mi_8h.html#a26">MM4K_MASK</a>;
00617 
00618 <span class="preprocessor">#if DBG</span>
00619 <span class="preprocessor"></span>        MiSubsectionConsistent(ExtendedSubsection);
00620 <span class="preprocessor">#endif</span>
00621 <span class="preprocessor"></span>
00622         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a> = ExtendedPtes;
00623 
00624         PointerPte = ExtendedPtes;
00625         LastPte = ExtendedPtes + (AllocationSize / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>));
00626 
00627         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00628             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a149">MiGetSubsectionAddressForPte</a>(ExtendedSubsection);
00629         }
00630 <span class="preprocessor">#if DBG</span>
00631 <span class="preprocessor"></span>        <span class="keywordflow">else</span> {
00632             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM: Extend with no control area file pointer %x %x\n"</span>,
00633                 ExtendedSubsection, ControlArea);
00634             DbgBreakPoint();
00635         }
00636 <span class="preprocessor">#endif</span>
00637 <span class="preprocessor"></span>
00638         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o9">SegmentPteTemplate</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection;
00639         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype = 1;
00640         ExtendedSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.Protection =
00641             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a184">MI_GET_PROTECTION_FROM_SOFT_PTE</a>(&amp;TempPte);
00642 
00643         <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
00644             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
00645             PointerPte += 1;
00646         }
00647 
00648         <span class="comment">//</span>
00649         <span class="comment">// Link this into the list.</span>
00650         <span class="comment">//</span>
00651 
00652         LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> = ExtendedSubsection;
00653         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o2">TotalNumberOfPtes</a> += RequiredPtes;
00654 
00655 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(NT_UP)</span>
00656 <span class="preprocessor"></span>        <span class="comment">//</span>
00657         <span class="comment">// A memory barrier is required here to synchronize with</span>
00658         <span class="comment">// NtMapViewOfSection, which validates the specified offset against</span>
00659         <span class="comment">// the section object without holding lock synchronization.</span>
00660         <span class="comment">// This memory barrier forces the subsection chaining to be correct</span>
00661         <span class="comment">// before increasing the size in the section object.</span>
00662         <span class="comment">//</span>
00663         __MB();
00664 <span class="preprocessor">#endif</span>
00665 <span class="preprocessor"></span>
00666     }
00667 
00668     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o4">SizeOfSegment</a> = *(PUINT64)NewSectionSize;
00669     Section-&gt;SizeOfSection = *NewSectionSize;
00670 
00671 ReleaseAndReturnSuccess:
00672 
00673     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00674 
00675 ReleaseAndReturn:
00676 
00677     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;MmSectionExtendResource);
00678     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a> ();
00679 
00680     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00681 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a257" doxytag="mm.h::MmFlushImageSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmFlushImageSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionObjectPointer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/mm_8h.html#a153">MMFLUSH_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FlushType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l02094">2094</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1002a766">CheckImageSection</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02149">MiCheckControlAreaStatus()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01075">MiCleanSection()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d2/d1/mm_8h.html#a153">MMFLUSH_TYPE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a346a179">MmFlushForDelete</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02062">_CONTROL_AREA::NumberOfMappedViews</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02081">_LARGE_CONTROL_AREA::NumberOfSectionReferences</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02065">_CONTROL_AREA::NumberOfUserReferences</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o10">_LARGE_CONTROL_AREA::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02614">MiCanFileBeTruncatedInternal()</a>, and <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>.
<p>
<pre class="fragment"><div>02101                    :
02102 
02103     This function determines <span class="keywordflow">if</span> any views of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified image section
02104     are mapped, and <span class="keywordflow">if</span> not, flushes valid pages (even modified ones)
02105     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section and returns any used pages to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free
02106     list.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> accomplished by examining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prototype PTEs
02107     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified offset to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section, and <span class="keywordflow">if</span>
02108     any prototype PTEs are in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transition state, putting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02109     prototype PTE back into its original state and putting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02110     physical page on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free list.
02111 
02112 Arguments:
02113 
02114     SectionPointer - Supplies a pointer to a section object pointers
02115                      within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d9/struct__FCB.html">FCB</a>.
02116 
02117     FlushType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of flush to check <span class="keywordflow">for</span>.  One of
02118                 <a class="code" href="../../d2/d1/mm_8h.html#a346a179">MmFlushForDelete</a> or <a class="code" href="../../d2/d1/mm_8h.html#a346a180">MmFlushForWrite</a>.
02119 
02120 Return Value:
02121 
02122     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> either no section exists <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object or
02123     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not mapped and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> purge was done, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
02124 
02125 --*/
02126 
02127 {
02128     PLIST_ENTRY Next;
02129     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
02130     <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a> LargeControlArea;
02131     KIRQL OldIrql;
02132     BOOLEAN state;
02133     BOOLEAN FinalControlArea;
02134 
02135 
02136     <span class="keywordflow">if</span> (FlushType == <a class="code" href="../../d2/d1/mm_8h.html#a346a179">MmFlushForDelete</a>) {
02137 
02138         <span class="comment">//</span>
02139         <span class="comment">// Do a quick check to see if there are any mapped views for</span>
02140         <span class="comment">// the data section.  If so, just return FALSE.</span>
02141         <span class="comment">//</span>
02142 
02143         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02144         ControlArea = (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(SectionPointer-&gt;DataSectionObject);
02145         <span class="keywordflow">if</span> (ControlArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02146             <span class="keywordflow">if</span> ((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> != 0) ||
02147                 (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingCreated)) {
02148                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02149                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02150             }
02151         }
02152         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02153     }
02154 
02155     <span class="comment">//</span>
02156     <span class="comment">// Check the status of the control area.  If the control area is in use</span>
02157     <span class="comment">// or the control area is being deleted, this operation cannot continue.</span>
02158     <span class="comment">//</span>
02159 
02160     state = <a class="code" href="../../d5/d5/sectsup_8c.html#a26">MiCheckControlAreaStatus</a> (CheckImageSection,
02161                                       SectionPointer,
02162                                       FALSE,
02163                                       &amp;ControlArea,
02164                                       &amp;OldIrql);
02165 
02166     <span class="keywordflow">if</span> (ControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02167         <span class="keywordflow">return</span> state;
02168     }
02169 
02170     <span class="comment">//</span>
02171     <span class="comment">// PFN LOCK IS NOW HELD!</span>
02172     <span class="comment">//</span>
02173 
02174     <span class="comment">//</span>
02175     <span class="comment">// Repeat until there are no more control areas - multiple control areas</span>
02176     <span class="comment">// for the same image section occur to support user global DLLs - these DLLs</span>
02177     <span class="comment">// require data that is shared within a session but not across sessions.</span>
02178     <span class="comment">// Note this can only happen for Hydra.</span>
02179     <span class="comment">//</span>
02180 
02181     <span class="keywordflow">do</span> {
02182 
02183         <span class="comment">//</span>
02184         <span class="comment">// Set the being deleted flag and up the number of mapped views</span>
02185         <span class="comment">// for the segment.  Upping the number of mapped views prevents</span>
02186         <span class="comment">// the segment from being deleted and passed to the deletion thread</span>
02187         <span class="comment">// while we are forcing a delete.</span>
02188         <span class="comment">//</span>
02189 
02190         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted = 1;
02191         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> = 1;
02192         FinalControlArea = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02193 
02194         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02195             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea ==
02196                     (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)SectionPointer-&gt;ImageSectionObject);
02197         }
02198 
02199         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0) {
02200         }
02201         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsListEmpty(&amp;((<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)ControlArea)-&gt;UserGlobalList)) {
02202             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea ==
02203                     (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)SectionPointer-&gt;ImageSectionObject);
02204         }
02205         <span class="keywordflow">else</span> {
02206 
02207             <span class="comment">//</span>
02208             <span class="comment">// Check if there's only one image section in this control area, so</span>
02209             <span class="comment">// we don't reference the section object pointers as the</span>
02210             <span class="comment">// MiCleanSection call may result in its deletion.</span>
02211             <span class="comment">//</span>
02212 
02213             FinalControlArea = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02214 
02215             <span class="comment">//</span>
02216             <span class="comment">// There are multiple control areas, bump the reference count</span>
02217             <span class="comment">// on one of them (doesn't matter which one) so that it can't</span>
02218             <span class="comment">// go away.  This ensures the section object pointers will stick</span>
02219             <span class="comment">// around even after the calls below so we can safely reloop to</span>
02220             <span class="comment">// flush any other remaining control areas.</span>
02221             <span class="comment">//</span>
02222 
02223             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 1);
02224 
02225             Next = ((<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>)ControlArea)-&gt;UserGlobalList.Flink;
02226 
02227             LargeControlArea = CONTAINING_RECORD (Next,
02228                                                   <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">LARGE_CONTROL_AREA</a>,
02229                                                   UserGlobalList);
02230         
02231             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LargeControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 1);
02232 
02233             LargeControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> += 1;
02234         }
02235 
02236         <span class="comment">//</span>
02237         <span class="comment">// This is a page file backed or image segment.  The segment is being</span>
02238         <span class="comment">// deleted, remove all references to the paging file and physical</span>
02239         <span class="comment">// memory.</span>
02240         <span class="comment">//</span>
02241 
02242         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02243 
02244         <a class="code" href="../../d5/d5/sectsup_8c.html#a22">MiCleanSection</a> (ControlArea, TRUE);
02245 
02246         <span class="comment">//</span>
02247         <span class="comment">// Get the next Hydra control area.</span>
02248         <span class="comment">//</span>
02249 
02250         <span class="keywordflow">if</span> (FinalControlArea == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02251             state = <a class="code" href="../../d5/d5/sectsup_8c.html#a26">MiCheckControlAreaStatus</a> (CheckImageSection,
02252                                               SectionPointer,
02253                                               FALSE,
02254                                               &amp;ControlArea,
02255                                               &amp;OldIrql);
02256             <span class="keywordflow">if</span> (!ControlArea) {
02257                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02258                 LargeControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> -= 1;
02259                 <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)LargeControlArea,
02260                                     NULL,
02261                                     OldIrql);
02262             }
02263             <span class="keywordflow">else</span> {
02264                 LargeControlArea-&gt;<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> -= 1;
02265                 <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)LargeControlArea,
02266                                     NULL,
02267                                     OldIrql);
02268                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02269             }
02270         } <span class="keywordflow">else</span> {
02271             state = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02272             <span class="keywordflow">break</span>;
02273         }
02274 
02275     } <span class="keywordflow">while</span> (ControlArea);
02276 
02277     <span class="keywordflow">return</span> state;
02278 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a254" doxytag="mm.h::MmFlushSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmFlushSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionObjectPointer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER <a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>RegionSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AcquireFile</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00668">668</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02070">_CONTROL_AREA::FilePointer</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00428">_ETHREAD::ForwardClusterOnly</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02402">FsRtlAcquireFileForCcFlush()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02483">FsRtlReleaseFileForCcFlush()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01014">MiFlushSectionInternal()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00215">MmShortTime</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02124">_SUBSECTION::NextSubsection</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02062">_CONTROL_AREA::NumberOfMappedViews</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02061">_CONTROL_AREA::NumberOfPfnReferences</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cachesub_8c-source.html#l04411">CcFlushCache()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l06024">CcMapAndCopy()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00838">CcMdlWriteComplete2()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02194">CcPurgeAndClearCacheSection()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l01821">CcSetFileSizes()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l05143">CcUnpinRepinnedBcb()</a>, and <a class="el" href="../../d1/d7/creasect_8c-source.html#l04999">MiFlushDataSection()</a>.
<p>
<pre class="fragment"><div>00678                    :
00679 
00680     This function flushes to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> backing <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> any modified pages within
00681     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified range of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section.
00682 
00683 Arguments:
00684 
00685     SectionObjectPointer - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section objects.
00686 
00687     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section in which to begin
00688              flushing pages.  If <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not present, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00689              whole section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> flushed without regard to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region size
00690              argument.
00691 
00692     RegionSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size in bytes to flush.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded
00693                  to a page multiple.
00694 
00695     IoStatus - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IoStatus <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last attempted
00696          I/O operation.
00697 
00698     AcquireFile - Nonzero <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback should be used to acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00699 
00700 Return Value:
00701 
00702     Returns status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00703 
00704 --*/
00705 
00706 {
00707     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00708     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00709     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00710     KIRQL OldIrql;
00711     ULONG PteOffset;
00712     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00713     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> LastSubsection;
00714     BOOLEAN DeleteSegment = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00715     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread;
00716     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00717     BOOLEAN OldClusterState;
00718     ULONG ConsecutiveFileLockFailures;
00719 
00720     <span class="comment">//</span>
00721     <span class="comment">// Initialize IoStatus for success, in case we take an early exit.</span>
00722     <span class="comment">//</span>
00723 
00724     IoStatus-&gt;Status = STATUS_SUCCESS;
00725     IoStatus-&gt;Information = RegionSize;
00726 
00727     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00728 
00729     ControlArea = ((<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(SectionObjectPointer-&gt;DataSectionObject));
00730 
00731     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((ControlArea == NULL) || (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image == 0));
00732 
00733     <span class="keywordflow">if</span> ((ControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00734         (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted) ||
00735         (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingCreated) ||
00736         (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> == 0)) {
00737 
00738         <span class="comment">//</span>
00739         <span class="comment">// This file no longer has an associated segment or is in the</span>
00740         <span class="comment">// process of coming or going.</span>
00741         <span class="comment">// If the number of PFN references is zero, then this control</span>
00742         <span class="comment">// area does not have any valid or transition pages that need</span>
00743         <span class="comment">// to be flushed.</span>
00744         <span class="comment">//</span>
00745 
00746         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00747         <span class="keywordflow">return</span> STATUS_SUCCESS;
00748     }
00749 
00750     <span class="comment">//</span>
00751     <span class="comment">// Locate the subsection.</span>
00752     <span class="comment">//</span>
00753 
00754     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0);
00755 
00756     Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
00757 
00758     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT (Offset)) {
00759 
00760         <span class="comment">//</span>
00761         <span class="comment">// If the offset is not specified, flush the complete file ignoring</span>
00762         <span class="comment">// the region size.</span>
00763         <span class="comment">//</span>
00764 
00765         PointerPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[0];
00766         LastSubsection = Subsection;
00767         <span class="keywordflow">while</span> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00768             LastSubsection = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00769         }
00770         LastPte = &amp;LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>
00771                             [LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> - 1];
00772     } <span class="keywordflow">else</span> {
00773 
00774         PteOffset = (ULONG)(<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00775 
00776         <span class="comment">//</span>
00777         <span class="comment">// Make sure the PTEs are not in the extended part of the</span>
00778         <span class="comment">// segment.</span>
00779         <span class="comment">//</span>
00780 
00781         <span class="keywordflow">while</span> (PteOffset &gt;= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>) {
00782             PteOffset -= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
00783             <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00784 
00785                 <span class="comment">//</span>
00786                 <span class="comment">// Past end of mapping, just return success.</span>
00787                 <span class="comment">//</span>
00788 
00789                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00790                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00791             }
00792             Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00793         }
00794 
00795         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteOffset &lt; Subsection-&gt;PtesInSubsection);
00796         PointerPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset];
00797 
00798         <span class="comment">//</span>
00799         <span class="comment">// Locate the address of the last prototype PTE to be flushed.</span>
00800         <span class="comment">//</span>
00801 
00802         PteOffset += (ULONG)(((RegionSize + <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>-&gt;LowPart)) - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00803 
00804         LastSubsection = Subsection;
00805 
00806         <span class="keywordflow">while</span> (PteOffset &gt;= LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>) {
00807             PteOffset -= LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
00808             <span class="keywordflow">if</span> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00809                 PteOffset = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> - 1;
00810                 <span class="keywordflow">break</span>;
00811             }
00812             LastSubsection = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00813         }
00814 
00815         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteOffset &lt; LastSubsection-&gt;PtesInSubsection);
00816         LastPte = &amp;LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset];
00817     }
00818 
00819     <span class="comment">//</span>
00820     <span class="comment">// Up the map view count so the control area cannot be deleted</span>
00821     <span class="comment">// out from under the call.</span>
00822     <span class="comment">//</span>
00823 
00824     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> += 1;
00825 
00826     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00827 
00828     CurrentThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00829 
00830     <span class="comment">//</span>
00831     <span class="comment">// Indicate that disk verify errors should be returned as exceptions.</span>
00832     <span class="comment">//</span>
00833 
00834     OldClusterState = CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o22">ForwardClusterOnly</a>;
00835     CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o22">ForwardClusterOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00836 
00837     <span class="comment">//</span>
00838     <span class="comment">// Preacquire the file if we are going to synchronize the flush.</span>
00839     <span class="comment">//</span>
00840 
00841     <span class="keywordflow">if</span> (AcquireFile == 0) {
00842 
00843         <span class="comment">//</span>
00844         <span class="comment">// Flush the PTEs from the specified section.</span>
00845         <span class="comment">//</span>
00846 
00847         status = <a class="code" href="../../d4/d8/mi_8h.html#a935">MiFlushSectionInternal</a> (PointerPte,
00848                                          LastPte,
00849                                          Subsection,
00850                                          LastSubsection,
00851                                          TRUE,
00852                                          TRUE,
00853                                          IoStatus);
00854     }
00855     <span class="keywordflow">else</span> {
00856 
00857         ConsecutiveFileLockFailures = 0;
00858 
00859         <span class="keywordflow">do</span> {
00860 
00861             <a class="code" href="../../d1/d8/fsrtl_8h.html#a105">FsRtlAcquireFileForCcFlush</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>);
00862 
00863             <span class="comment">//</span>
00864             <span class="comment">// Flush the PTEs from the specified section.</span>
00865             <span class="comment">//</span>
00866 
00867             status = <a class="code" href="../../d4/d8/mi_8h.html#a935">MiFlushSectionInternal</a> (PointerPte,
00868                                              LastPte,
00869                                              Subsection,
00870                                              LastSubsection,
00871                                              TRUE,
00872                                              TRUE,
00873                                              IoStatus);
00874 
00875             <span class="comment">//</span>
00876             <span class="comment">// Release the file we acquired.</span>
00877             <span class="comment">//</span>
00878 
00879             <a class="code" href="../../d1/d8/fsrtl_8h.html#a106">FsRtlReleaseFileForCcFlush</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>);
00880 
00881             <span class="comment">//</span>
00882             <span class="comment">// Only try the request more than once if the filesystem told us</span>
00883             <span class="comment">// it had a deadlock.</span>
00884             <span class="comment">//</span>
00885 
00886             <span class="keywordflow">if</span> (status != STATUS_FILE_LOCK_CONFLICT) {
00887                 <span class="keywordflow">break</span>;
00888             }
00889 
00890             ConsecutiveFileLockFailures += 1;
00891             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;MmShortTime);
00892 
00893         } <span class="keywordflow">while</span> (ConsecutiveFileLockFailures &lt; 5);
00894     }
00895 
00896     CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o22">ForwardClusterOnly</a> = OldClusterState;
00897 
00898     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00899 
00900     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> &gt;= 1);
00901     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
00902 
00903     <span class="comment">//</span>
00904     <span class="comment">// Check to see if the control area should be deleted.  This</span>
00905     <span class="comment">// will release the PFN lock.</span>
00906     <span class="comment">//</span>
00907 
00908     <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
00909 
00910     <span class="keywordflow">return</span> status;
00911 
00912 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a250" doxytag="mm.h::MmFlushVirtualMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmFlushVirtualMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>RegionSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00297">297</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02393">_MMVAD::ControlArea</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02070">_CONTROL_AREA::FilePointer</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02402">FsRtlAcquireFileForCcFlush()</a>, <a class="el" href="../../d4/d0/fastio_8c-source.html#l02483">FsRtlReleaseFileForCcFlush()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01039">LOCK_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01093">LOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05293">MI_IS_SESSION_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02717">MI_IS_SYSTEM_CACHE_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00765">MI_VPN_TO_VA_ENDING</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00437">MiDoesPdeExistAndMakeValid()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01980">MiDoesPpeExistAndMakeValid</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00223">MiFlushAcquire()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l02281">MiFlushDirtyBitsToPfn()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00258">MiFlushRelease()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01014">MiFlushSectionInternal()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l03696">MiGetProtoPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l02402">MiGetSystemCacheSubsection()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00380">MiLocateAddress()</a>, <a class="el" href="../../d9/d9/extsect_8c-source.html#l00783">MiLocateSubsection()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00215">MmShortTime</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02124">_SUBSECTION::NextSubsection</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01081">UNLOCK_WS</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00055">NtFlushVirtualMemory()</a>.
<p>
<pre class="fragment"><div>00306                    :
00307 
00308     This function flushes a range of <span class="keyword">virtual</span> address which map
00309     a data <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> back into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">if</span> they have been modified.
00310 
00311     Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modification <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">this</span> process's view of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages,
00312     on certain implementations (like the Intel 386), <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modify
00313     bit <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> captured in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE and not forced to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database
00314     until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set.  This means
00315     that pages which have been modified by another process will
00316     not be flushed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00317 
00318 Arguments:
00319 
00320     Process - Supplies a pointer to a process object.
00321 
00322     BaseAddress - Supplies a pointer to a variable that will receive
00323          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flushed region.  The initial value
00324          of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00325          pages to flush.
00326 
00327     RegionSize - Supplies a pointer to a variable that will receive
00328          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual size in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flushed region of pages.
00329          The initial value of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00330          next host-page-size boundary.
00331 
00332          If <span class="keyword">this</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as zero, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapped range from
00333          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> flushed.
00334 
00335     IoStatus - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IoStatus <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last attempted
00336          I/O operation.
00337 
00338 Return Value:
00339 
00340     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT status
00341 
00342 --*/
00343 
00344 {
00345     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
00346     PVOID EndingAddress;
00347     PVOID Va;
00348     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00349     BOOLEAN SystemCache;
00350     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00351     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00352     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00353     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00354     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00355     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FinalPte;
00356     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00357     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> LastSubsection;
00358     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00359     ULONG ConsecutiveFileLockFailures;
00360     ULONG Waited;
00361     LOGICAL EntireRestOfVad;
00362     LOGICAL Attached;
00363 
00364     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00365 
00366     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00367 
00368     <span class="comment">//</span>
00369     <span class="comment">// Determine if the specified base address is within the system</span>
00370     <span class="comment">// cache and if so, don't attach, the working set mutex is still</span>
00371     <span class="comment">// required to "lock" paged pool pages (proto PTEs) into the</span>
00372     <span class="comment">// working set.</span>
00373     <span class="comment">//</span>
00374 
00375     EndingAddress = (PVOID)(((ULONG_PTR)*BaseAddress + *RegionSize - 1) |
00376                                                             (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
00377     *BaseAddress = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (*BaseAddress);
00378 
00379     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (*BaseAddress)) {
00380 
00381         <span class="comment">//</span>
00382         <span class="comment">// Nothing in session space needs flushing.</span>
00383         <span class="comment">//</span>
00384 
00385         <span class="keywordflow">return</span> STATUS_NOT_MAPPED_VIEW;
00386     }
00387 
00388     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
00389 
00390     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a196">MI_IS_SYSTEM_CACHE_ADDRESS</a>(*BaseAddress)) {
00391 
00392         SystemCache = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00393 
00394         <span class="comment">//</span>
00395         <span class="comment">// Attach to the specified process.</span>
00396         <span class="comment">//</span>
00397 
00398         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != Process) {
00399             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
00400             Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00401         }
00402 
00403         <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00404 
00405         <span class="comment">//</span>
00406         <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
00407         <span class="comment">//</span>
00408 
00409         <span class="keywordflow">if</span> (Process-&gt;AddressSpaceDeleted != 0) {
00410             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
00411             <span class="keywordflow">goto</span> ErrorReturn;
00412         }
00413 
00414         Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (*BaseAddress);
00415 
00416         <span class="keywordflow">if</span> (Vad == (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00417 
00418             <span class="comment">//</span>
00419             <span class="comment">// No Virtual Address Descriptor located for Base Address.</span>
00420             <span class="comment">//</span>
00421 
00422             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_MAPPED_VIEW;
00423             <span class="keywordflow">goto</span> ErrorReturn;
00424         }
00425 
00426         <span class="keywordflow">if</span> (*RegionSize == 0) {
00427             EndingAddress = <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>);
00428             EntireRestOfVad = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00429         }
00430         <span class="keywordflow">else</span> {
00431             EntireRestOfVad = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00432         }
00433 
00434         <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 1) ||
00435             (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress) &gt; Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>)) {
00436 
00437             <span class="comment">//</span>
00438             <span class="comment">// This virtual address descriptor does not refer to a Segment</span>
00439             <span class="comment">// object.</span>
00440             <span class="comment">//</span>
00441 
00442             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_MAPPED_VIEW;
00443             <span class="keywordflow">goto</span> ErrorReturn;
00444         }
00445 
00446         <span class="comment">//</span>
00447         <span class="comment">// Make sure this VAD maps a data file (not an image file).</span>
00448         <span class="comment">//</span>
00449 
00450         ControlArea = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a>;
00451 
00452         <span class="keywordflow">if</span> ((ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00453              (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.ImageMap == 1)) {
00454 
00455             <span class="comment">//</span>
00456             <span class="comment">// This virtual address descriptor does not refer to a Segment</span>
00457             <span class="comment">// object.</span>
00458             <span class="comment">//</span>
00459 
00460             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_MAPPED_DATA;
00461             <span class="keywordflow">goto</span> ErrorReturn;
00462         }
00463 
00464     } <span class="keywordflow">else</span> {
00465 
00466         SystemCache = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00467         Process = CurrentProcess;
00468         <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (Process);
00469     }
00470 
00471     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (*BaseAddress);
00472     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (*BaseAddress);
00473     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (*BaseAddress);
00474     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
00475     *RegionSize = (PCHAR)EndingAddress - (PCHAR)*BaseAddress + 1;
00476 
00477 retry:
00478 
00479     <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe, Process, FALSE, &amp;Waited)) {
00480 
00481         <span class="comment">//</span>
00482         <span class="comment">// This page directory parent entry is empty, go to the next one.</span>
00483         <span class="comment">//</span>
00484 
00485         PointerPpe += 1;
00486         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
00487         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00488         Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00489 
00490         <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
00491             <span class="keywordflow">break</span>;
00492         }
00493     }
00494 
00495     Waited = 0;
00496 
00497     <span class="keywordflow">if</span> (PointerPte &lt;= LastPte) {
00498         <span class="keywordflow">while</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a>(PointerPde, Process, FALSE, &amp;Waited)) {
00499 
00500             <span class="comment">//</span>
00501             <span class="comment">// No page table page exists for this address.</span>
00502             <span class="comment">//</span>
00503 
00504             PointerPde += 1;
00505 
00506             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00507 
00508             <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
00509                 <span class="keywordflow">break</span>;
00510             }
00511 
00512 <span class="preprocessor">#if defined (_WIN64)</span>
00513 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
00514                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00515                 <span class="keywordflow">goto</span> retry;
00516             }
00517 <span class="preprocessor">#endif</span>
00518 <span class="preprocessor"></span>
00519             Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00520         }
00521 
00522         <span class="comment">//</span>
00523         <span class="comment">// If the PFN lock (and accordingly the WS mutex) was</span>
00524         <span class="comment">// released and reacquired we must retry the operation.</span>
00525         <span class="comment">//</span>
00526 
00527         <span class="keywordflow">if</span> (PointerPte &lt;= LastPte &amp;&amp; Waited != 0) {
00528             <span class="keywordflow">goto</span> retry;
00529         }
00530     }
00531 
00532     <a class="code" href="../../d6/d5/flushsec_8c.html#a2">MiFlushDirtyBitsToPfn</a> (PointerPte, LastPte, Process, SystemCache);
00533 
00534     <span class="keywordflow">if</span> (SystemCache) {
00535 
00536         <span class="comment">//</span>
00537         <span class="comment">// No VADs exist for the system cache.</span>
00538         <span class="comment">//</span>
00539 
00540         Subsection = <a class="code" href="../../d6/d5/flushsec_8c.html#a1">MiGetSystemCacheSubsection</a> (*BaseAddress,
00541                                                  Process,
00542                                                  &amp;PointerPte);
00543         LastSubsection = <a class="code" href="../../d6/d5/flushsec_8c.html#a1">MiGetSystemCacheSubsection</a> (EndingAddress,
00544                                                      Process,
00545                                                      &amp;FinalPte);
00546         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (Process);
00547 
00548         <span class="comment">//</span>
00549         <span class="comment">// Flush the PTEs from the specified section.</span>
00550         <span class="comment">//</span>
00551 
00552         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d8/mi_8h.html#a935">MiFlushSectionInternal</a> (PointerPte,
00553                                          FinalPte,
00554                                          Subsection,
00555                                          LastSubsection,
00556                                          FALSE,
00557                                          TRUE,
00558                                          IoStatus);
00559     }
00560     <span class="keywordflow">else</span> {
00561 
00562         <span class="comment">//</span>
00563         <span class="comment">// Protect against the section being prematurely deleted.</span>
00564         <span class="comment">//</span>
00565 
00566         <a class="code" href="../../d6/d5/flushsec_8c.html#a5">MiFlushAcquire</a> (ControlArea);
00567 
00568         PointerPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a> (Vad, MI_VA_TO_VPN (*BaseAddress));
00569         Subsection = <a class="code" href="../../d4/d8/mi_8h.html#a909">MiLocateSubsection</a> (Vad, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(*BaseAddress));
00570         LastSubsection = <a class="code" href="../../d4/d8/mi_8h.html#a909">MiLocateSubsection</a> (Vad, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(EndingAddress));
00571 
00572         <span class="comment">//</span>
00573         <span class="comment">// The last subsection is NULL if the section is not fully </span>
00574         <span class="comment">// committed.  Only allow the flush if the caller said do the whole</span>
00575         <span class="comment">// thing, otherwise it's an error.</span>
00576         <span class="comment">//</span>
00577 
00578         <span class="keywordflow">if</span> (LastSubsection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00579 
00580             <span class="keywordflow">if</span> (EntireRestOfVad == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00581 
00582                 <span class="comment">//</span>
00583                 <span class="comment">// Caller can only specify the range that is committed or zero</span>
00584                 <span class="comment">// to indicate the entire range.</span>
00585                 <span class="comment">//</span>
00586 
00587                 <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00588                 <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00589                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00590                 }
00591                 <a class="code" href="../../d6/d5/flushsec_8c.html#a6">MiFlushRelease</a> (ControlArea);
00592                 <span class="keywordflow">return</span> STATUS_NOT_MAPPED_VIEW;
00593             }
00594 
00595             LastSubsection = Subsection;
00596             <span class="keywordflow">while</span> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>) {
00597                 LastSubsection = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00598             }
00599             FinalPte = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a> + LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> - 1;
00600         }
00601         <span class="keywordflow">else</span> {
00602             FinalPte = <a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a> (Vad, MI_VA_TO_VPN (EndingAddress));
00603         }
00604 
00605         <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00606         <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00607             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00608         }
00609 
00610         <span class="comment">//</span>
00611         <span class="comment">// Preacquire the file to synchronize the flush.</span>
00612         <span class="comment">//</span>
00613 
00614         ConsecutiveFileLockFailures = 0;
00615 
00616         <span class="keywordflow">do</span> {
00617 
00618             <a class="code" href="../../d1/d8/fsrtl_8h.html#a105">FsRtlAcquireFileForCcFlush</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>);
00619 
00620             <span class="comment">//</span>
00621             <span class="comment">// Flush the PTEs from the specified section.</span>
00622             <span class="comment">//</span>
00623 
00624             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d8/mi_8h.html#a935">MiFlushSectionInternal</a> (PointerPte,
00625                                              FinalPte,
00626                                              Subsection,
00627                                              LastSubsection,
00628                                              TRUE,
00629                                              TRUE,
00630                                              IoStatus);
00631 
00632             <span class="comment">//</span>
00633             <span class="comment">// Release the file we acquired.</span>
00634             <span class="comment">//</span>
00635 
00636             <a class="code" href="../../d1/d8/fsrtl_8h.html#a106">FsRtlReleaseFileForCcFlush</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>);
00637 
00638             <span class="comment">//</span>
00639             <span class="comment">// Only try the request more than once if the filesystem told us</span>
00640             <span class="comment">// it had a deadlock.</span>
00641             <span class="comment">//</span>
00642 
00643             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_FILE_LOCK_CONFLICT) {
00644                 <span class="keywordflow">break</span>;
00645             }
00646 
00647             ConsecutiveFileLockFailures += 1;
00648             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;MmShortTime);
00649 
00650         } <span class="keywordflow">while</span> (ConsecutiveFileLockFailures &lt; 5);
00651 
00652         <a class="code" href="../../d6/d5/flushsec_8c.html#a6">MiFlushRelease</a> (ControlArea);
00653     }
00654 
00655     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00656 
00657 ErrorReturn:
00658     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SystemCache == FALSE);
00659     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00660     <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00661         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00662     }
00663     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00664 
00665 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a243" doxytag="mm.h::MmForceSectionClosed" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmForceSectionClosed           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionObjectPointer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DelayClose</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00957">957</a> of file <a class="el" href="../../d6/d4/sectsup_8c-source.html">sectsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1002a768">CheckBothSection</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02149">MiCheckControlAreaStatus()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01075">MiCleanSection()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02062">_CONTROL_AREA::NumberOfMappedViews</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
<pre class="fragment"><div>00964                    :
00965 
00966     This function examines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Section object pointers.  If they are <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00967     no further action <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> taken and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00968 
00969     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Section object pointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section reference count
00970     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map view count are checked. If both counts are zero, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00971     segment associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deleted and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> closed.
00972     If one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> counts <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> non-zero, no action <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> taken and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00973     value <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00974 
00975 Arguments:
00976 
00977     SectionObjectPointer - Supplies a pointer to a section object.
00978 
00979     DelayClose - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> close operation should
00980                  occur as soon as possible in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event <span class="keyword">this</span> section
00981                  cannot be closed now due to outstanding references.
00982 
00983 Return Value:
00984 
00985     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - The segment was deleted and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> closed or no segment was
00986            located.
00987 
00988     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - The segment was not deleted and no action was performed OR
00989             an I/O error occurred trying to write <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages.
00990 
00991 --*/
00992 
00993 {
00994     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00995     KIRQL OldIrql;
00996     BOOLEAN state;
00997 
00998     <span class="comment">//</span>
00999     <span class="comment">// Check the status of the control area, if the control area is in use</span>
01000     <span class="comment">// or the control area is being deleted, this operation cannot continue.</span>
01001     <span class="comment">//</span>
01002 
01003     state = <a class="code" href="../../d5/d5/sectsup_8c.html#a26">MiCheckControlAreaStatus</a> (CheckBothSection,
01004                                       SectionObjectPointer,
01005                                       DelayClose,
01006                                       &amp;ControlArea,
01007                                       &amp;OldIrql);
01008 
01009     <span class="keywordflow">if</span> (ControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01010         <span class="keywordflow">return</span> state;
01011     }
01012 
01013     <span class="comment">//</span>
01014     <span class="comment">// PFN LOCK IS NOW HELD!</span>
01015     <span class="comment">//</span>
01016 
01017     <span class="comment">//</span>
01018     <span class="comment">// Repeat until there are no more control areas - multiple control areas</span>
01019     <span class="comment">// for the same image section occur to support user global DLLs - these DLLs</span>
01020     <span class="comment">// require data that is shared within a session but not across sessions.</span>
01021     <span class="comment">// Note this can only happen for Hydra.</span>
01022     <span class="comment">//</span>
01023 
01024     <span class="keywordflow">do</span> {
01025 
01026         <span class="comment">//</span>
01027         <span class="comment">// Set the being deleted flag and up the number of mapped views</span>
01028         <span class="comment">// for the segment.  Upping the number of mapped views prevents</span>
01029         <span class="comment">// the segment from being deleted and passed to the deletion thread</span>
01030         <span class="comment">// while we are forcing a delete.</span>
01031         <span class="comment">//</span>
01032 
01033         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted = 1;
01034         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> == 0);
01035         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> = 1;
01036 
01037         <span class="comment">//</span>
01038         <span class="comment">// This is a page file backed or image Segment.  The Segment is being</span>
01039         <span class="comment">// deleted, remove all references to the paging file and physical memory.</span>
01040         <span class="comment">//</span>
01041 
01042         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01043 
01044         <span class="comment">//</span>
01045         <span class="comment">// Delete the section by flushing all modified pages back to the section</span>
01046         <span class="comment">// if it is a file and freeing up the pages such that the</span>
01047         <span class="comment">// PfnReferenceCount goes to zero.</span>
01048         <span class="comment">//</span>
01049 
01050         <a class="code" href="../../d5/d5/sectsup_8c.html#a22">MiCleanSection</a> (ControlArea, TRUE);
01051 
01052         <span class="comment">//</span>
01053         <span class="comment">// Get the next Hydra control area.</span>
01054         <span class="comment">//</span>
01055 
01056         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01057             state = <a class="code" href="../../d5/d5/sectsup_8c.html#a26">MiCheckControlAreaStatus</a> (CheckBothSection,
01058                                               SectionObjectPointer,
01059                                               DelayClose,
01060                                               &amp;ControlArea,
01061                                               &amp;OldIrql);
01062         }
01063         <span class="keywordflow">else</span> {
01064             state = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01065             <span class="keywordflow">break</span>;
01066         }
01067 
01068     } <span class="keywordflow">while</span> (ControlArea);
01069 
01070     <span class="keywordflow">return</span> state;
01071 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a295" doxytag="mm.h::MmFreeContiguousMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmFreeContiguousMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BaseAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05372">5372</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d4/d5/procsup_8c.html#a28">MiFreeLowMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00141">MiNoLowMemory</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01300">IoFreeDumpStack()</a>, <a class="el" href="../../d3/d0/largepag_8c-source.html#l00646">Ki386ClearIdentityMap()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l03744">MmAllocateContiguousMemorySpecifyCache()</a>.
<p>
<pre class="fragment"><div>05378                    :
05379 
05380     This function deallocates a range of physically contiguous non-paged
05381     <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> which was allocated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d1/mm_8h.html#a293">MmAllocateContiguousMemory</a> function.
05382 
05383 Arguments:
05384 
05385     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <span class="keyword">virtual</span> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical
05386                   address was previously mapped.
05387 
05388 Return Value:
05389 
05390     None.
05391 
05392 Environment:
05393 
05394     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
05395 
05396 --*/
05397 
05398 {
05399     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05400 
05401 <span class="preprocessor">#if defined (_X86PAE_)</span>
05402 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a15">MiNoLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05403         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/procsup_8c.html#a28">MiFreeLowMemory</a> (BaseAddress, 'tnoC') == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05404             <span class="keywordflow">return</span>;
05405         }
05406     }
05407 <span class="preprocessor">#endif</span>
05408 <span class="preprocessor"></span>
05409     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (BaseAddress);
05410 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a296" doxytag="mm.h::MmFreeContiguousMemorySpecifyCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmFreeContiguousMemorySpecifyCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CacheType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05414">5414</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d4/d5/procsup_8c.html#a28">MiFreeLowMemory()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00141">MiNoLowMemory</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00063">MmNonPagedSystemStart</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00079">MmNumberOfSystemPtes</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03678">MmUnmapIoSpace()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
<pre class="fragment"><div>05422                    :
05423 
05424     This function deallocates a range of noncached memory in
05425     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-paged portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system address space.
05426 
05427 Arguments:
05428 
05429     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <span class="keyword">virtual</span> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> noncached
05430 
05431     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes allocated to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.
05432                     This must be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same number that was obtained with
05433                     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d1/mm_8h.html#a294">MmAllocateContiguousMemorySpecifyCache</a> call.
05434 
05435     CacheType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cachetype used when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05436                 <a class="code" href="../../d2/d1/mm_8h.html#a294">MmAllocateContiguousMemorySpecifyCache</a> call.
05437 
05438 Return Value:
05439 
05440     None.
05441 
05442 Environment:
05443 
05444     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
05445 
05446 --*/
05447 
05448 {
05449     PVOID PoolAddress;
05450     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05451 
05452     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05453 
05454     <span class="keywordflow">if</span> (CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) {
05455 
05456         <span class="comment">//</span>
05457         <span class="comment">// The caller was using an alternate mapping - free these PTEs too.</span>
05458         <span class="comment">//</span>
05459 
05460         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(BaseAddress);
05461 
05462         PointerPte += ((NumberOfBytes + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
05463         PoolAddress = (PVOID)(ULONG_PTR)PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
05464 
05465         PointerPte += 1;
05466         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes == PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
05467 
05468         NumberOfBytes += (2 * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
05469         <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a> (BaseAddress, NumberOfBytes);
05470         BaseAddress = PoolAddress;
05471     }
05472     <span class="keywordflow">else</span> {
05473         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (BaseAddress &lt; MmNonPagedSystemStart ||
05474                 BaseAddress &gt;= (PVOID)((PCHAR)MmNonPagedSystemStart + (MmNumberOfSystemPtes &lt;&lt; PAGE_SHIFT)));
05475     }
05476 
05477 <span class="preprocessor">#if defined (_X86PAE_)</span>
05478 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a15">MiNoLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05479         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/procsup_8c.html#a28">MiFreeLowMemory</a> (BaseAddress, 'tnoC') == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05480             <span class="keywordflow">return</span>;
05481         }
05482     }
05483 <span class="preprocessor">#endif</span>
05484 <span class="preprocessor"></span>
05485     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (BaseAddress);
05486 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a232" doxytag="mm.h::MmFreeDriverInitialization" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmFreeDriverInitialization           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Section</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l02106">2106</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05293">MI_IS_SESSION_ADDRESS</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">MiDeleteSystemPagableVm()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04308">MM_DBG_COMMIT_RETURN_DRIVER_INIT_CODE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00075">MmDriverCommit</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>.
<p>
<pre class="fragment"><div>02112                    :
02113 
02114     This routine removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages that relocate and debug information from
02115     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver.
02116 
02117     NOTE:  This routine looks at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last sections defined in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image
02118            header and <span class="keywordflow">if</span> that section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> marked as DISCARDABLE in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02119            characteristics, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image.  This means
02120            that all discardable sections at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver are
02121            deleted.
02122 
02123 Arguments:
02124 
02125     SectionObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image.
02126 
02127 Return Value:
02128 
02129     None.
02130 
02131 --*/
02132 
02133 {
02134     PLDR_DATA_TABLE_ENTRY DataTableEntry;
02135     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02136     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02137     PFN_NUMBER NumberOfPtes;
02138     PVOID Base;
02139     ULONG i;
02140     PIMAGE_NT_HEADERS NtHeaders;
02141     PIMAGE_SECTION_HEADER NtSection;
02142     PIMAGE_SECTION_HEADER FoundSection;
02143     PFN_NUMBER PagesDeleted;
02144 
02145     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
02146     DataTableEntry = (PLDR_DATA_TABLE_ENTRY)ImageHandle;
02147     Base = DataTableEntry-&gt;DllBase;
02148 
02149     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_IS_SESSION_ADDRESS (Base) == FALSE);
02150 
02151     NumberOfPtes = DataTableEntry-&gt;SizeOfImage &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
02152     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Base) + NumberOfPtes;
02153 
02154     NtHeaders = (PIMAGE_NT_HEADERS)<a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Base);
02155 
02156     NtSection = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeaders +
02157                         <span class="keyword">sizeof</span>(ULONG) +
02158                         <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
02159                         NtHeaders-&gt;FileHeader.SizeOfOptionalHeader
02160                         );
02161 
02162     NtSection += NtHeaders-&gt;FileHeader.NumberOfSections;
02163 
02164     FoundSection = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02165     <span class="keywordflow">for</span> (i = 0; i &lt; NtHeaders-&gt;FileHeader.NumberOfSections; i += 1) {
02166         NtSection -= 1;
02167         <span class="keywordflow">if</span> ((NtSection-&gt;Characteristics &amp; IMAGE_SCN_MEM_DISCARDABLE) != 0) {
02168             FoundSection = NtSection;
02169         } <span class="keywordflow">else</span> {
02170 
02171             <span class="comment">//</span>
02172             <span class="comment">// There was a non discardable section between the this</span>
02173             <span class="comment">// section and the last non discardable section, don't</span>
02174             <span class="comment">// discard this section and don't look any more.</span>
02175             <span class="comment">//</span>
02176 
02177             <span class="keywordflow">break</span>;
02178         }
02179     }
02180 
02181     <span class="keywordflow">if</span> (FoundSection != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02182 
02183         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (ROUND_TO_PAGES (
02184                                     (PCHAR)Base + FoundSection-&gt;VirtualAddress));
02185         NumberOfPtes = (PFN_NUMBER)(LastPte - PointerPte);
02186 
02187         PagesDeleted = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (PointerPte,
02188                                                 NumberOfPtes,
02189                                                 ZeroKernelPte,
02190                                                 FALSE,
02191                                                 NULL);
02192 
02193         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += PagesDeleted;
02194         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(18, PagesDeleted);
02195         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (PagesDeleted);
02196         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_DRIVER_INIT_CODE, PagesDeleted);
02197         <a class="code" href="../../d8/d5/kddata_8c.html#a32">MmDriverCommit</a> -= (ULONG)PagesDeleted;
02198 <span class="preprocessor">#if DBG</span>
02199 <span class="preprocessor"></span>        MiPagesConsumed -= PagesDeleted;
02200 <span class="preprocessor">#endif</span>
02201 <span class="preprocessor"></span>    }
02202 
02203     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
02204     <span class="keywordflow">return</span>;
02205 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a188" doxytag="mm.h::MmFreeLoaderBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmFreeLoaderBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/mminit_8c-source.html#l02005">2005</a> of file <a class="el" href="../../d6/d0/mminit_8c-source.html">mminit.c</a>.
<p>
References <a class="el" href="../../d2/d8/arc_8h-source.html#l01701">_MEMORY_ALLOCATION_DESCRIPTOR::BasePage</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00591">KSEG0_BASE</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01699">_MEMORY_ALLOCATION_DESCRIPTOR::ListEntry</a>, <a class="el" href="../../d1/d9/arc_8h.html#a320a275">LoaderNlsData</a>, <a class="el" href="../../d1/d9/arc_8h.html#a320a261">LoaderOsloaderHeap</a>, <a class="el" href="../../d1/d9/arc_8h.html#a320a273">LoaderRegistryData</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01700">_MEMORY_ALLOCATION_DESCRIPTOR::MemoryType</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02757">MiDecrementShareCountOnly</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00118">MM_MAX_LOADER_BLOCKS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00029">MmVirtualBias</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01702">_MEMORY_ALLOCATION_DESCRIPTOR::PageCount</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00282">PTE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
<pre class="fragment"><div>02011                    :
02012 
02013     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last routine in phase 1 initialization.
02014     It frees memory used by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OsLoader.
02015 
02016 Arguments:
02017 
02018     LoadBlock - Supplies a pointer <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system loader block.
02019 
02020 Return Value:
02021 
02022     None.
02023 
02024 Environment:
02025 
02026     Kernel Mode Only.  System initialization.
02027 
02028 --*/
02029 
02030 {
02031 
02032     PLIST_ENTRY NextMd;
02033     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Pde;
02034     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> MemoryDescriptor;
02035     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a> SavedDescriptor[<a class="code" href="../../d5/d1/mminit_8c.html#a0">MM_MAX_LOADER_BLOCKS</a>];
02036     PFN_NUMBER i;
02037     PFN_NUMBER NextPhysicalPage;
02038     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02039     LONG BlockNumber = -1;
02040     KIRQL OldIrql;
02041 
02042     <span class="comment">//</span>
02043     <span class="comment">//</span>
02044     <span class="comment">// Walk through the memory descriptors and add pages to the</span>
02045     <span class="comment">// free list in the PFN database.</span>
02046     <span class="comment">//</span>
02047 
02048     NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
02049 
02050     <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
02051 
02052         MemoryDescriptor = CONTAINING_RECORD(NextMd,
02053                                              <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
02054                                              ListEntry);
02055 
02056 
02057         <span class="keywordflow">switch</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a>) {
02058             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a261">LoaderOsloaderHeap</a>:
02059             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a273">LoaderRegistryData</a>:
02060             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a275">LoaderNlsData</a>:
02061             <span class="comment">//case LoaderMemoryData:  //this has page table and other stuff.</span>
02062 
02063                 <span class="comment">//</span>
02064                 <span class="comment">// Capture the data to temporary storage so we won't</span>
02065                 <span class="comment">// free memory we are referencing.  Coalesce it if</span>
02066                 <span class="comment">// the blocks are adjacent and of the same type.</span>
02067                 <span class="comment">//</span>
02068 
02069                 <span class="keywordflow">if</span> (BlockNumber != -1 &amp;&amp;
02070                     MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == SavedDescriptor[BlockNumber].<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> &amp;&amp;
02071                     MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> == SavedDescriptor[BlockNumber].<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + SavedDescriptor[BlockNumber].<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>) {
02072 
02073                         <span class="comment">//</span>
02074                         <span class="comment">// these blocks are adjacent - merge them</span>
02075                         <span class="comment">//</span>
02076 
02077                         SavedDescriptor[BlockNumber].<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> += MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
02078                 }
02079                 <span class="keywordflow">else</span> {
02080                     BlockNumber += 1;
02081                     <span class="keywordflow">if</span> (BlockNumber &gt;= <a class="code" href="../../d5/d1/mminit_8c.html#a0">MM_MAX_LOADER_BLOCKS</a>) {
02082                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT, 0, 0, 0, 0);
02083                     }
02084                     SavedDescriptor[BlockNumber] = *MemoryDescriptor;
02085                 }
02086 
02087                 <span class="keywordflow">break</span>;
02088 
02089             <span class="keywordflow">default</span>:
02090 
02091                 <span class="keywordflow">break</span>;
02092         }
02093 
02094         NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
02095     }
02096 
02097     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02098 
02099     <span class="keywordflow">while</span> (BlockNumber &gt;= 0) {
02100 
02101         i = SavedDescriptor[BlockNumber].<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
02102         NextPhysicalPage = SavedDescriptor[BlockNumber].BasePage;
02103 
02104         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (NextPhysicalPage);
02105         <span class="keywordflow">while</span> (i != 0) {
02106 
02107             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
02108                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink == 0) {
02109 
02110                     <span class="comment">//</span>
02111                     <span class="comment">// Set the PTE address to the physical page for</span>
02112                     <span class="comment">// virtual address alignment checking.</span>
02113                     <span class="comment">//</span>
02114 
02115                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> =
02116                                (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(NextPhysicalPage &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
02117                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
02118                                         NextPhysicalPage);
02119                 }
02120             } <span class="keywordflow">else</span> {
02121 
02122                 <span class="keywordflow">if</span> (NextPhysicalPage != 0) {
02123                     <span class="comment">//</span>
02124                     <span class="comment">// Remove PTE and insert into the free list.  If it is</span>
02125                     <span class="comment">// a physical address within the PFN database, the PTE</span>
02126                     <span class="comment">// element does not exist and therefore cannot be updated.</span>
02127                     <span class="comment">//</span>
02128 
02129                     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a> (
02130                             MiGetVirtualAddressMappedByPte (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>))) {
02131 
02132                         <span class="comment">//</span>
02133                         <span class="comment">// Not a physical address.</span>
02134                         <span class="comment">//</span>
02135 
02136                         *(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>) = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
02137                     }
02138 
02139                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
02140                     <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (NextPhysicalPage);
02141                 }
02142             }
02143 
02144             Pfn1++;
02145             i -= 1;
02146             NextPhysicalPage += 1;
02147         }
02148 
02149         BlockNumber -= 1;
02150     }
02151 
02152     <span class="comment">//</span>
02153     <span class="comment">// If the kernel has been biased to allow for 3gb of user address space,</span>
02154     <span class="comment">// then the first 16mb of memory is doubly mapped to KSEG0_BASE and to</span>
02155     <span class="comment">// ALTERNATE_BASE. Therefore, the KSEG0_BASE entries must be unmapped.</span>
02156     <span class="comment">//</span>
02157 
02158 <span class="preprocessor">#if defined(_X86_)</span>
02159 <span class="preprocessor"></span>
02160     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> != 0) {
02161         Pde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(KSEG0_BASE);
02162         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (Pde, ZeroKernelPte);
02163         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (Pde + 1, ZeroKernelPte);
02164         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (Pde + 2, ZeroKernelPte);
02165         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (Pde + 3, ZeroKernelPte);
02166 
02167 <span class="preprocessor">#if defined(_X86PAE_)</span>
02168 <span class="preprocessor"></span>        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (Pde + 4, ZeroKernelPte);
02169         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (Pde + 5, ZeroKernelPte);
02170         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (Pde + 6, ZeroKernelPte);
02171         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (Pde + 7, ZeroKernelPte);
02172 <span class="preprocessor">#endif</span>
02173 <span class="preprocessor"></span>
02174     }
02175 
02176 <span class="preprocessor">#endif</span>
02177 <span class="preprocessor"></span>
02178     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (TRUE, TRUE);
02179     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02180     <span class="keywordflow">return</span>;
02181 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a301" doxytag="mm.h::MmFreeNonCachedMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmFreeNonCachedMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05721">5721</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02099">MI_MAKING_MULTIPLE_PTES_INVALID</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02757">MiDecrementShareCountOnly</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04289">MM_DBG_COMMIT_RETURN_NONCACHED_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
<pre class="fragment"><div>05728                    :
05729 
05730     This function deallocates a range of noncached memory in
05731     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-paged portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system address space.
05732 
05733 Arguments:
05734 
05735     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <span class="keyword">virtual</span> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> noncached
05736                   memory resides.
05737 
05738     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes allocated to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.
05739                     This must be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same number that was obtained with
05740                     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d1/mm_8h.html#a300">MmAllocateNonCachedMemory</a> call.
05741 
05742 Return Value:
05743 
05744     None.
05745 
05746 Environment:
05747 
05748     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
05749 
05750 --*/
05751 
05752 {
05753 
05754     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05755     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
05756     PFN_NUMBER NumberOfPages;
05757     PFN_NUMBER i;
05758     PFN_NUMBER PageFrameIndex;
05759     KIRQL OldIrql;
05760 
05761     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes != 0);
05762     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PAGE_ALIGN (BaseAddress) == BaseAddress);
05763 
05764     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a173">MI_MAKING_MULTIPLE_PTES_INVALID</a> (TRUE);
05765 
05766     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(NumberOfBytes);
05767 
05768     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
05769 
05770     i = NumberOfPages;
05771 
05772     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (ExPageLockHandle);
05773 
05774     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05775 
05776     <span class="keywordflow">do</span> {
05777 
05778         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
05779 
05780         <span class="comment">//</span>
05781         <span class="comment">// Mark the page for deletion when the reference count goes to zero.</span>
05782         <span class="comment">//</span>
05783 
05784         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
05785         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
05786         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
05787         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
05788         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
05789         PointerPte += 1;
05790         i -= 1;
05791     } <span class="keywordflow">while</span> (i != 0);
05792 
05793     PointerPte -= NumberOfPages;
05794 
05795     <span class="comment">//</span>
05796     <span class="comment">// Update the count of available resident pages.</span>
05797     <span class="comment">//</span>
05798 
05799     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += NumberOfPages;
05800     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(5, NumberOfPages);
05801 
05802     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05803 
05804     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
05805 
05806     <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte, (ULONG)NumberOfPages, SystemPteSpace);
05807 
05808     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (NumberOfPages);
05809     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_NONCACHED_PAGES, NumberOfPages);
05810 
05811     <span class="keywordflow">return</span>;
05812 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a285" doxytag="mm.h::MmFreePagesFromMdl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmFreePagesFromMdl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>MemoryDescriptorList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05051">5051</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00217">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00435">MDL_IO_SPACE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00434">MDL_PHYSICAL_VIEW</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00934">MI_IS_PFN_DELETED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01219">MI_MAGIC_AWE_PTEFRAME</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02099">MI_MAKING_MULTIPLE_PTES_INVALID</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01221">MI_PFN_IS_AWE</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04288">MM_DBG_COMMIT_RETURN_MDL_PAGES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00204">MmMdlPagesAllocated</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/physical_8c-source.html#l02313">MiCleanPhysicalProcessPages()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l00970">NtAllocateUserPhysicalPages()</a>, and <a class="el" href="../../d9/d4/physical_8c-source.html#l01624">NtFreeUserPhysicalPages()</a>.
<p>
<pre class="fragment"><div>05057                    :
05058 
05059     This routine walks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> argument <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> freeing each physical page back to
05060     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> designed to free pages acquired via
05061     <a class="code" href="../../d2/d1/mm_8h.html#a284">MmAllocatePagesForMdl</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.
05062 
05063 Arguments:
05064 
05065     MemoryDescriptorList - Supplies an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> which contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages to be freed.
05066 
05067 Return Value:
05068 
05069     None.
05070 
05071 Environment:
05072 
05073     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
05074 
05075 --*/
05076 {
05077     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
05078     KIRQL OldIrql;
05079     PVOID StartingAddress;
05080     PVOID AlignedVa;
05081     PPFN_NUMBER Page;
05082     PFN_NUMBER NumberOfPages;
05083     PFN_NUMBER PagesFreed;
05084 
05085     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt;= APC_LEVEL);
05086 
05087     PagesFreed = 0;
05088 
05089     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (ExPageLockHandle);
05090 
05091     Page = (PPFN_NUMBER)(MemoryDescriptorList + 1);
05092 
05093     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; (MDL_IO_SPACE | MDL_PHYSICAL_VIEW)) == 0);
05094 
05095     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG_PTR)MemoryDescriptorList-&gt;StartVa &amp; (PAGE_SIZE - 1)) == 0);
05096     AlignedVa = (PVOID)MemoryDescriptorList-&gt;StartVa;
05097 
05098     StartingAddress = (PVOID)((PCHAR)AlignedVa +
05099                     MemoryDescriptorList-&gt;ByteOffset);
05100 
05101     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>(StartingAddress,
05102                                               MemoryDescriptorList-&gt;ByteCount);
05103 
05104     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a173">MI_MAKING_MULTIPLE_PTES_INVALID</a> (TRUE);
05105 
05106     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05107 
05108     <span class="keywordflow">do</span> {
05109 
05110         <span class="keywordflow">if</span> (*Page == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
05111 
05112             <span class="comment">//</span>
05113             <span class="comment">// There are no more locked pages.</span>
05114             <span class="comment">//</span>
05115 
05116             <span class="keywordflow">break</span>;
05117         }
05118 
05119         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (*Page &lt;= MmHighestPhysicalPage);
05120 
05121         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
05122         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
05123         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_IS_PFN_DELETED (Pfn1) == TRUE);
05124         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_PFN_IS_AWE (Pfn1) == TRUE);
05125         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> == MI_MAGIC_AWE_PTEFRAME);
05126 
05127         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 0;
05128         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 0;
05129         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
05130 <span class="preprocessor">#if DBG</span>
05131 <span class="preprocessor"></span>        Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> -= 1;
05132         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
05133 <span class="preprocessor">#endif</span>
05134 <span class="preprocessor"></span>
05135         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (*Page);
05136 
05137         PagesFreed += 1;
05138 
05139         StartingAddress = (PVOID)((PCHAR)StartingAddress + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
05140 
05141         *Page++ = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
05142         NumberOfPages -= 1;
05143 
05144     } <span class="keywordflow">while</span> (NumberOfPages != 0);
05145 
05146     <a class="code" href="../../d5/d6/iosup_8c.html#a17">MmMdlPagesAllocated</a> -= PagesFreed;
05147 
05148     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += PagesFreed;
05149     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(35, PagesFreed);
05150 
05151     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05152 
05153     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
05154 
05155     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (PagesFreed);
05156     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_MDL_PAGES, PagesFreed);
05157 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a320" doxytag="mm.h::MmFreeSpecialPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmFreeSpecialPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>P</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03742">3742</a> of file <a class="el" href="../../d2/d5/allocpag_8c-source.html">allocpag.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00182">KeQueryTickCount()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04225">MI_FREED_SPECIAL_POOL_SIGNATURE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00065">MI_SPECIAL_POOL_PAGABLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00068">MI_SPECIAL_POOL_PTE_NONPAGABLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00067">MI_SPECIAL_POOL_PTE_PAGABLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00066">MI_SPECIAL_POOL_VERIFIER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04227">MI_STACK_BYTES</a>, <a class="el" href="../../d4/d8/mi_8h.html#a550">MI_VERIFIER_POOL_HEADER</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">MiDeleteSystemPagableVm()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02912">MiSpecialPagesNonPaged</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02913">MiSpecialPagesPagable</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02910">MiSpecialPoolLastPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00108">MM_EMPTY_PTE_LIST</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00431">MM_KERNEL_NOACCESS_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00145">MM_NOACCESS</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02914">MmSpecialPagesInUse</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04806">MmSystemPteBase</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00081">NoAccessPte</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04235">_MI_FREED_SPECIAL_POOL::NumberOfBytesRequested</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04236">_MI_FREED_SPECIAL_POOL::Pagable</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d4/d8/mi_8h.html#a559">PMI_FREED_SPECIAL_POOL</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00116">POOL_OVERHEAD</a>, <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04233">_MI_FREED_SPECIAL_POOL::Signature</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04240">_MI_FREED_SPECIAL_POOL::StackBytes</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04243">_MI_FREED_SPECIAL_POOL::StackData</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04239">_MI_FREED_SPECIAL_POOL::StackPointer</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04241">_MI_FREED_SPECIAL_POOL::Thread</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04234">_MI_FREED_SPECIAL_POOL::TickCount</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a91">VerifierFreeTrackedPool()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04238">_MI_FREED_SPECIAL_POOL::VirtualAddress</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
<pre class="fragment"><div>03748                    :
03749 
03750     This routine frees a special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocation.  The backing page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed
03751     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping <span class="keyword">virtual</span> address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> no access (the next <span class="keyword">virtual</span>
03752     address is already no access).
03753 
03754     The <span class="keyword">virtual</span> address PTE pair <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> then placed into an LRU queue to provide
03755     maximum no-access (protection) life to catch components that access
03756     deallocated pool.
03757 
03758 Arguments:
03759 
03760     VirtualAddress - Supplies the special pool virtual address to free.
03761 
03762 Return Value:
03763 
03764     None.
03765 
03766 Environment:
03767 
03768     Kernel mode, no locks (not even pool locks) held.
03769 
03770 --*/
03771 
03772 {
03773     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
03774     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03775     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03776     KIRQL OldIrql;
03777     ULONG SlopBytes;
03778     ULONG NumberOfBytesCalculated;
03779     ULONG NumberOfBytesRequested;
03780     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType;
03781     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a13">NoAccessPte</a>;
03782     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
03783     PUCHAR Slop;
03784     ULONG i;
03785     LOGICAL BufferAtPageEnd;
03786     <a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html">PMI_FREED_SPECIAL_POOL</a> AllocationBase;
03787     LARGE_INTEGER CurrentTime;
03788     PULONG_PTR StackPointer;
03789 
03790     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (P);
03791     PteContents = *PointerPte;
03792 
03793     <span class="comment">//</span>
03794     <span class="comment">// Check the PTE now so we can give a more friendly bugcheck rather than</span>
03795     <span class="comment">// crashing below on a bad reference.</span>
03796     <span class="comment">//</span>
03797 
03798     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03799         <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection == 0) ||
03800             (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>)) {
03801             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SPECIAL_POOL_DETECTED_MEMORY_CORRUPTION,
03802                           (ULONG_PTR)P,
03803                           (ULONG_PTR)PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
03804                           0,
03805                           0x20);
03806         }
03807     }
03808 
03809     <span class="keywordflow">if</span> (((ULONG_PTR)P &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1))) {
03810         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (P);
03811         BufferAtPageEnd = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03812     }
03813     <span class="keywordflow">else</span> {
03814         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (P) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
03815         BufferAtPageEnd = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03816     }
03817 
03818     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Ulong1 &amp; <a class="code" href="../../d4/d8/mi_8h.html#a2">MI_SPECIAL_POOL_PAGABLE</a>) {
03819         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PointerPte + 1)-&gt;u.Soft.PageFileHigh == MI_SPECIAL_POOL_PTE_PAGABLE);
03820         <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
03821             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SPECIAL_POOL_DETECTED_MEMORY_CORRUPTION,
03822                           KeGetCurrentIrql(),
03823                           PagedPool,
03824                           (ULONG_PTR)P,
03825                           0x31);
03826         }
03827         PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
03828     }
03829     <span class="keywordflow">else</span> {
03830         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PointerPte + 1)-&gt;u.Soft.PageFileHigh == MI_SPECIAL_POOL_PTE_NONPAGABLE);
03831         <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
03832             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SPECIAL_POOL_DETECTED_MEMORY_CORRUPTION,
03833                           KeGetCurrentIrql(),
03834                           NonPagedPool,
03835                           (ULONG_PTR)P,
03836                           0x31);
03837         }
03838         PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
03839     }
03840 
03841     NumberOfBytesRequested = (ULONG)(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Ulong1 &amp; ~(<a class="code" href="../../d4/d8/mi_8h.html#a2">MI_SPECIAL_POOL_PAGABLE</a> | <a class="code" href="../../d4/d8/mi_8h.html#a3">MI_SPECIAL_POOL_VERIFIER</a>));
03842 
03843     <span class="comment">//</span>
03844     <span class="comment">// We gave the caller pool-header aligned data, so account for</span>
03845     <span class="comment">// that when checking here.</span>
03846     <span class="comment">//</span>
03847 
03848     <span class="keywordflow">if</span> (BufferAtPageEnd == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03849 
03850         NumberOfBytesCalculated = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(P);
03851     
03852         <span class="keywordflow">if</span> (NumberOfBytesRequested &gt; NumberOfBytesCalculated) {
03853     
03854             <span class="comment">//</span>
03855             <span class="comment">// Seems like we didn't give the caller enough - this is an error.</span>
03856             <span class="comment">//</span>
03857     
03858             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SPECIAL_POOL_DETECTED_MEMORY_CORRUPTION,
03859                           (ULONG_PTR)P,
03860                           NumberOfBytesRequested,
03861                           NumberOfBytesCalculated,
03862                           0x21);
03863         }
03864     
03865         <span class="keywordflow">if</span> (NumberOfBytesRequested + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a> &lt; NumberOfBytesCalculated) {
03866     
03867             <span class="comment">//</span>
03868             <span class="comment">// Seems like we gave the caller too much - also an error.</span>
03869             <span class="comment">//</span>
03870     
03871             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SPECIAL_POOL_DETECTED_MEMORY_CORRUPTION,
03872                           (ULONG_PTR)P,
03873                           NumberOfBytesRequested,
03874                           NumberOfBytesCalculated,
03875                           0x22);
03876         }
03877 
03878         <span class="comment">//</span>
03879         <span class="comment">// Check the memory before the start of the caller's allocation.</span>
03880         <span class="comment">//</span>
03881     
03882         Slop = (PUCHAR)(<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> + 1);
03883         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Ulong1 &amp; <a class="code" href="../../d4/d8/mi_8h.html#a3">MI_SPECIAL_POOL_VERIFIER</a>) {
03884             Slop += <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">MI_VERIFIER_POOL_HEADER</a>);
03885         }
03886 
03887         <span class="keywordflow">for</span> ( ; Slop &lt; (PUCHAR)P; Slop += 1) {
03888     
03889             <span class="keywordflow">if</span> (*Slop != <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;BlockSize) {
03890     
03891                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SPECIAL_POOL_DETECTED_MEMORY_CORRUPTION,
03892                               (ULONG_PTR)P,
03893                               (ULONG_PTR)Slop,
03894                               <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Ulong1,
03895                               0x23);
03896             }
03897         }
03898     }
03899     <span class="keywordflow">else</span> {
03900         NumberOfBytesCalculated = 0;
03901     }
03902 
03903     <span class="comment">//</span>
03904     <span class="comment">// Check the memory after the end of the caller's allocation.</span>
03905     <span class="comment">//</span>
03906 
03907     Slop = (PUCHAR)P + NumberOfBytesRequested;
03908 
03909     SlopBytes = (ULONG)((PUCHAR)(<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(P)) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - Slop);
03910 
03911     <span class="keywordflow">if</span> (BufferAtPageEnd == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03912         SlopBytes -= <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>;
03913         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Ulong1 &amp; <a class="code" href="../../d4/d8/mi_8h.html#a3">MI_SPECIAL_POOL_VERIFIER</a>) {
03914             SlopBytes -= <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">MI_VERIFIER_POOL_HEADER</a>);
03915         }
03916     }
03917 
03918     <span class="keywordflow">for</span> (i = 0; i &lt; SlopBytes; i += 1) {
03919 
03920         <span class="keywordflow">if</span> (*Slop != <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;BlockSize) {
03921 
03922             <span class="comment">//</span>
03923             <span class="comment">// The caller wrote slop between the free alignment we gave and the</span>
03924             <span class="comment">// end of the page (this is not detectable from page protection).</span>
03925             <span class="comment">//</span>
03926     
03927             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SPECIAL_POOL_DETECTED_MEMORY_CORRUPTION,
03928                           (ULONG_PTR)P,
03929                           (ULONG_PTR)Slop,
03930                           <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Ulong1,
03931                           0x24);
03932         }
03933         Slop += 1;
03934     }
03935 
03936     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Ulong1 &amp; <a class="code" href="../../d4/d8/mi_8h.html#a3">MI_SPECIAL_POOL_VERIFIER</a>) {
03937         <a class="code" href="../../d9/d5/verifier_8c.html#a91">VerifierFreeTrackedPool</a> (P,
03938                                  NumberOfBytesRequested,
03939                                  PoolType,
03940                                  TRUE);
03941     }
03942 
03943     AllocationBase = (<a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html">PMI_FREED_SPECIAL_POOL</a>)(<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (P));
03944 
03945     AllocationBase-&gt;<a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o2">Signature</a> = <a class="code" href="../../d4/d8/mi_8h.html#a255">MI_FREED_SPECIAL_POOL_SIGNATURE</a>;
03946 
03947     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a4">KeQueryTickCount</a>(&amp;CurrentTime);
03948     AllocationBase-&gt;<a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o3">TickCount</a> = CurrentTime.LowPart;
03949 
03950     AllocationBase-&gt;<a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o4">NumberOfBytesRequested</a> = NumberOfBytesRequested;
03951     AllocationBase-&gt;<a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o5">Pagable</a> = (ULONG)PoolType;
03952     AllocationBase-&gt;<a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o6">VirtualAddress</a> = P;
03953     AllocationBase-&gt;<a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o9">Thread</a> = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
03954 
03955 <span class="preprocessor">#if defined (_X86_)</span>
03956 <span class="preprocessor"></span>    _asm {
03957         mov StackPointer, esp
03958     }
03959 
03960     AllocationBase-&gt;<a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o7">StackPointer</a> = StackPointer;
03961 
03962     <span class="comment">//</span>
03963     <span class="comment">// For now, don't get fancy with copying more than what's in the current</span>
03964     <span class="comment">// stack page.  To do so would require checking the thread stack limits,</span>
03965     <span class="comment">// DPC stack limits, etc.</span>
03966     <span class="comment">//</span>
03967 
03968     AllocationBase-&gt;<a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o8">StackBytes</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(StackPointer);
03969 
03970     <span class="keywordflow">if</span> (AllocationBase-&gt;<a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o8">StackBytes</a> != 0) {
03971 
03972         <span class="keywordflow">if</span> (AllocationBase-&gt;<a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o8">StackBytes</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a256">MI_STACK_BYTES</a>) {
03973             AllocationBase-&gt;<a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o8">StackBytes</a> = <a class="code" href="../../d4/d8/mi_8h.html#a256">MI_STACK_BYTES</a>;
03974         }
03975 
03976         RtlCopyMemory (AllocationBase-&gt;<a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o10">StackData</a>,
03977                        StackPointer,
03978                        AllocationBase-&gt;<a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o8">StackBytes</a>);
03979     }
03980 <span class="preprocessor">#else</span>
03981 <span class="preprocessor"></span>    AllocationBase-&gt;<a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o7">StackPointer</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03982     AllocationBase-&gt;<a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o8">StackBytes</a> = 0;
03983 <span class="preprocessor">#endif</span>
03984 <span class="preprocessor"></span>
03985     <span class="keywordflow">if</span> (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
03986         <a class="code" href="../../d4/d2/datalpha_8c.html#a13">NoAccessPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a97">MM_KERNEL_NOACCESS_PTE</a>;
03987         <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (PointerPte,
03988                                  1,
03989                                  NoAccessPte,
03990                                  FALSE,
03991                                  NULL);
03992         <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
03993         <a class="code" href="../../d1/d6/allocpag_8c.html#a20">MiSpecialPagesPagable</a> -= 1;
03994     }
03995     <span class="keywordflow">else</span> {
03996 
03997         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;u.Hard.PageFrameNumber);
03998         <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
03999         <a class="code" href="../../d1/d6/allocpag_8c.html#a19">MiSpecialPagesNonPaged</a> -= 1;
04000         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
04001         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPte));
04002         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(P),
04003                          TRUE,
04004                          TRUE,
04005                          (PHARDWARE_PTE)PointerPte,
04006                          <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
04007         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += 1;
04008         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(37, 1);
04009     }
04010 
04011     <span class="comment">// </span>
04012     <span class="comment">// Clear the adjacent PTE to support MmIsSpecialPoolAddressFree().</span>
04013     <span class="comment">// </span>
04014 
04015     (PointerPte + 1)-&gt;u.Long = 0;
04016 
04017     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d6/allocpag_8c.html#a18">MiSpecialPoolLastPte</a>-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry == MM_EMPTY_PTE_LIST);
04018     <a class="code" href="../../d1/d6/allocpag_8c.html#a18">MiSpecialPoolLastPte</a>-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = PointerPte - <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a>;
04019 
04020     <a class="code" href="../../d1/d6/allocpag_8c.html#a18">MiSpecialPoolLastPte</a> = PointerPte;
04021     <a class="code" href="../../d1/d6/allocpag_8c.html#a18">MiSpecialPoolLastPte</a>-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>;
04022 
04023     <a class="code" href="../../d1/d6/allocpag_8c.html#a21">MmSpecialPagesInUse</a> -= 1;
04024 
04025     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
04026 
04027     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (1);
04028 
04029     <span class="keywordflow">return</span>;
04030 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a297" doxytag="mm.h::MmGatherMemoryForHibernate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI ULONG MmGatherMemoryForHibernate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mdl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07930">7930</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04555">MiDelayPageFaults</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02715">MiEmptyAllWorkingSets()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04870">MiFlushAllPages()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00217">Mm30Milliseconds</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00418">MM_DEMAND_ZERO_WRITE_PTE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
<pre class="fragment"><div>07937                    :
07938 
07939     Finds enough memory to fill in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <span class="keywordflow">for</span> power management
07940     hibernate function.
07941 
07942 Arguments:
07943 
07944     Mdl - Supplies an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start VA field should be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.  The length
07945           field indicates how many pages to obtain.
07946 
07947     Wait - <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> to fail immediately <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages aren'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> available.
07948 
07949 Return Value:
07950 
07951     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d9/ntosdef_8h.html#a58">MDL</a> could be filled in, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
07952 
07953 Environment:
07954 
07955     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
07956 
07957 --*/
07958 
07959 {
07960     KIRQL OldIrql;
07961     PFN_NUMBER PagesNeeded;
07962     PPFN_NUMBER Pages;
07963     PFN_NUMBER i;
07964     PFN_NUMBER PageFrameIndex;
07965     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
07966     ULONG status;
07967 
07968     status = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07969 
07970     PagesNeeded = Mdl-&gt;ByteCount &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
07971     Pages = (PPFN_NUMBER)(Mdl + 1);
07972 
07973     i = Wait ? 100 : 1;
07974 
07975     InterlockedIncrement (&amp;MiDelayPageFaults);
07976 
07977     <span class="keywordflow">do</span> {
07978 
07979         <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
07980         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; PagesNeeded) {
07981 
07982             <span class="comment">//</span>
07983             <span class="comment">// Fill in the MDL.</span>
07984             <span class="comment">//</span>
07985 
07986             <span class="keywordflow">do</span> {
07987                 PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (MI_GET_PAGE_COLOR_FROM_PTE (NULL));
07988                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
07989                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
07990                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
07991                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
07992                 *Pages = PageFrameIndex;
07993                 Pages += 1;
07994                 PagesNeeded -= 1;
07995             } <span class="keywordflow">while</span> (PagesNeeded);
07996             <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
07997             Mdl-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
07998             status = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07999             <span class="keywordflow">break</span>;
08000         }
08001 
08002         <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
08003 
08004         <span class="comment">//</span>
08005         <span class="comment">// If we're being called at DISPATCH_LEVEL we cannot move pages to</span>
08006         <span class="comment">// the standby list because mutexes must be acquired to do so.</span>
08007         <span class="comment">//</span>
08008 
08009         <span class="keywordflow">if</span> (OldIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
08010             <span class="keywordflow">break</span>;
08011         }
08012 
08013         <span class="keywordflow">if</span> (!i) {
08014             <span class="keywordflow">break</span>;
08015         }
08016 
08017         <span class="comment">//</span>
08018         <span class="comment">// Attempt to move pages to the standby list.</span>
08019         <span class="comment">//</span>
08020 
08021         <a class="code" href="../../d5/d0/wsmanage_8c.html#a47">MiEmptyAllWorkingSets</a> ();
08022         <a class="code" href="../../d6/d3/modwrite_8c.html#a57">MiFlushAllPages</a>();
08023 
08024         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode,
08025                                 FALSE,
08026                                 (PLARGE_INTEGER)&amp;Mm30Milliseconds);
08027         i -= 1;
08028 
08029     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
08030 
08031     InterlockedDecrement (&amp;MiDelayPageFaults);
08032 
08033     <span class="keywordflow">return</span> status;
08034 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a255" doxytag="mm.h::MmGetCrashDumpInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmGetCrashDumpInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSYSTEM_CRASH_DUMP_INFORMATION&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CrashInfo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01392">1392</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00083">MmCrashDumpSection</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>.
<p>
<pre class="fragment"><div>01398                    :
01399 
01400     This function checks to see <span class="keywordflow">if</span> a crash dump section exists and
01401     <span class="keywordflow">if</span> so creates a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section and returns that value
01402     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CrashDumpInformation structure.  Once <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01403     section has been created, no other references can be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>
01404     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> crash dump section, and when that handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> closed, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01405     crash dump section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deleted and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01406     available <span class="keywordflow">for</span> reuse.
01407 
01408 Arguments:
01409 
01410     CrashInfo - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> crash dump information
01411                 structure.
01412 
01413 Return Value:
01414 
01415     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> handle value of zero indicates no
01416     crash dump was located.
01417 
01418 --*/
01419 
01420 {
01421     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01422     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
01423 
01424     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01425 
01426     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01427         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = 0;
01428         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01429     } <span class="keywordflow">else</span> {
01430         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a> (MmCrashDumpSection,
01431                                  NULL,
01432                                  SECTION_MAP_READ,
01433                                  0,
01434                                  (PVOID *)NULL,
01435                                  &amp;Handle);
01436         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01437 
01438             <span class="comment">//</span>
01439             <span class="comment">// One shot operation.</span>
01440             <span class="comment">//</span>
01441 
01442             <a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01443         }
01444     }
01445 
01446     CrashInfo-&gt;CrashDumpSection = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
01447     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01448 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a256" doxytag="mm.h::MmGetCrashDumpStateInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmGetCrashDumpStateInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSYSTEM_CRASH_STATE_INFORMATION&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CrashInfo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01452">1452</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00083">MmCrashDumpSection</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>.
<p>
<pre class="fragment"><div>01458                    :
01459 
01460     This function checks to see <span class="keywordflow">if</span> a crash dump section exists and
01461     returns a BOOLEAN value in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CrashStateInformation structure
01462     based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> outcome.
01463 
01464 Arguments:
01465 
01466     CrashInfo - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> crash dump state information
01467                 structure.
01468 
01469 Return Value:
01470 
01471     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> BOOLEAN value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates no
01472     crash dump was located.
01473 
01474 --*/
01475 
01476 {
01477     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01478 
01479     CrashInfo-&gt;ValidCrashDump = (<a class="code" href="../../d6/d3/modwrite_8c.html#a11">MmCrashDumpSection</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01480     <span class="keywordflow">return</span> STATUS_SUCCESS;
01481 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a244" doxytag="mm.h::MmGetFileNameForSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmGetFileNameForSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Section</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FileName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01721">1721</a> of file <a class="el" href="../../d6/d4/sectsup_8c-source.html">sectsup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00381">MmSectionObjectType</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00713">ObQueryNameString()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00246">RtlUnicodeStringToAnsiString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d5/sectsup_8c.html#a0">xMAX_NAME</a>.
<p>
Referenced by <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00211">DbgkCreateThread()</a>, and <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00136">DbgkpSectionHandleToFileHandle()</a>.
<p>
<pre class="fragment"><div>01728                    :
01729 
01730     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding section.
01731 
01732 Arguments:
01733 
01734     Section - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section to get <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of.
01735 
01736     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding section.
01737 
01738 Return Value:
01739 
01740     TBS
01741 
01742 Environment:
01743 
01744     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below, no mutexes held.
01745 
01746 --*/
01747 
01748 {
01749 
01750     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> SectionObject;
01751     POBJECT_NAME_INFORMATION FileNameInfo;
01752     ULONG whocares;
01753     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01754     ULONG Dereference;
01755 
01756     Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01757 
01758 <span class="preprocessor">#define xMAX_NAME 1024</span>
01759 <span class="preprocessor"></span>
01760     <span class="keywordflow">if</span> ( (ULONG_PTR)Section &amp; 1 ) {
01761         SectionObject = (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)((ULONG_PTR)Section &amp; ~1);
01762         Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01763     } <span class="keywordflow">else</span> {
01764         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( Section,
01765                                              0,
01766                                              MmSectionObjectType,
01767                                              KernelMode,
01768                                              (PVOID *)&amp;SectionObject,
01769                                              NULL );
01770 
01771         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01772             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01773         }
01774     }
01775 
01776     <span class="keywordflow">if</span> (SectionObject-&gt;u.Flags.Image == 0) {
01777         <span class="keywordflow">if</span> ( Dereference )
01778             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SectionObject);
01779         <span class="keywordflow">return</span> STATUS_SECTION_NOT_IMAGE;
01780     }
01781 
01782     FileNameInfo = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool, xMAX_NAME, '  mM');
01783 
01784     <span class="keywordflow">if</span> ( !FileNameInfo ) {
01785         <span class="keywordflow">if</span> ( Dereference )
01786             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SectionObject);
01787         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01788     }
01789 
01790     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>(
01791                 SectionObject-&gt;Segment-&gt;ControlArea-&gt;FilePointer,
01792                 FileNameInfo,
01793                 xMAX_NAME,
01794                 &amp;whocares
01795                 );
01796 
01797     <span class="keywordflow">if</span> ( Dereference )
01798         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (SectionObject);
01799 
01800     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01801         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(FileNameInfo);
01802         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01803     }
01804 
01805     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length = 0;
01806     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength = (FileNameInfo-&gt;Name.Length/<span class="keyword">sizeof</span>(WCHAR)) + 1;
01807     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool,
01808                                               <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength,
01809                                               '  mM');
01810     <span class="keywordflow">if</span> ( !<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer ) {
01811         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(FileNameInfo);
01812         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01813     }
01814     <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>((PANSI_STRING)FileName,&amp;FileNameInfo-&gt;Name,FALSE);
01815     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length] = <span class="charliteral">'\0'</span>;
01816     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(FileNameInfo);
01817 
01818     <span class="keywordflow">return</span> STATUS_SUCCESS;
01819 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a248" doxytag="mm.h::MmGetPageFileInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmGetPageFileInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04466">4466</a> of file <a class="el" href="../../d7/d2/modwrite_8c-source.html">modwrite.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02554">_MMPAGING_FILE::CurrentUsage</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00056">MmNumberOfPagingFiles</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05083">MmPagingFile</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02561">_MMPAGING_FILE::PageFileName</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02555">_MMPAGING_FILE::PeakUsage</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l02550">_MMPAGING_FILE::Size</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>.
<p>
<pre class="fragment"><div>04474                    :
04475 
04476     This routine returns information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> currently active paging
04477     files.
04478 
04479 Arguments:
04480 
04481     SystemInformation - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> information.
04482 
04483     SystemInformationLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SystemInformation
04484                               buffer.
04485 
04486     Length - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> information placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04487              buffer.
04488 
04489 Return Value:
04490 
04491     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
04492 
04493 --*/
04494 
04495 {
04496     PSYSTEM_PAGEFILE_INFORMATION PageFileInfo;
04497     ULONG NextEntryOffset = 0;
04498     ULONG TotalSize = 0;
04499     ULONG i;
04500     UNICODE_STRING UserBufferPageFileName;
04501 
04502     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04503 
04504     *Length = 0;
04505     PageFileInfo = (PSYSTEM_PAGEFILE_INFORMATION)SystemInformation;
04506 
04507     PageFileInfo-&gt;TotalSize = 0;
04508 
04509     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>; i += 1) {
04510         PageFileInfo = (PSYSTEM_PAGEFILE_INFORMATION)(
04511                                 (PUCHAR)PageFileInfo + NextEntryOffset);
04512         NextEntryOffset = <span class="keyword">sizeof</span>(SYSTEM_PAGEFILE_INFORMATION);
04513         TotalSize += <span class="keyword">sizeof</span>(SYSTEM_PAGEFILE_INFORMATION);
04514 
04515         <span class="keywordflow">if</span> (TotalSize &gt; SystemInformationLength) {
04516             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
04517         }
04518 
04519         PageFileInfo-&gt;TotalSize = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>;
04520         PageFileInfo-&gt;TotalInUse = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o4">CurrentUsage</a>;
04521         PageFileInfo-&gt;PeakUsage = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o5">PeakUsage</a>;
04522 
04523         <span class="comment">//</span>
04524         <span class="comment">// The PageFileName portion of the UserBuffer must be saved locally</span>
04525         <span class="comment">// to protect against a malicious thread changing the contents.  This</span>
04526         <span class="comment">// is because we will reference the contents ourselves when the actual</span>
04527         <span class="comment">// string is copied out carefully below.</span>
04528         <span class="comment">//</span>
04529 
04530         UserBufferPageFileName.Length = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o11">PageFileName</a>.Length;
04531         UserBufferPageFileName.MaximumLength = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o11">PageFileName</a>.Length + <span class="keyword">sizeof</span>(WCHAR);
04532         UserBufferPageFileName.Buffer = (PWCHAR)(PageFileInfo + 1);
04533 
04534         PageFileInfo-&gt;PageFileName = UserBufferPageFileName;
04535 
04536         TotalSize += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a> (UserBufferPageFileName.MaximumLength,
04537                                <span class="keyword">sizeof</span>(ULONG));
04538         NextEntryOffset += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a> (UserBufferPageFileName.MaximumLength,
04539                                      <span class="keyword">sizeof</span>(ULONG));
04540 
04541         <span class="keywordflow">if</span> (TotalSize &gt; SystemInformationLength) {
04542             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
04543         }
04544 
04545         <span class="comment">//</span>
04546         <span class="comment">// Carefully reference the user buffer here.</span>
04547         <span class="comment">//</span>
04548 
04549         RtlMoveMemory(UserBufferPageFileName.Buffer,
04550                       MmPagingFile[i]-&gt;PageFileName.Buffer,
04551                       MmPagingFile[i]-&gt;PageFileName.Length);
04552         UserBufferPageFileName.Buffer[
04553                     <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[i]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o11">PageFileName</a>.Length/<span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
04554         PageFileInfo-&gt;NextEntryOffset = NextEntryOffset;
04555     }
04556     PageFileInfo-&gt;NextEntryOffset = 0;
04557     *Length = TotalSize;
04558     <span class="keywordflow">return</span> STATUS_SUCCESS;
04559 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a291" doxytag="mm.h::MmGetPhysicalAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI PHYSICAL_ADDRESS MmGetPhysicalAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BaseAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05490">5490</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02287">MI_CONVERT_PHYSICAL_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01128">ZERO_LARGE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02400">IoFreeDumpRange()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">IopInitializeDCB()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03759">IopMapVirtualToPhysicalMdl()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02291">IoSetDumpRange()</a>, <a class="el" href="../../d4/d8/4_2ia64_2kdtrap_8c-source.html#l00467">KdpStub()</a>, <a class="el" href="../../d7/d5/ia64_2allproc_8c-source.html#l00082">KeStartAllProcessors()</a>, <a class="el" href="../../d3/d0/largepag_8c-source.html#l00515">Ki386BuildIdentityBuffer()</a>, <a class="el" href="../../d3/d0/largepag_8c-source.html#l00482">Ki386ConvertPte()</a>, <a class="el" href="../../d3/d0/largepag_8c-source.html#l00054">Ki386CreateIdentityMap()</a>, <a class="el" href="../../d2/d1/mips_2buserror_8c-source.html#l00081">KiGetPhysicalAddress()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03744">MmAllocateContiguousMemorySpecifyCache()</a>, <a class="el" href="../../d5/d5/ppc_2debugsup_8c-source.html#l00078">MmDbgWriteCheck()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01503">MmHibernateInformation()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l05161">MmMapUserAddressesToPage()</a>.
<p>
<pre class="fragment"><div>05496                    :
05497 
05498     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding physical address <span class="keywordflow">for</span> a
05499     valid <span class="keyword">virtual</span> address.
05500 
05501 Arguments:
05502 
05503     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address <span class="keywordflow">for</span> which to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05504                   physical address.
05505 
05506 Return Value:
05507 
05508     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding physical address.
05509 
05510 Environment:
05511 
05512     Kernel mode.  Any IRQL level.
05513 
05514 --*/
05515 
05516 {
05517     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05518     PHYSICAL_ADDRESS PhysicalAddress;
05519 
05520     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(BaseAddress)) {
05521         PhysicalAddress.QuadPart = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (BaseAddress);
05522     } <span class="keywordflow">else</span> {
05523 
05524         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(BaseAddress);
05525 
05526         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
05527             KdPrint((<span class="stringliteral">"MM:MmGetPhysicalAddressFailed base address was %lx"</span>,
05528                       BaseAddress));
05529             <a class="code" href="../../d4/d8/mi_8h.html#a166">ZERO_LARGE</a> (PhysicalAddress);
05530             <span class="keywordflow">return</span> PhysicalAddress;
05531         }
05532         PhysicalAddress.QuadPart = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
05533     }
05534 
05535     PhysicalAddress.QuadPart = PhysicalAddress.QuadPart &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
05536     PhysicalAddress.LowPart += <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(BaseAddress);
05537 
05538     <span class="keywordflow">return</span> PhysicalAddress;
05539 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a283" doxytag="mm.h::MmGetPhysicalMemoryRanges" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI <a class="el" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">PPHYSICAL_MEMORY_RANGE</a> MmGetPhysicalMemoryRanges           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/dynmem_8c-source.html#l01032">1032</a> of file <a class="el" href="../../d0/d3/dynmem_8c-source.html">dynmem.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01476">_PHYSICAL_MEMORY_RANGE::BaseAddress</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00034">_PHYSICAL_MEMORY_RUN::BasePage</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00024">MmDynamicMemoryMutex</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">MmPhysicalMemoryBlock</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01477">_PHYSICAL_MEMORY_RANGE::NumberOfBytes</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00039">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfRuns</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00035">_PHYSICAL_MEMORY_RUN::PageCount</a>, <a class="el" href="../../d2/d2/ppcdef_8h-source.html#l00079">PASSIVE_LEVEL</a>, <a class="el" href="../../d2/d1/mm_8h.html#a155">PHYSICAL_MEMORY_RANGE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00041">_PHYSICAL_MEMORY_DESCRIPTOR::Run</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
<pre class="fragment"><div>01038                    :
01039 
01040     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address of a nonpaged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> block which
01041     contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical memory ranges in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
01042 
01043     The returned block contains physical address and page count pairs.
01044     The last entry contains zero <span class="keywordflow">for</span> both.
01045 
01046     The caller must understand that <span class="keyword">this</span> block can change at any point before
01047     or after <span class="keyword">this</span> snapshot.
01048 
01049     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's responsibility to free <span class="keyword">this</span> block.
01050 
01051 Arguments:
01052 
01053     None.
01054 
01055 Return Value:
01056 
01057     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
01058 
01059 Environment:
01060 
01061     Kernel mode.  PASSIVE level.  No locks held.
01062 
01063 --*/
01064 
01065 {
01066     ULONG i;
01067     KIRQL OldIrql;
01068     <a class="code" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">PPHYSICAL_MEMORY_RANGE</a> p;
01069     <a class="code" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">PPHYSICAL_MEMORY_RANGE</a> PhysicalMemoryBlock;
01070 
01071     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == PASSIVE_LEVEL);
01072 
01073     ExAcquireFastMutex (&amp;MmDynamicMemoryMutex);
01074 
01075     i = <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">PHYSICAL_MEMORY_RANGE</a>) * (<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> + 1);
01076 
01077     PhysicalMemoryBlock = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
01078                                                  i,
01079                                                  'hPmM');
01080 
01081     <span class="keywordflow">if</span> (PhysicalMemoryBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01082         ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
01083         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01084     }
01085 
01086     p = PhysicalMemoryBlock;
01087 
01088     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01089 
01090     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (i == (<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html">PHYSICAL_MEMORY_RANGE</a>) * (<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> + 1)));
01091 
01092     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>; i += 1) {
01093         p-&gt;<a class="code" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html#o0">BaseAddress</a>.QuadPart = (LONGLONG)<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01094         p-&gt;<a class="code" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html#o1">NumberOfBytes</a>.QuadPart = (LONGLONG)<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01095         p += 1;
01096     }
01097 
01098     p-&gt;<a class="code" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html#o0">BaseAddress</a>.QuadPart = 0;
01099     p-&gt;<a class="code" href="../../d4/d5/struct__PHYSICAL__MEMORY__RANGE.html#o1">NumberOfBytes</a>.QuadPart = 0;
01100 
01101     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01102 
01103     ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
01104 
01105     <span class="keywordflow">return</span> PhysicalMemoryBlock;
01106 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a333" doxytag="mm.h::MmGetSectionRange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmGetSectionRange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>AddressWithinSection</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingSectionAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SizeofSection</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l06797">6797</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06991">MiLookupDataTableEntry()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00583">PsLoadedModuleResource</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>06802 {
06803     PLDR_DATA_TABLE_ENTRY DataTableEntry;
06804     ULONG i;
06805     PIMAGE_NT_HEADERS NtHeaders;
06806     PIMAGE_SECTION_HEADER NtSection;
06807     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06808     ULONG_PTR Rva;
06809 
06810     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06811 
06812     <span class="comment">//</span>
06813     <span class="comment">// Search the loaded module list for the data table entry that describes</span>
06814     <span class="comment">// the DLL that was just unloaded. It is possible that an entry is not in</span>
06815     <span class="comment">// the list if a failure occurred at a point in loading the DLL just before</span>
06816     <span class="comment">// the data table entry was generated.</span>
06817     <span class="comment">//</span>
06818 
06819     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_FOUND;
06820 
06821     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
06822     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a> (&amp;PsLoadedModuleResource, TRUE);
06823 
06824     DataTableEntry = <a class="code" href="../../d4/d8/mi_8h.html#a874">MiLookupDataTableEntry</a> (AddressWithinSection, TRUE);
06825     <span class="keywordflow">if</span> (DataTableEntry) {
06826 
06827         Rva = (ULONG_PTR)((PUCHAR)AddressWithinSection - (ULONG_PTR)DataTableEntry-&gt;DllBase);
06828 
06829         NtHeaders = (PIMAGE_NT_HEADERS)<a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(DataTableEntry-&gt;DllBase);
06830 
06831         NtSection = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeaders +
06832                             <span class="keyword">sizeof</span>(ULONG) +
06833                             <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
06834                             NtHeaders-&gt;FileHeader.SizeOfOptionalHeader
06835                             );
06836 
06837         <span class="keywordflow">for</span> (i = 0; i &lt; NtHeaders-&gt;FileHeader.NumberOfSections; i += 1) {
06838 
06839             <span class="keywordflow">if</span> ( Rva &gt;= NtSection-&gt;VirtualAddress &amp;&amp;
06840                  Rva &lt; NtSection-&gt;VirtualAddress + NtSection-&gt;SizeOfRawData ) {
06841 
06842                 <span class="comment">//</span>
06843                 <span class="comment">// Found it</span>
06844                 <span class="comment">//</span>
06845 
06846                 *StartingSectionAddress = (PVOID)
06847                     ((PCHAR) DataTableEntry-&gt;DllBase + NtSection-&gt;VirtualAddress);
06848                 *SizeofSection = NtSection-&gt;SizeOfRawData;
06849                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
06850                 <span class="keywordflow">break</span>;
06851             }
06852 
06853             NtSection += 1;
06854         }
06855     }
06856 
06857     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;PsLoadedModuleResource);
06858     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
06859     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06860 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a277" doxytag="mm.h::MmGetSystemRoutineAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI PVOID MmGetSystemRoutineAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SystemRoutineName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l06808">6808</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l06928">MiFindExportedRoutineByName()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00215">MmShortTime</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d2/ppcdef_8h-source.html#l00079">PASSIVE_LEVEL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00583">PsLoadedModuleResource</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01249">RtlFreeAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00246">RtlUnicodeStringToAnsiString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>06814                    :
06815 
06816     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> argument function pointer <span class="keywordflow">if</span>
06817     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel or <a class="code" href="../../d0/d2/genxx_8h.html#a21">HAL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not.
06818 
06819 Arguments:
06820 
06821     SystemRoutineName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired routine.
06822 
06823 Return Value:
06824 
06825     Non-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> function pointer <span class="keywordflow">if</span> successful.  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> not.
06826 
06827 Environment:
06828 
06829     Kernel mode.
06830 
06831 --*/
06832 
06833 {
06834     ULONG AnsiLength;
06835     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06836     PLDR_DATA_TABLE_ENTRY DataTableEntry;
06837     ANSI_STRING AnsiString;
06838     PLIST_ENTRY NextEntry;
06839     UNICODE_STRING KernelString;
06840     UNICODE_STRING HalString;
06841     PVOID FunctionAddress;
06842     LOGICAL Found;
06843     ULONG EntriesChecked;
06844 
06845     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == PASSIVE_LEVEL);
06846 
06847     EntriesChecked = 0;
06848     FunctionAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06849 
06850     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;KernelString, L<span class="stringliteral">"ntoskrnl.exe"</span>);
06851     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;HalString, L<span class="stringliteral">"hal.dll"</span>);
06852 
06853     <span class="keywordflow">do</span> {
06854         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>( &amp;AnsiString,
06855                                                SystemRoutineName,
06856                                                TRUE );
06857     
06858         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status)) {
06859             <span class="keywordflow">break</span>;
06860         }
06861 
06862         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;MmShortTime);
06863 
06864     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
06865     
06866     <span class="comment">//</span>
06867     <span class="comment">// Arbitrary process context so prevent suspend APCs now.</span>
06868     <span class="comment">//</span>
06869 
06870     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
06871     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a> (&amp;PsLoadedModuleResource, TRUE);
06872 
06873     <span class="comment">//</span>
06874     <span class="comment">// Check only the kernel and the HAL for exports.</span>
06875     <span class="comment">//</span>
06876 
06877     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
06878     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
06879 
06880         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06881 
06882         DataTableEntry = CONTAINING_RECORD(NextEntry,
06883                                            LDR_DATA_TABLE_ENTRY,
06884                                            InLoadOrderLinks);
06885 
06886         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;KernelString,
06887                                    &amp;DataTableEntry-&gt;BaseDllName,
06888                                    TRUE)) {
06889 
06890             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06891             EntriesChecked += 1;
06892 
06893         }
06894         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a> (&amp;HalString,
06895                                         &amp;DataTableEntry-&gt;BaseDllName,
06896                                         TRUE)) {
06897 
06898             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06899             EntriesChecked += 1;
06900         }
06901 
06902         <span class="keywordflow">if</span> (Found == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06903 
06904             FunctionAddress = <a class="code" href="../../d8/d8/sysload_8c.html#a51">MiFindExportedRoutineByName</a> (DataTableEntry,
06905                                                            &amp;AnsiString);
06906 
06907             <span class="keywordflow">if</span> (FunctionAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06908                 <span class="keywordflow">break</span>;
06909             }
06910 
06911             <span class="keywordflow">if</span> (EntriesChecked == 2) {
06912                 <span class="keywordflow">break</span>;
06913             }
06914         }
06915 
06916         NextEntry = NextEntry-&gt;Flink;
06917     }
06918 
06919     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;PsLoadedModuleResource);
06920     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
06921 
06922     <a class="code" href="../../d6/d6/nls_8c.html#a35">RtlFreeAnsiString</a> (&amp;AnsiString);
06923 
06924     <span class="keywordflow">return</span> FunctionAddress;
06925 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a247" doxytag="mm.h::MmGetVerifierInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmGetVerifierInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/verifier_8c-source.html#l04046">4046</a> of file <a class="el" href="../../d0/d5/verifier_8c-source.html">verifier.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l04104">_MI_VERIFIER_DRIVER_ENTRY::BaseName</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04122">_MI_VERIFIER_DRIVER_ENTRY::CurrentNonPagedPoolAllocations</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04121">_MI_VERIFIER_DRIVER_ENTRY::CurrentPagedPoolAllocations</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04111">_MI_VERIFIER_DRIVER_ENTRY::Flags</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00178">KeReleaseMutant()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04101">_MI_VERIFIER_DRIVER_ENTRY::Loads</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04193">MiSuspectDriverList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00928">MmSystemLoadLock</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00097">MmVerifierData</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04127">_MI_VERIFIER_DRIVER_ENTRY::NonPagedBytes</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04126">_MI_VERIFIER_DRIVER_ENTRY::PagedBytes</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04129">_MI_VERIFIER_DRIVER_ENTRY::PeakNonPagedBytes</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04124">_MI_VERIFIER_DRIVER_ENTRY::PeakNonPagedPoolAllocations</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04128">_MI_VERIFIER_DRIVER_ENTRY::PeakPagedBytes</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04123">_MI_VERIFIER_DRIVER_ENTRY::PeakPagedPoolAllocations</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00049">ROUND_UP</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04102">_MI_VERIFIER_DRIVER_ENTRY::Unloads</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04108">VI_VERIFYING_DIRECTLY</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>.
<p>
<pre class="fragment"><div>04054                    :
04055 
04056     This routine returns information about drivers undergoing verification.
04057 
04058 Arguments:
04059 
04060     SystemInformation - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver verification information.
04061 
04062     SystemInformationLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SystemInformation
04063                               buffer.
04064 
04065     Length - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver verification <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> information
04066              placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
04067 
04068 Return Value:
04069 
04070     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
04071 
04072 Environment:
04073 
04074     The SystemInformation buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in user space and our caller has wrapped
04075     a <span class="keywordflow">try</span>-except around <span class="keyword">this</span> entire routine.  Capture any exceptions here and
04076     release resources accordingly.
04077 
04078 --*/
04079 
04080 {
04081     PSYSTEM_VERIFIER_INFORMATION UserVerifyBuffer;
04082     ULONG NextEntryOffset;
04083     ULONG TotalSize;
04084     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04085     PLIST_ENTRY NextEntry;
04086     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier;
04087     UNICODE_STRING UserBufferDriverName;
04088 
04089     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04090 
04091     NextEntryOffset = 0;
04092     TotalSize = 0;
04093 
04094     *Length = 0;
04095     UserVerifyBuffer = (PSYSTEM_VERIFIER_INFORMATION)SystemInformation;
04096 
04097     <span class="comment">//</span>
04098     <span class="comment">// Capture the number of verifying drivers and the relevant data while</span>
04099     <span class="comment">// synchronized.  Then return it to our caller.</span>
04100     <span class="comment">//</span>
04101 
04102     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04103 
04104     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
04105 
04106     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;MmSystemLoadLock,
04107                            WrVirtualMemory,
04108                            KernelMode,
04109                            FALSE,
04110                            (PLARGE_INTEGER)NULL);
04111 
04112     <span class="keywordflow">try</span> {
04113 
04114         NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a555">MiSuspectDriverList</a>.Flink;
04115         <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a555">MiSuspectDriverList</a>) {
04116 
04117             Verifier = CONTAINING_RECORD(NextEntry,
04118                                               <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">MI_VERIFIER_DRIVER_ENTRY</a>,
04119                                               Links);
04120 
04121             <span class="keywordflow">if</span> ((Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o6">Flags</a> &amp; <a class="code" href="../../d4/d8/mi_8h.html#a252">VI_VERIFYING_DIRECTLY</a>) == 0) {
04122                 NextEntry = NextEntry-&gt;Flink;
04123                 <span class="keywordflow">continue</span>;
04124             }
04125 
04126             UserVerifyBuffer = (PSYSTEM_VERIFIER_INFORMATION)(
04127                                     (PUCHAR)UserVerifyBuffer + NextEntryOffset);
04128             NextEntryOffset = <span class="keyword">sizeof</span>(SYSTEM_VERIFIER_INFORMATION);
04129             TotalSize += <span class="keyword">sizeof</span>(SYSTEM_VERIFIER_INFORMATION);
04130 
04131             <span class="keywordflow">if</span> (TotalSize &gt; SystemInformationLength) {
04132                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INFO_LENGTH_MISMATCH);
04133             }
04134 
04135             <span class="comment">//</span>
04136             <span class="comment">// This data is cumulative for all drivers.</span>
04137             <span class="comment">//</span>
04138 
04139             UserVerifyBuffer-&gt;Level = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level;
04140             UserVerifyBuffer-&gt;RaiseIrqls = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.RaiseIrqls;
04141             UserVerifyBuffer-&gt;AcquireSpinLocks = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AcquireSpinLocks;
04142 
04143             UserVerifyBuffer-&gt;UnTrackedPool = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.UnTrackedPool;
04144             UserVerifyBuffer-&gt;SynchronizeExecutions = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.SynchronizeExecutions;
04145 
04146             UserVerifyBuffer-&gt;AllocationsAttempted = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsAttempted;
04147             UserVerifyBuffer-&gt;AllocationsSucceeded = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsSucceeded;
04148             UserVerifyBuffer-&gt;AllocationsSucceededSpecialPool = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsSucceededSpecialPool;
04149             UserVerifyBuffer-&gt;AllocationsWithNoTag = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsWithNoTag;
04150 
04151             UserVerifyBuffer-&gt;TrimRequests = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.TrimRequests;
04152             UserVerifyBuffer-&gt;Trims = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Trims;
04153             UserVerifyBuffer-&gt;AllocationsFailed = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsFailed;
04154             UserVerifyBuffer-&gt;AllocationsFailedDeliberately = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.AllocationsFailedDeliberately;
04155 
04156             <span class="comment">//</span>
04157             <span class="comment">// This data is kept on a per-driver basis.</span>
04158             <span class="comment">//</span>
04159 
04160             UserVerifyBuffer-&gt;CurrentPagedPoolAllocations = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o14">CurrentPagedPoolAllocations</a>;
04161             UserVerifyBuffer-&gt;CurrentNonPagedPoolAllocations = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o15">CurrentNonPagedPoolAllocations</a>;
04162             UserVerifyBuffer-&gt;PeakPagedPoolAllocations = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o16">PeakPagedPoolAllocations</a>;
04163             UserVerifyBuffer-&gt;PeakNonPagedPoolAllocations = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o17">PeakNonPagedPoolAllocations</a>;
04164 
04165             UserVerifyBuffer-&gt;PagedPoolUsageInBytes = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o18">PagedBytes</a>;
04166             UserVerifyBuffer-&gt;NonPagedPoolUsageInBytes = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o19">NonPagedBytes</a>;
04167             UserVerifyBuffer-&gt;PeakPagedPoolUsageInBytes = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o20">PeakPagedBytes</a>;
04168             UserVerifyBuffer-&gt;PeakNonPagedPoolUsageInBytes = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o21">PeakNonPagedBytes</a>;
04169 
04170             UserVerifyBuffer-&gt;Loads = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o1">Loads</a>;
04171             UserVerifyBuffer-&gt;Unloads = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o2">Unloads</a>;
04172 
04173             <span class="comment">//</span>
04174             <span class="comment">// The DriverName portion of the UserVerifyBuffer must be saved</span>
04175             <span class="comment">// locally to protect against a malicious thread changing the</span>
04176             <span class="comment">// contents.  This is because we will reference the contents</span>
04177             <span class="comment">// ourselves when the actual string is copied out carefully below.</span>
04178             <span class="comment">//</span>
04179 
04180             UserBufferDriverName.Length = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>.Length;
04181             UserBufferDriverName.MaximumLength = Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>.Length + <span class="keyword">sizeof</span> (WCHAR);
04182             UserBufferDriverName.Buffer = (PWCHAR)(UserVerifyBuffer + 1);
04183 
04184             UserVerifyBuffer-&gt;DriverName = UserBufferDriverName;
04185 
04186             TotalSize += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a> (UserBufferDriverName.MaximumLength,
04187                                    <span class="keyword">sizeof</span>(ULONG));
04188             NextEntryOffset += <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a> (UserBufferDriverName.MaximumLength,
04189                                          <span class="keyword">sizeof</span>(ULONG));
04190 
04191             <span class="keywordflow">if</span> (TotalSize &gt; SystemInformationLength) {
04192                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INFO_LENGTH_MISMATCH);
04193             }
04194 
04195             <span class="comment">//</span>
04196             <span class="comment">// Carefully reference the UserVerifyBuffer here.</span>
04197             <span class="comment">//</span>
04198 
04199             RtlMoveMemory(UserBufferDriverName.Buffer,
04200                           Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>.Buffer,
04201                           Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>.Length);
04202 
04203             UserBufferDriverName.Buffer[
04204                         Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>.Length/<span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
04205             UserVerifyBuffer-&gt;NextEntryOffset = NextEntryOffset;
04206 
04207             NextEntry = NextEntry-&gt;Flink;
04208         }
04209     } except (EXCEPTION_EXECUTE_HANDLER) {
04210         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
04211     }
04212 
04213     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;MmSystemLoadLock, 1, FALSE, FALSE);
04214 
04215     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
04216 
04217     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_INFO_LENGTH_MISMATCH) {
04218         UserVerifyBuffer-&gt;NextEntryOffset = 0;
04219         *Length = TotalSize;
04220     }
04221 
04222     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04223 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a292" doxytag="mm.h::MmGetVirtualForPhysical" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI PVOID MmGetVirtualForPhysical           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PhysicalAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05542">5542</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l08083">MmSetKernelDumpRange()</a>.
<p>
<pre class="fragment"><div>05548                    :
05549 
05550     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding <span class="keyword">virtual</span> address <span class="keywordflow">for</span> a physical
05551     address whose primary <span class="keyword">virtual</span> address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in system space.
05552 
05553 Arguments:
05554 
05555     PhysicalAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical address <span class="keywordflow">for</span> which to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05556                   <span class="keyword">virtual</span> address.
05557 
05558 Return Value:
05559 
05560     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding <span class="keyword">virtual</span> address.
05561 
05562 Environment:
05563 
05564     Kernel mode.  Any IRQL level.
05565 
05566 --*/
05567 
05568 {
05569     PFN_NUMBER PageFrameIndex;
05570     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn;
05571 
05572     PageFrameIndex = (PFN_NUMBER)(PhysicalAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
05573 
05574     Pfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
05575 
05576     <span class="keywordflow">return</span> (PVOID)((PCHAR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>) +
05577                     <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a> (PhysicalAddress.LowPart));
05578 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a217" doxytag="mm.h::MmGrowKernelStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS MmGrowKernelStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CurrentStack</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l02921">2921</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00425">MM_KERNEL_DEMAND_ZERO_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00151">MM_KSTACK_OUTSWAPPED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00097">MmKernelStackResident</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02177">PERFINFO_GROW_STACK</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00667">_KTHREAD::StackBase</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00557">_KTHREAD::StackLimit</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
<pre class="fragment"><div>02927                    :
02928 
02929     This function attempts to grows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread's kernel stack
02930     such that there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always KERNEL_LARGE_STACK_COMMIT bytes below
02931     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current stack pointer.
02932 
02933 Arguments:
02934 
02935     CurrentStack - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current stack pointer.
02936 
02937 Return Value:
02938 
02939     STATUS_SUCCESS <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack was grown.
02940 
02941     STATUS_STACK_OVERFLOW <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> there was not enough space reserved
02942     <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> commitment.
02943 
02944     STATUS_NO_MEMORY <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> there was not enough physical memory
02945     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
02946 
02947 --*/
02948 
02949 {
02950     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> NewLimit;
02951     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StackLimit;
02952     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndStack;
02953     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
02954     PFN_NUMBER NumberOfPages;
02955     KIRQL OldIrql;
02956     PFN_NUMBER PageFrameIndex;
02957     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02958 
02959     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
02960     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((PCHAR)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o61">StackBase</a> - (PCHAR)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o3">StackLimit</a>) &lt;=
02961             (KERNEL_LARGE_STACK_SIZE + PAGE_SIZE));
02962     NewLimit = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PVOID)((PUCHAR)CurrentStack -
02963                                                     KERNEL_LARGE_STACK_COMMIT));
02964 
02965     StackLimit = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o3">StackLimit</a>);
02966 
02967     <span class="comment">//</span>
02968     <span class="comment">// If the new stack limit exceeds the reserved region for the kernel</span>
02969     <span class="comment">// stack, then return an error.</span>
02970     <span class="comment">//</span>
02971 
02972     EndStack = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PVOID)((PUCHAR)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o61">StackBase</a> -
02973                                                     KERNEL_LARGE_STACK_SIZE));
02974 
02975     <span class="keywordflow">if</span> (NewLimit &lt; EndStack) {
02976 
02977         <span class="comment">//</span>
02978         <span class="comment">// Don't go into guard page.</span>
02979         <span class="comment">//</span>
02980 
02981         <span class="keywordflow">return</span> STATUS_STACK_OVERFLOW;
02982 
02983     }
02984 
02985     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StackLimit-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
02986 
02987     <span class="comment">//</span>
02988     <span class="comment">// Lock the PFN database and attempt to expand the kernel stack.</span>
02989     <span class="comment">//</span>
02990 
02991     StackLimit -= 1;
02992 
02993     NumberOfPages = (PFN_NUMBER) (StackLimit - NewLimit + 1);
02994 
02995     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02996 
02997     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> &lt;= (SPFN_NUMBER)NumberOfPages) {
02998         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02999         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
03000     }
03001 
03002     <span class="comment">//</span>
03003     <span class="comment">// Note MmResidentAvailablePages must be charged before calling</span>
03004     <span class="comment">// MiEnsureAvailablePageOrWait as it may let go of the PFN lock.</span>
03005     <span class="comment">//</span>
03006 
03007     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= NumberOfPages;
03008     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(11, NumberOfPages);
03009 
03010     <span class="keywordflow">while</span> (StackLimit &gt;= NewLimit) {
03011 
03012         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StackLimit-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
03013 
03014         <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
03015         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (MI_GET_PAGE_COLOR_FROM_PTE (StackLimit));
03016         StackLimit-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a96">MM_KERNEL_DEMAND_ZERO_PTE</a>;
03017 
03018 <span class="preprocessor">#ifdef PROTECT_KSTACKS</span>
03019 <span class="preprocessor"></span>        StackLimit-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>;
03020 <span class="preprocessor">#endif</span>
03021 <span class="preprocessor"></span>
03022         <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, StackLimit, 1);
03023 
03024         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
03025                            PageFrameIndex,
03026                            MM_READWRITE,
03027                            StackLimit );
03028 
03029         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
03030         *StackLimit = TempPte;
03031         StackLimit -= 1;
03032     }
03033 
03034     <a class="code" href="../../d4/d5/procsup_8c.html#a11">MmKernelStackResident</a> += NumberOfPages;
03035     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03036 
03037 <span class="preprocessor">#if DBG</span>
03038 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NewLimit-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
03039     <span class="keywordflow">if</span> (NewLimit != EndStack) {
03040         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((NewLimit - 1)-&gt;u.Hard.Valid == 0);
03041     }
03042 <span class="preprocessor">#endif</span>
03043 <span class="preprocessor"></span>
03044     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o3">StackLimit</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (NewLimit);
03045 
03046     <a class="code" href="../../d2/d1/mm_8h.html#a56">PERFINFO_GROW_STACK</a>(Thread);
03047 
03048     <span class="keywordflow">return</span> STATUS_SUCCESS;
03049 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a271" doxytag="mm.h::MmHibernateInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmHibernateInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryMap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>HiberVa</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>HiberPte</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01503">1503</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00105">MmCrashDumpPte</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05490">MmGetPhysicalAddress()</a>, <a class="el" href="../../d2/d1/po_8h-source.html#l00141">PO_MEM_CLONE</a>, and <a class="el" href="../../d1/d2/po_8h.html#a67">PoSetHiberRange()</a>.
<p>
<pre class="fragment"><div>01508 {
01509     <span class="comment">//</span>
01510     <span class="comment">// Mark PTE page where the 16 dump PTEs reside as needing cloned</span>
01511     <span class="comment">//</span>
01512 
01513     <a class="code" href="../../d1/d2/po_8h.html#a67">PoSetHiberRange</a> (
01514         MemoryMap,
01515         PO_MEM_CLONE,
01516         MmCrashDumpPte,
01517         1,
01518         ' etP'
01519         );
01520 
01521     <span class="comment">//</span>
01522     <span class="comment">// Return the dump PTEs to the loader (as it needs to use them</span>
01523     <span class="comment">// to map it's relocation code into the kernel space on the</span>
01524     <span class="comment">// final bit of restoring memory)</span>
01525     <span class="comment">//</span>
01526 
01527     *HiberVa = (ULONG_PTR) <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(MmCrashDumpPte);
01528     *HiberPte = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a>(MmCrashDumpPte);
01529 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a187" doxytag="mm.h::MmInitializeMemoryLimits" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmInitializeMemoryLimits           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LoaderBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IncludedType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Memory</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/mminit_8c-source.html#l01582">1582</a> of file <a class="el" href="../../d6/d0/mminit_8c-source.html">mminit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01701">_MEMORY_ALLOCATION_DESCRIPTOR::BasePage</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01699">_MEMORY_ALLOCATION_DESCRIPTOR::ListEntry</a>, <a class="el" href="../../d1/d9/arc_8h.html#a320a278">LoaderMaximum</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01700">_MEMORY_ALLOCATION_DESCRIPTOR::MemoryType</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01702">_MEMORY_ALLOCATION_DESCRIPTOR::PageCount</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00035">TotalPages</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/report_8c-source.html#l00066">IopInitializeResourceMap()</a>, and <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.
<p>
<pre class="fragment"><div>01590                    :
01591 
01592     This function walks through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader block's memory
01593     descriptor list and builds a list of contiguous physical
01594     memory blocks of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired types.
01595 
01596 Arguments:
01597 
01598     LoaderBlock - Supplies a pointer <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system loader block.
01599 
01600     IncludeType - Array of BOOLEANS of size <a class="code" href="../../d1/d9/arc_8h.html#a320a278">LoaderMaximum</a>.
01601                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> means include <span class="keyword">this</span> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of memory in <span class="keywordflow">return</span>.
01602 
01603     Memory - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical memory blocks.
01604 
01605 Return Value:
01606 
01607     None.
01608 
01609 Environment:
01610 
01611     Kernel Mode Only.  System initialization.
01612 
01613 --*/
01614 {
01615 
01616     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> MemoryDescriptor;
01617     PLIST_ENTRY NextMd;
01618     PFN_NUMBER i;
01619     PFN_NUMBER LowestFound;
01620     PFN_NUMBER Found;
01621     PFN_NUMBER Merged;
01622     PFN_NUMBER NextPage;
01623     PFN_NUMBER <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a>;
01624 
01625     <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a> = 0;
01626 
01627     <span class="comment">//</span>
01628     <span class="comment">// Walk through the memory descriptors and build the physical memory list.</span>
01629     <span class="comment">//</span>
01630 
01631     LowestFound = 0;
01632     Memory-&gt;Run[0].BasePage = 0xffffffff;
01633     NextPage = 0xffffffff;
01634     Memory-&gt;Run[0].PageCount = 0;
01635     i = 0;
01636 
01637     <span class="keywordflow">do</span> {
01638         Merged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01639         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01640         NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
01641 
01642         <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
01643 
01644             MemoryDescriptor = CONTAINING_RECORD(NextMd,
01645                                                  <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
01646                                                  ListEntry);
01647 
01648             <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> &lt; <a class="code" href="../../d1/d9/arc_8h.html#a320a278">LoaderMaximum</a> &amp;&amp;
01649                 IncludeType [MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a>] ) {
01650 
01651                 <span class="comment">//</span>
01652                 <span class="comment">// Try to merge runs.</span>
01653                 <span class="comment">//</span>
01654 
01655                 <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> == NextPage) {
01656                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> != 0);
01657                     Memory-&gt;Run[i - 1].PageCount += MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01658                     NextPage += MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01659                     <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a> += MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01660                     Merged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01661                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01662                     <span class="keywordflow">break</span>;
01663                 }
01664 
01665                 <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &gt;= LowestFound) {
01666                     <span class="keywordflow">if</span> (Memory-&gt;Run[i].BasePage &gt; MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>) {
01667                         Memory-&gt;Run[i].BasePage = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
01668                         Memory-&gt;Run[i].PageCount = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
01669                     }
01670                     Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01671                 }
01672             }
01673             NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
01674         }
01675 
01676         <span class="keywordflow">if</span> (!Merged &amp;&amp; Found) {
01677             NextPage = Memory-&gt;Run[i].BasePage + Memory-&gt;Run[i].PageCount;
01678             <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a> += Memory-&gt;Run[i].PageCount;
01679             i += 1;
01680         }
01681         Memory-&gt;Run[i].BasePage = 0xffffffff;
01682         LowestFound = NextPage;
01683 
01684     } <span class="keywordflow">while</span> (Found);
01685     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (i &lt;= Memory-&gt;NumberOfRuns);
01686     Memory-&gt;NumberOfRuns = (ULONG)i;
01687     Memory-&gt;NumberOfPages = <a class="code" href="../../d4/d6/regext_8c.html#a1">TotalPages</a>;
01688 
01689     <span class="keywordflow">return</span>;
01690 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a210" doxytag="mm.h::MmInitializeProcessAddressSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmInitializeProcessAddressSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessToInitialize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToClone&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID SectionToMap&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING *AuditName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l00911">911</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00071">_2gb</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d5/d8/ex_8h.html#a325">ExVerifySuite()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00349">HYPER_SPACE</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02679">_LOCK_HEADER::ListHead</a>, <a class="el" href="../../d4/d8/mi_8h.html#a528">LOCK_HEADER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05659">MiAllocateVad()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00556">MiCheckForConflictingVad</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d2/d9/miia64_8h.html#a311">MiInitializeAlternateTable()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01481">MiInitializeWorkingSetList()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00030">MiInsertVad()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00165">MM_DBG_PTE_UPDATE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00418">MM_DEMAND_ZERO_WRITE_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00089">MmTrackLockedPages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00029">MmVirtualBias</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d8/d9/exts_8h-source.html#l00092">n</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, <a class="el" href="../../d1/d9/ps_8h.html#a36">PWOW64_PROCESS</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d5/sectsup_8c.html#a12">VadTreeWalk()</a>, <a class="el" href="../../d1/d9/ps_8h.html#a35">WOW64_PROCESS</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01128">ZERO_LARGE</a>.
<p>
Referenced by <a class="el" href="../../d3/d0/inialpha_8c-source.html#l00041">MiInitMachineDependent()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>.
<p>
<pre class="fragment"><div>00920                    :
00921 
00922     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set and mutexes within an
00923     newly created address space to support paging.
00924 
00925     No page faults may occur in a <span class="keyword">new</span> process until <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00926     completed.
00927 
00928 Arguments:
00929 
00930     ProcessToInitialize - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process to initialize.
00931 
00932     ProcessToClone - Optionally supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose
00933                      address space should be copied into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00934                      ProcessToInitialize address space.
00935 
00936     SectionToMap - Optionally supplies a section to map into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly
00937                    initialized address space.
00938 
00939         Only one of ProcessToClone and SectionToMap may be specified.
00940 
00941 
00942 Return Value:
00943 
00944     None.
00945 
00946 
00947 Environment:
00948 
00949     Kernel mode.  APCs Disabled.
00950 
00951 --*/
00952 
00953 
00954 {
00955     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00956     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00957     PVOID BaseAddress;
00958     SIZE_T ViewSize;
00959     KIRQL OldIrql;
00960     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00961     PFN_NUMBER PpePhysicalPage;
00962     PFN_NUMBER PdePhysicalPage;
00963     PFN_NUMBER PageContainingWorkingSet;
00964     LARGE_INTEGER SectionOffset;
00965     PSECTION_IMAGE_INFORMATION ImageInfo;
00966     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> VadShare;
00967     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> VadReserve;
00968     <a class="code" href="../../d5/d2/struct__LOCK__HEADER.html">PLOCK_HEADER</a> LockedPagesHeader;
00969 <span class="preprocessor">#if defined (_X86PAE_)</span>
00970 <span class="preprocessor"></span>    ULONG i;
00971     PFN_NUMBER PdePhysicalPage2;
00972 <span class="preprocessor">#endif</span>
00973 <span class="preprocessor"></span><span class="preprocessor">#if defined (_WIN64)</span>
00974 <span class="preprocessor"></span>    <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process;
00975 <span class="preprocessor">#endif</span>
00976 <span class="preprocessor"></span>
00977     <span class="comment">//</span>
00978     <span class="comment">// Initialize Working Set Mutex in process header.</span>
00979     <span class="comment">//</span>
00980 
00981     <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;ProcessToInitialize-&gt;Pcb);
00982     ProcessToInitialize-&gt;AddressSpaceInitialized = 2;
00983 
00984     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;ProcessToInitialize-&gt;AddressCreationLock);
00985 
00986     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;ProcessToInitialize-&gt;WorkingSetLock);
00987 
00988     <span class="comment">//</span>
00989     <span class="comment">// NOTE:  The process block has been zeroed when allocated, so</span>
00990     <span class="comment">// there is no need to zero fields and set pointers to NULL.</span>
00991     <span class="comment">//</span>
00992 
00993     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToInitialize-&gt;VadRoot == NULL);
00994 
00995     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;ProcessToInitialize-&gt;Vm.LastTrimTime);
00996     ProcessToInitialize-&gt;Vm.VmWorkingSetList = <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>;
00997 
00998     <span class="comment">//</span>
00999     <span class="comment">// Obtain a page to map the working set and initialize the</span>
01000     <span class="comment">// working set.  Get PFN mutex to allocate physical pages.</span>
01001     <span class="comment">//</span>
01002 
01003     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01004 
01005     <span class="comment">//</span>
01006     <span class="comment">// Initialize the PFN database for the Page Directory and the</span>
01007     <span class="comment">// PDE which maps hyper space.</span>
01008     <span class="comment">//</span>
01009 
01010 <span class="preprocessor">#if defined (_WIN64)</span>
01011 <span class="preprocessor"></span>
01012     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PDE_TBASE);
01013     PpePhysicalPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
01014 
01015     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PpePhysicalPage, PointerPte, 1);
01016 
01017     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (HYPER_SPACE);
01018     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPte), PointerPte, 1);
01019 
01020 <span class="preprocessor">#if defined(_IA64_)</span>
01021 <span class="preprocessor"></span>    PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PDE_STBASE);
01022     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPte), PointerPte, 1);
01023 <span class="preprocessor">#endif</span>
01024 <span class="preprocessor"></span>
01025 <span class="preprocessor">#else</span>
01026 <span class="preprocessor"></span>
01027 <span class="preprocessor">#if defined (_X86PAE_)</span>
01028 <span class="preprocessor"></span>    PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PDE_BASE);
01029 <span class="preprocessor">#else</span>
01030 <span class="preprocessor"></span>    PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PDE_BASE);
01031 <span class="preprocessor">#endif</span>
01032 <span class="preprocessor"></span>    PdePhysicalPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
01033 
01034     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PdePhysicalPage, PointerPte, 1);
01035 
01036 <span class="preprocessor">#endif</span>
01037 <span class="preprocessor"></span>
01038     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (HYPER_SPACE);
01039     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPte), PointerPte, 1);
01040 
01041 <span class="preprocessor">#if defined (_X86PAE_)</span>
01042 <span class="preprocessor"></span>
01043     <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM - 1; i += 1) {
01044         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PDE_BASE + (i &lt;&lt; PAGE_SHIFT));
01045         PdePhysicalPage2 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
01046         <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PdePhysicalPage2, PointerPte, 1);
01047     }
01048 
01049     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (HYPER_SPACE2);
01050     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPte), PointerPte, 1);
01051 <span class="preprocessor">#endif</span>
01052 <span class="preprocessor"></span>
01053     PageContainingWorkingSet = ProcessToInitialize-&gt;WorkingSetPage;
01054 
01055     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MmWorkingSetList);
01056     PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
01057 
01058     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageContainingWorkingSet, PointerPte, 1);
01059 
01060     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01061 
01062     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
01063                        PageContainingWorkingSet,
01064                        MM_READWRITE,
01065                        PointerPte );
01066 
01067     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
01068     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
01069 
01070     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToInitialize-&gt;LockedPagesList == NULL);
01071 
01072     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01073         LockedPagesHeader = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
01074                                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html">LOCK_HEADER</a>),
01075                                                    'xTmM');
01076 
01077         <span class="keywordflow">if</span> (LockedPagesHeader) {
01078             RtlZeroMemory (LockedPagesHeader, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html">LOCK_HEADER</a>));
01079             ProcessToInitialize-&gt;LockedPagesList = (PVOID)LockedPagesHeader;
01080             InitializeListHead (&amp;LockedPagesHeader-&gt;<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o0">ListHead</a>);
01081         }
01082     }
01083 
01084     <a class="code" href="../../d4/d0/wslist_8c.html#a27">MiInitializeWorkingSetList</a> (ProcessToInitialize);
01085 
01086     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;ProcessToInitialize-&gt;AweLock);
01087     InitializeListHead (&amp;ProcessToInitialize-&gt;PhysicalVadList);
01088 
01089     <span class="comment">//</span>
01090     <span class="comment">// Page faults may be taken now.</span>
01091     <span class="comment">//</span>
01092     <span class="comment">// If the system has been biased to an alternate base address to allow</span>
01093     <span class="comment">// 3gb of user address space and a process is not being cloned, then</span>
01094     <span class="comment">// create a VAD for the shared memory page.</span>
01095     <span class="comment">//</span>
01096 
01097 <span class="preprocessor">#if defined(_X86_) &amp;&amp; defined(MM_SHARED_USER_DATA_VA)</span>
01098 <span class="preprocessor"></span>
01099     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> != 0) &amp;&amp; (ProcessToClone == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01100 
01101         <span class="comment">//</span>
01102         <span class="comment">// Allocate a VAD to map the shared memory page. If a VAD cannot be</span>
01103         <span class="comment">// allocated, then detach from the target process and return a failure</span>
01104         <span class="comment">// status.  This VAD is marked as not deletable.</span>
01105         <span class="comment">//</span>
01106 
01107         VadShare = <a class="code" href="../../d4/d5/procsup_8c.html#a25">MiAllocateVad</a> (MM_SHARED_USER_DATA_VA,
01108                                   MM_SHARED_USER_DATA_VA,
01109                                   FALSE);
01110 
01111         <span class="keywordflow">if</span> (VadShare == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01112             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01113             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01114         }
01115 
01116         <span class="comment">//</span>
01117         <span class="comment">// If a section is being mapped and the executable is not large</span>
01118         <span class="comment">// address space aware, then create a VAD that reserves the address</span>
01119         <span class="comment">// space between 2gb and the highest user address.</span>
01120         <span class="comment">//</span>
01121 
01122         <span class="keywordflow">if</span> (SectionToMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01123             <span class="keywordflow">if</span> (!((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;u.Flags.Image) {
01124                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01125                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (VadShare);
01126                 <span class="keywordflow">return</span> STATUS_SECTION_NOT_IMAGE;
01127             }
01128             ImageInfo = ((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;Segment-&gt;ImageInformation;
01129             <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d8/ex_8h.html#a325">ExVerifySuite</a>(Enterprise) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
01130                 ((ImageInfo-&gt;ImageCharacteristics &amp; IMAGE_FILE_LARGE_ADDRESS_AWARE) == 0)) {
01131 
01132                 <span class="comment">//</span>
01133                 <span class="comment">// Allocate a VAD to map the address space between 2gb and</span>
01134                 <span class="comment">// the highest user address. If a VAD can not be allocated,</span>
01135                 <span class="comment">// then deallocate the shared address space VAD, detach from</span>
01136                 <span class="comment">// the target process, and return a failure status.</span>
01137                 <span class="comment">// This VAD is marked as not deletable.</span>
01138                 <span class="comment">//</span>
01139 
01140                 VadReserve = <a class="code" href="../../d4/d5/procsup_8c.html#a25">MiAllocateVad</a> (_2gb,
01141                                             (ULONG_PTR)MM_HIGHEST_USER_ADDRESS,
01142                                             FALSE);
01143 
01144                 <span class="keywordflow">if</span> (VadReserve == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01145                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01146                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (VadShare);
01147                     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01148                 }
01149 
01150                 <span class="comment">//</span>
01151                 <span class="comment">// Insert the VAD.</span>
01152                 <span class="comment">//</span>
01153                 <span class="comment">// N.B. No exception can occur since there is no commit charge.</span>
01154                 <span class="comment">//</span>
01155 
01156                 <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (VadReserve);
01157             }
01158         }
01159 
01160         <span class="comment">//</span>
01161         <span class="comment">// Insert the VAD.</span>
01162         <span class="comment">//</span>
01163         <span class="comment">// N.B. No exception can occur since there is no commit charge.</span>
01164         <span class="comment">//</span>
01165 
01166         <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (VadShare);
01167     }
01168 
01169 <span class="preprocessor">#endif</span>
01170 <span class="preprocessor"></span>
01171 <span class="preprocessor">#if defined(_WIN64)</span>
01172 <span class="preprocessor"></span>
01173     <span class="keywordflow">if</span> (ProcessToClone == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01174 
01175         <span class="comment">//</span>
01176         <span class="comment">// Reserve the address space just below KUSER_SHARED_DATA as the</span>
01177         <span class="comment">// compatibility area.  This range can be unreserved by user mode</span>
01178         <span class="comment">// code such as WOW64 or csrss.</span>
01179         <span class="comment">//</span>
01180 
01181         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a>(WOW64_COMPATIBILITY_AREA_ADDRESS, MM_SHARED_USER_DATA_VA) == NULL);
01182 
01183         VadShare = <a class="code" href="../../d4/d5/procsup_8c.html#a25">MiAllocateVad</a> (WOW64_COMPATIBILITY_AREA_ADDRESS,
01184                                   MM_SHARED_USER_DATA_VA,
01185                                   TRUE);
01186 
01187         <span class="keywordflow">if</span> (VadShare == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01188            <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01189            <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01190         }
01191 
01192         <span class="comment">//</span>
01193         <span class="comment">// Reserve the memory above 2GB to prevent 32 bit (WOW64) process</span>
01194         <span class="comment">// access.</span>
01195         <span class="comment">//</span>
01196 
01197         <span class="keywordflow">if</span> (SectionToMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01198             <span class="keywordflow">if</span> (!((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;u.Flags.Image) {
01199                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01200                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (VadShare);
01201                 <span class="keywordflow">return</span> STATUS_SECTION_NOT_IMAGE;
01202             }
01203             ImageInfo = ((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;Segment-&gt;ImageInformation;
01204 
01205             <span class="keywordflow">if</span> ((ImageInfo-&gt;ImageCharacteristics &amp; IMAGE_FILE_LARGE_ADDRESS_AWARE) == 0 ||
01206 <span class="preprocessor">#if defined(_AXP64_)</span>
01207 <span class="preprocessor"></span>                ImageInfo-&gt;Machine == IMAGE_FILE_MACHINE_ALPHA ||
01208 <span class="preprocessor">#endif</span>
01209 <span class="preprocessor"></span>                ImageInfo-&gt;Machine == IMAGE_FILE_MACHINE_I386) {
01210 
01211                 <span class="comment">//</span>
01212                 <span class="comment">// Allocate a VAD to reserve the address space between 2gb and</span>
01213                 <span class="comment">// the highest user address.  If a VAD cannot be allocated,</span>
01214                 <span class="comment">// then deallocate the compatibility VAD, detach from the target</span>
01215                 <span class="comment">// process and return a failure status.</span>
01216                 <span class="comment">//</span>
01217 
01218                 VadReserve = <a class="code" href="../../d4/d5/procsup_8c.html#a25">MiAllocateVad</a> (_2gb,
01219                                             (ULONG_PTR)MM_HIGHEST_USER_ADDRESS,
01220                                             TRUE);
01221 
01222                 <span class="keywordflow">if</span> (VadReserve == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01223                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01224                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (VadShare);
01225                     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01226                 }
01227 
01228                 <span class="comment">//</span>
01229                 <span class="comment">// Insert the VAD.</span>
01230                 <span class="comment">//</span>
01231                 <span class="comment">// N.B. No exception can occur since there is no commit charge.</span>
01232                 <span class="comment">//</span>
01233 
01234                 <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (VadReserve);
01235 
01236                 <span class="comment">//</span>
01237                 <span class="comment">// Initialize Wow64 Process structure</span>
01238                 <span class="comment">//</span>
01239 
01240                 Wow64Process = 
01241                     (<a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a>) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
01242                                                             <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">WOW64_PROCESS</a>),
01243                                                             'WowM');
01244 
01245                 <span class="keywordflow">if</span> (Wow64Process == (<a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01246                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01247                     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01248                 }
01249 
01250                 RtlZeroMemory(Wow64Process, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">WOW64_PROCESS</a>));
01251 
01252                 ProcessToInitialize-&gt;Wow64Process = Wow64Process;
01253                  
01254 <span class="preprocessor">#if defined(_MIALT4K_)</span>
01255 <span class="preprocessor"></span>
01256                 <span class="comment">//</span>
01257                 <span class="comment">// Initialize the alternate page table for the 4kb page function</span>
01258                 <span class="comment">//</span>
01259 
01260                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d9/miia64_8h.html#a311">MiInitializeAlternateTable</a> (ProcessToInitialize);
01261                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
01262                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01263                     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01264                 }
01265 
01266 <span class="preprocessor">#endif</span>
01267 <span class="preprocessor"></span>            }
01268         }
01269 
01270         <span class="comment">//</span>
01271         <span class="comment">// Insert the VAD.</span>
01272         <span class="comment">//</span>
01273         <span class="comment">// N.B. No exception can occur since there is no commit charge.</span>
01274         <span class="comment">//</span>
01275 
01276         <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (VadShare);
01277     }
01278 
01279 <span class="preprocessor">#endif</span>
01280 <span class="preprocessor"></span>
01281     <span class="keywordflow">if</span> (SectionToMap != (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01282 
01283         <span class="comment">//</span>
01284         <span class="comment">// Map the specified section into the address space of the</span>
01285         <span class="comment">// process but only if it is an image section.</span>
01286         <span class="comment">//</span>
01287 
01288         <span class="keywordflow">if</span> (!((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;u.Flags.Image) {
01289             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SECTION_NOT_IMAGE;
01290         } <span class="keywordflow">else</span> {
01291             UNICODE_STRING UnicodeString;
01292             ULONG <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
01293             PWSTR Src;
01294             PCHAR Dst;
01295 
01296             UnicodeString = ((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;Segment-&gt;ControlArea-&gt;FilePointer-&gt;FileName;
01297             Src = (PWSTR)((PCHAR)UnicodeString.Buffer + UnicodeString.Length);
01298             <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = 0;
01299             <span class="keywordflow">if</span> (UnicodeString.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01300                 <span class="keywordflow">while</span> (Src &gt; UnicodeString.Buffer) {
01301                     <span class="keywordflow">if</span> (*--Src == OBJ_NAME_PATH_SEPARATOR) {
01302                         Src += 1;
01303                         <span class="keywordflow">break</span>;
01304                     }
01305                     <span class="keywordflow">else</span> {
01306                         <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> += 1;
01307                     }
01308                 }
01309             }
01310             Dst = ProcessToInitialize-&gt;ImageFileName;
01311             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> &gt;= <span class="keyword">sizeof</span>( ProcessToInitialize-&gt;ImageFileName )) {
01312                 <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = <span class="keyword">sizeof</span>( ProcessToInitialize-&gt;ImageFileName ) - 1;
01313             }
01314 
01315             <span class="keywordflow">while</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>--) {
01316                 *Dst++ = (UCHAR)*Src++;
01317             }
01318             *Dst = <span class="charliteral">'\0'</span>;
01319 
01320             <span class="keywordflow">if</span> (AuditName) {
01321                 *AuditName = &amp;((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;Segment-&gt;ControlArea-&gt;FilePointer-&gt;FileName ;
01322             }
01323 
01324             ProcessToInitialize-&gt;SubSystemMajorVersion =
01325                 (UCHAR)((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;Segment-&gt;ImageInformation-&gt;SubSystemMajorVersion;
01326             ProcessToInitialize-&gt;SubSystemMinorVersion =
01327                 (UCHAR)((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap)-&gt;Segment-&gt;ImageInformation-&gt;SubSystemMinorVersion;
01328 
01329             BaseAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01330             ViewSize = 0;
01331             <a class="code" href="../../d4/d8/mi_8h.html#a166">ZERO_LARGE</a> (SectionOffset);
01332 
01333             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a> ( (PSECTION)SectionToMap,
01334                                           ProcessToInitialize,
01335                                           &amp;BaseAddress,
01336                                           0,                <span class="comment">// ZeroBits,</span>
01337                                           0,                <span class="comment">// CommitSize,</span>
01338                                           &amp;SectionOffset,   <span class="comment">//SectionOffset,</span>
01339                                           &amp;ViewSize,
01340                                           ViewShare,        <span class="comment">//InheritDisposition,</span>
01341                                           0,                <span class="comment">//allocation type</span>
01342                                           PAGE_READWRITE    <span class="comment">// Protect</span>
01343                                           );
01344 
01345             ProcessToInitialize-&gt;SectionBaseAddress = BaseAddress;
01346 
01347 <span class="preprocessor">#if DBG</span>
01348 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a57">MM_DBG_PTE_UPDATE</a>) {
01349                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"mapped image section vads\n"</span>);
01350                 <a class="code" href="../../d5/d5/sectsup_8c.html#a12">VadTreeWalk</a>(ProcessToInitialize-&gt;VadRoot);
01351             }
01352 <span class="preprocessor">#endif //DBG</span>
01353 <span class="preprocessor"></span>        }
01354 
01355         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01356         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01357     }
01358 
01359     <span class="keywordflow">if</span> (ProcessToClone != (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01360 <span class="preprocessor">#if DEVL</span>
01361 <span class="preprocessor"></span>        strcpy( ProcessToInitialize-&gt;ImageFileName, ProcessToClone-&gt;ImageFileName );
01362 <span class="preprocessor">#endif // DEVL</span>
01363 <span class="preprocessor"></span>
01364         <span class="comment">//</span>
01365         <span class="comment">// Clone the address space of the specified process.</span>
01366         <span class="comment">//</span>
01367 
01368         <span class="comment">//</span>
01369         <span class="comment">// As the page directory and page tables are private to each</span>
01370         <span class="comment">// process, the physical pages which map the directory page</span>
01371         <span class="comment">// and the page table usage must be mapped into system space</span>
01372         <span class="comment">// so they can be updated while in the context of the process</span>
01373         <span class="comment">// we are cloning.</span>
01374         <span class="comment">//</span>
01375 
01376         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01377         <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a853">MiCloneProcessAddressSpace</a> (ProcessToClone,
01378                                            ProcessToInitialize,
01379 #<span class="keywordflow">if</span> defined (_WIN64)
01380                                            PpePhysicalPage,
01381 #<span class="keywordflow">else</span>
01382                                            PdePhysicalPage,
01383 #endif
01384                                            PageContainingWorkingSet
01385                                            );
01386 
01387     }
01388 
01389     <span class="comment">//</span>
01390     <span class="comment">// System Process.</span>
01391     <span class="comment">//</span>
01392 
01393     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
01394     <span class="keywordflow">return</span> STATUS_SUCCESS;
01395 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a186" doxytag="mm.h::MmInitSystem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmInitSystem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Phase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LoaderBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalMemoryBlock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">184</a> of file <a class="el" href="../../d6/d0/mminit_8c-source.html">mminit.c</a>.
<p>
References <a class="el" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02213">_MMPAGE_FILE_EXPANSION::ActualExpansion</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00311">_EPROCESS::AweLock</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00034">_PHYSICAL_MEMORY_RUN::BasePage</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00035">BBTPagesToReserve</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02214">_MMPAGE_FILE_EXPANSION::Event</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00110">ExpMultiUserTS</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d5/d8/ex_8h.html#a325">ExVerifySuite()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02215">_MMPAGE_FILE_EXPANSION::InProgress</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">KeBalanceSetManager()</a>, <a class="el" href="../../d5/d0/dpcobj_8c-source.html#l00039">KeInitializeDpc()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00040">KeInitializeMutant()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00075">KeInitializeTimerEx()</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00322">KeSwapProcessOrStack()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00591">KSEG0_BASE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02222">_MMWORKING_SET_EXPANSION_HEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02568">_MMINPAGE_SUPPORT_LIST::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02573">_MMEVENT_COUNT_LIST::ListHead</a>, <a class="el" href="../../d1/d9/arc_8h.html#a320a257">LoaderBad</a>, <a class="el" href="../../d1/d9/arc_8h.html#a320a277">LoaderBBTMemory</a>, <a class="el" href="../../d1/d9/arc_8h.html#a320a260">LoaderFirmwarePermanent</a>, <a class="el" href="../../d1/d9/arc_8h.html#a320a278">LoaderMaximum</a>, <a class="el" href="../../d1/d9/arc_8h.html#a320a276">LoaderSpecialMemory</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00031">MAX_PHYSICAL_MEMORY_FRAGMENTS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02219">MI_EXTEND_ANY_PAGEFILE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05221">MI_SESSION_IMAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05280">MI_SESSION_SPACE_END</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05229">MI_SESSION_SPACE_TOTAL_SIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01907">MiAddSystemPtes()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00259">MiAdjustWorkingSetManagerParameters()</a>, <a class="el" href="../../d5/d1/mminit_8c.html#a47">MiBuildPagedPool()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00329">MiChargeCommitmentCantExpand()</a>, <a class="el" href="../../d4/d8/mi_8h.html#a966">MiDumpPfn()</a>, <a class="el" href="../../d4/d8/mi_8h.html#a965">MiDumpValidAddresses()</a>, <a class="el" href="../../d4/d8/mi_8h.html#a964">MiEnableKernelVerifier()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02735">MiEnablePagingTheExecutive()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02543">MiFillMemoryPte</a>, <a class="el" href="../../d4/d8/mi_8h.html#a968">MiFormatPte()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01559">MiGetSubsectionAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01591">MiGetSubsectionAddressForPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05701">MiHighestUserPde</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05700">MiHighestUserPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l03121">MiInitializeDriverVerifierList()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01595">MiInitializeIoTrackers()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l06591">MiInitializeLoadedModuleList()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d3/d7/session_8c.html#a7">MiInitializeSessionIds()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01847">MiInitializeSessionWsSupport()</a>, <a class="el" href="../../d5/d1/mminit_8c.html#a50">MiInitializeSpecialPoolCriteria()</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00814">MiInitializeSystemCache()</a>, <a class="el" href="../../d3/d2/initppc_8c-source.html#l00036">MiInitMachineDependent()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l01440">MiMapBBTMemory()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05138">MiMappedPagesTooOldEvent</a>, <a class="el" href="../../d3/d1/data386_8c-source.html#l00177">MiMaximumSystemCacheSizeExtra</a>, <a class="el" href="../../d3/d1/data386_8c-source.html#l00130">MiMaximumWorkingSet</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l01899">MiMergeMemoryLimit()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05134">MiModifiedPageLife</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02669">MiModifiedPageWriter()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05142">MiModifiedPageWriterTimer</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02782">MiModifiedPageWriterTimerDispatch()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05140">MiModifiedPageWriterTimerDpc</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01495">MiProtoAddressForPte</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00155">MiPteStr</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01466">MiPteToProto</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l05956">MiReloadBootLoadedDrivers()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01177">MiRemoveZeroPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04664">MiRequestedSystemPtes</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00768">MiSectionInitialization()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05703">MiSessionBasePte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05704">MiSessionLastPte</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00652">MiSessionWideInitializeAddresses()</a>, <a class="el" href="../../d3/d1/data386_8c-source.html#l00181">MiSystemCacheEndExtra</a>, <a class="el" href="../../d3/d1/data386_8c-source.html#l00179">MiSystemCacheStartExtra</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04744">MiSystemViewStart</a>, <a class="el" href="../../d4/d8/mi_8h.html#a957">MiTriageSystem()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00157">MiTrimInProgressCount</a>, <a class="el" href="../../d8/d8/sysload_8c.html#a47">MiWriteProtectSystemImage()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00079">Mm64BitPhysicalAddress</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00164">MM_BOOT_IMAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00182">MM_DBG_CHECK_PFN_LOCK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04260">MM_DBG_COMMIT_EXTRA_SYSTEM_PTES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00176">MM_DBG_DUMP_BOOT_PTES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00180">MM_DEFAULT_SYSTEM_PTES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00418">MM_DEMAND_ZERO_WRITE_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00090">MM_FLUID_PHYSICAL_PAGES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00178">MM_MAXIMUM_SYSTEM_PTES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00364">MM_MAXIMUM_WORKING_SET</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00145">MM_MEDIUM_SYSTEM</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00176">MM_MINIMUM_SYSTEM_PTES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00164">MM_NONPAGED_POOL_END</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00134">MM_READONLY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00141">MM_SESSION_SPACE_DEFAULT</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00143">MM_SMALL_SYSTEM</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04065">MM_SPECIAL_POOL_PTES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00139">MM_SYSTEM_CACHE_END</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00137">MM_SYSTEM_CACHE_START</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00249">MM_SYSTEM_CACHE_START_EXTRA</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00154">MM_SYSTEM_VIEW_SIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00158">MM_SYSTEM_VIEW_SIZE_IF_HYDRA</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00152">MM_SYSTEM_VIEW_START</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00156">MM_SYSTEM_VIEW_START_IF_HYDRA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05073">MmAttemptForCantExtend</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04581">MmAvailablePagesEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04583">MmAvailablePagesEventHigh</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04899">MmChargeCommitmentLock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04854">MmCodeClusterSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05098">MmCollidedFlushEvent</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00206">MmCollidedLockEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00218">MmCriticalSectionTimeout</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00101">MmCritsectTimeoutSeconds</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04852">MmDataClusterSize</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00068">MmDontVerifyRandomDrivers</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00024">MmDynamicMemoryMutex</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00086">MmEnforceWriteProtection</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00028">MmEventCountList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04905">MmExpansionLock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05171">MmHardFaultNotifyRoutine</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00105">MmHeapDeCommitFreeBlockThreshold</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00104">MmHeapDeCommitTotalFreeThreshold</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00103">MmHeapSegmentCommit</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00102">MmHeapSegmentReserve</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00027">MmHighestUserAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04821">MmHighSectionBase</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04846">MmImageMappingPteEvent</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l01582">MmInitializeMemoryLimits()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00027">MmInPageSupportList</a>, <a class="el" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00045">MmLargeSystemCache</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00062">MmLoadedUserImageList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00995">MmLockConflictList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04668">MmLockPagesLimit</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00077">MmLockPagesPercentage</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04610">MmMappedFileIoComplete</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04797">MmMaximumDeadKernelStacks</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00062">MmMaximumNonPagedPoolInBytes</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00687">MmMaximumWorkingSetSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04957">MmMaxUnusedSegmentNonPagedPoolUsage</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04950">MmMaxUnusedSegmentPagedPoolUsage</a>, <a class="el" href="../../d2/d1/mm_8h.html#a343a166">MmMediumSystem</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05118">MmMinimumFreePages</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00083">MmModifiedPageLifeInSeconds</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05122">MmModifiedPageMaximum</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05124">MmModifiedPageMinimum</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05096">MmModifiedPageWriterEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04486">MmMoreThanEnoughFreePages</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00063">MmNonPagedSystemStart</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00399">MmNumberOfPhysicalPages</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00079">MmNumberOfSystemPtes</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00076">MmOverCommit</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00068">MmPagedPoolEnd</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00067">MmPagedPoolStart</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05170">MmPageFaultNotifyRoutine</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04860">MmPageFileCreationLock</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">MmPhysicalMemoryBlock</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00108">MmProductType</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00092">MmProtectFreedNonPagedPool</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00387">MmReadClusterSize</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00041">MmResidentAvailableAtInit</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04833">MmSectionBasedMutex</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04827">MmSectionCommitMutex</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04839">MmSectionExtendResource</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04840">MmSectionExtendSetResource</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05211">MmSessionBase</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00025">MmSharedUserDataPte</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00074">MmSizeOfPagedPoolInBytes</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00406">MmSizeOfSystemCacheInPages</a>, <a class="el" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00088">MmSnapUnloads</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01975">MmSpecialPoolTag</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00050">MmSystemCacheEnd</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00049">MmSystemCacheStart</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04752">MmSystemCacheWorkingSetList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04766">MmSystemCacheWsMaximum</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04764">MmSystemCacheWsMinimum</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00928">MmSystemLoadLock</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00033">MmSystemRangeStart</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00172">MmSystemSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04887">MmSystemWsLock</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01090">MmThrottleBottom</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01089">MmThrottleTop</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00041">MmTotalCommitLimit</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00100">MmTotalCommitLimitMaximum</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00089">MmTrackLockedPages</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00093">MmTrackPtes</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04962">MmUnusedSegmentNonPagedPoolReduction</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04955">MmUnusedSegmentPagedPoolReduction</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00080">MmUnusedSegmentTrimLevel</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00039">MmUserProbeAddress</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00065">MmVerifyDriverBufferLength</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00029">MmVirtualBias</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05071">MmWorkingSetExpansionHead</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00418">MmWorkingSetManagerEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04589">MmZeroingPageEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04598">MmZeroingPageThreadActive</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00166">NON_PAGED_SYSTEM_END</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00040">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfPages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00039">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfRuns</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00035">_PHYSICAL_MEMORY_RUN::PageCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02216">_MMPAGE_FILE_EXPANSION::PageFileNumber</a>, <a class="el" href="../../d0/d8/axp64_2mialpha_8h-source.html#l00157">PDE_KTBASE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00267">_EPROCESS::PhysicalVadList</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00175">PsCreateSystemThread()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00583">PsLoadedModuleResource</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00455">PTE_PER_PAGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00282">PTE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02212">_MMPAGE_FILE_EXPANSION::RequestedExpansionSize</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00041">_PHYSICAL_MEMORY_DESCRIPTOR::Run</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02210">_MMPAGE_FILE_EXPANSION::Segment</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00060">ValidKernelPde</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00038">ValidKernelPte</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
<pre class="fragment"><div>00192                    :
00193 
00194     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called during Phase 0, phase 1 and at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end
00195     of phase 1 (<span class="stringliteral">"phase 2"</span>) initialization.
00196 
00197     Phase 0 initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory management paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a>,
00198     nonpaged and paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database, etc.
00199 
00200     Phase 1 initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section objects, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical memory
00201     object, and starts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory management system threads.
00202 
00203     Phase 2 frees memory used by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OsLoader.
00204 
00205 Arguments:
00206 
00207     Phase - System initialization phase.
00208 
00209     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system loader block.
00210 
00211 Return Value:
00212 
00213     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initialization was successful.
00214 
00215 Environment:
00216 
00217     Kernel Mode Only.  System initialization.
00218 
00219 --*/
00220 
00221 {
00222     HANDLE <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>;
00223     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00224     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00225     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00226     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPde;
00227     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPpe;
00228     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte;
00229     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPde;
00230     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00231     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> Pointer;
00232     PFN_NUMBER i, j;
00233     PFN_NUMBER PageFrameIndex;
00234     PFN_NUMBER DirectoryFrameIndex;
00235     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00236     KIRQL OldIrql;
00237     LOGICAL First;
00238     PLIST_ENTRY NextEntry;
00239     PLDR_DATA_TABLE_ENTRY DataTableEntry;
00240     ULONG MaximumSystemCacheSize;
00241     ULONG MaximumSystemCacheSizeTotal;
00242     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00243     PIMAGE_NT_HEADERS NtHeaders;
00244     ULONG_PTR SystemPteMultiplier;
00245 
00246     BOOLEAN IncludeType[<a class="code" href="../../d1/d9/arc_8h.html#a320a278">LoaderMaximum</a>];
00247     ULONG MemoryAlloc[(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PHYSICAL_MEMORY_DESCRIPTOR</a>) +
00248             <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a>)*<a class="code" href="../../d2/d1/mm_8h.html#a0">MAX_PHYSICAL_MEMORY_FRAGMENTS</a>) /
00249               <span class="keyword">sizeof</span>(ULONG)];
00250 
00251     <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> Memory;
00252 
00253     <span class="comment">//</span>
00254     <span class="comment">// Make sure structure alignment is okay.</span>
00255     <span class="comment">//</span>
00256 
00257     <span class="keywordflow">if</span> (Phase == 0) {
00258         <a class="code" href="../../d2/d1/mm_8h.html#a151">MmThrottleTop</a> = 450;
00259         <a class="code" href="../../d2/d1/mm_8h.html#a152">MmThrottleBottom</a> = 127;
00260 
00261         <span class="comment">//</span>
00262         <span class="comment">// Set the highest user address, the system range start address, the</span>
00263         <span class="comment">// user probe address, and the virtual bias.</span>
00264         <span class="comment">//</span>
00265 
00266 <span class="preprocessor">#if defined(_AXP64_) || defined(_IA64_)</span>
00267 <span class="preprocessor"></span>
00268         <a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a> = MM_HIGHEST_USER_ADDRESS;
00269         <a class="code" href="../../d0/d9/miglobal_8c.html#a2">MmUserProbeAddress</a> = MM_USER_PROBE_ADDRESS;
00270         <a class="code" href="../../d0/d9/miglobal_8c.html#a1">MmSystemRangeStart</a> = MM_SYSTEM_RANGE_START;
00271 
00272 <span class="preprocessor">#else</span>
00273 <span class="preprocessor"></span>
00274         <a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a> = (PVOID)(<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> - 0x10000 - 1);
00275         <a class="code" href="../../d0/d9/miglobal_8c.html#a2">MmUserProbeAddress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> - 0x10000;
00276         <a class="code" href="../../d0/d9/miglobal_8c.html#a1">MmSystemRangeStart</a> = (PVOID)<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a>;
00277 
00278 <span class="preprocessor">#endif</span>
00279 <span class="preprocessor"></span>
00280         <a class="code" href="../../d4/d8/mi_8h.html#a755">MiHighestUserPte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MmHighestUserAddress);
00281         <a class="code" href="../../d4/d8/mi_8h.html#a756">MiHighestUserPde</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MmHighestUserAddress);
00282 
00283         <a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> = 0;
00284 
00285         <span class="comment">//</span>
00286         <span class="comment">// Set the highest section base address.</span>
00287         <span class="comment">//</span>
00288         <span class="comment">// N.B. In 32-bit systems this address must be 2gb or less even for</span>
00289         <span class="comment">//      systems that run with 3gb enabled. Otherwise, it would not</span>
00290         <span class="comment">//      be possible to map based sections identically in all processes.</span>
00291         <span class="comment">//</span>
00292 
00293         <a class="code" href="../../d4/d8/mi_8h.html#a676">MmHighSectionBase</a> = ((PCHAR)<a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a> - 0x800000);
00294 
00295         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a325">ExVerifySuite</a>(TerminalServer) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00296             <a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00297             <a class="code" href="../../d4/d8/mi_8h.html#a656">MiSystemViewStart</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a19">MM_SYSTEM_VIEW_START_IF_HYDRA</a>;
00298             <a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a> = (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a14">MM_SESSION_SPACE_DEFAULT</a>;
00299 
00300         } <span class="keywordflow">else</span> {
00301             <a class="code" href="../../d4/d8/mi_8h.html#a656">MiSystemViewStart</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a17">MM_SYSTEM_VIEW_START</a>;
00302             <a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00303         }
00304 
00305         MaximumSystemCacheSize = (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a13">MM_SYSTEM_CACHE_END</a> - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a12">MM_SYSTEM_CACHE_START</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00306 
00307         <span class="comment">//</span>
00308         <span class="comment">// If the system has been biased to an alternate base address to</span>
00309         <span class="comment">// allow 3gb of user address space, then set the user probe address</span>
00310         <span class="comment">// and the maximum system cache size.</span>
00311         <span class="comment">//</span>
00312 
00313 <span class="preprocessor">#if defined(_X86_)</span>
00314 <span class="preprocessor"></span>
00315         <a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> = LoaderBlock-&gt;u.I386.VirtualBias;
00316 
00317         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a126">MmVirtualBias</a> != 0) {
00318             <a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a> = ((PCHAR)<a class="code" href="../../d0/d9/miglobal_8c.html#a0">MmHighestUserAddress</a> + 0x40000000);
00319             <a class="code" href="../../d0/d9/miglobal_8c.html#a1">MmSystemRangeStart</a> = ((PCHAR)<a class="code" href="../../d0/d9/miglobal_8c.html#a1">MmSystemRangeStart</a> + 0x40000000);
00320             <a class="code" href="../../d0/d9/miglobal_8c.html#a2">MmUserProbeAddress</a> += 0x40000000;
00321             <a class="code" href="../../d2/d2/data386_8c.html#a20">MiMaximumWorkingSet</a> += 0x40000000 &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00322 
00323             <a class="code" href="../../d4/d8/mi_8h.html#a755">MiHighestUserPte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MmHighestUserAddress);
00324             <a class="code" href="../../d4/d8/mi_8h.html#a756">MiHighestUserPde</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MmHighestUserAddress);
00325 
00326             MaximumSystemCacheSize -= <a class="code" href="../../d6/d8/mi386_8h.html#a4">MM_BOOT_IMAGE_SIZE</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00327 
00328             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00329 
00330                 <span class="comment">//</span>
00331                 <span class="comment">// Moving to 3GB means moving session space to just above</span>
00332                 <span class="comment">// the system cache (and lowering the system cache max size</span>
00333                 <span class="comment">// accordingly).</span>
00334                 <span class="comment">//</span>
00335 
00336                 MaximumSystemCacheSize -= (<a class="code" href="../../d4/d8/mi_8h.html#a339">MI_SESSION_SPACE_TOTAL_SIZE</a> + <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a20">MM_SYSTEM_VIEW_SIZE_IF_HYDRA</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00337 
00338                 <a class="code" href="../../d4/d8/mi_8h.html#a656">MiSystemViewStart</a> = (ULONG_PTR)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a12">MM_SYSTEM_CACHE_START</a> +
00339                                       (MaximumSystemCacheSize &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
00340 
00341                 <a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a> = <a class="code" href="../../d4/d8/mi_8h.html#a656">MiSystemViewStart</a> + <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a20">MM_SYSTEM_VIEW_SIZE_IF_HYDRA</a> + <a class="code" href="../../d6/d8/mi386_8h.html#a4">MM_BOOT_IMAGE_SIZE</a>;
00342 
00343             } <span class="keywordflow">else</span> {
00344                 MaximumSystemCacheSize -= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a18">MM_SYSTEM_VIEW_SIZE</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00345                 <a class="code" href="../../d4/d8/mi_8h.html#a656">MiSystemViewStart</a> = (ULONG_PTR)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a12">MM_SYSTEM_CACHE_START</a> +
00346                                       (MaximumSystemCacheSize &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) +
00347                                       <a class="code" href="../../d6/d8/mi386_8h.html#a4">MM_BOOT_IMAGE_SIZE</a>);
00348             }
00349         }
00350 
00351 <span class="preprocessor">#else</span>
00352 <span class="preprocessor"></span>
00353         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00354             MaximumSystemCacheSize -= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a20">MM_SYSTEM_VIEW_SIZE_IF_HYDRA</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00355             <a class="code" href="../../d4/d8/mi_8h.html#a656">MiSystemViewStart</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a19">MM_SYSTEM_VIEW_START_IF_HYDRA</a>;
00356         }
00357 
00358 <span class="preprocessor">#endif</span>
00359 <span class="preprocessor"></span>
00360         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00361             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a> = (<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a>)((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a> + <a class="code" href="../../d4/d8/mi_8h.html#a335">MI_SESSION_IMAGE_SIZE</a>);
00362 
00363             <a class="code" href="../../d4/d8/mi_8h.html#a757">MiSessionBasePte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MmSessionBase);
00364             <a class="code" href="../../d4/d8/mi_8h.html#a758">MiSessionLastPte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MI_SESSION_SPACE_END);
00365         }
00366 
00367         <span class="comment">//</span>
00368         <span class="comment">// A few sanity checks to ensure things are as they should be.</span>
00369         <span class="comment">//</span>
00370 
00371 <span class="preprocessor">#if DBG</span>
00372 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/struct__MMWSL.html">MMWSL</a>) % 8) != 0) {
00373             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"working set list is not a quadword sized structure\n"</span>);
00374         }
00375 
00376         <span class="keywordflow">if</span> ((<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">CONTROL_AREA</a>) % 8) != 0) {
00377             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"control area list is not a quadword sized structure\n"</span>);
00378         }
00379 
00380         <span class="keywordflow">if</span> ((<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>) % 8) != 0) {
00381             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"subsection list is not a quadword sized structure\n"</span>);
00382         }
00383 
00384         <span class="comment">//</span>
00385         <span class="comment">// Some checks to make sure prototype PTEs can be placed in</span>
00386         <span class="comment">// either paged or nonpaged (prototype PTEs for paged pool are here)</span>
00387         <span class="comment">// can be put into pte format.</span>
00388         <span class="comment">//</span>
00389 
00390         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>;
00391         Pointer.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (PointerPte);
00392         TempPte = Pointer;
00393         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a>(&amp;TempPte);
00394         <span class="keywordflow">if</span> (PointerPte != PointerPde) {
00395             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"unable to map start of paged pool as prototype pte %p %p\n"</span>,
00396                      PointerPde,
00397                      PointerPte);
00398         }
00399 
00400         PointerPte =
00401                 (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a23">MM_NONPAGED_POOL_END</a> &amp; ~((1 &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>) - 1));
00402 
00403         Pointer.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (PointerPte);
00404         TempPte = Pointer;
00405         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a>(&amp;TempPte);
00406         <span class="keywordflow">if</span> (PointerPte != PointerPde) {
00407             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"unable to map end of nonpaged pool as prototype pte %p %p\n"</span>,
00408                      PointerPde,
00409                      PointerPte);
00410         }
00411 
00412         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(((ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a24">NON_PAGED_SYSTEM_END</a> -
00413                         0x37000 + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
00414 
00415         <span class="keywordflow">for</span> (j = 0; j &lt; 20; j++) {
00416             Pointer.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (PointerPte);
00417             TempPte = Pointer;
00418             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a>(&amp;TempPte);
00419             <span class="keywordflow">if</span> (PointerPte != PointerPde) {
00420                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"unable to map end of nonpaged pool as prototype pte %p %p\n"</span>,
00421                          PointerPde,
00422                          PointerPte);
00423             }
00424 
00425             PointerPte++;
00426         }
00427 
00428         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(((ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a23">MM_NONPAGED_POOL_END</a> - 0x133448) &amp; ~(ULONG_PTR)7);
00429         Pointer.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a149">MiGetSubsectionAddressForPte</a> (PointerPte);
00430         TempPte = Pointer;
00431         PointerPde = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a>(&amp;TempPte);
00432         <span class="keywordflow">if</span> (PointerPte != PointerPde) {
00433             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"unable to map end of nonpaged pool as section pte %p %p\n"</span>,
00434                      PointerPde,
00435                      PointerPte);
00436 
00437             <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(&amp;TempPte);
00438         }
00439 
00440         <span class="comment">//</span>
00441         <span class="comment">// End of sanity checks.</span>
00442         <span class="comment">//</span>
00443 
00444 <span class="preprocessor">#endif //dbg</span>
00445 <span class="preprocessor"></span>
00446         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a30">MmEnforceWriteProtection</a>) {
00447             <a class="code" href="../../d5/d1/mminit_8c.html#a32">MiPteStr</a>[0] = (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)1;
00448         }
00449     
00450         InitializeListHead( &amp;MmLoadedUserImageList );
00451         InitializeListHead( &amp;MmLockConflictList );
00452 
00453         <a class="code" href="../../d4/d8/mi_8h.html#a423">MmCriticalSectionTimeout</a>.QuadPart = Int32x32To64(
00454                                                  MmCritsectTimeoutSeconds,
00455                                                 -10000000);
00456 
00457 
00458         <span class="comment">//</span>
00459         <span class="comment">// Initialize PFN database mutex and System Address Space creation</span>
00460         <span class="comment">// mutex.</span>
00461         <span class="comment">//</span>
00462 
00463         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a> (&amp;MmSectionCommitMutex);
00464         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a> (&amp;MmSectionBasedMutex);
00465         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a> (&amp;MmDynamicMemoryMutex);
00466 
00467         <a class="code" href="../../d3/d5/mutntobj_8c.html#a1">KeInitializeMutant</a> (&amp;MmSystemLoadLock, FALSE);
00468 
00469         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;MmAvailablePagesEvent, NotificationEvent, TRUE);
00470         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;MmAvailablePagesEventHigh, NotificationEvent, TRUE);
00471         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;MmMappedFileIoComplete, NotificationEvent, FALSE);
00472         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;MmImageMappingPteEvent, NotificationEvent, FALSE);
00473         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;MmZeroingPageEvent, SynchronizationEvent, FALSE);
00474         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;MmCollidedFlushEvent, NotificationEvent, FALSE);
00475         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;MmCollidedLockEvent, NotificationEvent, FALSE);
00476         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;MiMappedPagesTooOldEvent, NotificationEvent, FALSE);
00477 
00478         <a class="code" href="../../d4/d1/dpcobj_8c.html#a1">KeInitializeDpc</a>( &amp;MiModifiedPageWriterTimerDpc, MiModifiedPageWriterTimerDispatch, NULL );
00479         <a class="code" href="../../d3/d2/timerobj_8c.html#a2">KeInitializeTimerEx</a>( &amp;MiModifiedPageWriterTimer, SynchronizationTimer );
00480 
00481         <a class="code" href="../../d4/d8/mi_8h.html#a734">MiModifiedPageLife</a>.QuadPart = Int32x32To64(
00482                                                  MmModifiedPageLifeInSeconds,
00483                                                 -10000000);
00484 
00485         InitializeListHead (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>);
00486         InitializeListHead (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a6">MmInPageSupportList</a>.<a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html#o0">ListHead</a>);
00487         InitializeListHead (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a7">MmEventCountList</a>.<a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html#o0">ListHead</a>);
00488 
00489         <a class="code" href="../../d4/d8/mi_8h.html#a612">MmZeroingPageThreadActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00490 
00491         <span class="comment">//</span>
00492         <span class="comment">// Compute physical memory blocks yet again</span>
00493         <span class="comment">//</span>
00494 
00495         Memory = (<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a>)&amp;MemoryAlloc;
00496         Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> = <a class="code" href="../../d2/d1/mm_8h.html#a0">MAX_PHYSICAL_MEMORY_FRAGMENTS</a>;
00497 
00498         <span class="comment">// include all memory types ...</span>
00499         <span class="keywordflow">for</span> (i=0; i &lt; <a class="code" href="../../d1/d9/arc_8h.html#a320a278">LoaderMaximum</a>; i++) {
00500             IncludeType[i] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00501         }
00502 
00503         <span class="comment">// ... expect these..</span>
00504         IncludeType[<a class="code" href="../../d1/d9/arc_8h.html#a320a257">LoaderBad</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00505         IncludeType[<a class="code" href="../../d1/d9/arc_8h.html#a320a260">LoaderFirmwarePermanent</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00506         IncludeType[<a class="code" href="../../d1/d9/arc_8h.html#a320a276">LoaderSpecialMemory</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00507         IncludeType[<a class="code" href="../../d1/d9/arc_8h.html#a320a277">LoaderBBTMemory</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00508 
00509         <a class="code" href="../../d5/d1/mminit_8c.html#a52">MmInitializeMemoryLimits</a>(LoaderBlock, IncludeType, Memory);
00510 
00511 <span class="preprocessor">#if defined (_X86PAE_)</span>
00512 <span class="preprocessor"></span>        MiCheckPaeLicense (LoaderBlock, IncludeType, Memory);
00513 <span class="preprocessor">#endif</span>
00514 <span class="preprocessor"></span>
00515 <span class="preprocessor">#if defined (_X86PAE_) || defined (_WIN64)</span>
00516 <span class="preprocessor"></span>        <a class="code" href="../../d2/d1/mm_8h.html#a132">Mm64BitPhysicalAddress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00517 <span class="preprocessor">#endif</span>
00518 <span class="preprocessor"></span>
00519         <span class="comment">//</span>
00520         <span class="comment">// Add all memory runs in PhysicalMemoryBlock to Memory</span>
00521         <span class="comment">//</span>
00522 
00523         <span class="keywordflow">for</span> (i = 0; i &lt; PhysicalMemoryBlock-&gt;NumberOfRuns; i += 1) {
00524             <a class="code" href="../../d5/d1/mminit_8c.html#a48">MiMergeMemoryLimit</a> (Memory,
00525                                 PhysicalMemoryBlock-&gt;Run[i].BasePage,
00526                                 PhysicalMemoryBlock-&gt;Run[i].PageCount
00527                                 );
00528         }
00529 
00530         <span class="comment">//</span>
00531         <span class="comment">// Sort and merge adjacent runs.</span>
00532         <span class="comment">//</span>
00533 
00534         <span class="keywordflow">for</span> (i=0; i &lt; Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>; i++) {
00535             <span class="keywordflow">for</span> (j=i+1; j &lt; Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>; j++) {
00536                 <span class="keywordflow">if</span> (Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[j].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> &lt; Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>) {
00537                     <span class="comment">// swap runs</span>
00538                     PhysicalMemoryBlock-&gt;Run[0] = Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[j];
00539                     Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[j] = Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i];
00540                     Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i] = PhysicalMemoryBlock-&gt;Run[0];
00541                 }
00542 
00543                 <span class="keywordflow">if</span> (Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> + Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> ==
00544                     Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[j].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>) {
00545                     <span class="comment">// merge runs</span>
00546                     Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> -= 1;
00547                     Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[i].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> += Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[j].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
00548                     Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[j] = Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>];
00549                     i -= 1;
00550                     <span class="keywordflow">break</span>;
00551                 }
00552             }
00553         }
00554 
00555         <span class="comment">//</span>
00556         <span class="comment">// When safebooting, don't enable special pool, the verifier or any</span>
00557         <span class="comment">// other options that track corruption regardless of registry settings.</span>
00558         <span class="comment">//</span>
00559     
00560         <span class="keywordflow">if</span> (strstr(LoaderBlock-&gt;LoadOptions, SAFEBOOT_LOAD_OPTION_A)) {
00561             <a class="code" href="../../d8/d0/cmdat3_8c.html#a10">MmVerifyDriverBufferLength</a> = (ULONG)-1;
00562             <a class="code" href="../../d8/d0/cmdat3_8c.html#a13">MmDontVerifyRandomDrivers</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00563             <a class="code" href="../../d2/d1/mm_8h.html#a159">MmSpecialPoolTag</a> = (ULONG)-1;
00564             <a class="code" href="../../d8/d0/cmdat3_8c.html#a32">MmSnapUnloads</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00565             <a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00566             <a class="code" href="../../d8/d0/cmdat3_8c.html#a30">MmEnforceWriteProtection</a> = 0;
00567             <a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00568             <a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00569         }
00570         <span class="keywordflow">else</span> {
00571             <a class="code" href="../../d4/d8/mi_8h.html#a957">MiTriageSystem</a> (LoaderBlock);
00572         }
00573 
00574         SystemPteMultiplier = 0;
00575 
00576         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> == 0) {
00577 <span class="preprocessor">#if defined (_WIN64)</span>
00578 <span class="preprocessor"></span>
00579             <span class="comment">//</span>
00580             <span class="comment">// 64-bit NT is not contrained by virtual address space.  No</span>
00581             <span class="comment">// tradeoffs between nonpaged pool, paged pool and system PTEs</span>
00582             <span class="comment">// need to be made.  So just allocate PTEs on a linear scale as</span>
00583             <span class="comment">// a function of the amount of RAM.</span>
00584             <span class="comment">//</span>
00585             <span class="comment">// For example on Alpha64, 4gb of RAM gets 128gb of PTEs by default.</span>
00586             <span class="comment">// The page table cost is the inversion of the multiplier based</span>
00587             <span class="comment">// on the PTE_PER_PAGE.</span>
00588             <span class="comment">//</span>
00589 
00590             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (<a class="code" href="../../d8/d0/cmdat3_8c.html#a54">ExpMultiUserTS</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00591                 SystemPteMultiplier = 128;
00592             }
00593             <span class="keywordflow">else</span> {
00594                 SystemPteMultiplier = 64;
00595             }
00596             <span class="keywordflow">if</span> (Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> &lt; 0x8000) {
00597                 SystemPteMultiplier &gt;&gt;= 1;
00598             }
00599 <span class="preprocessor">#else</span>
00600 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> &lt; <a class="code" href="../../d5/d1/mminit_8c.html#a2">MM_MEDIUM_SYSTEM</a>) {
00601                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a27">MM_MINIMUM_SYSTEM_PTES</a>;
00602             } <span class="keywordflow">else</span> {
00603                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a29">MM_DEFAULT_SYSTEM_PTES</a>;
00604                 <span class="keywordflow">if</span> (Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> &gt; 8192) {
00605                     <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> += <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a>;
00606 
00607                     <span class="comment">//</span>
00608                     <span class="comment">// Any reasonable Hydra machine gets the maximum.</span>
00609                     <span class="comment">//</span>
00610 
00611                     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (<a class="code" href="../../d8/d0/cmdat3_8c.html#a54">ExpMultiUserTS</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00612                         <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a28">MM_MAXIMUM_SYSTEM_PTES</a>;
00613                     }
00614                 }
00615             }
00616 <span class="preprocessor">#endif</span>
00617 <span class="preprocessor"></span>        }
00618         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> == (ULONG)-1) {
00619 
00620             <span class="comment">//</span>
00621             <span class="comment">// This registry setting indicates the maximum number of</span>
00622             <span class="comment">// system PTEs possible for this machine must be allocated.</span>
00623             <span class="comment">// Snap this for later reference.</span>
00624             <span class="comment">//</span>
00625         
00626             <a class="code" href="../../d4/d8/mi_8h.html#a633">MiRequestedSystemPtes</a> = <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a>;
00627 
00628 <span class="preprocessor">#if defined (_WIN64)</span>
00629 <span class="preprocessor"></span>            SystemPteMultiplier = 256;
00630 <span class="preprocessor">#else</span>
00631 <span class="preprocessor"></span>            <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a28">MM_MAXIMUM_SYSTEM_PTES</a>;
00632 <span class="preprocessor">#endif</span>
00633 <span class="preprocessor"></span>        }
00634 
00635         <span class="keywordflow">if</span> (SystemPteMultiplier != 0) {
00636             <span class="keywordflow">if</span> (Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> * SystemPteMultiplier &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a28">MM_MAXIMUM_SYSTEM_PTES</a>) {
00637                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a28">MM_MAXIMUM_SYSTEM_PTES</a>;
00638             }
00639             <span class="keywordflow">else</span> {
00640                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = (ULONG)(Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> * SystemPteMultiplier);
00641             }
00642         }
00643 
00644         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a28">MM_MAXIMUM_SYSTEM_PTES</a>)  {
00645             <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a28">MM_MAXIMUM_SYSTEM_PTES</a>;
00646         }
00647 
00648         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a27">MM_MINIMUM_SYSTEM_PTES</a>) {
00649             <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a27">MM_MINIMUM_SYSTEM_PTES</a>;
00650         }
00651 
00652         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a46">MmHeapSegmentReserve</a> == 0) {
00653             <a class="code" href="../../d8/d0/cmdat3_8c.html#a46">MmHeapSegmentReserve</a> = 1024 * 1024;
00654         }
00655 
00656         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a47">MmHeapSegmentCommit</a> == 0) {
00657             <a class="code" href="../../d8/d0/cmdat3_8c.html#a47">MmHeapSegmentCommit</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> * 2;
00658         }
00659 
00660         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a48">MmHeapDeCommitTotalFreeThreshold</a> == 0) {
00661             <a class="code" href="../../d8/d0/cmdat3_8c.html#a48">MmHeapDeCommitTotalFreeThreshold</a> = 64 * 1024;
00662         }
00663 
00664         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a49">MmHeapDeCommitFreeBlockThreshold</a> == 0) {
00665             <a class="code" href="../../d8/d0/cmdat3_8c.html#a49">MmHeapDeCommitFreeBlockThreshold</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00666         }
00667 
00668 <span class="preprocessor">#ifndef NO_POOL_CHECKS</span>
00669 <span class="preprocessor"></span>        <a class="code" href="../../d5/d1/mminit_8c.html#a50">MiInitializeSpecialPoolCriteria</a> ();
00670 <span class="preprocessor">#endif</span>
00671 <span class="preprocessor"></span>
00672         <span class="comment">//</span>
00673         <span class="comment">// If the registry indicates drivers are in the suspect list,</span>
00674         <span class="comment">// extra system PTEs need to be allocated to support special pool</span>
00675         <span class="comment">// for their allocations.</span>
00676         <span class="comment">//</span>
00677 
00678         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a10">MmVerifyDriverBufferLength</a> != (ULONG)-1) ||
00679             ((<a class="code" href="../../d2/d1/mm_8h.html#a159">MmSpecialPoolTag</a> != 0) &amp;&amp; (<a class="code" href="../../d2/d1/mm_8h.html#a159">MmSpecialPoolTag</a> != (ULONG)-1))) {
00680             <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> += <a class="code" href="../../d4/d8/mi_8h.html#a248">MM_SPECIAL_POOL_PTES</a>;
00681         }
00682 
00683         <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> += <a class="code" href="../../d5/d1/mminit_8c.html#a13">BBTPagesToReserve</a>;
00684 
00685         <span class="comment">//</span>
00686         <span class="comment">// Initialize the machine dependent portion of the hardware.</span>
00687         <span class="comment">//</span>
00688 
00689         <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a> (&amp;MmSystemWsLock);
00690 
00691         <a class="code" href="../../d2/d3/initppc_8c.html#a1">MiInitMachineDependent</a> (LoaderBlock);
00692 
00693 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00694 <span class="preprocessor"></span>        MiPfnProtectionEnabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00695 <span class="preprocessor">#endif</span>
00696 <span class="preprocessor"></span>
00697         <a class="code" href="../../d8/d8/sysload_8c.html#a64">MiReloadBootLoadedDrivers</a> (LoaderBlock);
00698 
00699         <a class="code" href="../../d9/d5/verifier_8c.html#a109">MiInitializeDriverVerifierList</a> (LoaderBlock);
00700 
00701         j = (<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PHYSICAL_MEMORY_DESCRIPTOR</a>) +
00702              (<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a>) *
00703                     (Memory-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> - 1)));
00704 
00705         <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPoolMustSucceed,
00706                                                        j,
00707                                                        '  mM');
00708 
00709         RtlCopyMemory (MmPhysicalMemoryBlock, Memory, j);
00710 
00711         <span class="comment">//</span>
00712         <span class="comment">// Setup the system size as small, medium, or large depending</span>
00713         <span class="comment">// on memory available.</span>
00714         <span class="comment">//</span>
00715         <span class="comment">// For internal MM tuning, the following applies</span>
00716         <span class="comment">//</span>
00717         <span class="comment">// 12Mb  is small</span>
00718         <span class="comment">// 12-19 is medium</span>
00719         <span class="comment">// &gt; 19 is large</span>
00720         <span class="comment">//</span>
00721         <span class="comment">//</span>
00722         <span class="comment">// For all other external tuning,</span>
00723         <span class="comment">// &lt; 19 is small</span>
00724         <span class="comment">// 19 - 31 is medium for workstation</span>
00725         <span class="comment">// 19 - 63 is medium for server</span>
00726         <span class="comment">// &gt;= 32 is large for workstation</span>
00727         <span class="comment">// &gt;= 64 is large for server</span>
00728         <span class="comment">//</span>
00729 
00730         <a class="code" href="../../d2/d1/mm_8h.html#a134">MmReadClusterSize</a> = 7;
00731         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt;= <a class="code" href="../../d5/d1/mminit_8c.html#a1">MM_SMALL_SYSTEM</a> ) {
00732             <a class="code" href="../../d5/d1/mminit_8c.html#a37">MmSystemSize</a> = <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>;
00733             <a class="code" href="../../d4/d8/mi_8h.html#a669">MmMaximumDeadKernelStacks</a> = 0;
00734             <a class="code" href="../../d4/d8/mi_8h.html#a729">MmModifiedPageMinimum</a> = 40;
00735             <a class="code" href="../../d4/d8/mi_8h.html#a728">MmModifiedPageMaximum</a> = 100;
00736             <a class="code" href="../../d4/d8/mi_8h.html#a682">MmDataClusterSize</a> = 0;
00737             <a class="code" href="../../d4/d8/mi_8h.html#a683">MmCodeClusterSize</a> = 1;
00738             <a class="code" href="../../d2/d1/mm_8h.html#a134">MmReadClusterSize</a> = 2;
00739 
00740         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt;= <a class="code" href="../../d5/d1/mminit_8c.html#a2">MM_MEDIUM_SYSTEM</a> ) {
00741             <a class="code" href="../../d5/d1/mminit_8c.html#a37">MmSystemSize</a> = <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>;
00742             <a class="code" href="../../d4/d8/mi_8h.html#a669">MmMaximumDeadKernelStacks</a> = 2;
00743             <a class="code" href="../../d4/d8/mi_8h.html#a729">MmModifiedPageMinimum</a> = 80;
00744             <a class="code" href="../../d4/d8/mi_8h.html#a728">MmModifiedPageMaximum</a> = 150;
00745             <a class="code" href="../../d4/d8/mi_8h.html#a663">MmSystemCacheWsMinimum</a> += 100;
00746             <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> += 150;
00747             <a class="code" href="../../d4/d8/mi_8h.html#a682">MmDataClusterSize</a> = 1;
00748             <a class="code" href="../../d4/d8/mi_8h.html#a683">MmCodeClusterSize</a> = 2;
00749             <a class="code" href="../../d2/d1/mm_8h.html#a134">MmReadClusterSize</a> = 4;
00750 
00751         } <span class="keywordflow">else</span> {
00752             <a class="code" href="../../d5/d1/mminit_8c.html#a37">MmSystemSize</a> = <a class="code" href="../../d2/d1/mm_8h.html#a343a166">MmMediumSystem</a>;
00753             <a class="code" href="../../d4/d8/mi_8h.html#a669">MmMaximumDeadKernelStacks</a> = 5;
00754             <a class="code" href="../../d4/d8/mi_8h.html#a729">MmModifiedPageMinimum</a> = 150;
00755             <a class="code" href="../../d4/d8/mi_8h.html#a728">MmModifiedPageMaximum</a> = 300;
00756             <a class="code" href="../../d4/d8/mi_8h.html#a663">MmSystemCacheWsMinimum</a> += 400;
00757             <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> += 800;
00758             <a class="code" href="../../d4/d8/mi_8h.html#a682">MmDataClusterSize</a> = 3;
00759             <a class="code" href="../../d4/d8/mi_8h.html#a683">MmCodeClusterSize</a> = 7;
00760         }
00761 
00762         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt; ((24*1024*1024)/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
00763             <a class="code" href="../../d4/d8/mi_8h.html#a663">MmSystemCacheWsMinimum</a> = 32;
00764         }
00765 
00766         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt;= ((32*1024*1024)/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
00767 
00768             <span class="comment">//</span>
00769             <span class="comment">// If we are on a workstation, 32Mb and above are considered large systems</span>
00770             <span class="comment">//</span>
00771             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d0/cmdat3_8c.html#a52">MmProductType</a> == 0x00690057 ) {
00772                 <a class="code" href="../../d5/d1/mminit_8c.html#a37">MmSystemSize</a> = <a class="code" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a>;
00773 
00774             } <span class="keywordflow">else</span> {
00775 
00776                 <span class="comment">//</span>
00777                 <span class="comment">// For servers, 64Mb and greater is a large system</span>
00778                 <span class="comment">//</span>
00779 
00780                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt;= ((64*1024*1024)/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
00781                     <a class="code" href="../../d5/d1/mminit_8c.html#a37">MmSystemSize</a> = <a class="code" href="../../d2/d1/mm_8h.html#a343a167">MmLargeSystem</a>;
00782                 }
00783             }
00784         }
00785 
00786         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt; ((33*1024*1024)/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
00787             <a class="code" href="../../d4/d8/mi_8h.html#a729">MmModifiedPageMinimum</a> = 400;
00788             <a class="code" href="../../d4/d8/mi_8h.html#a728">MmModifiedPageMaximum</a> = 800;
00789             <a class="code" href="../../d4/d8/mi_8h.html#a663">MmSystemCacheWsMinimum</a> += 500;
00790             <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> += 900;
00791         }
00792 
00793         <span class="comment">//</span>
00794         <span class="comment">// determine if we are on an AS system ( Winnt is not AS)</span>
00795         <span class="comment">//</span>
00796 
00797         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a52">MmProductType</a> == 0x00690057) {
00798             SharedUserData-&gt;NtProductType = NtProductWinNt;
00799             <a class="code" href="../../d8/d0/cmdat3_8c.html#a52">MmProductType</a> = 0;
00800             <a class="code" href="../../d2/d1/mm_8h.html#a151">MmThrottleTop</a> = 250;
00801             <a class="code" href="../../d2/d1/mm_8h.html#a152">MmThrottleBottom</a> = 30;
00802 
00803         } <span class="keywordflow">else</span> {
00804             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d0/cmdat3_8c.html#a52">MmProductType</a> == 0x0061004c ) {
00805                 SharedUserData-&gt;NtProductType = NtProductLanManNt;
00806 
00807             } <span class="keywordflow">else</span> {
00808                 SharedUserData-&gt;NtProductType = NtProductServer;
00809             }
00810 
00811             <a class="code" href="../../d8/d0/cmdat3_8c.html#a52">MmProductType</a> = 1;
00812             <a class="code" href="../../d2/d1/mm_8h.html#a151">MmThrottleTop</a> = 450;
00813             <a class="code" href="../../d2/d1/mm_8h.html#a152">MmThrottleBottom</a> = 80;
00814             <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a> = 81;
00815         }
00816 
00817         <a class="code" href="../../d5/d0/wsmanage_8c.html#a39">MiAdjustWorkingSetManagerParameters</a>((BOOLEAN)(MmProductType == 0 ? TRUE : FALSE));
00818 
00819         <span class="comment">//</span>
00820         <span class="comment">// Set the ResidentAvailablePages to the number of available</span>
00821         <span class="comment">// pages minus the fluid value.</span>
00822         <span class="comment">//</span>
00823 
00824         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> = <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> - <a class="code" href="../../d4/d8/mi_8h.html#a16">MM_FLUID_PHYSICAL_PAGES</a>;
00825 
00826         <span class="comment">//</span>
00827         <span class="comment">// Subtract off the size of the system cache working set.</span>
00828         <span class="comment">//</span>
00829 
00830         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= <a class="code" href="../../d4/d8/mi_8h.html#a663">MmSystemCacheWsMinimum</a>;
00831         <a class="code" href="../../d5/d1/mminit_8c.html#a18">MmResidentAvailableAtInit</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a>;
00832 
00833 
00834         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> &lt; 0) {
00835 <span class="preprocessor">#if DBG</span>
00836 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"system cache working set too big\n"</span>);
00837 <span class="preprocessor">#endif</span>
00838 <span class="preprocessor"></span>            <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00839         }
00840 
00841         <span class="comment">//</span>
00842         <span class="comment">// Initialize spin lock for charging and releasing page file</span>
00843         <span class="comment">// commitment.</span>
00844         <span class="comment">//</span>
00845 
00846         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;MmChargeCommitmentLock);
00847 
00848         <a class="code" href="../../d4/d8/mi_8h.html#a817">MiInitializeIoTrackers</a> ();
00849 
00850         <span class="comment">//</span>
00851         <span class="comment">// Initialize spin lock for allowing working set expansion.</span>
00852         <span class="comment">//</span>
00853 
00854         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;MmExpansionLock);
00855 
00856         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a> (&amp;MmPageFileCreationLock);
00857 
00858         <span class="comment">//</span>
00859         <span class="comment">// Initialize resource for extending sections.</span>
00860         <span class="comment">//</span>
00861 
00862         <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a> (&amp;MmSectionExtendResource);
00863         <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a> (&amp;MmSectionExtendSetResource);
00864 
00865         <span class="comment">//</span>
00866         <span class="comment">// Build the system cache structures.</span>
00867         <span class="comment">//</span>
00868 
00869         StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MmSystemCacheWorkingSetList);
00870         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MmSystemCacheWorkingSetList);
00871 
00872 <span class="preprocessor">#if defined (_WIN64)</span>
00873 <span class="preprocessor"></span>
00874         StartPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(StartPde);
00875 
00876         TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
00877 
00878         <span class="keywordflow">if</span> (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00879 
00880             <span class="comment">//</span>
00881             <span class="comment">// Map in a page directory page for the system cache working set.</span>
00882             <span class="comment">// Note that we only populate one page table for this.</span>
00883             <span class="comment">//</span>
00884 
00885             DirectoryFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a>(
00886                 MI_GET_PAGE_COLOR_FROM_PTE (StartPpe));
00887             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = DirectoryFrameIndex;
00888             *StartPpe = TempPte;
00889 
00890 
00891             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(DirectoryFrameIndex);
00892             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (
00893                                   <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PDE_KTBASE));
00894             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = StartPpe;
00895             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00896             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00897             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
00898             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
00899 
00900             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (StartPde,
00901                              PAGE_SIZE,
00902                              <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00903         }
00904 
00905         <span class="comment">//</span>
00906         <span class="comment">// Map in a page table page.</span>
00907         <span class="comment">//</span>
00908 
00909         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00910 
00911         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a>(
00912                                 MI_GET_PAGE_COLOR_FROM_PTE (StartPde));
00913         TempPte.u.Hard.PageFrameNumber = PageFrameIndex;
00914         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (StartPde, TempPte);
00915 
00916         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
00917         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = DirectoryFrameIndex;
00918         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = StartPde;
00919         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00920         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00921         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
00922         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
00923 
00924         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (MiGetVirtualAddressMappedByPte (StartPde),
00925                          PAGE_SIZE,
00926                          <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00927 
00928         StartPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(MmSystemCacheStart);
00929         StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MmSystemCacheStart);
00930         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (StartPde);
00931 
00932 <span class="preprocessor">#else</span>
00933 <span class="preprocessor"></span><span class="preprocessor">#if !defined(_X86PAE_)</span>
00934 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((StartPde + 1) == MiGetPdeAddress (MmSystemCacheStart));
00935 <span class="preprocessor">#endif</span>
00936 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00937 <span class="preprocessor"></span>
00938         MaximumSystemCacheSizeTotal = MaximumSystemCacheSize;
00939 
00940 <span class="preprocessor">#if defined(_X86_)</span>
00941 <span class="preprocessor"></span>        MaximumSystemCacheSizeTotal += <a class="code" href="../../d2/d2/data386_8c.html#a28">MiMaximumSystemCacheSizeExtra</a>;
00942 <span class="preprocessor">#endif</span>
00943 <span class="preprocessor"></span>
00944         <span class="comment">//</span>
00945         <span class="comment">// Size the system cache based on the amount of physical memory.</span>
00946         <span class="comment">//</span>
00947 
00948         i = (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> + 65) / 1024;
00949 
00950         <span class="keywordflow">if</span> (i &gt;= 4) {
00951 
00952             <span class="comment">//</span>
00953             <span class="comment">// System has at least 4032 pages.  Make the system</span>
00954             <span class="comment">// cache 128mb + 64mb for each additional 1024 pages.</span>
00955             <span class="comment">//</span>
00956 
00957             <a class="code" href="../../d2/d1/mm_8h.html#a137">MmSizeOfSystemCacheInPages</a> = (PFN_COUNT)(
00958                             ((128*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) +
00959                             ((i - 4) * ((64*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)));
00960             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a137">MmSizeOfSystemCacheInPages</a> &gt; MaximumSystemCacheSizeTotal) {
00961                 <a class="code" href="../../d2/d1/mm_8h.html#a137">MmSizeOfSystemCacheInPages</a> = MaximumSystemCacheSizeTotal;
00962             }
00963         }
00964 
00965         <a class="code" href="../../d8/d5/kddata_8c.html#a12">MmSystemCacheEnd</a> = (PVOID)(((PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a11">MmSystemCacheStart</a> +
00966                     <a class="code" href="../../d2/d1/mm_8h.html#a137">MmSizeOfSystemCacheInPages</a> * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) - 1);
00967 
00968 <span class="preprocessor">#if defined(_X86_)</span>
00969 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a137">MmSizeOfSystemCacheInPages</a> &gt; MaximumSystemCacheSize) {
00970             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiMaximumSystemCacheSizeExtra != 0);
00971             <a class="code" href="../../d8/d5/kddata_8c.html#a12">MmSystemCacheEnd</a> = (PVOID)(((PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a11">MmSystemCacheStart</a> +
00972                         MaximumSystemCacheSize * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) - 1);
00973 
00974             <a class="code" href="../../d2/d2/data386_8c.html#a29">MiSystemCacheStartExtra</a> = (PVOID)<a class="code" href="../../d6/d8/mi386_8h.html#a33">MM_SYSTEM_CACHE_START_EXTRA</a>;
00975             <a class="code" href="../../d2/d2/data386_8c.html#a30">MiSystemCacheEndExtra</a> = (PVOID)(((PCHAR)<a class="code" href="../../d2/d2/data386_8c.html#a29">MiSystemCacheStartExtra</a> +
00976                         (<a class="code" href="../../d2/d1/mm_8h.html#a137">MmSizeOfSystemCacheInPages</a> - MaximumSystemCacheSize) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) - 1);
00977         }
00978                 <span class="keywordflow">else</span> {
00979             <a class="code" href="../../d2/d2/data386_8c.html#a29">MiSystemCacheStartExtra</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a11">MmSystemCacheStart</a>;
00980             <a class="code" href="../../d2/d2/data386_8c.html#a30">MiSystemCacheEndExtra</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a12">MmSystemCacheEnd</a>;
00981                 }
00982 <span class="preprocessor">#endif</span>
00983 <span class="preprocessor"></span>
00984         EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MmSystemCacheEnd);
00985 
00986         TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
00987 
00988 <span class="preprocessor">#if defined(_WIN64)</span>
00989 <span class="preprocessor"></span>        First = (StartPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00990 <span class="preprocessor">#endif</span>
00991 <span class="preprocessor"></span>
00992 <span class="preprocessor">#if !defined (_WIN64)</span>
00993 <span class="preprocessor"></span>        DirectoryFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PDE_BASE));
00994 <span class="preprocessor">#endif</span>
00995 <span class="preprocessor"></span>
00996         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00997         <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
00998 
00999 <span class="preprocessor">#if defined (_WIN64)</span>
01000 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (First == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> || <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(StartPde)) {
01001                 First = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01002                 StartPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(StartPde);
01003 
01004                 <span class="comment">//</span>
01005                 <span class="comment">// Map in a page directory page.</span>
01006                 <span class="comment">//</span>
01007 
01008                 DirectoryFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a>(
01009                                         MI_GET_PAGE_COLOR_FROM_PTE (StartPpe));
01010                 TempPte.u.Hard.PageFrameNumber = DirectoryFrameIndex;
01011                 *StartPpe = TempPte;
01012 
01013                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(DirectoryFrameIndex);
01014                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (
01015                                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PDE_KTBASE));
01016                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = StartPpe;
01017                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01018                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
01019                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01020                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
01021 
01022                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (StartPde,
01023                                  PAGE_SIZE,
01024                                  <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01025             }
01026 <span class="preprocessor">#endif</span>
01027 <span class="preprocessor"></span>
01028             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
01029 
01030             <span class="comment">//</span>
01031             <span class="comment">// Map in a page table page.</span>
01032             <span class="comment">//</span>
01033 
01034             PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a>(
01035                                     MI_GET_PAGE_COLOR_FROM_PTE (StartPde));
01036             TempPte.u.Hard.PageFrameNumber = PageFrameIndex;
01037             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (StartPde, TempPte);
01038 
01039             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
01040             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = DirectoryFrameIndex;
01041             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = StartPde;
01042             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01043             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
01044             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01045             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
01046 
01047             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (PointerPte,
01048                              PAGE_SIZE,
01049                              <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01050 
01051             StartPde += 1;
01052             PointerPte += <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>;
01053         }
01054 
01055 <span class="preprocessor">#if defined(_X86_)</span>
01056 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/data386_8c.html#a30">MiSystemCacheEndExtra</a> != <a class="code" href="../../d8/d5/kddata_8c.html#a12">MmSystemCacheEnd</a>) {
01057 
01058             StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MiSystemCacheStartExtra);
01059                         EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MiSystemCacheEndExtra);
01060 
01061                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MiSystemCacheStartExtra);
01062 
01063                         <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
01064 
01065                                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
01066 
01067                 <span class="comment">//</span>
01068                 <span class="comment">// Map in a page directory page.</span>
01069                 <span class="comment">//</span>
01070 
01071                 PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a>(
01072                                         MI_GET_PAGE_COLOR_FROM_PTE (StartPde));
01073                 TempPte.u.Hard.PageFrameNumber = PageFrameIndex;
01074                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (StartPde, TempPte);
01075 
01076                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
01077                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (
01078                                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PDE_BASE));
01079                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = StartPde;
01080                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01081                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
01082                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01083                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
01084 
01085                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (PointerPte,
01086                                  PAGE_SIZE,
01087                                  <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01088 
01089                 StartPde += 1;
01090                 PointerPte += <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>;
01091             }
01092         }
01093 <span class="preprocessor">#endif</span>
01094 <span class="preprocessor"></span>
01095         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01096 
01097         <span class="comment">//</span>
01098         <span class="comment">// Initialize the system cache.  Only set the large system cache if</span>
01099         <span class="comment">// we have a large amount of physical memory.</span>
01100         <span class="comment">//</span>
01101 
01102         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/fssup_8c.html#a4">MmLargeSystemCache</a> != 0 &amp;&amp; <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt; 0x7FF0) {
01103             <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt;
01104                     <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> + ((64*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>))) {
01105                 <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> =
01106                             <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> - ((32*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01107                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)MmSystemCacheWsMaximum &gt; (LONG)MmSystemCacheWsMinimum);
01108                 <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a> = 256;
01109             }
01110         }
01111 
01112         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> &gt; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a70">MM_MAXIMUM_WORKING_SET</a> - 5)) {
01113             <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a70">MM_MAXIMUM_WORKING_SET</a> - 5;
01114         }
01115 
01116         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> &gt; <a class="code" href="../../d2/d1/mm_8h.html#a137">MmSizeOfSystemCacheInPages</a>) {
01117             <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> = <a class="code" href="../../d2/d1/mm_8h.html#a137">MmSizeOfSystemCacheInPages</a>;
01118             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a663">MmSystemCacheWsMinimum</a> + 500) &gt; <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a>) {
01119                 <a class="code" href="../../d4/d8/mi_8h.html#a663">MmSystemCacheWsMinimum</a> = <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a> - 500;
01120             }
01121         }
01122 
01123         <a class="code" href="../../d4/d8/mi_8h.html#a910">MiInitializeSystemCache</a> ((ULONG)MmSystemCacheWsMinimum,
01124                                  (ULONG)MmSystemCacheWsMaximum);
01125 
01126         <span class="comment">//</span>
01127         <span class="comment">// Set the commit page limit to four times the number of available</span>
01128         <span class="comment">// pages. This value is updated as paging files are created.</span>
01129         <span class="comment">//</span>
01130 
01131         <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> = <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt;&lt; 2;
01132         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>;
01133 
01134         <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o0">Segment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01135         <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o2">RequestedExpansionSize</a> = 1;
01136         <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o3">ActualExpansion</a> = 1;
01137         <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o5">InProgress</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01138         <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o6">PageFileNumber</a> = <a class="code" href="../../d4/d8/mi_8h.html#a221">MI_EXTEND_ANY_PAGEFILE</a>;
01139 
01140         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>.<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o4">Event</a>,
01141                            NotificationEvent,
01142                            FALSE);
01143 
01144         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a20">MmOverCommit</a> == 0) {
01145 
01146             <span class="comment">// If this value was not set via the registry, set the</span>
01147             <span class="comment">// over commit value to the number of available pages</span>
01148             <span class="comment">// minus 1024 pages (4mb with 4k pages).</span>
01149             <span class="comment">//</span>
01150 
01151             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; 1024) {
01152                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a20">MmOverCommit</a> = <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> - 1024;
01153             }
01154         }
01155 
01156         <span class="comment">//</span>
01157         <span class="comment">// Set maximum working set size to 512 pages less total available</span>
01158         <span class="comment">// memory.  2mb on machine with 4k pages.</span>
01159         <span class="comment">//</span>
01160 
01161         <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a> = (ULONG)(<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> - 512);
01162 
01163         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a> &gt; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a70">MM_MAXIMUM_WORKING_SET</a> - 5)) {
01164             <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a70">MM_MAXIMUM_WORKING_SET</a> - 5;
01165         }
01166 
01167         <span class="comment">//</span>
01168         <span class="comment">// Create the modified page writer event.</span>
01169         <span class="comment">//</span>
01170 
01171         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;MmModifiedPageWriterEvent, NotificationEvent, FALSE);
01172 
01173         <span class="comment">//</span>
01174         <span class="comment">// Build paged pool.</span>
01175         <span class="comment">//</span>
01176 
01177         <a class="code" href="../../d5/d1/mminit_8c.html#a47">MiBuildPagedPool</a> ();
01178 
01179         <span class="comment">//</span>
01180         <span class="comment">// Initialize the loaded module list.  This cannot be done until</span>
01181         <span class="comment">// paged pool has been built.</span>
01182         <span class="comment">//</span>
01183 
01184         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/sysload_8c.html#a66">MiInitializeLoadedModuleList</a> (LoaderBlock) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01185 <span class="preprocessor">#if DBG</span>
01186 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Loaded module list initialization failed\n"</span>);
01187 <span class="preprocessor">#endif</span>
01188 <span class="preprocessor"></span>            <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01189         }
01190 
01191         <span class="comment">//</span>
01192         <span class="comment">// Initialize the unused segment thresholds.  The assumption is made</span>
01193         <span class="comment">// that the filesystem will tack on approximately a 1024-byte paged</span>
01194         <span class="comment">// pool charge (regardless of file size) for each file in the cache.</span>
01195         <span class="comment">//</span>
01196 
01197         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a24">MmUnusedSegmentTrimLevel</a> &lt; 5) {
01198             <a class="code" href="../../d8/d0/cmdat3_8c.html#a24">MmUnusedSegmentTrimLevel</a> = 5;
01199         }
01200         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a24">MmUnusedSegmentTrimLevel</a> &gt; 40) {
01201             <a class="code" href="../../d8/d0/cmdat3_8c.html#a24">MmUnusedSegmentTrimLevel</a> = 40;
01202         }
01203         
01204         <a class="code" href="../../d4/d8/mi_8h.html#a700">MmMaxUnusedSegmentPagedPoolUsage</a> = (<a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> / 100) * (<a class="code" href="../../d8/d0/cmdat3_8c.html#a24">MmUnusedSegmentTrimLevel</a> &lt;&lt; 1);
01205         <a class="code" href="../../d4/d8/mi_8h.html#a703">MmUnusedSegmentPagedPoolReduction</a> = <a class="code" href="../../d4/d8/mi_8h.html#a700">MmMaxUnusedSegmentPagedPoolUsage</a> &gt;&gt; 2;
01206 
01207         <a class="code" href="../../d4/d8/mi_8h.html#a704">MmMaxUnusedSegmentNonPagedPoolUsage</a> = (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> / 100) * (<a class="code" href="../../d8/d0/cmdat3_8c.html#a24">MmUnusedSegmentTrimLevel</a> &lt;&lt; 1);
01208         <a class="code" href="../../d4/d8/mi_8h.html#a707">MmUnusedSegmentNonPagedPoolReduction</a> = <a class="code" href="../../d4/d8/mi_8h.html#a704">MmMaxUnusedSegmentNonPagedPoolUsage</a> &gt;&gt; 2;
01209 
01210         <span class="comment">//</span>
01211         <span class="comment">// Add more system PTEs if this is a large memory system.</span>
01212         <span class="comment">// Note that 64 bit systems can determine the right value at the</span>
01213         <span class="comment">// beginning since there is no virtual address space crunch.</span>
01214         <span class="comment">//</span>
01215 
01216 <span class="preprocessor">#if !defined (_WIN64)</span>
01217 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt; ((127*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01218 
01219             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> ((PCHAR)MmPagedPoolEnd + 1);
01220             StartingPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PCHAR)MmPagedPoolEnd + 1);
01221             j = 0;
01222 
01223             TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a7">ValidKernelPde</a>;
01224             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01225             <span class="keywordflow">while</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01226 
01227                 <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (1, TRUE);
01228                 <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_EXTRA_SYSTEM_PTES, 1);
01229 
01230                 PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> (
01231                                     MI_GET_PAGE_COLOR_FROM_PTE (PointerPde));
01232                 TempPte.u.Hard.PageFrameNumber = PageFrameIndex;
01233                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPde, TempPte);
01234                 <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPde, 1);
01235                 PointerPde += 1;
01236                 StartingPte += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>);
01237                 j += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>);
01238             }
01239 
01240             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01241 
01242             <span class="keywordflow">if</span> (j != 0) {
01243                 StartingPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PCHAR)MmPagedPoolEnd + 1);
01244                 <a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (StartingPte);
01245                 <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> += j;
01246                 <a class="code" href="../../d0/d9/sysptes_8c.html#a28">MiAddSystemPtes</a> (StartingPte, j, SystemPteSpace);
01247             }
01248         }
01249 <span class="preprocessor">#endif</span>
01250 <span class="preprocessor"></span>
01251 
01252 <span class="preprocessor">#if DBG</span>
01253 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a68">MM_DBG_DUMP_BOOT_PTES</a>) {
01254             <a class="code" href="../../d4/d8/mi_8h.html#a965">MiDumpValidAddresses</a> ();
01255             <a class="code" href="../../d4/d8/mi_8h.html#a966">MiDumpPfn</a> ();
01256         }
01257 <span class="preprocessor">#endif</span>
01258 <span class="preprocessor"></span>
01259         <a class="code" href="../../d4/d8/mi_8h.html#a746">MmPageFaultNotifyRoutine</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01260         <a class="code" href="../../d4/d8/mi_8h.html#a747">MmHardFaultNotifyRoutine</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01261 
01262         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01263     }
01264 
01265     <span class="keywordflow">if</span> (Phase == 1) {
01266 
01267 <span class="preprocessor">#if DBG</span>
01268 <span class="preprocessor"></span>        MmDebug |= <a class="code" href="../../d4/d8/mi_8h.html#a74">MM_DBG_CHECK_PFN_LOCK</a>;
01269 <span class="preprocessor">#endif</span>
01270 <span class="preprocessor"></span>
01271 <span class="preprocessor">#ifdef _X86_</span>
01272 <span class="preprocessor"></span>        <a class="code" href="../../d2/d3/initppc_8c.html#a1">MiInitMachineDependent</a> (LoaderBlock);
01273 <span class="preprocessor">#endif</span>
01274 <span class="preprocessor"></span>        <a class="code" href="../../d5/d1/mminit_8c.html#a43">MiMapBBTMemory</a>(LoaderBlock);
01275 
01276         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/sectsup_8c.html#a20">MiSectionInitialization</a> ()) {
01277             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01278         }
01279 
01280         Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
01281         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o61">PhysicalVadList</a>.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01282             <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o90">AweLock</a>);
01283             InitializeListHead (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o61">PhysicalVadList</a>);
01284         }
01285 
01286 <span class="preprocessor">#if defined(MM_SHARED_USER_DATA_VA)</span>
01287 <span class="preprocessor"></span>
01288         <span class="comment">//</span>
01289         <span class="comment">// Create double mapped page between kernel and user mode.</span>
01290         <span class="comment">//</span>
01291 
01292         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(KI_USER_SHARED_DATA);
01293         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
01294         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
01295 
01296         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (MmSharedUserDataPte,
01297                            PageFrameIndex,
01298                            MM_READONLY,
01299                            PointerPte);
01300         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01301 
01302         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01303 
01304         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
01305 
01306         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01307 <span class="preprocessor">#endif</span>
01308 <span class="preprocessor"></span>
01309         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01310             <a class="code" href="../../d4/d7/sessload_8c.html#a15">MiSessionWideInitializeAddresses</a> ();
01311             <a class="code" href="../../d4/d0/wslist_8c.html#a28">MiInitializeSessionWsSupport</a> ();
01312             <a class="code" href="../../d3/d7/session_8c.html#a7">MiInitializeSessionIds</a> ();
01313         }
01314 
01315         <span class="comment">//</span>
01316         <span class="comment">// Set up system wide lock pages limit.</span>
01317         <span class="comment">//</span>
01318 
01319         <span class="keywordflow">if</span> ((MmLockPagesPercentage &lt; 5) || (MmLockPagesPercentage &gt;= 100)) {
01320 
01321             <span class="comment">//</span>
01322             <span class="comment">// No (reasonable or max) registry override from the user</span>
01323             <span class="comment">// so default to allowing all available memory.</span>
01324             <span class="comment">//</span>
01325 
01326             <a class="code" href="../../d4/d8/mi_8h.html#a635">MmLockPagesLimit</a> = (PFN_NUMBER)-1;
01327         }
01328         <span class="keywordflow">else</span> {
01329 
01330             <span class="comment">//</span>
01331             <span class="comment">// Use the registry value - note it is expressed as a percentage.</span>
01332             <span class="comment">//</span>
01333 
01334             <a class="code" href="../../d4/d8/mi_8h.html#a635">MmLockPagesLimit</a> = (PFN_NUMBER)((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> * <a class="code" href="../../d8/d0/cmdat3_8c.html#a21">MmLockPagesPercentage</a>) / 100);
01335         }
01336 
01337         <span class="comment">//</span>
01338         <span class="comment">// Start the modified page writer.</span>
01339         <span class="comment">//</span>
01340 
01341         InitializeObjectAttributes( &amp;ObjectAttributes, NULL, 0, NULL, NULL );
01342 
01343         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a>(
01344                         &amp;ThreadHandle,
01345                         THREAD_ALL_ACCESS,
01346                         &amp;ObjectAttributes,
01347                         0L,
01348                         NULL,
01349                         MiModifiedPageWriter,
01350                         NULL
01351                         ))) {
01352             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01353         }
01354         ZwClose (ThreadHandle);
01355 
01356         <span class="comment">//</span>
01357         <span class="comment">// Start the balance set manager.</span>
01358         <span class="comment">//</span>
01359         <span class="comment">// The balance set manager performs stack swapping and working</span>
01360         <span class="comment">// set management and requires two threads.</span>
01361         <span class="comment">//</span>
01362 
01363         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;MmWorkingSetManagerEvent,
01364                            SynchronizationEvent,
01365                            FALSE);
01366 
01367         InitializeObjectAttributes( &amp;ObjectAttributes, NULL, 0, NULL, NULL );
01368 
01369         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a>(
01370                         &amp;ThreadHandle,
01371                         THREAD_ALL_ACCESS,
01372                         &amp;ObjectAttributes,
01373                         0L,
01374                         NULL,
01375                         KeBalanceSetManager,
01376                         NULL
01377                         ))) {
01378 
01379             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01380         }
01381         ZwClose (ThreadHandle);
01382 
01383         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a>(
01384                         &amp;ThreadHandle,
01385                         THREAD_ALL_ACCESS,
01386                         &amp;ObjectAttributes,
01387                         0L,
01388                         NULL,
01389                         KeSwapProcessOrStack,
01390                         NULL
01391                         ))) {
01392 
01393             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01394         }
01395         ZwClose (ThreadHandle);
01396 
01397 <span class="preprocessor">#ifndef NO_POOL_CHECKS</span>
01398 <span class="preprocessor"></span>        <a class="code" href="../../d5/d1/mminit_8c.html#a50">MiInitializeSpecialPoolCriteria</a> ();
01399 <span class="preprocessor">#endif</span>
01400 <span class="preprocessor"></span>
01401 <span class="preprocessor">#if defined(_X86_)</span>
01402 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a964">MiEnableKernelVerifier</a> ();
01403 <span class="preprocessor">#endif</span>
01404 <span class="preprocessor"></span>
01405         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;PsLoadedModuleResource, TRUE);
01406 
01407         NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
01408     
01409         <span class="keywordflow">for</span> ( ; NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>; NextEntry = NextEntry-&gt;Flink) {
01410     
01411             DataTableEntry = CONTAINING_RECORD(NextEntry,
01412                                                LDR_DATA_TABLE_ENTRY,
01413                                                InLoadOrderLinks);
01414     
01415             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(DataTableEntry-&gt;DllBase);
01416 
01417             <span class="keywordflow">if</span> ((NtHeaders-&gt;OptionalHeader.MajorOperatingSystemVersion &gt;= 5) &amp;&amp;
01418                 (NtHeaders-&gt;OptionalHeader.MajorImageVersion &gt;= 5)) {
01419                 DataTableEntry-&gt;Flags |= LDRP_ENTRY_NATIVE;
01420             }
01421 
01422             <a class="code" href="../../d8/d8/sysload_8c.html#a47">MiWriteProtectSystemImage</a> (DataTableEntry-&gt;DllBase);
01423         }
01424         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;PsLoadedModuleResource);
01425 
01426         InterlockedDecrement (&amp;MiTrimInProgressCount);
01427 
01428         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01429     }
01430 
01431     <span class="keywordflow">if</span> (Phase == 2) {
01432         <a class="code" href="../../d5/d1/mminit_8c.html#a45">MiEnablePagingTheExecutive</a>();
01433         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01434     }
01435 
01436     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01437 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a219" doxytag="mm.h::MmInPageKernelStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmInPageKernelStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Thread</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l03445">3445</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00101">KernelDemandZeroPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05287">MiMakeOutswappedPageResident()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00425">MM_KERNEL_DEMAND_ZERO_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00151">MM_KSTACK_OUTSWAPPED</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00097">MmKernelStackResident</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00431">KiInSwapKernelStacks()</a>.
<p>
<pre class="fragment"><div>03451                    :
03452 
03453     This routine makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified kernel stack resident.
03454 
03455 Arguments:
03456 
03457     Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel stack.
03458 
03459 Return Value:
03460 
03461     Thread - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread whose stack should be
03462              <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> resident.
03463 
03464 Environment:
03465 
03466     Kernel mode.
03467 
03468 --*/
03469 
03470 {
03471     PVOID BaseOfKernelStack;
03472     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03473     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndOfStackPte;
03474     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> SignaturePte;
03475     ULONG DiskRead;
03476     PFN_NUMBER ContainingPage;
03477     KIRQL OldIrql;
03478 
03479     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((PCHAR)Thread-&gt;StackBase - (PCHAR)Thread-&gt;StackLimit) &lt;=
03480             (KERNEL_LARGE_STACK_SIZE + PAGE_SIZE));
03481 
03482     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_DISABLE_PAGE_KERNEL_STACKS) {
03483         <span class="keywordflow">return</span>;
03484     }
03485 
03486     <span class="comment">//</span>
03487     <span class="comment">// The first page of the stack is the page before the base</span>
03488     <span class="comment">// of the stack.</span>
03489     <span class="comment">//</span>
03490 
03491     <span class="keywordflow">if</span> (Thread-&gt;LargeStack) {
03492         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PVOID)((PUCHAR)Thread-&gt;StackLimit));
03493 
03494         EndOfStackPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PVOID)((PUCHAR)Thread-&gt;InitialStack -
03495                                             KERNEL_LARGE_STACK_COMMIT));
03496         <span class="comment">//</span>
03497         <span class="comment">// Trim back the stack.  Make sure that the stack does not grow, i.e.</span>
03498         <span class="comment">// StackLimit remains the limit.</span>
03499         <span class="comment">//</span>
03500 
03501         <span class="keywordflow">if</span> (EndOfStackPte &lt; PointerPte) {
03502             EndOfStackPte = PointerPte;
03503         }
03504         Thread-&gt;StackLimit = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (EndOfStackPte);
03505     } <span class="keywordflow">else</span> {
03506         EndOfStackPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Thread-&gt;StackLimit);
03507     }
03508 
03509 <span class="preprocessor">#if defined(_IA64_)</span>
03510 <span class="preprocessor"></span>
03511     <span class="keywordflow">if</span> (Thread-&gt;LargeStack) {
03512        
03513         PVOID TempAddress = (PVOID)((PUCHAR)Thread-&gt;BStoreLimit);
03514 
03515         BaseOfKernelStack = (PVOID)(((ULONG_PTR)Thread-&gt;InitialBStore + 
03516                                KERNEL_LARGE_BSTORE_COMMIT) &amp;
03517                                ~(ULONG_PTR)(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
03518 
03519         <span class="comment">//</span>
03520         <span class="comment">// Make sure the guard page is not set to valid.</span>
03521         <span class="comment">//</span>
03522 
03523         <span class="keywordflow">if</span> (BaseOfKernelStack &gt; TempAddress) {
03524             BaseOfKernelStack = TempAddress;
03525         }
03526         Thread-&gt;BStoreLimit = BaseOfKernelStack;
03527     }
03528     BaseOfKernelStack = ((PCHAR)Thread-&gt;BStoreLimit - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03529 <span class="preprocessor">#else</span>
03530 <span class="preprocessor"></span>    BaseOfKernelStack = ((PCHAR)Thread-&gt;StackBase - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03531 <span class="preprocessor">#endif // _IA64_</span>
03532 <span class="preprocessor"></span>
03533     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseOfKernelStack);
03534 
03535     DiskRead = 0;
03536     SignaturePte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PULONG_PTR)Thread-&gt;KernelStack - 1);
03537     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SignaturePte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
03538     <span class="keywordflow">if</span> ((SignaturePte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a96">MM_KERNEL_DEMAND_ZERO_PTE</a>) &amp;&amp;
03539         (SignaturePte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 0)) {
03540             DiskRead = 1;
03541     }
03542 
03543     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03544 
03545     <span class="keywordflow">while</span> (PointerPte &gt;= EndOfStackPte) {
03546 
03547 <span class="preprocessor">#ifdef PROTECT_KSTACKS</span>
03548 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!((PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d5/procsup_8c.html#a14">KernelDemandZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) ||
03549                 (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection == <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>))) {
03550             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
03551                           0x3451,
03552                           (ULONG_PTR)PointerPte,
03553                           (ULONG_PTR)Thread,
03554                           0);
03555         }
03556         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
03557         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection == <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>) {
03558             PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = PAGE_READWRITE;
03559         }
03560 <span class="preprocessor">#endif</span>
03561 <span class="preprocessor"></span>
03562         ContainingPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (MiGetPteAddress (PointerPte));
03563         <a class="code" href="../../d4/d5/procsup_8c.html#a44">MiMakeOutswappedPageResident</a> (PointerPte,
03564                                       PointerPte,
03565                                       1,
03566                                       ContainingPage);
03567 
03568         PointerPte -= 1;
03569         <a class="code" href="../../d4/d5/procsup_8c.html#a11">MmKernelStackResident</a> += 1;
03570     }
03571 
03572     <span class="comment">//</span>
03573     <span class="comment">// Check the signature at the current stack location - 4.</span>
03574     <span class="comment">//</span>
03575 
03576     <span class="keywordflow">if</span> (*((PULONG_PTR)Thread-&gt;KernelStack - 1) != (ULONG_PTR)Thread) {
03577         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (KERNEL_STACK_INPAGE_ERROR,
03578                       DiskRead,
03579                       *((PULONG_PTR)Thread-&gt;KernelStack - 1),
03580                       0,
03581                       (ULONG_PTR)Thread-&gt;KernelStack);
03582     }
03583 
03584     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03585     <span class="keywordflow">return</span>;
03586 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a221" doxytag="mm.h::MmInSwapProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmInSwapProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l03910">3910</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00066">_MMSUPPORT::AllowWorkingSetAdjustment</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00349">HYPER_SPACE</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l00442">INITIALIZE_DIRECTORY_TABLE_BASE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02222">_MMWORKING_SET_EXPANSION_HEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02287">MI_CONVERT_PHYSICAL_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01722">MiGetPdeOffset</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01698">MiGetPpeOffset</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01769">MiGetPteOffset</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05287">MiMakeOutswappedPageResident()</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02737">MiSessionInSwapProcess()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00101">MM_WS_SWAPPED_OUT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05071">MmWorkingSetExpansionHead</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00272">_EPROCESS::PaePageDirectoryPage</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00224">_EPROCESS::PaeTop</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00269">_EPROCESS::PageDirectoryPte</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00213">_EPROCESS::ProcessOutswapEnabled</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00214">_EPROCESS::ProcessOutswapped</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00065">_MMSUPPORT::WorkingSetExpansionLinks</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00212">_EPROCESS::WorkingSetPage</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00483">KiInSwapProcesses()</a>.
<p>
<pre class="fragment"><div>03916                    :
03917 
03918     This routine in swaps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process.
03919 
03920 Arguments:
03921 
03922     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be swapped
03923               into memory.
03924 
03925 Return Value:
03926 
03927     None.
03928 
03929 --*/
03930 
03931 {
03932     KIRQL OldIrql;
03933     KIRQL OldIrql2;
03934     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> OutProcess;
03935     PFN_NUMBER PdePage;
03936     PFN_NUMBER PageDirectoryPage;
03937     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PageDirectoryMap;
03938     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PageDirectoryParentMap;
03939     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03940     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte2;
03941     PFN_NUMBER HyperSpacePageTable;
03942     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> HyperSpacePageTableMap;
03943     PFN_NUMBER WorkingSetPage;
03944     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03945     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03946     PFN_NUMBER ProcessPage;
03947 <span class="preprocessor">#if defined (_X86PAE_)</span>
03948 <span class="preprocessor"></span>    ULONG i;
03949     PPAE_ENTRY PaeVa;
03950     PFN_NUMBER PdePage2;
03951 <span class="preprocessor">#endif</span>
03952 <span class="preprocessor"></span>
03953     OutProcess = CONTAINING_RECORD (Process, <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>, Pcb);
03954 
03955     <span class="keywordflow">if</span> (OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o25">ProcessOutswapped</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03956 
03957         <span class="comment">//</span>
03958         <span class="comment">// The process is out of memory, rebuild the initialized page</span>
03959         <span class="comment">// structure.</span>
03960         <span class="comment">//</span>
03961 
03962         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(OutProcess)) {
03963             ProcessPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (OutProcess);
03964         } <span class="keywordflow">else</span> {
03965             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (OutProcess);
03966             ProcessPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
03967         }
03968 
03969         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03970 
03971 <span class="preprocessor">#if defined (_WIN64)</span>
03972 <span class="preprocessor"></span>        PdePage = <a class="code" href="../../d4/d5/procsup_8c.html#a44">MiMakeOutswappedPageResident</a> (MiGetPteAddress (PDE_TBASE),
03973                                         (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)&amp;OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o62">PageDirectoryPte</a>,
03974                                         0,
03975                                         ProcessPage);
03976 <span class="preprocessor">#else</span>
03977 <span class="preprocessor"></span>        PdePage = <a class="code" href="../../d4/d5/procsup_8c.html#a44">MiMakeOutswappedPageResident</a> (MiGetPteAddress (PDE_BASE),
03978                                         (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)&amp;OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o62">PageDirectoryPte</a>,
03979                                         0,
03980                                         ProcessPage);
03981 <span class="preprocessor">#endif</span>
03982 <span class="preprocessor"></span>
03983         <span class="comment">//</span>
03984         <span class="comment">// Adjust the counts for the process page.</span>
03985         <span class="comment">//</span>
03986 
03987         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (ProcessPage);
03988         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount -= 1;
03989 
03990         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt;= 1);
03991 
03992         <span class="comment">//</span>
03993         <span class="comment">// Adjust the counts properly for the page directory page.</span>
03994         <span class="comment">//</span>
03995 
03996         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PdePage);
03997         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
03998 <span class="preprocessor">#if !defined (_WIN64)</span>
03999 <span class="preprocessor"></span>        Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)OutProcess;
04000 <span class="preprocessor">#endif</span>
04001 <span class="preprocessor"></span>        Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PdePage;
04002         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PDE_BASE);
04003 
04004 <span class="preprocessor">#if defined (_WIN64)</span>
04005 <span class="preprocessor"></span>
04006         <span class="comment">//</span>
04007         <span class="comment">// Only the page directory parent page has really been read in above.</span>
04008         <span class="comment">// Get the page directory page now also.</span>
04009         <span class="comment">//</span>
04010 
04011         PageDirectoryParentMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
04012 
04013         TempPte = PageDirectoryParentMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(MmWorkingSetList)];
04014 
04015         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04016 
04017         PageDirectoryPage = <a class="code" href="../../d4/d5/procsup_8c.html#a44">MiMakeOutswappedPageResident</a> (
04018                                  MiGetPpeAddress (MmWorkingSetList),
04019                                  &amp;TempPte,
04020                                  0,
04021                                  PdePage);
04022 
04023         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PageDirectoryPage == TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
04024         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt;= 3);
04025 
04026         PageDirectoryParentMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
04027 
04028         PageDirectoryParentMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(PDE_TBASE)].u.Flush =
04029                                               OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o62">PageDirectoryPte</a>;
04030         PageDirectoryParentMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(MmWorkingSetList)] = TempPte;
04031 
04032         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04033 
04034         PdePage = PageDirectoryPage;
04035 <span class="preprocessor">#endif</span>
04036 <span class="preprocessor"></span>
04037 <span class="preprocessor">#if defined (_X86PAE_)</span>
04038 <span class="preprocessor"></span>
04039         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o64">PaePageDirectoryPage</a> = PdePage;
04040 
04041         <span class="comment">//</span>
04042         <span class="comment">// Locate the additional page directory pages and make them resident.</span>
04043         <span class="comment">//</span>
04044 
04045         PaeVa = (PPAE_ENTRY)OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o35">PaeTop</a>;
04046         <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM - 1; i += 1) {
04047             PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
04048     
04049             TempPte = PageDirectoryMap[i];
04050     
04051             <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04052     
04053             PdePage2 = <a class="code" href="../../d4/d5/procsup_8c.html#a44">MiMakeOutswappedPageResident</a> (
04054                                      MiGetPteAddress (PDE_BASE + (i &lt;&lt; PAGE_SHIFT)),
04055                                      &amp;TempPte,
04056                                      0,
04057                                      PdePage);
04058     
04059             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt;= 1);
04060     
04061             PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
04062             PageDirectoryMap[i] = TempPte;
04063             <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04064             PaeVa-&gt;PteEntry[i].u.Long = (TempPte.u.Long &amp; ~MM_PAE_PDPTE_MASK);
04065         }
04066 
04067         TempPte.u.Flush = OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o62">PageDirectoryPte</a>;
04068         TempPte.u.Long &amp;= ~MM_PAE_PDPTE_MASK;
04069         PaeVa-&gt;PteEntry[i].u.Flush = TempPte.u.Flush;
04070 
04071         <span class="comment">//</span>
04072         <span class="comment">// Locate the second page table page for hyperspace &amp; make it resident.</span>
04073         <span class="comment">//</span>
04074 
04075         PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
04076 
04077         TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(HYPER_SPACE2)];
04078 
04079         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04080 
04081         HyperSpacePageTable = <a class="code" href="../../d4/d5/procsup_8c.html#a44">MiMakeOutswappedPageResident</a> (
04082                                  MiGetPdeAddress (HYPER_SPACE2),
04083                                  &amp;TempPte,
04084                                  0,
04085                                  PdePage);
04086 
04087         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt;= 1);
04088 
04089         PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
04090         PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(HYPER_SPACE2)] = TempPte;
04091         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04092         TempPte2 = TempPte;
04093 <span class="preprocessor">#endif</span>
04094 <span class="preprocessor"></span>
04095         <span class="comment">//</span>
04096         <span class="comment">// Locate the page table page for hyperspace and make it resident.</span>
04097         <span class="comment">//</span>
04098 
04099         PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
04100 
04101         TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmWorkingSetList)];
04102 
04103         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04104 
04105         HyperSpacePageTable = <a class="code" href="../../d4/d5/procsup_8c.html#a44">MiMakeOutswappedPageResident</a> (
04106                                  MiGetPdeAddress (HYPER_SPACE),
04107                                  &amp;TempPte,
04108                                  0,
04109                                  PdePage);
04110 
04111         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt;= 3);
04112 
04113         PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
04114 
04115 <span class="preprocessor">#if !defined (_WIN64)</span>
04116 <span class="preprocessor"></span>        PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(PDE_BASE)].u.Flush =
04117                                               OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o62">PageDirectoryPte</a>;
04118 <span class="preprocessor">#endif</span>
04119 <span class="preprocessor"></span>
04120         PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmWorkingSetList)] = TempPte;
04121 
04122         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04123 
04124         <span class="comment">//</span>
04125         <span class="comment">// Map in the hyper space page table page and retrieve the</span>
04126         <span class="comment">// PTE that maps the working set list.</span>
04127         <span class="comment">//</span>
04128 
04129         HyperSpacePageTableMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (HyperSpacePageTable, &amp;OldIrql2);
04130         TempPte = HyperSpacePageTableMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a158">MiGetPteOffset</a>(MmWorkingSetList)];
04131         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04132         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (HyperSpacePageTable);
04133 
04134         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = 1;
04135 
04136         WorkingSetPage = <a class="code" href="../../d4/d5/procsup_8c.html#a44">MiMakeOutswappedPageResident</a> (
04137                                  MiGetPteAddress (MmWorkingSetList),
04138                                  &amp;TempPte,
04139                                  0,
04140                                  HyperSpacePageTable);
04141 
04142         HyperSpacePageTableMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (HyperSpacePageTable, &amp;OldIrql2);
04143         HyperSpacePageTableMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a158">MiGetPteOffset</a>(MmWorkingSetList)] = TempPte;
04144 <span class="preprocessor">#if defined (_X86PAE_)</span>
04145 <span class="preprocessor"></span>        HyperSpacePageTableMap[0] = TempPte2;
04146 <span class="preprocessor">#endif</span>
04147 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
04148 
04149         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (WorkingSetPage);
04150 
04151         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = 2;
04152 
04153         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04154 
04155         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
04156 
04157         <span class="comment">//</span>
04158         <span class="comment">// Allow working set trimming on this process.</span>
04159         <span class="comment">//</span>
04160 
04161         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04162         <span class="keywordflow">if</span> (OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink == <a class="code" href="../../d4/d8/mi_8h.html#a22">MM_WS_SWAPPED_OUT</a>) {
04163             InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
04164                             &amp;OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
04165         }
04166         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
04167 
04168         <span class="comment">//</span>
04169         <span class="comment">// Set up process structures.</span>
04170         <span class="comment">//</span>
04171 
04172         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o23">WorkingSetPage</a> = WorkingSetPage;
04173 
04174 <span class="preprocessor">#if !defined (_X86PAE_)</span>
04175 <span class="preprocessor"></span>        OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> = 3;
04176 
04177         <a class="code" href="../../d6/d9/mippc_8h.html#a84">INITIALIZE_DIRECTORY_TABLE_BASE</a> (&amp;Process-&gt;DirectoryTableBase[0],
04178                                          PdePage);
04179         <a class="code" href="../../d6/d9/mippc_8h.html#a84">INITIALIZE_DIRECTORY_TABLE_BASE</a> (&amp;Process-&gt;DirectoryTableBase[1],
04180                                          HyperSpacePageTable);
04181 <span class="preprocessor">#else</span>
04182 <span class="preprocessor"></span>        <span class="comment">//</span>
04183         <span class="comment">// The DirectoryTableBase[0] never changes for PAE processes.</span>
04184         <span class="comment">//</span>
04185 
04186         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> = 7;
04187         Process-&gt;DirectoryTableBase[1] = HyperSpacePageTable;
04188 <span class="preprocessor">#endif</span>
04189 <span class="preprocessor"></span>
04190         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o25">ProcessOutswapped</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04191     }
04192 
04193     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession == 1) {
04194         <a class="code" href="../../d3/d7/session_8c.html#a20">MiSessionInSwapProcess</a> (OutProcess);
04195     }
04196 
04197     OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04198     <span class="keywordflow">return</span>;
04199 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a302" doxytag="mm.h::MmIsAddressValid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN MmIsAddressValid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VirtualAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">3883</a> of file <a class="el" href="../../d9/d1/pagfault_8c-source.html">pagfault.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01817">MiGetVirtualAddressMappedByPde</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02400">IoFreeDumpRange()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03815">IopCreateSummaryDump()</a>, <a class="el" href="../../d2/d4/ioassert_8c-source.html#l00599">IopDriverCorrectnessProcessParams()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00287">IopIsAddressRangeValid()</a>, <a class="el" href="../../d2/d4/ioassert_8c-source.html#l01320">IopIsMemoryRangeReadable()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02291">IoSetDumpRange()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03784">IovpSeedStack()</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l01253">MiDetachSession()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">MiGatherMappedPages()</a>, <a class="el" href="../../d2/d1/mm_2i386_2init386_8c-source.html#l00058">MiInitMachineDependent()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00388">MiInsertStandbyListAtFront()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00764">MiMakeSystemAddressValid()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00996">MiMakeSystemAddressValidPfn()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00916">MiMakeSystemAddressValidPfnSystemWs()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00837">MiMakeSystemAddressValidPfnWs()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l01223">MiRemoveImageSessionWide()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01245">MiRestoreTransitionPte()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00191">MiSegmentDelete()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00178">MiSessionAddProcess()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02144">MiSessionCommitImagePages()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02318">MiSessionCommitPageTables()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00394">MiSessionCreateInternal()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00259">MiSessionRemoveProcess()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00936">MiSessionWideReserveImageAddress()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02309">MiSetPagingOfDriver()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00119">MiShareSessionImage()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l02335">MiWaitForInPageComplete()</a>, <a class="el" href="../../d0/d5/alpha_2debugsup_8c-source.html#l00027">MmDbgReadCheck()</a>, <a class="el" href="../../d0/d5/alpha_2debugsup_8c-source.html#l00182">MmDbgReleaseAddress()</a>, <a class="el" href="../../d4/d5/mips_2debugsup_8c-source.html#l00245">MmDbgTranslatePhysicalAddress()</a>, <a class="el" href="../../d3/d5/ia64_2debugsup_8c-source.html#l00236">MmDbgTranslatePhysicalAddress64()</a>, <a class="el" href="../../d0/d5/alpha_2debugsup_8c-source.html#l00070">MmDbgWriteCheck()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03211">MmMapViewInSessionSpace()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00974">MmSessionCreate()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l01093">MmSessionDelete()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00140">MmSessionSetUnloadAddress()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l08083">MmSetKernelDumpRange()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03639">MmUnmapViewInSessionSpace()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>, <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00033">NtLockVirtualMemory()</a>, <a class="el" href="../../d4/d4/lockvm_8c-source.html#l00605">NtUnlockVirtualMemory()</a>, <a class="el" href="../../d8/d5/stktrace_8c-source.html#l00741">RtlWalkFrameChain()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l01976">VerifierFreeTrackedPool()</a>.
<p>
<pre class="fragment"><div>03889                    :
03890 
03891     For a given <span class="keyword">virtual</span> address <span class="keyword">this</span> function returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> no page fault
03892     will occur <span class="keywordflow">for</span> a read operation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
03893 
03894     Note that after <span class="keyword">this</span> routine was called, <span class="keywordflow">if</span> appropriate locks are not
03895     held, a non-faulting address could fault.
03896 
03897 Arguments:
03898 
03899     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address to check.
03900 
03901 Return Value:
03902 
03903     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> a no page fault would be generated reading <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address,
03904     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
03905 
03906 Environment:
03907 
03908     Kernel mode.
03909 
03910 --*/
03911 
03912 {
03913     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03914 
03915 <span class="preprocessor">#if defined(_ALPHA_) || defined(_IA64_)</span>
03916 <span class="preprocessor"></span>
03917     <span class="comment">//</span>
03918     <span class="comment">// If this is within the physical addressing range, just return TRUE.</span>
03919     <span class="comment">//</span>
03920 
03921     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(VirtualAddress)) {
03922         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03923     }
03924 
03925 <span class="preprocessor">#endif // _ALPHA_ || _IA64_</span>
03926 <span class="preprocessor"></span>
03927 <span class="preprocessor">#if defined (_WIN64)</span>
03928 <span class="preprocessor"></span>    PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (VirtualAddress);
03929     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03930         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03931     }
03932 <span class="preprocessor">#endif</span>
03933 <span class="preprocessor"></span>
03934     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (VirtualAddress);
03935     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03936         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03937     }
03938 <span class="preprocessor">#ifdef _X86_</span>
03939 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.LargePage == 1) {
03940         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03941     }
03942 <span class="preprocessor">#endif //_X86_</span>
03943 <span class="preprocessor"></span>
03944     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
03945     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03946         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03947     }
03948 
03949 <span class="preprocessor">#ifdef _X86_</span>
03950 <span class="preprocessor"></span>    <span class="comment">//</span>
03951     <span class="comment">// Make sure we're not treating a page directory as a page table here for</span>
03952     <span class="comment">// the case where the page directory is mapping a large page.  This is</span>
03953     <span class="comment">// because the large page bit is valid in PDE formats, but reserved in</span>
03954     <span class="comment">// PTE formats and will cause a trap.  A virtual address like c0200000</span>
03955     <span class="comment">// triggers this case.  It's not enough to just check the large page bit</span>
03956     <span class="comment">// in the PTE below because of course that bit's been reused by other</span>
03957     <span class="comment">// steppings of the processor so we have to look at the address too.</span>
03958     <span class="comment">//</span>
03959     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.LargePage == 1) {
03960         PVOID Va;
03961 
03962         Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a160">MiGetVirtualAddressMappedByPde</a> (PointerPte);
03963         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(Va)) {
03964             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03965         }
03966     }
03967 <span class="preprocessor">#endif</span>
03968 <span class="preprocessor"></span>
03969     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03970 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a327" doxytag="mm.h::MmIsDriverVerifying" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI LOGICAL MmIsDriverVerifying           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN struct <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">_DRIVER_OBJECT</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a325" doxytag="mm.h::MmIsHydraAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MmIsHydraAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VirtualAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/allocpag_8c-source.html#l05146">5146</a> of file <a class="el" href="../../d2/d5/allocpag_8c-source.html">allocpag.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l05293">MI_IS_SESSION_ADDRESS</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>.
<p>
<pre class="fragment"><div>05152                    :
05153 
05154     This function returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> a Hydra address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified.
05155     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> not.
05156 
05157 Arguments:
05158 
05159     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address in question.
05160 
05161 Return Value:
05162 
05163     See above.
05164 
05165 Environment:
05166 
05167     Kernel mode.  Note <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present and nonpaged <span class="keywordflow">for</span> both Hydra
05168     and non-Hydra systems.
05169 
05170 --*/
05171 
05172 {
05173     <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (VirtualAddress);
05174 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a303" doxytag="mm.h::MmIsNonPagedSystemAddressValid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN MmIsNonPagedSystemAddressValid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VirtualAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01460">1460</a> of file <a class="el" href="../../d1/d1/mmsup_8c-source.html">mmsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00068">MmPagedPoolEnd</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00067">MmPagedPoolStart</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l01500">MmBuildMdlForNonPagedPool()</a>.
<p>
<pre class="fragment"><div>01466                    :
01467 
01468     For a given <span class="keyword">virtual</span> address <span class="keyword">this</span> function returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address
01469     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> nonpagable portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system's address space,
01470     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01471 
01472 Arguments:
01473 
01474     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address to check.
01475 
01476 Return Value:
01477 
01478     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> nonpagable portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system
01479     address space, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01480 
01481 Environment:
01482 
01483     Kernel mode.
01484 
01485 --*/
01486 
01487 {
01488     <span class="comment">//</span>
01489     <span class="comment">// Return TRUE if address is within the nonpagable portion</span>
01490     <span class="comment">// of the system.  Check limits for paged pool and if not within</span>
01491     <span class="comment">// those limits, return TRUE.</span>
01492     <span class="comment">//</span>
01493 
01494     <span class="keywordflow">if</span> ((VirtualAddress &gt;= <a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>) &amp;&amp;
01495         (VirtualAddress &lt;= <a class="code" href="../../d8/d5/kddata_8c.html#a26">MmPagedPoolEnd</a>)) {
01496         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01497     }
01498 
01499     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01500 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a323" doxytag="mm.h::MmIsSpecialPoolAddressFree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MmIsSpecialPoolAddressFree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VirtualAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/allocpag_8c-source.html#l05177">5177</a> of file <a class="el" href="../../d2/d5/allocpag_8c-source.html">allocpag.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00068">MI_SPECIAL_POOL_PTE_NONPAGABLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00067">MI_SPECIAL_POOL_PTE_PAGABLE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01977">MmSpecialPoolEnd</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01976">MmSpecialPoolStart</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>.
<p>
<pre class="fragment"><div>05183                    :
05184 
05185     This function returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> a special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> address has been freed.
05186     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> inuse (ie: the caller overran).
05187 
05188 Arguments:
05189 
05190     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> address in question.
05191 
05192 Return Value:
05193 
05194     See above.
05195 
05196 Environment:
05197 
05198     Kernel mode.
05199 
05200 --*/
05201 
05202 {
05203     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05204 
05205     <span class="comment">//</span>
05206     <span class="comment">// Caller must check that the address in in special pool.</span>
05207     <span class="comment">//</span>
05208 
05209     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VirtualAddress &gt;= MmSpecialPoolStart &amp;&amp; VirtualAddress &lt; MmSpecialPoolEnd);
05210 
05211     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(VirtualAddress);
05212 
05213     <span class="comment">//</span>
05214     <span class="comment">// Take advantage of the fact that adjacent PTEs have the paged/nonpaged</span>
05215     <span class="comment">// bits set when in use and these bits are cleared on free.  Note also</span>
05216     <span class="comment">// that freed pages get their PTEs chained together through PageFileHigh.</span>
05217     <span class="comment">//</span>
05218 
05219     <span class="keywordflow">if</span> ((PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh == <a class="code" href="../../d4/d8/mi_8h.html#a4">MI_SPECIAL_POOL_PTE_PAGABLE</a>) ||
05220         (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh == <a class="code" href="../../d4/d8/mi_8h.html#a5">MI_SPECIAL_POOL_PTE_NONPAGABLE</a>)) {
05221             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05222     }
05223 
05224     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05225 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a336" doxytag="mm.h::MmIsSystemAddressAccessable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN MmIsSystemAddressAccessable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VirtualAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d8/mips_2kdtrap_8c-source.html#l00046">KdpPageInData()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a207" doxytag="mm.h::MmIsSystemAddressLocked" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MmIsSystemAddressLocked           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VirtualAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01693">IovpCompleteRequest3()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02555">IovpInternalDeferredCompletion()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a185" doxytag="mm.h::MmIsThisAnNtAsSystem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN MmIsThisAnNtAsSystem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/mminit_8c-source.html#l03087">3087</a> of file <a class="el" href="../../d6/d0/mminit_8c-source.html">mminit.c</a>.
<p>
References <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00108">MmProductType</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l00069">CcInitializeCacheManager()</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00220">ExpWorkerInitialization()</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00538">ExpWorkerThread()</a>, <a class="el" href="../../d2/d6/tunnel_8c-source.html#l00382">FsRtlInitializeTunnels()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02184">MiBuildPagedPool()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, and <a class="el" href="../../d1/d0/psinit_8c-source.html#l00878">PsChangeQuantumTable()</a>.
<p>
<pre class="fragment"><div>03090 {
03091     <span class="keywordflow">return</span> (BOOLEAN)<a class="code" href="../../d8/d0/cmdat3_8c.html#a52">MmProductType</a>;
03092 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a231" doxytag="mm.h::MmLoadAndLockSystemImage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmLoadAndLockSystemImage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageFileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING NamePrefix&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING LoadedBaseName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Section</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageBaseAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00379">379</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00954">IopLoadDumpDriver()</a>.
<p>
<pre class="fragment"><div>00389                    :
00390 
00391     This routine reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image pages from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section into
00392     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL's header.  Very similar
00393     to <a class="code" href="../../d2/d1/mm_8h.html#a230">MmLoadSystemImage</a>, except that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> also locks down <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver pages.
00394     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed <span class="keywordflow">for</span> things like <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dump driver because we cannot page <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00395     back in after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has crashed (when we want to write the system
00396     dump to the pagefile).
00397 
00398     At successful completion, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> referenced so <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> remains
00399     until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system image <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unloaded.
00400 
00401 Arguments:
00402 
00403     ImageName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image to load.
00404 
00405     ImageFileName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> name (including the image name)
00406                     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image to load.
00407 
00408     NamePrefix - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prefix to use with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image name on load
00409                  operations.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to load <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same image multiple
00410                  times, by <span class="keyword">using</span> different prefixes
00411 
00412     LoadedBaseName - If present, supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base name to use on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00413                      loaded image instead of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base name found on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00414                      image name.
00415 
00416     ImageHandle - Returns an opaque pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> referenced section object
00417                   of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image that was loaded.
00418 
00419     ImageBaseAddress - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image base within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
00420 
00421 Return Value:
00422 
00423     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> load operation.
00424 
00425 --*/
00426 
00427 {
00428     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00429 
00430     <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/sysload_8c.html#a45">MiLoadSystemImage</a> (
00431         ImageFileName,
00432         NamePrefix,
00433         LoadedBaseName,
00434         FALSE,
00435         ImageHandle,
00436         ImageBaseAddress,
00437         TRUE
00438         );
00439 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a230" doxytag="mm.h::MmLoadSystemImage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmLoadSystemImage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageFileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING NamePrefix&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING LoadedBaseName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LoadInSessionSpace</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Section</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageBaseAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l00315">315</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03953">MiResolveImageReferences()</a>, and <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>.
<p>
<pre class="fragment"><div>00326                    :
00327 
00328     This routine reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image pages from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section into
00329     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL's header.
00330 
00331     At successful completion, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> referenced so <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> remains
00332     until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system image <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unloaded.
00333 
00334 Arguments:
00335 
00336     ImageName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image to load.
00337 
00338     ImageFileName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> name (including the image name)
00339                     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image to load.
00340 
00341     NamePrefix - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prefix to use with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image name on load
00342                  operations.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to load <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same image multiple
00343                  times, by <span class="keyword">using</span> different prefixes
00344 
00345     LoadedBaseName - If present, supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base name to use on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00346                      loaded image instead of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base name found on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00347                      image name.
00348 
00349     LoadInSessionSpace - Supplies whether to load <span class="keyword">this</span> image in session space -
00350                      ie: each session will have a different copy of <span class="keyword">this</span> driver
00351                      with pages shared as much as possible via copy on write.
00352 
00353     ImageHandle - Returns an opaque pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> referenced section object
00354                   of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image that was loaded.
00355 
00356     ImageBaseAddress - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image base within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
00357 
00358 Return Value:
00359 
00360     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> load operation.
00361 
00362 --*/
00363 
00364 {
00365     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00366 
00367     <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/sysload_8c.html#a45">MiLoadSystemImage</a> (
00368         ImageFileName,
00369         NamePrefix,
00370         LoadedBaseName,
00371         LoadInSessionSpace,
00372         ImageHandle,
00373         ImageBaseAddress,
00374         FALSE
00375         );
00376 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a326" doxytag="mm.h::MmLocateUnloadedDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PUNICODE_STRING MmLocateUnloadedDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VirtualAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l02836">2836</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02690">_UNLOADED_DRIVERS::EndAddress</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02685">MI_UNLOADED_DRIVERS</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00093">MiLastUnloadedDriver</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00092">MiUnloadedDrivers</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02688">_UNLOADED_DRIVERS::Name</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l02689">_UNLOADED_DRIVERS::StartAddress</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, and <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00317">KiDumpParameterImages()</a>.
<p>
<pre class="fragment"><div>02842                    :
02843 
02844     This routine attempts to find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span> address in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02845     unloaded driver list.
02846 
02847 Arguments:
02848 
02849     VirtualAddress - Supplies a <span class="keyword">virtual</span> address that might be within a driver
02850                      that has already unloaded.
02851 
02852 Return Value:
02853 
02854     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> string containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unloaded driver's name.
02855 
02856 Environment:
02857 
02858     Kernel mode, bugcheck time.
02859 
02860 --*/
02861 
02862 {
02863     <a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html">PUNLOADED_DRIVERS</a> Entry;
02864     ULONG i;
02865     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02866 
02867     <span class="comment">//</span>
02868     <span class="comment">// No serialization is needed because we've crashed.</span>
02869     <span class="comment">//</span>
02870 
02871     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a46">MiUnloadedDrivers</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02872         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02873     }
02874 
02875     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a47">MiLastUnloadedDriver</a> - 1;
02876 
02877     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d4/d8/mi_8h.html#a240">MI_UNLOADED_DRIVERS</a>; i += 1) {
02878         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a240">MI_UNLOADED_DRIVERS</a>) {
02879             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d8/mi_8h.html#a240">MI_UNLOADED_DRIVERS</a> - 1;
02880         }
02881         Entry = &amp;<a class="code" href="../../d9/d5/4_2kddata_8c.html#a46">MiUnloadedDrivers</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
02882         <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02883             <span class="keywordflow">if</span> ((VirtualAddress &gt;= Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o1">StartAddress</a>) &amp;&amp;
02884                 (VirtualAddress &lt; Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o2">EndAddress</a>)) {
02885                     <span class="keywordflow">return</span> &amp;Entry-&gt;<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">Name</a>;
02886             }
02887         }
02888         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> -= 1;
02889     }
02890 
02891     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02892 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a306" doxytag="mm.h::MmLockPagableDataSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI PVOID MmLockPagableDataSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>AddressWithinSection</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l06864">6864</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06991">MiLookupDataTableEntry()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00186">MM_DBG_LOCK_CODE</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00583">PsLoadedModuleResource</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01985">SECTION_BASE_ADDRESS</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>.
<p>
<pre class="fragment"><div>06870                    :
06871 
06872     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> locks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire section that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
06873     section in memory.  This allows pagable code to be brought into
06874     memory and to be used as <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> code was not really pagable.  This
06875     should not be done with a <a class="code" href="../../d2/d3/fetypes_8h.html#a457a417">high</a> degree of frequency.
06876 
06877 Arguments:
06878 
06879     AddressWithinSection - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a function
06880         contained within a section that should be brought in and locked
06881         in memory.
06882 
06883 Return Value:
06884 
06885     This function returns a value to be used in a subsequent call to
06886     <a class="code" href="../../d2/d1/mm_8h.html#a312">MmUnlockPagableImageSection</a>.
06887 
06888 --*/
06889 
06890 {
06891     PLDR_DATA_TABLE_ENTRY DataTableEntry;
06892     ULONG i;
06893     PIMAGE_NT_HEADERS NtHeaders;
06894     PIMAGE_SECTION_HEADER NtSection;
06895     PIMAGE_SECTION_HEADER FoundSection;
06896     ULONG_PTR Rva;
06897 
06898     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06899 
06900     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(AddressWithinSection)) {
06901 
06902         <span class="comment">//</span>
06903         <span class="comment">// Physical address, just return that as the handle.</span>
06904         <span class="comment">//</span>
06905 
06906         <span class="keywordflow">return</span> AddressWithinSection;
06907     }
06908 
06909     <span class="comment">//</span>
06910     <span class="comment">// Search the loaded module list for the data table entry that describes</span>
06911     <span class="comment">// the DLL that was just unloaded. It is possible that an entry is not in</span>
06912     <span class="comment">// the list if a failure occurred at a point in loading the DLL just before</span>
06913     <span class="comment">// the data table entry was generated.</span>
06914     <span class="comment">//</span>
06915 
06916     FoundSection = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06917 
06918     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
06919     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a> (&amp;PsLoadedModuleResource, TRUE);
06920 
06921     DataTableEntry = <a class="code" href="../../d4/d8/mi_8h.html#a874">MiLookupDataTableEntry</a> (AddressWithinSection, TRUE);
06922 
06923     Rva = (ULONG_PTR)((PUCHAR)AddressWithinSection - (ULONG_PTR)DataTableEntry-&gt;DllBase);
06924 
06925     NtHeaders = (PIMAGE_NT_HEADERS)<a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(DataTableEntry-&gt;DllBase);
06926 
06927     NtSection = (PIMAGE_SECTION_HEADER)((ULONG_PTR)NtHeaders +
06928                         <span class="keyword">sizeof</span>(ULONG) +
06929                         <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
06930                         NtHeaders-&gt;FileHeader.SizeOfOptionalHeader
06931                         );
06932 
06933     <span class="keywordflow">for</span> (i = 0; i &lt; NtHeaders-&gt;FileHeader.NumberOfSections; i += 1) {
06934 
06935         <span class="keywordflow">if</span> ( Rva &gt;= NtSection-&gt;VirtualAddress &amp;&amp;
06936              Rva &lt; NtSection-&gt;VirtualAddress + NtSection-&gt;SizeOfRawData ) {
06937             FoundSection = NtSection;
06938 
06939             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a217">SECTION_BASE_ADDRESS</a>(NtSection) != ((PUCHAR)DataTableEntry-&gt;DllBase +
06940                             NtSection-&gt;VirtualAddress)) {
06941 
06942                 <span class="comment">//</span>
06943                 <span class="comment">// Overwrite the PointerToRelocations field (and on Win64, the</span>
06944                 <span class="comment">// PointerToLinenumbers field also) so that it contains</span>
06945                 <span class="comment">// the Va of this section and NumberOfLinenumbers so it contains</span>
06946                 <span class="comment">// the Lock Count for the section.</span>
06947                 <span class="comment">//</span>
06948 
06949                 <a class="code" href="../../d4/d8/mi_8h.html#a217">SECTION_BASE_ADDRESS</a>(NtSection) = ((PUCHAR)DataTableEntry-&gt;DllBase +
06950                                         NtSection-&gt;VirtualAddress);
06951                 NtSection-&gt;NumberOfLinenumbers = 0;
06952             }
06953 
06954             <span class="comment">//</span>
06955             <span class="comment">// Now lock in the code</span>
06956             <span class="comment">//</span>
06957 
06958 <span class="preprocessor">#if DBG</span>
06959 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a78">MM_DBG_LOCK_CODE</a>) {
06960                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM Lock %wZ %8s %p -&gt; %p : %p %3ld.\n"</span>,
06961                         &amp;DataTableEntry-&gt;BaseDllName,
06962                         NtSection-&gt;Name,
06963                         AddressWithinSection,
06964                         NtSection,
06965                         <a class="code" href="../../d4/d8/mi_8h.html#a217">SECTION_BASE_ADDRESS</a>(NtSection),
06966                         NtSection-&gt;NumberOfLinenumbers);
06967             }
06968 <span class="preprocessor">#endif //DBG</span>
06969 <span class="preprocessor"></span>
06970             <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> ((PVOID)NtSection);
06971 
06972             <span class="keywordflow">break</span>;
06973         }
06974         NtSection += 1;
06975     }
06976 
06977     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;PsLoadedModuleResource);
06978     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
06979     <span class="keywordflow">if</span> (!FoundSection) {
06980         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
06981                       0x1234,
06982                       (ULONG_PTR)AddressWithinSection,
06983                       0,
06984                       0);
06985     }
06986     <span class="keywordflow">return</span> (PVOID)FoundSection;
06987 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a307" doxytag="mm.h::MmLockPagableSectionByHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmLockPagableSectionByHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ImageSectionHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">6284</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00167">KePulseEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02717">MI_IS_SYSTEM_CACHE_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">MiLockCode()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00916">MiMakeSystemAddressValidPfnSystemWs()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00113">MM_LOCK_BY_REFCOUNT</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00206">MmCollidedLockEvent</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00207">MmCollidedLockWait</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00033">MmSystemRangeStart</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01985">SECTION_BASE_ADDRESS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00910">UNLOCK_PFN_AND_THEN_WAIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01012">UNLOCK_SYSTEM_WS_NO_IRQL</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03579">ExpGetLockInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03661">ExpGetLookasideInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03846">ExpGetPoolInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03060">ExpGetProcessInformation()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00576">KeSetPhysicalCacheTypeRange()</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00294">KiAmdK6MtrrSetMemoryType()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02715">MiEmptyAllWorkingSets()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03268">MiMapViewInSystemSpace()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02309">MiSetPagingOfDriver()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00119">MiShareSessionImage()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03253">MiUnmapLockedPagesInUserSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03683">MiUnmapViewInSystemSpace()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05581">MmAllocateNonCachedMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02106">MmFreeDriverInitialization()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05721">MmFreeNonCachedMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05051">MmFreePagesFromMdl()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06864">MmLockPagableDataSection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07821">MmLockPagedPool()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02560">MmResetDriverPaging()</a>, <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07869">MmUnlockPagedPool()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00061">NtQueryVirtualMemory()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00291">PspQueryPooledQuotaLimits()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00209">PspQueryQuotaLimits()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00113">PspQueryWorkingSetWatch()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l01211">PspSetQuotaLimits()</a>.
<p>
<pre class="fragment"><div>06291                    :
06292 
06293     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified pages are resident in
06294     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process's working set and <span class="keywordflow">if</span> so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
06295     page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incremented.  The allows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address to be accessed
06296     without getting a hard page fault (have to go to the disk... except
06297     <span class="keywordflow">for</span> extremely rare <span class="keywordflow">case</span> when the page table page is removed from the
06298     working set and migrates to the disk.
06299 
06300     If the <span class="keyword">virtual</span> address is that of the system wide global <span class="stringliteral">"cache"</span> the
06301     <span class="keyword">virtual</span> address of the <span class="stringliteral">"locked"</span> pages is always guaranteed to
06302     be valid.
06303 
06304     NOTE: This routine is not to be used <span class="keywordflow">for</span> general locking of user
06305     addresses - use <a class="code" href="../../d2/d1/mm_8h.html#a273">MmProbeAndLockPages</a>.  This routine is intended <span class="keywordflow">for</span>
06306     well behaved system code like the file system caches which allocates
06307     <span class="keyword">virtual</span> addresses <span class="keywordflow">for</span> mapping files AND guarantees that the mapping
06308     will not be modified (deleted or changed) <span class="keywordflow">while</span> the pages are locked.
06309 
06310 Arguments:
06311 
06312     ImageSectionHandle - Supplies the value returned by a previous call
06313         to <a class="code" href="../../d2/d1/mm_8h.html#a306">MmLockPagableDataSection</a>.  This is a pointer to the Section
06314         header <span class="keywordflow">for</span> the image.
06315 
06316 Return Value:
06317 
06318     None.
06319 
06320 Environment:
06321 
06322     Kernel mode, IRQL of DISPATCH_LEVEL or below.
06323 
06324 --*/
06325 
06326 {
06327     PIMAGE_SECTION_HEADER NtSection;
06328     PVOID BaseAddress;
06329     ULONG SizeToLock;
06330     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
06331     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
06332     KIRQL OldIrql;
06333     KIRQL OldIrqlWs;
06334     ULONG Collision;
06335 
06336     if (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(ImageSectionHandle)) {
06337 
06338         <span class="comment">//</span>
06339         <span class="comment">// No need to lock physical addresses.</span>
06340         <span class="comment">//</span>
06341 
06342         <span class="keywordflow">return</span>;
06343     }
06344 
06345     NtSection = (PIMAGE_SECTION_HEADER)ImageSectionHandle;
06346 
06347     BaseAddress = <a class="code" href="../../d4/d8/mi_8h.html#a217">SECTION_BASE_ADDRESS</a>(NtSection);
06348 
06349     ASSERT (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a196">MI_IS_SYSTEM_CACHE_ADDRESS</a>(BaseAddress));
06350 
06351     ASSERT (BaseAddress &gt;= MmSystemRangeStart);
06352 
06353     SizeToLock = NtSection-&gt;SizeOfRawData;
06354     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(BaseAddress);
06355     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>((PCHAR)BaseAddress + SizeToLock - 1);
06356 
06357     ASSERT (SizeToLock != 0);
06358 
06359     <span class="comment">//</span>
06360     <span class="comment">// The address must be within the system space.</span>
06361     <span class="comment">//</span>
06362 
06363 RetryLock:
06364 
06365     LOCK_SYSTEM_WS (OldIrqlWs);
06366     LOCK_PFN2 (OldIrql);
06367 
06368     MiMakeSystemAddressValidPfnSystemWs (&amp;NtSection-&gt;NumberOfLinenumbers);
06369 
06370     <span class="comment">//</span>
06371     <span class="comment">// The NumberOfLinenumbers field is used to store the</span>
06372     <span class="comment">// lock count.</span>
06373     <span class="comment">//</span>
06374     <span class="comment">//  Value of 0 means unlocked,</span>
06375     <span class="comment">//  Value of 1 means lock in progress by another thread.</span>
06376     <span class="comment">//  Value of 2 or more means locked.</span>
06377     <span class="comment">//</span>
06378     <span class="comment">//  If the value is 1, this thread must block until the other thread's</span>
06379     <span class="comment">//  lock operation is complete.</span>
06380     <span class="comment">//</span>
06381 
06382     NtSection-&gt;NumberOfLinenumbers += 1;
06383 
06384     if (NtSection-&gt;NumberOfLinenumbers &gt;= 3) {
06385 
06386         <span class="comment">//</span>
06387         <span class="comment">// Already locked, increment counter and return.</span>
06388         <span class="comment">//</span>
06389 
06390         <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
06391         UNLOCK_SYSTEM_WS (OldIrqlWs);
06392         <span class="keywordflow">return</span>;
06393     }
06394 
06395     <span class="keywordflow">if</span> (NtSection-&gt;NumberOfLinenumbers == 2) {
06396 
06397         <span class="comment">//</span>
06398         <span class="comment">// A lock is in progress.</span>
06399         <span class="comment">// Reset back to 1 and wait.</span>
06400         <span class="comment">//</span>
06401 
06402         NtSection-&gt;NumberOfLinenumbers = 1;
06403         MmCollidedLockWait = TRUE;
06404 
06405         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
06406 
06407         <span class="comment">//</span>
06408         <span class="comment">// The unlock IRQLs are deliberately reversed as the lock and mutex</span>
06409         <span class="comment">// are being released in reverse order.</span>
06410         <span class="comment">//</span>
06411 
06412         UNLOCK_SYSTEM_WS_NO_IRQL ();
06413         UNLOCK_PFN_AND_THEN_WAIT (OldIrqlWs);
06414 
06415         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;MmCollidedLockEvent,
06416                               WrVirtualMemory,
06417                               KernelMode,
06418                               FALSE,
06419                               (PLARGE_INTEGER)NULL);
06420         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
06421         <span class="keywordflow">goto</span> RetryLock;
06422     }
06423 
06424     <span class="comment">//</span>
06425     <span class="comment">// Value was 0 when the lock was obtained.  It is now 1 indicating</span>
06426     <span class="comment">// a lock is in progress.</span>
06427     <span class="comment">//</span>
06428 
06429     MiLockCode (PointerPte, LastPte, MM_LOCK_BY_REFCOUNT);
06430 
06431     <span class="comment">//</span>
06432     <span class="comment">// Set lock count to 2 (it was 1 when this started) and check</span>
06433     <span class="comment">// to see if any other threads tried to lock while this was happening.</span>
06434     <span class="comment">//</span>
06435 
06436     MiMakeSystemAddressValidPfnSystemWs (&amp;NtSection-&gt;NumberOfLinenumbers);
06437     NtSection-&gt;NumberOfLinenumbers += 1;
06438 
06439     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NtSection-&gt;NumberOfLinenumbers == 2);
06440 
06441     Collision = MmCollidedLockWait;
06442     MmCollidedLockWait = FALSE;
06443 
06444     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
06445     UNLOCK_SYSTEM_WS (OldIrqlWs);
06446 
06447     <span class="keywordflow">if</span> (Collision) {
06448 
06449         <span class="comment">//</span>
06450         <span class="comment">// Wake up all waiters.</span>
06451         <span class="comment">//</span>
06452 
06453         KePulseEvent (&amp;MmCollidedLockEvent, 0, FALSE);
06454     }
06455 
06456     <span class="keywordflow">return</span>;
06457 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a308" doxytag="mm.h::MmLockPagedPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmLockPagedPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07821">7821</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">MiLockCode()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00113">MM_LOCK_BY_REFCOUNT</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/i386_2ldtsup_8c-source.html#l00255">Ke386SetDescriptorProcess()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l05376">MiSetImageProtect()</a>.
<p>
<pre class="fragment"><div>07828                    :
07829 
07830     Locks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address (which MUST reside in paged pool) into
07831     memory until <a class="code" href="../../d2/d1/mm_8h.html#a309">MmUnlockPagedPool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
07832 
07833 Arguments:
07834 
07835     Address - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address in paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to lock.
07836 
07837     SizeInBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size in bytes to lock.
07838 
07839 Return Value:
07840 
07841     None.
07842 
07843 Environment:
07844 
07845     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
07846 
07847 --*/
07848 
07849 {
07850     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
07851     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
07852     KIRQL OldIrql;
07853     KIRQL OldIrqlWs;
07854 
07855     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
07856     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Address);
07857     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PVOID)((PCHAR)Address + (SizeInBytes - 1)));
07858     <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrqlWs);
07859     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
07860     <a class="code" href="../../d4/d8/mi_8h.html#a873">MiLockCode</a> (PointerPte, LastPte, MM_LOCK_BY_REFCOUNT);
07861     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
07862     <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrqlWs);
07863     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
07864     <span class="keywordflow">return</span>;
07865 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a234" doxytag="mm.h::MmMakeKernelResourceSectionWritable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmMakeKernelResourceSectionWritable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l06495">6495</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02513">MI_WRITE_VALID_PTE_NEW_PROTECTION</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00097">KeGetBugMessageText()</a>.
<p>
<pre class="fragment"><div>06501                    :
06502 
06503     This function makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel's resource section readwrite so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bugcheck
06504     code can write into <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
06505 
06506 Arguments:
06507 
06508     None.
06509 
06510 Return Value:
06511 
06512     None.
06513 
06514 Environment:
06515 
06516     Kernel mode.  Any IRQL.
06517 
06518 --*/
06519 
06520 {
06521 <span class="preprocessor">#if defined (_X86_)</span>
06522 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
06523     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
06524     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
06525 
06526     <span class="keywordflow">if</span> (MiKernelResourceStartPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06527         <span class="keywordflow">return</span>;
06528     }
06529 
06530     PointerPte = MiKernelResourceStartPte;
06531 
06532     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a> (MiGetVirtualAddressMappedByPte (PointerPte))) {
06533 
06534         <span class="comment">//</span>
06535         <span class="comment">// Mapped physically, doesn't need to be made readwrite.</span>
06536         <span class="comment">//</span>
06537 
06538         <span class="keywordflow">return</span>;
06539     }
06540 
06541     <span class="comment">//</span>
06542     <span class="comment">// Since the entry state and IRQL are unknown, just go through the</span>
06543     <span class="comment">// PTEs without a lock and make them all readwrite.</span>
06544     <span class="comment">//</span>
06545 
06546     <span class="keywordflow">do</span> {
06547         PteContents = *PointerPte;
06548 <span class="preprocessor">#if defined(NT_UP)</span>
06549 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 0)
06550 <span class="preprocessor">#else</span>
06551 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Writable == 0)
06552 <span class="preprocessor">#endif</span>
06553 <span class="preprocessor"></span>        {
06554             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
06555                                PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber,
06556                                MM_READWRITE,
06557                                PointerPte);
06558 <span class="preprocessor">#if !defined(NT_UP)</span>
06559 <span class="preprocessor"></span>            TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Writable = 1;
06560 <span class="preprocessor">#endif</span>
06561 <span class="preprocessor"></span>            <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a188">MI_WRITE_VALID_PTE_NEW_PROTECTION</a> (PointerPte, TempPte);
06562         }
06563         PointerPte += 1;
06564     } <span class="keywordflow">while</span> (PointerPte &lt;= MiKernelResourceEndPte); 
06565 
06566     <span class="comment">//</span>
06567     <span class="comment">// Don't do this more than once.</span>
06568     <span class="comment">//</span>
06569 
06570     MiKernelResourceStartPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06571 
06572     <span class="comment">//</span>
06573     <span class="comment">// Only flush this processor as the state of the others is unknown.</span>
06574     <span class="comment">//</span>
06575 
06576     <a class="code" href="../../d4/d9/ke_8h.html#a374">KeFlushCurrentTb</a> ();
06577 <span class="preprocessor">#endif</span>
06578 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a286" doxytag="mm.h::MmMapIoSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI PVOID MmMapIoSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CacheType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l03415">3415</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00420">_MDL::ByteCount</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00421">_MDL::ByteOffset</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02780">KeFeatureBits</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d1/d4/i386_2flush_8c-source.html#l00187">KeInvalidateAllCaches()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00576">KeSetPhysicalCacheTypeRange()</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02712">KF_PAT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00418">_MDL::MappedSystemVa</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00861">MI_DISABLE_CACHING</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00687">MI_SET_PTE_WRITE_COMBINE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01611">MiInsertPteTracker()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00822">MiLockSystemSpace</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01859">MiReleaseDeadPteTrackers()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d7/d1/mm_2ia64_2initia64_8c-source.html#l02042">MiSweepCacheMachineDependent()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00093">MiTrackPtesAborted</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00825">MiUnlockSystemSpace</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00267">MiWriteCombiningPtes</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00321">MM_COLOR_ALIGNMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00327">MM_COLOR_MASK_VIRTUAL</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a254">MmMaximumCacheType</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00093">MmTrackPtes</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a253">MmUSWCCached</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00419">_MDL::StartVa</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00038">ValidKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/rules_8c-source.html#l02173">CmpFindACPITable()</a>, <a class="el" href="../../d7/d7/fsvga_8c-source.html#l00053">DriverEntry()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03744">MmAllocateContiguousMemorySpecifyCache()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07516">MmMapVideoDisplay()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l00662">VerifierMapIoSpace()</a>.
<p>
<pre class="fragment"><div>03423                    :
03424 
03425     This function maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical address into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-pagable
03426     portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system address space.
03427 
03428 Arguments:
03429 
03430     PhysicalAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting physical address to map.
03431 
03432     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to map.
03433 
03434     CacheType - Supplies <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be mapped
03435                 as non-cached, <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address should be cached, and
03436                 <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address should be cached and
03437                 write-combined as a frame buffer which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be used <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> by
03438                 <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> video port driver.  All other callers should use
03439                 <a class="code" href="../../d4/d9/ke_8h.html#a413a253">MmUSWCCached</a>.  <a class="code" href="../../d4/d9/ke_8h.html#a413a253">MmUSWCCached</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d9/union__PAT.html">PAT</a>
03440                 feature <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present and available.
03441 
03442                 For I/O device registers, <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> usually specified
03443                 as <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>.
03444 
03445 Return Value:
03446 
03447     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address which maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical addresses.
03448     The value <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> sufficient <span class="keyword">virtual</span> address space <span class="keywordflow">for</span>
03449     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping could not be found.
03450 
03451 Environment:
03452 
03453     Kernel mode, Should be IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below, but unfortunately
03454     callers are coming in at <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> and <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>'s too late to change <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03455     rules now.  This means you can never make <span class="keyword">this</span> routine pagable.
03456 
03457 --*/
03458 
03459 {
03460     PFN_NUMBER NumberOfPages;
03461     PFN_NUMBER PageFrameIndex;
03462     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03463     PVOID BaseVa;
03464     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03465     KIRQL OldIrql;
03466     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> TempMdl;
03467     PFN_NUMBER MdlHack[(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)/<span class="keyword">sizeof</span>(PFN_NUMBER)) + 1];
03468     PPFN_NUMBER Page;
03469     <a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">PLOCK_TRACKER</a> Tracker;
03470     PVOID CallingAddress;
03471     PVOID CallersCaller;
03472 <span class="preprocessor">#ifdef i386</span>
03473 <span class="preprocessor"></span>    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03474 <span class="preprocessor">#endif</span>
03475 <span class="preprocessor"></span>
03476 <span class="preprocessor">#if !defined (_X86_)</span>
03477 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
03478     CallersCaller = (PVOID)0;
03479 <span class="preprocessor">#endif</span>
03480 <span class="preprocessor"></span>
03481     <span class="comment">//</span>
03482     <span class="comment">// For compatibility for when CacheType used to be passed as a BOOLEAN</span>
03483     <span class="comment">// mask off the upper bits (TRUE == MmCached, FALSE == MmNonCached).</span>
03484     <span class="comment">//</span>
03485 
03486     CacheType &amp;= 0xFF;
03487 
03488     <span class="keywordflow">if</span> (CacheType &gt;= <a class="code" href="../../d4/d9/ke_8h.html#a413a254">MmMaximumCacheType</a>) {
03489         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03490     }
03491 
03492 <span class="preprocessor">#if defined (i386) &amp;&amp; !defined (_X86PAE_)</span>
03493 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PhysicalAddress.HighPart == 0);
03494 <span class="preprocessor">#endif</span>
03495 <span class="preprocessor"></span>
03496     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes != 0);
03497     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (PhysicalAddress.LowPart,
03498                                            NumberOfBytes);
03499 
03500     PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a>((ULONG)NumberOfPages,
03501                                      SystemPteSpace,
03502                                      MM_COLOR_ALIGNMENT,
03503                                      (PhysicalAddress.LowPart &amp;
03504                                                        MM_COLOR_MASK_VIRTUAL),
03505                                      FALSE);
03506     <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03507         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03508     }
03509 
03510     BaseVa = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
03511     BaseVa = (PVOID)((PCHAR)BaseVa + <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(PhysicalAddress.LowPart));
03512 
03513     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
03514 
03515 <span class="preprocessor">#ifdef i386</span>
03516 <span class="preprocessor"></span>    <span class="comment">//</span>
03517     <span class="comment">// Set the physical range to proper caching type.  If the PAT feature</span>
03518     <span class="comment">// is supported, then set the caching type in the PTE, otherwise modify</span>
03519     <span class="comment">// the MTRRs if applicable.  If the cache type is MmUSWCCached and the</span>
03520     <span class="comment">// PAT is not supported then fail the call.</span>
03521     <span class="comment">//</span>
03522 
03523     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a>) {
03524         <span class="keywordflow">if</span> ((CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>) || (CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a253">MmUSWCCached</a>)) {
03525             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/mi386_8h.html#a204">MiWriteCombiningPtes</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03526                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a111">MI_SET_PTE_WRITE_COMBINE</a>(TempPte);
03527                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03528             } <span class="keywordflow">else</span> {
03529                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
03530             }
03531         } <span class="keywordflow">else</span> {
03532 
03533             <span class="comment">//</span>
03534             <span class="comment">// For Non-MmFrameBufferCaching type use existing mm macros.</span>
03535             <span class="comment">//</span>
03536 
03537             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03538         }
03539     } <span class="keywordflow">else</span> {
03540 
03541         <span class="comment">// Set the MTRRs if possible.</span>
03542 
03543         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d4/mtrr_8c.html#a32">KeSetPhysicalCacheTypeRange</a>(
03544                     PhysicalAddress,
03545                     NumberOfBytes,
03546                     CacheType
03547                     );
03548     }
03549 
03550     <span class="comment">//</span>
03551     <span class="comment">// If range could not be set, determine what to do</span>
03552     <span class="comment">//</span>
03553 
03554     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03555 
03556         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOT_SUPPORTED) &amp;&amp;
03557             ((CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>) || (CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>))) {
03558 
03559             <span class="comment">//</span>
03560             <span class="comment">// The range may not have been set into the proper cache</span>
03561             <span class="comment">// type.  If the range is either MmNonCached or MmCached just</span>
03562             <span class="comment">// continue as the PTE will be marked properly.</span>
03563             <span class="comment">//</span>
03564 
03565             NOTHING;
03566 
03567         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_UNSUCCESSFUL  &amp;&amp;  CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) {
03568 
03569             <span class="comment">//</span>
03570             <span class="comment">// If setting a range to Cached was unsuccessful things are not</span>
03571             <span class="comment">// optimal, but not fatal.  The range can be returned to the</span>
03572             <span class="comment">// caller and it will have whatever caching type it has - possibly</span>
03573             <span class="comment">// something below fully cached.</span>
03574             <span class="comment">//</span>
03575 
03576             NOTHING;
03577 
03578         } <span class="keywordflow">else</span> {
03579 
03580             <span class="comment">//</span>
03581             <span class="comment">// If there's still a problem, fail the request.</span>
03582             <span class="comment">//</span>
03583 
03584             <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a>(PointerPte, NumberOfPages, SystemPteSpace);
03585 
03586             <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03587          }
03588     }
03589 <span class="preprocessor">#endif</span>
03590 <span class="preprocessor"></span>
03591     <span class="keywordflow">if</span> (CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>) {
03592         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a118">MI_DISABLE_CACHING</a> (TempPte);
03593     }
03594 
03595 <span class="preprocessor">#if defined(_IA64_)</span>
03596 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) { 
03597         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a>(FALSE, TRUE);
03598     }
03599 <span class="preprocessor">#endif</span>
03600 <span class="preprocessor"></span>
03601     PageFrameIndex = (PFN_NUMBER)(PhysicalAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03602 
03603     <span class="keywordflow">do</span> {
03604         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
03605         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
03606         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
03607         PointerPte += 1;
03608         PageFrameIndex += 1;
03609         NumberOfPages -= 1;
03610     } <span class="keywordflow">while</span> (NumberOfPages != 0);
03611 
03612 <span class="preprocessor">#if defined(i386)</span>
03613 <span class="preprocessor"></span>    <span class="comment">//</span>
03614     <span class="comment">// WriteCombined is a non self-snooping memory type.  This memory type</span>
03615     <span class="comment">// requires a writeback invalidation of all the caches on all processors</span>
03616     <span class="comment">// and each accompanying TB flush if the PAT is supported.</span>
03617     <span class="comment">//</span>
03618 
03619     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a>) &amp;&amp; ((CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>)
03620         || (CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a253">MmUSWCCached</a>)) &amp;&amp; (<a class="code" href="../../d6/d8/mi386_8h.html#a204">MiWriteCombiningPtes</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03621             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (FALSE, TRUE);
03622             <a class="code" href="../../d0/d5/i386_2flush_8c.html#a2">KeInvalidateAllCaches</a> (TRUE);
03623     }
03624 <span class="preprocessor">#endif</span>
03625 <span class="preprocessor"></span>
03626 <span class="preprocessor">#if defined(_IA64_)</span>
03627 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) {
03628         <a class="code" href="../../d2/d9/miia64_8h.html#a318">MiSweepCacheMachineDependent</a>(BaseVa, NumberOfBytes, CacheType);
03629     }
03630 <span class="preprocessor">#endif</span>
03631 <span class="preprocessor"></span>
03632     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a> != 0) {
03633 
03634         <span class="comment">//</span>
03635         <span class="comment">// First free any zombie blocks as no locks are being held.</span>
03636         <span class="comment">//</span>
03637 
03638         <a class="code" href="../../d5/d6/iosup_8c.html#a35">MiReleaseDeadPteTrackers</a> ();
03639 
03640         Tracker = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
03641                                          <span class="keyword">sizeof</span> (<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html">PTE_TRACKER</a>),
03642                                          'ySmM');
03643 
03644         <span class="keywordflow">if</span> (Tracker != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03645 <span class="preprocessor">#if defined (_X86_)</span>
03646 <span class="preprocessor"></span>            <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
03647 <span class="preprocessor">#endif</span>
03648 <span class="preprocessor"></span>
03649             TempMdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) &amp;MdlHack;
03650             TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a> = BaseVa;
03651             TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o5">StartVa</a> = (PVOID)(ULONG_PTR)PhysicalAddress.QuadPart;
03652             TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o7">ByteOffset</a> = <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(PhysicalAddress.LowPart);
03653             TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> = (ULONG)NumberOfBytes;
03654     
03655             Page = (PPFN_NUMBER) (TempMdl + 1);
03656             Page = (PPFN_NUMBER)-1;
03657     
03658             <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
03659     
03660             <a class="code" href="../../d5/d6/iosup_8c.html#a33">MiInsertPteTracker</a> (Tracker,
03661                                 TempMdl,
03662                                 COMPUTE_PAGES_SPANNED (PhysicalAddress.LowPart,
03663                                                NumberOfBytes),
03664                                 CallingAddress,
03665                                 CallersCaller);
03666     
03667             <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
03668         }
03669         <span class="keywordflow">else</span> {
03670             <a class="code" href="../../d5/d6/iosup_8c.html#a9">MiTrackPtesAborted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03671         }
03672     }
03673     
03674     <span class="keywordflow">return</span> BaseVa;
03675 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a276" doxytag="mm.h::MmMapLockedPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI PVOID MmMapLockedPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l02009">2009</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02058">MmMapLockedPagesSpecifyCache()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/verifier_8c-source.html#l00688">VerifierMapLockedPages()</a>.
<p>
<pre class="fragment"><div>02016                    :
02017 
02018     This function maps physical pages described by a memory descriptor
02019     list into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system <span class="keyword">virtual</span> address space or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user portion of
02020     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address space.
02021 
02022 Arguments:
02023 
02024     MemoryDescriptorList - Supplies a valid Memory Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> which has
02025                             been updated by <a class="code" href="../../d2/d1/mm_8h.html#a273">MmProbeAndLockPages</a>.
02026 
02027 
02028     AccessMode - Supplies an indicator of where to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages;
02029                  <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages should be mapped in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02030                  system part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02031                  pages should be mapped in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space.
02032 
02033 Return Value:
02034 
02035     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are mapped.  The base address
02036     has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same offset as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
02037 
02038     This routine will raise an exception <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> USER_MODE
02039     and quota limits or VM limits are exceeded.
02040 
02041 Environment:
02042 
02043     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below <span class="keywordflow">if</span> access mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02044                   <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below <span class="keywordflow">if</span> access mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
02045 
02046 --*/
02047 
02048 {
02049     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/iosup_8c.html#a50">MmMapLockedPagesSpecifyCache</a> (MemoryDescriptorList,
02050                                          AccessMode,
02051                                          MmCached,
02052                                          NULL,
02053                                          TRUE,
02054                                          HighPagePriority);
02055 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a279" doxytag="mm.h::MmMapLockedPagesSpecifyCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI PVOID MmMapLockedPagesSpecifyCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CacheType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BugCheckOnFailure</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/mm_8h.html#a154">MM_PAGE_PRIORITY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Priority</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l02058">2058</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d1/d4/i386_2flush_8c-source.html#l00187">KeInvalidateAllCaches()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00435">MDL_IO_SPACE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00437">MDL_MAPPING_CAN_FAIL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00428">MDL_PARTIAL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00429">MDL_PARTIAL_HAS_BEEN_MAPPED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00434">MDL_PHYSICAL_VIEW</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00426">MDL_SOURCE_IS_NONPAGED_POOL</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00861">MI_DISABLE_CACHING</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00687">MI_SET_PTE_WRITE_COMBINE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l02030">MiGetSystemPteAvailability()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01611">MiInsertPteTracker()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00822">MiLockSystemSpace</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02785">MiMapLockedPagesInUserSpace()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01859">MiReleaseDeadPteTrackers()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d7/d1/mm_2ia64_2initia64_8c-source.html#l02042">MiSweepCacheMachineDependent()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00093">MiTrackPtesAborted</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00825">MiUnlockSystemSpace</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00267">MiWriteCombiningPtes</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00321">MM_COLOR_ALIGNMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00315">MM_COLOR_MASK</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00327">MM_COLOR_MASK_VIRTUAL</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00116">MM_KSEG0_BASE</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a251">MmHardwareCoherentCached</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a252">MmNonCachedUnordered</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00026">MmSystemLockPagesCount</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00093">MmTrackPtes</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00282">PTE_SHIFT</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00038">ValidKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00529">MiDoMappedCopy()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02009">MmMapLockedPages()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l00751">VerifierMapLockedPagesSpecifyCache()</a>.
<p>
<pre class="fragment"><div>02069                    :
02070 
02071     This function maps physical pages described by a memory descriptor
02072     list into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system <span class="keyword">virtual</span> address space or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user portion of
02073     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address space.
02074 
02075 Arguments:
02076 
02077     MemoryDescriptorList - Supplies a valid Memory Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> which has
02078                            been updated by <a class="code" href="../../d2/d1/mm_8h.html#a273">MmProbeAndLockPages</a>.
02079 
02080     AccessMode - Supplies an indicator of where to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages;
02081                  <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages should be mapped in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02082                  system part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02083                  pages should be mapped in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space.
02084 
02085     CacheType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of cache mapping to use <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
02086                 <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a> indicates <span class="stringliteral">"normal"</span> kernel or user mappings.
02087 
02088     RequestedAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base user address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
02089                        used <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessMode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial
02090                        value of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not null, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view will
02091                        be allocated starting at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span>
02092                        address rounded down to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next 64kb address
02093                        boundary. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial value of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02094                        null, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operating system will determine
02095                        where to allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view.
02096 
02097     BugCheckOnFailure - Supplies whether to bugcheck <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping cannot be
02098                         obtained.  This flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> checked <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>'s
02099                         <a class="code" href="../../d0/d9/ntosdef_8h.html#a25">MDL_MAPPING_CAN_FAIL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zero, which implies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02100                         <span class="keywordflow">default</span> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> behavior <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to bugcheck.  This flag then
02101                         provides an additional avenue to avoid <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bugcheck.
02102                         Done <span class="keyword">this</span> way in order to provide WDM compatibility.
02103 
02104     Priority - Supplies an indication as to how important <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that <span class="keyword">this</span>
02105                request succeed under <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> available PTE conditions.
02106 
02107 Return Value:
02108 
02109     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are mapped.  The base address
02110     has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same offset as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
02111 
02112     This routine will raise an exception <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> USER_MODE
02113     and quota limits or VM limits are exceeded.
02114 
02115 Environment:
02116 
02117     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below <span class="keywordflow">if</span> access mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02118                   <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below <span class="keywordflow">if</span> access mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
02119 
02120 --*/
02121 
02122 {
02123     PFN_NUMBER NumberOfPages;
02124     PFN_NUMBER SavedPageCount;
02125     PPFN_NUMBER Page;
02126     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02127     PVOID BaseVa;
02128     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02129     PVOID StartingVa;
02130     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
02131     KIRQL OldIrql;
02132     PFN_NUMBER NumberOfPtes;
02133     PVOID CallingAddress;
02134     PVOID CallersCaller;
02135     PVOID Tracker;
02136 
02137 <span class="preprocessor">#if !defined (_X86_)</span>
02138 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
02139     CallersCaller = (PVOID)0;
02140 <span class="preprocessor">#endif</span>
02141 <span class="preprocessor"></span>
02142     StartingVa = (PVOID)((PCHAR)MemoryDescriptorList-&gt;StartVa +
02143                     MemoryDescriptorList-&gt;ByteOffset);
02144 
02145     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MemoryDescriptorList-&gt;ByteCount != 0);
02146 
02147     <span class="keywordflow">if</span> (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
02148 
02149         Page = (PPFN_NUMBER)(MemoryDescriptorList + 1);
02150         NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (StartingVa,
02151                                                MemoryDescriptorList-&gt;ByteCount);
02152         SavedPageCount = NumberOfPages;
02153 
02154         <span class="comment">//</span>
02155         <span class="comment">// Map the pages into the system part of the address space as</span>
02156         <span class="comment">// kernel read/write.</span>
02157         <span class="comment">//</span>
02158 
02159         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; (
02160                         MDL_MAPPED_TO_SYSTEM_VA |
02161                         MDL_SOURCE_IS_NONPAGED_POOL |
02162                         MDL_PARTIAL_HAS_BEEN_MAPPED)) == 0);
02163         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; (
02164                         MDL_PAGES_LOCKED |
02165                         MDL_PARTIAL)) != 0);
02166 
02167         <span class="comment">//</span>
02168         <span class="comment">// Map this with KSEG0 if possible.</span>
02169         <span class="comment">//</span>
02170 
02171 <span class="preprocessor">#if defined(_ALPHA_)</span>
02172 <span class="preprocessor"></span><span class="preprocessor">#define KSEG0_MAXPAGE ((PFN_NUMBER)((KSEG2_BASE - KSEG0_BASE) &gt;&gt; PAGE_SHIFT))</span>
02173 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02174 <span class="preprocessor"></span>
02175 <span class="preprocessor">#if defined(_X86_) || defined(_IA64_)</span>
02176 <span class="preprocessor"></span><span class="preprocessor">#define KSEG0_MAXPAGE MmKseg2Frame</span>
02177 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02178 <span class="preprocessor"></span>
02179 <span class="preprocessor">#if defined(_IA64_)</span>
02180 <span class="preprocessor"></span><span class="preprocessor">#define MM_KSEG0_BASE KSEG0_BASE</span>
02181 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02182 <span class="preprocessor"></span>
02183         <span class="keywordflow">if</span> ((NumberOfPages == 1) &amp;&amp; (CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) &amp;&amp;
02184             (*Page &lt; KSEG0_MAXPAGE)) {
02185             BaseVa = (PVOID)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a3">MM_KSEG0_BASE</a> + (*Page &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) +
02186                             MemoryDescriptorList-&gt;ByteOffset);
02187             MemoryDescriptorList-&gt;MappedSystemVa = BaseVa;
02188             MemoryDescriptorList-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>;
02189 
02190             <span class="keywordflow">goto</span> Update;
02191         }
02192 
02193         <span class="comment">//</span>
02194         <span class="comment">// Make sure there are enough PTEs of the requested size.</span>
02195         <span class="comment">//</span>
02196 
02197         <span class="keywordflow">if</span> ((Priority != <a class="code" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>) &amp;&amp;
02198             (<a class="code" href="../../d0/d9/sysptes_8c.html#a29">MiGetSystemPteAvailability</a> ((ULONG)NumberOfPages, Priority) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02199                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02200         }
02201 
02202         PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (
02203                                     (ULONG)NumberOfPages,
02204                                     SystemPteSpace,
02205                                     MM_COLOR_ALIGNMENT,
02206                                     (PtrToUlong(StartingVa) &amp;
02207                                                        MM_COLOR_MASK_VIRTUAL),
02208                         MemoryDescriptorList-&gt;MdlFlags &amp; MDL_MAPPING_CAN_FAIL ? 0 : BugCheckOnFailure);
02209 
02210         <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02211 
02212             <span class="comment">//</span>
02213             <span class="comment">// Not enough system PTES are available.</span>
02214             <span class="comment">//</span>
02215 
02216             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02217         }
02218         BaseVa = (PVOID)((PCHAR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte) +
02219                                 MemoryDescriptorList-&gt;ByteOffset);
02220 
02221         NumberOfPtes = NumberOfPages;
02222 
02223         TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
02224 
02225         <span class="keywordflow">switch</span> (CacheType) {
02226 
02227             <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>:
02228                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a118">MI_DISABLE_CACHING</a> (TempPte);
02229                 <span class="keywordflow">break</span>;
02230 
02231             <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>:
02232                 <span class="keywordflow">break</span>;
02233 
02234             <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>:
02235                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a111">MI_SET_PTE_WRITE_COMBINE</a> (TempPte);
02236                 <span class="keywordflow">break</span>;
02237 
02238             <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a251">MmHardwareCoherentCached</a>:
02239                 <span class="keywordflow">break</span>;
02240 
02241 <span class="preprocessor">#if 0</span>
02242 <span class="preprocessor"></span>            <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a252">MmNonCachedUnordered</a>:
02243                 <span class="keywordflow">break</span>;
02244 <span class="preprocessor">#endif</span>
02245 <span class="preprocessor"></span>
02246             <span class="keywordflow">default</span>:
02247                 <span class="keywordflow">break</span>;
02248         }
02249 
02250 <span class="preprocessor">#if defined(_IA64_)</span>
02251 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) {
02252             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a>(FALSE, TRUE);
02253         }
02254 <span class="preprocessor">#endif</span>
02255 <span class="preprocessor"></span>
02256 <span class="preprocessor">#if DBG</span>
02257 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
02258 <span class="preprocessor">#endif //DBG</span>
02259 <span class="preprocessor"></span>
02260         <span class="keywordflow">do</span> {
02261 
02262             <span class="keywordflow">if</span> (*Page == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
02263                 <span class="keywordflow">break</span>;
02264             }
02265             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = *Page;
02266             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
02267 
02268 <span class="preprocessor">#if DBG</span>
02269 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;MdlFlags &amp; (<a class="code" href="../../d0/d9/ntosdef_8h.html#a23">MDL_IO_SPACE</a> | <a class="code" href="../../d0/d9/ntosdef_8h.html#a22">MDL_PHYSICAL_VIEW</a>)) == 0) {
02270                 Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
02271                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0);
02272                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((((ULONG_PTR)PointerPte &gt;&gt; PTE_SHIFT) &amp; MM_COLOR_MASK) ==
02273                      (((ULONG)Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor)));
02274             }
02275 <span class="preprocessor">#endif //DBG</span>
02276 <span class="preprocessor"></span>
02277             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
02278             Page += 1;
02279             PointerPte += 1;
02280             NumberOfPages -= 1;
02281         } <span class="keywordflow">while</span> (NumberOfPages != 0);
02282 
02283 <span class="preprocessor">#if DBG</span>
02284 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
02285 <span class="preprocessor">#endif //DBG</span>
02286 <span class="preprocessor"></span>
02287 <span class="preprocessor">#if defined(i386)</span>
02288 <span class="preprocessor"></span>        <span class="comment">//</span>
02289         <span class="comment">// If write combined was specified then flush all caches and TBs.</span>
02290         <span class="comment">//</span>
02291 
02292         <span class="keywordflow">if</span> (CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a> &amp;&amp; <a class="code" href="../../d6/d8/mi386_8h.html#a204">MiWriteCombiningPtes</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02293             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (FALSE, TRUE);
02294             <a class="code" href="../../d0/d5/i386_2flush_8c.html#a2">KeInvalidateAllCaches</a> (TRUE);
02295         }
02296 <span class="preprocessor">#endif</span>
02297 <span class="preprocessor"></span>
02298 <span class="preprocessor">#if defined(_IA64_)</span>
02299 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) {
02300             <a class="code" href="../../d2/d9/miia64_8h.html#a318">MiSweepCacheMachineDependent</a>(BaseVa, SavedPageCount * PAGE_SIZE, CacheType);
02301         }
02302 <span class="preprocessor">#endif</span>
02303 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a> != 0) {
02304 
02305             <span class="comment">//</span>
02306             <span class="comment">// First free any zombie blocks as no locks are being held.</span>
02307             <span class="comment">//</span>
02308 
02309             <a class="code" href="../../d5/d6/iosup_8c.html#a35">MiReleaseDeadPteTrackers</a> ();
02310 
02311             Tracker = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
02312                                              <span class="keyword">sizeof</span> (<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html">PTE_TRACKER</a>),
02313                                              'ySmM');
02314             <span class="keywordflow">if</span> (Tracker == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02315                 <a class="code" href="../../d5/d6/iosup_8c.html#a9">MiTrackPtesAborted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02316             }
02317         }
02318 
02319         <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
02320         <span class="keywordflow">if</span> (MemoryDescriptorList-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>) {
02321 
02322             <span class="comment">//</span>
02323             <span class="comment">// Another thread must have already mapped this.</span>
02324             <span class="comment">// Clean up the system PTES and release them.</span>
02325             <span class="comment">//</span>
02326 
02327             <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
02328 
02329             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a> != 0) {
02330                 <span class="keywordflow">if</span> (Tracker != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02331                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Tracker);
02332                 }
02333             }
02334 
02335 <span class="preprocessor">#if DBG</span>
02336 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;MdlFlags &amp; (<a class="code" href="../../d0/d9/ntosdef_8h.html#a23">MDL_IO_SPACE</a> | <a class="code" href="../../d0/d9/ntosdef_8h.html#a22">MDL_PHYSICAL_VIEW</a>)) == 0) {
02337                 <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn3;
02338                 PFN_NUMBER j;
02339                 PPFN_NUMBER Page1;
02340     
02341                 Page1 = (PPFN_NUMBER)(MemoryDescriptorList + 1);
02342                 <span class="keywordflow">for</span> (j = 0; j &lt; SavedPageCount ;j += 1) {
02343                     <span class="keywordflow">if</span> (*Page == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
02344                         <span class="keywordflow">break</span>;
02345                     }
02346                     Pfn3 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page1);
02347                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn3-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0);
02348                     Page1 += 1;
02349                 }
02350             }
02351 <span class="preprocessor">#endif //DBG</span>
02352 <span class="preprocessor"></span>            PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseVa);
02353 
02354             <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte,
02355                                  (ULONG)SavedPageCount,
02356                                  SystemPteSpace);
02357 
02358             <span class="keywordflow">return</span> MemoryDescriptorList-&gt;MappedSystemVa;
02359         }
02360 
02361         MemoryDescriptorList-&gt;MappedSystemVa = BaseVa;
02362         *(<span class="keyword">volatile</span> ULONG *)&amp;<a class="code" href="../../d5/d6/iosup_8c.html#a2">MmSystemLockPagesCount</a>;  <span class="comment">//need to force order.</span>
02363         MemoryDescriptorList-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>;
02364 
02365         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a> != 0) &amp;&amp; (Tracker != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02366 <span class="preprocessor">#if defined (_X86_)</span>
02367 <span class="preprocessor"></span>            <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
02368 <span class="preprocessor">#endif</span>
02369 <span class="preprocessor"></span>            <a class="code" href="../../d5/d6/iosup_8c.html#a33">MiInsertPteTracker</a> (Tracker,
02370                                 MemoryDescriptorList,
02371                                 NumberOfPtes,
02372                                 CallingAddress,
02373                                 CallersCaller);
02374         }
02375 
02376         <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
02377 
02378 Update:
02379         <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a16">MDL_PARTIAL</a>) != 0) {
02380             MemoryDescriptorList-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a17">MDL_PARTIAL_HAS_BEEN_MAPPED</a>;
02381         }
02382 
02383         <span class="keywordflow">return</span> BaseVa;
02384 
02385     } <span class="keywordflow">else</span> {
02386 
02387         <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/iosup_8c.html#a29">MiMapLockedPagesInUserSpace</a> (MemoryDescriptorList,
02388                                             StartingVa,
02389                                             CacheType,
02390                                             RequestedAddress);
02391     }
02392 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a334" doxytag="mm.h::MmMapMemoryDumpMdl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmMapMemoryDumpMdl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>MemoryDumpMdl</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07197">7197</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00425">MM_KERNEL_DEMAND_ZERO_PTE</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00105">MmCrashDumpPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00038">ValidKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02081">IopMapPhysicalMemory()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03183">IopWritePageToDisk()</a>.
<p>
<pre class="fragment"><div>07203                    :
07204 
07205     For use by crash dump routine ONLY.  Maps an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> into a fixed
07206     portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space.  Only 1 <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> can be mapped at a
07207     time.
07208 
07209 Arguments:
07210 
07211     MemoryDumpMdl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> to map.
07212 
07213 Return Value:
07214 
07215     None, fields in <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> updated.
07216 
07217 --*/
07218 
07219 {
07220     PFN_NUMBER NumberOfPages;
07221     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
07222     PCHAR BaseVa;
07223     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
07224     PPFN_NUMBER Page;
07225 
07226     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (MemoryDumpMdl-&gt;ByteCount + MemoryDumpMdl-&gt;ByteOffset);
07227 
07228     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPages &lt;= 16);
07229 
07230     PointerPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a19">MmCrashDumpPte</a>;
07231     BaseVa = (PCHAR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte);
07232     MemoryDumpMdl-&gt;MappedSystemVa = (PCHAR)BaseVa + MemoryDumpMdl-&gt;ByteOffset;
07233     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
07234     Page = (PPFN_NUMBER)(MemoryDumpMdl + 1);
07235 
07236     <span class="comment">//</span>
07237     <span class="comment">// If the pages don't span the entire dump virtual address range,</span>
07238     <span class="comment">// build a barrier.  Otherwise use the default barrier provided at the</span>
07239     <span class="comment">// end of the dump virtual address range.</span>
07240     <span class="comment">//</span>
07241 
07242     <span class="keywordflow">if</span> (NumberOfPages &lt; 16) {
07243         <a class="code" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb</a> (TRUE, BaseVa + (NumberOfPages &lt;&lt; PAGE_SHIFT));
07244         (PointerPte + NumberOfPages)-&gt;u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a96">MM_KERNEL_DEMAND_ZERO_PTE</a>;
07245     }
07246 
07247     <span class="keywordflow">do</span> {
07248 
07249         <a class="code" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb</a> (TRUE, BaseVa);
07250 
07251         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = *Page;
07252 
07253         <span class="comment">//</span>
07254         <span class="comment">// Note this PTE may be valid or invalid prior to the overwriting here.</span>
07255         <span class="comment">//</span>
07256 
07257         *PointerPte = TempPte;
07258 
07259         Page += 1;
07260         PointerPte += 1;
07261         BaseVa += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
07262         NumberOfPages -= 1;
07263     } <span class="keywordflow">while</span> (NumberOfPages != 0);
07264 
07265     <span class="keywordflow">return</span>;
07266 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a278" doxytag="mm.h::MmMapUserAddressesToPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS MmMapUserAddressesToPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>PageAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05161">5161</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00216">_EPROCESS::AddressSpaceDeleted</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01093">LOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00763">MI_VPN_TO_VA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00765">MI_VPN_TO_VA_ENDING</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02543">MiFillMemoryPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00380">MiLocateAddress()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05490">MmGetPhysicalAddress()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>05169                    :
05170 
05171     This function maps a range of addresses in a physical memory VAD to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05172     specified page address.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> typically used by a driver to nicely
05173     remove an application's access to things like video memory when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05174     application <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not responding to requests to relinquish <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
05175 
05176     Note <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire range must be currently mapped (ie, all the PTEs must
05177     be valid) by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
05178 
05179 Arguments:
05180 
05181     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <span class="keyword">virtual</span> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical
05182                   address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mapped.
05183 
05184     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to remap to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> address.
05185 
05186     PageAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> remapped to.
05187                   This must be nonpaged memory.
05188 
05189 Return Value:
05190 
05191     Various <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> codes.
05192 
05193 Environment:
05194 
05195     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
05196 
05197 --*/
05198 
05199 {
05200     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
05201     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05202     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
05203     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
05204     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
05205     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05206     PVOID EndingAddress;
05207     PFN_NUMBER PageFrameNumber;
05208     SIZE_T NumberOfPtes;
05209     PHYSICAL_ADDRESS PhysicalAddress;
05210     KIRQL OldIrql;
05211 
05212     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05213 
05214     <span class="keywordflow">if</span> (BaseAddress &gt; MM_HIGHEST_USER_ADDRESS) {
05215         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_1;
05216     }
05217 
05218     <span class="keywordflow">if</span> ((ULONG_PTR)BaseAddress + NumberOfBytes &gt; (ULONG64)MM_HIGHEST_USER_ADDRESS) {
05219         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
05220     }
05221 
05222     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
05223 
05224     EndingAddress = (PVOID)((PCHAR)BaseAddress + NumberOfBytes - 1);
05225 
05226     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
05227 
05228     <span class="comment">//</span>
05229     <span class="comment">// Make sure the address space was not deleted.</span>
05230     <span class="comment">//</span>
05231 
05232     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) {
05233         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
05234         <span class="keywordflow">goto</span> ErrorReturn;
05235     }
05236 
05237     Vad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (BaseAddress);
05238 
05239     <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05240 
05241         <span class="comment">//</span>
05242         <span class="comment">// No virtual address descriptor located.</span>
05243         <span class="comment">//</span>
05244 
05245         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_MEMORY_NOT_ALLOCATED;
05246         <span class="keywordflow">goto</span> ErrorReturn;
05247     }
05248 
05249     <span class="keywordflow">if</span> (NumberOfBytes == 0) {
05250 
05251         <span class="comment">//</span>
05252         <span class="comment">// If the region size is specified as 0, the base address</span>
05253         <span class="comment">// must be the starting address for the region.  The entire VAD</span>
05254         <span class="comment">// will then be repointed.</span>
05255         <span class="comment">//</span>
05256 
05257         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (BaseAddress) != Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) {
05258             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_FREE_VM_NOT_AT_BASE;
05259             <span class="keywordflow">goto</span> ErrorReturn;
05260         }
05261 
05262         BaseAddress = <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>);
05263         EndingAddress = <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>);
05264         NumberOfBytes = (PCHAR)EndingAddress - (PCHAR)BaseAddress + 1;
05265     }
05266 
05267     <span class="comment">//</span>
05268     <span class="comment">// Found the associated virtual address descriptor.</span>
05269     <span class="comment">//</span>
05270 
05271     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress)) {
05272 
05273         <span class="comment">//</span>
05274         <span class="comment">// The entire range to remap is not contained within a single</span>
05275         <span class="comment">// virtual address descriptor.  Return an error.</span>
05276         <span class="comment">//</span>
05277 
05278         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_2;
05279         <span class="keywordflow">goto</span> ErrorReturn;
05280     }
05281 
05282     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping == 0) {
05283 
05284         <span class="comment">//</span>
05285         <span class="comment">// The virtual address descriptor is not a physical mapping.</span>
05286         <span class="comment">//</span>
05287 
05288         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_ADDRESS;
05289         <span class="keywordflow">goto</span> ErrorReturn;
05290     }
05291 
05292     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
05293     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
05294     NumberOfPtes = LastPte - PointerPte + 1;
05295 
05296     PhysicalAddress = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a> (PageAddress);
05297     PageFrameNumber = (PFN_NUMBER)(PhysicalAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
05298 
05299     PteContents = *PointerPte;
05300     PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameNumber;
05301 
05302 <span class="preprocessor">#if DBG</span>
05303 <span class="preprocessor"></span>
05304     <span class="comment">//</span>
05305     <span class="comment">// All the PTEs must be valid or the filling will corrupt the</span>
05306     <span class="comment">// UsedPageTableCounts.</span>
05307     <span class="comment">//</span>
05308 
05309     <span class="keywordflow">do</span> {
05310         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid == 1);
05311         PointerPte += 1;
05312     } <span class="keywordflow">while</span> (PointerPte &lt; LastPte);
05313     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
05314 <span class="preprocessor">#endif</span>
05315 <span class="preprocessor"></span>
05316     <span class="comment">//</span>
05317     <span class="comment">// Fill the PTEs and flush at the end - no race here because it doesn't</span>
05318     <span class="comment">// matter whether the user app sees the old or the new data until we</span>
05319     <span class="comment">// return (writes going to either page is acceptable prior to return</span>
05320     <span class="comment">// from this function).  There is no race with I/O and ProbeAndLockPages</span>
05321     <span class="comment">// because the PFN lock is acquired here.</span>
05322     <span class="comment">//</span>
05323 
05324     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05325 
05326 <span class="preprocessor">#if !defined (_X86PAE_)</span>
05327 <span class="preprocessor"></span>    <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (PointerPte,
05328                      NumberOfPtes * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>),
05329                      PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
05330 <span class="preprocessor">#else</span>
05331 <span class="preprocessor"></span>
05332     <span class="comment">//</span>
05333     <span class="comment">// Note that the PAE architecture must very carefully fill these PTEs.</span>
05334     <span class="comment">//</span>
05335 
05336     <span class="keywordflow">do</span> {
05337         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid == 1);
05338         PointerPte += 1;
05339         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)KeInterlockedSwapPte ((PHARDWARE_PTE)PointerPte,
05340                                     (PHARDWARE_PTE)&amp;PteContents);
05341     } <span class="keywordflow">while</span> (PointerPte &lt; LastPte);
05342     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
05343 
05344 <span class="preprocessor">#endif</span>
05345 <span class="preprocessor"></span>
05346     <span class="keywordflow">if</span> (NumberOfPtes == 1) {
05347 
05348         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (BaseAddress,
05349                                TRUE,
05350                                TRUE,
05351                                (PHARDWARE_PTE)PointerPte,
05352                                PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
05353     }
05354     <span class="keywordflow">else</span> {
05355         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (TRUE, TRUE);
05356     }
05357 
05358     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05359 
05360     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
05361 
05362 ErrorReturn:
05363 
05364     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
05365 
05366     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05367 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a289" doxytag="mm.h::MmMapVideoDisplay" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI PVOID MmMapVideoDisplay           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CacheType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07516">7516</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00861">MI_DISABLE_CACHING</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00808">MI_SET_GLOBAL_STATE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02543">MiFillMemoryPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01591">MiGetSubsectionAddressForPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01495">MiProtoAddressForPte</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00142">MM_NOCACHE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00278">MM_VA_MAPPED_BY_PDE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00412">MM_ZERO_KERNEL_PTE</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03415">MmMapIoSpace()</a>, <a class="el" href="../../d4/d1/dataia64_8c-source.html#l00180">MmPageSizeInfo</a>, <a class="el" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00282">PTE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02119">_SUBSECTION::StartingSector</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d1/d7/struct__SUBSECTION.html#o3">_SUBSECTION::u</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00038">ValidKernelPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00094">X64K</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
<pre class="fragment"><div>07524                    :
07525 
07526     This function maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical address into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-pagable
07527     portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system address space.
07528 
07529 Arguments:
07530 
07531     PhysicalAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting physical address to map.
07532 
07533     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to map.
07534 
07535     CacheType - Supplies <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be mapped
07536                 as non-cached, <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address should be cached, and
07537                 <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address should be cached and
07538                 write-combined as a frame buffer. For I/O device registers,
07539                 <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> usually specified as <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>.
07540 
07541 Return Value:
07542 
07543     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address which maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical addresses.
07544     The value <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> sufficient <span class="keyword">virtual</span> address space <span class="keywordflow">for</span>
07545     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping could not be found.
07546 
07547 Environment:
07548 
07549     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
07550 
07551 --*/
07552 
07553 {
07554     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
07555     PVOID BaseVa;
07556 <span class="preprocessor">#ifdef LARGE_PAGES</span>
07557 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
07558     PFN_NUMBER PageFrameIndex;
07559     PFN_NUMBER NumberOfPages;
07560     ULONG size;
07561     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> protoPte;
07562     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> largePte;
07563     ULONG pageSize;
07564     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
07565     ULONG Alignment;
07566     ULONG EmPageSize;
07567 <span class="preprocessor">#endif LARGE_PAGES</span>
07568 <span class="preprocessor"></span>    ULONG LargePages;
07569 
07570     LargePages = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07571     PointerPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07572 
07573 <span class="preprocessor">#if defined (i386) &amp;&amp; !defined (_X86PAE_)</span>
07574 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PhysicalAddress.HighPart == 0);
07575 <span class="preprocessor">#endif</span>
07576 <span class="preprocessor"></span>
07577     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07578 
07579     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes != 0);
07580 
07581 <span class="preprocessor">#ifdef LARGE_PAGES</span>
07582 <span class="preprocessor"></span>    NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (PhysicalAddress.LowPart,
07583                                            NumberOfBytes);
07584 
07585     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
07586     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a118">MI_DISABLE_CACHING</a> (TempPte);
07587     PageFrameIndex = (PFN_NUMBER)(PhysicalAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
07588     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
07589 
07590     <span class="keywordflow">if</span> ((NumberOfBytes &gt; <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>) &amp;&amp; (!MmLargeVideoMapped)) {
07591         size = (NumberOfBytes - 1) &gt;&gt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> + 1);
07592         pageSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
07593 
07594         <span class="keywordflow">while</span> (size != 0) {
07595             size = size &gt;&gt; 2;
07596             pageSize = pageSize &lt;&lt; 2;
07597         }
07598 
07599         Alignment = pageSize &lt;&lt; 1;
07600         <span class="keywordflow">if</span> (Alignment &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>) {
07601             Alignment = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>;
07602         }
07603 
07604 <span class="preprocessor">#if defined(_IA64_)</span>
07605 <span class="preprocessor"></span>
07606         <span class="comment">//</span>
07607         <span class="comment">// Convert pageSize to the EM specific page-size field format</span>
07608         <span class="comment">//</span>
07609 
07610         EmPageSize = 0;
07611         size = pageSize - 1 ;
07612 
07613         <span class="keywordflow">while</span> (size) {
07614             size = size &gt;&gt; 1;
07615             EmPageSize += 1;
07616         }
07617 
07618         <span class="keywordflow">if</span> (NumberOfBytes &gt; pageSize) {
07619 
07620             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d2/dataia64_8c.html#a27">MmPageSizeInfo</a> &amp; (pageSize &lt;&lt; 1)) {
07621 
07622                 <span class="comment">//</span>
07623                 <span class="comment">// if larger page size is supported in the implementation</span>
07624                 <span class="comment">//</span>
07625 
07626                 pageSize = pageSize &lt;&lt; 1;
07627                 EmPageSize += 1;
07628 
07629             }
07630             <span class="keywordflow">else</span> {
07631 
07632                 EmPageSize = EmPageSize | pageSize;
07633 
07634             }
07635         }
07636 
07637         pageSize = EmPageSize;
07638 <span class="preprocessor">#endif</span>
07639 <span class="preprocessor"></span>
07640         NumberOfPages = Alignment &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
07641 
07642         PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a>(NumberOfPages,
07643                                          SystemPteSpace,
07644                                          Alignment,
07645                                          0,
07646                                          FALSE);
07647 
07648         <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07649             <span class="keywordflow">goto</span> MapWithSmallPages;
07650         }
07651 
07652         protoPte = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool,
07653                                            <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>),
07654                                            'bSmM');
07655 
07656         <span class="keywordflow">if</span> (protoPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07657             <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a>(PointerPte, NumberOfPages, SystemPteSpace);
07658             <span class="keywordflow">goto</span> MapWithSmallPages;
07659         }
07660 
07661         Subsection = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
07662                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>) + (4 * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)),
07663                                      'bSmM');
07664 
07665         <span class="keywordflow">if</span> (Subsection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07666             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (protoPte);
07667             <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a>(PointerPte, NumberOfPages, SystemPteSpace);
07668             <span class="keywordflow">goto</span> MapWithSmallPages;
07669         }
07670 
07671         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (PointerPte,
07672                          Alignment &gt;&gt; (PAGE_SHIFT - PTE_SHIFT),
07673                          MM_ZERO_KERNEL_PTE);
07674 
07675         <span class="comment">//</span>
07676         <span class="comment">// Build large page descriptor and fill in all the PTEs.</span>
07677         <span class="comment">//</span>
07678 
07679         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o4">StartingSector</a> = pageSize;
07680         Subsection-&gt;EndingSector = (ULONG)NumberOfPages;
07681         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.LongFlags = 0;
07682         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.LargePages = 1;
07683         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a> | <a class="code" href="../../d4/d8/mi_8h.html#a43">MM_NOCACHE</a>;
07684         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> = Alignment;
07685         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a> = PointerPte;
07686 
07687         largePte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(Subsection + 1);
07688 
07689         <span class="comment">//</span>
07690         <span class="comment">// Build the first 2 PTEs as entries for the TLB to</span>
07691         <span class="comment">// map the specified physical address.</span>
07692         <span class="comment">//</span>
07693 
07694         *largePte = TempPte;
07695         largePte += 1;
07696 
07697         <span class="keywordflow">if</span> (NumberOfBytes &gt; pageSize) {
07698             *largePte = TempPte;
07699             largePte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber += (pageSize &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
07700         } <span class="keywordflow">else</span> {
07701             *largePte = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
07702         }
07703 
07704         <span class="comment">//</span>
07705         <span class="comment">// Build the first prototype PTE as a paging file format PTE</span>
07706         <span class="comment">// referring to the subsection.</span>
07707         <span class="comment">//</span>
07708 
07709         protoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a149">MiGetSubsectionAddressForPte</a>(Subsection);
07710         protoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype = 1;
07711         protoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a> | <a class="code" href="../../d4/d8/mi_8h.html#a43">MM_NOCACHE</a>;
07712 
07713         <span class="comment">//</span>
07714         <span class="comment">// Set the PTE up for all the user's PTE entries, proto pte</span>
07715         <span class="comment">// format pointing to the 3rd prototype PTE.</span>
07716         <span class="comment">//</span>
07717 
07718         TempPte.u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (protoPte);
07719         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, 1);
07720         LargePages = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07721         MmLargeVideoMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07722     }
07723 
07724     <span class="keywordflow">if</span> (PointerPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07725         BaseVa = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
07726         BaseVa = (PVOID)((PCHAR)BaseVa + <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(PhysicalAddress.LowPart));
07727 
07728         <span class="keywordflow">do</span> {
07729             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
07730             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
07731             PointerPte += 1;
07732             NumberOfPages -= 1;
07733         } <span class="keywordflow">while</span> (NumberOfPages != 0);
07734     } <span class="keywordflow">else</span> {
07735 
07736 MapWithSmallPages:
07737 
07738 <span class="preprocessor">#endif //LARGE_PAGES</span>
07739 <span class="preprocessor"></span>
07740         BaseVa = <a class="code" href="../../d5/d6/iosup_8c.html#a57">MmMapIoSpace</a> (PhysicalAddress,
07741                                NumberOfBytes,
07742                                CacheType);
07743 <span class="preprocessor">#ifdef LARGE_PAGES</span>
07744 <span class="preprocessor"></span>    }
07745 <span class="preprocessor">#endif //LARGE_PAGES</span>
07746 <span class="preprocessor"></span>
07747     <span class="keywordflow">return</span> BaseVa;
07748 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a317" doxytag="mm.h::MmMapViewInSessionSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS MmMapViewInSessionSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Section</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>MappedBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>ViewSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l03211">3211</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03268">MiMapViewInSystemSpace()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00044">MmSession</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05575">_MM_SESSION_SPACE::Session</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>03219                    :
03220 
03221     This routine maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process's
03222     session address space.
03223 
03224 Arguments:
03225 
03226     Section - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section to map.
03227 
03228     *MappedBase - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section was mapped.
03229 
03230     ViewSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view to map.  If <span class="keyword">this</span>
03231                <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as zero, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> whole section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mapped.
03232                Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual size mapped.
03233 
03234 Return Value:
03235 
03236     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map view operation.
03237 
03238 Environment:
03239 
03240     Kernel Mode, IRQL of dispatch level.
03241 
03242 --*/
03243 
03244 {
03245     <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a>  Session;
03246 
03247     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03248 
03249     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03250         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 0) {
03251             <span class="keywordflow">return</span> STATUS_NOT_MAPPED_VIEW;
03252         }
03253         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(MmSessionSpace) == TRUE);
03254         Session = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o34">Session</a>;
03255     }
03256     <span class="keywordflow">else</span> {
03257         Session = &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>;
03258     }
03259 
03260     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/mapview_8c.html#a13">MiMapViewInSystemSpace</a> (Section,
03261                                    Session,
03262                                    MappedBase,
03263                                    ViewSize);
03264 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a251" doxytag="mm.h::MmMapViewInSystemCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmMapViewInSystemCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionToMap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedViewSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00063">63</a> of file <a class="el" href="../../d2/d4/mapcache_8c-source.html">mapcache.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02001">_SEGMENT::ControlArea</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01527">MiProtoAddressForKernelPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00315">MM_COLOR_MASK</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00108">MM_EMPTY_PTE_LIST</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00047">MmFirstFreeSystemCache</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00051">MmFlushSystemCache</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00050">MmSystemCacheEnd</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00053">MmSystemCachePteBase</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02124">_SUBSECTION::NextSubsection</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02062">_CONTROL_AREA::NumberOfMappedViews</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02060">_CONTROL_AREA::NumberOfSectionReferences</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02073">_CONTROL_AREA::NumberOfSystemCacheViews</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00282">PTE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02058">_CONTROL_AREA::Segment</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/vacbsup_8c-source.html#l00401">CcGetVacbMiss()</a>.
<p>
<pre class="fragment"><div>00072                    :
00073 
00074     This function maps a view in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified subject process to
00075     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object.  The page protection <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> identical to that
00076     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prototype PTE.
00077 
00078     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a kernel mode interface to allow LPC to map
00079     a section given <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section pointer to map.
00080 
00081     This routine assumes all arguments have been probed and captured.
00082 
00083 Arguments:
00084 
00085     SectionToMap - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object.
00086 
00087     BaseAddress - Supplies a pointer to a variable that will receive
00088          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial value
00089          of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not null, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view will
00090          be allocated starting at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span>
00091          address rounded down to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next 64kb address
00092          boundary. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial value of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00093          null, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operating system will determine
00094          where to allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information
00095          specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ZeroBits argument value and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00096          section allocation attributes (i.e. based and
00097          tiled).
00098 
00099     SectionOffset - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> beginning of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00100          section to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view in bytes. This value must be a multiple
00101          of 256k.
00102 
00103     ViewSize - Supplies a pointer to a variable that will receive
00104          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual size in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view.
00105          The initial values of <span class="keyword">this</span> argument specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00106          size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view in bytes and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00107          next host page size boundary and must be less than or equal
00108          to 256k.
00109 
00110 Return Value:
00111 
00112     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
00113 
00114     TBS
00115 
00116 Environment:
00117 
00118     Kernel mode.
00119 
00120 --*/
00121 
00122 {
00123     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> Section;
00124     ULONG PteOffset;
00125     KIRQL OldIrql;
00126     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00127     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00128     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPte;
00129     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastProto;
00130     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00131     PVOID EndingVa;
00132     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00133 
00134     Section = SectionToMap;
00135 
00136     <span class="comment">//</span>
00137     <span class="comment">// Assert the view size is less 256kb and the section offset</span>
00138     <span class="comment">// is aligned on a 256k boundary.</span>
00139     <span class="comment">//</span>
00140 
00141     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (*CapturedViewSize &lt;= 256L*1024L);
00142     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((SectionOffset-&gt;LowPart &amp; (256L*1024L - 1)) == 0);
00143 
00144     <span class="comment">//</span>
00145     <span class="comment">// Make sure the section is not an image section or a page file</span>
00146     <span class="comment">// backed section.</span>
00147     <span class="comment">//</span>
00148 
00149     <span class="keywordflow">if</span> (Section-&gt;u.Flags.Image) {
00150         <span class="keywordflow">return</span> STATUS_NOT_MAPPED_DATA;
00151     }
00152 
00153     ControlArea = Section-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
00154 
00155     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (*CapturedViewSize != 0);
00156 
00157     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0);
00158 
00159     Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
00160 
00161     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00162 
00163     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingCreated == 0);
00164     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted == 0);
00165     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingPurged == 0);
00166 
00167     <span class="comment">//</span>
00168     <span class="comment">// Find a free 256k base in the cache.</span>
00169     <span class="comment">//</span>
00170 
00171     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d5/mapcache_8c.html#a2">MmFirstFreeSystemCache</a> == (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00172         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00173         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00174     }
00175 
00176     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d5/mapcache_8c.html#a2">MmFirstFreeSystemCache</a> == <a class="code" href="../../d1/d5/mapcache_8c.html#a4">MmFlushSystemCache</a>) {
00177 
00178         <span class="comment">//</span>
00179         <span class="comment">// All system cache PTEs have been used, flush the entire</span>
00180         <span class="comment">// TB to remove any stale TB entries.</span>
00181         <span class="comment">//</span>
00182 
00183         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (TRUE, TRUE);
00184         <a class="code" href="../../d1/d5/mapcache_8c.html#a4">MmFlushSystemCache</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00185     }
00186 
00187     PointerPte = <a class="code" href="../../d1/d5/mapcache_8c.html#a2">MmFirstFreeSystemCache</a>;
00188 
00189     <span class="comment">//</span>
00190     <span class="comment">// Update next free entry.</span>
00191     <span class="comment">//</span>
00192 
00193     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
00194 
00195     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>) {
00196         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
00197                       0x778,
00198                       (ULONG_PTR)PointerPte,
00199                       0,
00200                       0);
00201         <a class="code" href="../../d1/d5/mapcache_8c.html#a2">MmFirstFreeSystemCache</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00202     }
00203     <span class="keywordflow">else</span> {
00204         <a class="code" href="../../d1/d5/mapcache_8c.html#a2">MmFirstFreeSystemCache</a> = <a class="code" href="../../d1/d5/mapcache_8c.html#a5">MmSystemCachePteBase</a> + PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry;
00205         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmFirstFreeSystemCache &lt;= MiGetPteAddress (MmSystemCacheEnd));
00206     }
00207 
00208     <span class="comment">//</span>
00209     <span class="comment">// Increment the count of the number of views for the</span>
00210     <span class="comment">// section object.  This requires the PFN lock to be held.</span>
00211     <span class="comment">//</span>
00212 
00213     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> += 1;
00214     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o14">NumberOfSystemCacheViews</a> += 1;
00215     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a> != 0);
00216 
00217     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00218 
00219     *CapturedBase = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00220 
00221     EndingVa = (PVOID)(((ULONG_PTR)*CapturedBase +
00222                                 *CapturedViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
00223 
00224     <span class="comment">//</span>
00225     <span class="comment">// An unoccupied address range has been found, put the PTEs in</span>
00226     <span class="comment">// the range into prototype PTEs.</span>
00227     <span class="comment">//</span>
00228 
00229 <span class="preprocessor">#if DBG</span>
00230 <span class="preprocessor"></span>
00231     <span class="comment">//</span>
00232     <span class="comment">//  Zero out the next pointer field.</span>
00233     <span class="comment">//</span>
00234 
00235     PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = 0;
00236 <span class="preprocessor">#endif //DBG</span>
00237 <span class="preprocessor"></span>
00238     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingVa);
00239 
00240     <span class="comment">//</span>
00241     <span class="comment">// Calculate the first prototype PTE address.</span>
00242     <span class="comment">//</span>
00243 
00244     PteOffset = (ULONG)(SectionOffset-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00245 
00246     <span class="comment">//</span>
00247     <span class="comment">// Make sure the PTEs are not in the extended part of the</span>
00248     <span class="comment">// segment.</span>
00249     <span class="comment">//</span>
00250 
00251     <span class="keywordflow">while</span> (PteOffset &gt;= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>) {
00252         PteOffset -= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
00253         Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00254     }
00255 
00256     ProtoPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset];
00257 
00258     LastProto = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>];
00259 
00260     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00261 
00262         <span class="keywordflow">if</span> (ProtoPte &gt;= LastProto) {
00263 
00264             <span class="comment">//</span>
00265             <span class="comment">// Handle extended subsections.</span>
00266             <span class="comment">//</span>
00267 
00268             Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
00269             ProtoPte = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>;
00270             LastProto = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[
00271                                         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>];
00272         }
00273         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00274         PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a146">MiProtoAddressForKernelPte</a> (ProtoPte);
00275 
00276         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG_PTR)PointerPte &amp; (MM_COLOR_MASK &lt;&lt; PTE_SHIFT)) ==
00277                  (((ULONG_PTR)ProtoPte  &amp; (MM_COLOR_MASK &lt;&lt; PTE_SHIFT))));
00278 
00279         PointerPte += 1;
00280         ProtoPte += 1;
00281     }
00282 
00283     <span class="keywordflow">return</span> STATUS_SUCCESS;
00284 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a315" doxytag="mm.h::MmMapViewInSystemSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS MmMapViewInSystemSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Section</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>MappedBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>ViewSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a241" doxytag="mm.h::MmMapViewOfSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS MmMapViewOfSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionToMap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ZeroBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>CommitSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedViewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECTION_INHERIT&nbsp;</td>
          <td class="mdname" nowrap> <em>InheritDisposition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocationType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Protect</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">753</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l02001">_SEGMENT::ControlArea</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02006">_SEGMENT::ImageCommitment</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01090">LOCK_ADDRESS_SPACE</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00243">MiMakeProtectionMask()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l02256">MiMapViewOfDataSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l01567">MiMapViewOfImageSection()</a>, <a class="el" href="../../d1/d5/alpha_2physsect_8c-source.html#l00043">MiMapViewOfPhysicalSection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02058">_CONTROL_AREA::Segment</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01101">UNLOCK_ADDRESS_SPACE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/ex_8c-source.html#l00278">CommitReadOnlyMemory()</a>, <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l01654">InitMapSharedSection()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l02836">MapDesktop()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04868">MiGetWritablePagesInSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04631">MmCreatePeb()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00911">MmInitializeProcessAddressSpace()</a>, <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l00040">NtAcceptConnectPort()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00199">NtMapViewOfSection()</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00311">NtMapViewOfSuperSection()</a>, <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00679">PspMapSystemDll()</a>, and <a class="el" href="../../d3/d8/w32_2ntuser_2kernel_2heap_8c-source.html#l00189">UserCreateHeap()</a>.
<p>
<pre class="fragment"><div>00768                    :
00769 
00770     This function maps a view in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified subject process to
00771     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object.
00772 
00773     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a kernel mode interface to allow LPC to map
00774     a section given <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section pointer to map.
00775 
00776     This routine assumes all arguments have been probed and captured.
00777 
00778     ********************************************************************
00779     ********************************************************************
00780     ********************************************************************
00781 
00782     NOTE:
00783 
00784     CapturedViewSize, SectionOffset, and CapturedBase must be
00785     captured in non-paged system space (i.e., kernel stack).
00786 
00787     ********************************************************************
00788     ********************************************************************
00789     ********************************************************************
00790 
00791 Arguments:
00792 
00793     SectionToMap - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object.
00794 
00795     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process object.
00796 
00797     BaseAddress - Supplies a pointer to a variable that will receive
00798          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial value
00799          of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not null, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view will
00800          be allocated starting at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span>
00801          address rounded down to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next 64kb address
00802          boundary. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial value of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00803          null, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operating system will determine
00804          where to allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information
00805          specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ZeroBits argument value and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00806          section allocation attributes (i.e. based and
00807          tiled).
00808 
00809     ZeroBits - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of <a class="code" href="../../d2/d3/fetypes_8h.html#a457a417">high</a> order address bits that
00810          must be zero in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section
00811          view. The value of <span class="keyword">this</span> argument must be less than
00812          21 and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> used when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operating system
00813          determines where to allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view (i.e. when
00814          BaseAddress is null).
00815 
00816     CommitSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initially committed region
00817          of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view in bytes. This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded up to
00818          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next host page size boundary.
00819 
00820     SectionOffset - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> beginning of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00821          section to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view in bytes. This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00822          rounded down to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next host page size boundary.
00823 
00824     ViewSize - Supplies a pointer to a variable that will receive
00825          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual size in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value
00826          of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zero, then a view of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00827          section will be mapped starting at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00828          section offset and continuing to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00829          section. Otherwise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial value of <span class="keyword">this</span>
00830          argument specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view in bytes
00831          and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next host page size
00832          boundary.
00833 
00834     InheritDisposition - Supplies a value that specifies how <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00835          view <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be shared by a child process created
00836          with a create process operation.
00837 
00838     AllocationType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of allocation.
00839 
00840     Protect - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection desired <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region of
00841          initially committed pages.
00842 
00843 Return Value:
00844 
00845     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
00846 
00847     TBS
00848 
00849 
00850 --*/
00851 {
00852     BOOLEAN Attached;
00853     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> Section;
00854     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00855     ULONG ProtectionMask;
00856     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00857     BOOLEAN ReleasedWsMutex;
00858     BOOLEAN WriteCombined;
00859     SIZE_T ImageCommitment;
00860 
00861     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00862 
00863     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00864     ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00865 
00866     Section = (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToMap;
00867 
00868     <span class="comment">//</span>
00869     <span class="comment">// Check to make sure the section is not smaller than the view size.</span>
00870     <span class="comment">//</span>
00871 
00872     <span class="keywordflow">if</span> ((LONGLONG)*CapturedViewSize &gt; Section-&gt;SizeOfSection.QuadPart) {
00873         <span class="keywordflow">if</span> ((AllocationType &amp; MEM_RESERVE) == 0) {
00874             <span class="keywordflow">return</span> STATUS_INVALID_VIEW_SIZE;
00875         }
00876     }
00877 
00878     <span class="keywordflow">if</span> (AllocationType &amp; MEM_RESERVE) {
00879         <span class="keywordflow">if</span> (((Section-&gt;InitialPageProtection &amp; PAGE_READWRITE) |
00880             (Section-&gt;InitialPageProtection &amp; PAGE_EXECUTE_READWRITE)) == 0) {
00881 
00882             <span class="keywordflow">return</span> STATUS_SECTION_PROTECTION;
00883         }
00884     }
00885 
00886     <span class="keywordflow">if</span> (Section-&gt;u.Flags.NoCache) {
00887         Protect |= PAGE_NOCACHE;
00888     }
00889 
00890     <span class="comment">//</span>
00891     <span class="comment">// Note that write combining is only relevant to physical memory sections</span>
00892     <span class="comment">// because they are never trimmed - the write combining bits in a PTE entry</span>
00893     <span class="comment">// are not preserved across trims.</span>
00894     <span class="comment">//</span>
00895 
00896     <span class="keywordflow">if</span> (Protect &amp; PAGE_WRITECOMBINE) {
00897         Protect &amp;= ~PAGE_WRITECOMBINE;
00898         WriteCombined = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00899     }
00900     <span class="keywordflow">else</span> {
00901         WriteCombined = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00902     }
00903 
00904     <span class="comment">//</span>
00905     <span class="comment">// Check the protection field.  This could raise an exception.</span>
00906     <span class="comment">//</span>
00907 
00908     <span class="keywordflow">try</span> {
00909         ProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (Protect);
00910     } except (EXCEPTION_EXECUTE_HANDLER) {
00911         <span class="keywordflow">return</span> GetExceptionCode();
00912     }
00913 
00914     ControlArea = Section-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
00915     ImageCommitment = Section-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o5">ImageCommitment</a>;
00916 
00917     <span class="comment">//</span>
00918     <span class="comment">// If the specified process is not the current process, attach</span>
00919     <span class="comment">// to the specified process.</span>
00920     <span class="comment">//</span>
00921 
00922     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != Process) {
00923         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
00924         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00925     }
00926 
00927     <span class="comment">//</span>
00928     <span class="comment">// Get the address creation mutex to block multiple threads</span>
00929     <span class="comment">// creating or deleting address space at the same time.</span>
00930     <span class="comment">//</span>
00931 
00932     <a class="code" href="../../d4/d8/mi_8h.html#a160">LOCK_ADDRESS_SPACE</a> (Process);
00933 
00934     <span class="comment">//</span>
00935     <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
00936     <span class="comment">//</span>
00937 
00938     <span class="keywordflow">if</span> (Process-&gt;AddressSpaceDeleted != 0) {
00939         status = STATUS_PROCESS_IS_TERMINATING;
00940         <span class="keywordflow">goto</span> ErrorReturn;
00941     }
00942 
00943     <span class="comment">//</span>
00944     <span class="comment">// Map the view base on the type.</span>
00945     <span class="comment">//</span>
00946 
00947     ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00948 
00949     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.PhysicalMemory) {
00950 
00951         <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
00952         status = <a class="code" href="../../d4/d8/mi_8h.html#a913">MiMapViewOfPhysicalSection</a> (ControlArea,
00953                                              Process,
00954                                              CapturedBase,
00955                                              SectionOffset,
00956                                              CapturedViewSize,
00957                                              ProtectionMask,
00958                                              ZeroBits,
00959                                              AllocationType,
00960                                              WriteCombined,
00961                                              &amp;ReleasedWsMutex);
00962         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00963 
00964     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image) {
00965         <span class="keywordflow">if</span> (AllocationType &amp; MEM_RESERVE) {
00966             status = STATUS_INVALID_PARAMETER_9;
00967         }
00968         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00969             status = STATUS_INVALID_PARAMETER_10;
00970         } <span class="keywordflow">else</span> {
00971 
00972             status = <a class="code" href="../../d3/d5/mapview_8c.html#a23">MiMapViewOfImageSection</a> (ControlArea,
00973                                               Process,
00974                                               CapturedBase,
00975                                               SectionOffset,
00976                                               CapturedViewSize,
00977                                               Section,
00978                                               InheritDisposition,
00979                                               ZeroBits,
00980                                               ImageCommitment,
00981                                               &amp;ReleasedWsMutex);
00982         }
00983 
00984     } <span class="keywordflow">else</span> {
00985 
00986         <span class="comment">//</span>
00987         <span class="comment">// Not an image section, therefore it is a data section.</span>
00988         <span class="comment">//</span>
00989 
00990         <span class="keywordflow">if</span> (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00991             status = STATUS_INVALID_PARAMETER_10;
00992         }
00993         <span class="keywordflow">else</span> {
00994             status = <a class="code" href="../../d3/d5/mapview_8c.html#a24">MiMapViewOfDataSection</a> (ControlArea,
00995                                          Process,
00996                                          CapturedBase,
00997                                          SectionOffset,
00998                                          CapturedViewSize,
00999                                          Section,
01000                                          InheritDisposition,
01001                                          ProtectionMask,
01002                                          CommitSize,
01003                                          ZeroBits,
01004                                          AllocationType,
01005                                          &amp;ReleasedWsMutex
01006                                         );
01007         }
01008     }
01009 
01010 ErrorReturn:
01011     <span class="keywordflow">if</span> (!ReleasedWsMutex) {
01012         <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
01013     }
01014     <span class="keywordflow">else</span> {
01015         <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (Process);
01016     }
01017 
01018     <span class="keywordflow">if</span> (Attached) {
01019         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01020     }
01021 
01022     <span class="keywordflow">return</span> status;
01023 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a338" doxytag="mm.h::MmMemoryUsage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmMemoryUsage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/dmpaddr_8c-source.html#l00730">730</a> of file <a class="el" href="../../d7/d9/dmpaddr_8c-source.html">dmpaddr.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>.
<p>
<pre class="fragment"><div>00736 {
00737     <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00738 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a218" doxytag="mm.h::MmOutPageKernelStack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmOutPageKernelStack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Thread</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l03180">3180</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00104">KeFlushMultipleTb()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00101">KernelDemandZeroPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d4/d5/procsup_8c.html#a3">MAX_STACK_PAGES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00535">MI_MAKE_VALID_PTE_TRANSITION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02757">MiDecrementShareCountOnly</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00151">MM_KSTACK_OUTSWAPPED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00127">MM_MAXIMUM_FLUSH_COUNT</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00097">MmKernelStackResident</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00544">KiOutSwapKernelStacks()</a>.
<p>
<pre class="fragment"><div>03186                    :
03187 
03188     This routine makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified kernel stack non-resident and
03189     puts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transition list.  Note, that <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03190     CurrentStackPointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first page of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03191     contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second page of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not useful and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03192     page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> freed.
03193 
03194 Arguments:
03195 
03196     Thread - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread whose stack should be
03197              removed.
03198 
03199 Return Value:
03200 
03201     None.
03202 
03203 Environment:
03204 
03205     Kernel mode.
03206 
03207 --*/
03208 
03209 <span class="preprocessor">#if defined(_IA64_)</span>
03210 <span class="preprocessor"></span><span class="preprocessor">#define MAX_STACK_PAGES ((KERNEL_LARGE_STACK_SIZE + KERNEL_LARGE_BSTORE_SIZE) / PAGE_SIZE)</span>
03211 <span class="preprocessor"></span><span class="preprocessor">#else</span>
03212 <span class="preprocessor"></span><span class="preprocessor">#define MAX_STACK_PAGES (KERNEL_LARGE_STACK_SIZE / PAGE_SIZE)</span>
03213 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03214 <span class="preprocessor"></span>
03215 {
03216     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03217     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
03218     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndOfStackPte;
03219     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03220     PFN_NUMBER PageFrameIndex;
03221     KIRQL OldIrql;
03222     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03223     PVOID BaseOfKernelStack;
03224     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FlushPte[<a class="code" href="../../d4/d5/procsup_8c.html#a3">MAX_STACK_PAGES</a>];
03225     PVOID FlushVa[<a class="code" href="../../d4/d5/procsup_8c.html#a3">MAX_STACK_PAGES</a>];
03226     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> FlushPteSave[<a class="code" href="../../d4/d5/procsup_8c.html#a3">MAX_STACK_PAGES</a>];
03227     ULONG StackSize;
03228     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
03229     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LimitPte;
03230     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LowestLivePte;
03231 
03232     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((PCHAR)Thread-&gt;StackBase - (PCHAR)Thread-&gt;StackLimit) &lt;=
03233             (KERNEL_LARGE_STACK_SIZE + PAGE_SIZE));
03234 
03235     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_DISABLE_PAGE_KERNEL_STACKS) {
03236         <span class="keywordflow">return</span>;
03237     }
03238 
03239     <span class="comment">//</span>
03240     <span class="comment">// The first page of the stack is the page before the base</span>
03241     <span class="comment">// of the stack.</span>
03242     <span class="comment">//</span>
03243 
03244     BaseOfKernelStack = ((PCHAR)Thread-&gt;StackBase - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03245     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseOfKernelStack);
03246     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PULONG)Thread-&gt;KernelStack - 1);
03247     <span class="keywordflow">if</span> (Thread-&gt;LargeStack) {
03248         StackSize = KERNEL_LARGE_STACK_SIZE &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03249 
03250         <span class="comment">//</span>
03251         <span class="comment">// The stack pagein won't necessarily bring back all the pages.</span>
03252         <span class="comment">// Make sure that we account now for the ones that will disappear.</span>
03253         <span class="comment">//</span>
03254 
03255         LimitPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Thread-&gt;StackLimit);
03256 
03257         LowestLivePte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PVOID)((PUCHAR)Thread-&gt;InitialStack -
03258                                             KERNEL_LARGE_STACK_COMMIT));
03259 
03260         <span class="keywordflow">if</span> (LowestLivePte &lt; LimitPte) {
03261             LowestLivePte = LimitPte;
03262         }
03263     } <span class="keywordflow">else</span> {
03264         StackSize = KERNEL_STACK_SIZE &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03265         LowestLivePte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Thread-&gt;StackLimit);
03266     }
03267     EndOfStackPte = PointerPte - StackSize;
03268 
03269     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LowestLivePte &lt;= LastPte);
03270 
03271     <span class="comment">//</span>
03272     <span class="comment">// Put a signature at the current stack location - 4.</span>
03273     <span class="comment">//</span>
03274 
03275     *((PULONG_PTR)Thread-&gt;KernelStack - 1) = (ULONG_PTR)Thread;
03276 
03277     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
03278 
03279     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03280 
03281     <span class="keywordflow">do</span> {
03282         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
03283         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
03284         TempPte = *PointerPte;
03285         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte, 0);
03286 
03287 <span class="preprocessor">#ifdef PROTECT_KSTACKS</span>
03288 <span class="preprocessor"></span>        TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>;
03289         {
03290             <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> x;
03291             x = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
03292             x-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>;
03293         }
03294 <span class="preprocessor">#endif</span>
03295 <span class="preprocessor"></span>
03296         FlushPteSave[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = TempPte;
03297         FlushPte[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = PointerPte;
03298         FlushVa[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = BaseOfKernelStack;
03299 
03300         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (PageFrameIndex);
03301         PointerPte -= 1;
03302         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
03303         BaseOfKernelStack = ((PCHAR)BaseOfKernelStack - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03304     } <span class="keywordflow">while</span> (PointerPte &gt;= LastPte);
03305 
03306     <span class="keywordflow">while</span> (PointerPte != EndOfStackPte) {
03307         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03308             <span class="keywordflow">break</span>;
03309         }
03310 
03311         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
03312         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03313         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
03314         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
03315         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPte));
03316 
03317         FlushPteSave[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = <a class="code" href="../../d4/d5/procsup_8c.html#a14">KernelDemandZeroPte</a>;
03318 
03319 <span class="preprocessor">#ifdef PROTECT_KSTACKS</span>
03320 <span class="preprocessor"></span>        FlushPteSave[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>;
03321 <span class="preprocessor">#endif</span>
03322 <span class="preprocessor"></span>
03323         FlushPte[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = PointerPte;
03324 
03325         FlushVa[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = BaseOfKernelStack;
03326         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
03327 
03328         <span class="comment">//</span>
03329         <span class="comment">// Account for any pages that won't ever come back in.</span>
03330         <span class="comment">//</span>
03331 
03332         <span class="keywordflow">if</span> (PointerPte &lt; LowestLivePte) {
03333             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Thread-&gt;LargeStack);
03334             <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += 1;
03335             <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(12, 1);
03336         }
03337 
03338         PointerPte -= 1;
03339         BaseOfKernelStack = ((PCHAR)BaseOfKernelStack - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03340     }
03341 
03342 <span class="preprocessor">#if defined(_IA64_)</span>
03343 <span class="preprocessor"></span>    <span class="comment">//</span>
03344     <span class="comment">// do for RSE stack space too.</span>
03345     <span class="comment">//</span>
03346 
03347     BaseOfKernelStack = Thread-&gt;StackBase;
03348     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseOfKernelStack);
03349     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PULONG)Thread-&gt;KernelBStore);
03350 
03351     <span class="keywordflow">if</span> (Thread-&gt;LargeStack) {
03352         StackSize = KERNEL_LARGE_BSTORE_SIZE &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03353     } <span class="keywordflow">else</span> {
03354         StackSize = KERNEL_BSTORE_SIZE &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03355     }
03356     EndOfStackPte = PointerPte + StackSize;
03357 
03358     <span class="keywordflow">do</span> {
03359         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
03360         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
03361         TempPte = *PointerPte;
03362         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte, 0);
03363 
03364 <span class="preprocessor">#ifdef PROTECT_KSTACKS</span>
03365 <span class="preprocessor"></span>        TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>;
03366         {
03367             <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> x;
03368             x = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
03369             x-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>;
03370         }
03371 <span class="preprocessor">#endif</span>
03372 <span class="preprocessor"></span>
03373         FlushPteSave[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = TempPte;
03374         FlushPte[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = PointerPte;
03375         FlushVa[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = BaseOfKernelStack;
03376 
03377         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (PageFrameIndex);
03378         PointerPte += 1;
03379         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
03380         BaseOfKernelStack = ((PCHAR)BaseOfKernelStack + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03381     } <span class="keywordflow">while</span> (PointerPte &lt;= LastPte);
03382 
03383     <span class="keywordflow">while</span> (PointerPte != EndOfStackPte) {
03384         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03385             <span class="keywordflow">break</span>;
03386         }
03387 
03388         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
03389         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03390         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
03391         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
03392         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPte));
03393 
03394         FlushPteSave[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = <a class="code" href="../../d4/d5/procsup_8c.html#a14">KernelDemandZeroPte</a>;
03395 
03396 <span class="preprocessor">#ifdef PROTECT_KSTACKS</span>
03397 <span class="preprocessor"></span>        FlushPteSave[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>;
03398 <span class="preprocessor">#endif</span>
03399 <span class="preprocessor"></span>
03400         FlushPte[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = PointerPte;
03401         FlushVa[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = BaseOfKernelStack;
03402         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
03403 
03404         PointerPte += 1;
03405         BaseOfKernelStack = ((PCHAR)BaseOfKernelStack + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03406     }
03407 
03408 <span class="preprocessor">#endif // _IA64_</span>
03409 <span class="preprocessor"></span>
03410     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Count &lt;= MAX_STACK_PAGES);
03411 
03412     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
03413         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a1">KeFlushMultipleTb</a> (Count,
03414                            &amp;FlushVa[0],
03415                            TRUE,
03416                            TRUE,
03417                            &amp;((PHARDWARE_PTE)FlushPte[0]),
03418                            <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
03419     } <span class="keywordflow">else</span> {
03420         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (TRUE, TRUE);
03421     }
03422 
03423     <span class="comment">//</span>
03424     <span class="comment">// Increase the available pages by the number of pages that where</span>
03425     <span class="comment">// deleted and turned into demand zero.</span>
03426     <span class="comment">//</span>
03427 
03428     <a class="code" href="../../d4/d5/procsup_8c.html#a11">MmKernelStackResident</a> -= <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
03429 
03430     <span class="comment">//</span>
03431     <span class="comment">// Put the right contents back into the PTEs</span>
03432     <span class="comment">//</span>
03433 
03434     <span class="keywordflow">do</span> {
03435         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> -= 1;
03436         *FlushPte[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = FlushPteSave[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>];
03437     } <span class="keywordflow">while</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != 0);
03438 
03439 
03440     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03441     <span class="keywordflow">return</span>;
03442 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a220" doxytag="mm.h::MmOutSwapProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmOutSwapProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l03590">3590</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00066">_MMSUPPORT::AllowWorkingSetAdjustment</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00705">_KPROCESS::DirectoryTableBase</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02287">MI_CONVERT_PHYSICAL_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00535">MI_MAKE_VALID_PTE_TRANSITION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01722">MiGetPdeOffset</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01698">MiGetPpeOffset</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01769">MiGetPteOffset</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00032">MiMapPageInHyperSpace()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l02551">MiSessionOutSwapProcess()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02922">MiUnmapPageInHyperSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00185">MM_DBG_SWAP_PROCESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00102">MM_IO_IN_PROGRESS</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00042">MM_PROCESS_COMMIT_CHARGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00101">MM_WS_SWAPPED_OUT</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00224">_EPROCESS::PaeTop</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00269">_EPROCESS::PageDirectoryPte</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02433">PMMPTE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00213">_EPROCESS::ProcessOutswapEnabled</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00214">_EPROCESS::ProcessOutswapped</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00065">_MMSUPPORT::WorkingSetExpansionLinks</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00212">_EPROCESS::WorkingSetPage</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00644">KiOutSwapProcesses()</a>.
<p>
<pre class="fragment"><div>03596                    :
03597 
03598     This routine <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> swaps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process.
03599 
03600 Arguments:
03601 
03602     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> swapped <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of memory.
03603 
03604 Return Value:
03605 
03606     None.
03607 
03608 --*/
03609 
03610 {
03611     KIRQL OldIrql;
03612     KIRQL OldIrql2;
03613     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> OutProcess;
03614     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03615     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03616     PFN_NUMBER HyperSpacePageTable;
03617     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> HyperSpacePageTableMap;
03618     PFN_NUMBER PpePage;
03619     PFN_NUMBER PdePage;
03620     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PageDirectoryMap;
03621     PFN_NUMBER ProcessPage;
03622     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03623 <span class="preprocessor">#if defined (_X86PAE_)</span>
03624 <span class="preprocessor"></span>    ULONG i;
03625     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte2;
03626     PFN_NUMBER PdePage2;
03627     PFN_NUMBER HyperPage2;
03628     PPAE_ENTRY PaeVa;
03629 <span class="preprocessor">#endif</span>
03630 <span class="preprocessor"></span>
03631     OutProcess = CONTAINING_RECORD (Process, <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>, Pcb);
03632 
03633     OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03634 
03635 <span class="preprocessor">#if DBG</span>
03636 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a77">MM_DBG_SWAP_PROCESS</a>) != 0) {
03637         <span class="keywordflow">return</span>;
03638     }
03639 <span class="preprocessor">#endif //DBG</span>
03640 <span class="preprocessor"></span>
03641     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession == 1) {
03642         <a class="code" href="../../d3/d7/session_8c.html#a19">MiSessionOutSwapProcess</a> (OutProcess);
03643     }
03644 
03645     <span class="keywordflow">if</span> ((OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> == <a class="code" href="../../d4/d5/procsup_8c.html#a0">MM_PROCESS_COMMIT_CHARGE</a>) &amp;&amp;
03646         (OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a>)) {
03647 
03648         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
03649 
03650         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o25">ProcessOutswapped</a> == FALSE);
03651 
03652         <span class="keywordflow">if</span> (OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03653 
03654             <span class="comment">//</span>
03655             <span class="comment">// An outswap is not allowed at this point because the process</span>
03656             <span class="comment">// has been attached to and is being trimmed.</span>
03657             <span class="comment">//</span>
03658 
03659             <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
03660             <span class="keywordflow">return</span>;
03661         }
03662 
03663         <span class="comment">//</span>
03664         <span class="comment">// Swap the process working set info and page parent/directory/table</span>
03665         <span class="comment">// pages from memory.</span>
03666         <span class="comment">//</span>
03667 
03668         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o25">ProcessOutswapped</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03669 
03670         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
03671 
03672         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03673 
03674         <span class="comment">//</span>
03675         <span class="comment">// Remove the working set list page from the process.</span>
03676         <span class="comment">//</span>
03677 
03678 <span class="preprocessor">#if !defined (_X86PAE_)</span>
03679 <span class="preprocessor"></span>        HyperSpacePageTable =
03680              <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(&amp;(OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o2">DirectoryTableBase</a>[1])));
03681 <span class="preprocessor">#else</span>
03682 <span class="preprocessor"></span>        HyperSpacePageTable = (PFN_NUMBER)OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o2">DirectoryTableBase</a>[1];
03683 <span class="preprocessor">#endif</span>
03684 <span class="preprocessor"></span>
03685         HyperSpacePageTableMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (HyperSpacePageTable, &amp;OldIrql2);
03686 
03687         TempPte = HyperSpacePageTableMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a158">MiGetPteOffset</a>(MmWorkingSetList)];
03688 
03689         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
03690                                       MM_READWRITE);
03691 
03692         HyperSpacePageTableMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a158">MiGetPteOffset</a>(MmWorkingSetList)] = TempPte;
03693 
03694 <span class="preprocessor">#if defined (_X86PAE_)</span>
03695 <span class="preprocessor"></span>        TempPte2 = HyperSpacePageTableMap[0];
03696 
03697         HyperPage2 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)&amp;TempPte2);
03698 
03699         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte2,
03700                                       MM_READWRITE);
03701 
03702         HyperSpacePageTableMap[0] = TempPte2;
03703 <span class="preprocessor">#endif</span>
03704 <span class="preprocessor"></span>
03705         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
03706 
03707 <span class="preprocessor">#if DBG</span>
03708 <span class="preprocessor"></span>        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o23">WorkingSetPage</a>);
03709         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1);
03710 <span class="preprocessor">#endif</span>
03711 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o23">WorkingSetPage</a>);
03712 
03713         <span class="comment">//</span>
03714         <span class="comment">// Remove the hyper space page from the process.</span>
03715         <span class="comment">//</span>
03716 
03717         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (HyperSpacePageTable);
03718         PdePage = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>;
03719         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PdePage);
03720 
03721         PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PdePage, &amp;OldIrql2);
03722 
03723         TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmWorkingSetList)];
03724 
03725         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.u.Hard.Valid == 1);
03726         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.u.Hard.PageFrameNumber == HyperSpacePageTable);
03727 
03728         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
03729                                       MM_READWRITE);
03730 
03731         PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(MmWorkingSetList)] = TempPte;
03732 
03733         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1);
03734 
03735         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (HyperSpacePageTable);
03736 
03737 <span class="preprocessor">#if defined (_X86PAE_)</span>
03738 <span class="preprocessor"></span>
03739         <span class="comment">//</span>
03740         <span class="comment">// Remove the second hyper space page from the process.</span>
03741         <span class="comment">//</span>
03742 
03743         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (HyperPage2);
03744 
03745         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1);
03746 
03747         PdePage = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>;
03748         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PdePage);
03749 
03750         PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(HYPER_SPACE2)] = TempPte2;
03751 
03752         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (HyperPage2);
03753 
03754         <span class="comment">//</span>
03755         <span class="comment">// Remove the additional page directory pages.</span>
03756         <span class="comment">//</span>
03757 
03758         PaeVa = (PPAE_ENTRY)OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o35">PaeTop</a>;
03759         <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM - 1; i += 1) {
03760     
03761             TempPte = PageDirectoryMap[i];
03762             PdePage2 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)&amp;TempPte);
03763     
03764             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
03765                                           MM_READWRITE);
03766     
03767             PageDirectoryMap[i] = TempPte;
03768             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PdePage2);
03769             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1);
03770 
03771             <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (PdePage2);
03772             PaeVa-&gt;PteEntry[i].u.Long = TempPte.u.Long;
03773         }
03774 
03775 <span class="preprocessor">#if DBG</span>
03776 <span class="preprocessor"></span>        TempPte = PageDirectoryMap[i];
03777         PdePage2 = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)&amp;TempPte);
03778         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PdePage2);
03779         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1);
03780 <span class="preprocessor">#endif</span>
03781 <span class="preprocessor"></span>
03782 <span class="preprocessor">#endif</span>
03783 <span class="preprocessor"></span>
03784 <span class="preprocessor">#if defined (_WIN64)</span>
03785 <span class="preprocessor"></span>
03786         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
03787 
03788         <span class="comment">//</span>
03789         <span class="comment">// Remove the page directory page (64-bit version).</span>
03790         <span class="comment">//</span>
03791 
03792         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PdePage);
03793         PpePage = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>;
03794         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PpePage);
03795         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PpePage == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a>((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(&amp;(OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o2">DirectoryTableBase</a>[0]))));
03796 
03797         PageDirectoryMap = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (PpePage, &amp;OldIrql2);
03798 
03799         TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(MmWorkingSetList)];
03800 
03801         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.u.Hard.Valid == 1);
03802         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.u.Hard.PageFrameNumber == PdePage);
03803 
03804         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
03805                                       MM_READWRITE);
03806 
03807         PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(MmWorkingSetList)] = TempPte;
03808 
03809         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1);
03810 
03811         <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (HyperSpacePageTable);
03812 
03813         <span class="comment">//</span>
03814         <span class="comment">// Remove the top level page directory parent page.</span>
03815         <span class="comment">//</span>
03816 
03817         TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(PDE_TBASE)];
03818 
03819         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
03820                                       MM_READWRITE);
03821 
03822         PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a155">MiGetPpeOffset</a>(PDE_TBASE)] = TempPte;
03823 
03824         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PpePage);
03825 
03826 <span class="preprocessor">#else</span>
03827 <span class="preprocessor"></span>
03828         <span class="comment">//</span>
03829         <span class="comment">// Remove the top level page directory page.</span>
03830         <span class="comment">//</span>
03831 
03832         TempPte = PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(PDE_BASE)];
03833 
03834         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
03835                                       MM_READWRITE);
03836 
03837         PageDirectoryMap[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a156">MiGetPdeOffset</a>(PDE_BASE)] = TempPte;
03838 
03839         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PdePage);
03840 
03841 <span class="preprocessor">#endif</span>
03842 <span class="preprocessor"></span>
03843         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql2);
03844 
03845         <span class="comment">//</span>
03846         <span class="comment">// Decrement share count so the top level page directory page gets</span>
03847         <span class="comment">// removed.  This can cause the PteCount to equal the sharecount as the</span>
03848         <span class="comment">// page directory page no longer contains itself, yet can have</span>
03849         <span class="comment">// itself as a transition page.</span>
03850         <span class="comment">//</span>
03851 
03852         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount -= 2;
03853         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a214">PMMPTE</a>)&amp;OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o62">PageDirectoryPte</a>;
03854 
03855         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o62">PageDirectoryPte</a> = TempPte.u.Flush;
03856 
03857 <span class="preprocessor">#if defined (_X86PAE_)</span>
03858 <span class="preprocessor"></span>        PaeVa-&gt;PteEntry[i].u.Long = TempPte.u.Long;
03859 <span class="preprocessor">#endif</span>
03860 <span class="preprocessor"></span>
03861         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(OutProcess)) {
03862             ProcessPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (OutProcess);
03863         } <span class="keywordflow">else</span> {
03864             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (OutProcess);
03865             ProcessPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
03866         }
03867 
03868         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = ProcessPage;
03869         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (ProcessPage);
03870 
03871         <span class="comment">//</span>
03872         <span class="comment">// Increment the share count for the process page.</span>
03873         <span class="comment">//</span>
03874 
03875         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
03876         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03877 
03878         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
03879         <span class="keywordflow">if</span> (OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink &gt;
03880                                                        <a class="code" href="../../d4/d8/mi_8h.html#a23">MM_IO_IN_PROGRESS</a>) {
03881 
03882             <span class="comment">//</span>
03883             <span class="comment">// The entry must be on the list.</span>
03884             <span class="comment">//</span>
03885             RemoveEntryList (&amp;OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
03886             OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a22">MM_WS_SWAPPED_OUT</a>;
03887         }
03888         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
03889 
03890         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o23">WorkingSetPage</a> = 0;
03891         OutProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> = 0;
03892 <span class="preprocessor">#if defined(_IA64_)</span>
03893 <span class="preprocessor"></span>
03894         <span class="comment">//</span>
03895         <span class="comment">// Force assignment of new PID as we have removed</span>
03896         <span class="comment">// the page directory page.</span>
03897         <span class="comment">// Note that a TB flush would not work here as we</span>
03898         <span class="comment">// are in the wrong process context.</span>
03899         <span class="comment">//</span>
03900 
03901         Process-&gt;ProcessRegion.SequenceNumber = 0;
03902 <span class="preprocessor">#endif _IA64_</span>
03903 <span class="preprocessor"></span>
03904     }
03905 
03906     <span class="keywordflow">return</span>;
03907 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a311" doxytag="mm.h::MmPageEntireDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI PVOID MmPageEntireDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>AddressWithinSection</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l02472">2472</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05287">MI_IS_SESSION_IMAGE_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06991">MiLookupDataTableEntry()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02309">MiSetPagingOfDriver()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00082">MmDisablePagingExecutive</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00067">DriverEntry()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, and <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>.
<p>
<pre class="fragment"><div>02478                    :
02479 
02480     This routine allows a driver to page <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> all of its code and
02481     data regardless of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> various image sections.
02482 
02483     Note, <span class="keyword">this</span> routine can be called multiple times with no
02484     intervening calls to <a class="code" href="../../d2/d1/mm_8h.html#a310">MmResetDriverPaging</a>.
02485 
02486 Arguments:
02487 
02488     AddressWithinSection - Supplies an address within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver, e.g.
02489                            <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>.
02490 
02491 Return Value:
02492 
02493     Base address of driver.
02494 
02495 Environment:
02496 
02497     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
02498 
02499 --*/
02500 
02501 {
02502     PLDR_DATA_TABLE_ENTRY DataTableEntry;
02503     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPte;
02504     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02505     PVOID BaseAddress;
02506     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> SectionPointer;
02507     BOOLEAN SessionSpace;
02508 
02509     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02510 
02511     <span class="comment">//</span>
02512     <span class="comment">// Don't page kernel mode code if disabled via registry.</span>
02513     <span class="comment">//</span>
02514 
02515     DataTableEntry = <a class="code" href="../../d4/d8/mi_8h.html#a874">MiLookupDataTableEntry</a> (AddressWithinSection, FALSE);
02516 
02517     <span class="keywordflow">if</span> (DataTableEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02518         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02519     }
02520 
02521     SectionPointer = (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)DataTableEntry-&gt;SectionPointer;
02522 
02523     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a26">MmDisablePagingExecutive</a>) {
02524         <span class="keywordflow">return</span> DataTableEntry-&gt;DllBase;
02525     }
02526 
02527     SessionSpace = <a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (AddressWithinSection);
02528 
02529     <span class="keywordflow">if</span> ((SectionPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (SectionPointer != (PVOID)-1)) {
02530 
02531         <span class="comment">//</span>
02532         <span class="comment">// Driver is mapped as an image (ie: win32k), this is always pagable.</span>
02533         <span class="comment">// For session space, an image that has been loaded at its desired</span>
02534         <span class="comment">// address is also always pagable.  If there was an address collision,</span>
02535         <span class="comment">// then we fall through because we have to explicitly page it.</span>
02536         <span class="comment">//</span>
02537 
02538         <span class="keywordflow">if</span> (SessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02539             <span class="keywordflow">if</span> (SectionPointer-&gt;Segment &amp;&amp;
02540                 SectionPointer-&gt;Segment-&gt;BasedAddress == SectionPointer-&gt;Segment-&gt;SystemImageBase) {
02541                 <span class="keywordflow">return</span> DataTableEntry-&gt;DllBase;
02542             }
02543         }
02544         <span class="keywordflow">else</span> {
02545             <span class="keywordflow">return</span> DataTableEntry-&gt;DllBase;
02546         }
02547     }
02548 
02549     BaseAddress = DataTableEntry-&gt;DllBase;
02550     FirstPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
02551     LastPte = (FirstPte - 1) + (DataTableEntry-&gt;SizeOfImage &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02552 
02553     <a class="code" href="../../d8/d8/sysload_8c.html#a35">MiSetPagingOfDriver</a> (FirstPte, LastPte, SessionSpace);
02554 
02555     <span class="keywordflow">return</span> BaseAddress;
02556 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a273" doxytag="mm.h::MmProbeAndLockPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmProbeAndLockPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Operation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">238</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00217">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02429">_MI_PHYSICAL_VIEW::EndVa</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00056">failure</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00435">MDL_IO_SPACE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00428">MDL_PARTIAL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00434">MDL_PHYSICAL_VIEW</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00426">MDL_SOURCE_IS_NONPAGED_POOL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00431">MDL_WRITE_OPERATION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01417">MI_ADD_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02287">MI_CONVERT_PHYSICAL_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00225">MI_INSTRUMENT_PROBE_RAISES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02717">MI_IS_SYSTEM_CACHE_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04360">MI_NONPAGABLE_MEMORY_AVAILABLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00879">MiAddMdlTracker()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01921">MiIsPteOnPpeBoundary</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00374">MM_PTE_WRITE_MASK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04668">MmLockPagesLimit</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00234">MmReferenceCountCheck</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01053">MmResetPageFaultReadAhead</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00983">MmSavePageFaultReadAhead</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01018">MmSetPageFaultReadAhead</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00026">MmSystemLockPagesCount</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00089">MmTrackLockedPages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01347">MmUnlockPages()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00231">_EPROCESS::NumberOfLockedPages</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00267">_EPROCESS::PhysicalVadList</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01464">ProbeForWriteChar</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02428">_MI_PHYSICAL_VIEW::StartVa</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l02427">_MI_PHYSICAL_VIEW::Vad</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">BuildQueryDirectoryIrp()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00030">CcMdlRead()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00466">CcPrepareMdlWrite()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02995">ExLockUserBuffer()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01360">IoBuildAsynchronousFsdRequest()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">IopSetEaOrQuotaInformationFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00529">MiDoMappedCopy()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00890">MiGetWorkingSetInfo()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00813">MmProbeAndLockProcessPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01152">MmProbeAndLockSelectedPages()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00821">NtNotifyChangeDirectoryFile()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00035">NtQueryEaFile()</a>, <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00652">NtSetEaFile()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00474">UdfCreateUserMdl()</a>, <a class="el" href="../../d4/d3/vdm_2vdm_8c-source.html#l00087">VdmQueryDirectoryFile()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l00537">VerifierProbeAndLockPages()</a>.
<p>
<pre class="fragment"><div>00246                    :
00247 
00248     This routine probes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified pages, makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages resident and
00249     locks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical pages mapped by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> pages in memory.  The
00250     Memory descriptor list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> updated to describe <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical pages.
00251 
00252 Arguments:
00253 
00254     MemoryDescriptorList - Supplies a pointer to a Memory Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>
00255                             (<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>). The supplied <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> must supply a <span class="keyword">virtual</span>
00256                             address, byte offset and length field.  The
00257                             physical page portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> updated when
00258                             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are locked in memory.
00259 
00260     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access mode in which to probe <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arguments.
00261                  One of <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> or <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
00262 
00263     Operation - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.  One of <a class="code" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>, <a class="code" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a>
00264                 or <a class="code" href="../../d2/d1/mm_8h.html#a344a170">IoModifyAccess</a>.
00265 
00266 Return Value:
00267 
00268     None - exceptions are raised.
00269 
00270 Environment:
00271 
00272     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> and below <span class="keywordflow">for</span> pagable addresses,
00273                   <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> and below <span class="keywordflow">for</span> non-pagable addresses.
00274 
00275 --*/
00276 
00277 {
00278     PPFN_NUMBER Page;
00279     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00280     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00281     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00282     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00283     PVOID Va;
00284     PVOID EndVa;
00285     PVOID AlignedVa;
00286     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00287     PFN_NUMBER PageFrameIndex;
00288     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00289     KIRQL OldIrql;
00290     PFN_NUMBER NumberOfPagesToLock;
00291     PFN_NUMBER NumberOfPagesSpanned;
00292     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00293     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ProbeStatus;
00294     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00295     ULONG SavedState;
00296     LOGICAL AddressIsPhysical;
00297     PLIST_ENTRY NextEntry;
00298     <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a> PhysicalView;
00299     PCHAR StartVa;
00300     PVOID CallingAddress;
00301     PVOID CallersCaller;
00302 
00303 <span class="preprocessor">#if !defined (_X86_)</span>
00304 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
00305     CallersCaller = (PVOID)0;
00306 <span class="preprocessor">#endif</span>
00307 <span class="preprocessor"></span>
00308 <span class="preprocessor">#if DBG</span>
00309 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MiPrintLockedPages != 0) {
00310         MiVerifyLockedPageCharges ();
00311     }
00312 <span class="preprocessor">#endif</span>
00313 <span class="preprocessor"></span>
00314     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MemoryDescriptorList-&gt;ByteCount != 0);
00315     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG)MemoryDescriptorList-&gt;ByteOffset &amp; ~(PAGE_SIZE - 1)) == 0);
00316 
00317     Page = (PPFN_NUMBER)(MemoryDescriptorList + 1);
00318 
00319     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG_PTR)MemoryDescriptorList-&gt;StartVa &amp; (PAGE_SIZE - 1)) == 0);
00320     AlignedVa = (PVOID)MemoryDescriptorList-&gt;StartVa;
00321 
00322     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; (
00323                     MDL_PAGES_LOCKED |
00324                     MDL_MAPPED_TO_SYSTEM_VA |
00325                     MDL_SOURCE_IS_NONPAGED_POOL |
00326                     MDL_PARTIAL |
00327                     MDL_IO_SPACE)) == 0);
00328 
00329     Va = (PCHAR)AlignedVa + MemoryDescriptorList-&gt;ByteOffset;
00330     StartVa = Va;
00331 
00332     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Va);
00333 
00334     <span class="comment">//</span>
00335     <span class="comment">// Endva is one byte past the end of the buffer, if ACCESS_MODE is not</span>
00336     <span class="comment">// kernel, make sure the EndVa is in user space AND the byte count</span>
00337     <span class="comment">// does not cause it to wrap.</span>
00338     <span class="comment">//</span>
00339 
00340     EndVa = (PVOID)((PCHAR)Va + MemoryDescriptorList-&gt;ByteCount);
00341 
00342     <span class="keywordflow">if</span> ((AccessMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;
00343         ((EndVa &gt; (PVOID)MM_USER_PROBE_ADDRESS) || (Va &gt;= EndVa))) {
00344         *Page = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00345         <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(0);
00346         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_ACCESS_VIOLATION);
00347         <span class="keywordflow">return</span>;
00348     }
00349 
00350     <span class="comment">//</span>
00351     <span class="comment">// There is an optimization which could be performed here.  If</span>
00352     <span class="comment">// the operation is for WriteAccess and the complete page is</span>
00353     <span class="comment">// being modified, we can remove the current page, if it is not</span>
00354     <span class="comment">// resident, and substitute a demand zero page.</span>
00355     <span class="comment">// Note, that after analysis by marking the thread and then</span>
00356     <span class="comment">// noting if a page read was done, this rarely occurs.</span>
00357     <span class="comment">//</span>
00358 
00359     MemoryDescriptorList-&gt;Process = (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00360 
00361     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
00362 
00363     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(Va)) {
00364 
00365         AddressIsPhysical = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00366         ProbeStatus = STATUS_SUCCESS;
00367 
00368         NumberOfPagesToLock = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (Va,
00369                                        MemoryDescriptorList-&gt;ByteCount);
00370 
00371         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPagesToLock != 0);
00372 
00373         NumberOfPagesSpanned = NumberOfPagesToLock;
00374 
00375         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (Va);
00376         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (Va);
00377 
00378         <a class="code" href="../../d2/d1/mm_8h.html#a19">MmSavePageFaultReadAhead</a> (Thread, &amp;SavedState);
00379         <a class="code" href="../../d2/d1/mm_8h.html#a20">MmSetPageFaultReadAhead</a> (Thread, (ULONG)(NumberOfPagesToLock - 1));
00380 
00381         <span class="keywordflow">try</span> {
00382 
00383             <span class="keywordflow">do</span> {
00384 
00385                 *Page = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00386 
00387                 <span class="comment">//</span>
00388                 <span class="comment">// Make sure the page is resident.</span>
00389                 <span class="comment">//</span>
00390 
00391                 *(<span class="keyword">volatile</span> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> *)Va;
00392 
00393                 <span class="keywordflow">if</span> ((Operation != <a class="code" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>) &amp;&amp;
00394                     (Va &lt;= MM_HIGHEST_USER_ADDRESS)) {
00395 
00396                     <span class="comment">//</span>
00397                     <span class="comment">// Probe for write access as well.</span>
00398                     <span class="comment">//</span>
00399 
00400                     <a class="code" href="../../d5/d8/ex_8h.html#a29">ProbeForWriteChar</a> ((PCHAR)Va);
00401                 }
00402 
00403                 NumberOfPagesToLock -= 1;
00404 
00405                 <a class="code" href="../../d2/d1/mm_8h.html#a20">MmSetPageFaultReadAhead</a> (Thread, (ULONG)(NumberOfPagesToLock - 1));
00406                 Va = (PVOID)(((ULONG_PTR)(PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
00407                 Page += 1;
00408             } <span class="keywordflow">while</span> (Va &lt; EndVa);
00409 
00410             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPagesToLock == 0);
00411 
00412         } except (EXCEPTION_EXECUTE_HANDLER) {
00413             ProbeStatus = GetExceptionCode();
00414         }
00415 
00416         <span class="comment">//</span>
00417         <span class="comment">// We may still fault again below but it's generally rare.</span>
00418         <span class="comment">// Restore this thread's normal fault behavior now.</span>
00419         <span class="comment">//</span>
00420 
00421         <a class="code" href="../../d2/d1/mm_8h.html#a21">MmResetPageFaultReadAhead</a> (Thread, SavedState);
00422 
00423         <span class="keywordflow">if</span> (ProbeStatus != STATUS_SUCCESS) {
00424             <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(1);
00425             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (ProbeStatus);
00426             <span class="keywordflow">return</span>;
00427         }
00428     }
00429     <span class="keywordflow">else</span> {
00430         AddressIsPhysical = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00431         *Page = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00432     }
00433 
00434     Va = AlignedVa;
00435     Page = (PPFN_NUMBER)(MemoryDescriptorList + 1);
00436 
00437     <span class="comment">//</span>
00438     <span class="comment">// Indicate that this is a write operation.</span>
00439     <span class="comment">//</span>
00440 
00441     <span class="keywordflow">if</span> (Operation != <a class="code" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>) {
00442         MemoryDescriptorList-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a19">MDL_WRITE_OPERATION</a>;
00443     } <span class="keywordflow">else</span> {
00444         MemoryDescriptorList-&gt;MdlFlags &amp;= ~(<a class="code" href="../../d0/d9/ntosdef_8h.html#a19">MDL_WRITE_OPERATION</a>);
00445     }
00446 
00447     <span class="comment">//</span>
00448     <span class="comment">// Acquire the PFN database lock.</span>
00449     <span class="comment">//</span>
00450 
00451     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
00452 
00453     <span class="keywordflow">if</span> (Va &lt;= MM_HIGHEST_USER_ADDRESS) {
00454 
00455         <span class="comment">//</span>
00456         <span class="comment">// These are addresses with user space, check to see if the</span>
00457         <span class="comment">// working set size will allow these pages to be locked.</span>
00458         <span class="comment">//</span>
00459 
00460         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPagesSpanned != 0);
00461 
00462         CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
00463 
00464         <span class="comment">//</span>
00465         <span class="comment">// Check for a transfer to/from a physical VAD - no reference counts</span>
00466         <span class="comment">// may be modified for these pages.</span>
00467         <span class="comment">//</span>
00468 
00469         NextEntry = CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o61">PhysicalVadList</a>.Flink;
00470         <span class="keywordflow">while</span> (NextEntry != &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o61">PhysicalVadList</a>) {
00471 
00472             PhysicalView = CONTAINING_RECORD(NextEntry,
00473                                              <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">MI_PHYSICAL_VIEW</a>,
00474                                              ListEntry);
00475 
00476             <span class="keywordflow">if</span> ((PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 0) &amp;&amp;
00477                 (PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping == 0)) {
00478                 NextEntry = NextEntry-&gt;Flink;
00479                 <span class="keywordflow">continue</span>;
00480             }
00481 
00482             <span class="keywordflow">if</span> (StartVa &lt; PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o2">StartVa</a>) {
00483 
00484                 <span class="keywordflow">if</span> ((PCHAR)EndVa - 1 &gt;= PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o2">StartVa</a>) {
00485 
00486                     <span class="comment">//</span>
00487                     <span class="comment">// The range encompasses a physical VAD.  This is not</span>
00488                     <span class="comment">// allowed.</span>
00489                     <span class="comment">//</span>
00490 
00491                     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00492                     <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(2);
00493                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_ACCESS_VIOLATION);
00494                     <span class="keywordflow">return</span>;
00495                 }
00496 
00497                 NextEntry = NextEntry-&gt;Flink;
00498                 <span class="keywordflow">continue</span>;
00499             }
00500 
00501             <span class="keywordflow">if</span> (StartVa &lt;= PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o3">EndVa</a>) {
00502 
00503                 <span class="comment">//</span>
00504                 <span class="comment">// Ensure that the entire range lies within the VAD.</span>
00505                 <span class="comment">//</span>
00506 
00507                 <span class="keywordflow">if</span> ((PCHAR)EndVa - 1 &gt; PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o3">EndVa</a>) {
00508 
00509                     <span class="comment">//</span>
00510                     <span class="comment">// The range goes past the end of the VAD - not allowed.</span>
00511                     <span class="comment">//</span>
00512 
00513                     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00514                     <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(3);
00515                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_ACCESS_VIOLATION);
00516                     <span class="keywordflow">return</span>;
00517                 }
00518 
00519                 <span class="keywordflow">if</span> (PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
00520 
00521                     <span class="comment">//</span>
00522                     <span class="comment">// All the PTEs must still be checked and reference</span>
00523                     <span class="comment">// counts bumped on the pages.  Just don't charge</span>
00524                     <span class="comment">// against the working set.</span>
00525                     <span class="comment">//</span>
00526 
00527                     NextEntry = NextEntry-&gt;Flink;
00528                     <span class="keywordflow">continue</span>;
00529                 }
00530 
00531                 <span class="comment">//</span>
00532                 <span class="comment">// The range lies within a physical VAD.</span>
00533                 <span class="comment">//</span>
00534 
00535                 <span class="keywordflow">if</span> (Operation != <a class="code" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>) {
00536 
00537                     <span class="comment">//</span>
00538                     <span class="comment">// Ensure the VAD is writable.  Changing individual PTE</span>
00539                     <span class="comment">// protections in a physical VAD is not allowed.</span>
00540                     <span class="comment">//</span>
00541 
00542                     <span class="keywordflow">if</span> ((PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>) == 0) {
00543                         <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00544                         <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(4);
00545                         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_ACCESS_VIOLATION);
00546                         <span class="keywordflow">return</span>;
00547                     }
00548                 }
00549 
00550                 <span class="comment">//</span>
00551                 <span class="comment">// Don't charge page locking for this transfer as it is all</span>
00552                 <span class="comment">// physical, just initialize the MDL.  Note the pages do not</span>
00553                 <span class="comment">// have to be physically contiguous, so the frames must be</span>
00554                 <span class="comment">// extracted from the PTEs.</span>
00555                 <span class="comment">//</span>
00556 
00557                 MemoryDescriptorList-&gt;MdlFlags |= (<a class="code" href="../../d0/d9/ntosdef_8h.html#a22">MDL_PHYSICAL_VIEW</a> | <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>);
00558                 MemoryDescriptorList-&gt;Process = CurrentProcess;
00559 
00560                 <span class="keywordflow">do</span> {
00561                     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
00562                     *Page = PageFrameIndex;
00563                     Page += 1;
00564                     PointerPte += 1;
00565                     Va = (PVOID)((PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00566                 } <span class="keywordflow">while</span> (Va &lt; EndVa);
00567 
00568                 <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00569                 <span class="keywordflow">return</span>;
00570             }
00571             NextEntry = NextEntry-&gt;Flink;
00572         }
00573 
00574         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o42">NumberOfLockedPages</a> += NumberOfPagesSpanned;
00575 
00576         MemoryDescriptorList-&gt;Process = CurrentProcess;
00577     }
00578 
00579     MemoryDescriptorList-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
00580 
00581     <span class="keywordflow">do</span> {
00582 
00583         <span class="keywordflow">if</span> (AddressIsPhysical == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00584 
00585             <span class="comment">//</span>
00586             <span class="comment">// On certain architectures, virtual addresses</span>
00587             <span class="comment">// may be physical and hence have no corresponding PTE.</span>
00588             <span class="comment">//</span>
00589 
00590             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (Va);
00591 
00592         } <span class="keywordflow">else</span> {
00593 
00594 <span class="preprocessor">#if defined (_WIN64)</span>
00595 <span class="preprocessor"></span>            <span class="keywordflow">while</span> ((PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
00596                    (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
00597                    (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0))
00598 <span class="preprocessor">#else</span>
00599 <span class="preprocessor"></span>            <span class="keywordflow">while</span> ((PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
00600                    (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0))
00601 <span class="preprocessor">#endif</span>
00602 <span class="preprocessor"></span>            {
00603 
00604                 <span class="comment">//</span>
00605                 <span class="comment">// PDE is not resident, release PFN lock touch the page and make</span>
00606                 <span class="comment">// it appear.</span>
00607                 <span class="comment">//</span>
00608 
00609                 <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00610 
00611                 <a class="code" href="../../d2/d1/mm_8h.html#a20">MmSetPageFaultReadAhead</a> (Thread, 0);
00612 
00613                 status = <a class="code" href="../../d4/d1/mmfault_8c.html#a2">MmAccessFault</a> (FALSE, Va, KernelMode, (PVOID)0);
00614 
00615                 <a class="code" href="../../d2/d1/mm_8h.html#a21">MmResetPageFaultReadAhead</a> (Thread, SavedState);
00616 
00617                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00618 
00619                     <span class="comment">//</span>
00620                     <span class="comment">// An exception occurred.  Unlock the pages locked</span>
00621                     <span class="comment">// so far.</span>
00622                     <span class="comment">//</span>
00623 
00624 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>:
00625                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00626 
00627                         <span class="comment">//</span>
00628                         <span class="comment">// Adjust the MDL length so that MmUnlockPages only</span>
00629                         <span class="comment">// processes the part that was completed.</span>
00630                         <span class="comment">//</span>
00631 
00632                         ULONG PagesLocked;
00633             
00634                         PagesLocked = <a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>(StartVa,
00635                                               MemoryDescriptorList-&gt;ByteCount);
00636 
00637 <span class="preprocessor">#if defined (_X86_)</span>
00638 <span class="preprocessor"></span>                        <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
00639 <span class="preprocessor">#endif</span>
00640 <span class="preprocessor"></span>                        <a class="code" href="../../d5/d6/iosup_8c.html#a32">MiAddMdlTracker</a> (MemoryDescriptorList,
00641                                          CallingAddress,
00642                                          CallersCaller,
00643                                          PagesLocked,
00644                                          0);
00645                     }
00646 
00647                     <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (MemoryDescriptorList);
00648 
00649                     <span class="comment">//</span>
00650                     <span class="comment">// Raise an exception of access violation to the caller.</span>
00651                     <span class="comment">//</span>
00652 
00653                     <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(7);
00654                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (status);
00655                     <span class="keywordflow">return</span>;
00656                 }
00657 
00658                 <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
00659             }
00660 
00661             PteContents = *PointerPte;
00662             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
00663 
00664             <span class="keywordflow">if</span> (Va &lt;= MM_HIGHEST_USER_ADDRESS) {
00665                 <span class="keywordflow">if</span> (Operation != <a class="code" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>) {
00666 
00667                     <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a77">MM_PTE_WRITE_MASK</a>) == 0) {
00668 
00669                         <span class="comment">//</span>
00670                         <span class="comment">// The caller has made the page protection more</span>
00671                         <span class="comment">// restrictive, this should never be done once the</span>
00672                         <span class="comment">// request has been issued !  Rather than wading</span>
00673                         <span class="comment">// through the PFN database entry to see if it</span>
00674                         <span class="comment">// could possibly work out, give the caller an</span>
00675                         <span class="comment">// access violation.</span>
00676                         <span class="comment">//</span>
00677 
00678 <span class="preprocessor">#if DBG</span>
00679 <span class="preprocessor"></span>                        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MmProbeAndLockPages: PTE %p %p changed\n"</span>,
00680                             PointerPte,
00681                             PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00682                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE);
00683 <span class="preprocessor">#endif</span>
00684 <span class="preprocessor"></span>
00685                         <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00686                         status = STATUS_ACCESS_VIOLATION;
00687                         <span class="keywordflow">goto</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>;
00688                     }
00689                 }
00690             }
00691 
00692             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PteContents);
00693         }
00694 
00695         <span class="keywordflow">if</span> (PageFrameIndex &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
00696 
00697             <span class="comment">//</span>
00698             <span class="comment">// This is an I/O space address don't allow operations</span>
00699             <span class="comment">// on addresses not in the PFN database.</span>
00700             <span class="comment">//</span>
00701 
00702             MemoryDescriptorList-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a23">MDL_IO_SPACE</a>;
00703 
00704         } <span class="keywordflow">else</span> {
00705             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; MDL_IO_SPACE) == 0);
00706 
00707             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00708 
00709 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00710 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageTablePage == 0);
00711 <span class="preprocessor">#endif</span>
00712 <span class="preprocessor"></span>
00713             <span class="comment">//</span>
00714             <span class="comment">// Check to make sure this page is not locked down an unusually</span>
00715             <span class="comment">// high number of times.</span>
00716             <span class="comment">//</span>
00717 
00718             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt;= <a class="code" href="../../d5/d6/iosup_8c.html#a23">MmReferenceCountCheck</a>) {
00719                 <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00720                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE);
00721                 status = STATUS_WORKING_SET_QUOTA;
00722                 <span class="keywordflow">goto</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>;
00723             }
00724 
00725             <span class="comment">//</span>
00726             <span class="comment">// Check to make sure the systemwide locked pages count is fluid.</span>
00727             <span class="comment">//</span>
00728 
00729             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() &lt;= 0) {
00730 
00731                 <span class="comment">//</span>
00732                 <span class="comment">// If this page is for paged pool or privileged code/data,</span>
00733                 <span class="comment">// then force it in.</span>
00734                 <span class="comment">//</span>
00735 
00736                 <span class="keywordflow">if</span> ((Va &gt; MM_HIGHEST_USER_ADDRESS) &amp;&amp;
00737                     (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a196">MI_IS_SYSTEM_CACHE_ADDRESS</a>(Va))) {
00738                     <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(8);
00739                     <span class="keywordflow">goto</span> ok;
00740                 }
00741 
00742                 <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(5);
00743                 <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00744                 status = STATUS_WORKING_SET_QUOTA;
00745                 <span class="keywordflow">goto</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>;
00746             }
00747 
00748             <span class="comment">//</span>
00749             <span class="comment">// Check to make sure any administrator-desired limit is obeyed.</span>
00750             <span class="comment">//</span>
00751 
00752             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a2">MmSystemLockPagesCount</a> + 1 &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a635">MmLockPagesLimit</a>) {
00753 
00754                 <span class="comment">//</span>
00755                 <span class="comment">// If this page is for paged pool or privileged code/data,</span>
00756                 <span class="comment">// then force it in.</span>
00757                 <span class="comment">//</span>
00758 
00759                 <span class="keywordflow">if</span> ((Va &gt; MM_HIGHEST_USER_ADDRESS) &amp;&amp;
00760                     (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a196">MI_IS_SYSTEM_CACHE_ADDRESS</a>(Va))) {
00761                     <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(9);
00762                     <span class="keywordflow">goto</span> ok;
00763                 }
00764 
00765                 <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(6);
00766                 <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00767                 status = STATUS_WORKING_SET_QUOTA;
00768                 <span class="keywordflow">goto</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>;
00769             }
00770 
00771 ok:
00772             <a class="code" href="../../d4/d8/mi_8h.html#a186">MI_ADD_LOCKED_PAGE_CHARGE</a>(Pfn1, 0);
00773 
00774             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
00775         }
00776 
00777         *Page = PageFrameIndex;
00778 
00779         Page += 1;
00780         PointerPte += 1;
00781         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) {
00782             PointerPde += 1;
00783             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a>(PointerPte)) {
00784                 PointerPpe += 1;
00785             }
00786         }
00787 
00788         Va = (PVOID)((PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00789     } <span class="keywordflow">while</span> (Va &lt; EndVa);
00790 
00791     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00792 
00793     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (AlignedVa &lt;= MM_HIGHEST_USER_ADDRESS)) {
00794 
00795         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPagesSpanned != 0);
00796 
00797 <span class="preprocessor">#if defined (_X86_)</span>
00798 <span class="preprocessor"></span>        <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
00799 <span class="preprocessor">#endif</span>
00800 <span class="preprocessor"></span>
00801         <a class="code" href="../../d5/d6/iosup_8c.html#a32">MiAddMdlTracker</a> (MemoryDescriptorList,
00802                          CallingAddress,
00803                          CallersCaller,
00804                          NumberOfPagesSpanned,
00805                          1);
00806     }
00807 
00808     <span class="keywordflow">return</span>;
00809 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a272" doxytag="mm.h::MmProbeAndLockProcessPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmProbeAndLockProcessPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Operation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00813">813</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/verifier_8c-source.html#l00563">VerifierProbeAndLockProcessPages()</a>.
<p>
<pre class="fragment"><div>00822                    :
00823 
00824     This routine probes and locks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address range specified by
00825     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MemoryDescriptorList in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified Process <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessMode
00826     and Operation.
00827 
00828 Arguments:
00829 
00830     MemoryDescriptorList - Supplies a pre-initialized <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00831                            address range to be probed and locked.
00832 
00833     Process - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose address range <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00834               to be locked.
00835 
00836     AccessMode - The mode <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> probe should check access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
00837 
00838     Operation - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of access which <span class="keywordflow">for</span> which to check <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
00839 
00840 Return Value:
00841 
00842     None.
00843 
00844 --*/
00845 
00846 {
00847     LOGICAL Attached;
00848     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00849 
00850     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00851     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00852 
00853     <span class="keywordflow">if</span> (Process != <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ()) {
00854         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
00855         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00856     }
00857 
00858     <span class="keywordflow">try</span> {
00859 
00860         <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a> (MemoryDescriptorList,
00861                              AccessMode,
00862                              Operation);
00863 
00864     } except (EXCEPTION_EXECUTE_HANDLER) {
00865         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00866     }
00867 
00868     <span class="keywordflow">if</span> (Attached) {
00869         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00870     }
00871 
00872     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00873         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (Status);
00874     }
00875     <span class="keywordflow">return</span>;
00876 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a288" doxytag="mm.h::MmProbeAndLockSelectedPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmProbeAndLockSelectedPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFILE_SEGMENT_ELEMENT&nbsp;</td>
          <td class="mdname" nowrap> <em>SegmentArray</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Operation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l01152">1152</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00435">MDL_IO_SPACE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00428">MDL_PARTIAL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00426">MDL_SOURCE_IS_NONPAGED_POOL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00416">_MDL::MdlFlags</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00879">MiAddMdlTracker()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01041">MiFreeMdlTracker()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01789">MmInitializeMdl</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00089">MmTrackLockedPages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01347">MmUnlockPages()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00417">_MDL::Process</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00419">_MDL::StartVa</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l00593">VerifierProbeAndLockSelectedPages()</a>.
<p>
<pre class="fragment"><div>01161                    :
01162 
01163     This routine probes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified pages, makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages resident and
01164     locks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical pages mapped by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> pages in memory.  The
01165     Memory descriptor list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> updated to describe <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical pages.
01166 
01167 Arguments:
01168 
01169     MemoryDescriptorList - Supplies a pointer to a Memory Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>
01170                            (<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>). The <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> must supply <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length. The
01171                            physical page portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> updated when
01172                            <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are locked in memory.
01173 
01174     SegmentArray - Supplies a pointer to a list of buffer segments to be
01175                    probed and locked.
01176 
01177     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access mode in which to probe <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arguments.
01178                  One of <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> or <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
01179 
01180     Operation - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.  One of <a class="code" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>, <a class="code" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a>
01181                 or <a class="code" href="../../d2/d1/mm_8h.html#a344a170">IoModifyAccess</a>.
01182 
01183 Return Value:
01184 
01185     None - exceptions are raised.
01186 
01187 Environment:
01188 
01189     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> and below.
01190 
01191 --*/
01192 
01193 {
01194     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> TempMdl;
01195     PFN_NUMBER MdlHack[(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)/<span class="keyword">sizeof</span>(PFN_NUMBER)) + 1];
01196     PPFN_NUMBER Page;
01197     PFILE_SEGMENT_ELEMENT LastSegment;
01198     PVOID CallingAddress;
01199     PVOID CallersCaller;
01200     ULONG NumberOfPagesToLock;
01201 
01202     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01203 
01204 <span class="preprocessor">#if !defined (_X86_)</span>
01205 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
01206     CallersCaller = (PVOID)0;
01207 <span class="preprocessor">#endif</span>
01208 <span class="preprocessor"></span>
01209     NumberOfPagesToLock = 0;
01210 
01211     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MemoryDescriptorList-&gt;ByteCount != 0);
01212     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG_PTR)MemoryDescriptorList-&gt;ByteOffset &amp; ~(PAGE_SIZE - 1)) == 0);
01213 
01214     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; (
01215                     MDL_PAGES_LOCKED |
01216                     MDL_MAPPED_TO_SYSTEM_VA |
01217                     MDL_SOURCE_IS_NONPAGED_POOL |
01218                     MDL_PARTIAL |
01219                     MDL_IO_SPACE)) == 0);
01220 
01221     <span class="comment">//</span>
01222     <span class="comment">// Initialize TempMdl.</span>
01223     <span class="comment">//</span>
01224 
01225     TempMdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) &amp;MdlHack;
01226 
01227     <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a>( TempMdl, SegmentArray-&gt;Buffer, PAGE_SIZE );
01228 
01229     Page = (PPFN_NUMBER) (MemoryDescriptorList + 1);
01230 
01231     <span class="comment">//</span>
01232     <span class="comment">// Calculate the end of the segment list.</span>
01233     <span class="comment">//</span>
01234 
01235     LastSegment = SegmentArray +
01236                   <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(MemoryDescriptorList-&gt;ByteCount);
01237 
01238     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(SegmentArray &lt; LastSegment);
01239 
01240     <span class="comment">//</span>
01241     <span class="comment">// Build a small Mdl for each segment and call probe and lock pages.</span>
01242     <span class="comment">// Then copy the PFNs to the real mdl.  The first page is processed</span>
01243     <span class="comment">// outside of the try/finally to ensure that the flags and process</span>
01244     <span class="comment">// field are correctly set in case MmUnlockPages needs to be called.</span>
01245     <span class="comment">//</span>
01246 
01247     <span class="comment">//</span>
01248     <span class="comment">// Even systems without 64 bit pointers are required to zero the</span>
01249     <span class="comment">// upper 32 bits of the segment address so use alignment rather</span>
01250     <span class="comment">// than the buffer pointer.</span>
01251     <span class="comment">//</span>
01252 
01253     SegmentArray += 1;
01254     <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a>( TempMdl, AccessMode, Operation );
01255 
01256     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01257 
01258         <span class="comment">//</span>
01259         <span class="comment">// Since we move the page from the temp MDL to the real one below</span>
01260         <span class="comment">// and never free the temp one, fixup our accounting now.</span>
01261         <span class="comment">//</span>
01262 
01263         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a43">MiFreeMdlTracker</a> (TempMdl, 1) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01264             NumberOfPagesToLock += 1;
01265         }
01266     }
01267 
01268     *Page++ = *((PPFN_NUMBER) (TempMdl + 1));
01269 
01270     <span class="comment">//</span>
01271     <span class="comment">// Copy the flags and process fields.</span>
01272     <span class="comment">//</span>
01273 
01274     MemoryDescriptorList-&gt;MdlFlags |= TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a>;
01275     MemoryDescriptorList-&gt;Process = TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o3">Process</a>;
01276 
01277     <span class="keywordflow">try</span> {
01278 
01279         <span class="keywordflow">while</span> (SegmentArray &lt; LastSegment) {
01280 
01281             <span class="comment">//</span>
01282             <span class="comment">// Even systems without 64 bit pointers are required to zero the</span>
01283             <span class="comment">// upper 32 bits of the segment address so use alignment rather</span>
01284             <span class="comment">// than the buffer pointer.</span>
01285             <span class="comment">//</span>
01286 
01287             TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o5">StartVa</a> = (PVOID)(ULONG_PTR)SegmentArray-&gt;Buffer;
01288             TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> = 0;
01289 
01290             SegmentArray += 1;
01291             <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a>( TempMdl, AccessMode, Operation );
01292 
01293 
01294             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01295 
01296                 <span class="comment">//</span>
01297                 <span class="comment">// Since we move the page from the temp MDL to the real one</span>
01298                 <span class="comment">// below and never free the temp one, fixup our accounting now.</span>
01299                 <span class="comment">//</span>
01300 
01301                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a43">MiFreeMdlTracker</a> (TempMdl, 1) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01302                     NumberOfPagesToLock += 1;
01303                 }
01304             }
01305 
01306             *Page++ = *((PPFN_NUMBER) (TempMdl + 1));
01307         }
01308     } finally {
01309 
01310         <span class="keywordflow">if</span> (abnormal_termination()) {
01311 
01312             <span class="comment">//</span>
01313             <span class="comment">// Adjust the MDL length so that MmUnlockPages only processes</span>
01314             <span class="comment">// the part that was completed.</span>
01315             <span class="comment">//</span>
01316 
01317             MemoryDescriptorList-&gt;ByteCount =
01318                 (ULONG) (Page - (PPFN_NUMBER) (MemoryDescriptorList + 1)) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01319 
01320             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01321 <span class="preprocessor">#if defined (_X86_)</span>
01322 <span class="preprocessor"></span>                <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
01323 <span class="preprocessor">#endif</span>
01324 <span class="preprocessor"></span>                <a class="code" href="../../d5/d6/iosup_8c.html#a32">MiAddMdlTracker</a> (MemoryDescriptorList,
01325                                  CallingAddress,
01326                                  CallersCaller,
01327                                  NumberOfPagesToLock,
01328                                  2);
01329             }
01330 
01331             <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a>( MemoryDescriptorList );
01332         }
01333         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01334 <span class="preprocessor">#if defined (_X86_)</span>
01335 <span class="preprocessor"></span>            <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
01336 <span class="preprocessor">#endif</span>
01337 <span class="preprocessor"></span>            <a class="code" href="../../d5/d6/iosup_8c.html#a32">MiAddMdlTracker</a> (MemoryDescriptorList,
01338                              CallingAddress,
01339                              CallersCaller,
01340                              NumberOfPagesToLock,
01341                              3);
01342         }
01343     }
01344 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a322" doxytag="mm.h::MmProtectSpecialPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MmProtectSpecialPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewProtect</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/allocpag_8c-source.html#l05228">5228</a> of file <a class="el" href="../../d2/d5/allocpag_8c-source.html">allocpag.c</a>.
<p>
References <a class="el" href="../../d2/d5/allocpag_8c-source.html#l05278">MiProtectSpecialPool()</a>, and <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02922">MiSpecialPoolPtes</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00807">IovpProtectedIrpMakeTouchable()</a>, and <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00744">IovpProtectedIrpMakeUntouchable()</a>.
<p>
<pre class="fragment"><div>05235                    :
05236 
05237     This function protects a special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocation.
05238 
05239 Arguments:
05240 
05241     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> address to protect.
05242 
05243     NewProtect - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection to set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages to (PAGE_XX).
05244 
05245 Return Value:
05246 
05247     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection was successfully applied, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
05248 
05249 Environment:
05250 
05251     Kernel mode, IRQL at <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below <span class="keywordflow">for</span> pagable <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>, DISPATCH or
05252     below <span class="keywordflow">for</span> nonpagable <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
05253 
05254     Note that setting an allocation to NO_ACCESS implies that an accessible
05255     protection must be applied by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller prior to <span class="keyword">this</span> allocation being
05256     freed.
05257 
05258     Note <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a nonpagable wrapper so that machines without special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
05259     can still support code attempting to protect special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> at
05260     <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>.
05261 
05262 --*/
05263 
05264 {
05265     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/allocpag_8c.html#a26">MiSpecialPoolPtes</a> == 0) {
05266 
05267         <span class="comment">//</span>
05268         <span class="comment">// The special pool allocation code was never initialized.</span>
05269         <span class="comment">//</span>
05270 
05271         <span class="keywordflow">return</span> (ULONG)-1;
05272     }
05273 
05274     <span class="keywordflow">return</span> <a class="code" href="../../d1/d6/allocpag_8c.html#a42">MiProtectSpecialPool</a> (VirtualAddress, NewProtect);
05275 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a253" doxytag="mm.h::MmPurgeSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmPurgeSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionObjectPointer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER <a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>RegionSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreCacheViews</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01548">1548</a> of file <a class="el" href="../../d7/d4/flushsec_8c-source.html">flushsec.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01534">_FILE_OBJECT::FileName</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02070">_CONTROL_AREA::FilePointer</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02411">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02579">MiCancelWriteOfMappedPfn()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l02614">MiCanFileBeTruncatedInternal()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>, <a class="el" href="../../d5/d5/sectsup_8c.html#a11">MiCheckProtoPtePageState()</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00996">MiMakeSystemAddressValidPfn()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00179">MM_DBG_FLUSH_SECTION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04610">MmMappedFileIoComplete</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02072">_CONTROL_AREA::ModifiedWriteCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02124">_SUBSECTION::NextSubsection</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02062">_CONTROL_AREA::NumberOfMappedViews</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02061">_CONTROL_AREA::NumberOfPfnReferences</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02073">_CONTROL_AREA::NumberOfSystemCacheViews</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00910">UNLOCK_PFN_AND_THEN_WAIT</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a217">WrPageOut</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l02331">CcPurgeCacheSection()</a>.
<p>
<pre class="fragment"><div>01557                    :
01558 
01559     This function determines <span class="keywordflow">if</span> any views of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section
01560     are mapped, and <span class="keywordflow">if</span> not, purges valid pages (even modified ones)
01561     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section and returns any used pages to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free
01562     list.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> accomplished by examining <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prototype PTEs
01563     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified offset to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section, and <span class="keywordflow">if</span>
01564     any prototype PTEs are in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> transition state, putting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01565     prototype PTE back into its original state and putting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01566     physical page on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free list.
01567 
01568     NOTE:
01569 
01570     If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an I/O operation ongoing <span class="keywordflow">for</span> one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages,
01571     that page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> eliminated from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> segment and allowed to <span class="stringliteral">"float"</span>
01572     until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> i/o <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> complete.  Once <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> share count goes to zero
01573     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page will be added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free page list.
01574 
01575 Arguments:
01576 
01577     SectionObjectPointer - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section objects.
01578 
01579     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section in which to begin
01580              purging pages.  If <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not present, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01581              whole section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> purged without regard to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region size
01582              argument.
01583 
01584 
01585     RegionSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> region to purge.  If <span class="keyword">this</span>
01586                  <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified as zero and <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01587                  region from <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> purged.
01588 
01589                  Note: The largest value acceptable <span class="keywordflow">for</span> RegionSize <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01590                  0xFFFF0000;
01591 
01592     IgnoreCacheViews - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> mapped views in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system
01593                  cache should cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function to <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
01594                  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> normal <span class="keywordflow">case</span>.
01595                  Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> mapped views should be ignored
01596                  and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flush should occur.  NOTE THAT <a class="code" href="../../d2/d0/aw_8h.html#a1">IF</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01597                  IS SPECIFIED AND ANY DATA PURGED IS CURRENTLY MAPPED
01598                  AND VALID <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> BUGCHECK WILL OCCUR!!
01599 
01600 Return Value:
01601 
01602     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> either no section exists <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object or
01603     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not mapped and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> purge was done, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01604 
01605     Note that <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> purge operation, a page
01606     could not be purged due to a non-zero reference count.
01607 
01608 --*/
01609 
01610 {
01611     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
01612     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01613     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
01614     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FinalPte;
01615     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
01616     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01617     KIRQL OldIrql;
01618     ULONG PteOffset;
01619     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
01620     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> LastSubsection;
01621     LARGE_INTEGER LocalOffset;
01622     BOOLEAN DeleteSegment = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01623     BOOLEAN LockHeld;
01624     BOOLEAN ReturnValue;
01625     PFN_NUMBER PageFrameIndex;
01626 <span class="preprocessor">#if DBG</span>
01627 <span class="preprocessor"></span>    PFN_NUMBER LastLocked = 0;
01628 <span class="preprocessor">#endif //DBG</span>
01629 <span class="preprocessor"></span>
01630     <span class="comment">//</span>
01631     <span class="comment">// This is needed in case a page is on the mapped page writer list -</span>
01632     <span class="comment">// the PFN lock will need to be released and APCs disabled.</span>
01633     <span class="comment">//</span>
01634 
01635     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt; DISPATCH_LEVEL);
01636 
01637     <span class="comment">//</span>
01638     <span class="comment">//  Capture caller's file size, since we may modify it.</span>
01639     <span class="comment">//</span>
01640 
01641     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Offset)) {
01642 
01643         LocalOffset = *<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01644         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = &amp;LocalOffset;
01645     }
01646 
01647     <span class="comment">//</span>
01648     <span class="comment">//  See if we can truncate this file to where the caller wants</span>
01649     <span class="comment">//  us to.</span>
01650     <span class="comment">//</span>
01651 
01652     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/sectsup_8c.html#a31">MiCanFileBeTruncatedInternal</a>(SectionObjectPointer, Offset, TRUE, &amp;OldIrql)) {
01653         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01654     }
01655 
01656     <span class="comment">//</span>
01657     <span class="comment">// PFN LOCK IS NOW HELD!</span>
01658     <span class="comment">//</span>
01659 
01660     ControlArea = (<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>)(SectionObjectPointer-&gt;DataSectionObject);
01661     <span class="keywordflow">if</span> (ControlArea == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01662         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01663         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01664 
01665     <span class="comment">//</span>
01666     <span class="comment">//  Even though MiCanFileBeTruncatedInternal returned TRUE, there could</span>
01667     <span class="comment">//  still be a system cache mapped view.  We cannot truncate if</span>
01668     <span class="comment">//  the Cache Manager has a view mapped.</span>
01669     <span class="comment">//</span>
01670 
01671     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((IgnoreCacheViews == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
01672             (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o14">NumberOfSystemCacheViews</a> != 0)) {
01673         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01674         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01675     }
01676 
01677     <span class="comment">//</span>
01678     <span class="comment">// Prevent races when the control area is being deleted as the clean</span>
01679     <span class="comment">// path releases the PFN lock midway through.  File objects may still have</span>
01680     <span class="comment">// section object pointers and data section objects that point at this</span>
01681     <span class="comment">// control area, hence the purge can be issued.</span>
01682     <span class="comment">//</span>
01683     <span class="comment">// Check for this and fail the purge as the control area (and the section</span>
01684     <span class="comment">// object pointers/data section objects) will be going away momentarily.</span>
01685     <span class="comment">// Note that even though drivers have these data section objects, no one</span>
01686     <span class="comment">// currently has an open section for this control area and no one is</span>
01687     <span class="comment">// allowed to open one until the clean path finishes.</span>
01688     <span class="comment">//</span>
01689 
01690     <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingDeleted == 1) {
01691         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01692         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01693     }
01694 
01695     <span class="comment">//</span>
01696     <span class="comment">// Purge the section - locate the subsection which</span>
01697     <span class="comment">// contains the PTEs.</span>
01698     <span class="comment">//</span>
01699 
01700     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0);
01701 
01702     Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
01703 
01704     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT (Offset)) {
01705 
01706         <span class="comment">//</span>
01707         <span class="comment">// If the offset is not specified, flush the complete file ignoring</span>
01708         <span class="comment">// the region size.</span>
01709         <span class="comment">//</span>
01710 
01711         PointerPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[0];
01712         RegionSize = 0;
01713 
01714     } <span class="keywordflow">else</span> {
01715 
01716         PteOffset = (ULONG)(<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01717 
01718         <span class="comment">//</span>
01719         <span class="comment">// Make sure the PTEs are not in the extended part of the</span>
01720         <span class="comment">// segment.</span>
01721         <span class="comment">//</span>
01722 
01723         <span class="keywordflow">while</span> (PteOffset &gt;= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>) {
01724             PteOffset -= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
01725             Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
01726             <span class="keywordflow">if</span> (Subsection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01727 
01728                 <span class="comment">//</span>
01729                 <span class="comment">// The offset must be equal to the size of</span>
01730                 <span class="comment">// the section, don't purge anything just return.</span>
01731                 <span class="comment">//</span>
01732 
01733                 <span class="comment">//ASSERT (PteOffset == 0);</span>
01734                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01735                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01736             }
01737         }
01738 
01739         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteOffset &lt; Subsection-&gt;PtesInSubsection);
01740         PointerPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset];
01741     }
01742 
01743 
01744     <span class="comment">//</span>
01745     <span class="comment">// Locate the address of the last prototype PTE to be flushed.</span>
01746     <span class="comment">//</span>
01747 
01748     <span class="keywordflow">if</span> (RegionSize == 0) {
01749 
01750         <span class="comment">//</span>
01751         <span class="comment">// Flush to end of section.</span>
01752         <span class="comment">//</span>
01753 
01754         LastSubsection = Subsection;
01755         <span class="keywordflow">while</span> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01756             LastSubsection = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
01757         }
01758 
01759         <span class="comment">//</span>
01760         <span class="comment">// Set the final PTE to 1 beyond the last page.</span>
01761         <span class="comment">//</span>
01762 
01763         FinalPte = &amp;LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>
01764                             [LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>];
01765     } <span class="keywordflow">else</span> {
01766 
01767         <span class="comment">//</span>
01768         <span class="comment">// Calculate the end of the region.</span>
01769         <span class="comment">//</span>
01770 
01771         PteOffset +=
01772             (ULONG) (((RegionSize + <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>-&gt;LowPart)) - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
01773 
01774         LastSubsection = Subsection;
01775 
01776         <span class="keywordflow">while</span> (PteOffset &gt;= LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>) {
01777             PteOffset -= LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
01778             <span class="keywordflow">if</span> (LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01779                 PteOffset = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> - 1;
01780                 <span class="keywordflow">break</span>;
01781             }
01782             LastSubsection = LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
01783         }
01784 
01785         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteOffset &lt; LastSubsection-&gt;PtesInSubsection);
01786 
01787         <span class="comment">//</span>
01788         <span class="comment">// Point final PTE to 1 beyond the end.</span>
01789         <span class="comment">//</span>
01790 
01791         FinalPte = &amp;LastSubsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset + 1];
01792     }
01793 
01794     <span class="comment">//</span>
01795     <span class="comment">// Increment the number of mapped views to</span>
01796     <span class="comment">// prevent the section from being deleted while the purge is</span>
01797     <span class="comment">// in progress.</span>
01798     <span class="comment">//</span>
01799 
01800     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> += 1;
01801 
01802     <span class="comment">//</span>
01803     <span class="comment">// Set being purged so no one can map a view</span>
01804     <span class="comment">// while the purge is going on.</span>
01805     <span class="comment">//</span>
01806 
01807     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingPurged = 1;
01808     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.WasPurged = 1;
01809 
01810     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01811     LockHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01812     ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01813 
01814     <span class="keywordflow">for</span> (;;) {
01815 
01816         <span class="keywordflow">if</span> (LastSubsection != Subsection) {
01817 
01818             <span class="comment">//</span>
01819             <span class="comment">// Flush to the last PTE in this subsection.</span>
01820             <span class="comment">//</span>
01821 
01822             LastPte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>];
01823         } <span class="keywordflow">else</span> {
01824 
01825             <span class="comment">//</span>
01826             <span class="comment">// Flush to the end of the range.</span>
01827             <span class="comment">//</span>
01828 
01829             LastPte = FinalPte;
01830         }
01831 
01832         <span class="comment">//</span>
01833         <span class="comment">// If the page table page containing the PTEs is not</span>
01834         <span class="comment">// resident, then no PTEs can be in the valid or transition</span>
01835         <span class="comment">// state!  Skip over the PTEs.</span>
01836         <span class="comment">//</span>
01837 
01838         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/sectsup_8c.html#a11">MiCheckProtoPtePageState</a>(PointerPte, LockHeld)) {
01839             PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(((ULONG_PTR)PointerPte | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) + 1);
01840         }
01841 
01842         <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
01843 
01844             <span class="comment">//</span>
01845             <span class="comment">// If the page table page containing the PTEs is not</span>
01846             <span class="comment">// resident, then no PTEs can be in the valid or transition</span>
01847             <span class="comment">// state!  Skip over the PTEs.</span>
01848             <span class="comment">//</span>
01849 
01850             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) {
01851                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/sectsup_8c.html#a11">MiCheckProtoPtePageState</a>(PointerPte, LockHeld)) {
01852                     PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((PCHAR)PointerPte + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01853                     <span class="keywordflow">continue</span>;
01854                 }
01855             }
01856 
01857             PteContents = *PointerPte;
01858 
01859             <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01860 
01861                 <span class="comment">//</span>
01862                 <span class="comment">// A valid PTE was found, it must be mapped in the</span>
01863                 <span class="comment">// system cache.  Just exit the loop and return FALSE</span>
01864                 <span class="comment">// and let the caller fix this.</span>
01865                 <span class="comment">//</span>
01866 
01867                 ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01868                 <span class="keywordflow">break</span>;
01869             }
01870 
01871             <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
01872                      (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)) {
01873 
01874                 <span class="keywordflow">if</span> (!LockHeld) {
01875                     LockHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01876                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01877                     <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerPte);
01878                     <span class="keywordflow">continue</span>;
01879                 }
01880 
01881                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>(&amp;PteContents);
01882                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01883 
01884                 <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype != 1) ||
01885                     (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid != 0) ||
01886                     (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> != PointerPte)) {
01887 
01888                     <span class="comment">//</span>
01889                     <span class="comment">// The pool containing the prototype PTEs has been</span>
01890                     <span class="comment">// corrupted.  Pool corruption like this is fatal.</span>
01891                     <span class="comment">//</span>
01892 
01893                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (POOL_CORRUPTION_IN_FILE_AREA,
01894                                   0x2,
01895                                   (ULONG_PTR)PointerPte,
01896                                   (ULONG_PTR)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>,
01897                                   (ULONG_PTR)PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01898                 }
01899 
01900 <span class="preprocessor">#if DBG</span>
01901 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0) &amp;&amp;
01902                     (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0)) {
01903 
01904                     <span class="comment">//</span>
01905                     <span class="comment">// There must be an I/O in progress on this</span>
01906                     <span class="comment">// page.</span>
01907                     <span class="comment">//</span>
01908 
01909                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>(&amp;PteContents) != LastLocked) {
01910                         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01911 
01912 <span class="preprocessor">#if DBG</span>
01913 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a71">MM_DBG_FLUSH_SECTION</a>) {
01914                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:PURGE - page %lx locked, file:%Z\n"</span>,
01915                                     PageFrameIndex,
01916                                     &amp;ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>
01917                                 );
01918                         }
01919 <span class="preprocessor">#endif</span>
01920 <span class="preprocessor"></span>                        LastLocked = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;PteContents);
01921                         <span class="comment">//DbgBreakPoint();</span>
01922                         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01923                         <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerPte);
01924                         <span class="keywordflow">continue</span>;
01925                     }
01926                 }
01927 <span class="preprocessor">#endif //DBG</span>
01928 <span class="preprocessor"></span>
01929                 <span class="comment">//</span>
01930                 <span class="comment">// If the modified page writer has page locked for I/O</span>
01931                 <span class="comment">// wait for the I/O's to be completed and the pages</span>
01932                 <span class="comment">// to be unlocked.  The eliminates a race condition</span>
01933                 <span class="comment">// when the modified page writer locks the pages, then</span>
01934                 <span class="comment">// a purge occurs and completes before the mapped</span>
01935                 <span class="comment">// writer thread runs.</span>
01936                 <span class="comment">//</span>
01937 
01938                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 1) {
01939 
01940                     <span class="comment">//</span>
01941                     <span class="comment">// A 3 or more thread deadlock can occur where:</span>
01942                     <span class="comment">//</span>
01943                     <span class="comment">// 1.  The mapped page writer thread has issued a write</span>
01944                     <span class="comment">//     and is in the filesystem code waiting for a resource.</span>
01945                     <span class="comment">//</span>
01946                     <span class="comment">// 2.  Thread 2 owns the resource above but is waiting for</span>
01947                     <span class="comment">//     the filesystem's quota mutex.</span>
01948                     <span class="comment">//</span>
01949                     <span class="comment">// 3.  Thread 3 owns the quota mutex and is right here</span>
01950                     <span class="comment">//     doing a purge from the cache manager when he notices</span>
01951                     <span class="comment">//     the page to be purged is either already being written</span>
01952                     <span class="comment">//     or is in the mapped page writer list.  If it is</span>
01953                     <span class="comment">//     already being written everything will unjam.  If it</span>
01954                     <span class="comment">//     is still on the mapped page writer list awaiting</span>
01955                     <span class="comment">//     processing, then it must be cancelled - otherwise</span>
01956                     <span class="comment">//     if this thread were to wait, deadlock can occur.</span>
01957                     <span class="comment">//</span>
01958                     <span class="comment">// The alternative to all this is for the filesystems to</span>
01959                     <span class="comment">// always release the quota mutex before purging but the</span>
01960                     <span class="comment">// filesystem overhead to do this is substantial.</span>
01961                     <span class="comment">//</span>
01962 
01963                     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/modwrite_8c.html#a50">MiCancelWriteOfMappedPfn</a> (PageFrameIndex) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01964 
01965                         <span class="comment">//</span>
01966                         <span class="comment">// Stopping any failed writes (even deliberately</span>
01967                         <span class="comment">// cancelled ones) automatically cause a delay.  A</span>
01968                         <span class="comment">// successful stop also results in the PFN lock</span>
01969                         <span class="comment">// being released and reacquired.  So loop back to</span>
01970                         <span class="comment">// the top now as the world may have changed.</span>
01971                         <span class="comment">//</span>
01972 
01973                         <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerPte);
01974                         <span class="keywordflow">continue</span>;
01975                     }
01976 
01977                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o13">ModifiedWriteCount</a> != 0);
01978                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0);
01979 
01980                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.SetMappedFileIoComplete = 1;
01981 
01982                     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01983                     <a class="code" href="../../d4/d8/mi_8h.html#a132">UNLOCK_PFN_AND_THEN_WAIT</a>(OldIrql);
01984 
01985                     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;MmMappedFileIoComplete,
01986                                           WrPageOut,
01987                                           KernelMode,
01988                                           FALSE,
01989                                           (PLARGE_INTEGER)NULL);
01990                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01991                     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01992                     <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerPte);
01993                     <span class="keywordflow">continue</span>;
01994                 }
01995 
01996                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress == 1) {
01997 
01998                     <span class="comment">//</span>
01999                     <span class="comment">// The page currently is being read in from the</span>
02000                     <span class="comment">// disk.  Treat this just like a valid PTE and</span>
02001                     <span class="comment">// return false.</span>
02002                     <span class="comment">//</span>
02003 
02004                     ReturnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02005                     <span class="keywordflow">break</span>;
02006                 }
02007 
02008                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
02009                     (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)));
02010 
02011                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
02012 
02013                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
02014 
02015                 ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> -= 1;
02016                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> &gt;= 0);
02017 
02018                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
02019 
02020                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
02021 
02022                 <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
02023 
02024                 <span class="comment">//</span>
02025                 <span class="comment">// If the reference count for the page is zero, insert</span>
02026                 <span class="comment">// it into the free page list, otherwise leave it alone</span>
02027                 <span class="comment">// and when the reference count is decremented to zero</span>
02028                 <span class="comment">// the page will go to the free list.</span>
02029                 <span class="comment">//</span>
02030 
02031                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
02032                     <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
02033                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
02034                                         MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE (&amp;PteContents));
02035                 }
02036             }
02037             PointerPte += 1;
02038 
02039             <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) &amp;&amp; (LockHeld)) {
02040 
02041                 <span class="comment">//</span>
02042                 <span class="comment">// Unlock PFN so large requests will not block other</span>
02043                 <span class="comment">// threads on MP systems.</span>
02044                 <span class="comment">//</span>
02045 
02046                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02047                 LockHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02048             }
02049 
02050         } <span class="comment">//end while</span>
02051 
02052         <span class="keywordflow">if</span> (LockHeld) {
02053             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02054             LockHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02055         }
02056 
02057         <span class="keywordflow">if</span> ((LastSubsection != Subsection) &amp;&amp; (ReturnValue)) {
02058 
02059             <span class="comment">//</span>
02060             <span class="comment">// Get the next subsection in the list.</span>
02061             <span class="comment">//</span>
02062 
02063             Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
02064             PointerPte = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>;
02065 
02066         } <span class="keywordflow">else</span> {
02067 
02068             <span class="comment">//</span>
02069             <span class="comment">// The last range has been flushed, exit the top FOR loop</span>
02070             <span class="comment">// and return.</span>
02071             <span class="comment">//</span>
02072 
02073             <span class="keywordflow">break</span>;
02074         }
02075     }  <span class="comment">//end for</span>
02076 
02077     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02078 
02079     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> &gt;= 1);
02080     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
02081 
02082     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.BeingPurged = 0;
02083 
02084     <span class="comment">//</span>
02085     <span class="comment">// Check to see if the control area should be deleted.  This</span>
02086     <span class="comment">// will release the PFN lock.</span>
02087     <span class="comment">//</span>
02088 
02089     <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
02090     <span class="keywordflow">return</span> ReturnValue;
02091 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a260" doxytag="mm.h::MmPurgeWorkingSet" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmPurgeWorkingSet           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>RegionSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a324" doxytag="mm.h::MmQuerySpecialPoolBlockSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T MmQuerySpecialPoolBlockSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>P</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02927">2927</a> of file <a class="el" href="../../d2/d5/allocpag_8c-source.html">allocpag.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00065">MI_SPECIAL_POOL_PAGABLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00066">MI_SPECIAL_POOL_VERIFIER</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01977">MmSpecialPoolEnd</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01976">MmSpecialPoolStart</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00116">POOL_OVERHEAD</a>, and <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00114">PPOOL_HEADER</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03328">ExQueryPoolBlockSize()</a>.
<p>
<pre class="fragment"><div>02933                    :
02934 
02935     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of a special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocation.
02936 
02937 Arguments:
02938 
02939     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <span class="keyword">virtual</span> address to query.
02940 
02941 Return Value:
02942 
02943     The size in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation.
02944 
02945 Environment:
02946 
02947     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below <span class="keywordflow">for</span> pagable addresses, <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or
02948     below <span class="keywordflow">for</span> nonpaged addresses.
02949 
02950 --*/
02951 
02952 {
02953     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
02954 
02955     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((P &gt;= MmSpecialPoolStart) &amp;&amp; (P &lt; MmSpecialPoolEnd));
02956 
02957     <span class="keywordflow">if</span> (((ULONG_PTR)P &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1))) {
02958         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (P);
02959     }
02960     <span class="keywordflow">else</span> {
02961         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (P) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
02962     }
02963 
02964     <span class="keywordflow">return</span> (SIZE_T)(<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Ulong1 &amp; ~(<a class="code" href="../../d4/d8/mi_8h.html#a2">MI_SPECIAL_POOL_PAGABLE</a> | <a class="code" href="../../d4/d8/mi_8h.html#a3">MI_SPECIAL_POOL_VERIFIER</a>));
02965 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a184" doxytag="mm.h::MmQuerySystemSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI <a class="el" href="../../d2/d1/mm_8h.html#a140">MM_SYSTEMSIZE</a> MmQuerySystemSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/mminit_8c-source.html#l03073">3073</a> of file <a class="el" href="../../d6/d0/mminit_8c-source.html">mminit.c</a>.
<p>
References <a class="el" href="../../d6/d0/mminit_8c-source.html#l00172">MmSystemSize</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cachesub_8c-source.html#l05541">CcAllocateInitializeBcb()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00069">CcInitializeCacheManager()</a>, <a class="el" href="../../d7/d5/ex_2region_8c-source.html#l00024">ExInitializeRegion()</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00220">ExpWorkerInitialization()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">KeBalanceSetManager()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>, and <a class="el" href="../../d3/d7/udfinit_8c-source.html#l00183">UdfInitializeGlobalData()</a>.
<p>
<pre class="fragment"><div>03076 {
03077     <span class="comment">//</span>
03078     <span class="comment">// 12Mb  is small</span>
03079     <span class="comment">// 12-19 is medium</span>
03080     <span class="comment">// &gt; 19 is large</span>
03081     <span class="comment">//</span>
03082     <span class="keywordflow">return</span> <a class="code" href="../../d5/d1/mminit_8c.html#a37">MmSystemSize</a>;
03083 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a329" doxytag="mm.h::MmRaisePoolQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmRaisePoolQuota           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>OldQuotaLimit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NewQuotaLimit</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01118">1118</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l04726">_MM_PAGED_POOL_INFO::AllocatedPagedPool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00098">MmAllocatedNonPagedPool</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00062">MmMaximumNonPagedPoolInBytes</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02010">MMNONPAGED_QUOTA_INCREASE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02016">MMPAGED_QUOTA_CHECK</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02012">MMPAGED_QUOTA_INCREASE</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00069">MmPagedPoolInfo</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00074">MmSizeOfPagedPoolInBytes</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01115">MmTotalNonPagedPoolQuota</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01114">MmTotalPagedPoolQuota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/psquota_8c-source.html#l00246">PsChargePoolQuota()</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00024">PsChargeSharedPoolQuota()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l01211">PspSetQuotaLimits()</a>.
<p>
<pre class="fragment"><div>01126                    :
01127 
01128     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called (with a spinlock) whenever PS detects a quota
01129     limit has been exceeded. The purpose of <span class="keyword">this</span> function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to attempt to
01130     increase <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified quota.
01131 
01132 Arguments:
01133 
01134     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota to be raised
01135 
01136     OldQuotaLimit - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current quota limit <span class="keywordflow">for</span> <span class="keyword">this</span> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
01137 
01138     NewQuotaLimit - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> limit
01139 
01140 Return Value:
01141 
01142     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - The API succeeded and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota limit was raised.
01143 
01144     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - We were unable to raise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota limit.
01145 
01146 Environment:
01147 
01148     Kernel mode, QUOTA SPIN <a class="code" href="../../d4/d2/struct__LOCK.html">LOCK</a> HELD!!
01149 
01150 --*/
01151 
01152 {
01153     SIZE_T Limit;
01154     <a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html">PMM_PAGED_POOL_INFO</a> PagedPoolInfo;
01155 
01156     <span class="keywordflow">if</span> (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
01157 
01158         <span class="comment">//</span>
01159         <span class="comment">// Check commit limit and make sure at least 1mb is available.</span>
01160         <span class="comment">// Check to make sure 4mb of paged pool still exists.</span>
01161         <span class="comment">//</span>
01162 
01163         PagedPoolInfo = &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a27">MmPagedPoolInfo</a>;
01164 
01165         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) &lt;
01166             (PagedPoolInfo-&gt;<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o8">AllocatedPagedPool</a> + ((<a class="code" href="../../d2/d1/mm_8h.html#a31">MMPAGED_QUOTA_CHECK</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>))) {
01167 
01168             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01169         }
01170 
01171         <a class="code" href="../../d6/d1/mmquota_8c.html#a12">MmTotalPagedPoolQuota</a> += (<a class="code" href="../../d2/d1/mm_8h.html#a29">MMPAGED_QUOTA_INCREASE</a>);
01172         *NewQuotaLimit = OldQuotaLimit + (<a class="code" href="../../d2/d1/mm_8h.html#a29">MMPAGED_QUOTA_INCREASE</a>);
01173         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01174 
01175     } <span class="keywordflow">else</span> {
01176 
01177         <span class="keywordflow">if</span> ( (ULONG_PTR)(<a class="code" href="../../d9/d5/4_2kddata_8c.html#a52">MmAllocatedNonPagedPool</a> + ((1*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) &lt; (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01178             <span class="keywordflow">goto</span> aok;
01179             }
01180 
01181         <span class="comment">//</span>
01182         <span class="comment">// Make sure 200 pages and 5mb of nonpaged pool expansion</span>
01183         <span class="comment">// available.  Raise quota by 64k.</span>
01184         <span class="comment">//</span>
01185 
01186         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 200) ||
01187             (MmResidentAvailablePages &lt; ((MMNONPAGED_QUOTA_CHECK) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>))) {
01188 
01189             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01190         }
01191 
01192         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; ((4*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01193             Limit = (1*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01194         } <span class="keywordflow">else</span> {
01195             Limit = (4*1024*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01196         }
01197 
01198         <span class="keywordflow">if</span> ((ULONG_PTR)((<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) &lt;
01199             (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a52">MmAllocatedNonPagedPool</a> + Limit)) {
01200 
01201             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01202         }
01203 aok:
01204         <a class="code" href="../../d6/d1/mmquota_8c.html#a13">MmTotalNonPagedPoolQuota</a> += (<a class="code" href="../../d2/d1/mm_8h.html#a28">MMNONPAGED_QUOTA_INCREASE</a>);
01205         *NewQuotaLimit = OldQuotaLimit + (<a class="code" href="../../d2/d1/mm_8h.html#a28">MMNONPAGED_QUOTA_INCREASE</a>);
01206         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01207     }
01208 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a299" doxytag="mm.h::MmReleaseDumpAddresses" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmReleaseDumpAddresses           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PFN_NUMBER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Pages</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07270">7270</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00406">MM_ZERO_PTE</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00105">MmCrashDumpPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
<pre class="fragment"><div>07276                    :
07277 
07278     For use by hibernate routine ONLY.  Puts zeros back into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
07279     used dump PTEs.
07280 
07281 Arguments:
07282 
07283     None
07284 
07285 Return Value:
07286 
07287     None
07288 
07289 --*/
07290 
07291 {
07292     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
07293     PCHAR BaseVa;
07294 
07295     PointerPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a19">MmCrashDumpPte</a>;
07296     BaseVa = (PCHAR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte);
07297 
07298     <span class="keywordflow">while</span> (Pages) {
07299 
07300         <a class="code" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb</a> (TRUE, BaseVa);
07301 
07302         PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a93">MM_ZERO_PTE</a>;
07303         PointerPte += 1;
07304         BaseVa += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
07305         Pages -= 1;
07306     }
07307 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a282" doxytag="mm.h::MmRemovePhysicalMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS MmRemovePhysicalMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PPHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>StartAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">437</a> of file <a class="el" href="../../d0/d3/dynmem_8c-source.html">dynmem.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00059">ASSERT64</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00034">_PHYSICAL_MEMORY_RUN::BasePage</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04360">MI_NONPAGABLE_MEMORY_AVAILABLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04555">MiDelayPageFaults</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02715">MiEmptyAllWorkingSets()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04870">MiFlushAllPages()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l01109">MiRemovePhysicalPages()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00026">MiTrimRemovalPagesOnly</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04899">MmChargeCommitmentLock</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00024">MmDynamicMemoryMutex</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00085">MmDynamicPfn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00216">MmHalfSecond</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00076">MmHighestPossiblePhysicalPage</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00399">MmNumberOfPhysicalPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00075">MmPfnDatabase</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">MmPhysicalMemoryBlock</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00041">MmTotalCommitLimit</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00100">MmTotalCommitLimitMaximum</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00040">MmTotalCommittedPages</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00040">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfPages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00039">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfRuns</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00035">_PHYSICAL_MEMORY_RUN::PageCount</a>, <a class="el" href="../../d2/d2/ppcdef_8h-source.html#l00079">PASSIVE_LEVEL</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00033">PFN_REMOVED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00041">_PHYSICAL_MEMORY_DESCRIPTOR::Run</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
<pre class="fragment"><div>00444                    :
00445 
00446     This routine attempts to remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical address range
00447     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
00448 
00449 Arguments:
00450 
00451     StartAddress  - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting physical address.
00452 
00453     NumberOfBytes  - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes being removed.
00454 
00455 Return Value:
00456 
00457     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>.
00458 
00459 Environment:
00460 
00461     Kernel mode.  PASSIVE level.  No locks held.
00462 
00463 --*/
00464 
00465 {
00466     ULONG i;
00467     ULONG Additional;
00468     PFN_NUMBER Page;
00469     PFN_NUMBER LastPage;
00470     PFN_NUMBER OriginalLastPage;
00471     PFN_NUMBER start;
00472     PFN_NUMBER PagesReleased;
00473     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00474     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> StartPfn;
00475     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> EndPfn;
00476     KIRQL OldIrql;
00477     PFN_NUMBER StartPage;
00478     PFN_NUMBER EndPage;
00479     PFN_COUNT NumberOfPages;
00480     SPFN_NUMBER MaxPages;
00481     PFN_NUMBER PageFrameIndex;
00482     PFN_NUMBER RemovedPages;
00483     LOGICAL Inserted;
00484     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00485     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00486     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPte;
00487     PVOID VirtualAddress;
00488     <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> OldPhysicalMemoryBlock;
00489     <a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> NewPhysicalMemoryBlock;
00490     <a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PPHYSICAL_MEMORY_RUN</a> NewRun;
00491     LOGICAL PfnDatabaseIsPhysical;
00492 
00493     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == PASSIVE_LEVEL);
00494 
00495     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(NumberOfBytes-&gt;LowPart) == 0);
00496     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(StartAddress-&gt;LowPart) == 0);
00497 
00498     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(MmPfnDatabase)) {
00499 
00500         <span class="comment">//</span>
00501         <span class="comment">// The system must be configured for dynamic memory addition.  This is</span>
00502         <span class="comment">// not strictly required to remove the memory, but it's better to check</span>
00503         <span class="comment">// for it now under the assumption that the administrator is probably</span>
00504         <span class="comment">// going to want to add this range of memory back in - better to give</span>
00505         <span class="comment">// the error now and refuse the removal than to refuse the addition</span>
00506         <span class="comment">// later.</span>
00507         <span class="comment">//</span>
00508     
00509         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a29">MmDynamicPfn</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00510             <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00511         }
00512 
00513         PfnDatabaseIsPhysical = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00514     }
00515     <span class="keywordflow">else</span> {
00516         PfnDatabaseIsPhysical = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00517     }
00518 
00519     StartPage = (PFN_NUMBER)(StartAddress-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00520     NumberOfPages = (PFN_COUNT)(NumberOfBytes-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00521 
00522     EndPage = StartPage + NumberOfPages;
00523 
00524     <span class="keywordflow">if</span> (EndPage - 1 &gt; <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a>) {
00525 
00526         <span class="comment">//</span>
00527         <span class="comment">// Truncate the request into something that can be mapped by the PFN</span>
00528         <span class="comment">// database.</span>
00529         <span class="comment">//</span>
00530 
00531         EndPage = <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a> + 1;
00532         NumberOfPages = (PFN_COUNT)(EndPage - StartPage);
00533     }
00534 
00535     <span class="comment">//</span>
00536     <span class="comment">// The range cannot wrap.</span>
00537     <span class="comment">//</span>
00538 
00539     <span class="keywordflow">if</span> (StartPage &gt;= EndPage) {
00540         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_1;
00541     }
00542 
00543     StartPfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (StartPage);
00544     EndPfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (EndPage);
00545 
00546     ExAcquireFastMutex (&amp;MmDynamicMemoryMutex);
00547 
00548 <span class="preprocessor">#if DBG</span>
00549 <span class="preprocessor"></span>    MiDynmemData[0] += 1;
00550 <span class="preprocessor">#endif</span>
00551 <span class="preprocessor"></span>
00552     <span class="comment">//</span>
00553     <span class="comment">// Decrease all commit limits to reflect the removed memory.</span>
00554     <span class="comment">//</span>
00555 
00556     ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
00557 
00558     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTotalCommitLimit &lt;= MmTotalCommitLimitMaximum);
00559 
00560     <span class="keywordflow">if</span> ((NumberOfPages + 100 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> - <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>) ||
00561         (<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>)) {
00562 
00563 <span class="preprocessor">#if DBG</span>
00564 <span class="preprocessor"></span>        MiDynmemData[1] += 1;
00565 <span class="preprocessor">#endif</span>
00566 <span class="preprocessor"></span>        ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
00567         ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
00568         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00569     }
00570 
00571     <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> -= NumberOfPages;
00572     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> -= NumberOfPages;
00573 
00574     ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
00575 
00576     <span class="comment">//</span>
00577     <span class="comment">// Check for outstanding promises that cannot be broken.</span>
00578     <span class="comment">//</span>
00579 
00580     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00581 
00582     MaxPages = <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() - 100;
00583 
00584     <span class="keywordflow">if</span> ((SPFN_NUMBER)NumberOfPages &gt; MaxPages) {
00585 <span class="preprocessor">#if DBG</span>
00586 <span class="preprocessor"></span>        MiDynmemData[2] += 1;
00587 <span class="preprocessor">#endif</span>
00588 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00589         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00590         <span class="keywordflow">goto</span> giveup2;
00591     }
00592 
00593     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= NumberOfPages;
00594     <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> -= NumberOfPages;
00595 
00596     <span class="comment">//</span>
00597     <span class="comment">// The range must be contained in a single entry.  It is permissible for</span>
00598     <span class="comment">// it to be part of a single entry, but it must not cross multiple entries.</span>
00599     <span class="comment">//</span>
00600 
00601     Additional = (ULONG)-2;
00602 
00603     start = 0;
00604     <span class="keywordflow">do</span> {
00605 
00606         Page = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
00607         LastPage = Page + <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
00608 
00609         <span class="keywordflow">if</span> ((StartPage &gt;= Page) &amp;&amp; (EndPage &lt;= LastPage)) {
00610             <span class="keywordflow">if</span> ((StartPage == Page) &amp;&amp; (EndPage == LastPage)) {
00611                 Additional = (ULONG)-1;
00612             }
00613             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((StartPage == Page) || (EndPage == LastPage)) {
00614                 Additional = 0;
00615             }
00616             <span class="keywordflow">else</span> {
00617                 Additional = 1;
00618             }
00619             <span class="keywordflow">break</span>;
00620         }
00621 
00622         start += 1;
00623 
00624     } <span class="keywordflow">while</span> (start != <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>);
00625 
00626     <span class="keywordflow">if</span> (Additional == (ULONG)-2) {
00627 <span class="preprocessor">#if DBG</span>
00628 <span class="preprocessor"></span>        MiDynmemData[3] += 1;
00629 <span class="preprocessor">#endif</span>
00630 <span class="preprocessor"></span>        <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += NumberOfPages;
00631         <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> += NumberOfPages;
00632         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00633         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_CONFLICTING_ADDRESSES;
00634         <span class="keywordflow">goto</span> giveup2;
00635     }
00636 
00637     <span class="keywordflow">for</span> (Pfn1 = StartPfn; Pfn1 &lt; EndPfn; Pfn1 += 1) {
00638         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested = 1;
00639     }
00640 
00641     <span class="comment">//</span>
00642     <span class="comment">// The free and zero lists must be pruned now before releasing the PFN</span>
00643     <span class="comment">// lock otherwise if another thread allocates the page from these lists,</span>
00644     <span class="comment">// the allocation will clear the RemovalRequested flag forever.</span>
00645     <span class="comment">//</span>
00646 
00647     RemovedPages = <a class="code" href="../../d9/d3/dynmem_8c.html#a3">MiRemovePhysicalPages</a> (StartPage, EndPage);
00648 
00649     <span class="keywordflow">if</span> (RemovedPages != NumberOfPages) {
00650 
00651 <span class="preprocessor">#if DBG</span>
00652 <span class="preprocessor"></span>retry:
00653 <span class="preprocessor">#endif</span>
00654 <span class="preprocessor"></span>    
00655         Pfn1 = StartPfn;
00656     
00657         InterlockedIncrement (&amp;MiDelayPageFaults);
00658     
00659         <span class="keywordflow">for</span> (i = 0; i &lt; 5; i += 1) {
00660     
00661             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00662     
00663             <span class="comment">//</span>
00664             <span class="comment">// Attempt to move pages to the standby list.  Note that only the</span>
00665             <span class="comment">// pages with RemovalRequested set are moved.</span>
00666             <span class="comment">//</span>
00667     
00668             <a class="code" href="../../d9/d3/dynmem_8c.html#a2">MiTrimRemovalPagesOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00669     
00670             <a class="code" href="../../d5/d0/wsmanage_8c.html#a47">MiEmptyAllWorkingSets</a> ();
00671     
00672             <a class="code" href="../../d9/d3/dynmem_8c.html#a2">MiTrimRemovalPagesOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00673     
00674             <a class="code" href="../../d6/d3/modwrite_8c.html#a57">MiFlushAllPages</a> ();
00675     
00676             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;MmHalfSecond);
00677     
00678             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00679     
00680             RemovedPages += <a class="code" href="../../d9/d3/dynmem_8c.html#a3">MiRemovePhysicalPages</a> (StartPage, EndPage);
00681     
00682             <span class="keywordflow">if</span> (RemovedPages == NumberOfPages) {
00683                 <span class="keywordflow">break</span>;
00684             }
00685     
00686             <span class="comment">//</span>
00687             <span class="comment">// RemovedPages doesn't include pages that were freed directly to</span>
00688             <span class="comment">// the bad page list via MiDecrementReferenceCount.  So use the above</span>
00689             <span class="comment">// check purely as an optimization - and walk here when necessary.</span>
00690             <span class="comment">//</span>
00691     
00692             <span class="keywordflow">for</span> ( ; Pfn1 &lt; EndPfn; Pfn1 += 1) {
00693                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>) {
00694                     <span class="keywordflow">break</span>;
00695                 }
00696             }
00697     
00698             <span class="keywordflow">if</span> (Pfn1 == EndPfn) {
00699                 RemovedPages = NumberOfPages;
00700                 <span class="keywordflow">break</span>;
00701             }
00702         }
00703 
00704         InterlockedDecrement (&amp;MiDelayPageFaults);
00705     }
00706 
00707     <span class="keywordflow">if</span> (RemovedPages != NumberOfPages) {
00708 <span class="preprocessor">#if DBG</span>
00709 <span class="preprocessor"></span>        MiDynmemData[4] += 1;
00710         <span class="keywordflow">if</span> (MiShowStuckPages != 0) {
00711 
00712             RemovedPages = 0;
00713             <span class="keywordflow">for</span> (Pfn1 = StartPfn; Pfn1 &lt; EndPfn; Pfn1 += 1) {
00714                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>) {
00715                     RemovedPages += 1;
00716                 }
00717             }
00718 
00719             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (RemovedPages != 0);
00720 
00721             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MmRemovePhysicalMemory : could not get %d of %d pages\n"</span>,
00722                 RemovedPages, NumberOfPages);
00723 
00724             <span class="keywordflow">if</span> (MiShowStuckPages &amp; 0x2) {
00725 
00726                 ULONG PfnsPrinted;
00727                 ULONG EnoughShown;
00728                 <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> FirstPfn;
00729                 PFN_COUNT PfnCount;
00730 
00731                 PfnCount = 0;
00732                 PfnsPrinted = 0;
00733                 EnoughShown = 100;
00734     
00735                 <span class="keywordflow">if</span> (MiShowStuckPages &amp; 0x4) {
00736                     EnoughShown = (ULONG)-1;
00737                 }
00738     
00739                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Stuck PFN list: "</span>);
00740                 <span class="keywordflow">for</span> (Pfn1 = StartPfn; Pfn1 &lt; EndPfn; Pfn1 += 1) {
00741                     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>) {
00742                         <span class="keywordflow">if</span> (PfnCount == 0) {
00743                             FirstPfn = Pfn1;
00744                         }
00745                         PfnCount += 1;
00746                     }
00747                     <span class="keywordflow">else</span> {
00748                         <span class="keywordflow">if</span> (PfnCount != 0) {
00749                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"%x -&gt; %x ; "</span>, FirstPfn - MmPfnDatabase,
00750                                                     (FirstPfn - MmPfnDatabase) + PfnCount - 1);
00751                             PfnsPrinted += 1;
00752                             <span class="keywordflow">if</span> (PfnsPrinted == EnoughShown) {
00753                                 <span class="keywordflow">break</span>;
00754                             }
00755                             PfnCount = 0;
00756                         }
00757                     }
00758                 }
00759                 <span class="keywordflow">if</span> (PfnCount != 0) {
00760                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"%x -&gt; %x ; "</span>, FirstPfn - MmPfnDatabase,
00761                                             (FirstPfn - MmPfnDatabase) + PfnCount - 1);
00762                 }
00763                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
00764             }
00765             <span class="keywordflow">if</span> (MiShowStuckPages &amp; 0x8) {
00766                 DbgBreakPoint ();
00767             }
00768             <span class="keywordflow">if</span> (MiShowStuckPages &amp; 0x10) {
00769                 <span class="keywordflow">goto</span> retry;
00770             }
00771         }
00772 <span class="preprocessor">#endif</span>
00773 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00774         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00775         <span class="keywordflow">goto</span> giveup;
00776     }
00777 
00778 <span class="preprocessor">#if DBG</span>
00779 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (Pfn1 = StartPfn; Pfn1 &lt; EndPfn; Pfn1 += 1) {
00780         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == BadPageList);
00781     }
00782 <span class="preprocessor">#endif</span>
00783 <span class="preprocessor"></span>
00784     <span class="comment">//</span>
00785     <span class="comment">// All the pages in the range have been removed.  Update the physical</span>
00786     <span class="comment">// memory blocks and other associated housekeeping.</span>
00787     <span class="comment">//</span>
00788 
00789     <span class="keywordflow">if</span> (Additional == 0) {
00790 
00791         <span class="comment">//</span>
00792         <span class="comment">// The range can be split off from an end of an existing chunk so no</span>
00793         <span class="comment">// pool growth or shrinkage is required.</span>
00794         <span class="comment">//</span>
00795 
00796         NewPhysicalMemoryBlock = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>;
00797         OldPhysicalMemoryBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00798     }
00799     <span class="keywordflow">else</span> {
00800 
00801         <span class="comment">//</span>
00802         <span class="comment">// The range cannot be split off from an end of an existing chunk so</span>
00803         <span class="comment">// pool growth or shrinkage is required.</span>
00804         <span class="comment">//</span>
00805 
00806         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00807 
00808         i = (<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PHYSICAL_MEMORY_DESCRIPTOR</a>) +
00809              (<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html">PHYSICAL_MEMORY_RUN</a>) * (<a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> + Additional)));
00810 
00811         NewPhysicalMemoryBlock = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
00812                                                         i,
00813                                                         '  mM');
00814 
00815         <span class="keywordflow">if</span> (NewPhysicalMemoryBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00816             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00817 <span class="preprocessor">#if DBG</span>
00818 <span class="preprocessor"></span>            MiDynmemData[5] += 1;
00819 <span class="preprocessor">#endif</span>
00820 <span class="preprocessor"></span>            <span class="keywordflow">goto</span> giveup;
00821         }
00822 
00823         OldPhysicalMemoryBlock = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>;
00824         RtlZeroMemory (NewPhysicalMemoryBlock, i);
00825 
00826         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00827     }
00828 
00829     <span class="comment">//</span>
00830     <span class="comment">// Remove or split the requested range from the existing memory block.</span>
00831     <span class="comment">//</span>
00832 
00833     NewPhysicalMemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a> + Additional;
00834     NewPhysicalMemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o1">NumberOfPages</a> - NumberOfPages;
00835 
00836     NewRun = &amp;NewPhysicalMemoryBlock-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[0];
00837     start = 0;
00838     Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00839 
00840     <span class="keywordflow">do</span> {
00841 
00842         Page = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
00843         LastPage = Page + <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
00844 
00845         <span class="keywordflow">if</span> (Inserted == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00846 
00847             <span class="keywordflow">if</span> ((StartPage &gt;= Page) &amp;&amp; (EndPage &lt;= LastPage)) {
00848 
00849                 <span class="keywordflow">if</span> ((StartPage == Page) &amp;&amp; (EndPage == LastPage)) {
00850                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Additional == -1);
00851                     start += 1;
00852                     <span class="keywordflow">continue</span>;
00853                 }
00854                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((StartPage == Page) || (EndPage == LastPage)) {
00855                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Additional == 0);
00856                     <span class="keywordflow">if</span> (StartPage == Page) {
00857                         <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> += NumberOfPages;
00858                     }
00859                     <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> -= NumberOfPages;
00860                 }
00861                 <span class="keywordflow">else</span> {
00862                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Additional == 1);
00863 
00864                     OriginalLastPage = LastPage;
00865 
00866                     <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> =
00867                         StartPage - <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
00868 
00869                     *NewRun = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start];
00870                     NewRun += 1;
00871 
00872                     NewRun-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> = EndPage;
00873                     NewRun-&gt;<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a> = OriginalLastPage - EndPage;
00874                     NewRun += 1;
00875 
00876                     start += 1;
00877                     <span class="keywordflow">continue</span>;
00878                 }
00879 
00880                 Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00881             }
00882         }
00883 
00884         *NewRun = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start];
00885         NewRun += 1;
00886         start += 1;
00887 
00888     } <span class="keywordflow">while</span> (start != <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>);
00889 
00890     <span class="comment">//</span>
00891     <span class="comment">// Repoint the MmPhysicalMemoryBlock at the new chunk.</span>
00892     <span class="comment">// Free the old block after releasing the PFN lock.</span>
00893     <span class="comment">//</span>
00894 
00895     <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a> = NewPhysicalMemoryBlock;
00896 
00897     <span class="keywordflow">if</span> (EndPage - 1 == <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
00898         <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> = StartPage - 1;
00899     }
00900 
00901     <span class="comment">//</span>
00902     <span class="comment">// Throw away all the removed pages that are currently enqueued.</span>
00903     <span class="comment">//</span>
00904 
00905     <span class="keywordflow">for</span> (Pfn1 = StartPfn; Pfn1 &lt; EndPfn; Pfn1 += 1) {
00906 
00907         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == BadPageList);
00908         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 1);
00909 
00910         <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
00911 
00912         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink == 0);
00913         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink == 0);
00914         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
00915         <a class="code" href="../../d4/d8/mi_8h.html#a1">ASSERT64</a> (Pfn1-&gt;UsedPageTableEntries == 0);
00916 
00917         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = <a class="code" href="../../d9/d3/dynmem_8c.html#a0">PFN_REMOVED</a>;
00918         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ShortFlags = 0;
00919         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00920         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = 0;
00921     }
00922 
00923     <span class="comment">//</span>
00924     <span class="comment">// Now that the removed pages have been discarded, eliminate the PFN</span>
00925     <span class="comment">// entries that mapped them.  Straddling entries left over from an</span>
00926     <span class="comment">// adjacent earlier removal are not collapsed at this point.</span>
00927     <span class="comment">//</span>
00928     <span class="comment">//</span>
00929 
00930     PagesReleased = 0;
00931 
00932     <span class="keywordflow">if</span> (PfnDatabaseIsPhysical == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00933 
00934         VirtualAddress = (PVOID)<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(StartPage));
00935         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
00936         EndPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(EndPage)));
00937 
00938         <span class="keywordflow">while</span> (PointerPte &lt; EndPte) {
00939             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
00940             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00941             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
00942             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1);
00943             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
00944             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00945 <span class="preprocessor">#if DBG</span>
00946 <span class="preprocessor"></span>            Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
00947 <span class="preprocessor">#endif //DBG</span>
00948 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
00949     
00950             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (VirtualAddress,
00951                              TRUE,
00952                              TRUE,
00953                              (PHARDWARE_PTE)PointerPte,
00954                              <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
00955     
00956             PagesReleased += 1;
00957             PointerPte += 1;
00958             VirtualAddress = (PVOID)((PCHAR)VirtualAddress + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00959         }
00960 
00961         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += PagesReleased;
00962     }
00963 
00964 <span class="preprocessor">#if DBG</span>
00965 <span class="preprocessor"></span>    MiDynmemData[6] += 1;
00966 <span class="preprocessor">#endif</span>
00967 <span class="preprocessor"></span>
00968     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00969 
00970     <span class="keywordflow">if</span> (PagesReleased != 0) {
00971         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (PagesReleased);
00972     }
00973 
00974     ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
00975 
00976     <span class="keywordflow">if</span> (OldPhysicalMemoryBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00977         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (OldPhysicalMemoryBlock);
00978     }
00979 
00980     NumberOfBytes-&gt;QuadPart = (ULONGLONG)NumberOfPages * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00981 
00982     <span class="keywordflow">return</span> STATUS_SUCCESS;
00983 
00984 giveup:
00985 
00986     <span class="comment">//</span>
00987     <span class="comment">// All the pages in the range were not obtained.  Back everything out.</span>
00988     <span class="comment">//</span>
00989 
00990     PageFrameIndex = StartPage;
00991     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00992 
00993     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00994 
00995     <span class="keywordflow">while</span> (PageFrameIndex &lt; EndPage) {
00996 
00997         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 1);
00998 
00999         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested = 0;
01000 
01001         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>) &amp;&amp;
01002             (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ParityError == 0)) {
01003 
01004             <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
01005             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
01006                                 PageFrameIndex);
01007         }
01008 
01009         Pfn1 += 1;
01010         PageFrameIndex += 1;
01011     }
01012 
01013     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += NumberOfPages;
01014     <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> += NumberOfPages;
01015 
01016     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01017 
01018 giveup2:
01019 
01020     ExAcquireSpinLock (&amp;MmChargeCommitmentLock, &amp;OldIrql);
01021     <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a> += NumberOfPages;
01022     <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a> += NumberOfPages;
01023     ExReleaseSpinLock (&amp;MmChargeCommitmentLock, OldIrql);
01024 
01025     ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
01026 
01027     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01028 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a310" doxytag="mm.h::MmResetDriverPaging" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmResetDriverPaging           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>AddressWithinSection</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l02560">2560</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">MiLockCode()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06991">MiLookupDataTableEntry()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00115">MM_LOCK_BY_NONPAGE</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00082">MmDisablePagingExecutive</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>.
<p>
<pre class="fragment"><div>02566                    :
02567 
02568     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> resets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver paging to what <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image specified.
02569     Hence image sections such as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IAT, .text, .data will be locked
02570     down in memory.
02571 
02572     Note, there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no requirement that <a class="code" href="../../d2/d1/mm_8h.html#a311">MmPageEntireDriver</a> was called.
02573 
02574 Arguments:
02575 
02576      AddressWithinSection - Supplies an address within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver, e.g.
02577                             <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>.
02578 
02579 Return Value:
02580 
02581     None.
02582 
02583 Environment:
02584 
02585     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
02586 
02587 --*/
02588 
02589 {
02590     PLDR_DATA_TABLE_ENTRY DataTableEntry;
02591     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02592     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02593     PVOID Base;
02594     ULONG i;
02595     PIMAGE_NT_HEADERS NtHeaders;
02596     PIMAGE_SECTION_HEADER FoundSection;
02597     KIRQL OldIrql;
02598     KIRQL OldIrqlWs;
02599 
02600     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02601 
02602     <span class="comment">//</span>
02603     <span class="comment">// Don't page kernel mode code if disabled via registry.</span>
02604     <span class="comment">//</span>
02605 
02606     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a26">MmDisablePagingExecutive</a>) {
02607         <span class="keywordflow">return</span>;
02608     }
02609 
02610     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(AddressWithinSection)) {
02611         <span class="keywordflow">return</span>;
02612     }
02613 
02614     <span class="comment">//</span>
02615     <span class="comment">// If the driver has pagable code, make it paged.</span>
02616     <span class="comment">//</span>
02617 
02618     DataTableEntry = <a class="code" href="../../d4/d8/mi_8h.html#a874">MiLookupDataTableEntry</a> (AddressWithinSection, FALSE);
02619 
02620     <span class="keywordflow">if</span> ((DataTableEntry-&gt;SectionPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02621         (DataTableEntry-&gt;SectionPointer != (PVOID)-1)) {
02622 
02623         <span class="comment">//</span>
02624         <span class="comment">// Driver is mapped by image hence already paged.</span>
02625         <span class="comment">//</span>
02626 
02627         <span class="keywordflow">return</span>;
02628     }
02629 
02630     Base = DataTableEntry-&gt;DllBase;
02631 
02632     NtHeaders = (PIMAGE_NT_HEADERS)<a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Base);
02633 
02634     FoundSection = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeaders +
02635                         <span class="keyword">sizeof</span>(ULONG) +
02636                         <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
02637                         NtHeaders-&gt;FileHeader.SizeOfOptionalHeader
02638                         );
02639 
02640     i = NtHeaders-&gt;FileHeader.NumberOfSections;
02641     PointerPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02642 
02643     <span class="keywordflow">while</span> (i &gt; 0) {
02644 <span class="preprocessor">#if DBG</span>
02645 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((*(PULONG)FoundSection-&gt;Name == 'tini') ||
02646                 (*(PULONG)FoundSection-&gt;Name == 'egap')) {
02647                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"driver %wZ has lower case sections (init or pagexxx)\n"</span>,
02648                     &amp;DataTableEntry-&gt;FullDllName);
02649             }
02650 <span class="preprocessor">#endif</span>
02651 <span class="preprocessor"></span>
02652         <span class="comment">//</span>
02653         <span class="comment">// Don't lock down code for sections marked as discardable or</span>
02654         <span class="comment">// sections marked with the first 4 characters PAGE or .eda</span>
02655         <span class="comment">// (for the .edata section) or INIT.</span>
02656         <span class="comment">//</span>
02657 
02658         <span class="keywordflow">if</span> (((FoundSection-&gt;Characteristics &amp; IMAGE_SCN_MEM_DISCARDABLE) != 0) ||
02659            (*(PULONG)FoundSection-&gt;Name == 'EGAP') ||
02660            (*(PULONG)FoundSection-&gt;Name == 'ade.') ||
02661            (*(PULONG)FoundSection-&gt;Name == 'TINI')) {
02662 
02663             NOTHING;
02664 
02665         } <span class="keywordflow">else</span> {
02666 
02667             <span class="comment">//</span>
02668             <span class="comment">// This section is nonpagable.</span>
02669             <span class="comment">//</span>
02670 
02671             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (
02672                                    (PCHAR)Base + FoundSection-&gt;VirtualAddress);
02673             LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PCHAR)Base +
02674                                        FoundSection-&gt;VirtualAddress +
02675                                       (FoundSection-&gt;SizeOfRawData - 1));
02676             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte &lt;= LastPte);
02677             <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
02678             <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrqlWs);
02679             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02680             <a class="code" href="../../d4/d8/mi_8h.html#a873">MiLockCode</a> (PointerPte, LastPte, MM_LOCK_BY_NONPAGE);
02681             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02682             <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrqlWs);
02683             <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
02684         }
02685         i -= 1;
02686         FoundSection += 1;
02687     }
02688     <span class="keywordflow">return</span>;
02689 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a200" doxytag="mm.h::MmResourcesAvailable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MmResourcesAvailable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a97">EX_POOL_PRIORITY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Priority</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00589">589</a> of file <a class="el" href="../../d2/d5/allocpag_8c-source.html">allocpag.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00050">BASE_POOL_TYPE_MASK</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d5/d8/ex_8h.html#a97">EX_POOL_PRIORITY</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a330a194">HighPoolPriority</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00143">MI_MEMORY_MAKER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05225">MI_SESSION_POOL_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04995">MI_UNUSED_SEGMENTS_SURPLUS</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l05023">MiIssuePageExtendRequestNoWait()</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00098">MmAllocatedNonPagedPool</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00062">MmMaximumNonPagedPoolInBytes</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00069">MmPagedPoolInfo</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00074">MmSizeOfPagedPoolInBytes</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00100">MmTotalCommitLimitMaximum</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00040">MmTotalCommittedPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04948">MmUnusedSegmentCleanup</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00141">MmUnusedSegmentForceFree</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04946">MmUnusedSegmentList</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00052">MUST_SUCCEED_POOL_TYPE_MASK</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a330a191">NormalPoolPriority</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05451">_MM_SESSION_SPACE::PagedPoolBytes</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d1/pool_8h-source.html#l00056">SESSION_POOL_MASK</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00993">ExAllocatePoolWithTagPriority()</a>.
<p>
<pre class="fragment"><div>00597                    :
00598 
00599     This function examines various resources to determine <span class="keywordflow">if</span> <span class="keyword">this</span>
00600     <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocation should be allowed to proceed.
00601 
00602 Arguments:
00603 
00604     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to retrieve information about.
00605 
00606     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to allocate.
00607 
00608     Priority - Supplies an indication as to how important <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that <span class="keyword">this</span>
00609                request succeed under <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> available resource conditions.                       
00610 Return Value:
00611 
00612     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocation should be allowed to proceed, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
00613 
00614 --*/
00615 
00616 {
00617     KIRQL OldIrql;
00618     PFN_NUMBER NumberOfPages;
00619     SIZE_T FreePoolInBytes;
00620     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00621     LOGICAL SignalDereferenceThread;
00622 
00623     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Priority != HighPoolPriority);
00624     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PoolType &amp; MUST_SUCCEED_POOL_TYPE_MASK) == 0);
00625 
00626     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (NumberOfBytes);
00627 
00628     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {
00629         FreePoolInBytes = <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> - (<a class="code" href="../../d9/d5/4_2kddata_8c.html#a52">MmAllocatedNonPagedPool</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00630     }
00631     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>) {
00632         FreePoolInBytes = <a class="code" href="../../d4/d8/mi_8h.html#a337">MI_SESSION_POOL_SIZE</a> - <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o10">PagedPoolBytes</a>;
00633     }
00634     <span class="keywordflow">else</span> {
00635         FreePoolInBytes = <a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a> - (<a class="code" href="../../d8/d5/kddata_8c.html#a27">MmPagedPoolInfo</a>.AllocatedPagedPool &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00636     }
00637 
00638     <span class="comment">//</span>
00639     <span class="comment">// Check available VA space.</span>
00640     <span class="comment">//</span>
00641 
00642     <span class="keywordflow">if</span> (Priority == <a class="code" href="../../d5/d8/ex_8h.html#a330a191">NormalPoolPriority</a>) {
00643         <span class="keywordflow">if</span> ((SIZE_T)NumberOfBytes + 512*1024 &gt; FreePoolInBytes) {
00644             Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
00645             <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d6/allocpag_8c.html#a1">MI_MEMORY_MAKER</a>(Thread)) {
00646                 <span class="keywordflow">goto</span> nopool;
00647             }
00648         }
00649     }
00650     <span class="keywordflow">else</span> {
00651         <span class="keywordflow">if</span> ((SIZE_T)NumberOfBytes + 2*1024*1024 &gt; FreePoolInBytes) {
00652             Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
00653             <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d6/allocpag_8c.html#a1">MI_MEMORY_MAKER</a>(Thread)) {
00654                 <span class="keywordflow">goto</span> nopool;
00655             }
00656         }
00657     }
00658 
00659     <span class="comment">//</span>
00660     <span class="comment">// Paged allocations (session and normal) can also fail for lack of commit.</span>
00661     <span class="comment">//</span>
00662 
00663     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
00664         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a> + NumberOfPages &gt; <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a>) {
00665             Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
00666             <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d6/allocpag_8c.html#a1">MI_MEMORY_MAKER</a>(Thread)) {
00667                 <a class="code" href="../../d6/d3/modwrite_8c.html#a59">MiIssuePageExtendRequestNoWait</a> (NumberOfPages);
00668                 <span class="keywordflow">goto</span> nopool;
00669             }
00670         }
00671     }
00672 
00673     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00674 
00675 nopool:
00676 
00677     <span class="comment">//</span>
00678     <span class="comment">// Running low on pool - if this request is not for session pool,</span>
00679     <span class="comment">// force unused segment trimming when appropriate.</span>
00680     <span class="comment">//</span>
00681 
00682     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>) == 0) {
00683 
00684         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a328">MI_UNUSED_SEGMENTS_SURPLUS</a>()) {
00685             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmUnusedSegmentCleanup, 0, FALSE);
00686         }
00687         <span class="keywordflow">else</span> {
00688             SignalDereferenceThread = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00689             <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
00690             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/allocpag_8c.html#a11">MmUnusedSegmentForceFree</a> == 0) {
00691                 <span class="keywordflow">if</span> (!IsListEmpty(&amp;MmUnusedSegmentList)) {
00692                     SignalDereferenceThread = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00693                     <a class="code" href="../../d1/d6/allocpag_8c.html#a11">MmUnusedSegmentForceFree</a> = 30;
00694                 }
00695             }
00696             <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00697             <span class="keywordflow">if</span> (SignalDereferenceThread == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00698                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmUnusedSegmentCleanup, 0, FALSE);
00699             }
00700         }
00701     }
00702 
00703     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00704 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a298" doxytag="mm.h::MmReturnMemoryForHibernate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmReturnMemoryForHibernate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Mdl</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l08038">8038</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
<pre class="fragment"><div>08044                    :
08045 
08046     Returns memory from MmGatherMemoryForHibername.
08047 
08048 Arguments:
08049 
08050     Mdl - Supplies an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start VA field should be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.  The length
08051           field indicates how many pages to obtain.
08052 
08053 Return Value:
08054 
08055     None.
08056 
08057 Environment:
08058 
08059     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
08060 
08061 --*/
08062 
08063 {
08064     KIRQL OldIrql;
08065     PFN_NUMBER PagesNeeded;
08066     PPFN_NUMBER Pages;
08067 
08068     PagesNeeded = (Mdl-&gt;ByteCount &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
08069     Pages = (PPFN_NUMBER)(Mdl + 1);
08070 
08071     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
08072     <span class="keywordflow">do</span> {
08073         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (*Pages);
08074         Pages += 1;
08075         PagesNeeded -= 1;
08076     } <span class="keywordflow">while</span> (PagesNeeded);
08077     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
08078     <span class="keywordflow">return</span>;
08079 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a330" doxytag="mm.h::MmReturnPoolQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmReturnPoolQuota           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnedQuota</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01212">1212</a> of file <a class="el" href="../../d7/d0/mmquota_8c-source.html">mmquota.c</a>.
<p>
References <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01115">MmTotalNonPagedPoolQuota</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01114">MmTotalPagedPoolQuota</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>.
<p>
<pre class="fragment"><div>01219                    :
01220 
01221     Returns <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> quota.
01222 
01223 Arguments:
01224 
01225     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota to be returned.
01226 
01227     ReturnedQuota - Number of bytes returned.
01228 
01229 Return Value:
01230 
01231     NONE.
01232 
01233 Environment:
01234 
01235     Kernel mode, QUOTA SPIN <a class="code" href="../../d4/d2/struct__LOCK.html">LOCK</a> HELD!!
01236 
01237 --*/
01238 
01239 {
01240 
01241     <span class="keywordflow">if</span> (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
01242         <a class="code" href="../../d6/d1/mmquota_8c.html#a12">MmTotalPagedPoolQuota</a> -= ReturnedQuota;
01243     } <span class="keywordflow">else</span> {
01244         <a class="code" href="../../d6/d1/mmquota_8c.html#a13">MmTotalNonPagedPoolQuota</a> -= ReturnedQuota;
01245     }
01246 
01247     <span class="keywordflow">return</span>;
01248 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a313" doxytag="mm.h::MmSecureVirtualMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI HANDLE MmSecureVirtualMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProbeMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l04177">4177</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02379">_MMSECURE_ENTRY::EndVpn</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02387">_MMVAD::LeftChild</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02380">_MMSECURE_ENTRY::List</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01090">LOCK_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01044">LOCK_WS_UNSAFE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00437">MiDoesPdeExistAndMakeValid()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01980">MiDoesPpeExistAndMakeValid</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d4/d8/mi_8h.html#a775">MiInsertConflictInList()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00380">MiLocateAddress()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02721">MiPhysicalViewAdjuster()</a>, <a class="el" href="../../d4/d8/mi_8h.html#a774">MiRemoveConflictFromList()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00139">MM_EXECUTE_READWRITE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00140">MM_EXECUTE_WRITECOPY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00145">MM_NOACCESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d4/d8/mi_8h.html#a487">MMSECURE_ENTRY</a>, <a class="el" href="../../d4/d8/mi_8h.html#a489">MMVAD</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00030">MMVADKEY</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02386">_MMVAD::Parent</a>, <a class="el" href="../../d4/d8/mi_8h.html#a488">PMMSECURE_ENTRY</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02388">_MMVAD::RightChild</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02378">_MMSECURE_ENTRY::StartVpn</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o13">_MMVAD::u2</a>, <a class="el" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">_MMSECURE_ENTRY::u2</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o16">_MMVAD::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01101">UNLOCK_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01085">UNLOCK_WS_UNSAFE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00257">_EPROCESS::VadFreeHint</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00228">_EPROCESS::VadHint</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00227">_EPROCESS::VadRoot</a>.
<p>
<pre class="fragment"><div>04185                    :
04186 
04187     This routine probes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested address range and protects
04188     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address range from having its protection <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>
04189     more restricted and being deleted.
04190 
04191     <a class="code" href="../../d2/d1/mm_8h.html#a314">MmUnsecureVirtualMemory</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to allow <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range to <span class="keywordflow">return</span>
04192     to a normal state.
04193 
04194 Arguments:
04195 
04196     Address - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address to probe and secure.
04197 
04198     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range to secure.
04199 
04200     ProbeMode - Supplies one of PAGE_READONLY or PAGE_READWRITE.
04201 
04202 Return Value:
04203 
04204     Returns a handle to be used to unsecure <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
04205     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range could not be locked because of protection
04206     problems or noncommitted memory, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value (HANDLE)0
04207     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
04208 
04209 Environment:
04210 
04211     Kernel Mode.
04212 
04213 --*/
04214 
04215 {
04216     ULONG_PTR EndAddress;
04217     PVOID StartAddress;
04218     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> Temp;
04219     ULONG Probe;
04220     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
04221     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
04222     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> NewVad;
04223     <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a> Secure;
04224     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
04225     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
04226     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
04227     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
04228     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
04229     <a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html">MMLOCK_CONFLICT</a> Conflict;
04230     ULONG Waited;
04231 
04232     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04233 
04234     <span class="keywordflow">if</span> ((ULONG_PTR)Address + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt; (ULONG_PTR)MM_HIGHEST_USER_ADDRESS || (ULONG_PTR)Address + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt;= (ULONG_PTR)Address) {
04235         <span class="keywordflow">return</span> (HANDLE)0;
04236     }
04237 
04238     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE)0;
04239 
04240     Probe = (ProbeMode == PAGE_READONLY);
04241 
04242     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
04243     StartAddress = Address;
04244 
04245     <a class="code" href="../../d4/d8/mi_8h.html#a160">LOCK_ADDRESS_SPACE</a> (Process);
04246 
04247     <span class="comment">//</span>
04248     <span class="comment">// Check for a private committed VAD first instead of probing to avoid all</span>
04249     <span class="comment">// the page faults and zeroing.  If we find one, then we run the PTEs</span>
04250     <span class="comment">// instead.</span>
04251     <span class="comment">//</span>
04252 
04253     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt;= 64 * 1024) {
04254         EndAddress = (ULONG_PTR)StartAddress + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - 1;
04255         Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (StartAddress);
04256 
04257         <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04258             <span class="keywordflow">goto</span> Return1;
04259         }
04260 
04261         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
04262             <span class="keywordflow">goto</span> Return1;
04263         }
04264 
04265         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.MemCommit == 0) {
04266             <span class="keywordflow">goto</span> LongWay;
04267         }
04268 
04269         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 0) {
04270             <span class="keywordflow">goto</span> LongWay;
04271         }
04272 
04273         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping == 1) {
04274             <span class="keywordflow">goto</span> LongWay;
04275         }
04276 
04277         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection);
04278 
04279         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartAddress) &lt; Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) ||
04280             (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndAddress) &gt; Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>)) {
04281             <span class="keywordflow">goto</span> Return1;
04282         }
04283 
04284         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
04285             <span class="keywordflow">goto</span> LongWay;
04286         }
04287 
04288         <span class="keywordflow">if</span> (ProbeMode == PAGE_READONLY) {
04289             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection &gt; <a class="code" href="../../d4/d8/mi_8h.html#a42">MM_EXECUTE_WRITECOPY</a>) {
04290                 <span class="keywordflow">goto</span> LongWay;
04291             }
04292         }
04293         <span class="keywordflow">else</span> {
04294             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection != <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a> &amp;&amp;
04295                 Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection != <a class="code" href="../../d4/d8/mi_8h.html#a41">MM_EXECUTE_READWRITE</a>) {
04296                     <span class="keywordflow">goto</span> LongWay;
04297             }
04298         }
04299 
04300         <span class="comment">//</span>
04301         <span class="comment">// Check individual page permissions.</span>
04302         <span class="comment">//</span>
04303 
04304         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartAddress);
04305         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
04306         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartAddress);
04307         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndAddress);
04308 
04309         <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
04310 
04311         <span class="keywordflow">do</span> {
04312 
04313             <span class="keywordflow">while</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
04314                                                Process,
04315                                                FALSE,
04316                                                &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04317                 <span class="comment">//</span>
04318                 <span class="comment">// Page directory parent entry is empty, go to the next one.</span>
04319                 <span class="comment">//</span>
04320 
04321                 PointerPpe += 1;
04322                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
04323                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
04324                 <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
04325                     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04326                     <span class="keywordflow">goto</span> EditVad;
04327                 }
04328             }
04329 
04330             Waited = 0;
04331 
04332             <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
04333                                                Process,
04334                                                FALSE,
04335                                                &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04336                 <span class="comment">//</span>
04337                 <span class="comment">// This page directory entry is empty, go to the next one.</span>
04338                 <span class="comment">//</span>
04339 
04340                 PointerPde += 1;
04341                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
04342                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
04343                 <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
04344                     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04345                     <span class="keywordflow">goto</span> EditVad;
04346                 }
04347 <span class="preprocessor">#if defined (_WIN64)</span>
04348 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
04349                     Waited = 1;
04350                     <span class="keywordflow">break</span>;
04351                 }
04352 <span class="preprocessor">#endif</span>
04353 <span class="preprocessor"></span>            }
04354 
04355         } <span class="keywordflow">while</span> (Waited != 0);
04356 
04357         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
04358 
04359             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
04360 
04361                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
04362                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
04363 
04364                 <span class="keywordflow">do</span> {
04365 
04366                     <span class="keywordflow">while</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
04367                                                        Process,
04368                                                        FALSE,
04369                                                        &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04370                         <span class="comment">//</span>
04371                         <span class="comment">// Page directory parent entry is empty, go to the next one.</span>
04372                         <span class="comment">//</span>
04373 
04374                         PointerPpe += 1;
04375                         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
04376                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
04377 
04378                         <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
04379                             <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04380                             <span class="keywordflow">goto</span> EditVad;
04381                         }
04382                     }
04383 
04384                     Waited = 0;
04385 
04386                     <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
04387                                                        Process,
04388                                                        FALSE,
04389                                                        &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04390                         <span class="comment">//</span>
04391                         <span class="comment">// This page directory entry is empty, go to the next one.</span>
04392                         <span class="comment">//</span>
04393 
04394                         PointerPde += 1;
04395                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
04396                         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
04397                         <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
04398                             <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04399                             <span class="keywordflow">goto</span> EditVad;
04400                         }
04401 <span class="preprocessor">#if defined (_WIN64)</span>
04402 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPde)) {
04403                             Waited = 1;
04404                             <span class="keywordflow">break</span>;
04405                         }
04406 <span class="preprocessor">#endif</span>
04407 <span class="preprocessor"></span>                    }
04408 
04409                 } <span class="keywordflow">while</span> (Waited != 0);
04410             }
04411             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) {
04412                 <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04413                 <span class="keywordflow">goto</span> LongWay;
04414             }
04415             PointerPte += 1;
04416         }
04417         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04418     }
04419     <span class="keywordflow">else</span> {
04420 LongWay:
04421 
04422         <a class="code" href="../../d4/d8/mi_8h.html#a775">MiInsertConflictInList</a> (&amp;Conflict);
04423 
04424         <span class="keywordflow">try</span> {
04425 
04426             <span class="keywordflow">if</span> (ProbeMode == PAGE_READONLY) {
04427 
04428                 EndAddress = (ULONG_PTR)Address + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - 1;
04429                 EndAddress = (EndAddress &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
04430 
04431                 <span class="keywordflow">do</span> {
04432                     Temp = *(<span class="keyword">volatile</span> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> *)Address;
04433                     Address = (PVOID)(((ULONG_PTR)Address &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
04434                 } <span class="keywordflow">while</span> ((ULONG_PTR)Address != EndAddress);
04435             } <span class="keywordflow">else</span> {
04436                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> (Address, (ULONG)Size, 1); <span class="comment">// ****** temp ******</span>
04437             }
04438 
04439         } except (EXCEPTION_EXECUTE_HANDLER) {
04440             <a class="code" href="../../d4/d8/mi_8h.html#a774">MiRemoveConflictFromList</a> (&amp;Conflict);
04441             <span class="keywordflow">goto</span> Return1;
04442         }
04443 
04444         <a class="code" href="../../d4/d8/mi_8h.html#a774">MiRemoveConflictFromList</a> (&amp;Conflict);
04445 
04446         <span class="comment">//</span>
04447         <span class="comment">// Locate VAD and add in secure descriptor.</span>
04448         <span class="comment">//</span>
04449 
04450         EndAddress = (ULONG_PTR)StartAddress + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - 1;
04451         Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (StartAddress);
04452 
04453         <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04454             <span class="keywordflow">goto</span> Return1;
04455         }
04456 
04457         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
04458             <span class="keywordflow">goto</span> Return1;
04459         }
04460 
04461         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartAddress) &lt; Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) ||
04462             (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndAddress) &gt; Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>)) {
04463 
04464             <span class="comment">//</span>
04465             <span class="comment">// Not within the section virtual address descriptor,</span>
04466             <span class="comment">// return an error.</span>
04467             <span class="comment">//</span>
04468 
04469             <span class="keywordflow">goto</span> Return1;
04470         }
04471     }
04472 
04473 EditVad:
04474 
04475     <span class="comment">//</span>
04476     <span class="comment">// If this is a short VAD, it needs to be reallocated as a large</span>
04477     <span class="comment">// VAD.</span>
04478     <span class="comment">//</span>
04479 
04480     <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory) &amp;&amp; (!Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange)) {
04481 
04482         NewVad = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
04483                                         <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>),
04484                                         MMVADKEY);
04485         <span class="keywordflow">if</span> (NewVad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04486             <span class="keywordflow">goto</span> Return1;
04487         }
04488 
04489         RtlZeroMemory (NewVad, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>));
04490         RtlCopyMemory (NewVad, Vad, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html">MMVAD_SHORT</a>));
04491         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 1;
04492         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured = 1;
04493         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.StoredInVad = 1;
04494         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.ReadOnly = Probe;
04495         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.StartVpn = (ULONG_PTR)StartAddress;
04496         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.EndVpn = EndAddress;
04497 
04498         <span class="comment">//</span>
04499         <span class="comment">// Replace the current VAD with this expanded VAD.</span>
04500         <span class="comment">//</span>
04501 
04502         <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
04503         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>) {
04504             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o4">RightChild</a> == Vad) {
04505                 Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o4">RightChild</a> = NewVad;
04506             } <span class="keywordflow">else</span> {
04507                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o3">LeftChild</a> == Vad);
04508                 Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o3">LeftChild</a> = NewVad;
04509             }
04510         } <span class="keywordflow">else</span> {
04511             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o38">VadRoot</a> = NewVad;
04512         }
04513         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o3">LeftChild</a>) {
04514             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o3">LeftChild</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a> = NewVad;
04515         }
04516         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o4">RightChild</a>) {
04517             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o4">RightChild</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a> = NewVad;
04518         }
04519         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a> == Vad) {
04520             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o39">VadHint</a> = NewVad;
04521         }
04522         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a> == Vad) {
04523             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o57">VadFreeHint</a> = NewVad;
04524         }
04525 
04526         <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping == 1) ||
04527             (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.WriteWatch == 1)) {
04528 
04529             <a class="code" href="../../d4/d8/mi_8h.html#a894">MiPhysicalViewAdjuster</a> (Process, Vad, NewVad);
04530         }
04531 
04532         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
04533         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
04534         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE)&amp;NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.LongFlags2;
04535         <span class="keywordflow">goto</span> Return1;
04536     }
04537 
04538     <span class="comment">//</span>
04539     <span class="comment">// This is already a large VAD, add the secure entry.</span>
04540     <span class="comment">//</span>
04541 
04542     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured) {
04543 
04544         <span class="comment">//</span>
04545         <span class="comment">// This VAD already is secured.  Move the info out of the</span>
04546         <span class="comment">// block into pool.</span>
04547         <span class="comment">//</span>
04548 
04549         Secure = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
04550                                         <span class="keyword">sizeof</span> (<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">MMSECURE_ENTRY</a>),
04551                                         'eSmM');
04552         <span class="keywordflow">if</span> (Secure == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04553             <span class="keywordflow">goto</span> Return1;
04554         }
04555 
04556         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange == 1);
04557         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured = 0;
04558         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured = 1;
04559         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">u2</a>.LongFlags2 = (ULONG) Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.LongFlags;
04560         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">u2</a>.VadFlags2.StoredInVad = 0;
04561         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o3">StartVpn</a> = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.StartVpn;
04562         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o4">EndVpn</a> = Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.EndVpn;
04563 
04564         InitializeListHead (&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List);
04565         InsertTailList (&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List,
04566                         &amp;Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">List</a>);
04567     }
04568 
04569     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured) {
04570 
04571         <span class="comment">//</span>
04572         <span class="comment">// This VAD already has a secured element in its list, allocate and</span>
04573         <span class="comment">// add in the new secured element.</span>
04574         <span class="comment">//</span>
04575 
04576         Secure = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
04577                                         <span class="keyword">sizeof</span> (<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">MMSECURE_ENTRY</a>),
04578                                         'eSmM');
04579         <span class="keywordflow">if</span> (Secure == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04580             <span class="keywordflow">goto</span> Return1;
04581         }
04582 
04583         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">u2</a>.LongFlags2 = 0;
04584         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">u2</a>.VadFlags2.ReadOnly = Probe;
04585         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o3">StartVpn</a> = (ULONG_PTR)StartAddress;
04586         Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o4">EndVpn</a> = EndAddress;
04587 
04588         InsertTailList (&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List,
04589                         &amp;Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">List</a>);
04590         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE)Secure;
04591 
04592     } <span class="keywordflow">else</span> {
04593 
04594         <span class="comment">//</span>
04595         <span class="comment">// This list does not have a secure element.  Put it in the VAD.</span>
04596         <span class="comment">//</span>
04597 
04598         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 1;
04599         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured = 1;
04600         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.StoredInVad = 1;
04601         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.ReadOnly = Probe;
04602         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.StartVpn = (ULONG_PTR)StartAddress;
04603         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.Secured.EndVpn = EndAddress;
04604         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE)&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.LongFlags2;
04605     }
04606 
04607 Return1:
04608     <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (Process);
04609     <span class="keywordflow">return</span> <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
04610 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a195" doxytag="mm.h::MmSessionCreate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmSessionCreate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SessionId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l00974">974</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05280">MI_SESSION_SPACE_END</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l01544">MiDereferenceSession()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05611">MiSessionCount</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l00394">MiSessionCreateInternal()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01881">MiSessionInitializeWorkingSetList()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05211">MmSessionBase</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">_MM_SESSION_SPACE::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>.
<p>
<pre class="fragment"><div>00980                    :
00981 
00982     Called from <a class="code" href="../../d6/d8/sysinfo_8c.html#a50">NtSetSystemInformation</a>() to create a session space
00983     in the calling process with the specified SessionId.  An error is returned
00984     if the calling process already has a session Space.
00985 
00986 Arguments:
00987 
00988     SessionId - Supplies a pointer to place the resulting session <span class="keywordtype">id</span> in.
00989 
00990 Return Value:
00991 
00992     Various NTSTATUS error codes.
00993 
00994 Environment:
00995 
00996     Kernel mode, no mutexes held.
00997 
00998 --*/
00999 
01000 {
01001     KIRQL OldIrql;
01002     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01003     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
01004 <span class="preprocessor">#if DBG</span>
01005 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPde;
01006     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPde;
01007 <span class="preprocessor">#endif</span>
01008 <span class="preprocessor"></span>
01009     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01010         <span class="keywordflow">return</span> STATUS_INVALID_SYSTEM_SERVICE;
01011     }
01012 
01013     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01014 
01015     <span class="comment">//</span>
01016     <span class="comment">// A simple check to see if the calling process already has a session space.</span>
01017     <span class="comment">// No need to go through all this if it does.  Creation races are caught</span>
01018     <span class="comment">// below and recovered from regardless.</span>
01019     <span class="comment">//</span>
01020 
01021     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession == 1) {
01022         <span class="keywordflow">return</span> STATUS_ALREADY_COMMITTED;
01023     }
01024 
01025     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionLeader == 0) {
01026 
01027         <span class="comment">//</span>
01028         <span class="comment">// Only the session manager can create a session.</span>
01029         <span class="comment">//</span>
01030 
01031         <span class="keywordflow">return</span> STATUS_INVALID_SYSTEM_SERVICE;
01032     }
01033 
01034 <span class="preprocessor">#if DBG</span>
01035 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(MmSessionSpace) == FALSE);
01036 
01037 <span class="preprocessor">#if defined (_WIN64)</span>
01038 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(MmSessionBase))-&gt;u.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01039 <span class="preprocessor">#else</span>
01040 <span class="preprocessor"></span>    StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MmSessionBase);
01041     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MI_SESSION_SPACE_END);
01042 
01043     <span class="keywordflow">while</span> (StartPde &lt; EndPde) {
01044         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
01045         StartPde += 1;
01046     }
01047 <span class="preprocessor">#endif</span>
01048 <span class="preprocessor"></span>
01049 <span class="preprocessor">#endif</span>
01050 <span class="preprocessor"></span>
01051     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01052 
01053     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/session_8c.html#a8">MiSessionCreateInternal</a> (SessionId);
01054 
01055     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01056         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01057         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01058     }
01059 
01060     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01061 
01062     <a class="code" href="../../d4/d8/mi_8h.html#a754">MiSessionCount</a> += 1;
01063 
01064     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01065 
01066     <span class="comment">//</span>
01067     <span class="comment">// Add the session space to the working set list.</span>
01068     <span class="comment">//</span>
01069 
01070     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/wslist_8c.html#a29">MiSessionInitializeWorkingSetList</a> ();
01071 
01072     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01073         <a class="code" href="../../d3/d7/session_8c.html#a10">MiDereferenceSession</a> ();
01074         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01075         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01076     }
01077 
01078     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01079 
01080     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.Initialized = 1;
01081 
01082     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01083 
01084     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession = 1;
01085 
01086     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01087 
01088     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01089 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a196" doxytag="mm.h::MmSessionDelete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmSessionDelete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SessionId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a198" doxytag="mm.h::MmSessionLeader" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmSessionLeader           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l00109">109</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
<pre class="fragment"><div>00115                    :
00116 
00117     Mark <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> argument process as having <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ability to create or <span class="keyword">delete</span> session
00118     spaces.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> granted to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session manager process.
00119 
00120 Arguments:
00121 
00122     Process - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privileged process.
00123 
00124 Return Value:
00125 
00126     None.
00127 
00128 Environment:
00129 
00130     Kernel mode.
00131 
00132 --*/
00133 
00134 {
00135     Process-&gt;Vm.u.Flags.SessionLeader = 1;
00136 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a199" doxytag="mm.h::MmSessionSetUnloadAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmSessionSetUnloadAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pWin32KDevice</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/session_8c-source.html#l00140">140</a> of file <a class="el" href="../../d4/d6/session_8c-source.html">session.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l05584">_MM_SESSION_SPACE::Win32KDriverObject</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>.
<p>
<pre class="fragment"><div>00146                    :
00147 
00148     <a class="code" href="../../d9/d0/cmdata_8h.html#a104a97">Copy</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> win32k.sys driver object to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> session structure <span class="keywordflow">for</span> use during
00149     unload.
00150 
00151 Arguments:
00152 
00153     NewProcess - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> win32k driver object.
00154 
00155 Return Value:
00156 
00157     None.
00158 
00159 Environment:
00160 
00161     Kernel mode.
00162 
00163 --*/
00164 
00165 {
00166     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 1) {
00167 
00168         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(MmSessionSpace) == TRUE);
00169 
00170         RtlMoveMemory (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o35">Win32KDriverObject</a>,
00171                        pWin32KDevice,
00172                        <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a>));
00173         }
00174 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a261" doxytag="mm.h::MmSetAddressRangeModified" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmSetAddressRangeModified           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05920">5920</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00104">KeFlushMultipleTb()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00757">MI_IS_PTE_DIRTY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00733">MI_SET_PTE_CLEAN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02513">MI_WRITE_VALID_PTE_NEW_PROTECTION</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00127">MM_MAXIMUM_FLUSH_COUNT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cachesub_8c-source.html#l04411">CcFlushCache()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l06024">CcMapAndCopy()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02194">CcPurgeAndClearCacheSection()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l05143">CcUnpinRepinnedBcb()</a>, and <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>.
<p>
<pre class="fragment"><div>05927                    :
05928 
05929     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified bit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05930     pages that correspond to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address range.
05931 
05932     Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dirty bit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cleared by <span class="keyword">this</span> operation.
05933 
05934 Arguments:
05935 
05936     Address - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.  This
05937               range must reside within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cache.
05938 
05939     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
05940 
05941 Return Value:
05942 
05943     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> at least one PTE was dirty in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
05944 
05945 Environment:
05946 
05947     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> and below <span class="keywordflow">for</span> pagable addresses,
05948                   <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> and below <span class="keywordflow">for</span> non-pagable addresses.
05949 
05950 --*/
05951 
05952 {
05953     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05954     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
05955     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
05956     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FlushPte;
05957     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
05958     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> FlushContents;
05959     KIRQL OldIrql;
05960     PVOID VaFlushList[<a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>];
05961     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
05962     BOOLEAN Result;
05963 
05964     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
05965     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05966 
05967     <span class="comment">//</span>
05968     <span class="comment">// Loop on the copy on write case until the page is only</span>
05969     <span class="comment">// writable.</span>
05970     <span class="comment">//</span>
05971 
05972     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Address);
05973     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PVOID)((PCHAR)Address + Length - 1));
05974 
05975     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
05976 
05977     <span class="keywordflow">do</span> {
05978 
05979         PteContents = *PointerPte;
05980 
05981         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
05982 
05983             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
05984             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
05985 
05986             <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
05987                          (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0)) {
05988                 <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
05989                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = 0;
05990             }
05991 
05992 <span class="preprocessor">#ifdef NT_UP</span>
05993 <span class="preprocessor"></span>            <span class="comment">//</span>
05994             <span class="comment">// On uniprocessor systems no need to flush if this processor</span>
05995             <span class="comment">// doesn't think the PTE is dirty.</span>
05996             <span class="comment">//</span>
05997 
05998             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a114">MI_IS_PTE_DIRTY</a> (PteContents)) {
05999                 Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06000 <span class="preprocessor">#else  //NT_UP</span>
06001 <span class="preprocessor"></span>                Result |= (BOOLEAN)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a114">MI_IS_PTE_DIRTY</a> (PteContents));
06002 <span class="preprocessor">#endif //NT_UP</span>
06003 <span class="preprocessor"></span>                <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a113">MI_SET_PTE_CLEAN</a> (PteContents);
06004                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a188">MI_WRITE_VALID_PTE_NEW_PROTECTION</a> (PointerPte, PteContents);
06005                 FlushContents = PteContents;
06006                 FlushPte = PointerPte;
06007 
06008                 <span class="comment">//</span>
06009                 <span class="comment">// Clear the write bit in the PTE so new writes can be tracked.</span>
06010                 <span class="comment">//</span>
06011 
06012                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
06013                     VaFlushList[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = Address;
06014                     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
06015                 }
06016 <span class="preprocessor">#ifdef NT_UP</span>
06017 <span class="preprocessor"></span>            }
06018 <span class="preprocessor">#endif //NT_UP</span>
06019 <span class="preprocessor"></span>        }
06020         PointerPte += 1;
06021         Address = (PVOID)((PCHAR)Address + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
06022     } <span class="keywordflow">while</span> (PointerPte &lt;= LastPte);
06023 
06024     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != 0) {
06025         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == 1) {
06026 
06027             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (VaFlushList[0],
06028                                    FALSE,
06029                                    TRUE,
06030                                    (PHARDWARE_PTE)FlushPte,
06031                                    FlushContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
06032 
06033         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
06034 
06035             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a1">KeFlushMultipleTb</a> (Count,
06036                                &amp;VaFlushList[0],
06037                                FALSE,
06038                                TRUE,
06039                                NULL,
06040                                *(PHARDWARE_PTE)&amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
06041 
06042         } <span class="keywordflow">else</span> {
06043             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (FALSE, TRUE);
06044         }
06045     }
06046     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
06047     <span class="keywordflow">return</span> Result;
06048 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a335" doxytag="mm.h::MmSetBankedSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmSetBankedSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BankLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReadWriteBank</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/mm_8h.html#a162">PBANKED_SECTION_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>BankRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07311">7311</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02308">_MMBANKED_SECTION::BankedRoutine</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02307">_MMBANKED_SECTION::BankShift</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02306">_MMBANKED_SECTION::BankSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02311">_MMBANKED_SECTION::BankTemplate</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02305">_MMBANKED_SECTION::BasedPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02304">_MMBANKED_SECTION::BasePhysicalPage</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02309">_MMBANKED_SECTION::Context</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02310">_MMBANKED_SECTION::CurrentMappedPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01093">LOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00763">MI_VPN_TO_VA</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00380">MiLocateAddress()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d4/d8/mi_8h.html#a481">MMBANKED_SECTION</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02072">PBANKED_SECTION_ROUTINE</a>, <a class="el" href="../../d4/d8/mi_8h.html#a482">PMMBANKED_SECTION</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00282">PTE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o19">_MMVAD::u4</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
<pre class="fragment"><div>07322                    :
07323 
07324     This function declares a mapped video buffer as a banked
07325     section.  This allows banked video devices (i.e., even
07326     though the video controller has a megabyte or so of memory,
07327     only a small bank (like 64k) can be mapped at any one time.
07328 
07329     In order to overcome <span class="keyword">this</span> problem, the pager handles faults
07330     to <span class="keyword">this</span> memory, unmaps the current bank, calls off to the
07331     video driver and then maps in the <span class="keyword">new</span> bank.
07332 
07333     This function creates the necessary structures to allow the
07334     video driver to be called from the pager.
07335 
07336  ********************* NOTE NOTE NOTE *************************
07337     At <span class="keyword">this</span> time only read/write banks are supported!
07338 
07339 Arguments:
07340 
07341     ProcessHandle - Supplies a handle to the process in which to
07342                     support the banked video function.
07343 
07344     VirtualAddress - Supplies the <span class="keyword">virtual</span> address where the video
07345                      buffer is mapped in the specified process.
07346 
07347     BankLength - Supplies the size of the bank.
07348 
07349     ReadWriteBank - Supplies TRUE <span class="keywordflow">if</span> the bank is read and write.
07350 
07351     BankRoutine - Supplies a pointer to the routine that should be
07352                   called by the pager.
07353 
07354     Context - Supplies a context to be passed by the pager to the
07355               BankRoutine.
07356 
07357 Return Value:
07358 
07359     Returns the status of the function.
07360 
07361 Environment:
07362 
07363     Kernel mode, APC_LEVEL or below.
07364 
07365 --*/
07366 
07367 {
07368     NTSTATUS Status;
07369     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
07370     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
07371     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
07372     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
07373     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
07374     ULONG_PTR size;
07375     LONG count;
07376     ULONG NumberOfPtes;
07377     <a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html">PMMBANKED_SECTION</a> Bank;
07378 
07379     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
07380 
07381     UNREFERENCED_PARAMETER (ReadWriteBank);
07382 
07383     <span class="comment">//</span>
07384     <span class="comment">// Reference the specified process handle for VM_OPERATION access.</span>
07385     <span class="comment">//</span>
07386 
07387     Status = ObReferenceObjectByHandle ( ProcessHandle,
07388                                          PROCESS_VM_OPERATION,
07389                                          PsProcessType,
07390                                          KernelMode,
07391                                          (PVOID *)&amp;Process,
07392                                          NULL );
07393 
07394     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
07395         <span class="keywordflow">return</span> Status;
07396     }
07397 
07398     KeAttachProcess (&amp;Process-&gt;Pcb);
07399 
07400     <span class="comment">//</span>
07401     <span class="comment">// Get the address creation mutex to block multiple threads from</span>
07402     <span class="comment">// creating or deleting address space at the same time and</span>
07403     <span class="comment">// get the working set mutex so virtual address descriptors can</span>
07404     <span class="comment">// be inserted and walked.  Block APCs so an APC which takes a page</span>
07405     <span class="comment">// fault does not corrupt various structures.</span>
07406     <span class="comment">//</span>
07407 
07408     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
07409 
07410     <span class="comment">//</span>
07411     <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
07412     <span class="comment">//</span>
07413 
07414     <span class="keywordflow">if</span> (Process-&gt;AddressSpaceDeleted != 0) {
07415         Status = STATUS_PROCESS_IS_TERMINATING;
07416         <span class="keywordflow">goto</span> ErrorReturn;
07417     }
07418 
07419     Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (VirtualAddress);
07420 
07421     <span class="keywordflow">if</span> ((Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
07422         (Vad-&gt;StartingVpn != <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (VirtualAddress)) ||
07423         (Vad-&gt;u.VadFlags.PhysicalMapping == 0)) {
07424         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_MAPPED_DATA;
07425         <span class="keywordflow">goto</span> ErrorReturn;
07426     }
07427 
07428     size = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> + ((Vad-&gt;EndingVpn - Vad-&gt;StartingVpn) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
07429     <span class="keywordflow">if</span> ((size % BankLength) != 0) {
07430         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_VIEW_SIZE;
07431         <span class="keywordflow">goto</span> ErrorReturn;
07432     }
07433 
07434     count = -1;
07435     NumberOfPtes = BankLength;
07436 
07437     <span class="keywordflow">do</span> {
07438         NumberOfPtes = NumberOfPtes &gt;&gt; 1;
07439         count += 1;
07440     } <span class="keywordflow">while</span> (NumberOfPtes != 0);
07441 
07442     <span class="comment">//</span>
07443     <span class="comment">// Turn VAD into Banked VAD</span>
07444     <span class="comment">//</span>
07445 
07446     NumberOfPtes = BankLength &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
07447 
07448     Bank = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
07449                                     <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html">MMBANKED_SECTION</a>) +
07450                                        (NumberOfPtes - 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>),
07451                                     '  mM');
07452     <span class="keywordflow">if</span> (Bank == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07453         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
07454         <span class="keywordflow">goto</span> ErrorReturn;
07455     }
07456 
07457     Bank-&gt;BankShift = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a> + count - <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
07458 
07459     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(MI_VPN_TO_VA (Vad-&gt;StartingVpn));
07460     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid == 1);
07461 
07462     Vad-&gt;u4.Banked = Bank;
07463     Bank-&gt;BasePhysicalPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
07464     Bank-&gt;BasedPte = PointerPte;
07465     Bank-&gt;BankSize = BankLength;
07466     Bank-&gt;BankedRoutine = BankRoutine;
07467     Bank-&gt;Context = Context;
07468     Bank-&gt;CurrentMappedPte = PointerPte;
07469 
07470     <span class="comment">//</span>
07471     <span class="comment">// Build the template PTEs structure.</span>
07472     <span class="comment">//</span>
07473 
07474     count = 0;
07475     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
07476 
07477     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
07478                        Bank-&gt;BasePhysicalPage,
07479                        MM_READWRITE,
07480                        PointerPte);
07481 
07482     <span class="keywordflow">if</span> (TempPte.u.Hard.Write) {
07483         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
07484     }
07485 
07486     <span class="keywordflow">do</span> {
07487         Bank-&gt;BankTemplate[count] = TempPte;
07488         TempPte.u.Hard.PageFrameNumber += 1;
07489         count += 1;
07490     } <span class="keywordflow">while</span> ((ULONG)count &lt; NumberOfPtes );
07491 
07492     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MI_VPN_TO_VA (Vad-&gt;EndingVpn));
07493 
07494     <span class="comment">//</span>
07495     <span class="comment">// Set all PTEs within this range to zero.  Any faults within</span>
07496     <span class="comment">// this range will call the banked routine before making the</span>
07497     <span class="comment">// page valid.</span>
07498     <span class="comment">//</span>
07499 
07500     RtlFillMemory (PointerPte,
07501                    (size &gt;&gt; (PAGE_SHIFT - PTE_SHIFT)),
07502                    (UCHAR)<a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
07503 
07504     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (TRUE, TRUE);
07505 
07506     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
07507 ErrorReturn:
07508 
07509     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
07510     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
07511     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
07512     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
07513 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a340" doxytag="mm.h::MmSetHardFaultNotifyRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FASTCALL MmSetHardFaultNotifyRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d1/mm_8h.html#a164">PHARD_FAULT_NOTIFY_ROUTINE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NotifyRoutine</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a342" doxytag="mm.h::MmSetKernelDumpRange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmSetKernelDumpRange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DumpContext</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a229" doxytag="mm.h::MmSetMemoryPriorityProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmSetMemoryPriorityProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryPriority</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d4/procsup_8c-source.html#l05567">5567</a> of file <a class="el" href="../../d5/d4/procsup_8c-source.html">procsup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01039">LOCK_WS</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00063">_MMSUPPORT::MaximumWorkingSetSize</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00041">MEMORY_PRIORITY_BACKGROUND</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00062">_MMSUPPORT::MinimumWorkingSetSize</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03612">MiTrimWorkingSet()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04486">MmMoreThanEnoughFreePages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00399">MmNumberOfPhysicalPages</a>, <a class="el" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00172">MmSystemSize</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00088">MmWorkingSetReductionMax</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01598">_MMWSL::Quota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01081">UNLOCK_WS</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l03916">PsSetProcessPriorityByClass()</a>.
<p>
<pre class="fragment"><div>05574                    :
05575 
05576     Sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory priority of a process.
05577 
05578 Arguments:
05579 
05580     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process to update
05581 
05582     MemoryPriority - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> memory priority of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process
05583 
05584 Return Value:
05585 
05586     None.
05587 
05588 --*/
05589 
05590 {
05591     KIRQL OldIrql;
05592     UCHAR OldPriority;
05593 
05594     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/mminit_8c.html#a37">MmSystemSize</a> == <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a> &amp;&amp; <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt; ((15*1024*1024)/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
05595 
05596         <span class="comment">//</span>
05597         <span class="comment">// If this is a small system, make every process BACKGROUND.</span>
05598         <span class="comment">//</span>
05599 
05600         MemoryPriority = <a class="code" href="../../d1/d9/ps_8h.html#a1">MEMORY_PRIORITY_BACKGROUND</a>;
05601     }
05602 
05603     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
05604 
05605     OldPriority = Process-&gt;Vm.MemoryPriority;
05606     Process-&gt;Vm.MemoryPriority = MemoryPriority;
05607 
05608     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
05609 
05610 <span class="preprocessor">#ifndef _MI_USE_CLAIMS_</span>
05611 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (OldPriority &gt; MemoryPriority &amp;&amp; <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a>) {
05612         <span class="comment">//</span>
05613         <span class="comment">// The priority is being lowered, see if the working set</span>
05614         <span class="comment">// should be trimmed.</span>
05615         <span class="comment">//</span>
05616 
05617         <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport;
05618         ULONG i;
05619         ULONG Trim;
05620         LOGICAL Attached;
05621 
05622         VmSupport = &amp;Process-&gt;Vm;
05623         i = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> - VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a>;
05624         <span class="keywordflow">if</span> ((LONG)i &gt; 0) {
05625             Trim = i;
05626             <span class="keywordflow">if</span> (Trim &gt; <a class="code" href="../../d4/d5/procsup_8c.html#a6">MmWorkingSetReductionMax</a>) {
05627                 Trim = <a class="code" href="../../d4/d5/procsup_8c.html#a6">MmWorkingSetReductionMax</a>;
05628             }
05629             <span class="keywordflow">if</span> (Process != <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()) {
05630                 <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
05631                 Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05632             }
05633             <span class="keywordflow">else</span> {
05634                 Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05635             }
05636             <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (Process);
05637 
05638             Trim = <a class="code" href="../../d4/d0/wslist_8c.html#a34">MiTrimWorkingSet</a> (Trim,
05639                                      VmSupport,
05640                                      FALSE);
05641 
05642             <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>;
05643             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> &lt; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>) {
05644                 <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
05645             }
05646 
05647             <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (Process);
05648             <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05649                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
05650             }
05651         }
05652     }
05653 <span class="preprocessor">#endif</span>
05654 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
05655 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a339" doxytag="mm.h::MmSetPageFaultNotifyRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID FASTCALL MmSetPageFaultNotifyRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d1/mm_8h.html#a163">PPAGE_FAULT_NOTIFY_ROUTINE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NotifyRoutine</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a191" doxytag="mm.h::MmSetPageProtection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmSetPageProtection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewProtect</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l04027">4027</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00243">MiMakeProtectionMask()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02460">KiI386PentiumLockErrataFixup()</a>.
<p>
<pre class="fragment"><div>04035                    :
04036 
04037     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span> address range to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired
04038     protection.  This assumes that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> addresses are backed by PTEs
04039     which can be set (ie: not in kseg0 or large pages).
04040 
04041 Arguments:
04042 
04043     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start address to protect.
04044 
04045     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to set.
04046 
04047     NewProtect - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection to set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages to (PAGE_XX).
04048 
04049 Return Value:
04050 
04051     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection was applied, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
04052 
04053 Environment:
04054 
04055     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
04056 
04057 --*/
04058 
04059 {
04060     PFN_NUMBER i;
04061     PFN_NUMBER NumberOfPages;
04062     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
04063     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
04064     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> NewPteContents;
04065     KIRQL OldIrql;
04066     ULONG ProtectionMask;
04067 
04068     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(VirtualAddress)) {
04069         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04070     }
04071 
04072     <span class="keywordflow">try</span> {
04073         ProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (NewProtect);
04074     } except (EXCEPTION_EXECUTE_HANDLER) {
04075         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04076     }
04077 
04078     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
04079     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (NumberOfBytes);
04080 
04081     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04082 
04083     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfPages; i += 1) {
04084         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
04085 
04086         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (NewPteContents,
04087                            TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber,
04088                            ProtectionMask,
04089                            PointerPte);
04090 
04091         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> ((PVOID)((PUCHAR)VirtualAddress + (i &lt;&lt; PAGE_SHIFT)),
04092                          TRUE,
04093                          TRUE,
04094                          (PHARDWARE_PTE)PointerPte,
04095                          NewPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
04096 
04097         PointerPte += 1;
04098     }
04099 
04100     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04101 
04102     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04103 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a321" doxytag="mm.h::MmSetSpecialPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MmSetSpecialPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN LOGICAL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Enable</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03141">3141</a> of file <a class="el" href="../../d2/d5/allocpag_8c-source.html">allocpag.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02924">MiSpecialPoolEnabled</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
<pre class="fragment"><div>03147                    :
03148 
03149     This routine enables/disables special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.  This allows callers to ensure
03150     that subsequent allocations <span class="keywordflow">do</span> not come from special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> relied
03151     upon by callers that require KSEG0 addresses.
03152 
03153 Arguments:
03154 
03155     Enable - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to enable special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> to disable <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
03156 
03157 Return Value:
03158 
03159     Current special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> state (enabled or disabled).
03160 
03161 Environment:
03162 
03163     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below.
03164 
03165 --*/
03166 
03167 {
03168     KIRQL OldIrql;
03169     LOGICAL OldEnable;
03170 
03171     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
03172 
03173     OldEnable = <a class="code" href="../../d1/d6/allocpag_8c.html#a27">MiSpecialPoolEnabled</a>;
03174 
03175     <a class="code" href="../../d1/d6/allocpag_8c.html#a27">MiSpecialPoolEnabled</a> = Enable;
03176 
03177     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
03178 
03179     <span class="keywordflow">return</span> OldEnable;
03180 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a246" doxytag="mm.h::MmSetVerifierInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmSetVerifierInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemInformationLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/verifier_8c-source.html#l04226">4226</a> of file <a class="el" href="../../d0/d5/verifier_8c-source.html">verifier.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00178">KeReleaseMutant()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00928">MmSystemLoadLock</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00097">MmVerifierData</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l00367">VerifierModifyableOptions</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l00368">VerifierOptionChanges</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>.
<p>
<pre class="fragment"><div>04233                    :
04234 
04235     This routine sets any driver verifier flags that can be done without
04236     rebooting.
04237 
04238 Arguments:
04239 
04240     SystemInformation - Gets and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver verification flags.
04241 
04242     SystemInformationLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SystemInformation
04243                               buffer.
04244 
04245 Return Value:
04246 
04247     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
04248 
04249 Environment:
04250 
04251     The SystemInformation buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in user space and our caller has wrapped
04252     a <span class="keywordflow">try</span>-except around <span class="keyword">this</span> entire routine.  Capture any exceptions here and
04253     release resources accordingly.
04254 
04255 --*/
04256 
04257 {
04258     ULONG UserFlags;
04259     ULONG NewFlags;
04260     ULONG NewFlagsOn;
04261     ULONG NewFlagsOff;
04262     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04263     PULONG UserVerifyBuffer;
04264 
04265     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04266 
04267     <span class="keywordflow">if</span> (SystemInformationLength &lt; <span class="keyword">sizeof</span> (ULONG)) {
04268         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INFO_LENGTH_MISMATCH);
04269     }
04270 
04271     UserVerifyBuffer = (PULONG)SystemInformation;
04272 
04273     <span class="comment">//</span>
04274     <span class="comment">// Synchronize all changes to the flags here.</span>
04275     <span class="comment">//</span>
04276 
04277     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04278 
04279     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
04280 
04281     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;MmSystemLoadLock,
04282                            WrVirtualMemory,
04283                            KernelMode,
04284                            FALSE,
04285                            (PLARGE_INTEGER)NULL);
04286 
04287     <span class="keywordflow">try</span> {
04288 
04289         UserFlags = *UserVerifyBuffer;
04290 
04291         <span class="comment">//</span>
04292         <span class="comment">// Ensure nothing is being set or cleared that isn't supported.</span>
04293         <span class="comment">//</span>
04294         <span class="comment">//</span>
04295 
04296         NewFlagsOn = UserFlags &amp; <a class="code" href="../../d9/d5/verifier_8c.html#a16">VerifierModifyableOptions</a>;
04297 
04298         NewFlags = <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level | NewFlagsOn;
04299 
04300         <span class="comment">//</span>
04301         <span class="comment">// Any bits set in NewFlagsOff must be zeroed in the NewFlags.</span>
04302         <span class="comment">//</span>
04303 
04304         NewFlagsOff = ((~UserFlags) &amp; <a class="code" href="../../d9/d5/verifier_8c.html#a16">VerifierModifyableOptions</a>);
04305 
04306         NewFlags &amp;= ~NewFlagsOff;
04307 
04308         <span class="keywordflow">if</span> (NewFlags != <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level) {
04309             <a class="code" href="../../d9/d5/verifier_8c.html#a17">VerifierOptionChanges</a> += 1;
04310             <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.Level = NewFlags;
04311             *UserVerifyBuffer = NewFlags;
04312         }
04313 
04314     } except (EXCEPTION_EXECUTE_HANDLER) {
04315         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
04316     }
04317 
04318     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;MmSystemLoadLock, 1, FALSE, FALSE);
04319 
04320     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
04321 
04322     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04323 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a192" doxytag="mm.h::MmShutdownSystem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmShutdownSystem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">41</a> of file <a class="el" href="../../d2/d8/shutdown_8c-source.html">shutdown.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02559">_MMPAGING_FILE::Bitmap</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00420">_MDL::ByteCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02114">_SUBSECTION::ControlArea</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02560">_MMPAGING_FILE::File</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02070">_CONTROL_AREA::FilePointer</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01081">_MMPFNLIST::Flink</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10957">IoSynchronousPageWrite()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00418">_MDL::MappedSystemVa</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00416">_MDL::MdlFlags</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01430">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01470">MI_REMOVE_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01559">MiGetSubsectionAddress</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01177">MiRemoveZeroPage()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00916">MiStartingOffset()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00121">MM_MAXIMUM_WRITE_CLUSTER</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05120">MmFreeGoal</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01789">MmInitializeMdl</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01087">MmModifiedPageListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05096">MmModifiedPageWriterEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05126">MmModifiedWriteClusterSize</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00056">MmNumberOfPagingFiles</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05083">MmPagingFile</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00094">MmSystemShutdown</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00214">MmTwentySeconds</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">MmUnmapLockedPages()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00114">MmZeroPageFile</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02062">_CONTROL_AREA::NumberOfMappedViews</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02061">_CONTROL_AREA::NumberOfPfnReferences</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02550">_MMPAGING_FILE::Size</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00419">_MDL::StartVa</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a217">WrPageOut</a>.
<p>
<pre class="fragment"><div>00047                    :
00048 
00049     This function performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> shutdown of memory management.  This
00050     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> accomplished by writing <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> all modified pages which are
00051     destined <span class="keywordflow">for</span> files other than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00052 
00053 Arguments:
00054 
00055     None.
00056 
00057 Return Value:
00058 
00059     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages were successfully written, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00060 
00061 --*/
00062 
00063 {
00064     PFN_NUMBER ModifiedPage;
00065     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00066     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00067     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00068     PPFN_NUMBER Page;
00069     PFN_NUMBER MdlHack[(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)/<span class="keyword">sizeof</span>(PFN_NUMBER)) + <a class="code" href="../../d4/d8/mi_8h.html#a33">MM_MAXIMUM_WRITE_CLUSTER</a>];
00070     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
00071     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00072     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> IoEvent;
00073     IO_STATUS_BLOCK IoStatus;
00074     KIRQL OldIrql;
00075     LARGE_INTEGER StartingOffset;
00076     ULONG count;
00077     PFN_NUMBER j;
00078     ULONG k;
00079     PFN_NUMBER first;
00080     ULONG write;
00081     <a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html">PMMPAGING_FILE</a> PagingFile;
00082 
00083     <span class="comment">//</span>
00084     <span class="comment">// Don't do this more than once.</span>
00085     <span class="comment">//</span>
00086 
00087     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d3/modwrite_8c.html#a17">MmSystemShutdown</a>) {
00088 
00089         <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
00090 
00091         Mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)&amp;MdlHack;
00092         Page = (PPFN_NUMBER)(Mdl + 1);
00093 
00094         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;IoEvent, NotificationEvent, FALSE);
00095 
00096         <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a>(Mdl,
00097                         NULL,
00098                         PAGE_SIZE);
00099 
00100         Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
00101 
00102         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00103 
00104         ModifiedPage = <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
00105         <span class="keywordflow">while</span> (ModifiedPage != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00106 
00107             <span class="comment">//</span>
00108             <span class="comment">// There are modified pages.</span>
00109             <span class="comment">//</span>
00110 
00111             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (ModifiedPage);
00112 
00113             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
00114 
00115                 <span class="comment">//</span>
00116                 <span class="comment">// This page is destined for a file.</span>
00117                 <span class="comment">//</span>
00118 
00119                 Subsection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00120                 ControlArea = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>;
00121                 <span class="keywordflow">if</span> ((!ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image) &amp;&amp;
00122                    (!ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoModifiedWriting)) {
00123 
00124                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
00125 
00126                     <span class="comment">//</span>
00127                     <span class="comment">// Issue the write.</span>
00128                     <span class="comment">//</span>
00129 
00130                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 0;
00131 
00132                     <span class="comment">//</span>
00133                     <span class="comment">// Up the reference count for the physical page as there</span>
00134                     <span class="comment">// is I/O in progress.</span>
00135                     <span class="comment">//</span>
00136 
00137                     <a class="code" href="../../d4/d8/mi_8h.html#a187">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a> (Pfn1, 26);
00138                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
00139 
00140                     *Page = ModifiedPage;
00141                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> += 1;
00142                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> += 1;
00143 
00144                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00145 
00146                     StartingOffset.QuadPart = <a class="code" href="../../d4/d8/mi_8h.html#a952">MiStartingOffset</a> (Subsection,
00147                                                                   Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
00148 
00149                     Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o5">StartVa</a> = (PVOID)ULongToPtr(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor &lt;&lt; PAGE_SHIFT);
00150                     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;IoEvent);
00151                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a116">IoSynchronousPageWrite</a> (
00152                                             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>,
00153                                             Mdl,
00154                                             &amp;StartingOffset,
00155                                             &amp;IoEvent,
00156                                             &amp;IoStatus );
00157 
00158                     <span class="comment">//</span>
00159                     <span class="comment">// Ignore all I/O failures - there is nothing that can be</span>
00160                     <span class="comment">// done at this point.</span>
00161                     <span class="comment">//</span>
00162 
00163                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00164                         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;IoEvent, 0, FALSE);
00165                     }
00166 
00167                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;IoEvent,
00168                                                     WrPageOut,
00169                                                     KernelMode,
00170                                                     FALSE,
00171                                                     (PLARGE_INTEGER)&amp;MmTwentySeconds);
00172 
00173                     <span class="keywordflow">if</span> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>) {
00174                         <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a>, Mdl);
00175                     }
00176 
00177                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT) {
00178 
00179                         <span class="comment">//</span>
00180                         <span class="comment">// The write did not complete in 20 seconds, assume</span>
00181                         <span class="comment">// that the file systems are hung and return an</span>
00182                         <span class="comment">// error.</span>
00183                         <span class="comment">//</span>
00184 
00185                         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00186                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
00187                         <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a> (Pfn1, 27);
00188                         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (ModifiedPage);
00189                         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
00190                         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> -= 1;
00191 
00192                         <span class="comment">//</span>
00193                         <span class="comment">// This routine returns with the PFN lock released!</span>
00194                         <span class="comment">//</span>
00195 
00196                         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
00197 
00198                         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00199 
00200                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00201                     }
00202 
00203                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00204                     <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a> (Pfn1, 27);
00205                     <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (ModifiedPage);
00206                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
00207                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> -= 1;
00208 
00209                     <span class="comment">//</span>
00210                     <span class="comment">// This routine returns with the PFN lock released!</span>
00211                     <span class="comment">//</span>
00212 
00213                     <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
00214                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00215 
00216                     <span class="comment">//</span>
00217                     <span class="comment">// Restart scan at the front of the list.</span>
00218                     <span class="comment">//</span>
00219 
00220                     ModifiedPage = <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
00221                     <span class="keywordflow">continue</span>;
00222                 }
00223             }
00224             ModifiedPage = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink;
00225         }
00226 
00227         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00228 
00229         <span class="comment">//</span>
00230         <span class="comment">// If a high number of modified pages still exist, start the</span>
00231         <span class="comment">// modified page writer and wait for 5 seconds.</span>
00232         <span class="comment">//</span>
00233 
00234         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; (<a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a> * 2)) {
00235             LARGE_INTEGER FiveSeconds = {(ULONG)(-5 * 1000 * 1000 * 10), -1};
00236 
00237             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmModifiedPageWriterEvent, 0, FALSE);
00238             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode,
00239                                     FALSE,
00240                                     (PLARGE_INTEGER)&amp;FiveSeconds);
00241         }
00242 
00243         <span class="comment">//</span>
00244         <span class="comment">// Indicate to the modified page writer that the system has</span>
00245         <span class="comment">// shutdown.</span>
00246         <span class="comment">//</span>
00247 
00248         <a class="code" href="../../d6/d3/modwrite_8c.html#a17">MmSystemShutdown</a> = 1;
00249 
00250         <span class="comment">//</span>
00251         <span class="comment">// Check to see if the paging file should be overwritten.</span>
00252         <span class="comment">// Only free blocks are written.</span>
00253         <span class="comment">//</span>
00254 
00255         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a58">MmZeroPageFile</a>) {
00256 
00257             <span class="comment">//</span>
00258             <span class="comment">// Get pages to complete the write request.</span>
00259             <span class="comment">//</span>
00260 
00261             Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o5">StartVa</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00262             j = 0;
00263             k = 0;
00264             Page = (PPFN_NUMBER)(Mdl + 1);
00265 
00266             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00267 
00268             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; (<a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a> + 20)) {
00269                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a>(OldIrql);
00270                 <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00271                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00272             }
00273 
00274             <span class="keywordflow">do</span> {
00275                 *Page = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> ((ULONG)j);
00276                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
00277                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00278                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
00279                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
00280                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00281                 Page += 1;
00282                 j += 1;
00283             } <span class="keywordflow">while</span> (j &lt; <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>);
00284 
00285             <span class="keywordflow">while</span> (k &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>) {
00286 
00287                 PagingFile = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[k];
00288 
00289                 count = 0;
00290                 write = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00291 
00292                 <span class="keywordflow">for</span> (j = 1; j &lt; PagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>; j += 1) {
00293 
00294                     <span class="keywordflow">if</span> (RtlCheckBit (PagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o9">Bitmap</a>, j) == 0) {
00295 
00296                         <span class="keywordflow">if</span> (count == 0) {
00297                             first = j;
00298                         }
00299                         count += 1;
00300                         <span class="keywordflow">if</span> (count == <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>) {
00301                             write = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00302                         }
00303                     } <span class="keywordflow">else</span> {
00304                         <span class="keywordflow">if</span> (count != 0) {
00305 
00306                             <span class="comment">//</span>
00307                             <span class="comment">// Issue a write.</span>
00308                             <span class="comment">//</span>
00309 
00310                             write = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00311                         }
00312                     }
00313 
00314                     <span class="keywordflow">if</span> ((j == (PagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> - 1)) &amp;&amp;
00315                         (count != 0)) {
00316                         write = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00317                     }
00318 
00319                     <span class="keywordflow">if</span> (write) {
00320 
00321                         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00322 
00323                         StartingOffset.QuadPart = (LONGLONG)first &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00324                         Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> = count &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00325                         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;IoEvent);
00326 
00327                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a116">IoSynchronousPageWrite</a> (PagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o10">File</a>,
00328                                                          Mdl,
00329                                                          &amp;StartingOffset,
00330                                                          &amp;IoEvent,
00331                                                          &amp;IoStatus);
00332 
00333                         <span class="comment">//</span>
00334                         <span class="comment">// Ignore all I/O failures - there is nothing that can</span>
00335                         <span class="comment">// be done at this point.</span>
00336                         <span class="comment">//</span>
00337 
00338                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00339                             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;IoEvent, 0, FALSE);
00340                         }
00341 
00342                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;IoEvent,
00343                                                         WrPageOut,
00344                                                         KernelMode,
00345                                                         FALSE,
00346                                                         (PLARGE_INTEGER)&amp;MmTwentySeconds);
00347 
00348                         <span class="keywordflow">if</span> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>) {
00349                             <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a>, Mdl);
00350                         }
00351 
00352                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT) {
00353 
00354                             <span class="comment">//</span>
00355                             <span class="comment">// The write did not complete in 20 seconds, assume</span>
00356                             <span class="comment">// that the file systems are hung and return an</span>
00357                             <span class="comment">// error.</span>
00358                             <span class="comment">//</span>
00359 
00360                             j = 0;
00361                             Page = (PPFN_NUMBER)(Mdl + 1);
00362                             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00363                             <span class="keywordflow">do</span> {
00364                                 <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (*Page);
00365                                 Page += 1;
00366                                 j += 1;
00367                             } <span class="keywordflow">while</span> (j &lt; <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>);
00368                             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00369 
00370                             <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00371                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00372                         }
00373 
00374                         count = 0;
00375                         write = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00376                         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00377                     }
00378                 }
00379                 k += 1;
00380             }
00381             j = 0;
00382             Page = (PPFN_NUMBER)(Mdl + 1);
00383             <span class="keywordflow">do</span> {
00384                 <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (*Page);
00385                 Page += 1;
00386                 j += 1;
00387             } <span class="keywordflow">while</span> (j &lt; <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>);
00388             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00389         }
00390         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00391     }
00392     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00393 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a304" doxytag="mm.h::MmSizeOfMdl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI SIZE_T MmSizeOfMdl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Base</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05815">5815</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00217">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02995">ExLockUserBuffer()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l01424">MiCreateImageFileMap()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05852">MmCreateMdl()</a>, and <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>.
<p>
<pre class="fragment"><div>05822                    :
05823 
05824     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes required <span class="keywordflow">for</span> an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <span class="keywordflow">for</span> a
05825     given buffer and size.
05826 
05827 Arguments:
05828 
05829     Base - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <span class="keyword">virtual</span> address <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
05830 
05831     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer in bytes.
05832 
05833 Return Value:
05834 
05835     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes required to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
05836 
05837 Environment:
05838 
05839     Kernel mode.  Any IRQL level.
05840 
05841 --*/
05842 
05843 {
05844     <span class="keywordflow">return</span>( <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> ) +
05845                 (<a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>( Base, Length ) *
05846                  <span class="keyword">sizeof</span>( PFN_NUMBER ))
05847           );
05848 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a236" doxytag="mm.h::MmSizeOfTriageInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MmSizeOfTriageInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02795">IopWriteTriageDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a237" doxytag="mm.h::MmSizeOfUnloadedDriverInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MmSizeOfUnloadedDriverInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02795">IopWriteTriageDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a328" doxytag="mm.h::MmTrimAllSystemPagableMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MmTrimAllSystemPagableMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN LOGICAL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PurgeTransition</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02986">2986</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01389">ExReleaseResourceLite()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00598">ExTryToAcquireResourceExclusiveLite()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a360">KeTryToAcquireSpinLock()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02222">_MMWORKING_SET_EXPANSION_HEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l04726">MiEmptyWorkingSet()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00521">MiRemovePageFromList()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02982">MiTrimAllPageFaultCount</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00157">MiTrimInProgressCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00099">MM_NO_WS_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00952">MM_SET_EXPANSION_OWNER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00100">MM_WS_EXPANSION_IN_PROGRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04905">MmExpansionLock</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00082">MmStandbyPageListHead</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00996">MmSystemLockOwner</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04887">MmSystemWsLock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05071">MmWorkingSetExpansionHead</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00059">_MMSUPPORT::PageFaultCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00065">_MMSUPPORT::WorkingSetExpansionLinks</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/verifier_8c-source.html#l02333">ViTrimAllSystemPagableMemory()</a>.
<p>
<pre class="fragment"><div>02992                    :
02993 
02994     This routine unmaps all pagable system memory.  This does not unmap user
02995     memory or locked down kernel memory.  Thus, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory being unmapped
02996     resides in paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>, pagable kernel/driver code &amp; data, special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
02997     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cache.
02998 
02999     Note that pages with a reference count greater than 1 are skipped (ie:
03000     they remain valid, as they are assumed to be locked down).  This prevents
03001     us from unmapping all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cache entries, etc.
03002 
03003     Non-locked down kernel stacks must be outpaged by modifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> balance
03004     set manager to operate in conjunction with a support routine.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
03005     done here.
03006 
03007 Arguments:
03008 
03009     PurgeTransition - Supplies whether to purge all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> clean pages from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03010                       transition list.
03011 
03012 Return Value:
03013 
03014     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> accomplished, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
03015 
03016 Environment:
03017 
03018     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
03019 
03020 --*/
03021 
03022 {
03023     KIRQL OldIrql;
03024     KIRQL OldIrql2;
03025     PLIST_ENTRY Next;
03026     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport;
03027     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> PagesInUse;
03028     PFN_NUMBER PageFrameIndex;
03029     LOGICAL LockAvailable;
03030     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03031     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread;
03032     ULONG flags;
03033 
03034     <span class="comment">//</span>
03035     <span class="comment">// It's ok to check this without acquiring the system WS lock.</span>
03036     <span class="comment">//</span>
03037 
03038     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a31">MiTrimAllPageFaultCount</a> == <a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>) {
03039         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03040     }
03041 
03042     <span class="comment">//</span>
03043     <span class="comment">// Working set mutexes will be acquired which require APC_LEVEL or below.</span>
03044     <span class="comment">//</span>
03045 
03046     <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
03047         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03048     }
03049 
03050     <span class="comment">//</span>
03051     <span class="comment">// Just return if it's too early during system initialization or if</span>
03052     <span class="comment">// another thread/processor is racing here to do the work for us.</span>
03053     <span class="comment">//</span>
03054 
03055     <span class="keywordflow">if</span> (InterlockedIncrement (&amp;MiTrimInProgressCount) &gt; 1) {
03056         InterlockedDecrement (&amp;MiTrimInProgressCount);
03057         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03058     }
03059 
03060 <span class="preprocessor">#if defined(_X86_)</span>
03061 <span class="preprocessor"></span>
03062     _asm {
03063         pushfd
03064         pop     flags
03065     }
03066 
03067     <span class="keywordflow">if</span> ((flags &amp; EFLAGS_INTERRUPT_MASK) == 0) {
03068         InterlockedDecrement (&amp;MiTrimInProgressCount);
03069         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03070     }
03071 
03072 <span class="preprocessor">#endif</span>
03073 <span class="preprocessor"></span>
03074     LockAvailable = <a class="code" href="../../d4/d9/ke_8h.html#a360">KeTryToAcquireSpinLock</a> (&amp;MmExpansionLock, &amp;OldIrql);
03075 
03076     <span class="keywordflow">if</span> (LockAvailable == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03077         InterlockedDecrement (&amp;MiTrimInProgressCount);
03078         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03079     }
03080 
03081     <a class="code" href="../../d4/d8/mi_8h.html#a137">MM_SET_EXPANSION_OWNER</a> ();
03082 
03083     CurrentThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
03084 
03085     <span class="comment">//</span>
03086     <span class="comment">// If the system cache resource is owned by this thread then don't bother</span>
03087     <span class="comment">// trying to trim now.  Note that checking the MmSystemLockOwner is not</span>
03088     <span class="comment">// sufficient as this flag is cleared just before actually releasing it.</span>
03089     <span class="comment">//</span>
03090 
03091     <span class="keywordflow">if</span> ((CurrentThread == <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a>) ||
03092         (<a class="code" href="../../d5/d8/ex_8h.html#a272">ExTryToAcquireResourceExclusiveLite</a>(&amp;MmSystemWsLock) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03093         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
03094         InterlockedDecrement (&amp;MiTrimInProgressCount);
03095         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03096     }
03097 
03098     Next = <a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>.Flink;
03099 
03100     <span class="keywordflow">while</span> (Next != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>) {
03101         <span class="keywordflow">if</span> (Next == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>) {
03102             <span class="keywordflow">break</span>;
03103         }
03104         Next = Next-&gt;Flink;
03105     }
03106 
03107     <span class="keywordflow">if</span> (Next != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>) {
03108         <a class="code" href="../../d5/d8/ex_8h.html#a273">ExReleaseResourceLite</a>(&amp;MmSystemWsLock);
03109         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
03110         InterlockedDecrement (&amp;MiTrimInProgressCount);
03111         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03112     }
03113 
03114     RemoveEntryList (Next);
03115 
03116     VmSupport = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
03117     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>;
03118     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink = <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>;
03119     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 0);
03120     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 1;
03121 
03122     <a class="code" href="../../d5/d0/wsmanage_8c.html#a31">MiTrimAllPageFaultCount</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
03123 
03124     PagesInUse = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>;
03125 
03126     <span class="comment">//</span>
03127     <span class="comment">// There are 2 issues here that are carefully dealt with :</span>
03128     <span class="comment">//</span>
03129     <span class="comment">// 1.  APCs must be disabled while any resources are held to prevent</span>
03130     <span class="comment">//     suspend APCs from deadlocking the system.</span>
03131     <span class="comment">// 2.  Once the system cache has been marked MM_WS_EXPANSION_IN_PROGRESS,</span>
03132     <span class="comment">//     either the thread must not be preempted or the system cache working</span>
03133     <span class="comment">//     set lock must be held throughout.  Otherwise a high priority thread</span>
03134     <span class="comment">//     can fault on a system code and data address and the two pages will</span>
03135     <span class="comment">//     thrash forever (at high priority) because no system working set</span>
03136     <span class="comment">//     expansion is allowed while MM_WS_EXPANSION_IN_PROGRESS is set.</span>
03137     <span class="comment">//     The decision was to hold the system working set lock throughout.</span>
03138     <span class="comment">//</span>
03139 
03140     <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a> = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
03141 
03142     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (APC_LEVEL);
03143 
03144     <a class="code" href="../../d4/d0/wslist_8c.html#a35">MiEmptyWorkingSet</a> (VmSupport, FALSE);
03145 
03146     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql2);
03147     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (OldIrql2 == APC_LEVEL);
03148 
03149     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink == MM_NO_WS_EXPANSION);
03150 
03151     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 1);
03152     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
03153 
03154     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink ==
03155                                         MM_WS_EXPANSION_IN_PROGRESS);
03156 
03157     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
03158                     &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
03159 
03160     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (APC_LEVEL);
03161 
03162     <span class="comment">//</span>
03163     <span class="comment">// Since MiEmptyWorkingSet will attempt to recursively acquire and release</span>
03164     <span class="comment">// the MmSystemWsLock, the MmSystemLockOwner field may get cleared.</span>
03165     <span class="comment">// This means here the resource must be explicitly released instead of</span>
03166     <span class="comment">// using UNLOCK_SYSTEM_WS.</span>
03167     <span class="comment">//</span>
03168 
03169     <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03170     <a class="code" href="../../d5/d8/ex_8h.html#a273">ExReleaseResourceLite</a> (&amp;MmSystemWsLock);
03171     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
03172     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt;= APC_LEVEL);
03173 
03174     <span class="keywordflow">if</span> (PurgeTransition == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03175 
03176         <span class="comment">//</span>
03177         <span class="comment">// Run the transition list and free all the entries so transition</span>
03178         <span class="comment">// faults are not satisfied for any of the non modified pages that were</span>
03179         <span class="comment">// freed.</span>
03180         <span class="comment">//</span>
03181     
03182         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03183     
03184         <span class="keywordflow">while</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0) {
03185     
03186             PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a> (&amp;MmStandbyPageListHead);
03187     
03188             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03189     
03190             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
03191             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
03192     
03193             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
03194             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a> = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
03195             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 0;
03196             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
03197         
03198             <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
03199         }
03200     
03201         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03202     }
03203     
03204     InterlockedDecrement (&amp;MiTrimInProgressCount);
03205 
03206     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03207 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a233" doxytag="mm.h::MmUnloadSystemImage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmUnloadSystemImage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Section</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">2896</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05471">_MM_SESSION_SPACE::CommittedPages</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l02894">ExpCheckForResource()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05766">_IMAGE_ENTRY_IN_SESSION::ImageCountInThisSession</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00467">KeCheckForTimer()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00178">KeReleaseMutant()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00046">LOADED_AT_BOOT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05688">LOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05287">MI_IS_SESSION_IMAGE_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04192">MiActiveVerifierThunks</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02693">MiClearImports()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l04950">MiDeleteSystemPagableVm()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03822">MiDereferenceImports()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02740">MiRememberUnloadedDriver()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l01223">MiRemoveImageSessionWide()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00518">MiSessionLookupImage()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00866">MiSessionWideGetImageSize()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a106">MiVerifierCheckThunks()</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l03625">MiVerifyingDriverUnloading()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05361">MM_BUMP_SESS_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04309">MM_DBG_COMMIT_RETURN_DRIVER_UNLOAD</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04310">MM_DBG_COMMIT_RETURN_DRIVER_UNLOAD1</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05326">MM_DBG_SESSION_COMMIT_IMAGE_UNLOAD</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00082">MmDisablePagingExecutive</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00075">MmDriverCommit</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00088">MmSnapUnloads</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00928">MmSystemLoadLock</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00051">MmTotalSystemDriverPages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02184">PERFINFO_IMAGE_UNLOAD</a>, <a class="el" href="../../d8/d8/sysload_8c.html#a6">PLOAD_IMPORTS</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00583">PsLoadedModuleResource</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00080">PsLoadedModuleSpinLock</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01249">RtlFreeAnsiString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00246">RtlUnicodeStringToAnsiString()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05416">_MM_SESSION_SPACE::SessionId</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01300">IoFreeDumpStack()</a>, <a class="el" href="../../d4/d0/objsup_8c-source.html#l00698">IopDeleteDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03645">MiCallDllUnloadAndUnloadDll()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l03953">MiResolveImageReferences()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00572">MiSessionUnloadAllImages()</a>, and <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>.
<p>
<pre class="fragment"><div>02902                    :
02903 
02904     This routine unloads a previously loaded system image and returns
02905     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated resources.
02906 
02907 Arguments:
02908 
02909     ImageHandle - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02910                   image to unload.
02911 
02912 Return Value:
02913 
02914     Various <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> codes.
02915 
02916 --*/
02917 
02918 {
02919     PLDR_DATA_TABLE_ENTRY DataTableEntry;
02920     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
02921     PFN_NUMBER PagesRequired;
02922     PFN_NUMBER ResidentPages;
02923     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02924     PFN_NUMBER NumberOfPtes;
02925     KIRQL OldIrql;
02926     PVOID BasedAddress;
02927     SIZE_T NumberOfBytes;
02928     BOOLEAN MustFree;
02929     SIZE_T CommittedPages;
02930     BOOLEAN ViewDeleted;
02931     <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a> DriverImage;
02932     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02933     PVOID StillQueued;
02934     <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> SectionPointer;
02935 
02936     <span class="comment">//</span>
02937     <span class="comment">// Arbitrary process context so prevent suspend APCs now.</span>
02938     <span class="comment">//</span>
02939 
02940     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02941 
02942     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;MmSystemLoadLock,
02943                            WrVirtualMemory,
02944                            KernelMode,
02945                            FALSE,
02946                            (PLARGE_INTEGER)NULL);
02947 
02948     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
02949 
02950     ViewDeleted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02951     DataTableEntry = (PLDR_DATA_TABLE_ENTRY)ImageHandle;
02952     BasedAddress = DataTableEntry-&gt;DllBase;
02953 
02954 <span class="preprocessor">#if DBGXX</span>
02955 <span class="preprocessor"></span>    <span class="comment">//</span>
02956     <span class="comment">// MiUnloadSystemImageByForce violates this check so remove it for now.</span>
02957     <span class="comment">//</span>
02958 
02959     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink) {
02960         LOGICAL Found;
02961         PLIST_ENTRY NextEntry;
02962         PLDR_DATA_TABLE_ENTRY DataTableEntry2;
02963 
02964         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02965         NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
02966         <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
02967     
02968             DataTableEntry2 = CONTAINING_RECORD(NextEntry,
02969                                                 LDR_DATA_TABLE_ENTRY,
02970                                                 InLoadOrderLinks);
02971             <span class="keywordflow">if</span> (DataTableEntry == DataTableEntry2) {
02972                 Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02973                 <span class="keywordflow">break</span>;
02974             }
02975             NextEntry = NextEntry-&gt;Flink;
02976         }
02977         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Found == TRUE);
02978     }
02979 <span class="preprocessor">#endif</span>
02980 <span class="preprocessor"></span>
02981 <span class="preprocessor">#if DBG_SYSLOAD</span>
02982 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (DataTableEntry-&gt;SectionPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02983         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: Called to unload boot driver %wZ\n"</span>,
02984             &amp;DataTableEntry-&gt;FullDllName);
02985     }
02986     <span class="keywordflow">else</span> {
02987         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: Called to unload non-boot driver %wZ\n"</span>,
02988             &amp;DataTableEntry-&gt;FullDllName);
02989     }
02990 <span class="preprocessor">#endif</span>
02991 <span class="preprocessor"></span>
02992     <span class="comment">//</span>
02993     <span class="comment">// Any driver loaded at boot that did not have its import list</span>
02994     <span class="comment">// and LoadCount reconstructed cannot be unloaded because we don't</span>
02995     <span class="comment">// know how many other drivers may be linked to it.</span>
02996     <span class="comment">//</span>
02997 
02998     <span class="keywordflow">if</span> (DataTableEntry-&gt;LoadedImports == (PVOID)<a class="code" href="../../d8/d8/sysload_8c.html#a0">LOADED_AT_BOOT</a>) {
02999         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
03000         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;MmSystemLoadLock, 1, FALSE, FALSE);
03001         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03002         <span class="keywordflow">return</span> STATUS_SUCCESS;
03003     }
03004 
03005     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry-&gt;LoadCount != 0);
03006 
03007     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (BasedAddress)) {
03008 
03009         <span class="comment">//</span>
03010         <span class="comment">// A printer driver may be referenced multiple times for the</span>
03011         <span class="comment">// same session space.  Only unload the last reference.</span>
03012         <span class="comment">//</span>
03013 
03014         DriverImage = <a class="code" href="../../d4/d7/sessload_8c.html#a13">MiSessionLookupImage</a> (BasedAddress);
03015 
03016         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DriverImage);
03017 
03018         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DriverImage-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o3">ImageCountInThisSession</a>);
03019 
03020         <span class="keywordflow">if</span> (DriverImage-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o3">ImageCountInThisSession</a> &gt; 1) {
03021 
03022             DriverImage-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o3">ImageCountInThisSession</a> -= 1;
03023             <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
03024             <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;MmSystemLoadLock, 1, FALSE, FALSE);
03025             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03026 
03027             <span class="keywordflow">return</span> STATUS_SUCCESS;
03028         }
03029 
03030         <span class="comment">//</span>
03031         <span class="comment">// The reference count for this image has dropped to zero in this</span>
03032         <span class="comment">// session, so we can delete this session's view of the image.</span>
03033         <span class="comment">//</span>
03034 
03035         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a16">MiSessionWideGetImageSize</a> (BasedAddress,
03036                                             &amp;NumberOfBytes,
03037                                             &amp;CommittedPages);
03038 
03039         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03040 
03041             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
03042                           0x41286,
03043                           (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
03044                           (ULONG_PTR)BasedAddress,
03045                           0);
03046         }
03047 
03048         <span class="comment">//</span>
03049         <span class="comment">// Free the session space taken up by the image, unmapping it from</span>
03050         <span class="comment">// the current VA space - note this does not remove page table pages</span>
03051         <span class="comment">// from the session PageTables[].  Each data page is only freed</span>
03052         <span class="comment">// if there are no other references to it (ie: from any other</span>
03053         <span class="comment">// sessions).</span>
03054         <span class="comment">//</span>
03055 
03056         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BasedAddress);
03057         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((ULONG_PTR)BasedAddress + NumberOfBytes);
03058 
03059         PagesRequired = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (PointerPte,
03060                                                  (PFN_NUMBER)(LastPte - PointerPte),
03061                                                  ZeroKernelPte,
03062                                                  TRUE,
03063                                                  &amp;ResidentPages);
03064 
03065         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a26">MmDisablePagingExecutive</a> == 0) {
03066 
03067             SectionPointer = (<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)DataTableEntry-&gt;SectionPointer;
03068         
03069             <span class="keywordflow">if</span> ((SectionPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
03070                 (SectionPointer == (PVOID)-1) ||
03071                 (SectionPointer-&gt;Segment == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
03072                 (SectionPointer-&gt;Segment-&gt;BasedAddress != SectionPointer-&gt;Segment-&gt;SystemImageBase)) {
03073 
03074                 <a class="code" href="../../d6/d8/sysinfo_8c.html#a14">MmTotalSystemDriverPages</a> -= (ULONG)(PagesRequired - ResidentPages);
03075             }
03076         }
03077 
03078         <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
03079         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= CommittedPages;
03080 
03081         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a>(MM_DBG_SESSION_COMMIT_IMAGE_UNLOAD,
03082             CommittedPages);
03083 
03084         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
03085 
03086         ViewDeleted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03087 
03088         <span class="comment">//</span>
03089         <span class="comment">// Return the commitment we took out on the pagefile when the</span>
03090         <span class="comment">// image was allocated.</span>
03091         <span class="comment">//</span>
03092 
03093         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (CommittedPages);
03094         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_DRIVER_UNLOAD, CommittedPages);
03095 
03096         <span class="comment">//</span>
03097         <span class="comment">// Tell the session space image handler that we are releasing</span>
03098         <span class="comment">// our claim to the image.</span>
03099         <span class="comment">//</span>
03100 
03101         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a18">MiRemoveImageSessionWide</a> (BasedAddress);
03102 
03103         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NT_SUCCESS (Status));
03104     }
03105 
03106     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DataTableEntry-&gt;LoadCount != 0);
03107 
03108     DataTableEntry-&gt;LoadCount -= 1;
03109 
03110     <span class="keywordflow">if</span> (DataTableEntry-&gt;LoadCount != 0) {
03111         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
03112         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;MmSystemLoadLock, 1, FALSE, FALSE);
03113         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03114         <span class="keywordflow">return</span> STATUS_SUCCESS;
03115     }
03116 
03117 <span class="preprocessor">#if DBG</span>
03118 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (BasedAddress)) {
03119         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiSessionLookupImage (BasedAddress) == NULL);
03120     }
03121 <span class="preprocessor">#endif</span>
03122 <span class="preprocessor"></span>
03123     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a32">MmSnapUnloads</a>) {
03124 <span class="preprocessor">#if 0</span>
03125 <span class="preprocessor"></span>        StillQueued = <a class="code" href="../../d3/d2/timerobj_8c.html#a9">KeCheckForTimer</a> (DataTableEntry-&gt;DllBase,
03126                                        DataTableEntry-&gt;SizeOfImage);
03127 
03128         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03129             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03130                           0x18,
03131                           (ULONG_PTR)StillQueued,
03132                           (ULONG_PTR)-1,
03133                           (ULONG_PTR)DataTableEntry-&gt;DllBase);
03134         }
03135 
03136         StillQueued = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a34">ExpCheckForResource</a> (DataTableEntry-&gt;DllBase,
03137                                            DataTableEntry-&gt;SizeOfImage);
03138 
03139         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03140             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03141                           0x19,
03142                           (ULONG_PTR)StillQueued,
03143                           (ULONG_PTR)-1,
03144                           (ULONG_PTR)DataTableEntry-&gt;DllBase);
03145         }
03146 <span class="preprocessor">#endif</span>
03147 <span class="preprocessor"></span>    }
03148 
03149     <span class="keywordflow">if</span> (DataTableEntry-&gt;Flags &amp; LDRP_IMAGE_VERIFYING) {
03150         <a class="code" href="../../d9/d5/verifier_8c.html#a111">MiVerifyingDriverUnloading</a> (DataTableEntry);
03151     }
03152 
03153     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a554">MiActiveVerifierThunks</a> != 0) {
03154         <a class="code" href="../../d9/d5/verifier_8c.html#a106">MiVerifierCheckThunks</a> (DataTableEntry);
03155     }
03156 
03157     <span class="comment">//</span>
03158     <span class="comment">// Unload symbols from debugger.</span>
03159     <span class="comment">//</span>
03160 
03161     <span class="keywordflow">if</span> (DataTableEntry-&gt;Flags &amp; LDRP_DEBUG_SYMBOLS_LOADED) {
03162 
03163         <span class="comment">//</span>
03164         <span class="comment">//  TEMP TEMP TEMP rip out when debugger converted</span>
03165         <span class="comment">//</span>
03166 
03167         ANSI_STRING AnsiName;
03168         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03169 
03170         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>( &amp;AnsiName,
03171                                                &amp;DataTableEntry-&gt;BaseDllName,
03172                                                TRUE );
03173 
03174         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status)) {
03175             DbgUnLoadImageSymbols( &amp;AnsiName,
03176                                    BasedAddress,
03177                                    (ULONG)-1);
03178             <a class="code" href="../../d6/d6/nls_8c.html#a35">RtlFreeAnsiString</a>( &amp;AnsiName );
03179         }
03180     }
03181 
03182     <span class="comment">//</span>
03183     <span class="comment">// No unload can happen till after Mm has finished Phase 1 initialization.</span>
03184     <span class="comment">// Therefore, large pages are already in effect (if this platform supports</span>
03185     <span class="comment">// it).</span>
03186     <span class="comment">//</span>
03187 
03188     <span class="keywordflow">if</span> (ViewDeleted == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03189 
03190         NumberOfPtes = DataTableEntry-&gt;SizeOfImage &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03191 
03192         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a32">MmSnapUnloads</a>) {
03193             <a class="code" href="../../d8/d8/sysload_8c.html#a46">MiRememberUnloadedDriver</a> (&amp;DataTableEntry-&gt;BaseDllName,
03194                                       BasedAddress,
03195                                       (ULONG)(NumberOfPtes &lt;&lt; PAGE_SHIFT));
03196         }
03197 
03198         <span class="keywordflow">if</span> (DataTableEntry-&gt;Flags &amp; LDRP_SYSTEM_MAPPED) {
03199 
03200             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BasedAddress);
03201 
03202             PagesRequired = <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (PointerPte,
03203                                                      NumberOfPtes,
03204                                                      ZeroKernelPte,
03205                                                      FALSE,
03206                                                      &amp;ResidentPages);
03207     
03208             <a class="code" href="../../d6/d8/sysinfo_8c.html#a14">MmTotalSystemDriverPages</a> -= (ULONG)(PagesRequired - ResidentPages);
03209 
03210             <span class="comment">//</span>
03211             <span class="comment">// Note that drivers loaded at boot that have not been relocated</span>
03212             <span class="comment">// have no system PTEs or commit charged.</span>
03213             <span class="comment">//</span>
03214     
03215             <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte,
03216                                  (ULONG)NumberOfPtes,
03217                                  SystemPteSpace);
03218 
03219             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03220             <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += ResidentPages;
03221             <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(21, ResidentPages);
03222             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03223 
03224             <span class="comment">//</span>
03225             <span class="comment">// Only return commitment for drivers that weren't loaded by the</span>
03226             <span class="comment">// boot loader.</span>
03227             <span class="comment">//</span>
03228     
03229             <span class="keywordflow">if</span> (DataTableEntry-&gt;SectionPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03230                 <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (PagesRequired);
03231                 <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_DRIVER_UNLOAD1, PagesRequired);
03232                 <a class="code" href="../../d8/d5/kddata_8c.html#a32">MmDriverCommit</a> -= (ULONG)PagesRequired;
03233             }
03234         }
03235         <span class="keywordflow">else</span> {
03236 
03237             <span class="comment">//</span>
03238             <span class="comment">// This must be a boot driver that was not relocated into</span>
03239             <span class="comment">// system PTEs.  If large or super pages are enabled, the</span>
03240             <span class="comment">// image pages must be freed without referencing the</span>
03241             <span class="comment">// non-existent page table pages.  If large/super pages are</span>
03242             <span class="comment">// not enabled, note that system PTEs were not used to map the</span>
03243             <span class="comment">// image and thus, cannot be freed.</span>
03244 
03245             <span class="comment">//</span>
03246             <span class="comment">// This is further complicated by the fact that the INIT and/or</span>
03247             <span class="comment">// discardable portions of these images may have already been freed.</span>
03248             <span class="comment">//</span>
03249         }
03250     }
03251 
03252     <span class="comment">//</span>
03253     <span class="comment">// Search the loaded module list for the data table entry that describes</span>
03254     <span class="comment">// the DLL that was just unloaded. It is possible an entry is not in the</span>
03255     <span class="comment">// list if a failure occurred at a point in loading the DLL just before</span>
03256     <span class="comment">// the data table entry was generated.</span>
03257     <span class="comment">//</span>
03258 
03259     <span class="keywordflow">if</span> (DataTableEntry-&gt;InLoadOrderLinks.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03260         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
03261         <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;PsLoadedModuleResource, TRUE);
03262 
03263         ExAcquireSpinLock (&amp;PsLoadedModuleSpinLock, &amp;OldIrql);
03264 
03265         RemoveEntryList(&amp;DataTableEntry-&gt;InLoadOrderLinks);
03266         ExReleaseSpinLock (&amp;PsLoadedModuleSpinLock, OldIrql);
03267 
03268         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;PsLoadedModuleResource);
03269         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03270 
03271         MustFree = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03272     }
03273     <span class="keywordflow">else</span> {
03274         MustFree = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03275     }
03276 
03277     <span class="comment">//</span>
03278     <span class="comment">// Handle unloading of any dependent DLLs that we loaded automatically</span>
03279     <span class="comment">// for this image.</span>
03280     <span class="comment">//</span>
03281 
03282     <a class="code" href="../../d8/d8/sysload_8c.html#a42">MiDereferenceImports</a> ((<a class="code" href="../../d9/d1/struct__LOAD__IMPORTS.html">PLOAD_IMPORTS</a>)DataTableEntry-&gt;LoadedImports);
03283 
03284     <a class="code" href="../../d8/d8/sysload_8c.html#a37">MiClearImports</a> (DataTableEntry);
03285 
03286     <span class="comment">//</span>
03287     <span class="comment">// Free this loader entry.</span>
03288     <span class="comment">//</span>
03289 
03290     <span class="keywordflow">if</span> (MustFree == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03291 
03292         <span class="keywordflow">if</span> (DataTableEntry-&gt;FullDllName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03293             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DataTableEntry-&gt;FullDllName.Buffer);
03294         }
03295 
03296         <span class="keywordflow">if</span> (DataTableEntry-&gt;BaseDllName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03297             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (DataTableEntry-&gt;BaseDllName.Buffer);
03298         }
03299 
03300         <span class="comment">//</span>
03301         <span class="comment">// Dereference the section object if there is one.</span>
03302         <span class="comment">// There should only be one for win32k.sys and Hydra session images.</span>
03303         <span class="comment">//</span>
03304 
03305         <span class="keywordflow">if</span> ((DataTableEntry-&gt;SectionPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03306             (DataTableEntry-&gt;SectionPointer != (PVOID)-1)) {
03307 
03308             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (DataTableEntry-&gt;SectionPointer);
03309         }
03310 
03311         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)DataTableEntry);
03312     }
03313 
03314     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
03315 
03316     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;MmSystemLoadLock, 1, FALSE, FALSE);
03317     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03318 
03319     <a class="code" href="../../d2/d1/mm_8h.html#a63">PERFINFO_IMAGE_UNLOAD</a>(BasedAddress);
03320 
03321     <span class="keywordflow">return</span> STATUS_SUCCESS;
03322 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a264" doxytag="mm.h::MmUnlockCachedPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmUnlockCachedPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>AddressInCache</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d4/mapcache_8c-source.html#l01833">1833</a> of file <a class="el" href="../../d2/d4/mapcache_8c-source.html">mapcache.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01470">MI_REMOVE_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cachesub_8c-source.html#l05885">CcFreeActiveVacb()</a>.
<p>
<pre class="fragment"><div>01839                    :
01840 
01841     This routine unlocks a previous locked cached page.
01842 
01843 Arguments:
01844 
01845     AddressInCache - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page was locked
01846                      in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cache.  This must be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same
01847                      address that <a class="code" href="../../d2/d1/mm_8h.html#a263">MmCopyToCachedPage</a> was called with.
01848 
01849 Return Value:
01850 
01851     None.
01852 
01853 --*/
01854 
01855 {
01856     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01857     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01858     KIRQL OldIrql;
01859 
01860     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (AddressInCache);
01861 
01862     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
01863     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01864 
01865     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01866 
01867     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &lt;= 1) {
01868         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
01869                       0x777,
01870                       (ULONG_PTR)PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber,
01871                       Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount,
01872                       (ULONG_PTR)AddressInCache);
01873         <span class="keywordflow">return</span>;
01874     }
01875 
01876     <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a>(Pfn1, 25);
01877     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount -= 1;
01878 
01879     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01880     <span class="keywordflow">return</span>;
01881 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a312" doxytag="mm.h::MmUnlockPagableImageSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmUnlockPagableImageSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ImageSectionHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">7065</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00167">KePulseEvent()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01470">MI_REMOVE_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00206">MmCollidedLockEvent</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00207">MmCollidedLockWait</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00209">MmLockedCode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01985">SECTION_BASE_ADDRESS</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03579">ExpGetLockInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03661">ExpGetLookasideInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03846">ExpGetPoolInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03060">ExpGetProcessInformation()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11239">IoUnregisterShutdownNotification()</a>, <a class="el" href="../../d0/d1/cyrix_8c-source.html#l00270">Ke386ConfigureCyrixProcessor()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00576">KeSetPhysicalCacheTypeRange()</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00294">KiAmdK6MtrrSetMemoryType()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02715">MiEmptyAllWorkingSets()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02664">MiFreeInitializationCode()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03268">MiMapViewInSystemSpace()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02309">MiSetPagingOfDriver()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00119">MiShareSessionImage()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03253">MiUnmapLockedPagesInUserSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03683">MiUnmapViewInSystemSpace()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05581">MmAllocateNonCachedMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02106">MmFreeDriverInitialization()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05721">MmFreeNonCachedMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05051">MmFreePagesFromMdl()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07821">MmLockPagedPool()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02560">MmResetDriverPaging()</a>, <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07869">MmUnlockPagedPool()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00061">NtQueryVirtualMemory()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00291">PspQueryPooledQuotaLimits()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00209">PspQueryQuotaLimits()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00113">PspQueryWorkingSetWatch()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01211">PspSetQuotaLimits()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01050">SmbTraceStop()</a>.
<p>
<pre class="fragment"><div>07071                    :
07072 
07073     This function unlocks from memory, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages locked by a preceding call to
07074     <a class="code" href="../../d2/d1/mm_8h.html#a306">MmLockPagableDataSection</a>.
07075 
07076 Arguments:
07077 
07078     ImageSectionHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value returned by a previous call
07079         to <a class="code" href="../../d2/d1/mm_8h.html#a306">MmLockPagableDataSection</a>.
07080 
07081 Return Value:
07082 
07083     None.
07084 
07085 --*/
07086 
07087 {
07088     PIMAGE_SECTION_HEADER NtSection;
07089     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
07090     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
07091     PFN_NUMBER PageFrameIndex;
07092     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
07093     KIRQL OldIrql;
07094     PVOID BaseAddress;
07095     ULONG SizeToUnlock;
07096     ULONG Collision;
07097 
07098     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(ImageSectionHandle)) {
07099 
07100         <span class="comment">//</span>
07101         <span class="comment">// No need to lock physical addresses.</span>
07102         <span class="comment">//</span>
07103 
07104         <span class="keywordflow">return</span>;
07105     }
07106 
07107     NtSection = (PIMAGE_SECTION_HEADER)ImageSectionHandle;
07108 
07109     BaseAddress = <a class="code" href="../../d4/d8/mi_8h.html#a217">SECTION_BASE_ADDRESS</a>(NtSection);
07110     SizeToUnlock = NtSection-&gt;SizeOfRawData;
07111 
07112     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(BaseAddress);
07113     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>((PCHAR)BaseAddress + SizeToUnlock - 1);
07114 
07115     <span class="comment">//</span>
07116     <span class="comment">// Address must be within the system cache.</span>
07117     <span class="comment">//</span>
07118 
07119     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
07120 
07121     <span class="comment">//</span>
07122     <span class="comment">// The NumberOfLinenumbers field is used to store the</span>
07123     <span class="comment">// lock count.</span>
07124     <span class="comment">//</span>
07125 
07126     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NtSection-&gt;NumberOfLinenumbers &gt;= 2);
07127     NtSection-&gt;NumberOfLinenumbers -= 1;
07128 
07129     <span class="keywordflow">if</span> (NtSection-&gt;NumberOfLinenumbers != 1) {
07130         <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
07131         <span class="keywordflow">return</span>;
07132     }
07133 
07134     <span class="keywordflow">do</span> {
07135         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
07136 
07137         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
07138         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
07139 
07140         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
07141 
07142         <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a> (Pfn1, 37);
07143 
07144         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
07145 
07146         PointerPte += 1;
07147 
07148     } <span class="keywordflow">while</span> (PointerPte &lt;= LastPte);
07149 
07150     NtSection-&gt;NumberOfLinenumbers -= 1;
07151     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NtSection-&gt;NumberOfLinenumbers == 0);
07152     Collision = <a class="code" href="../../d5/d6/iosup_8c.html#a19">MmCollidedLockWait</a>;
07153     <a class="code" href="../../d5/d6/iosup_8c.html#a19">MmCollidedLockWait</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07154     <a class="code" href="../../d5/d6/iosup_8c.html#a20">MmLockedCode</a> -= SizeToUnlock;
07155 
07156     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
07157 
07158     <span class="keywordflow">if</span> (Collision) {
07159         <a class="code" href="../../d2/d8/eventobj_8c.html#a5">KePulseEvent</a> (&amp;MmCollidedLockEvent, 0, FALSE);
07160     }
07161 
07162     <span class="keywordflow">return</span>;
07163 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a309" doxytag="mm.h::MmUnlockPagedPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmUnlockPagedPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07869">7869</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01470">MI_REMOVE_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/i386_2ldtsup_8c-source.html#l00255">Ke386SetDescriptorProcess()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l05376">MiSetImageProtect()</a>.
<p>
<pre class="fragment"><div>07876                    :
07877 
07878     Unlocks paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> that was locked with <a class="code" href="../../d2/d1/mm_8h.html#a308">MmLockPagedPool</a>.
07879 
07880 Arguments:
07881 
07882     Address - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address in paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to unlock.
07883 
07884     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size to unlock.
07885 
07886 Return Value:
07887 
07888     None.
07889 
07890 Environment:
07891 
07892     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
07893 
07894 --*/
07895 
07896 {
07897     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
07898     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
07899     KIRQL OldIrql;
07900     PFN_NUMBER PageFrameIndex;
07901     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
07902 
07903     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
07904     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Address);
07905     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PVOID)((PCHAR)Address + (SizeInBytes - 1)));
07906     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
07907 
07908     <span class="keywordflow">do</span> {
07909         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
07910 
07911         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
07912         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
07913 
07914         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
07915 
07916         <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a> (Pfn1, 35);
07917 
07918         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
07919 
07920         PointerPte += 1;
07921     } <span class="keywordflow">while</span> (PointerPte &lt;= LastPte);
07922 
07923     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
07924     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
07925     <span class="keywordflow">return</span>;
07926 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a274" doxytag="mm.h::MmUnlockPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmUnlockPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>MemoryDescriptorList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a287" doxytag="mm.h::MmUnmapIoSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmUnmapIoSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l03678">3678</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01823">MiInsertDeadPteTrackingBlock()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00822">MiLockSystemSpace</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01675">MiRemovePteTracker()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00825">MiUnlockSystemSpace</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00093">MmTrackPtes</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/rules_8c-source.html#l02173">CmpFindACPITable()</a>, <a class="el" href="../../d0/d3/rules_8c-source.html#l01623">CmpMatchAcpiCreatorIdRule()</a>, <a class="el" href="../../d0/d3/rules_8c-source.html#l01540">CmpMatchAcpiCreatorRevisionRule()</a>, <a class="el" href="../../d0/d3/rules_8c-source.html#l01171">CmpMatchAcpiOemIdRule()</a>, <a class="el" href="../../d0/d3/rules_8c-source.html#l01372">CmpMatchAcpiOemRevisionRule()</a>, <a class="el" href="../../d0/d3/rules_8c-source.html#l01288">CmpMatchAcpiOemTableIdRule()</a>, <a class="el" href="../../d0/d3/rules_8c-source.html#l01456">CmpMatchAcpiRevisionRule()</a>, <a class="el" href="../../d7/d7/fsvga_8c-source.html#l00053">DriverEntry()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05414">MmFreeContiguousMemorySpecifyCache()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07751">MmUnmapVideoDisplay()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l00906">VerifierUnmapIoSpace()</a>.
<p>
<pre class="fragment"><div>03685                    :
03686 
03687     This function unmaps a range of physical address which were previously
03688     mapped via an <a class="code" href="../../d2/d1/mm_8h.html#a286">MmMapIoSpace</a> function call.
03689 
03690 Arguments:
03691 
03692     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <span class="keyword">virtual</span> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical
03693                   address was previously mapped.
03694 
03695     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes which were mapped.
03696 
03697 Return Value:
03698 
03699     None.
03700 
03701 Environment:
03702 
03703     Kernel mode, Should be IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below, but unfortunately
03704     callers are coming in at <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> and <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>'s too late to change <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03705     rules now.  This means you can never make <span class="keyword">this</span> routine pagable.
03706 
03707 --*/
03708 
03709 {
03710     PFN_NUMBER NumberOfPages;
03711     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPte;
03712     KIRQL OldIrql;
03713     PVOID PoolBlock;
03714 
03715     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03716     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes != 0);
03717     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (BaseAddress, NumberOfBytes);
03718     FirstPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
03719     <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a>(FirstPte, (ULONG)NumberOfPages, SystemPteSpace);
03720 
03721     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a> != 0) {
03722         <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
03723 
03724         PoolBlock = <a class="code" href="../../d5/d6/iosup_8c.html#a34">MiRemovePteTracker</a> (NULL,
03725                                         FirstPte,
03726                                         NumberOfPages);
03727         <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
03728 
03729         <span class="comment">//</span>
03730         <span class="comment">// Can't free the pool block here because we may be getting called</span>
03731         <span class="comment">// from the fault path in MiWaitForInPageComplete holding the PFN</span>
03732         <span class="comment">// lock.  Queue the block for later release.</span>
03733         <span class="comment">//</span>
03734 
03735         <span class="keywordflow">if</span> (PoolBlock) {
03736             <a class="code" href="../../d5/d6/iosup_8c.html#a36">MiInsertDeadPteTrackingBlock</a> (PoolBlock);
03737         }
03738     }
03739 
03740     <span class="keywordflow">return</span>;
03741 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a280" doxytag="mm.h::MmUnmapLockedPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmUnmapLockedPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">3124</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00435">MDL_IO_SPACE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00433">MDL_LOCK_HELD</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00432">MDL_PARENT_MAPPED_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00429">MDL_PARTIAL_HAS_BEEN_MAPPED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00434">MDL_PHYSICAL_VIEW</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01823">MiInsertDeadPteTrackingBlock()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00822">MiLockSystemSpace</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01675">MiRemovePteTracker()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00825">MiUnlockSystemSpace</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03253">MiUnmapLockedPagesInUserSpace()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00093">MmTrackPtes</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00145">ExpProfileDelete()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01095">MiCheckForCrashDump()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01075">MiCleanSection()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l01424">MiCreateImageFileMap()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00529">MiDoMappedCopy()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01014">MiFlushSectionInternal()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05287">MiMakeOutswappedPageResident()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l02335">MiWaitForInPageComplete()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02234">MiWriteComplete()</a>, <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01347">MmUnlockPages()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00680">NtStopProfile()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l00874">VerifierUnmapLockedPages()</a>.
<p>
<pre class="fragment"><div>03131                    :
03132 
03133     This routine unmaps locked pages which were previously mapped via
03134     a <a class="code" href="../../d2/d1/mm_8h.html#a276">MmMapLockedPages</a> call.
03135 
03136 Arguments:
03137 
03138     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages were previously
03139                   mapped.
03140 
03141     MemoryDescriptorList - Supplies a valid Memory Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> which has
03142                             been updated by <a class="code" href="../../d2/d1/mm_8h.html#a273">MmProbeAndLockPages</a>.
03143 
03144 Return Value:
03145 
03146     None.
03147 
03148 Environment:
03149 
03150     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below <span class="keywordflow">if</span> base address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within
03151     system space; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below <span class="keywordflow">if</span> base address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> user space.
03152 
03153 --*/
03154 
03155 {
03156     PFN_NUMBER NumberOfPages;
03157     PFN_NUMBER i;
03158     PPFN_NUMBER Page;
03159     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03160     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerBase;
03161     PVOID StartingVa;
03162     KIRQL OldIrql;
03163     PVOID PoolBlock;
03164 
03165     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MemoryDescriptorList-&gt;ByteCount != 0);
03166     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; MDL_PARENT_MAPPED_SYSTEM_VA) == 0);
03167 
03168     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a> (BaseAddress)) {
03169 
03170         <span class="comment">//</span>
03171         <span class="comment">// MDL is not mapped into virtual space, just clear the fields</span>
03172         <span class="comment">// and return.</span>
03173         <span class="comment">//</span>
03174 
03175         MemoryDescriptorList-&gt;MdlFlags &amp;= ~(<a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a> |
03176                                             <a class="code" href="../../d0/d9/ntosdef_8h.html#a17">MDL_PARTIAL_HAS_BEEN_MAPPED</a>);
03177         <span class="keywordflow">return</span>;
03178     }
03179 
03180     <span class="keywordflow">if</span> (BaseAddress &gt; MM_HIGHEST_USER_ADDRESS) {
03181 
03182         StartingVa = (PVOID)((PCHAR)MemoryDescriptorList-&gt;StartVa +
03183                         MemoryDescriptorList-&gt;ByteOffset);
03184 
03185         NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (StartingVa,
03186                                                MemoryDescriptorList-&gt;ByteCount);
03187 
03188         PointerBase = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
03189 
03190 
03191         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; MDL_MAPPED_TO_SYSTEM_VA) != 0);
03192 
03193 
03194 <span class="preprocessor">#if DBG</span>
03195 <span class="preprocessor"></span>        PointerPte = PointerBase;
03196         i = NumberOfPages;
03197         Page = (PPFN_NUMBER)(MemoryDescriptorList + 1);
03198         <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a21">MDL_LOCK_HELD</a>) == 0) {
03199             <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
03200         }
03201 
03202         <span class="keywordflow">while</span> (i != 0) {
03203             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
03204             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (*Page == MI_GET_PAGE_FRAME_FROM_PTE (PointerPte));
03205             <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;MdlFlags &amp; (<a class="code" href="../../d0/d9/ntosdef_8h.html#a23">MDL_IO_SPACE</a> | <a class="code" href="../../d0/d9/ntosdef_8h.html#a22">MDL_PHYSICAL_VIEW</a>)) == 0) {
03206                 <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn3;
03207                 Pfn3 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
03208                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn3-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0);
03209             }
03210 
03211             Page += 1;
03212             PointerPte += 1;
03213             i -= 1;
03214         }
03215 
03216         <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a21">MDL_LOCK_HELD</a>) == 0) {
03217             <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
03218         }
03219 <span class="preprocessor">#endif //DBG</span>
03220 <span class="preprocessor"></span>
03221         MemoryDescriptorList-&gt;MdlFlags &amp;= ~(<a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a> |
03222                                             <a class="code" href="../../d0/d9/ntosdef_8h.html#a17">MDL_PARTIAL_HAS_BEEN_MAPPED</a>);
03223 
03224         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a> != 0) {
03225             <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
03226             PoolBlock = <a class="code" href="../../d5/d6/iosup_8c.html#a34">MiRemovePteTracker</a> (MemoryDescriptorList,
03227                                             PointerBase,
03228                                             NumberOfPages);
03229             <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
03230 
03231             <span class="comment">//</span>
03232             <span class="comment">// Can't free the pool block here because we may be getting called</span>
03233             <span class="comment">// from the fault path in MiWaitForInPageComplete holding the PFN</span>
03234             <span class="comment">// lock.  Queue the block for later release.</span>
03235             <span class="comment">//</span>
03236 
03237             <span class="keywordflow">if</span> (PoolBlock) {
03238                 <a class="code" href="../../d5/d6/iosup_8c.html#a36">MiInsertDeadPteTrackingBlock</a> (PoolBlock);
03239             }
03240         }
03241 
03242         <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerBase, (ULONG)NumberOfPages, SystemPteSpace);
03243         <span class="keywordflow">return</span>;
03244 
03245     } <span class="keywordflow">else</span> {
03246 
03247         <a class="code" href="../../d5/d6/iosup_8c.html#a30">MiUnmapLockedPagesInUserSpace</a> (BaseAddress,
03248                                        MemoryDescriptorList);
03249     }
03250 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a290" doxytag="mm.h::MmUnmapVideoDisplay" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmUnmapVideoDisplay           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07751">7751</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00591">KSEG0_BASE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01559">MiGetSubsectionAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01466">MiPteToProto</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03678">MmUnmapIoSpace()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00094">X64K</a>.
<p>
<pre class="fragment"><div>07758                    :
07759 
07760     This function unmaps a range of physical address which were previously
07761     mapped via an <a class="code" href="../../d2/d1/mm_8h.html#a289">MmMapVideoDisplay</a> function call.
07762 
07763 Arguments:
07764 
07765     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <span class="keyword">virtual</span> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical
07766                   address was previously mapped.
07767 
07768     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes which were mapped.
07769 
07770 Return Value:
07771 
07772     None.
07773 
07774 Environment:
07775 
07776     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
07777 
07778 --*/
07779 
07780 {
07781 
07782 <span class="preprocessor">#ifdef LARGE_PAGES</span>
07783 <span class="preprocessor"></span>    PFN_NUMBER NumberOfPages;
07784     ULONG i;
07785     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPte;
07786     KIRQL OldIrql;
07787     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LargePte;
07788     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
07789 
07790     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07791 
07792     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes != 0);
07793     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (BaseAddress, NumberOfBytes);
07794     FirstPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
07795 
07796     <span class="keywordflow">if</span> ((NumberOfBytes &gt; <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>) &amp;&amp; (FirstPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0)) {
07797 
07798         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmLargeVideoMapped);
07799         LargePte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (FirstPte);
07800         Subsection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (LargePte);
07801         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a> == FirstPte);
07802 
07803         NumberOfPages = Subsection-&gt;EndingSector;
07804         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Subsection);
07805         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (LargePte);
07806         MmLargeVideoMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07807         KeFillFixedEntryTb ((PHARDWARE_PTE)FirstPte, (PVOID)KSEG0_BASE, LARGE_ENTRY);
07808     }
07809     <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a>(FirstPte, NumberOfPages, SystemPteSpace);
07810     <span class="keywordflow">return</span>;
07811 
07812 <span class="preprocessor">#else // LARGE_PAGES</span>
07813 <span class="preprocessor"></span>
07814     <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a> (BaseAddress, NumberOfBytes);
07815     <span class="keywordflow">return</span>;
07816 <span class="preprocessor">#endif //LARGE_PAGES</span>
07817 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a318" doxytag="mm.h::MmUnmapViewInSessionSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS MmUnmapViewInSessionSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>MappedBase</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l03639">3639</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03683">MiUnmapViewInSystemSpace()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00044">MmSession</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05575">_MM_SESSION_SPACE::Session</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>03645                    :
03646 
03647     This routine unmaps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system's address space.
03648 
03649 Arguments:
03650 
03651     MappedBase - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view to unmap.
03652 
03653 Return Value:
03654 
03655     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map view operation.
03656 
03657 Environment:
03658 
03659     Kernel Mode, IRQL of dispatch level.
03660 
03661 --*/
03662 
03663 {
03664     <a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a> Session;
03665 
03666     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03667 
03668     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03669         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 0) {
03670             <span class="keywordflow">return</span> STATUS_NOT_MAPPED_VIEW;
03671         }
03672         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(MmSessionSpace) == TRUE);
03673         Session = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o34">Session</a>;
03674     }
03675     <span class="keywordflow">else</span> {
03676         Session = &amp;<a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>;
03677     }
03678 
03679     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/mapview_8c.html#a14">MiUnmapViewInSystemSpace</a> (Session, MappedBase);
03680 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a252" doxytag="mm.h::MmUnmapViewInSystemCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmUnmapViewInSystemCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionToUnmap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AddToFront</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00381">381</a> of file <a class="el" href="../../d2/d4/mapcache_8c-source.html">mapcache.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02001">_SEGMENT::ControlArea</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02228">MI_CAPTURE_DIRTY_BIT_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00641">MI_SET_PTE_IN_WORKING_SET</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00030">MiDecrementShareCount()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00248">MiLocateWsle()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01016">MiReleaseWsle()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00464">MiRemoveWsle()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00108">MM_EMPTY_PTE_LIST</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00051">MmFlushSystemCache</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00030">MmFrontOfList</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00049">MmLastFreeSystemCache</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00053">MmSystemCachePteBase</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04752">MmSystemCacheWorkingSetList</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02062">_CONTROL_AREA::NumberOfMappedViews</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02073">_CONTROL_AREA::NumberOfSystemCacheViews</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d6/d2/parseini_8c-source.html#l00036">PSECTION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02058">_CONTROL_AREA::Segment</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>, <a class="el" href="../../d2/d4/mapcache_8c-source.html#l00045">X256K</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/vacbsup_8c-source.html#l01156">CcUnmapVacb()</a>.
<p>
<pre class="fragment"><div>00389                    :
00390 
00391     This function unmaps a view from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cache.
00392 
00393     NOTE: When <span class="keyword">this</span> function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called, no pages may be locked in
00394     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified view.
00395 
00396 Arguments:
00397 
00398     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00399                   system cache.
00400 
00401     SectionToUnmap - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00402                      base address maps.
00403 
00404     AddToFront - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unmapped pages should be
00405                  added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> front of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> standby list (i.e., their
00406                  value in the cache is low).  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
00407 
00408 Return Value:
00409 
00410     none.
00411 
00412 Environment:
00413 
00414     Kernel mode.
00415 
00416 --*/
00417 
00418 {
00419     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00420     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00421     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPte;
00422     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00423     KIRQL OldIrql;
00424     KIRQL OldIrqlWs;
00425     PFN_NUMBER i;
00426     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
00427     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00428     ULONG WsHeld;
00429     PFN_NUMBER PdeFrameNumber;
00430 
00431     WsHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00432 
00433     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt;= APC_LEVEL);
00434 
00435     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
00436     FirstPte = PointerPte;
00437     ControlArea = ((<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>)SectionToUnmap)-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
00438     PdeFrameNumber = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (MiGetPteAddress (PointerPte));
00439 
00440     <span class="comment">//</span>
00441     <span class="comment">// Get the control area for the segment which is mapped here.</span>
00442     <span class="comment">//</span>
00443 
00444     i = 0;
00445 
00446     <span class="keywordflow">do</span> {
00447 
00448         <span class="comment">//</span>
00449         <span class="comment">// The cache is organized in chunks of 256k bytes, clear</span>
00450         <span class="comment">// the first chunk then check to see if this is the last</span>
00451         <span class="comment">// chunk.</span>
00452         <span class="comment">//</span>
00453 
00454         <span class="comment">//</span>
00455         <span class="comment">// The page table page is always resident for the system cache.</span>
00456         <span class="comment">// Check each PTE, it is in one of two states, either valid or</span>
00457         <span class="comment">// prototype PTE format.</span>
00458         <span class="comment">//</span>
00459 
00460         PteContents = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
00461         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00462 
00463             <span class="keywordflow">if</span> (!WsHeld) {
00464                 WsHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00465                 <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrqlWs);
00466                 <span class="keywordflow">continue</span>;
00467             }
00468 
00469             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00470 
00471             WorkingSetIndex = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (BaseAddress,
00472                                             MmSystemCacheWorkingSetList,
00473                                             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex );
00474             <a class="code" href="../../d7/d0/wstree_8c.html#a8">MiRemoveWsle</a> (WorkingSetIndex,
00475                           MmSystemCacheWorkingSetList );
00476             <a class="code" href="../../d4/d0/wslist_8c.html#a24">MiReleaseWsle</a> (WorkingSetIndex, &amp;MmSystemCacheWs);
00477 
00478             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPte, 0);
00479 
00480             <span class="comment">//</span>
00481             <span class="comment">// The PTE is valid.</span>
00482             <span class="comment">//</span>
00483 
00484             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00485 
00486             <span class="comment">//</span>
00487             <span class="comment">// Capture the state of the modified bit for this PTE.</span>
00488             <span class="comment">//</span>
00489 
00490             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a177">MI_CAPTURE_DIRTY_BIT_TO_PFN</a> (PointerPte, Pfn1);
00491 
00492             <span class="comment">//</span>
00493             <span class="comment">// Decrement the share and valid counts of the page table</span>
00494             <span class="comment">// page which maps this PTE.</span>
00495             <span class="comment">//</span>
00496 
00497             <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (PdeFrameNumber);
00498 
00499             <span class="comment">//</span>
00500             <span class="comment">// Decrement the share count for the physical page.</span>
00501             <span class="comment">//</span>
00502 
00503 <span class="preprocessor">#if DBG</span>
00504 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> == 1) {
00505                 <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn;
00506                 Pfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00507                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
00508             }
00509 <span class="preprocessor">#endif //DBG</span>
00510 <span class="preprocessor"></span>
00511 
00512             <a class="code" href="../../d1/d5/mapcache_8c.html#a1">MmFrontOfList</a> = AddToFront;
00513             <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (MI_GET_PAGE_FRAME_FROM_PTE (&amp;PteContents));
00514             <a class="code" href="../../d1/d5/mapcache_8c.html#a1">MmFrontOfList</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00515             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00516         } <span class="keywordflow">else</span> {
00517             <span class="keywordflow">if</span> (WsHeld) {
00518                 <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrqlWs);
00519                 WsHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00520             }
00521 
00522             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long) ||
00523                     (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1));
00524             NOTHING;
00525         }
00526         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, ZeroKernelPte);
00527 
00528         PointerPte += 1;
00529         BaseAddress = (PVOID)((PCHAR)BaseAddress + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00530         i += 1;
00531     } <span class="keywordflow">while</span> (i &lt; (<a class="code" href="../../d1/d5/mapcache_8c.html#a0">X256K</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>));
00532 
00533     <span class="keywordflow">if</span> (WsHeld) {
00534         <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrqlWs);
00535     }
00536 
00537     FirstPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a1">MM_EMPTY_PTE_LIST</a>;
00538 
00539     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00540 
00541     <span class="comment">//</span>
00542     <span class="comment">// Free this entry to the end of the list.</span>
00543     <span class="comment">//</span>
00544 
00545     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d5/mapcache_8c.html#a4">MmFlushSystemCache</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00546 
00547         <span class="comment">//</span>
00548         <span class="comment">// If there is no entry marked to initiate a TB flush when</span>
00549         <span class="comment">// reused, mark this entry as the one.  This way the TB</span>
00550         <span class="comment">// only needs to be flushed when the list wraps.</span>
00551         <span class="comment">//</span>
00552 
00553         <a class="code" href="../../d1/d5/mapcache_8c.html#a4">MmFlushSystemCache</a> = FirstPte;
00554     }
00555 
00556     <a class="code" href="../../d1/d5/mapcache_8c.html#a3">MmLastFreeSystemCache</a>-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.List.NextEntry = FirstPte - <a class="code" href="../../d1/d5/mapcache_8c.html#a5">MmSystemCachePteBase</a>;
00557     <a class="code" href="../../d1/d5/mapcache_8c.html#a3">MmLastFreeSystemCache</a> = FirstPte;
00558 
00559     <span class="comment">//</span>
00560     <span class="comment">// Decrement the number of mapped views for the segment</span>
00561     <span class="comment">// and check to see if the segment should be deleted.</span>
00562     <span class="comment">//</span>
00563 
00564     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
00565     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o14">NumberOfSystemCacheViews</a> -= 1;
00566 
00567     <span class="comment">//</span>
00568     <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
00569     <span class="comment">// This routine releases the PFN lock.</span>
00570     <span class="comment">//</span>
00571 
00572     <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
00573 
00574     <span class="keywordflow">return</span>;
00575 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a316" doxytag="mm.h::MmUnmapViewInSystemSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS MmUnmapViewInSystemSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>MappedBase</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l03608">3608</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d4/d4/mapview_8c-source.html#l03683">MiUnmapViewInSystemSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00044">MmSession</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l00199">NtMapViewOfSection()</a>.
<p>
<pre class="fragment"><div>03614                    :
03615 
03616     This routine unmaps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system's address space.
03617 
03618 Arguments:
03619 
03620     MappedBase - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view to unmap.
03621 
03622 Return Value:
03623 
03624     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map view operation.
03625 
03626 Environment:
03627 
03628     Kernel Mode, IRQL of dispatch level.
03629 
03630 --*/
03631 
03632 {
03633     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03634 
03635     <span class="keywordflow">return</span> <a class="code" href="../../d3/d5/mapview_8c.html#a14">MiUnmapViewInSystemSpace</a> (&amp;MmSession, MappedBase);
03636 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a242" doxytag="mm.h::MmUnmapViewOfSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI NTSTATUS MmUnmapViewOfSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/umapview_8c-source.html#l00090">90</a> of file <a class="el" href="../../d5/d8/umapview_8c-source.html">umapview.c</a>.
<p>
References <a class="el" href="../../d8/d2/dbgkproc_8c-source.html#l00664">DbgkUnMapViewOfSection()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01093">LOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01044">LOCK_WS_UNSAFE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00763">MI_VPN_TO_VA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00765">MI_VPN_TO_VA_ENDING</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l02244">MiCheckSecuredVad()</a>, <a class="el" href="../../d2/d9/miia64_8h.html#a308">MiDeleteFor4kPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00503">MiGetNextVad</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00480">MiGetPreviousVad</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00380">MiLocateAddress()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00265">MiRemoveMappedView()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00256">MiRemoveVad()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00869">MiReturnPageTablePageCommitment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00158">MM_SECURE_DELETE_CHECK</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01085">UNLOCK_WS_UNSAFE</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/ex_8c-source.html#l00278">CommitReadOnlyMemory()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l02949">FreeView()</a>, <a class="el" href="../../d4/d5/lpcclose_8c-source.html#l00110">LpcpDeletePort()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04868">MiGetWritablePagesInSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00033">NtUnmapViewOfSection()</a>, and <a class="el" href="../../d3/d8/w32_2ntuser_2kernel_2heap_8c-source.html#l00189">UserCreateHeap()</a>.
<p>
<pre class="fragment"><div>00097                    :
00098 
00099     This function unmaps a previously created view to a section.
00100 
00101 Arguments:
00102 
00103     Process - Supplies a referenced pointer to a process object.
00104 
00105     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view.
00106 
00107 Return Value:
00108 
00109     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status
00110 
00111     TBS
00112 
00113 
00114 --*/
00115 
00116 {
00117     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
00118     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> PreviousVad;
00119     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> NextVad;
00120     SIZE_T RegionSize;
00121     PVOID UnMapImageBase;
00122     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00123     BOOLEAN Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00124 
00125     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00126 
00127     UnMapImageBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00128 
00129     <span class="comment">//</span>
00130     <span class="comment">// If the specified process is not the current process, attach</span>
00131     <span class="comment">// to the specified process.</span>
00132     <span class="comment">//</span>
00133 
00134     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != Process) {
00135         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
00136         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00137     }
00138 
00139     <span class="comment">//</span>
00140     <span class="comment">// Get the address creation mutex to block multiple threads from</span>
00141     <span class="comment">// creating or deleting address space at the same time and</span>
00142     <span class="comment">// get the working set mutex so virtual address descriptors can</span>
00143     <span class="comment">// be inserted and walked.</span>
00144     <span class="comment">// Raise IRQL to block APCs.</span>
00145     <span class="comment">//</span>
00146     <span class="comment">// Get the working set mutex, no page faults allowed for now until</span>
00147     <span class="comment">// working set mutex released.</span>
00148     <span class="comment">//</span>
00149 
00150 
00151     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00152 
00153     <span class="comment">//</span>
00154     <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
00155     <span class="comment">//</span>
00156 
00157     <span class="keywordflow">if</span> (Process-&gt;AddressSpaceDeleted != 0) {
00158         status = STATUS_PROCESS_IS_TERMINATING;
00159         <span class="keywordflow">goto</span> ErrorReturn;
00160     }
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">// Find the associated vad.</span>
00164     <span class="comment">//</span>
00165 
00166     Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (BaseAddress);
00167 
00168     <span class="keywordflow">if</span> ((Vad == (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory)) {
00169 
00170         <span class="comment">//</span>
00171         <span class="comment">// No Virtual Address Descriptor located for Base Address.</span>
00172         <span class="comment">//</span>
00173 
00174         status = STATUS_NOT_MAPPED_VIEW;
00175         <span class="keywordflow">goto</span> ErrorReturn;
00176     }
00177 
00178     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange == 1) {
00179 
00180         <span class="comment">//</span>
00181         <span class="comment">// An attempt is being made to delete a secured VAD, check</span>
00182         <span class="comment">// the whole VAD to see if this deletion is allowed.</span>
00183         <span class="comment">//</span>
00184 
00185         status = <a class="code" href="../../d0/d9/protect_8c.html#a9">MiCheckSecuredVad</a> ((<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)Vad,
00186                                     MI_VPN_TO_VA (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>),
00187                                     ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> - Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) &lt;&lt; PAGE_SHIFT) +
00188                                             (PAGE_SIZE - 1),
00189                                     MM_SECURE_DELETE_CHECK);
00190 
00191         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00192             <span class="keywordflow">goto</span> ErrorReturn;
00193         }
00194     }
00195 
00196     <span class="comment">//</span>
00197     <span class="comment">// If this Vad is for an image section, then</span>
00198     <span class="comment">// get the base address of the section</span>
00199     <span class="comment">//</span>
00200 
00201     <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.ImageMap == 1) &amp;&amp; (Process == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>())) {
00202         UnMapImageBase = <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>);
00203     }
00204 
00205     RegionSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> + ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> - Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00206 
00207     PreviousVad = <a class="code" href="../../d4/d8/mi_8h.html#a95">MiGetPreviousVad</a> (Vad);
00208     NextVad = <a class="code" href="../../d4/d8/mi_8h.html#a96">MiGetNextVad</a> (Vad);
00209 
00210 
00211     <a class="code" href="../../d6/d3/vadtree_8c.html#a1">MiRemoveVad</a> (Vad);
00212 
00213     <span class="comment">//</span>
00214     <span class="comment">// Return commitment for page table pages if possible.</span>
00215     <span class="comment">//</span>
00216 
00217     <a class="code" href="../../d6/d1/mmquota_8c.html#a21">MiReturnPageTablePageCommitment</a> (MI_VPN_TO_VA (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>),
00218                                      <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>),
00219                                      Process,
00220                                      PreviousVad,
00221                                      NextVad);
00222 
00223     <a class="code" href="../../d4/d9/umapview_8c.html#a2">MiRemoveMappedView</a> (Process, Vad);
00224 
00225 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00226 <span class="preprocessor"></span>
00227     <span class="keywordflow">if</span> (Process-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00228 
00229         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
00230 
00231         <a class="code" href="../../d2/d9/miia64_8h.html#a308">MiDeleteFor4kPage</a>(MI_VPN_TO_VA (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>),
00232                           <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>),
00233                           Process);
00234 
00235         <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
00236 
00237     }
00238 
00239 <span class="preprocessor">#endif</span>
00240 <span class="preprocessor"></span>
00241     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
00242 
00243     <span class="comment">//</span>
00244     <span class="comment">// Update the current virtual size in the process header.</span>
00245     <span class="comment">//</span>
00246 
00247     Process-&gt;VirtualSize -= RegionSize;
00248     status = STATUS_SUCCESS;
00249 
00250 ErrorReturn:
00251 
00252     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
00253 
00254     <span class="keywordflow">if</span> ( UnMapImageBase ) {
00255         <a class="code" href="../../d4/d3/dbgk_8h.html#a4">DbgkUnMapViewOfSection</a>(UnMapImageBase);
00256     }
00257     <span class="keywordflow">if</span> (Attached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00258         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00259     }
00260 
00261     <span class="keywordflow">return</span> status;
00262 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a314" doxytag="mm.h::MmUnsecureVirtualMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmUnsecureVirtualMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SecureHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d4/mapview_8c-source.html#l04614">4614</a> of file <a class="el" href="../../d4/d4/mapview_8c-source.html">mapview.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02380">_MMSECURE_ENTRY::List</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01090">LOCK_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02375">_MMSECURE_ENTRY::LongFlags2</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00380">MiLocateAddress()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02378">_MMSECURE_ENTRY::StartVpn</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">_MMSECURE_ENTRY::u2</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o13">_MMVAD::u2</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o16">_MMVAD::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01101">UNLOCK_ADDRESS_SPACE</a>.
<p>
<pre class="fragment"><div>04620                    :
04621 
04622     This routine unsecures memory previous secured via a call to
04623     <a class="code" href="../../d2/d1/mm_8h.html#a313">MmSecureVirtualMemory</a>.
04624 
04625 Arguments:
04626 
04627     SecureHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle returned in <a class="code" href="../../d2/d1/mm_8h.html#a313">MmSecureVirtualMemory</a>.
04628 
04629 Return Value:
04630 
04631     None.
04632 
04633 Environment:
04634 
04635     Kernel Mode.
04636 
04637 --*/
04638 
04639 {
04640     <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a> Secure;
04641     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
04642     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
04643 
04644     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04645 
04646     Secure = (<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a>)SecureHandle;
04647     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
04648     <a class="code" href="../../d4/d8/mi_8h.html#a160">LOCK_ADDRESS_SPACE</a> (Process);
04649 
04650     <span class="keywordflow">if</span> (Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o2">u2</a>.VadFlags2.StoredInVad) {
04651         Vad = CONTAINING_RECORD( Secure,
04652                                  <a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>,
04653                                  u2.LongFlags2);
04654     } <span class="keywordflow">else</span> {
04655         Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> ((PVOID)Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o3">StartVpn</a>);
04656     }
04657 
04658     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad);
04659     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange == 1);
04660 
04661     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured) {
04662         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Secure == (<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a>)&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.LongFlags2);
04663         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.OneSecured = 0;
04664         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured == 0);
04665         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.SecNoChange == 0) {
04666 
04667             <span class="comment">//</span>
04668             <span class="comment">// No more secure entries in this list, remove the state.</span>
04669             <span class="comment">//</span>
04670 
04671             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 0;
04672         }
04673     } <span class="keywordflow">else</span> {
04674         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured == 1);
04675 
04676         <span class="keywordflow">if</span> (Secure == (<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a>)&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.LongFlags2) {
04677 
04678             <span class="comment">//</span>
04679             <span class="comment">// This was a single block that got converted into a list.</span>
04680             <span class="comment">// Reset the entry.</span>
04681             <span class="comment">//</span>
04682 
04683             Secure = CONTAINING_RECORD (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List.Flink,
04684                                         <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">MMSECURE_ENTRY</a>,
04685                                         List);
04686         }
04687         RemoveEntryList (&amp;Secure-&gt;<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">List</a>);
04688         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Secure);
04689         <span class="keywordflow">if</span> (IsListEmpty (&amp;Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o16">u3</a>.List)) {
04690 
04691             <span class="comment">//</span>
04692             <span class="comment">// No more secure entries, reset the state.</span>
04693             <span class="comment">//</span>
04694 
04695             Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.MultipleSecured = 0;
04696 
04697             <span class="keywordflow">if</span> ((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.SecNoChange == 0) &amp;&amp;
04698                (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 0)) {
04699 
04700                 <span class="comment">//</span>
04701                 <span class="comment">// No more secure entries in this list, remove the state</span>
04702                 <span class="comment">// if and only if this VAD is not private.  If this VAD</span>
04703                 <span class="comment">// is private, removing the state NoChange flag indicates</span>
04704                 <span class="comment">// that this is a short VAD which it no longer is.</span>
04705                 <span class="comment">//</span>
04706 
04707                 Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.NoChange = 0;
04708             }
04709         }
04710     }
04711 
04712     <a class="code" href="../../d4/d8/mi_8h.html#a163">UNLOCK_ADDRESS_SPACE</a> (Process);
04713     <span class="keywordflow">return</span>;
04714 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a337" doxytag="mm.h::MmVerifyImageIsOkForMpUse" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmVerifyImageIsOkForMpUse           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BaseAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/sysload_8c-source.html#l04923">4923</a> of file <a class="el" href="../../d9/d7/sysload_8c-source.html">sysload.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l04820">MmCheckSystemImage()</a>.
<p>
<pre class="fragment"><div>04926 {
04927     PIMAGE_NT_HEADERS NtHeaders;
04928 
04929     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04930 
04931     <span class="comment">//</span>
04932     <span class="comment">// If the file is an image file, then subtract the two checksum words</span>
04933     <span class="comment">// in the optional header from the computed checksum before adding</span>
04934     <span class="comment">// the file length, and set the value of the header checksum.</span>
04935     <span class="comment">//</span>
04936 
04937     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(BaseAddress);
04938     <span class="keywordflow">if</span> (NtHeaders != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04939         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a> &gt; 1 &amp;&amp;
04940              (NtHeaders-&gt;FileHeader.Characteristics &amp; IMAGE_FILE_UP_SYSTEM_ONLY) ) {
04941             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04942         }
04943     }
04944     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04945 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a228" doxytag="mm.h::MmWorkingSetManager" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmWorkingSetManager           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">397</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00216">_EPROCESS::AddressSpaceDeleted</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00066">_MMSUPPORT::AllowWorkingSetAdjustment</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00191">_MMWS_TRIM_CRITERIA::DesiredFreeGoal</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00598">ExTryToAcquireResourceExclusiveLite()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">_MMWS_TRIM_CRITERIA::FaultBased</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00273">_EPROCESS::ImageFileName</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00228">KeForceAttachProcess()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00058">_MMSUPPORT::LastTrimFaultCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00057">_MMSUPPORT::LastTrimTime</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02222">_MMWORKING_SET_EXPANSION_HEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l01181">MiAttachSession()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00163">MiCheckCounter</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01372">MiCheckProcessTrimCriteria()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01591">MiCheckSystemCacheWsTrimCriteria()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01218">MiCheckSystemTrimEndCriteria()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l01253">MiDetachSession()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01644">MiDetermineWsTrimAmount()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00062">_MMSUPPORT::MinimumWorkingSetSize</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03612">MiTrimWorkingSet()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00168">MM_DBG_WS_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00117">MM_FORCE_TRIM</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00099">MM_NO_WS_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05677">MM_SET_SESSION_RESOURCE_OWNER</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00101">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00100">MM_WS_EXPANSION_IN_PROGRESS</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05118">MmMinimumFreePages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01087">MmModifiedPageListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05122">MmModifiedPageMaximum</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05096">MmModifiedPageWriterEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00215">MmShortTime</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04752">MmSystemCacheWorkingSetList</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00996">MmSystemLockOwner</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04887">MmSystemWsLock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05071">MmWorkingSetExpansionHead</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00059">_MMSUPPORT::PageFaultCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02219">PERFINFO_WSMANAGE_ACTUALTRIM</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02220">PERFINFO_WSMANAGE_DECL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02225">PERFINFO_WSMANAGE_FINALACTION</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02230">PERFINFO_WSMANAGE_PROCESS_RESET</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02234">PERFINFO_WSMANAGE_TOTRIM</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02236">PERFINFO_WSMANAGE_TRIMEND_CLAIMS</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02237">PERFINFO_WSMANAGE_TRIMEND_FAULTS</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02238">PERFINFO_WSMANAGE_TRIMWS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05524">_MM_SESSION_SPACE::ProcessOutSwapCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00213">_EPROCESS::ProcessOutswapEnabled</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00214">_EPROCESS::ProcessOutswapped</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01598">_MMWSL::Quota</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05416">_MM_SESSION_SPACE::SessionId</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01081">UNLOCK_WS</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00064">_MMSUPPORT::VmWorkingSetList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00065">_MMSUPPORT::WorkingSetExpansionLinks</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00211">_EPROCESS::WorkingSetLock</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l05559">_MM_SESSION_SPACE::WsLock</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">KeBalanceSetManager()</a>.
<p>
<pre class="fragment"><div>00403                    :
00404 
00405     Implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT working set manager thread.  When <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number
00406     of free pages becomes critical and ample pages can be obtained by
00407     reducing working sets, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set manager's event <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, and
00408     <span class="keyword">this</span> thread becomes active.
00409 
00410 Arguments:
00411 
00412     None.
00413 
00414 Return Value:
00415 
00416     None.
00417 
00418 Environment:
00419 
00420     Kernel mode.
00421 
00422 --*/
00423 
00424 {
00425 
00426     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00427     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToTrim;
00428     PLIST_ENTRY ListEntry;
00429     LOGICAL Attached;
00430     ULONG Trim;
00431     KIRQL OldIrql;
00432     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport;
00433     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
00434     LARGE_INTEGER CurrentTime;
00435     ULONG count;
00436     LOGICAL DoTrimming;
00437     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionSpace;
00438     LOGICAL InformSessionOfRelease;
00439 <span class="preprocessor">#if DBG</span>
00440 <span class="preprocessor"></span>    ULONG LastTrimFaultCount;
00441 <span class="preprocessor">#endif // DBG</span>
00442 <span class="preprocessor"></span>    <a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">MMWS_TRIM_CRITERIA</a> TrimCriteria;
00443     <a class="code" href="../../d2/d1/mm_8h.html#a99">PERFINFO_WSMANAGE_DECL</a>();
00444 
00445 <span class="preprocessor">#if DBG</span>
00446 <span class="preprocessor"></span>    MmWorkingSetThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
00447 <span class="preprocessor">#endif</span>
00448 <span class="preprocessor"></span>
00449     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == FALSE || MmIsAddressValid (MmSessionSpace) == FALSE);
00450 
00451     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
00452 
00453     Trim = 0;
00454 
00455     <span class="comment">//</span>
00456     <span class="comment">// Set the trim criteria: If there are plenty of pages, the existing</span>
00457     <span class="comment">// sets are aged and FALSE is returned to signify no trim is necessary.</span>
00458     <span class="comment">// Otherwise, the working set expansion list is ordered so the best</span>
00459     <span class="comment">// candidates for trimming are placed at the front and TRUE is returned.</span>
00460     <span class="comment">//</span>
00461 
00462     DoTrimming = <a class="code" href="../../d5/d0/wsmanage_8c.html#a42">MiCheckAndSetSystemTrimCriteria</a>(&amp;TrimCriteria);
00463 
00464     <span class="keywordflow">if</span> (DoTrimming) {
00465  
00466         Attached = 0;
00467 
00468         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;CurrentTime);
00469 
00470         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == FALSE || MmIsAddressValid (MmSessionSpace) == FALSE);
00471 
00472         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00473         <span class="keywordflow">while</span> (!IsListEmpty (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>)) {
00474 
00475             <span class="comment">//</span>
00476             <span class="comment">// Remove the entry at the head and trim it.</span>
00477             <span class="comment">//</span>
00478 
00479             ListEntry = RemoveHeadList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>);
00480 
00481             <span class="keywordflow">if</span> (ListEntry == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>) {
00482                 VmSupport = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
00483                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
00484                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.TrimHard == 0);
00485                 SessionSpace = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00486             }
00487             <span class="keywordflow">else</span> {
00488                 VmSupport = CONTAINING_RECORD(ListEntry,
00489                                               <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">MMSUPPORT</a>,
00490                                               WorkingSetExpansionLinks);
00491 
00492                 <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
00493                     ProcessToTrim = CONTAINING_RECORD(VmSupport,
00494                                                       <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,
00495                                                       Vm);
00496 
00497                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport == &amp;ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>);
00498                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> == 0);
00499                     SessionSpace = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00500                 }
00501                 <span class="keywordflow">else</span> {
00502                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
00503                     SessionSpace = CONTAINING_RECORD(VmSupport,
00504                                                      <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">MM_SESSION_SPACE</a>,
00505                                                      Vm);
00506                 }
00507             }
00508 
00509             <span class="comment">//</span>
00510             <span class="comment">// Note that other routines that set this bit must remove the</span>
00511             <span class="comment">// entry from the expansion list first.</span>
00512             <span class="comment">//</span>
00513 
00514             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 0);
00515 
00516             <span class="comment">//</span>
00517             <span class="comment">// Check to see if we've been here before.</span>
00518             <span class="comment">//</span>
00519 
00520             <span class="keywordflow">if</span> ((*(PLARGE_INTEGER)&amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a>).QuadPart ==
00521                        (*(PLARGE_INTEGER)&amp;CurrentTime).QuadPart) {
00522 
00523                 InsertHeadList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00524                             &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00525 
00526                 <span class="comment">//</span>
00527                 <span class="comment">// If we aren't finished we may sleep in this call.</span>
00528                 <span class="comment">//</span>
00529 
00530                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a43">MiCheckSystemTrimEndCriteria</a>(&amp;TrimCriteria, OldIrql)) {
00531 
00532                     <span class="comment">//</span>
00533                     <span class="comment">// No more pages are needed so we're done.</span>
00534                     <span class="comment">//</span>
00535 
00536                     <span class="keywordflow">break</span>;
00537                 }
00538 
00539                 <span class="comment">//</span>
00540                 <span class="comment">// Start a new round of trimming.</span>
00541                 <span class="comment">//</span>
00542 
00543                 <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;CurrentTime);
00544 
00545                 <span class="keywordflow">continue</span>;
00546             }
00547 
00548             <a class="code" href="../../d2/d1/mm_8h.html#a117">PERFINFO_WSMANAGE_TRIMWS</a>(ProcessToTrim, SessionSpace, VmSupport);
00549 
00550             <span class="keywordflow">if</span> (SessionSpace) {
00551 
00552                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a44">MiCheckProcessTrimCriteria</a>(&amp;TrimCriteria,
00553                                                 VmSupport,
00554                                                 NULL,
00555                                                 &amp;CurrentTime) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00556 
00557                     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00558                                     &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00559                     <span class="keywordflow">continue</span>;
00560                 }
00561 
00562                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a> = CurrentTime;
00563                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 1;
00564 
00565                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>;
00566                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink =
00567                                                     <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>;
00568                 <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00569 
00570                 ProcessToTrim = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00571 
00572                 <span class="comment">//</span>
00573                 <span class="comment">// Attach directly to the session space to be trimmed.</span>
00574                 <span class="comment">//</span>
00575 
00576                 <a class="code" href="../../d3/d7/session_8c.html#a16">MiAttachSession</a> (SessionSpace);
00577 
00578                 <span class="comment">//</span>
00579                 <span class="comment">// Try for the session working set lock.</span>
00580                 <span class="comment">//</span>
00581 
00582                 WorkingSetList = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>;
00583 
00584                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (APC_LEVEL, &amp;OldIrql);
00585 
00586                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a272">ExTryToAcquireResourceExclusiveLite</a> (&amp;SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o32">WsLock</a>)) {
00587                     <span class="comment">//</span>
00588                     <span class="comment">// This session space's working set lock was not</span>
00589                     <span class="comment">// granted, don't trim it.</span>
00590                     <span class="comment">//</span>
00591 
00592                     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
00593 
00594                     <a class="code" href="../../d3/d7/session_8c.html#a17">MiDetachSession</a> ();
00595 
00596                     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00597 
00598                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 1);
00599 
00600                     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
00601 
00602                     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d4/d8/mi_8h.html#a31">MM_FORCE_TRIM</a>;
00603 
00604                     <span class="keywordflow">goto</span> WorkingSetLockFailed;
00605                 }
00606 
00607                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
00608 
00609                 <a class="code" href="../../d4/d8/mi_8h.html#a404">MM_SET_SESSION_RESOURCE_OWNER</a>();
00610                 <a class="code" href="../../d2/d1/mm_8h.html#a108">PERFINFO_WSMANAGE_PROCESS_RESET</a>(VmSupport);
00611             }
00612             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
00613 
00614                 <span class="comment">//</span>
00615                 <span class="comment">// Check to see if this is a forced trim or</span>
00616                 <span class="comment">// if we are trimming because check counter is</span>
00617                 <span class="comment">// at the maximum.</span>
00618                 <span class="comment">//</span>
00619 
00620                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a44">MiCheckProcessTrimCriteria</a>(&amp;TrimCriteria,
00621                                                 VmSupport,
00622                                                 ProcessToTrim,
00623                                                 &amp;CurrentTime) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00624 
00625                     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00626                                     &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00627                     <span class="keywordflow">continue</span>;
00628                 }
00629 
00630                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a> = CurrentTime;
00631                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 1;
00632 
00633                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>;
00634                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink =
00635                                                     <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>;
00636                 <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00637                 WorkingSetList = <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>;
00638                 InformSessionOfRelease = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00639 
00640                 <span class="comment">//</span>
00641                 <span class="comment">// Attach to the process in preparation for trimming.</span>
00642                 <span class="comment">//</span>
00643 
00644                 <span class="keywordflow">if</span> (ProcessToTrim != CurrentProcess) {
00645 
00646                     Attached = <a class="code" href="../../d3/d5/procobj_8c.html#a5">KeForceAttachProcess</a> (&amp;ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
00647 
00648                     <span class="keywordflow">if</span> (Attached == 0) {
00649                         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00650                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
00651                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d4/d8/mi_8h.html#a31">MM_FORCE_TRIM</a>;
00652                         <span class="keywordflow">goto</span> WorkingSetLockFailed;
00653                     }
00654                     <span class="keywordflow">if</span> (ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00655                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o25">ProcessOutswapped</a> == FALSE);
00656                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession == 1 &amp;&amp; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionLeader == 0) {
00657                             InformSessionOfRelease = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00658                         }
00659                     }
00660                 }
00661 
00662                 <span class="comment">//</span>
00663                 <span class="comment">// Attempt to acquire the working set lock. If the</span>
00664                 <span class="comment">// lock cannot be acquired, skip over this process.</span>
00665                 <span class="comment">//</span>
00666 
00667                 count = 0;
00668                 <span class="keywordflow">do</span> {
00669                     <span class="keywordflow">if</span> (ExTryToAcquireFastMutex(&amp;ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o22">WorkingSetLock</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00670                         <span class="keywordflow">break</span>;
00671                     }
00672                     <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;MmShortTime);
00673                     count += 1;
00674                     <span class="keywordflow">if</span> (count == 5) {
00675 
00676                         <span class="comment">//</span>
00677                         <span class="comment">// Could not get the lock, skip this process.</span>
00678                         <span class="comment">//</span>
00679 
00680                         <span class="keywordflow">if</span> (InformSessionOfRelease == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00681                             <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00682                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> == TRUE);
00683                             ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00684                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &gt;= 1);
00685                             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> -= 1;
00686                             <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00687                             InformSessionOfRelease = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00688                         }
00689 
00690                         <span class="keywordflow">if</span> (Attached) {
00691                             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
00692                             Attached = 0;
00693                         }
00694 
00695                         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00696                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
00697                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d4/d8/mi_8h.html#a31">MM_FORCE_TRIM</a>;
00698                         <span class="keywordflow">goto</span> WorkingSetLockFailed;
00699                     }
00700                 } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00701 
00702                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 1);
00703 
00704 <span class="preprocessor">#if DBG</span>
00705 <span class="preprocessor"></span>                LastTrimFaultCount = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a>;
00706 <span class="preprocessor">#endif // DBG</span>
00707 <span class="preprocessor"></span>                VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
00708 
00709                 <a class="code" href="../../d2/d1/mm_8h.html#a108">PERFINFO_WSMANAGE_PROCESS_RESET</a>(VmSupport);
00710             }
00711             <span class="keywordflow">else</span> {
00712 
00713                 <span class="comment">//</span>
00714                 <span class="comment">// System cache,</span>
00715                 <span class="comment">//</span>
00716 
00717 <span class="preprocessor">#if DBG</span>
00718 <span class="preprocessor"></span>                LastTrimFaultCount = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a>;
00719 <span class="preprocessor">#endif // DBG</span>
00720 <span class="preprocessor"></span>
00721                 <a class="code" href="../../d2/d1/mm_8h.html#a108">PERFINFO_WSMANAGE_PROCESS_RESET</a>(VmSupport);
00722 
00723                 <span class="comment">//</span>
00724                 <span class="comment">// Always try to trim the system cache when using claims.</span>
00725                 <span class="comment">// Fault-based trimming might skip it from time to time.</span>
00726                 <span class="comment">//</span>
00727 
00728 <span class="preprocessor">#ifndef _MI_USE_CLAIMS_</span>
00729 <span class="preprocessor"></span>
00730                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d0/wsmanage_8c.html#a45">MiCheckSystemCacheWsTrimCriteria</a>(VmSupport)) {
00731 
00732                     <span class="comment">//</span>
00733                     <span class="comment">// Don't trim the system cache.</span>
00734                     <span class="comment">//</span>
00735 
00736                     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00737                                         &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00738                     <span class="keywordflow">continue</span>;
00739                 }
00740 <span class="preprocessor">#endif</span>
00741 <span class="preprocessor"></span>
00742                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a> = CurrentTime;
00743 
00744                 <span class="comment">//</span>
00745                 <span class="comment">// Indicate that this working set is being trimmed.</span>
00746                 <span class="comment">//</span>
00747 
00748                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 1;
00749 
00750                 <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00751 
00752                 ProcessToTrim = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00753                 WorkingSetList = <a class="code" href="../../d4/d8/mi_8h.html#a657">MmSystemCacheWorkingSetList</a>;
00754 
00755                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (APC_LEVEL, &amp;OldIrql);
00756                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a272">ExTryToAcquireResourceExclusiveLite</a> (&amp;MmSystemWsLock)) {
00757 
00758                     <span class="comment">//</span>
00759                     <span class="comment">// System working set lock was not granted, don't trim</span>
00760                     <span class="comment">// the system cache.</span>
00761                     <span class="comment">//</span>
00762 
00763                     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
00764                     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00765                     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
00766                     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00767                                     &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00768                     <span class="keywordflow">continue</span>;
00769                 }
00770 
00771                 <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a> = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00772 
00773                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
00774 
00775                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>;
00776                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink =
00777                                                     <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>;
00778             }
00779 
00780             <span class="comment">//</span>
00781             <span class="comment">// Determine how many pages we want to trim from this working set.</span>
00782             <span class="comment">//</span>
00783 
00784             Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a46">MiDetermineWsTrimAmount</a>(&amp;TrimCriteria,
00785                                            VmSupport,
00786                                            ProcessToTrim
00787                                            );
00788 
00789 <span class="preprocessor">#if DBG</span>
00790 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a60">MM_DBG_WS_EXPANSION</a>) {
00791                 <span class="keywordflow">if</span> (Trim) {
00792                   <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
00793                       <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"           Trimming        Process %16s %5d Faults, WS %6d, Trimming %5d ==&gt; %5d\n"</span>,
00794                         ProcessToTrim ? ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o65">ImageFileName</a> : (PUCHAR)<span class="stringliteral">"System Cache"</span>,
00795                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a> - LastTrimFaultCount,
00796                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>,
00797                         Trim,
00798                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>-Trim
00799                         );
00800                   }
00801                   <span class="keywordflow">else</span> {
00802                       <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"           Trimming        Session 0x%x (id %d) %5d Faults, WS %6d, Trimming %5d ==&gt; %5d\n"</span>,
00803                         SessionSpace,
00804                         SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
00805                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a> - LastTrimFaultCount,
00806                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>,
00807                         Trim,
00808                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>-Trim
00809                         );
00810                   }
00811                 }
00812             }
00813 <span class="preprocessor">#endif //DBG</span>
00814 <span class="preprocessor"></span>
00815 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00816 <span class="preprocessor"></span>
00817             <span class="comment">//</span>
00818             <span class="comment">// If there's something to trim...</span>
00819             <span class="comment">//</span>
00820 
00821             <span class="keywordflow">if</span> (Trim != 0 &amp;&amp;
00822                 (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; TrimCriteria.ClaimBased.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o1">DesiredFreeGoal</a>)) {
00823 
00824                 <span class="comment">//</span>
00825                 <span class="comment">// We haven't reached our goal, so trim now.</span>
00826                 <span class="comment">//</span>
00827 
00828                 <a class="code" href="../../d2/d1/mm_8h.html#a113">PERFINFO_WSMANAGE_TOTRIM</a>(Trim);
00829 
00830                 Trim = <a class="code" href="../../d4/d0/wslist_8c.html#a34">MiTrimWorkingSet</a> (Trim,
00831                                          VmSupport,
00832                                          TrimCriteria.ClaimBased.TrimAge
00833                                          );
00834 
00835                 <a class="code" href="../../d2/d1/mm_8h.html#a98">PERFINFO_WSMANAGE_ACTUALTRIM</a>(Trim);
00836             }
00837 
00838             <span class="comment">//</span>
00839             <span class="comment">// Estimating the current claim is always done here by taking a</span>
00840             <span class="comment">// sample of the working set.  Aging is only done if the trim</span>
00841             <span class="comment">// pass warrants it (ie: the first pass only).</span>
00842             <span class="comment">//</span>
00843 
00844             MiAgeAndEstimateAvailableInWorkingSet(
00845                                 VmSupport,
00846                                 TrimCriteria.ClaimBased.DoAging,
00847                                 &amp;TrimCriteria.ClaimBased.NewTotalClaim,
00848                                 &amp;TrimCriteria.ClaimBased.NewTotalEstimatedAvailable
00849                                 );
00850 <span class="preprocessor">#else</span>
00851 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Trim != 0) {
00852 
00853                 <a class="code" href="../../d2/d1/mm_8h.html#a113">PERFINFO_WSMANAGE_TOTRIM</a>(Trim);
00854 
00855                 Trim = <a class="code" href="../../d4/d0/wslist_8c.html#a34">MiTrimWorkingSet</a> (
00856                             Trim,
00857                             VmSupport,
00858                             (BOOLEAN)(MiCheckCounter &lt; MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM)
00859                             );
00860 
00861                 <a class="code" href="../../d2/d1/mm_8h.html#a98">PERFINFO_WSMANAGE_ACTUALTRIM</a>(Trim);
00862             }
00863 <span class="preprocessor">#endif</span>
00864 <span class="preprocessor"></span>
00865             <span class="comment">//</span>
00866             <span class="comment">// Set the quota to the current size.</span>
00867             <span class="comment">//</span>
00868 
00869             WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>;
00870             <span class="keywordflow">if</span> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> &lt; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>) {
00871                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
00872             }
00873 
00874             <span class="keywordflow">if</span> (SessionSpace) {
00875 
00876                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 1);
00877 
00878                 <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
00879 
00880                 <a class="code" href="../../d3/d7/session_8c.html#a17">MiDetachSession</a> ();
00881             }
00882             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
00883 
00884                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
00885                 <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (ProcessToTrim);
00886 
00887                 <span class="keywordflow">if</span> (InformSessionOfRelease == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00888                     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00889                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> == TRUE);
00890                     ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00891                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &gt;= 1);
00892                     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> -= 1;
00893                     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00894                     InformSessionOfRelease = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00895                 }
00896 
00897                 <span class="keywordflow">if</span> (Attached) {
00898                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
00899                     Attached = 0;
00900                 }
00901 
00902             }
00903             <span class="keywordflow">else</span> {
00904                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
00905                 <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql);
00906             }
00907 
00908             <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00909 
00910             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 1);
00911             VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
00912 
00913 WorkingSetLockFailed:
00914 
00915             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink == MM_NO_WS_EXPANSION);
00916 
00917             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink ==
00918                                                  <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>) {
00919 
00920                 <span class="comment">//</span>
00921                 <span class="comment">// If the working set size is still above the minimum,</span>
00922                 <span class="comment">// add this back at the tail of the list.</span>
00923                 <span class="comment">//</span>
00924 
00925                 InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00926                                 &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00927             }
00928             <span class="keywordflow">else</span> {
00929 
00930                 <span class="comment">//</span>
00931                 <span class="comment">// The value in the blink is the address of an event</span>
00932                 <span class="comment">// to set.</span>
00933                 <span class="comment">//</span>
00934 
00935                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport != &amp;MmSystemCacheWs);
00936 
00937                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> ((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink,
00938                             0,
00939                             FALSE);
00940             }
00941 
00942 <span class="preprocessor">#ifndef _MI_USE_CLAIMS_</span>
00943 <span class="preprocessor"></span>            TrimCriteria.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.TotalReduction += Trim;
00944 
00945             <span class="comment">//</span>
00946             <span class="comment">// Zero this in case the next attach fails.</span>
00947             <span class="comment">//</span>
00948 
00949             Trim = 0;
00950 
00951             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> &lt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a0">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>) {
00952                 <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; TrimCriteria.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.DesiredFreeGoal) ||
00953                     (TrimCriteria.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.TotalReduction &gt; TrimCriteria.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.DesiredReductionGoal)) {
00954 
00955 
00956                     <span class="comment">//</span>
00957                     <span class="comment">// Ample pages now exist.</span>
00958                     <span class="comment">//</span>
00959 
00960                     <a class="code" href="../../d2/d1/mm_8h.html#a104">PERFINFO_WSMANAGE_FINALACTION</a>(WS_ACTION_AMPLE_PAGES_EXIST);
00961                     <span class="keywordflow">break</span>;
00962                 }
00963             }
00964 <span class="preprocessor">#endif</span>
00965 <span class="preprocessor"></span>
00966         }
00967 
00968 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00969 <span class="preprocessor"></span>        MmTotalClaim = TrimCriteria.ClaimBased.NewTotalClaim;
00970         MmTotalEstimatedAvailable = TrimCriteria.ClaimBased.NewTotalEstimatedAvailable;
00971         <a class="code" href="../../d2/d1/mm_8h.html#a115">PERFINFO_WSMANAGE_TRIMEND_CLAIMS</a>(&amp;TrimCriteria);
00972 <span class="preprocessor">#else</span>
00973 <span class="preprocessor"></span>        <a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> = 0;
00974         <a class="code" href="../../d2/d1/mm_8h.html#a116">PERFINFO_WSMANAGE_TRIMEND_FAULTS</a>(&amp;TrimCriteria);
00975 <span class="preprocessor">#endif</span>
00976 <span class="preprocessor"></span>
00977         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00978     }
00979 
00980     <span class="comment">//</span>
00981     <span class="comment">// Signal the modified page writer as we have moved pages</span>
00982     <span class="comment">// to the modified list and memory was critical.</span>
00983     <span class="comment">//</span>
00984 
00985     <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a>) ||
00986         (<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a728">MmModifiedPageMaximum</a>)) {
00987         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmModifiedPageWriterEvent, 0, FALSE);
00988     }
00989 
00990     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentProcess == PsGetCurrentProcess ());
00991 
00992     <span class="keywordflow">return</span>;
00993 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a238" doxytag="mm.h::MmWriteTriageInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmWriteTriageInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PVOID</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02795">IopWriteTriageDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a239" doxytag="mm.h::MmWriteUnloadedDriverInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmWriteUnloadedDriverInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PVOID</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02795">IopWriteTriageDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a331" doxytag="mm.h::MmZeroPageThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmZeroPageThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/zeropage_8c-source.html#l00029">29</a> of file <a class="el" href="../../d8/d0/zeropage_8c-source.html">zeropage.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00590">_KTHREAD::BasePriority</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01081">_MMPFNLIST::Flink</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01838">KeSetPriorityThread()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00395">KeWaitForMultipleObjects()</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l00229">KeZeroPageFromIdleThread</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00890">LOCK_PFN_WITH_TRY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01165">MI_GET_SECONDARY_COLOR</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02474">MiFindInitializationCode()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02664">MiFreeInitializationCode()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d3/d2/ppc_2hypermap_8c-source.html#l00288">MiMapPageToZeroInHyperSpace()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d8/d0/zeropage_8c-source.html#l00023">MM_ZERO_PAGE_OBJECT</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00081">MmFreePageListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04589">MmZeroingPageEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04598">MmZeroingPageThreadActive</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d0/zeropage_8c-source.html#l00025">NUMBER_WAIT_OBJECTS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d8/d0/zeropage_8c-source.html#l00024">PO_SYS_IDLE_OBJECT</a>, <a class="el" href="../../d2/d1/po_8h-source.html#l00463">PoSystemIdleTimer</a>, <a class="el" href="../../d1/d2/po_8h.html#a69">PoSystemIdleWorker()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a206">WrFreePage</a>, and <a class="el" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>.
<p>
<pre class="fragment"><div>00035                    :
00036 
00037     Implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT zeroing page thread.  This thread runs
00038     at priority zero and removes a page from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free list,
00039     zeroes <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, and places <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> zeroed page list.
00040 
00041 Arguments:
00042 
00043     StartContext - not used.
00044 
00045 Return Value:
00046 
00047     None.
00048 
00049 Environment:
00050 
00051     Kernel mode.
00052 
00053 --*/
00054 
00055 {
00056     PVOID EndVa;
00057     KIRQL OldIrql;
00058     PFN_NUMBER PageFrame;
00059     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00060     PVOID StartVa;
00061     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread;
00062     PVOID ZeroBase;
00063     PFN_NUMBER NewPage;
00064     PVOID WaitObjects[<a class="code" href="../../d7/d1/zeropage_8c.html#a2">NUMBER_WAIT_OBJECTS</a>];
00065     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00066 
00067     <span class="comment">//</span>
00068     <span class="comment">// Before this becomes the zero page thread, free the kernel</span>
00069     <span class="comment">// initialization code.</span>
00070     <span class="comment">//</span>
00071 
00072 <span class="preprocessor">#if !defined(_IA64_)</span>
00073 <span class="preprocessor"></span>    <a class="code" href="../../d5/d1/mminit_8c.html#a55">MiFindInitializationCode</a> (&amp;StartVa, &amp;EndVa);
00074     <span class="keywordflow">if</span> (StartVa != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00075         <a class="code" href="../../d5/d1/mminit_8c.html#a56">MiFreeInitializationCode</a> (StartVa, EndVa);
00076     }
00077 <span class="preprocessor">#endif</span>
00078 <span class="preprocessor"></span>
00079     <span class="comment">//</span>
00080     <span class="comment">// The following code sets the current thread's base priority to zero</span>
00081     <span class="comment">// and then sets its current priority to zero. This ensures that the</span>
00082     <span class="comment">// thread always runs at a priority of zero.</span>
00083     <span class="comment">//</span>
00084 
00085     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00086     Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o24">BasePriority</a> = 0;
00087     <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a> (Thread, 0);
00088 
00089     <span class="comment">//</span>
00090     <span class="comment">// Initialize wait object array for multiple wait</span>
00091     <span class="comment">//</span>
00092 
00093     WaitObjects[<a class="code" href="../../d7/d1/zeropage_8c.html#a0">MM_ZERO_PAGE_OBJECT</a>] = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a611">MmZeroingPageEvent</a>;
00094     WaitObjects[<a class="code" href="../../d7/d1/zeropage_8c.html#a1">PO_SYS_IDLE_OBJECT</a>] = &amp;<a class="code" href="../../d1/d2/po_8h.html#a54">PoSystemIdleTimer</a>;
00095 
00096     <span class="comment">//</span>
00097     <span class="comment">// Loop forever zeroing pages.</span>
00098     <span class="comment">//</span>
00099 
00100     <span class="keywordflow">do</span> {
00101 
00102         <span class="comment">//</span>
00103         <span class="comment">// Wait until there are at least MmZeroPageMinimum pages</span>
00104         <span class="comment">// on the free list.</span>
00105         <span class="comment">//</span>
00106 
00107         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a> (NUMBER_WAIT_OBJECTS,
00108                                            WaitObjects,
00109                                            WaitAny,
00110                                            WrFreePage,
00111                                            KernelMode,
00112                                            FALSE,
00113                                            (PLARGE_INTEGER) NULL,
00114                                            (<a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">PKWAIT_BLOCK</a>) NULL
00115                                            );
00116 
00117         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d7/d1/zeropage_8c.html#a1">PO_SYS_IDLE_OBJECT</a>) {
00118             <a class="code" href="../../d1/d2/po_8h.html#a69">PoSystemIdleWorker</a> (TRUE);
00119             <span class="keywordflow">continue</span>;
00120         }
00121 
00122         <a class="code" href="../../d4/d8/mi_8h.html#a128">LOCK_PFN_WITH_TRY</a> (OldIrql);
00123         <span class="keywordflow">do</span> {
00124             <span class="keywordflow">if</span> ((<span class="keyword">volatile</span>)<a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> == 0) {
00125 
00126                 <span class="comment">//</span>
00127                 <span class="comment">// No pages on the free list at this time, wait for</span>
00128                 <span class="comment">// some more.</span>
00129                 <span class="comment">//</span>
00130 
00131                 <a class="code" href="../../d4/d8/mi_8h.html#a612">MmZeroingPageThreadActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00132                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00133                 <span class="keywordflow">break</span>;
00134 
00135             } <span class="keywordflow">else</span> {
00136 
00137                 PageFrame = <a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
00138                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrame);
00139 
00140                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PageFrame != MM_EMPTY_LIST);
00141                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrame);
00142 
00143                 NewPage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (MI_GET_SECONDARY_COLOR (PageFrame, Pfn1));
00144                 <span class="keywordflow">if</span> (NewPage != PageFrame) {
00145 
00146                     <span class="comment">//</span>
00147                     <span class="comment">// Someone has removed a page from the colored lists chain</span>
00148                     <span class="comment">// without updating the freelist chain.</span>
00149                     <span class="comment">//</span>
00150 
00151                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PFN_LIST_CORRUPT,
00152                                   0x8F,
00153                                   NewPage,
00154                                   PageFrame,
00155                                   0);
00156                 }
00157 
00158                 <span class="comment">//</span>
00159                 <span class="comment">// Zero the page using the last color used to map the page.</span>
00160                 <span class="comment">//</span>
00161 
00162 <span class="preprocessor">#if defined(_AXP64_) || defined(_X86_) || defined(_IA64_)</span>
00163 <span class="preprocessor"></span>
00164                 ZeroBase = <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a3">MiMapPageToZeroInHyperSpace</a> (PageFrame);
00165                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00166 
00167 <span class="preprocessor">#if defined(_X86_)</span>
00168 <span class="preprocessor"></span>
00169                 <a class="code" href="../../d6/d9/kernlini_8c.html#a25">KeZeroPageFromIdleThread</a>(ZeroBase);
00170 
00171 <span class="preprocessor">#else  //X86</span>
00172 <span class="preprocessor"></span>
00173                 RtlZeroMemory (ZeroBase, PAGE_SIZE);
00174 
00175 <span class="preprocessor">#endif //X86</span>
00176 <span class="preprocessor"></span>
00177 <span class="preprocessor">#else  //AXP64||X86||IA64</span>
00178 <span class="preprocessor"></span>
00179                 ZeroBase = (PVOID)(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00180                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00181                 HalZeroPage(ZeroBase, ZeroBase, PageFrame);
00182 
00183 <span class="preprocessor">#endif //AXP64||X86||IA64</span>
00184 <span class="preprocessor"></span>
00185                 <a class="code" href="../../d4/d8/mi_8h.html#a128">LOCK_PFN_WITH_TRY</a> (OldIrql);
00186                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[ZeroedPageList],
00187                                     PageFrame);
00188             }
00189         } <span class="keywordflow">while</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00190     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00191 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a235" doxytag="mm.h::VerifierFreeTrackedPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID VerifierFreeTrackedPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>ChargedBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LOGICAL&nbsp;</td>
          <td class="mdname" nowrap> <em>CheckType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LOGICAL&nbsp;</td>
          <td class="mdname" nowrap> <em>SpecialPool</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d5/verifier_8c-source.html#l01976">1976</a> of file <a class="el" href="../../d0/d5/verifier_8c-source.html">verifier.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l04122">_MI_VERIFIER_DRIVER_ENTRY::CurrentNonPagedPoolAllocations</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04121">_MI_VERIFIER_DRIVER_ENTRY::CurrentPagedPoolAllocations</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04097">MI_VERIFIER_ENTRY_SIGNATURE</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d0/d5/4_2kddata_8c-source.html#l00097">MmVerifierData</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04127">_MI_VERIFIER_DRIVER_ENTRY::NonPagedBytes</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00071">PAGE_ALIGNED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04126">_MI_VERIFIER_DRIVER_ENTRY::PagedBytes</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00116">POOL_OVERHEAD</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04112">_MI_VERIFIER_DRIVER_ENTRY::Signature</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l00390">VerifierIsTrackingPool</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l00394">VerifierPoolLock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04114">_MI_VERIFIER_DRIVER_ENTRY::VerifierPoolLock</a>, <a class="el" href="../../d0/d5/verifier_8c-source.html#l00396">VerifierPoolMutex</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l01447">ViReleasePoolAllocation()</a>.
<p>
<pre class="fragment"><div>01985                    :
01986 
01987     Called directly from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> manager or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory manager <span class="keywordflow">for</span> verifier-
01988     tracked allocations.  The call to <a class="code" href="../../d6/d3/cmwraper_8c.html#a26">ExFreePool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already in progress.
01989 
01990 Arguments:
01991 
01992     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address being freed.
01993 
01994     ChargedBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes charged to <span class="keyword">this</span> allocation.
01995 
01996     CheckType - Supplies <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a> or <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>.
01997 
01998     SpecialPool - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> from special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01999 
02000 Return Value:
02001 
02002     None.
02003 
02004 Environment:
02005 
02006     Kernel mode.
02007 
02008     N.B.
02009 
02010     Callers freeing small <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> allocations hold no locks or mutexes on entry.
02011 
02012     Callers freeing special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> hold no locks or mutexes on entry.
02013 
02014     Callers freeing <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> of <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> or larger hold <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN lock (<span class="keywordflow">for</span> nonpaged
02015     allocations) or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a> mutex (<span class="keywordflow">for</span> paged allocations) on entry.
02016 
02017 --*/
02018 
02019 {
02020     KIRQL OldIrql;
02021     ULONG_PTR <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02022     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> PoolHeader;
02023     <a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">PMI_VERIFIER_POOL_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
02024     <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier;
02025 
02026     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/verifier_8c.html#a28">VerifierIsTrackingPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02027 
02028         <span class="comment">//</span>
02029         <span class="comment">// The verifier is not enabled so the only way this routine is being</span>
02030         <span class="comment">// called is because the pool header is mangled or the caller specified</span>
02031         <span class="comment">// a bad address.  Either way it's a bugcheck.</span>
02032         <span class="comment">//</span>
02033 
02034         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (BAD_POOL_CALLER,
02035                       0x99,
02036                       (ULONG_PTR)VirtualAddress,
02037                       0,
02038                       0);
02039     }
02040 
02041     <span class="keywordflow">if</span> (SpecialPool == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02042 
02043         <span class="comment">//</span>
02044         <span class="comment">// Special pool allocation.</span>
02045         <span class="comment">//</span>
02046 
02047         <span class="keywordflow">if</span> (((ULONG_PTR)VirtualAddress &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1))) {
02048             PoolHeader = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (VirtualAddress);
02049             <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">PMI_VERIFIER_POOL_HEADER</a>)(PoolHeader + 1);
02050         }
02051         <span class="keywordflow">else</span> {
02052             PoolHeader = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (VirtualAddress) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
02053             <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">PMI_VERIFIER_POOL_HEADER</a>)(PoolHeader - 1);
02054         }
02055     }
02056     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/poolhack_8c.html#a5">PAGE_ALIGNED</a>(VirtualAddress)) {
02057 
02058         <span class="comment">//</span>
02059         <span class="comment">// Large page allocation.</span>
02060         <span class="comment">//</span>
02061 
02062         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">PMI_VERIFIER_POOL_HEADER</a>) ((PCHAR)VirtualAddress +
02063                      ChargedBytes -
02064                      <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">MI_VERIFIER_POOL_HEADER</a>));
02065     }
02066     <span class="keywordflow">else</span> {
02067         ChargedBytes -= <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>;
02068         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = (<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">PMI_VERIFIER_POOL_HEADER</a>) ((PCHAR)VirtualAddress +
02069                      ChargedBytes -
02070                      <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">MI_VERIFIER_POOL_HEADER</a>));
02071     }
02072 
02073     Verifier = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Verifier;
02074 
02075     <span class="comment">//</span>
02076     <span class="comment">// Check the pointer now so we can give a more friendly bugcheck</span>
02077     <span class="comment">// rather than crashing below on a bad reference.</span>
02078     <span class="comment">//</span>
02079 
02080     <span class="keywordflow">if</span> ((((ULONG_PTR)Verifier &amp; (<span class="keyword">sizeof</span>(ULONG) - 1)) != 0) ||
02081         (!<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(&amp;Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o7">Signature</a>)) ||
02082         (Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o7">Signature</a> != <a class="code" href="../../d4/d8/mi_8h.html#a251">MI_VERIFIER_ENTRY_SIGNATURE</a>)) {
02083 
02084         <span class="comment">//</span>
02085         <span class="comment">// The caller corrupted the saved verifier field.</span>
02086         <span class="comment">//</span>
02087 
02088         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
02089                       0x53,
02090                       (ULONG_PTR)VirtualAddress,
02091                       (ULONG_PTR)Header,
02092                       (ULONG_PTR)Verifier);
02093     }
02094 
02095     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;ListIndex;
02096 
02097     ExAcquireSpinLock (&amp;Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o9">VerifierPoolLock</a>, &amp;OldIrql);
02098 
02099     <a class="code" href="../../d9/d5/verifier_8c.html#a99">ViReleasePoolAllocation</a> (Verifier,
02100                              VirtualAddress,
02101                              Index,
02102                              ChargedBytes);
02103 
02104     <span class="keywordflow">if</span> (CheckType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
02105         Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o18">PagedBytes</a> -= ChargedBytes;
02106         Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o14">CurrentPagedPoolAllocations</a> -= 1;
02107 
02108         ExReleaseSpinLock (&amp;Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o9">VerifierPoolLock</a>, OldIrql);
02109 
02110         ExAcquireFastMutex (&amp;VerifierPoolMutex);
02111         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.PagedBytes -= ChargedBytes;
02112         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.CurrentPagedPoolAllocations -= 1;
02113         ExReleaseFastMutex (&amp;VerifierPoolMutex);
02114     }
02115     <span class="keywordflow">else</span> {
02116         Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o19">NonPagedBytes</a> -= ChargedBytes;
02117         Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o15">CurrentNonPagedPoolAllocations</a> -= 1;
02118         ExReleaseSpinLock (&amp;Verifier-&gt;<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o9">VerifierPoolLock</a>, OldIrql);
02119 
02120         ExAcquireSpinLock (&amp;VerifierPoolLock, &amp;OldIrql);
02121         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.NonPagedBytes -= ChargedBytes;
02122         <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>.CurrentNonPagedPoolAllocations -= 1;
02123         ExReleaseSpinLock (&amp;VerifierPoolLock, OldIrql);
02124     }
02125 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a132" doxytag="mm.h::Mm64BitPhysicalAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d0/d9/miglobal_8c.html#a154">Mm64BitPhysicalAddress</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00079">79</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a145" doxytag="mm.h::MmInfoCounters" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d2/struct__MMINFO__COUNTERS.html">MMINFO_COUNTERS</a> <a class="el" href="../../d0/d9/miglobal_8c.html#a13">MmInfoCounters</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00475">475</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>, <a class="el" href="../../d4/d9/wrtfault_8c-source.html#l00025">MiCopyOnWrite()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03198">MiGatherMappedPages()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l03701">MiGatherPagefilePages()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00117">MiLocateAndReserveWsle()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00674">MiResolveDemandZeroFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01989">MiResolveMappedFileFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01272">MiResolvePageFileFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l01446">MiResolveProtoPteFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00868">MiResolveTransitionFault()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l04446">MiSessionCopyOnWrite()</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, and <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a150" doxytag="mm.h::MmModifiedPageListHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d4/struct__MMPFNLIST.html">MMPFNLIST</a> <a class="el" href="../../d0/d9/miglobal_8c.html#a29">MmModifiedPageListHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01087">1087</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04870">MiFlushAllPages()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00388">MiInsertStandbyListAtFront()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">MiModifiedPageWriterWorker()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00336">MiObtainFreePages()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a135" doxytag="mm.h::MmNumberOfColors" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d2/d1/mm_8h.html#a135">MmNumberOfColors</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00393">393</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a136" doxytag="mm.h::MmNumberOfPhysicalPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_COUNT <a class="el" href="../../d0/d9/miglobal_8c.html#a6">MmNumberOfPhysicalPages</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00399">399</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l00069">CcInitializeCacheManager()</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00220">ExpWorkerInitialization()</a>, <a class="el" href="../../d4/d2/tob_8c-source.html#l00597">main()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00259">MiAdjustWorkingSetManagerParameters()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02184">MiBuildPagedPool()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>, <a class="el" href="../../d7/d1/mm_2ia64_2initia64_8c-source.html#l00225">MiEnsureAvailablePagesInFreeDescriptor()</a>, <a class="el" href="../../d7/d1/mm_2ia64_2initia64_8c-source.html#l00139">MiGetNextPhysicalPage()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02974">MiInitializeSpecialPool()</a>, <a class="el" href="../../d3/d0/inialpha_8c-source.html#l00041">MiInitMachineDependent()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00043">MmAddPhysicalMemory()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05567">MmSetMemoryPriorityProcess()</a>, <a class="el" href="../../d4/d0/iniaxp64_8c-source.html#l00046">MxGetNextPage()</a>, and <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a131" doxytag="mm.h::MmPhysicalMemoryBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html">PPHYSICAL_MEMORY_DESCRIPTOR</a> <a class="el" href="../../d5/d1/mminit_8c.html#a20">MmPhysicalMemoryBlock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">48</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03815">IopCreateSummaryDump()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03953">IopDeleteNonExistentMemory()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">IopInitializeDCB()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00066">IopInitializeResourceMap()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03442">IopInitializeSummaryDump()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04379">IopReadDumpRegistry()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01095">MiCheckForCrashDump()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00043">MmAddPhysicalMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l01032">MmGetPhysicalMemoryRanges()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>, and <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a142" doxytag="mm.h::MmProductType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d4/d5/procsup_8c.html#a5">MmProductType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00455">455</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a134" doxytag="mm.h::MmReadClusterSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d9/miglobal_8c.html#a131">MmReadClusterSize</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00387">387</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a133" doxytag="mm.h::MmSectionObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d0/d9/miglobal_8c.html#a88">MmSectionObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00381">381</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00768">MiSectionInitialization()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00390">MmCreateSection()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01721">MmGetFileNameForSection()</a>, <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l00040">NtAcceptConnectPort()</a>, <a class="el" href="../../d2/d7/super_8c-source.html#l00056">NtCreateSuperSection()</a>, <a class="el" href="../../d9/d9/extsect_8c-source.html#l00085">NtExtendSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00199">NtMapViewOfSection()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04250">NtOpenSection()</a>, <a class="el" href="../../d5/d2/querysec_8c-source.html#l00031">NtQuerySection()</a>, <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00525">PsLocateSystemDll()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a137" doxytag="mm.h::MmSizeOfSystemCacheInPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_COUNT <a class="el" href="../../d0/d9/miglobal_8c.html#a79">MmSizeOfSystemCacheInPages</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00406">406</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/vacbsup_8c-source.html#l00188">CcInitializeVacbs()</a>, and <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a161" doxytag="mm.h::MmSpecialPoolEnd" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d8/d2/pagfault_8c.html#a7">MmSpecialPoolEnd</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01977">1977</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02607">ExAllocatePoolWithQuotaTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03892">ExFreePoolSanityChecks()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03328">ExQueryPoolBlockSize()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03480">ExReturnPoolQuota()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02974">MiInitializeSpecialPool()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">MiLockCode()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l05278">MiProtectSpecialPool()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00868">MiResolveTransitionFault()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l05177">MmIsSpecialPoolAddressFree()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02927">MmQuerySpecialPoolBlockSize()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l01614">ViPostPoolAllocation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a160" doxytag="mm.h::MmSpecialPoolStart" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d8/d2/pagfault_8c.html#a6">MmSpecialPoolStart</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01976">1976</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02607">ExAllocatePoolWithQuotaTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03892">ExFreePoolSanityChecks()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02760">ExFreePoolWithTag()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03328">ExQueryPoolBlockSize()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l03480">ExReturnPoolQuota()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02974">MiInitializeSpecialPool()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">MiLockCode()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l00868">MiResolveTransitionFault()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l05177">MmIsSpecialPoolAddressFree()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02927">MmQuerySpecialPoolBlockSize()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l01614">ViPostPoolAllocation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a159" doxytag="mm.h::MmSpecialPoolTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d1/d6/allocpag_8c.html#a12">MmSpecialPoolTag</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01975">1975</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l01104">ExAllocatePoolWithTag()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02974">MiInitializeSpecialPool()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l03270">MiInitializeSpecialPoolCriteria()</a>, <a class="el" href="../../d2/d1/mm_2i386_2init386_8c-source.html#l00058">MiInitMachineDependent()</a>, and <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a138" doxytag="mm.h::MmSystemCacheWs" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">MMSUPPORT</a> <a class="el" href="../../d0/d9/miglobal_8c.html#a73">MmSystemCacheWs</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00412">412</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a152" doxytag="mm.h::MmThrottleBottom" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_NUMBER <a class="el" href="../../d0/d9/miglobal_8c.html#a12">MmThrottleBottom</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01090">1090</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a151" doxytag="mm.h::MmThrottleTop" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_NUMBER <a class="el" href="../../d0/d9/miglobal_8c.html#a11">MmThrottleTop</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l01089">1089</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a126" doxytag="mm.h::MmVirtualBias" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG_PTR <a class="el" href="../../d0/d9/miglobal_8c.html#a3">MmVirtualBias</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00029">29</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02492">IopCalculateRequiredDumpSpace()</a>, <a class="el" href="../../d2/d1/mm_2i386_2init386_8c-source.html#l00058">MiInitMachineDependent()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l01567">MiMapViewOfImageSection()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l01695">MmCleanProcessAddressSpace()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00190">MmCreateProcessAddressSpace()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02005">MmFreeLoaderBlock()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00911">MmInitializeProcessAddressSpace()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l08083">MmSetKernelDumpRange()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a139" doxytag="mm.h::MmWorkingSetManagerEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="el" href="../../d0/d9/miglobal_8c.html#a117">MmWorkingSetManagerEvent</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d0/mm_8h-source.html#l00418">418</a> of file <a class="el" href="../../d3/d0/mm_8h-source.html">mm.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">KeBalanceSetManager()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02715">MiEmptyAllWorkingSets()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00336">MiObtainFreePages()</a>, and <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:46 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
